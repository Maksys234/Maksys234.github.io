<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Interaktivní Výuka</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        // Konfigurace MathJax для inline ($...$) и display ($$...) математики
        if (typeof window.MathJax === 'undefined') {
            window.MathJax = {
                tex: {
                    inlineMath: [ ['\\(', '\\)'], ['$', '$'] ], // Поддержка $...$ и \(...\)
                    displayMath: [['$$', '$$']], // Поддержка $$...$$
                    processEscapes: true, processEnvironments: true
                },
                options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' },
                startup: { ready: () => { MathJax.startup.defaultReady(); MathJax.startup.promise.then(() => console.log('MathJax loaded and ready.')); } }
            };
        } else { console.warn("window.MathJax already defined."); }
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@excalidraw/excalidraw@0.17.3/dist/excalidraw.production.min.js" crossorigin></script>

    <style>
        /* --- CSS Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; scroll-behavior: smooth; }
        :root { 
            --primary-rgb: 67, 97, 238; 
            --primary: #4361ee; 
            --primary-light: #4895ef; 
            --secondary: #3f37c9; 
            --success: #06d6a0; 
            --danger: #f72585; 
            --warning: #f8961e; 
            --info: #4cc9f0; 
            --dark: #1e293b; 
            --light: #f8f9fa; 
            --white: #ffffff; 
            --gray-light: #e9ecef; 
            --gray: #ced4da; 
            --text-primary: #212529; 
            --text-secondary: #6c757d; 
            --text-muted: #adb5bd; 
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12); 
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1); 
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --card-radius: 12px;
            --btn-radius: 8px;
            --transition-speed: 0.3s;
            --sidebar-width: 260px;
            --avatar-size: 38px;
            --call-bg: #f1f5f9;
            --call-panel-bg: #fcfcff;
            --gradient-1: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            --font-base-size: 16px;
        }

        body { 
            background-color: var(--call-bg); 
            color: var(--text-primary); 
            min-height: 100vh; 
            display: flex; 
            overflow: hidden; 
            font-size: var(--font-base-size);
        }

        .sidebar { 
            width: var(--sidebar-width); 
            height: 100vh; 
            position: fixed; 
            top: 0; 
            left: 0; 
            background: var(--gradient-1); 
            color: var(--white); 
            padding: 1.5rem 1rem; 
            display: flex; 
            flex-direction: column; 
            z-index: 1050; 
            transition: transform var(--transition-speed) ease; 
            overflow-y: auto;
        }

        .sidebar-header { 
            display: flex; 
            align-items: center; 
            margin-bottom: 2rem; 
            padding: 0 0.75rem; 
        } 
        
        .sidebar-logo { 
            font-size: 1.6rem; 
            font-weight: 700; 
            color: var(--white); 
            text-decoration: none; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }

        .sidebar-menu { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
            flex-grow: 1; 
        } 
        
        .sidebar-item { 
            margin-bottom: 0.5rem; 
        } 
        
        .sidebar-link { 
            display: flex; 
            align-items: center; 
            padding: 0.85rem 1rem; 
            color: rgba(255,255,255,0.85); 
            text-decoration: none; 
            border-radius: 8px; 
            transition: all 0.2s ease; 
            font-weight: 500; 
            gap: 0.75rem; 
        }
        
        .sidebar-link i { 
            font-size: 1.2rem; 
            min-width: 28px; 
            text-align: center; 
        } 
        
        .sidebar-link:hover, .sidebar-link.active { 
            color: var(--white); 
            background-color: rgba(255,255,255,0.1);
        }

        .user-profile { 
            margin-top: auto; 
            display: flex; 
            align-items: center; 
            padding: 1rem; 
            background-color: rgba(0,0,0,0.1); 
            border-radius: 10px; 
            margin-bottom: 1rem; 
            gap: 0.75rem; 
        }
        
        .user-avatar { 
            width: var(--avatar-size); 
            height: var(--avatar-size); 
            border-radius: 50%; 
            background-color: var(--primary-light); 
            color: var(--white); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 600; 
            font-size: 1.2rem; 
            flex-shrink: 0;
        }
        
        .user-info { 
            overflow: hidden; 
        } 
        
        .user-name { 
            font-weight: 600; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        } 
        
        .user-role { 
            font-size: 0.8rem; 
            opacity: 0.85; 
            white-space: nowrap;
        }

        .sidebar-footer { 
            text-align: center; 
            color: rgba(255,255,255,0.6); 
            font-size: 0.8rem; 
            padding-top: 0.5rem; 
        }

        main { 
            flex: 1; 
            margin-left: var(--sidebar-width); 
            transition: margin var(--transition-speed) ease; 
            width: calc(100% - var(--sidebar-width)); 
            height: 100vh; 
            display: flex; 
            flex-direction: column;
        }

        .main-header { 
            padding: 1.2rem 2rem; 
            background-color: var(--white); 
            box-shadow: 0 2px 6px rgba(0,0,0,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-shrink: 0; 
            z-index: 10;
        }

        .header-content { 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        } 
        
        .header-content h1 { 
            font-size: 1.75rem; 
            font-weight: 600; 
            color: var(--dark); 
            margin: 0; 
        } 
        
        .header-actions button, 
        .header-actions a { 
            font-size: 0.95rem; 
            padding: 0.7rem 1.4rem; 
            border-radius: var(--btn-radius);
            margin-left: 10px;
        }

        .topic-loading-bar { 
            padding: 1rem 2rem; 
            background-color: var(--light); 
            border-bottom: 1px solid var(--gray-light); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            flex-shrink: 0;
        }

        #current-topic-display { 
            font-size: 1.15rem; 
            font-weight: 500; 
            color: var(--text-secondary); 
        } 
        
        #current-topic-display strong { 
            color: var(--primary); 
            font-weight: 600; 
        } 
        
        #current-topic-display .placeholder { 
            color: var(--text-muted); 
            font-style: italic;
        }

        .call-interface { 
            flex-grow: 1; 
            display: flex; 
            overflow: hidden; 
            padding: 1.75rem 2rem; 
            gap: 2rem; 
        }

        .ai-presenter-area { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            background-color: var(--call-panel-bg); 
            border-radius: var(--card-radius); 
            box-shadow: var(--shadow-md); 
            overflow: hidden; 
            transition: box-shadow 0.2s ease;
            max-height: 100%;
        }

        .ai-presenter-area:hover { 
            box-shadow: var(--shadow-lg); 
        } 
        
        .ai-presenter-header { 
            padding: 1.2rem 1.5rem; 
            border-bottom: 1px solid var(--gray-light); 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            background-color: rgba(255, 255, 255, 0.9);
        }
        
        .ai-avatar-placeholder { 
            width: var(--avatar-size); 
            height: var(--avatar-size); 
            border-radius: 50%; 
            background: var(--gradient-1); 
            color: var(--white); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.3rem;
        }
        
        .ai-presenter-info { 
            flex-grow: 1; 
        } 
        
        .ai-presenter-info h2 { 
            font-size: 1.3rem; 
            margin: 0; 
            font-weight: 600; 
        } 
        
        .ai-presenter-info p { 
            font-size: 0.9rem; 
            color: var(--text-secondary); 
            margin: 2px 0 0 0;
        }

        #excalidraw-container { 
            flex-grow: 1; 
            position: relative; 
            overflow: hidden; 
            border-radius: 0 0 var(--card-radius) var(--card-radius); 
            background-color: var(--white); 
            min-height: 0; 
            display: flex;
            flex-direction: column;
        }

        #excalidraw-container > .excalidraw-wrapper { 
            width: 100% !important; 
            height: 100% !important; 
            display: flex !important; 
            flex-direction: column !important; 
        } 
        
        #excalidraw-container .excalidraw .App { 
            min-height: 0 !important; 
        }

        .interaction-panel { 
            width: 450px; 
            flex-shrink: 0; 
            display: flex; 
            flex-direction: column; 
            background-color: var(--call-panel-bg); 
            border-radius: var(--card-radius); 
            box-shadow: var(--shadow-md); 
            transition: box-shadow 0.2s ease;
        }

        .interaction-panel:hover { 
            box-shadow: var(--shadow-lg); 
        } 
        
        .interaction-tabs { 
            display: flex; 
            border-bottom: 1px solid var(--gray-light); 
            background-color: #fdfdff; 
            flex-shrink: 0; 
            border-radius: var(--card-radius) var(--card-radius) 0 0;
        } 
        
        .interaction-tab { 
            flex-grow: 1; 
            flex-basis: 0; 
            text-align: center; 
            padding: 1.2rem 1rem; 
            cursor: pointer; 
            font-weight: 500; 
            color: var(--text-secondary); 
            border-bottom: 3px solid transparent; 
            transition: all 0.2s ease; 
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .interaction-tab:hover { 
            color: var(--primary); 
            background-color: rgba(var(--primary-rgb), 0.04); 
        } 
        
        .interaction-tab.active { 
            color: var(--primary); 
            border-bottom-color: var(--primary); 
            background-color: rgba(var(--primary-rgb), 0.06);
        }

        .interaction-content-area { 
            flex-grow: 1; 
            overflow: hidden; 
            position: relative; 
            background-color: var(--call-panel-bg); 
            min-height: 0; 
            border-radius: 0 0 var(--card-radius) var(--card-radius);
        }

        .tab-content { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            visibility: hidden; 
            opacity: 0; 
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .tab-content.active { 
            visibility: visible; 
            opacity: 1; 
            z-index: 1;
        }

        .explanation-scroll-content { 
            flex-grow: 1; 
            padding: 1.75rem 2rem; 
            overflow-y: auto; 
            scrollbar-width: thin; 
            scrollbar-color: var(--gray-light) transparent; 
            min-height: 0; 
        } 
        
        .explanation-scroll-content::-webkit-scrollbar { 
            width: 8px; 
        } 
        
        .explanation-scroll-content::-webkit-scrollbar-track { 
            background: transparent; 
        } 
        
        .explanation-scroll-content::-webkit-scrollbar-thumb { 
            background-color: var(--gray-light); 
            border-radius: 20px; 
            border: 3px solid var(--call-panel-bg);
        }

        #explanation-display { 
            line-height: 1.7; 
            font-size: 1rem; 
        } 
        
        #explanation-display .step { 
            margin-bottom: 1.75rem; 
            padding: 1.5rem; 
            border-radius: 12px; 
            background-color: #ffffff; 
            border: 1px solid var(--gray-light); 
            box-shadow: var(--shadow-sm);
        }
        
        #explanation-display .step:last-child { 
            margin-bottom: 0; 
        } 
        
        #explanation-display .step .step-title { 
            font-weight: 600; 
            margin-bottom: 0.75rem; 
            color: var(--primary);
        }

        .explanation-controls { 
            flex-shrink: 0; 
            margin-top: auto; 
            padding: 1.25rem 2rem; 
            border-top: 1px solid var(--gray-light); 
            text-align: center; 
            background-color: #f8f9fa; 
            display: flex; 
            justify-content: center; 
            gap: 1rem;
            border-radius: 0 0 var(--card-radius) var(--card-radius);
        }

        #chat-tab-content { 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
        }

        .chat-messages { 
            flex-grow: 1; 
            padding: 1.5rem; 
            overflow-y: auto; 
            scrollbar-color: var(--gray-light) var(--call-panel-bg); 
            min-height: 0; 
        }

        .chat-messages::-webkit-scrollbar { 
            width: 8px; 
        } 
        
        .chat-messages::-webkit-scrollbar-track { 
            background: var(--call-panel-bg); 
        } 
        
        .chat-messages::-webkit-scrollbar-thumb { 
            background-color: var(--gray-light); 
            border-radius: 20px; 
            border: 3px solid var(--call-panel-bg);
        }

        .chat-input-area { 
            flex-shrink: 0; 
            padding: 1.25rem 1.5rem; 
            background-color: #f8f9fa; 
            border-top: 1px solid var(--gray-light); 
            display: flex; 
            align-items: flex-end; 
            gap: 1rem; 
        }

        .chat-message { 
            display: flex; 
            gap: 1rem; 
            max-width: 92%; 
            align-items: flex-end; 
            margin-bottom: 1.5rem; 
        }

        .chat-message.user { 
            margin-left: auto; 
            flex-direction: row-reverse; 
        } 
        
        .message-avatar { 
            width: var(--avatar-size); 
            height: var(--avatar-size); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: var(--white); 
            font-weight: 600; 
            flex-shrink: 0; 
            font-size: 1.25rem;
        }
        
        .user .message-avatar { 
            background-color: var(--info); 
        } 
        
        .ai .message-avatar { 
            background: var(--gradient-1);
        }

        .message-content { 
            max-width: calc(100% - var(--avatar-size) - 12px); 
            border-radius: 16px; 
            padding: 0.75rem 1.25rem; 
            position: relative; 
            box-shadow: var(--shadow-sm); 
            font-size: 0.95rem; 
            line-height: 1.5; 
            color: var(--text-primary);
            animation: fadeIn 0.3s ease;
        }
        
        .user .message-content { 
            background-color: var(--primary); 
            color: var(--white); 
            border-top-right-radius: 4px;
        }
        
        .ai .message-content { 
            background-color: var(--white); 
            border: 1px solid var(--gray-light); 
            border-top-left-radius: 4px;
        }

        .message-time { 
            font-size: 0.75rem; 
            margin-top: 4px; 
            opacity: 0.8; 
            text-align: right;
        }

        .message-thinking-indicator { 
            background: var(--white); 
            display: flex; 
            align-items: center; 
            padding: 1rem 1.25rem; 
            border-radius: 16px; 
            box-shadow: var(--shadow-sm); 
            border: 1px solid #eef2f7; 
            color: var(--text-secondary);
        }
        
        .thinking-dots { 
            display: flex; 
            align-items: center; 
            gap: 4px;
        }
        
        .thinking-dots span { 
            width: 8px; 
            height: 8px; 
            background-color: var(--primary); 
            border-radius: 50%; 
            display: inline-block; 
            opacity: 0.6; 
            animation: thinking 1.4s infinite;
        }
        
        .thinking-dots span:nth-child(2) { 
            animation-delay: 0.2s; 
        } 
        
        .thinking-dots span:nth-child(3) { 
            animation-delay: 0.4s;
        }

        @keyframes thinking { 
            0%, 100% { transform: translateY(0); opacity: 0.6; } 
            50% { transform: translateY(-4px); opacity: 1; }
        }

        .chat-input { 
            flex-grow: 1; 
            padding: 1rem 1.25rem; 
            border: 1px solid var(--gray-light); 
            border-radius: 20px; 
            font-size: 1rem; 
            resize: none; 
            max-height: 150px; 
            overflow-y: auto; 
            transition: border-color 0.3s ease; 
            box-shadow: none; 
            outline: none; 
            font-family: inherit; 
            line-height: 1.5;
            background-color: var(--white);
        }
        
        .chat-input:focus { 
            border-color: var(--primary-light); 
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.15);
        }

        .chat-send-btn { 
            background-color: var(--primary); 
            color: var(--white); 
            border: none; 
            border-radius: 50%; 
            width: 48px; 
            height: 48px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.25rem; 
            cursor: pointer; 
            flex-shrink: 0; 
            transition: all 0.2s ease; 
            box-shadow: 0 2px 8px rgba(var(--primary-rgb), 0.4);
        }
        
        .chat-send-btn:hover { 
            background-color: var(--secondary); 
            box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.5);
        }
        
        .chat-send-btn:disabled { 
            background-color: var(--gray); 
            cursor: not-allowed; 
            box-shadow: none;
        }

        .chat-controls { 
            flex-shrink: 0; 
            padding: 0.75rem 1.5rem; 
            font-size: 0.85rem; 
            color: var(--text-muted); 
            text-align: right; 
            background-color: #f8f9fa; 
            border-top: 1px solid var(--gray-light); 
            border-radius: 0 0 var(--card-radius) var(--card-radius);
        } 
        
        .chat-controls button { 
            background: none; 
            border: none; 
            color: var(--primary); 
            cursor: pointer; 
            font-size: 0.85rem; 
            padding: 0.3rem 0.5rem; 
            margin-left: 0.5rem; 
            border-radius: 4px; 
            transition: background-color 0.2s;
        }
        
        .chat-controls button:hover { 
            text-decoration: underline; 
            background-color: rgba(var(--primary-rgb), 0.05);
        }

        .loading-placeholder { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 3rem 2rem; 
            text-align: center; 
            font-style: italic; 
            color: var(--text-muted); 
            flex-grow: 1; 
            gap: 1.5rem;
        }
        
        .loading-placeholder i { 
            font-size: 2.5rem; 
            color: var(--primary-light); 
            animation: loading-spin 1.5s linear infinite;
        }
        
        .loading-placeholder p { 
            font-size: 1.1rem;
        }

        @keyframes loading-spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); }
        }

        .empty-state { 
            text-align: center; 
            padding: 3rem 2rem; 
            color: var(--text-secondary); 
            margin-top: 1rem; 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            gap: 1rem;
        }
        
        .empty-state i { 
            font-size: 3rem; 
            color: var(--primary); 
            opacity: 0.5; 
            margin-bottom: 0.5rem;
        }
        
        .empty-state h3 { 
            font-size: 1.3rem; 
            font-weight: 600; 
            margin-bottom: 0.5rem;
        }
        
        .empty-state p { 
            max-width: 400px; 
            margin: 0 auto 1.5rem auto; 
            line-height: 1.6;
        }

        .btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            padding: 0.75rem 1.5rem; 
            border-radius: var(--btn-radius); 
            font-weight: 500; 
            font-size: 0.95rem; 
            text-decoration: none; 
            transition: all 0.2s ease; 
            cursor: pointer; 
            border: none; 
            outline: none; 
            gap: 0.5rem;
        }
        
        .btn-primary { 
            background-color: var(--primary); 
            color: var(--white); 
            box-shadow: 0 2px 8px rgba(var(--primary-rgb), 0.35);
        }
        
        .btn-primary:hover { 
            background-color: var(--secondary); 
            box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.45);
        }
        
        .btn-secondary { 
            background-color: #e9f0ff; 
            color: var(--primary);
        }
        
        .btn-secondary:hover { 
            background-color: #dae6ff;
        }
        
        .btn-outline { 
            background-color: transparent; 
            border: 1px solid var(--gray); 
            color: var(--text-secondary);
        }
        
        .btn-outline:hover { 
            border-color: var(--primary); 
            color: var(--primary); 
            background-color: rgba(var(--primary-rgb), 0.04);
        }
        
        .btn:disabled { 
            opacity: 0.65; 
            cursor: not-allowed; 
            box-shadow: none;
        }

        mjx-math[display="inline"] { 
            color: var(--secondary); 
            background-color: rgba(var(--primary-rgb), 0.1); 
            padding: 0.15em 0.4em; 
            border-radius: 4px; 
            font-weight: 500; 
            border: 1px solid rgba(var(--primary-rgb), 0.15);
        }
        
        mjx-math[display="block"] { 
            margin: 1.5rem 0; 
            border: 1px solid rgba(var(--primary-rgb), 0.2); 
            border-radius: 8px; 
            padding: 1.25rem; 
            background-color: rgba(var(--primary-rgb), 0.05);
        }

        .mobile-menu-toggle { 
            display: none; 
            background: none; 
            border: none; 
            cursor: pointer; 
            color: var(--dark); 
            font-size: 1.75rem; 
            margin-right: 1.25rem; 
            padding: 0.5rem; 
            z-index: 1060; 
            transition: color 0.2s;
        }
        
        .mobile-menu-toggle:hover { 
            color: var(--primary);
        }

        .sidebar-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.55); 
            z-index: 1040; 
            opacity: 0; 
            transition: opacity 0.3s ease; 
            backdrop-filter: blur(2px);
        }
        
        .sidebar-overlay.active { 
            opacity: 1;
        }

        @keyframes fadeIn { 
            0% { opacity: 0; transform: translateY(8px); } 
            100% { opacity: 1; transform: translateY(0); } 
        }

        @media (max-width: 1200px) { 
            .interaction-panel { width: 420px; } 
            .call-interface { padding: 1.5rem; gap: 1.5rem; }
            :root { --font-base-size: 15px; }
        }

        @media (max-width: 992px) { 
            :root { --sidebar-width: 80px; --font-base-size: 15px; } 
            .sidebar { width: 80px; } 
            .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; } 
            .sidebar-link i { font-size: 1.5rem; min-width: unset; } 
            .user-avatar { margin: 0 auto; } 
            .sidebar-header { justify-content: center; } 
            .interaction-panel { width: 380px; }
            #excalidraw-container .excalidraw .layer-ui__wrapper .App-menu_top__left { flex-wrap: wrap; gap: 4px; }
            .chat-input-area { gap: 0.8rem; } 
            .chat-send-btn { width: 44px; height: 44px; font-size: 1.1rem; }
        }

        @media (max-width: 768px) { 
            :root { --font-base-size: 14px; }
            .main-header { padding: 1rem 1.25rem; } 
            .header-content h1 { font-size: 1.5rem; } 
            .interaction-tab { padding: 1rem 0.75rem; font-size: 0.95rem; } 
            .chat-input { font-size: 0.95rem; padding: 0.85rem 1rem; } 
            .call-interface { flex-direction: column; padding: 1.25rem; gap: 1.25rem; } 
            .interaction-panel { width: 100%; }
            .explanation-scroll-content, .chat-messages { padding: 1.5rem; }
            .explanation-controls { padding: 1rem 1.5rem; }
            .ai-presenter-header { padding: 1rem 1.25rem; }
        }

        @media (max-width: 576px) { 
            :root { --sidebar-width: 0; --font-base-size: 14px; } 
            .sidebar { transform: translateX(-100%); z-index: 1050; width: 260px; } 
            .sidebar.active { transform: translateX(0); } 
            .sidebar.active ~ .sidebar-overlay { display: block; } 
            .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: block; } 
            .sidebar-link i { font-size: initial; min-width: 28px; } 
            .user-avatar { margin: 0; } 
            .sidebar-header { justify-content: flex-start; } 
            .mobile-menu-toggle { display: flex; }
            .chat-message { max-width: 95%; }
            .message-content { padding: 0.7rem 1rem; font-size: 0.9rem; }
            .btn { padding: 0.7rem 1.2rem; font-size: 0.9rem; }
            .main-header { padding: 0.85rem 1rem; }
            .topic-loading-bar { padding: 0.85rem 1rem; }
            .call-interface { padding: 1rem; gap: 1rem; }
            .empty-state { padding: 2rem 1rem; }
            .loading-placeholder { padding: 2rem 1rem; }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) { 
            :root { 
                --white: #1a202c; 
                --light: #2d3748; 
                --dark: #e2e8f0; 
                --gray-light: #4a5568; 
                --text-primary: #e2e8f0; 
                --text-secondary: #cbd5e0; 
                --text-muted: #a0aec0; 
                --call-bg: #171923; 
                --call-panel-bg: #1e2533;
                --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.3);
                --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.3);
            }
            
            .ai .message-content { 
                background-color: #2d3748; 
                border-color: #4a5568; 
            }
            
            .btn-secondary { 
                background-color: #2d3748; 
                color: #63b3ed; 
            }
            
            .btn-secondary:hover { 
                background-color: #4a5568; 
            }
            
            #explanation-display .step { 
                background-color: #2d3748; 
                border-color: #4a5568; 
            }
            
            .message-thinking-indicator { 
                background-color: #2d3748; 
                border-color: #4a5568; 
            }
        }

        .toast { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background-color: var(--white); 
            color: var(--text-primary); 
            border-radius: 8px; 
            padding: 1rem 1.2rem; 
            box-shadow: var(--shadow-lg); 
            max-width: 300px; 
            z-index: 9999; 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            transform: translateY(100px); 
            opacity: 0; 
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .toast.show { 
            transform: translateY(0); 
            opacity: 1; 
        }
        
        .toast i { 
            font-size: 1.25rem; 
            color: var(--primary); 
        }
        
        .toast.info i { color: var(--info); }
        .toast.success i { color: var(--success); }
        .toast.error i { color: var(--danger); }
        .toast.warning i { color: var(--warning); }
    </style>
</head>
<body>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header"> <a href="/" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
        <ul class="sidebar-menu">
            <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Dashboard</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li>
        </ul>
        <div class="user-profile"> 
            <div class="user-avatar" id="user-avatar">?</div> 
            <div class="user-info"> 
                <div class="user-name" id="user-name">Načítání...</div> 
                <div class="user-role">Student</div> 
            </div>
        </div>
        <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main>
        <div class="main-header">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 1rem;"> 
                    <button class="mobile-menu-toggle" id="mobile-menu-toggle"> 
                        <i class="fas fa-bars"></i> 
                    </button> 
                    <h1>Interaktivní výuka</h1>
                </div>
                <div class="header-actions"> 
                    <a href="/dashboard/procvicovani/main.html" class="btn btn-secondary"> 
                        <i class="fas fa-times"></i> Ukončit výuku 
                    </a> 
                </div>
            </div>
        </div>
        <div class="topic-loading-bar"> 
            <div id="current-topic-display"><span class="placeholder">Načítám data...</span></div> 
        </div>
        <div class="call-interface" style="display: none;">
            <div class="ai-presenter-area">
                <div class="ai-presenter-header"> 
                    <div class="ai-avatar-placeholder"> 
                        <i class="fas fa-chalkboard-teacher"></i> 
                    </div> 
                    <div class="ai-presenter-info"> 
                        <h2>AI Tutor Justax</h2> 
                        <p id="ai-status-text">Připraven</p>
                    </div>
                </div>
                <div id="excalidraw-container"> 
                    <div class="loading-placeholder">
                        <i class="fas fa-spinner"></i>
                        <p>Načítám kreslící plochu...</p>
                    </div> 
                </div>
            </div>
            <div class="interaction-panel">
                <div class="interaction-tabs"> 
                    <div class="interaction-tab active" data-tab="explanation-tab"> 
                        <i class="fas fa-graduation-cap"></i> Vysvětlení 
                    </div> 
                    <div class="interaction-tab" data-tab="chat-tab"> 
                        <i class="fas fa-comments"></i> Chat 
                    </div>
                </div>
                <div class="interaction-content-area">
                    <div id="explanation-tab-content" class="tab-content active"> 
                        <div class="explanation-scroll-content"> 
                            <div id="explanation-display"> 
                                <div class="empty-state"> 
                                    <i class="fas fa-book-reader"></i>
                                    <h3>Začínáme s výukou</h3>
                                    <p>Vyberte téma a AI tutor vám začne vysvětlovat základy krok za krokem.</p>
                                </div>
                            </div>
                        </div>
                        <div class="explanation-controls"> 
                            <button class="btn btn-outline" id="btn-prev-step" disabled> 
                                <i class="fas fa-chevron-left"></i> Předchozí 
                            </button>
                            <button class="btn btn-primary" id="btn-next-step" disabled> 
                                Další <i class="fas fa-chevron-right"></i> 
                            </button>
                            <button class="btn btn-secondary" id="btn-complete" disabled> 
                                <i class="fas fa-check"></i> Dokončit 
                            </button>
                        </div>
                    </div>
                    <div id="chat-tab-content" class="tab-content"> 
                        <section class="chat-area" style="display: flex; flex-direction: column; height: 100%;"> 
                            <div class="chat-messages" id="chat-messages">
                                <div class="empty-state">
                                    <i class="fas fa-comment-dots"></i>
                                    <h3>Žádné zprávy</h3>
                                    <p>Máte otázku k tématu? Zeptejte se AI tutora a získejte okamžitou odpověď.</p>
                                </div>
                            </div>
                            <div class="chat-input-area">
                                <textarea id="chat-input" class="chat-input" placeholder="Napište svoji zprávu..." rows="1"></textarea>
                                <button class="chat-send-btn" id="chat-send-btn" disabled>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            <div class="chat-controls">
                                <span>Využijte chat pro doplňující otázky k tématu</span>
                                <button id="btn-clear-chat">Vymazat</button>
                                <button id="btn-save-pdf">Uložit PDF</button>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div class="toast" id="toast"> 
        <i class="fas fa-info-circle"></i> 
        <div id="toast-message">Operace úspěšná.</div> 
    </div>

    <script>
        // Весь JavaScript код сохранен без изменений, так как вы просили не менять функциональность
        // Wrap the entire script in a try-catch block for robust error handling
        try {
            // --- Constants & Configuration ---
            const SUPABASE_URL = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1Njky[...]
            const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // !!! SECURITY WARNING: Hardcoding API keys is insecure. Use environment variables or a backend proxy in production!
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            const EXCALIDRAW_SCENE_REGEX = /EXCALIDRAW_SCENE:\s*```json\s*(\[[\s\S]*?\])\s*```\s*/g; // Regex to extract Excalidraw data

            // --- DOM Elements Cache ---
            const uiElements = { userAvatar: document.getElementById('user-avatar'), userName: document.getElementById('user-name'), mobileMenuToggle: document.getElementById('mobile-menu-toggle'), si[...]

            // --- Global State ---
            let state = { supabase: null, currentUser: null, currentProfile: null, currentTopic: null, currentPlanId: null, currentSessionId: null, geminiChatContext: [], excalidrawAPI: null, excalidr[...]

            // --- Utility Functions ---
            const sanitizeHTML = (str) => { const temp = document.createElement('div'); temp.textContent = str || ''; return temp.innerHTML; };
            const getInitials = (profile, email) => { if (!profile && !email) return '?'; let initials = ''; if (profile?.first_name) initials += profile.first_name[0]; if (profile?.last_name) initial[...]
            const showToast = (message, type = 'info', duration = 4000) => { if (!uiElements.toast || !uiElements.toastMessage) return; console.log(`Toast (${type}): ${message}`); uiElements.toastMess[...]
            const renderMarkdown = (element, markdownText) => { if (!element) return; console.log("Rendering Markdown in element:", element); try { element.innerHTML = marked.parse(markdownText || '')[...]
            const autoResizeTextarea = () => { if (!uiElements.chatInput) return; uiElements.chatInput.style.height = 'auto'; const scrollHeight = uiElements.chatInput.scrollHeight; const maxHeight = [...]
            const generateSessionId = () => `session_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
            const formatTimestamp = (date = new Date()) => date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
            const updateAIStatus = (text) => { if (uiElements.aiStatusText) uiElements.aiStatusText.textContent = text; };

            // --- Initialization Functions ---
            const initializeSupabase = () => { console.log("Initializing Supabase..."); try { if (typeof window.supabase === 'undefined' || typeof window.supabase.createClient !== 'function') throw ne[...]
            const initializeUI = () => { console.log("Initializing UI elements and Excalidraw..."); if (!initializeExcalidraw()) { showToast("Chyba inicializace Excalidraw!", "error", 10000); if(uiEle[...]
            const initializeApp = async () => { console.log("DOM Loaded. Initializing Justax AI Tutor (Excalidraw Mode)..."); if (!initializeSupabase()) return; if (!initializeUI()) return; console.lo[...]

            // --- UI State Management ---
            const manageUIState = (mode) => { console.log("Managing UI State:", mode); const showCallInterface = state.currentTopic && !['loggedOut', 'noPlan', 'planComplete'].includes(mode); if (uiEl[...]
            const manageButtonStates = () => { const enableSend = !state.geminiIsThinking && !!state.currentTopic; const enableNext = !state.geminiIsThinking && !!state.currentTopic; const enableCompl[...]

            // --- Excalidraw Functions ---
            const initializeExcalidraw = () => { console.log("Initializing Excalidraw..."); const container = uiElements.excalidrawContainer; if (!container) { console.error("Excalidraw container not [...]
            /** Safely updates the Excalidraw scene, including error catching. */
            const updateExcalidrawScene = (elements) => {
                // Ensure API is ready
                if (!state.excalidrawAPI) { console.warn("Excalidraw API not available for scene update."); return; }
                // Basic check if elements is an array
                if (!Array.isArray(elements)) { console.warn("Attempted to update scene with non-array elements:", elements); elements = []; } // Default to empty if invalid

                console.log(`Updating Excalidraw scene with ${elements.length} elements.`);
                if (elements.length > 0) console.log("First few elements data (structure check):", elements.slice(0,2).map(el => ({type: el?.type, id: el?.id})));

                // Hide loading placeholder if present
                const placeholder = uiElements.excalidrawContainer?.querySelector('.loading-placeholder');
                if (placeholder) placeholder.style.display = 'none';

                // Wrap the core API call in a try...catch
                try {
                    state.excalidrawAPI.updateScene({ elements: elements });
                    state.excalidrawElements = elements; // Update local state if successful

                    // Scroll to content after update
                    setTimeout(() => {
                        if (state.excalidrawAPI?.scrollToContent) {
                            const currentElements = state.excalidrawAPI.getSceneElements();
                            if (currentElements?.length > 0) {
                                console.log("Attempting to scroll to content...");
                                state.excalidrawAPI.scrollToContent(currentElements, { fitToContent: true, duration: 300 });
                            } else { console.log("No elements to scroll to after update."); }
                        } else { console.warn("scrollToContent function not available on Excalidraw API."); }
                    }, 200);
                } catch (error) {
                    // Catch errors specifically from excalidrawAPI.updateScene
                    console.error("!!! Error during ExcalidrawLib.updateScene call:", error);
                    showToast("Chyba při vykreslování na plochu Excalidraw.", "error");
                    // Log the problematic data for better debugging
                    console.error("Data that caused the rendering error:", elements);
                }
            };


            // --- User Profile & Auth ---
            const loadUserProfile = async () => { if (!state.supabase) return; try { const { data: { user }, error: userError } = await state.supabase.auth.getUser(); if (userError) throw userError; i[...]
            const updateUserInfoUI = () => { if (uiElements.userName && uiElements.userAvatar) { if (state.currentProfile || state.currentUser) { const email = state.currentUser?.email; const initials[...]
            const handleLoggedOutUser = () => { console.warn("User not logged in."); updateAIStatus("Přihlaste se pro zahájení výuky."); if (uiElements.currentTopicDisplay) uiElements.currentTopic[...]

            // --- Event Listeners Setup ---
            const setupEventListeners = () => { console.log("Setting up event listeners..."); if (uiElements.mobileMenuToggle && uiElements.sidebar && uiElements.sidebarOverlay) { uiElements.mobileMen[...]
            const initTooltips = () => { try { if (window.jQuery && window.jQuery.fn.tooltipster) { window.jQuery('.btn-tooltip:not(.tooltipstered)').tooltipster({ theme: 'tooltipster-shadow', animati[...]

            // --- Topic Loading and Progress ---
            const loadNextUncompletedTopic = async () => { if (!state.currentUser || state.topicLoadInProgress || !state.supabase) { console.log("Skipping topic load:", { loggedIn: !!state.currentUser[...]
            const handleMarkTopicComplete = async () => { if (!state.currentTopic || !state.currentTopic.activity_id || !state.supabase || state.topicLoadInProgress) return; console.log(`Marking activ[...]

            // --- Learning Session Management ---
            const startLearningSession = async () => { if (!state.currentTopic || !state.currentUser || !state.supabase) { console.error("Cannot start session: Missing data."); updateAIStatus('Chyba: [...]
            const switchInteractionTab = (tabId) => { uiElements.interactionTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabId)); uiElements.tabContents.forEach(content => co[...]
            const requestNextStep = async () => { if (state.geminiIsThinking || !state.currentTopic) return; console.log("Requesting next step..."); updateGeminiThinkingState(true); manageButtonStates[...]

            // --- Chat Functionality ---
            const addChatMessage = async (message, sender, saveToDb = true, timestamp = new Date()) => { if (!uiElements.chatMessages) return; const messageId = `msg-${Date.now()}-${Math.random().toSt[...]
            const updateGeminiThinkingState = (isThinking) => { state.geminiIsThinking = isThinking; manageButtonStates(); if (isThinking) addThinkingIndicator(); else removeThinkingIndicator(); };
            const addThinkingIndicator = () => { if (state.thinkingIndicatorId || !uiElements.chatMessages) return; const indicatorDiv = document.createElement('div'); indicatorDiv.className = 'chat-m[...]
            const removeThinkingIndicator = () => { if (state.thinkingIndicatorId) { const indicator = document.getElementById(state.thinkingIndicatorId); if (indicator) indicator.remove(); state.thin[...]
            const handleSendMessage = async () => { const messageText = uiElements.chatInput.value.trim(); if (!messageText || state.geminiIsThinking || !state.currentTopic) return; uiElements.chatInp[...]
            const confirmClearChat = () => { if (confirm("Opravdu chcete vymazat historii tohoto chatu a kresbu?\nTato akce je nevratná.")) { clearCurrentChatSessionHistory(); } };

            // *** CORRECTED clearCurrentChatSessionHistory function ***
            const clearCurrentChatSessionHistory = async () => {
                 // Clear UI elements
                 if (uiElements.chatMessages) uiElements.chatMessages.innerHTML = '';
                 state.geminiChatContext = []; // Clear context for Gemini
                 updateExcalidrawScene([]); // Clear Excalidraw canvas
                 showToast("Historie chatu a kresba vymazána.", "info");
                 console.log("Chat history and Excalidraw cleared for this session.");

                 // Delete from Database if possible
                 if (state.supabase && state.currentUser && state.currentSessionId) {
                     try { // <<< TRY block starts here
                         console.log(`Deleting chat history from DB for session: ${state.currentSessionId}`);
                         // Delete records matching user_id and session_id
                         const { error } = await state.supabase
                             .from('chat_history')
                             .delete()
                             .eq('user_id', state.currentUser.id)
                             .eq('session_id', state.currentSessionId);

                         if (error) {
                             // Log and notify user about DB error
                             console.error("Error deleting chat history from DB:", error);
                             showToast("Chyba při mazání historie z databáze.", "error");
                         } else {
                             console.log("Chat history deleted from DB.");
                             // Optional: Could add a success toast here if needed
                         }
                     } catch (dbError) { // <<< CATCH block now correctly follows TRY
                         console.error("Exception during DB chat history deletion:", dbError);
                         // Optionally show a different toast for exceptions
                         showToast("Nastala výjimka při mazání historie z DB.", "error");
                     } // <<< CORRECT: Brace now closes the TRY...CATCH structure
                 } // <<< Brace closes the IF statement
            }; // <<< Brace closes the function
            // *** END OF CORRECTED FUNCTION ***

            const saveChatToPDF = async () => { if (!uiElements.chatMessages || uiElements.chatMessages.children.length === 0) { showToast("Není co uložit.", "warning"); return; } showToast("Generuj[...]

            // --- Gemini Interaction & Excalidraw Processing ---
            /** Extracts Excalidraw JSON data from Gemini's response text. */
            const parseExcalidrawScene = (responseText) => { console.log("Attempting to parse Excalidraw scene data..."); EXCALIDRAW_SCENE_REGEX.lastIndex = 0; const match = EXCALIDRAW_SCENE_REGEX.exe[...]
            /** Validates Excalidraw elements, logging details about invalid ones. */
            const validateExcalidrawElements = (elements) => { if (!Array.isArray(elements)) { console.error("Validation failed: Input is not an array."); return { isValid: false, invalidElements: [] [...]
            /** Adds missing default properties and attempts to fix common issues in Excalidraw elements. */
            const addDefaultExcalidrawProps = (elements) => { if (!Array.isArray(elements)) return elements; console.log("Patching Excalidraw elements with default properties..."); return elements.map[...]
            /** Processes Gemini response, handles Excalidraw data, and updates UI. */
            const processGeminiResponse = (rawResponseText, targetArea, timestamp) => { removeThinkingIndicator(); let chatSummary = null; const summaryRegex = /CHAT_SUMMARY:\s*([\s\S]*)/; const summa[...]

                        /** Builds the prompt for the initial explanation step. */
            const _buildInitialPrompt = () => {
                let prompt = `Jako AI Tutor "Justax" začni vysvětlovat ZÁKLADY tématu "${state.currentTopic.name}" pro studenta 9. třídy ZŠ (přijímačky CERMAT).`;
                if (state.currentTopic.description) { 
                    prompt += ` Popis tématu pro kontext: "${state.currentTopic.description}".`; 
                }
                prompt += ` Buď podrobný, přátelský a postupuj krok za krokem. Toto je ÚPLNĚ PRVNÍ krok vysvětlení tohoto tématu. **POUŽIJ kreslící plochu (Excalidraw) k VIZUALIZACI základních konceptů.**`;
                return prompt;
            }

            /** Builds the complete prompt for the Gemini API call including system instructions and history. */
            const _buildGeminiPayloadContents = (userPromptText, targetArea) => {
                 // Base system instruction defining the AI's role and rules
                 const systemInstructionText = `Jsi AI Tutor "Justax", expert na matematiku pro 9. třídu ZŠ v ČR (přijímačky CERMAT). Vyučuješ téma: "${state.currentTopic.name}"${state.currentTopic.description ? ' - ' + state.currentTopic.description : ''}.
                 
                 VŽDY POUŽÍVEJ KRESLÍCÍ PLOCHU (Excalidraw) k VIZUALIZACI pojmů, co vysvětluješ. Kreslící data vlož v tomto formátu: 
                 
                 EXCALIDRAW_SCENE: \`\`\`json
                 [tvoje JSON data kreslící plochy zde]
                 \`\`\`
                 
                 Vysvětluj jasně, srozumitelně a s vizuálními příklady. Používej matematické značení (TeX) $...$ pro vzorce. Rozděl vysvětlení do kroků.
                 
                 Pokud odpovídáš v chatu, shrň svou odpověď výstižně na konci ve formátu:
                 CHAT_SUMMARY: stručné shrnutí odpovědi (max 1-2 věty)`;

                 const historyForApi = state.geminiChatContext.filter(item => item.role === 'user' || item.role === 'model');
                 const currentRequestContent = { role: "user", parts: [{ text: userPromptText }] };
                 let contentsPayload;
                 
                 // Base system instruction part
                 const baseSystemInstruction = [{ role: "user", parts: [{ text: systemInstructionText }] }];
                 
                 // Priming model response (improves adherence to instructions)
                 const modelPriming = { role: "model", parts: [{ text: "Rozumím. Budu postupovat podle pokynů." }] };

                 // Construct payload based on history and target area
                 if (historyForApi.length === 0 && targetArea === 'explanation') {
                     // First explanation turn
                     contentsPayload = [ ...baseSystemInstruction, modelPriming, currentRequestContent ];
                 } else {
                     // Subsequent turns or chat
                     contentsPayload = [ ...baseSystemInstruction, modelPriming, ...historyForApi, currentRequestContent ];
                 }
                 return contentsPayload;
             }

            /** Sends prompt to Gemini and processes the response. */
            const sendToGemini = async (userPromptText, targetArea) => {
                 if (!GEMINI_API_KEY || !GEMINI_API_KEY.startsWith('AIzaSy')) { 
                     showToast("Chyba: AI není správně nakonfigurována.", "error"); 
                     updateGeminiThinkingState(false); 
                     return; 
                 }
                 if (!state.currentTopic) { 
                     showToast("Chyba: Není vybráno žádné téma.", "error"); 
                     updateGeminiThinkingState(false); 
                     return; 
                 }
                 console.log(`Sending to Gemini (Target: ${targetArea}): "${userPromptText.substring(0, 100)}..."`);
                 updateAIStatus('AI přemýšlí...');
                 const requestTimestamp = new Date();
                 updateGeminiThinkingState(true);

                 const contentsPayload = _buildGeminiPayloadContents(userPromptText, targetArea); // Use helper

                 const requestBody = {
                     contents: contentsPayload,
                     generationConfig: { 
                         temperature: 0.5, 
                         topP: 0.95, 
                         topK: 40, 
                         maxOutputTokens: 8192 
                     },
                     safetySettings: [ 
                         { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, 
                         { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, 
                         { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, 
                         { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" } 
                     ]
                 };

                 try {
                     console.log("Sending payload to Gemini:", JSON.stringify(requestBody).substring(0, 500) + "...");
                     const response = await fetch(GEMINI_API_URL, { 
                         method: 'POST', 
                         headers: { 'Content-Type': 'application/json' }, 
                         body: JSON.stringify(requestBody) 
                     });
                     
                     if (!response.ok) { 
                         const errorBody = await response.text(); 
                         console.error("Gemini API Error Response:", response.status, errorBody); 
                         throw new Error(`Chyba Gemini API (${response.status}): ${errorBody.substring(0, 100)}...`); 
                     }
                     
                     const data = await response.json();
                     console.log("Raw Gemini Response (first 300 chars):", JSON.stringify(data).substring(0, 300) + "...");
                     const candidate = data.candidates?.[0];
                     
                     if (!candidate) { 
                         console.error("Invalid response structure from Gemini:", data); 
                         const promptFeedback = data.promptFeedback; 
                         if (promptFeedback?.blockReason) 
                             throw new Error(`Obsah byl blokován: ${promptFeedback.blockReason}`); 
                         throw new Error('Neplatná odpověď z AI'); 
                     }
                     
                     if (candidate.finishReason && !["STOP", "MAX_TOKENS"].includes(candidate.finishReason)) 
                         console.warn(`Gemini generation stopped unexpectedly: ${candidate.finishReason}`);
                     
                     const geminiResponseText = candidate.content?.parts?.[0]?.text;
                     if (!geminiResponseText) { 
                         console.warn("Gemini returned empty text content."); 
                         throw new Error('AI vrátila prázdnou odpověď.'); 
                     }
                     // Add context AFTER successful response received
                     state.geminiChatContext.push({ role: "user", parts: [{ text: userPromptText }] });
                     state.geminiChatContext.push({ role: "model", parts: [{ text: geminiResponseText }] });
                     processGeminiResponse(geminiResponseText, targetArea, requestTimestamp);
                     updateAIStatus(state.currentTopic ? `Vysvětluje: ${state.currentTopic.name}` : 'Připraven');
                 } catch (error) {
                     console.error('Error sending/processing Gemini request:', error);
                     showToast(`Chyba komunikace s AI: ${error.message}`, "error");
                     handleGeminiError(error.message, targetArea, requestTimestamp);
                     updateAIStatus('Nastala chyba');
                 } finally {
                     updateGeminiThinkingState(false);
                 }
            };

            /** Displays error messages in the UI after a Gemini API failure. */
            const handleGeminiError = (errorMessage, targetArea, timestamp) => { 
                const errorMsg = `Omlouvám se, nastala chyba při zpracování: ${errorMessage}`; 
                removeThinkingIndicator(); 
                addChatMessage(errorMsg, 'ai', false, timestamp); 
            };

            // --- Run Application ---
            document.addEventListener('DOMContentLoaded', initializeApp);

        } catch (e) {
            // --- Fatal Error Handling ---
            console.error("FATAL SCRIPT ERROR:", e);
            document.body.innerHTML = `<div style="padding: 30px; text-align: center; font-family: sans-serif; color: #dc3545;">
                <h1>Nastala kritická chyba</h1>
                <p>Omlouváme se, aplikace nemohla být načtena kvůli neočekávané chybě.</p>
                <p style="color: #6c757d; font-family: monospace; margin-top: 20px; text-align: left; padding: 10px; background: #f8f9fa; border-radius: 4px; overflow-x: auto;">
                    ${e.message || 'Neznámá chyba'}
                </p>
                <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 15px; background: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Obnovit stránku
                </button>
            </div>`;
        }
    </script>

</body>
</html>