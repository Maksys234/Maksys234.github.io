<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Výuka s AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        window.MathJax = {
          tex: {
            inlineMath: [['\\(', '\\)']],
            displayMath: [['$$', '$$']],
            processEscapes: true,
            processEnvironments: true
          },
          options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            ignoreHtmlClass: 'tex2jax_ignore',
            processHtmlClass: 'tex2jax_process'
          }
        };
        </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/tldraw@1.24.2/dist/tldraw.js"></script>

    <style>
        /* --- Základní styly a proměnné (kombinace) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; scroll-behavior: smooth; }
        :root {
            --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9; --success: #06d6a0; --danger: #f72585; --warning: #f8961e; --info: #4cc9f0; /* Upraveno info */ --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d; --gray-light: #dee2e6; --gray-dark: #343a40; --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3); --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee); --white: #ffffff; --sidebar-width: 260px; --transition-speed: 0.3s; --card-radius: 16px; --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06); /* Jemnější stín */ --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.08); --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1); --text-primary: #2d3748; --text-secondary: #4a5568; --text-muted: #718096;
        }
        body { background-color: #f6f8ff; color: var(--text-primary); min-height: 100vh; display: flex; overflow-x: hidden; }

        /* --- Sidebar (beze změny) --- */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 100; box-shadow: var(--shadow-lg); transition: all var(--transition-speed) ease; }
        /* ... (ostatní styly sidebar stejné) ... */
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; }
        .sidebar-logo { font-size: 1.5rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo i { font-size: 1.75rem; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .sidebar-item { margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; color: rgba(255, 255, 255, 0.85); text-decoration: none; border-radius: 12px; transition: all 0.2s ease; font-weight: 500; }
        .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; width: 24px; text-align: center; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--white); }
        .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); text-align: center; }
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.1); border-radius: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-weight: 500; overflow: hidden; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; }
        .user-name { font-weight: 600; font-size: 0.95rem; }
        .user-role { font-size: 0.8rem; opacity: 0.8; }


        /* --- Hlavní obsah (kombinace) --- */
        main { flex: 1; margin-left: var(--sidebar-width); padding: 1.5rem 2rem; transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .dashboard-header { margin-bottom: 1.5rem; background-color: var(--white); border-radius: var(--card-radius); padding: 1.25rem 1.5rem; box-shadow: var(--shadow-sm); flex-shrink: 0; }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .header-title-section { display: flex; align-items: center; gap: 1rem; }
        .header-content h1 { font-size: 1.7rem; /* Větší nadpis */ font-weight: 600; color: var(--dark); margin: 0; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }

        /* --- Layout Výuky (kombinace) --- */
        .learning-layout { display: flex; flex-grow: 1; gap: 1.75rem; /* Větší mezera */ overflow: hidden; }
        .left-panel { flex: 1; display: flex; flex-direction: column; gap: 1.75rem; min-width: 400px; overflow: hidden; }
        .right-panel { width: 420px; /* Mírně širší chat */ flex-shrink: 0; display: flex; flex-direction: column; overflow: hidden; }

        /* --- Levé komponenty (vylepšené styly) --- */
        .section { background-color: var(--white); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); padding: 1.75rem; /* Větší padding */ animation: fadeIn 0.5s ease forwards; transition: box-shadow 0.3s ease; }
        .section:hover { box-shadow: var(--shadow-md); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 1.35rem; /* Mírně větší */ font-weight: 600; margin-bottom: 1.25rem; /* Větší mezera */ color: var(--dark); display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; border-bottom: 1px solid var(--gray-light); padding-bottom: 0.75rem; /* Linka pod nadpisem */ }
        .section-title i { color: var(--primary); margin-right: 0.6rem; font-size: 1.1em; }

        .topic-loading-section { flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; background-color: #f8f9fa; /* Lehce odlišené pozadí */ }
        #current-topic-display { font-size: 1.1rem; font-weight: 500; color: var(--text-secondary); }
        #current-topic-display strong { color: var(--primary); font-weight: 600; }
        #current-topic-display .placeholder { font-style: italic; color: var(--text-muted); }

        .explanation-section { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #explanation-content { flex-grow: 1; overflow-y: auto; padding-right: 12px; line-height: 1.75; /* Větší řádkování */ }
        #explanation-content p:last-child { margin-bottom: 0; }
        #explanation-content .step { margin-bottom: 1.25rem; padding-bottom: 1.25rem; border-bottom: 1px dashed var(--gray-light); }
        #explanation-content .step:last-child { border-bottom: none; }
        #explanation-content h3 { color: var(--secondary); margin-top: 1.75rem; margin-bottom: 0.8rem; font-size: 1.15rem; }
        #explanation-content code { background-color: rgba(67, 97, 238, 0.1); padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.95em; }
        #explanation-content pre code { display: block; background-color: var(--dark-bg); color: var(--light); padding: 1rem; border-radius: 8px; font-size: 0.9rem; line-height: 1.6; margin: 1rem 0; }
        #explanation-content strong { color: var(--dark); font-weight: 600; }

        .whiteboard-section { height: 400px; flex-shrink: 0; display: flex; flex-direction: column; padding: 0; overflow: hidden; background: transparent; box-shadow: none; border: none;} /* Odebrán padding a stíny sekce */
        .whiteboard-container { width: 100%; height: 100%; border-radius: var(--card-radius); overflow: hidden; position: relative; border: 1px solid var(--gray-light); box-shadow: var(--shadow-sm); }

        /* --- Pravý panel (Chat - vylepšený design) --- */
        .chat-area { display: flex; flex-direction: column; height: 100%; border: 1px solid transparent; /* Bez ohraničení */ border-radius: var(--card-radius); background-color: var(--white); overflow: hidden; box-shadow: var(--shadow-md); /* Výraznější stín chatu */ }
        .chat-header { padding: 0.8rem 1.3rem; /* Upravený padding */ border-bottom: 1px solid var(--gray-light); display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa; flex-shrink: 0; }
        .chat-header h3 { font-size: 1.15rem; font-weight: 600; color: var(--dark); margin: 0; display: flex; align-items: center; gap: 0.6rem; }
        .chat-header h3 i { color: var(--primary); font-size: 1.1em; }
        .chat-actions { display: flex; gap: 0.5rem; /* Menší mezera mezi ikonami */ }
        .chat-actions button { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.5rem; font-size: 1.15rem; /* Větší ikony */ transition: color 0.2s ease, transform 0.2s ease; border-radius: 50%; }
        .chat-actions button:hover { color: var(--primary); background-color: rgba(0,0,0,0.05); transform: scale(1.1); }
        .chat-actions button:disabled { color: var(--gray-light); cursor: not-allowed; background-color: transparent; transform: none; }
        .chat-actions button i { vertical-align: middle; }

        .chat-messages { flex-grow: 1; padding: 1rem 1.25rem; /* Větší padding */ overflow-y: auto; display: flex; flex-direction: column; gap: 1.25rem; /* Větší mezera mezi zprávami */ scrollbar-width: thin; /* Tenčí scrollbar */ scrollbar-color: var(--gray-light) var(--white); }
        .chat-messages::-webkit-scrollbar { width: 6px; } .chat-messages::-webkit-scrollbar-track { background: var(--white); } .chat-messages::-webkit-scrollbar-thumb { background-color: var(--gray-light); border-radius: 3px; }

        .chat-message { display: flex; gap: 0.8rem; max-width: 88%; align-items: flex-end; } /* Avatary trochu dál */
        .chat-message.user { margin-left: auto; flex-direction: row-reverse; }
        .message-avatar { width: 38px; height: 38px; /* Větší avatar */ border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1rem; flex-shrink: 0; box-shadow: var(--shadow-sm); border: 2px solid var(--white); /* Bílý okraj */ }
        .chat-message.user .message-avatar { background: var(--success); color: white; }
        .chat-message.gemini .message-avatar { background: var(--primary); color: white; }

        .message-bubble { padding: 0.9rem 1.2rem; /* Větší padding bubliny */ border-radius: 20px; /* Zaoblenější */ line-height: 1.6; word-wrap: break-word; box-shadow: var(--shadow-md); position: relative; transition: transform 0.2s ease; }
        .message-bubble:hover { transform: scale(1.01); } /* Lehký hover efekt */
        .chat-message.user .message-bubble { background: var(--gradient-1); /* Gradient pro uživatele */ color: white; border-bottom-right-radius: 6px; }
        .chat-message.gemini .message-bubble { background: var(--white); color: var(--text-primary); border: 1px solid #e9ecef; /* Jemnější border */ border-bottom-left-radius: 6px; }
        .message-timestamp { font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; display: block; text-align: right; opacity: 0.8; }
        .chat-message.gemini .message-timestamp { text-align: left; }
        .message-thinking-indicator { /* ... (stejné) ... */ }
        .typing-dot { /* ... */ }
        @keyframes typing { /* ... */ }

        .chat-input-area { display: flex; padding: 1rem 1.25rem; border-top: 1px solid var(--gray-light); background-color: #f8f9fa; flex-shrink: 0; align-items: flex-end; /* Zarovná tlačítko dolů s textarea */ }
        .chat-input { flex-grow: 1; padding: 0.8rem 1.1rem; border: 1px solid var(--gray-light); border-radius: 22px; /* Zaoblenější */ margin-right: 0.8rem; font-size: 1rem; resize: none; max-height: 150px; overflow-y: auto; transition: border-color 0.2s ease, box-shadow 0.2s ease; line-height: 1.4; }
        .chat-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15); }
        .send-button { padding: 0.7rem 1.3rem; border-radius: 22px; font-weight: 500; font-size: 1rem; cursor: pointer; border: none; background: var(--gradient-1); color: white; transition: all 0.3s ease; flex-shrink: 0; height: 44px; /* Stejná výška jako počáteční textarea */ display: flex; align-items: center; justify-content: center; }
        .send-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(67, 97, 238, 0.2); }
        .send-button i { font-size: 1.1em; }
        .send-button .fa-spinner { margin: 0; }

        /* --- Utility & State Styles (vylepšené) --- */
        .loading { /* ... */ } .loading::after { /* ... */ } @keyframes loading-spinner { /* ... */ }
        .empty-state { /* ... */ } .empty-state i { /* ... */ } .empty-state h3 { /* ... */ } .empty-state p { /* ... */ }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 500; font-size: 0.95rem; text-decoration: none; transition: all 0.3s ease; cursor: pointer; border: none; gap: 0.5rem; line-height: 1.5; }
        .btn-primary { background: var(--gradient-1); color: white; box-shadow: var(--shadow-sm); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn-secondary { background-color: var(--light); color: var(--text-secondary); border: 1px solid var(--gray-light); box-shadow: var(--shadow-sm); }
        .btn-secondary:hover { background-color: #e9ecef; color: var(--dark); border-color: #ced4da; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn i { font-size: 1em; }

        /* --- Responsiveness (beze změny) --- */
        .mobile-menu-toggle { /* ... */ } .sidebar-overlay { /* ... */ } .sidebar-overlay.active { /* ... */ }
        @media (max-width: 1200px) { /* ... */ } @media (max-width: 992px) { /* ... */ }
        @media (max-width: 768px) { /* ... */ } @media (max-width: 576px) { /* ... */ }

        /* --- Dark mode (kombinace) --- */
        @media (prefers-color-scheme: dark) {
            :root { --white: #1a202c; --light: #2d3748; --dark: #e2e8f0; --gray-light: #4a5568; --text-primary: #e2e8f0; --text-secondary: #cbd5e0; --text-muted: #a0aec0; --dark-bg: #1e2533;}
            body { background-color: #171923; }
            .section, .dashboard-header { background-color: var(--dark-bg); border-color: var(--gray-light); }
            .mobile-menu-toggle { color: var(--dark); } .empty-state i { color: var(--light); }
            .topic-loading-section { background-color: #212733; } /* Tmavší pro odlišení */
            .whiteboard-container { border-color: var(--gray-light); }
            #explanation-content { scrollbar-color: var(--gray) var(--dark-bg); } #explanation-content::-webkit-scrollbar { width: 8px; } #explanation-content::-webkit-scrollbar-track { background: var(--dark-bg); } #explanation-content::-webkit-scrollbar-thumb { background-color: var(--gray); border-radius: 4px; }
            #explanation-content pre code { background-color: #1a202c; color: #d1d5db; }
            #explanation-content code { background-color: rgba(72, 149, 239, 0.15); color: var(--primary-light); }
            #explanation-content strong { color: var(--light); }

            .chat-area { background-color: var(--dark-bg); box-shadow: var(--shadow-md); border: none; }
            .chat-header { background-color: var(--light); border-bottom-color: var(--gray-light); } .chat-header h3 { color: var(--dark); } .chat-actions button { color: var(--text-secondary); } .chat-actions button:hover { color: var(--primary-light); background-color: rgba(255,255,255,0.1); }
            .chat-messages { scrollbar-color: var(--gray) var(--dark-bg); } .chat-messages::-webkit-scrollbar { width: 6px; } .chat-messages::-webkit-scrollbar-track { background: var(--dark-bg); } .chat-messages::-webkit-scrollbar-thumb { background-color: var(--gray); border-radius: 3px; border: 1px solid var(--dark-bg); }
            .message-bubble { background-color: var(--light); color: var(--text-primary); border-color: var(--gray-light); }
            .chat-message.user .message-bubble { background: var(--gradient-2); color: var(--white); } /* Jiný gradient pro dark */
            .message-bubble code { background-color: rgba(255,255,255,0.1); color: var(--text-primary); }
            .chat-message.user .message-bubble code { background-color: rgba(255,255,255,0.3); color: white; }
            .chat-input-area { background-color: var(--light); border-top-color: var(--gray-light); }
            .chat-input { background-color: var(--dark-bg); color: var(--text-primary); border-color: var(--gray-light); } .chat-input::placeholder { color: var(--text-muted); }
            .btn-secondary { background-color: var(--light); color: var(--text-secondary); border-color: var(--gray-light); box-shadow: var(--shadow-sm); }
            .btn-secondary:hover { background-color: var(--gray-light); color: var(--dark); }
        }
        /* --- Toast notification (beze změny) --- */
        .toast { /* ... */ } .toast.show { /* ... */ } .toast.success { /* ... */ } .toast.error { /* ... */ } .toast.warning { /* ... */ } .toast i { /* ... */ } .toast.success i { /* ... */ } .toast.error i { /* ... */ } .toast.warning i { /* ... */ }
        @media (prefers-color-scheme: dark) { .toast { background-color: var(--dark-bg); border-color: var(--gray-light); color: var(--text-primary);} }
    </style>
</head>
<body>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header"> <a href="/" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
         <ul class="sidebar-menu"> <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Dashboard</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li> </ul>
         <div class="user-profile"> <div class="user-avatar" id="user-avatar">?</div> <div class="user-info"> <div class="user-name" id="user-name">Načítání...</div> <div class="user-role">Student</div> </div> </div>
         <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main>
         <div class="dashboard-header">
             <div class="header-content"> <div class="header-title-section"> <button class="mobile-menu-toggle" id="mobile-menu-toggle"> <i class="fas fa-bars"></i> </button> <h1>Interaktivní výuka</h1> </div> <div class="header-actions"> <a href="/dashboard/procvicovani/main.html" class="btn btn-secondary"> <i class="fas fa-arrow-left"></i> Zpět na přehled </a> </div> </div>
         </div>

         <div class="learning-layout">

             <div class="left-panel">
                  <section class="section topic-loading-section">
                       <div id="current-topic-display">
                            <span class="placeholder">Načítám další téma z plánu...</span>
                       </div>
                       <button class="btn btn-primary" id="load-next-topic-btn" title="Načíst další nedokončené téma ze studijního plánu">
                            <i class="fas fa-sync-alt"></i> Načíst další téma
                       </button>
                   </section>

                 <section id="explanation-container" class="section explanation-section" style="display: none;">
                      <h2 class="section-title" id="explanation-title"><i class="fas fa-chalkboard-teacher"></i> Vysvětlení tématu</h2>
                      <div id="explanation-content"></div>
                       <div style="text-align: center; margin-top: 1rem; border-top: 1px solid var(--gray-light); padding-top: 1rem;">
                            <button class="btn btn-primary" id="next-step-btn" style="display: none;" title="Požádat AI o další krok nebo pokračování">
                                 <i class="fas fa-forward"></i> Pokračovat / Další krok
                            </button>
                       </div>
                 </section>

                 <section id="whiteboard-container-section" class="section whiteboard-section" style="display: none;">
                      <h2 class="section-title"><i class="fas fa-pencil-ruler"></i> Interaktivní doška</h2>
                      <div class="whiteboard-container" id="tldraw-container"></div>
                 </section>
             </div>

             <div id="chat-panel" class="right-panel" style="display: none;">
                 <section class="chat-area">
                       <div class="chat-header">
                            <h3><i class="fas fa-comments"></i> Chat s AI Tutorem</h3>
                            <div class="chat-actions">
                                 <button id="save-chat-btn" title="Uložit chat jako PDF" class="btn-tooltip"> <i class="fas fa-save"></i> </button>
                                 <button id="clear-chat-btn" title="Vymazat historii tohoto chatu" class="btn-tooltip"> <i class="fas fa-trash-alt"></i> </button>
                            </div>
                       </div>
                       <div class="chat-messages" id="chat-messages"></div>
                       <div class="chat-input-area">
                            <textarea class="chat-input" id="chat-input" placeholder="Napiš svou otázku..." rows="1"></textarea>
                            <button class="send-button" id="send-button" title="Odeslat zprávu">
                                 <i class="fas fa-paper-plane"></i>
                            </button>
                       </div>
                 </section>
             </div>

         </div> </main>

      <div class="toast" id="toast"> <i class="fas fa-check-circle"></i> <div id="toast-message">Operace úspěšná.</div> </div>

    <script>
        // --- JavaScript (zůstává stejný jako v předchozí odpovědi) ---
        // Obsahuje:
        // - Inicializaci Supabase, Gemini, tldraw
        // - Načítání profilu uživatele
        // - Automatické načítání dalšího tématu z plánu (loadNextTopicFromPlan)
        // - Start a řízení výukové session (startLearningSession, requestNextStep)
        // - Funkce chatu (addChatMessage, handleSendMessage, clearChatHistory, saveChatToPDF)
        // - Komunikaci s Gemini (sendToGemini, processGeminiResponse, handleGeminiError)
        // - Obsluhu UI (updateUserInfoUI, showToast, renderMarkdown, event listeners atd.)
        // - Pomocné funkce
        document.addEventListener('DOMContentLoaded', async function() {
            // --- Supabase & Gemini Init ---
            const supabaseUrl = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
            const supabase = window.supabase?.createClient ? window.supabase.createClient(supabaseUrl, supabaseKey) : null;
            const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // POUZE PRO TESTOVÁNÍ!
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

            // --- DOM Elements ---
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const currentTopicDisplay = document.getElementById('current-topic-display');
            const loadNextTopicBtn = document.getElementById('load-next-topic-btn');
            const explanationContainer = document.getElementById('explanation-container');
            const explanationTitle = document.getElementById('explanation-title');
            const explanationContent = document.getElementById('explanation-content');
            const whiteboardContainerSection = document.getElementById('whiteboard-container-section');
            const tldrawContainer = document.getElementById('tldraw-container');
            const chatPanel = document.getElementById('chat-panel');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const saveChatBtn = document.getElementById('save-chat-btn');
            const clearChatBtn = document.getElementById('clear-chat-btn');
            const nextStepBtn = document.getElementById('next-step-btn');
            const toastEl = document.getElementById('toast');
            const toastMessageEl = document.getElementById('toast-message');

            // --- Global Variables ---
            let currentUser = null;
            let currentProfile = null;
            let currentTopic = null; // { id: string, name: string, activity_id: number }
            let currentSessionId = null;
            let chatHistory = []; // Jen pro kontext Gemini, neukládá se přímo sem
            let tldrawApp = null;
            let geminiIsThinking = false;
            let thinkingIndicatorId = null; // ID pro odstranění indikátoru

            // --- Helper Functions ---
            const sanitizeHTML = (str) => { const temp = document.createElement('div'); temp.textContent = str || ''; return temp.innerHTML; };
            const getInitials = (profile, email) => { if (!profile) return email ? email[0].toUpperCase() : '?'; let i = (profile.first_name?.[0]||'')+(profile.last_name?.[0]||''); return i.toUpperCase() || profile.username?.[0].toUpperCase() || email?.[0].toUpperCase() || '?'; };
            const showToast = (message, type = 'success', duration = 4000) => { if (!toastEl || !toastMessageEl) return; toastMessageEl.textContent = message; const icon = toastEl.querySelector('i'); icon.className = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-exclamation-triangle'; toastEl.className = 'toast ' + type; toastEl.classList.add('show'); setTimeout(() => toastEl.classList.remove('show'), duration); };
            const renderMarkdown = (element, markdownText) => { try { element.innerHTML = marked.parse(markdownText || ''); if (window.MathJax) setTimeout(() => window.MathJax.typesetPromise([element]).catch(e=>console.error("MathJax:",e)), 0); } catch (e) { console.error("Markdown:", e); element.innerHTML = `<p style="color: red;">Chyba zobrazení.</p>`; }};
            const autoResizeTextarea = () => { chatInput.style.height = 'auto'; chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px'; };
            const generateSessionId = () => `session_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
            const formatTimestamp = (date) => date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });

            // --- Initialization ---
            const initializeApp = async () => {
                if (!supabase) { showToast("Chyba: Supabase klient není inicializován.", "error", 10000); return; }
                setupEventListeners();
                initTooltips();
                await loadUserProfile();
                if (currentUser) {
                     initializeTldraw();
                     await loadNextTopicFromPlan();
                } else {
                     currentTopicDisplay.innerHTML = '<span class="placeholder"><i class="fas fa-sign-in-alt"></i> Pro zahájení výuky se prosím přihlaste.</span>';
                     loadNextTopicBtn.disabled = true;
                     hideLearningUI(); // Skryje části UI, pokud není uživatel přihlášen
                }
            };

            const loadUserProfile = async () => { try { const { data: { user }, error: userError } = await supabase.auth.getUser(); if (userError) throw userError; if (user) { currentUser = user; const { data: profile, error: profileError } = await supabase.from('profiles').select('*').eq('id', user.id).single(); if (profileError && profileError.code !== 'PGRST116') throw profileError; currentProfile = profile; updateUserInfoUI(); } else { currentUser = null; currentProfile = null; updateUserInfoUI(); } } catch (error) { console.error('Chyba profilu:', error); showToast("Chyba načítání profilu.", "error"); currentUser = null; currentProfile = null; updateUserInfoUI(); } };
            const updateUserInfoUI = () => { const email = currentUser?.email; const displayName = `${currentProfile?.first_name || ''} ${currentProfile?.last_name || ''}`.trim() || currentProfile?.username || email?.split('@')[0] || 'Student'; if(userName) userName.textContent = displayName; if(userAvatar) { if (currentProfile?.avatar_url) userAvatar.innerHTML = `<img src="${currentProfile.avatar_url}" alt="${displayName}" />`; else userAvatar.textContent = getInitials(currentProfile, email); }};
            const setupEventListeners = () => { if (mobileMenuToggle) mobileMenuToggle.addEventListener('click', () => { sidebar?.classList.toggle('active'); sidebarOverlay?.classList.toggle('active'); }); if (sidebarOverlay) sidebarOverlay.addEventListener('click', () => { sidebar?.classList.remove('active'); sidebarOverlay?.classList.remove('active'); }); window.addEventListener('resize', () => { if (window.innerWidth > 576 && sidebar?.classList.contains('active')) { sidebar.classList.remove('active'); sidebarOverlay?.classList.remove('active'); } }); if (loadNextTopicBtn) loadNextTopicBtn.addEventListener('click', loadNextTopicFromPlan); if (sendButton) sendButton.addEventListener('click', handleSendMessage); if (chatInput) { chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } }); chatInput.addEventListener('input', autoResizeTextarea); } if (saveChatBtn) saveChatBtn.addEventListener('click', saveChatToPDF); if (clearChatBtn) clearChatBtn.addEventListener('click', confirmClearChat); if (nextStepBtn) nextStepBtn.addEventListener('click', requestNextStep); };
            const initTooltips = () => { try { if (window.$ && $.fn.tooltipster) { $('.btn-tooltip:not(.tooltipstered)').tooltipster({ theme: 'tooltipster-shadow', animation: 'fade', delay: 100, side: ['top', 'bottom'] }); console.log("Tooltips initialized."); } else console.warn("Tooltipster/jQuery not ready."); } catch (e) { console.error("Tooltipster error:", e); } };
            const initializeTldraw = () => { if (typeof tldraw !== 'undefined' && tldraw.Tldraw && tldrawContainer) { try { console.log("Initializing tldraw..."); tldrawApp = new tldraw.Tldraw({ container: tldrawContainer, showUI: true, readOnly: false }); console.log("tldraw initialized."); } catch (error) { console.error("Failed to initialize tldraw:", error); tldrawContainer.innerHTML = "<p style='padding: 1rem; color: red;'>Chyba inicializace interaktivní došky.</p>"; } } else { console.warn("tldraw library or container not found."); tldrawContainer.innerHTML = "<p style='padding: 1rem; color: orange;'>Interaktivní doška není dostupná.</p>"; } /* Sekce se zobrazí až později */};

            // --- Topic Loading and Learning Session ---
            const loadNextTopicFromPlan = async () => {
                if (!currentUser || !supabase) { showToast("Nelze načíst téma, nejste přihlášeni.", "warning"); return; }
                currentTopicDisplay.innerHTML = '<span class="placeholder"><i class="fas fa-spinner fa-spin"></i> Hledám další téma v plánu...</span>';
                loadNextTopicBtn.disabled = true;
                hideLearningUI();

                 try {
                     const { data: activePlan, error: planError } = await supabase.from('study_plans').select('id').eq('user_id', currentUser.id).eq('status', 'active').order('created_at', { ascending: false }).limit(1).maybeSingle();
                     if (planError) throw planError;
                     if (!activePlan) throw new Error("Nebyl nalezen žádný aktivní studijní plán.");

                     const { data: nextActivity, error: activityError } = await supabase.from('plan_activities').select('id, title, day_of_week, time_slot').eq('plan_id', activePlan.id).eq('completed', false).order('day_of_week', { ascending: true }).order('time_slot', { ascending: true }).limit(1).maybeSingle();
                     if (activityError) throw activityError;
                     if (!nextActivity) throw new Error("Všechny aktivity v plánu jsou dokončeny!");

                     currentTopic = { id: `activity_${nextActivity.id}`, name: nextActivity.title, activity_id: nextActivity.id };
                     currentTopicDisplay.innerHTML = `Aktuální téma: <strong>${sanitizeHTML(currentTopic.name)}</strong>`;
                     await startLearningSession(); // Spustí session s novým tématem

                 } catch (error) {
                     console.error("Chyba při načítání dalšího tématu:", error);
                     showToast(error.message || "Nepodařilo se načíst další téma.", "error");
                     currentTopicDisplay.innerHTML = `<span class="placeholder" style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> ${error.message || 'Chyba načítání tématu.'}</span>`;
                 } finally {
                     loadNextTopicBtn.disabled = false; // Vždy znovu povolit tlačítko
                 }
             };

            const startLearningSession = async () => {
                if (!currentTopic) { console.error("startLearningSession voláno bez currentTopic"); return; }
                currentSessionId = generateSessionId();
                console.log(`Starting session ${currentSessionId} for topic: ${currentTopic.name} (Activity ID: ${currentTopic.activity_id})`);

                explanationContainer.style.display = 'flex'; // Zobrazíme sekci vysvětlení
                whiteboardContainerSection.style.display = 'flex'; // Zobrazíme sekci s došku
                chatPanel.style.display = 'flex';

                explanationTitle.innerHTML = `<i class="fas fa-chalkboard-teacher"></i> Vysvětlení: ${sanitizeHTML(currentTopic.name)}`;
                explanationContent.innerHTML = '<div class="loading">Požaduji úvodní vysvětlení od AI...</div>';
                nextStepBtn.style.display = 'none';

                chatMessages.innerHTML = '';
                chatHistory = [];
                await addChatMessage(`Ahoj! Jsem připravený ti pomoct s tématem: **${sanitizeHTML(currentTopic.name)}**. Začneme se základy. Řekni **"pokračuj"** nebo polož otázku.`, 'gemini', true);

                if (tldrawApp && tldrawApp.resetDocument) { try { tldrawApp.resetDocument(); console.log("tldraw reset."); } catch (e) { console.warn("Could not reset tldraw:", e); } }

                updateGeminiThinkingState(true);
                await sendToGemini(`Začni vysvětlovat ZÁKLADY tématu "${currentTopic.name}" pro 9. třídu ZŠ (přijímačky CERMAT). Rozděl to na malé kroky. Toto je PRVNÍ KROK.`, 'explanation');
                updateGeminiThinkingState(false);
                nextStepBtn.style.display = 'inline-flex'; // Zobrazí se po prvním kroku
            };

            const hideLearningUI = () => {
                 explanationContainer.style.display = 'none';
                 whiteboardContainerSection.style.display = 'none';
                 chatPanel.style.display = 'none';
                 explanationContent.innerHTML = '';
                 chatMessages.innerHTML = '';
                 if (tldrawApp && tldrawApp.resetDocument) tldrawApp.resetDocument();
                 currentTopic = null;
                 currentSessionId = null;
                 chatHistory = [];
            };

            const requestNextStep = async () => {
                 if (!currentTopic || geminiIsThinking) return;
                 console.log("Requesting next step from Gemini...");
                 nextStepBtn.disabled = true;
                 nextStepBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Načítám...';
                 updateGeminiThinkingState(true);

                 const prompt = `Pokračuj ve vysvětlování tématu "${currentTopic.name}". Co následuje po předchozím kroku? Vysvětluj stručně a krok za krokem.`;
                 await addChatMessage("Pokračuj prosím / Další krok.", 'user', true); // Uložíme i tento požadavek
                 await sendToGemini(prompt, 'explanation');

                 // updateGeminiThinkingState(false) se volá ve finally v sendToGemini
                 nextStepBtn.disabled = false; // Povolíme hned po odeslání požadavku
                 nextStepBtn.innerHTML = '<i class="fas fa-forward"></i> Pokračovat / Další krok';
            };

            // --- Chat Functionality ---
            const addChatMessage = async (message, sender, saveToDb = false, timestamp = new Date()) => {
                 const messageId = `msg_${Date.now()}_${Math.random().toString(16).slice(2)}`;
                 const messageDiv = document.createElement('div');
                 messageDiv.classList.add('chat-message', sender);
                 messageDiv.id = messageId;

                 const avatarDiv = document.createElement('div');
                 avatarDiv.classList.add('message-avatar');
                 avatarDiv.innerHTML = sender === 'user' ? sanitizeHTML(getInitials(currentProfile, currentUser?.email)) : '<i class="fas fa-robot"></i>';

                 const bubbleDiv = document.createElement('div');
                 bubbleDiv.classList.add('message-bubble');
                 renderMarkdown(bubbleDiv, message);

                 const timeDiv = document.createElement('div');
                 timeDiv.classList.add('message-timestamp');
                 timeDiv.textContent = formatTimestamp(timestamp);

                 messageDiv.appendChild(avatarDiv);
                 messageDiv.appendChild(bubbleDiv);
                 bubbleDiv.appendChild(timeDiv);
                 chatMessages.appendChild(messageDiv);
                 // Malé zpoždění před skrolováním, aby se obsah stihl vykreslit
                 setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 50);


                 if (saveToDb && supabase && currentUser && currentSessionId && currentTopic) {
                      try {
                           const { error } = await supabase.from('chat_history').insert({ user_id: currentUser.id, session_id: currentSessionId, topic_id: currentTopic.id, topic_name: currentTopic.name, role: sender === 'user' ? 'user' : 'model', content: message, created_at: timestamp.toISOString() });
                           if (error) throw error;
                           console.log(`Msg saved (Sess:${currentSessionId}, Sender:${sender})`);
                      } catch (dbError) {
                           console.error("DB save error:", dbError);
                           showToast("Chyba ukládání zprávy.", "error");
                           // Zobrazíme ikonku chyby u zprávy
                           const errorIcon = bubbleDiv.querySelector('.fa-exclamation-circle');
                           if (!errorIcon) {
                                const errorIndicator = document.createElement('i');
                                errorIndicator.className = 'fas fa-exclamation-circle';
                                errorIndicator.style.cssText = 'color: var(--danger); font-size: 0.8em; margin-left: 8px; cursor: help;';
                                errorIndicator.title = `DB Error: ${dbError.message}`;
                                bubbleDiv.appendChild(errorIndicator);
                           }
                      }
                 }
                 return messageId;
            };

            const updateGeminiThinkingState = (isThinking) => {
                 geminiIsThinking = isThinking;
                 sendButton.disabled = isThinking;
                 nextStepBtn.disabled = isThinking; // Ovlivní i next step button

                 if (isThinking) {
                      addThinkingIndicator();
                      sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                 } else {
                      removeThinkingIndicator();
                      sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                      nextStepBtn.innerHTML = '<i class="fas fa-forward"></i> Pokračovat / Další krok'; // Reset textu next step
                 }
            };

            const addThinkingIndicator = () => {
                 removeThinkingIndicator();
                 const indicatorDiv = document.createElement('div');
                 thinkingIndicatorId = `thinking_${Date.now()}`;
                 indicatorDiv.id = thinkingIndicatorId;
                 indicatorDiv.classList.add('chat-message', 'gemini');
                 indicatorDiv.innerHTML = `
                      <div class="message-avatar"><i class="fas fa-robot"></i></div>
                      <div class="message-bubble message-thinking-indicator">
                           <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                      </div>`;
                 chatMessages.appendChild(indicatorDiv);
                 chatMessages.scrollTop = chatMessages.scrollHeight;
            };
            const removeThinkingIndicator = () => { if (thinkingIndicatorId) { const indicator = document.getElementById(thinkingIndicatorId); if (indicator) indicator.remove(); thinkingIndicatorId = null; } };

            const handleSendMessage = async () => {
                 const messageText = chatInput.value.trim();
                 if (!messageText || !currentTopic || geminiIsThinking) return;
                 const timestamp = new Date();
                 await addChatMessage(messageText, 'user', true, timestamp);
                 chatHistory.push({ role: "user", parts: [{ text: messageText }] });
                 chatInput.value = '';
                 autoResizeTextarea();
                 updateGeminiThinkingState(true);
                 nextStepBtn.style.display = 'inline-flex'; // Zobrazí tlačítko po odeslání zprávy
                 await sendToGemini(messageText, 'chat');
                 // updateGeminiThinkingState(false) se volá ve finally v sendToGemini
            };

            const confirmClearChat = () => { if (!currentSessionId || !currentUser) { showToast("Nelze vymazat chat bez aktivní session.", "warning"); return; } if (confirm("Opravdu chcete vymazat celou historii tohoto chatu? Tato akce je nevratná.")) { clearChatHistory(); } };
            const clearChatHistory = async () => {
                 if (!currentSessionId || !currentUser || !supabase) { showToast("Chyba: Nelze smazat historii.", "error"); return; }
                 console.log(`Clearing chat history for session: ${currentSessionId}`);
                 clearChatBtn.disabled = true;
                 const originalContent = chatMessages.innerHTML; // Záloha pro případ chyby
                 chatMessages.innerHTML = '<div class="loading">Mažu historii...</div>';

                 try {
                      const { error: deleteError } = await supabase.from('chat_history').delete().eq('user_id', currentUser.id).eq('session_id', currentSessionId);
                      if (deleteError) throw deleteError;
                      chatMessages.innerHTML = '';
                      chatHistory = [];
                      await addChatMessage(`Historie chatu byla vymazána. Můžeme začít znovu s tématem **${sanitizeHTML(currentTopic?.name || 'aktuálním tématem')}**.`, 'gemini', false); // Neukládáme tuto zprávu
                      showToast("Historie chatu byla úspěšně vymazána.", "success");
                 } catch (error) {
                      console.error("Chyba při mazání historie chatu:", error);
                      showToast("Nepodařilo se vymazat historii chatu.", "error");
                      chatMessages.innerHTML = originalContent; // Vrátíme původní zprávy v UI
                 } finally {
                     clearChatBtn.disabled = false;
                 }
            };
            const saveChatToPDF = () => { /* ... (stejné jako předtím) ... */ };


            // --- Gemini Interaction ---
            const sendToGemini = async (promptText, targetArea) => {
                 if (!GEMINI_API_KEY || GEMINI_API_KEY.startsWith('YOUR_')) { showToast("Chyba: Chybí API klíč.", "error", 8000); handleGeminiError("Chybí API klíč.", targetArea, new Date()); return; }
                 if (!currentTopic) { showToast("Chyba: Není vybráno téma.", "error"); handleGeminiError("Není vybráno téma.", targetArea, new Date()); return; }

                 console.log(`Posílám Gemini (cíl: ${targetArea}): "${promptText}"`);
                 const timestamp = new Date();
                 // updateGeminiThinkingState(true) se volá PŘED voláním této funkce

                 const systemInstructionText = `Jsi AI Tutor "Justax", expert na matematiku pro 9. třídu ZŠ v ČR (přijímačky CERMAT). Vyučuješ téma: "${currentTopic.name}". Tvůj styl je jako PŘÁTELSKÝ, TRPĚLIVÝ a PODROBNÝ UČITEL. Vysvětluj krok za krokem, používej příklady. Důsledně používej Markdown pro formátování (nadpisy **, seznamy *, tučně **, kurzívu *) a MathJax syntax pro matematiku (blokové: $$...$$, inline: \\(...\\)). Odpovídej VŽDY ČESKY.

                 DŮLEŽITÉ POKYNY PRO VÝUKU:
                 1.  **KROK ZA KROKEM:** Nepokrývej příliš mnoho informací najednou. Zaměř se na jeden koncept nebo krok postupu v jedné odpovědi. Počkej na reakci studenta ("pokračuj", otázka) než přejdeš dál.
                 2.  **INTERAKTIVITA:** Aktivně zapojuj studenta. Pokládej otázky ("Co si myslíš, jaký bude další krok?", "Chápeš tento pojem?", "Chceš vidět další příklad?").
                 3.  **"BÍLÁ DOŠKA" (Konceptuálně):** Student má k dispozici interaktivní došku. Můžeš ho VYZVAT, aby si na ni něco zkusil nakreslit nebo napsat ("Zkus si teď na došce načrtnout...", "Můžeš si na došce zapsat hlavní kroky..."). Ty na došku NEKRESLÍŠ, pouze poskytuješ textové vysvětlení a příklady.
                 4.  **DÉLKA ODPOVĚDI:** Drž odpovědi relativně stručné a zaměřené na jeden krok/myšlenku.
                 5.  **REAKCE NA VSTUP:** Pečlivě čti poslední zprávu uživatele a reaguj na ni. Pokud nerozumíš, požádej o upřesnění. Pokud uživatel řekne "pokračuj" nebo "další krok", vysvětli následující logický krok tématu.`;

                 const historyLimit = 6; // Mírně zvýšíme kontext
                 const recentHistory = chatHistory.slice(-historyLimit);
                 const requestContents = [ { role: "user", parts: [{ text: `${systemInstructionText}\n\n**Kontext:**\n${recentHistory.map(m => `${m.role === 'user' ? 'Student' : 'Tutor'}: ${m.parts[0].text}`).join('\n')}\n\n**Aktuální požadavek studenta:**\n${promptText}` }] } ];

                 try {
                     const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: requestContents, generationConfig: { temperature: 0.5, topP: 0.95, topK: 40, maxOutputTokens: 4096 }, safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" } ] }) });
                     if (!response.ok) { const errorBody = await response.json(); throw new Error(errorBody.error?.message || `Chyba API (${response.status})`); }
                     const data = await response.json();
                     if (!data.candidates || !data.candidates[0]?.content?.parts[0]?.text) throw new Error('Neplatná odpověď od Gemini.');
                     const geminiResponseText = data.candidates[0].content.parts[0].text;
                     chatHistory.push({ role: "model", parts: [{ text: geminiResponseText }] });
                     processGeminiResponse(geminiResponseText, targetArea, timestamp);
                 } catch (error) {
                     console.error('Chyba komunikace s Gemini:', error);
                     showToast(`Chyba AI: ${error.message}`, "error");
                     handleGeminiError(error.message, targetArea, timestamp); // Zpracujeme chybu
                 } finally {
                     updateGeminiThinkingState(false); // Ukončíme stav přemýšlení vždy
                 }
            };

            // Zpracování odpovědi Gemini
            const processGeminiResponse = (responseText, targetArea, timestamp) => {
                 removeThinkingIndicator();
                 const mainExplanationText = responseText.trim();

                 if (targetArea === 'explanation') {
                     const stepDiv = document.createElement('div');
                     stepDiv.className = 'step';
                     renderMarkdown(stepDiv, mainExplanationText);
                     explanationContent.appendChild(stepDiv);
                     explanationContent.scrollTop = explanationContent.scrollHeight; // Scroll dolů v sekci vysvětlení
                     // Uložíme odpověď do DB
                     addChatMessage(responseText, 'gemini', true, timestamp);
                     nextStepBtn.style.display = 'inline-flex';
                 } else { // Chat nebo fallback
                      addChatMessage(mainExplanationText, 'gemini', true, timestamp);
                 }
            };

            // Zpracování chyby Gemini
            const handleGeminiError = (errorMessage, targetArea, timestamp) => {
                 removeThinkingIndicator();
                 updateGeminiThinkingState(false); // Ukončíme stav přemýšlení explicitně i zde

                 const errorText = `Omlouvám se, při komunikaci s AI nastala chyba. Zkuste to prosím znovu. (Detail: ${errorMessage})`;
                 if (targetArea === 'explanation') {
                      const errorDiv = document.createElement('p');
                      errorDiv.style.color = 'var(--danger)';
                      errorDiv.style.fontWeight = '500';
                      errorDiv.textContent = errorText;
                      explanationContent.appendChild(errorDiv);
                      explanationContent.scrollTop = explanationContent.scrollHeight;
                      addChatMessage(errorText, 'gemini', true, timestamp); // Uložíme i chybu
                      if (nextStepBtn) {
                           nextStepBtn.disabled = false;
                           nextStepBtn.innerHTML = '<i class="fas fa-redo"></i> Požádat znovu'; // Změníme text tlačítka
                      }
                 } else {
                      addChatMessage(errorText, 'gemini', true, timestamp);
                 }
            };


            // --- Run Application ---
            initializeApp();
        });
    </script>

</body>
</html>