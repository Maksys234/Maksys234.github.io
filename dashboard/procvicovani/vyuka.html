<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Interaktivní Výuka (vylepšená verze 3 - Fokus Text)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        if (typeof window.MathJax === 'undefined') {
            window.MathJax = {
                tex: { inlineMath: [ ['\\(', '\\)'], ['$', '$'] ], displayMath: [['$$', '$$']], processEscapes: true, processEnvironments: true },
                options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' },
                startup: { ready: () => { MathJax.startup.defaultReady(); MathJax.startup.promise.then(() => console.log('MathJax loaded and ready.')); } }
            };
        } else { console.warn("window.MathJax already defined."); }
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@excalidraw/excalidraw@0.17.3/dist/excalidraw.production.min.js" crossorigin></script>

    <style>
        /* --- CSS Styly --- */
        /* (Zde jsou všechny vaše předchozí CSS styly - bez debug pravidel) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; scroll-behavior: smooth; }
        :root { --primary-rgb: 67, 97, 238; --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9; --success: #06d6a0; --danger: #f72585; --warning: #f8961e; --info: #4cc9f0; --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d; --gray-light: #dee2e6; --gray-dark: #343a40; --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3); --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee); --white: #ffffff; --sidebar-width: 260px; --transition-speed: 0.3s; --card-radius: 14px; --shadow-sm: 0 2px 6px rgba(0, 0, 0, 0.05); --shadow-md: 0 5px 12px rgba(0, 0, 0, 0.07); --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1); --text-primary: #2d3748; --text-secondary: #4a5568; --text-muted: #718096; --call-bg: #f9fafb; --call-panel-bg: var(--white); --avatar-size: 40px; }
        body { background-color: var(--call-bg); color: var(--text-primary); min-height: 100vh; display: flex; overflow: hidden; font-size: 15px; }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 1050; box-shadow: var(--shadow-lg); transition: transform var(--transition-speed) ease, width var(--transition-speed) ease; }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; } .sidebar-logo { font-size: 1.6rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.8rem; transition: transform 0.2s ease; } .sidebar-logo:hover { transform: scale(1.03); } .sidebar-logo i { font-size: 1.8rem; } .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; } .sidebar-item { margin-bottom: 0.5rem; } .sidebar-link { display: flex; align-items: center; padding: 0.85rem 1.1rem; color: rgba(255, 255, 255, 0.9); text-decoration: none; border-radius: 10px; transition: all 0.2s ease; font-weight: 500; position: relative; } .sidebar-link i { margin-right: 0.8rem; font-size: 1.25rem; width: 24px; text-align: center; transition: transform 0.2s ease; } .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.2); color: var(--white); } .sidebar-link:hover i { transform: scale(1.1); } .sidebar-link.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 65%; background-color: var(--white); border-radius: 0 4px 4px 0; } .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.85rem; color: rgba(255, 255, 255, 0.7); text-align: center; } .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.1); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.15); } .user-avatar { width: 42px; height: 42px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.8rem; font-weight: 500; overflow: hidden; color: var(--white); border: 2px solid rgba(255, 255, 255, 0.4); } .user-avatar img { width: 100%; height: 100%; object-fit: cover; } .user-info { flex-grow: 1; line-height: 1.3; } .user-name { font-weight: 600; font-size: 0.95rem; } .user-role { font-size: 0.8rem; opacity: 0.8; }
        main { flex: 1; margin-left: var(--sidebar-width); transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); height: 100vh; display: flex; flex-direction: column; overflow: hidden; background-color: var(--call-bg); }
        .main-header { padding: 1rem 1.75rem; background-color: var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; z-index: 100; border-bottom: 1px solid var(--gray-light); }
        .header-content h1 { font-size: 1.5rem; font-weight: 600; color: var(--dark); margin: 0; } .header-actions button, .header-actions a { font-size: 0.9rem; padding: 0.6rem 1.2rem; }
        .topic-loading-bar { padding: 0.9rem 1.75rem; background-color: var(--light); border-bottom: 1px solid var(--gray-light); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; flex-shrink: 0; }
        #current-topic-display { font-size: 1.05rem; font-weight: 500; color: var(--text-secondary); } #current-topic-display strong { color: var(--primary); font-weight: 600; } #current-topic-display .placeholder { font-style: italic; color: var(--text-muted); } #current-topic-display .fa-spinner { margin-right: 0.5rem; }
        .call-interface { flex-grow: 1; display: flex; overflow: hidden; padding: 1.5rem; gap: 1.5rem; }
        .ai-presenter-area { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--call-panel-bg); border-radius: var(--card-radius); box-shadow: var(--shadow-md); overflow: hidden; border: 1px solid var(--gray-light); min-width: 300px; transition: box-shadow var(--transition-speed) ease; height: 100%; min-height: 0; }
        .ai-presenter-area:hover { box-shadow: var(--shadow-lg); } .ai-presenter-header { padding: 0.8rem 1.25rem; border-bottom: 1px solid var(--gray-light); display: flex; align-items: center; gap: 0.8rem; background-color: #fdfdff; flex-shrink: 0; } .ai-avatar-placeholder { width: var(--avatar-size); height: var(--avatar-size); background: var(--gradient-1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0; box-shadow: var(--shadow-sm); } .ai-presenter-info h2 { font-size: 1.1rem; font-weight: 600; color: var(--dark); margin: 0; } .ai-presenter-info p { font-size: 0.85rem; color: var(--text-secondary); margin: 0; }
        #excalidraw-container { flex-grow: 1; position: relative; overflow: hidden; border-radius: 0 0 var(--card-radius) var(--card-radius); background-color: var(--white); min-height: 0; display: flex; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.04); }
        #excalidraw-container > .excalidraw-wrapper { width: 100% !important; height: 100% !important; display: flex !important; flex-direction: column !important; } #excalidraw-container .excalidraw { width: 100% !important; height: 100% !important; min-height: 350px; border: none !important; flex-grow: 1 !important; } #excalidraw-container .loading-placeholder { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; color: var(--text-muted); background-color: var(--white); z-index: 5; } #excalidraw-container .loading-placeholder i { font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem; animation: spinPulse 2s infinite ease-in-out; } #excalidraw-container .loading-placeholder p { font-size: 1rem; } @keyframes spinPulse { 0% { transform: scale(1) rotate(0deg); opacity: 0.7; } 50% { transform: scale(1.1) rotate(180deg); opacity: 1; } 100% { transform: scale(1) rotate(360deg); opacity: 0.7; } }
        .interaction-panel { width: 400px; flex-shrink: 0; display: flex; flex-direction: column; background-color: var(--call-panel-bg); border-radius: var(--card-radius); box-shadow: var(--shadow-md); overflow: hidden; border: 1px solid var(--gray-light); transition: box-shadow 0.3s ease; height: 100%; min-height: 0; }
        .interaction-panel:hover { box-shadow: var(--shadow-lg); } .interaction-tabs { display: flex; border-bottom: 1px solid var(--gray-light); background-color: #fdfdff; flex-shrink: 0; } .interaction-tab { flex: 1; text-align: center; padding: 0.9rem 1rem; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; border-bottom: 3px solid transparent; font-size: 0.95rem; position: relative; } .interaction-tab:hover { color: var(--primary); background-color: rgba(var(--primary-rgb), 0.03); } .interaction-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; background-color: var(--call-panel-bg); } .interaction-tab i { margin-right: 0.5rem; font-size: 1.05em; }
        .interaction-content-area { flex-grow: 1; overflow: hidden; position: relative; background-color: var(--call-panel-bg); min-height: 0; }
        .tab-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; visibility: hidden; opacity: 0; transition: opacity 0.3s ease, visibility 0s linear 0.3s; } .tab-content.active { visibility: visible; opacity: 1; transition: opacity 0.3s ease; }
        .explanation-scroll-content { flex-grow: 1; padding: 1.75rem; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--gray-light) transparent; min-height: 0; } .explanation-scroll-content::-webkit-scrollbar { width: 8px; } .explanation-scroll-content::-webkit-scrollbar-track { background: transparent; } .explanation-scroll-content::-webkit-scrollbar-thumb { background-color: var(--gray-light); border-radius: 4px; border: 2px solid var(--call-panel-bg); }
        #explanation-display { line-height: 1.7; font-size: 0.95rem; } #explanation-display .step { margin-bottom: 1.5rem; padding: 1.25rem; border-radius: 10px; background-color: #ffffff; border: 1px solid #edf2f7; box-shadow: var(--shadow-sm); transition: box-shadow 0.2s ease, border-color 0.2s ease; } #explanation-display .step:hover { box-shadow: var(--shadow-md); border-color: #dbe4f0; } #explanation-display .step:last-child { margin-bottom: 0; } #explanation-display h3 { color: var(--secondary); margin-top: 0; margin-bottom: 0.8rem; font-size: 1.15rem; padding-bottom: 0.4rem; border-bottom: 1px solid var(--gray-light); } #explanation-display code { background-color: rgba(var(--primary-rgb), 0.07); padding: 0.2em 0.45em; border-radius: 4px; font-size: 0.9em; color: #3f37c9; border: 1px solid rgba(var(--primary-rgb), 0.1); } #explanation-display pre { margin: 1rem 0; } #explanation-display pre code { display: block; background-color: #f0f2f5; color: #333; padding: 1rem; border-radius: 6px; font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; border: 1px solid #e2e8f0; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); } #explanation-display strong { color: var(--dark); font-weight: 600; } #explanation-display blockquote { border-left: 4px solid var(--info); padding-left: 1rem; margin: 1rem 0 1rem 0.25rem; color: #4a5568; font-style: normal; background-color: rgba(76, 201, 240, 0.06); border-radius: 0 6px 6px 0; } #explanation-display ul, #explanation-display ol { margin-left: 1.25rem; margin-bottom: 0.8rem; padding-left: 1rem; } #explanation-display li { margin-bottom: 0.6rem; }
        .explanation-controls { flex-shrink: 0; margin-top: auto; padding: 1rem 1.75rem; border-top: 1px solid var(--gray-light); text-align: center; background-color: #f8f9fa; display: flex; justify-content: space-between; gap: 1rem; } .explanation-controls .btn { flex: 1; }
        #chat-tab-content { display: flex; flex-direction: column; height: 100%; }
        .chat-messages { flex-grow: 1; padding: 1.25rem; overflow-y: auto; scrollbar-color: var(--gray-light) var(--call-panel-bg); min-height: 0; }
        .chat-messages::-webkit-scrollbar { width: 8px; } .chat-messages::-webkit-scrollbar-track { background: var(--call-panel-bg); } .chat-messages::-webkit-scrollbar-thumb { background-color: var(--gray-light); border-radius: 4px; border: 2px solid var(--call-panel-bg); }
        .chat-input-area { flex-shrink: 0; padding: 1rem 1.25rem; background-color: #f8f9fa; border-top: 1px solid var(--gray-light); display: flex; align-items: flex-end; gap: 0.75rem; }
        .chat-message { display: flex; gap: 0.75rem; max-width: 92%; align-items: flex-end; margin-bottom: 1.25rem; }
        .chat-message.user { margin-left: auto; flex-direction: row-reverse; } .message-avatar { width: var(--avatar-size); height: var(--avatar-size); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 0.95rem; flex-shrink: 0; box-shadow: var(--shadow-sm); border: 2px solid var(--call-panel-bg); } .chat-message.user .message-avatar { background: var(--success); color: white; } .chat-message.model .message-avatar { background: var(--primary); color: white; } .message-bubble { padding: 0.8rem 1.2rem; border-radius: 16px; line-height: 1.6; word-wrap: break-word; box-shadow: var(--shadow-sm); position: relative; background-color: var(--white); color: var(--text-primary); border: 1px solid #eef2f7; transition: box-shadow 0.2s ease; } .message-bubble:hover { box-shadow: var(--shadow-md); } .chat-message.model .message-bubble { border-bottom-left-radius: 5px; background: linear-gradient(145deg, #ffffff, #f9faff); } .chat-message.user .message-bubble { background: var(--gradient-1); color: white; border: none; border-bottom-right-radius: 5px; } .message-bubble code { background-color: rgba(var(--primary-rgb), 0.07); padding: 0.15em 0.4em; border-radius: 4px; font-size: 0.9em; color: #3f37c9; border: 1px solid rgba(var(--primary-rgb), 0.1); } .chat-message.user .message-bubble code { background-color: rgba(255, 255, 255, 0.15); color: #e0e0ff; border: 1px solid rgba(255, 255, 255, 0.2); } .message-bubble pre { margin: 0.7rem 0; } .message-bubble pre code { display: block; background-color: #f0f2f5; color: #333; padding: 0.8rem; border-radius: 6px; font-size: 0.88rem; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; border: 1px solid #e2e8f0; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); } .chat-message.user .message-bubble pre code { background-color: rgba(0,0,0,0.3); color: #eee; border: 1px solid rgba(255,255,255,0.1); } .message-timestamp { font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; display: block; text-align: left; opacity: 0.8; } .chat-message.user .message-timestamp { text-align: right; }
        .message-thinking-indicator { background: var(--white); display: flex; align-items: center; padding: 0.8rem 1.1rem; border-radius: 16px; box-shadow: var(--shadow-sm); border: 1px solid #eef2f7; width: fit-content; border-bottom-left-radius: 5px;} .typing-dot { width: 7px; height: 7px; background-color: var(--gray); border-radius: 50%; margin: 0 3px; display: inline-block; animation: typing 1.3s infinite ease-in-out; } .typing-dot:nth-child(2) { animation-delay: 0.2s; } .typing-dot:nth-child(3) { animation-delay: 0.4s; } @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.5; } 30% { transform: translateY(-3px); opacity: 1; } }
        .chat-input { flex-grow: 1; padding: 0.8rem 1.1rem; border: 1px solid var(--gray-light); border-radius: 20px; font-size: 0.95rem; resize: none; max-height: 120px; overflow-y: auto; transition: border-color 0.2s ease, box-shadow 0.2s ease; line-height: 1.45; background-color: var(--white); } .chat-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1); } .send-button { padding: 0 1.2rem; border-radius: 20px; font-weight: 600; font-size: 0.95rem; cursor: pointer; border: none; background: var(--gradient-1); color: white; transition: all 0.3s ease; flex-shrink: 0; height: 42px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); } .send-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(var(--primary-rgb), 0.2); } .send-button:active:not(:disabled) { transform: translateY(-1px); box-shadow: 0 3px 6px rgba(var(--primary-rgb), 0.15); } .send-button i { font-size: 1.1em; } .send-button .fa-spinner { margin: 0; }
        .chat-controls { flex-shrink: 0; padding: 0.5rem 1.25rem; font-size: 0.8rem; color: var(--text-muted); text-align: right; background-color: #f8f9fa; border-top: 1px solid var(--gray-light); } .chat-controls button { background:none; border:none; color: var(--text-muted); cursor:pointer; font-size: 0.95em; padding: 3px 6px; margin-left: 10px; transition: color 0.2s ease; } .chat-controls button:hover { color: var(--primary); }
        .loading-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; text-align: center; font-style: italic; color: var(--text-muted); flex-grow: 1; min-height: 150px; } .loading-placeholder i { margin-bottom: 1rem; font-size: 2.2rem; color: var(--primary-light); animation: spin 1.5s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 2rem 1.5rem; color: var(--text-secondary); margin-top: 1rem; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 150px; } .empty-state i { font-size: 3rem; margin-bottom: 1.25rem; color: var(--gray-light); opacity: 0.7; } .empty-state h3 { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.8rem; color: var(--dark); } .empty-state p { margin-bottom: 1.25rem; max-width: 450px; margin-left: auto; margin-right: auto; line-height: 1.55; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.7rem 1.4rem; border-radius: 8px; font-weight: 500; font-size: 0.9rem; text-decoration: none; transition: all 0.25s ease; cursor: pointer; border: none; gap: 0.5rem; line-height: 1.5; } .btn-primary { background: var(--gradient-1); color: white; box-shadow: var(--shadow-sm); } .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); background: linear-gradient(135deg, var(--primary-light), var(--secondary)); } .btn-secondary { background-color: var(--white); color: var(--text-secondary); border: 1px solid var(--gray-light); box-shadow: var(--shadow-sm); } .btn-secondary:hover:not(:disabled) { background-color: #f8f9fa; color: var(--primary); border-color: var(--primary-light); } .btn-success { background: linear-gradient(135deg, var(--success), #05a381); color: white; box-shadow: var(--shadow-sm); } .btn-success:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); background: linear-gradient(135deg, #0cd1a7, var(--success));} .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; background: var(--gray); color: var(--white); border: none; } .btn i { font-size: 1em; }
        mjx-math[display="inline"] { color: var(--secondary); background-color: rgba(var(--primary-rgb), 0.1); padding: 0.15em 0.4em; border-radius: 4px; font-weight: 500; border: 1px solid rgba(var(--primary-rgb), 0.15); display: inline-block; line-height: 1; margin: 0 1px; vertical-align: baseline; box-shadow: 0 1px 2px rgba(0,0,0,0.05); } .chat-message.user .message-bubble mjx-math[display="inline"] { color: #cdeeff; background-color: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.15); box-shadow: none; } #explanation-display .step mjx-math[display="inline"] { background-color: rgba(var(--primary-rgb), 0.08); border-color: rgba(var(--primary-rgb), 0.12); }
        .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; color: var(--dark); font-size: 1.6rem; margin-right: 1rem; padding: 0.5rem; z-index: 1060; transition: color 0.2s ease; } .mobile-menu-toggle:hover { color: var(--primary); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.55); z-index: 1040; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(5px); } .sidebar-overlay.active { display: block; opacity: 1; }
        @keyframes fadeIn { 0% { opacity: 0; transform: translateY(8px); } 100% { opacity: 1; transform: translateY(0); } }
        @media (max-width: 1200px) { .interaction-panel { width: 340px; } .call-interface { padding: 1.2rem; gap: 1.2rem; } }
        @media (max-width: 992px) { :root { --sidebar-width: 80px; } .sidebar { width: 80px; } .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; } .sidebar-link i { margin-right: 0; font-size: 1.5rem; } .sidebar-logo i { margin-right: 0; } .sidebar-header, .sidebar-link { justify-content: center; } .user-profile { justify-content: center; padding: 0.75rem 0; } .user-avatar { margin-right: 0; } main { margin-left: 80px; width: calc(100% - 80px); } .call-interface { flex-direction: column; padding: 1rem; gap: 1rem; } .interaction-panel { width: 100%; height: 55vh; flex-grow: 0; flex-shrink: 1; order: 1; } .ai-presenter-area { height: 45vh; min-height: 280px; order: 2; flex-grow: 0; flex-shrink: 1; } #excalidraw-container { min-height: 200px; } }
        @media (max-width: 768px) { .main-header { padding: 0.8rem 1.2rem; } .header-content h1 { font-size: 1.3rem; } .interaction-tab { padding: 0.8rem 0.5rem; font-size: 0.9rem; } .chat-input { font-size: 0.9rem; padding: 0.7rem 1rem; } .send-button { height: 40px; padding: 0 1rem; } .btn { padding: 0.6rem 1.2rem; font-size: 0.85rem; } .interaction-panel { height: 60vh; } .ai-presenter-area { height: 40vh; } }
        @media (max-width: 576px) { :root { --sidebar-width: 0; } .sidebar { transform: translateX(-100%); z-index: 1050; width: 260px; } .sidebar.active { transform: translateX(0); } .sidebar.active .sidebar-logo span, .sidebar.active .sidebar-link span, .sidebar.active .user-info, .sidebar.active .sidebar-footer { display: block; } .sidebar.active .sidebar-link i { margin-right: 0.75rem; font-size: 1.25rem; } .sidebar.active .sidebar-header, .sidebar.active .sidebar-link { justify-content: flex-start; } .sidebar.active .user-profile { justify-content: flex-start; padding: 1rem; } .sidebar.active .user-avatar { margin-right: 0.75rem; } main { margin-left: 0; width: 100%; } .mobile-menu-toggle { display: block; } .main-header { padding: 0.7rem 1rem; } .header-content h1 { font-size: 1.15rem; } .call-interface { padding: 0.8rem; gap: 0.8rem; } .ai-presenter-area { min-height: 220px; } .message-bubble { padding: 0.7rem 1rem; } .chat-input { padding: 0.6rem 0.9rem; } .send-button { height: 38px; padding: 0 0.9rem; } }
        @media (prefers-color-scheme: dark) { /* Dark mode styles (beze změny) */ :root { --white: #1a202c; --light: #2d3748; --dark: #e2e8f0; --gray-light: #4a5568; --text-primary: #e2e8f0; --text-secondary: #cbd5e0; --text-muted: #a0aec0; --dark-bg: #171923; --call-bg: #131720; --call-panel-bg: #1e2533; } body { background-color: var(--dark-bg); } main { background-color: var(--call-bg); } .main-header { background-color: var(--call-panel-bg); border-bottom-color: var(--gray-light); } .mobile-menu-toggle { color: var(--dark); } .ai-presenter-area, .interaction-panel { background-color: var(--call-panel-bg); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); border-color: var(--gray-light); } .ai-presenter-header { background-color: #242c3b; border-bottom-color: var(--gray-light); } #excalidraw-container { background-color: #ffffff; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1); } #excalidraw-container .loading-placeholder { background-color: #1e2533; color: var(--text-muted); } #excalidraw-container .loading-placeholder i { color: var(--primary-light); } .interaction-tabs { background-color: #242c3b; border-bottom-color: var(--gray-light); } .interaction-tab { color: var(--text-secondary); } .interaction-tab:hover { color: var(--primary-light); background-color: rgba(72, 149, 239, 0.1); } .interaction-tab.active { color: var(--primary-light); border-bottom-color: var(--primary-light); background-color: var(--call-panel-bg); } .tab-content { background-color: var(--call-panel-bg); } .explanation-scroll-content { scrollbar-color: var(--gray) var(--call-panel-bg); } .explanation-scroll-content::-webkit-scrollbar-thumb { border-color: var(--call-panel-bg); } #explanation-display .step { background-color: #232a37; border-color: #3b4458; } #explanation-display pre code { background-color: #161a22; color: #d1d5db; border-color: #363d4b; } #explanation-display code { background-color: rgba(72, 149, 239, 0.15); color: var(--primary-light); border-color: rgba(72, 149, 239, 0.25); } #explanation-display strong { color: #f0f2f5; } #explanation-display blockquote { border-left-color: var(--primary); color: #a0b3d0; background-color: #242c3b; } .explanation-controls { background-color: #242c3b; border-top-color: var(--gray-light); } .chat-messages { scrollbar-color: var(--gray) var(--call-panel-bg); } .chat-messages::-webkit-scrollbar-track { background: var(--call-panel-bg); } .chat-messages::-webkit-scrollbar-thumb { border-color: var(--call-panel-bg); } .message-avatar { border-color: var(--call-panel-bg); } .message-bubble { background-color: var(--light); color: var(--text-primary); border-color: #3b4458; } .chat-message.user .message-bubble { background: var(--gradient-2); color: #1a202c; } .message-bubble code { background-color: rgba(255,255,255,0.08); color: var(--text-primary); border-color: rgba(255,255,255,0.12); } .chat-message.user .message-bubble code { background-color: rgba(0, 0, 0, 0.15); color: #2d3748; border-color: rgba(0,0,0,0.2); } .message-bubble pre code { background-color: #161a22; color: #d1d5db; border-color: #363d4b; } .chat-message.user .message-bubble pre code { background-color: rgba(0,0,0,0.25); color: #eee; } .message-thinking-indicator { background: var(--light); border-color: #3b4458;} .typing-dot { background-color: #8494a6; } .chat-input-area { background-color: #242c3b; border-top-color: var(--gray-light); } .chat-input { background-color: var(--dark-bg); color: var(--text-primary); border-color: var(--gray-light); } .chat-input::placeholder { color: var(--text-muted); } .chat-input:focus { box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.2); } .chat-controls { background-color: #242c3b; border-top-color: var(--gray-light); } .chat-controls button { color: var(--text-muted); } .chat-controls button:hover { color: var(--primary-light); } .btn-secondary { background-color: var(--light); color: var(--text-secondary); border-color: var(--gray-light); } .btn-secondary:hover:not(:disabled) { background-color: #4a5568; color: var(--white); border-color: #6c757d; } .btn-success { background: linear-gradient(135deg, var(--success), #05a381); } .btn-success:hover:not(:disabled) { background: linear-gradient(135deg, #0cd1a7, var(--success));} .btn:disabled { background: #4a5568; color: #a0aec0; } .topic-loading-bar { background-color: var(--light); border-bottom-color: var(--gray-light); } .empty-state i { color: #4a5568; } .toast { background-color: var(--call-panel-bg); border-color: var(--gray-light); color: var(--text-primary); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);} mjx-math[display="inline"] { color: var(--primary-light); background-color: rgba(72, 149, 239, 0.15); border-color: rgba(72, 149, 239, 0.25); box-shadow: 0 1px 2px rgba(0,0,0,0.1); } .chat-message.user .message-bubble mjx-math[display="inline"] { color: #eee; background-color: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.1); box-shadow: none; } #explanation-display .step mjx-math[display="inline"] { background-color: rgba(72, 149, 239, 0.15); border-color: rgba(72, 149, 239, 0.2); } }
        .toast { position: fixed; bottom: 20px; right: 20px; background-color: var(--white); color: var(--text-primary); border-radius: 8px; padding: 1rem 1.2rem; box-shadow: var(--shadow-lg); max-width: 320px; z-index: 1001; display: flex; align-items: center; transform: translateX(calc(100% + 30px)); opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); } .toast.show { transform: translateX(0); opacity: 1; } .toast.success { border-left: 4px solid var(--success); } .toast.success i { color: var(--success); } .toast.error { border-left: 4px solid var(--danger); } .toast.error i { color: var(--danger); } .toast.warning { border-left: 4px solid var(--warning); } .toast.warning i { color: var(--warning); } .toast.info { border-left: 4px solid var(--info); } .toast.info i { color: var(--info); } .toast i { margin-right: 0.8rem; font-size: 1.3rem; }
    </style>
</head>
<body>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
    <aside id="sidebar" class="sidebar"></aside>
    <main>
        <div class="main-header"></div>
        <div class="topic-loading-bar"></div>
        <div class="call-interface" style="display: none;">
             <div class="ai-presenter-area"></div>
             <div class="interaction-panel"></div>
        </div>
    </main>
    <div class="toast" id="toast"> <i class="fas fa-info-circle"></i> <div id="toast-message">Operace úspěšná.</div> </div>

    <script>
        // Wrap the entire script in a try-catch block for robust error handling
        try {
            // --- Constants & Configuration ---
            const SUPABASE_URL = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
            const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // !!! SECURITY WARNING !!!
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            const EXCALIDRAW_SCENE_REGEX = /EXCALIDRAW_SCENE:\s*```json\s*(\[[\s\S]*?\])\s*```\s*/gim;
            const CHAT_SUMMARY_REGEX = /CHAT_SUMMARY:\s*([\s\S]*)/im;
            const MAX_GEMINI_HISTORY_TURNS = 10;

            // --- DOM Elements Cache ---
            const uiElements = { /* (stejné) */ userAvatar: document.getElementById('user-avatar'), userName: document.getElementById('user-name'), mobileMenuToggle: document.getElementById('mobile-menu-toggle'), sidebar: document.getElementById('sidebar'), sidebarOverlay: document.getElementById('sidebar-overlay'), currentTopicDisplay: document.getElementById('current-topic-display'), explanationDisplay: document.getElementById('explanation-display'), explanationScrollContent: document.querySelector('.explanation-scroll-content'), excalidrawContainer: document.getElementById('excalidraw-container'), chatMessages: document.getElementById('chat-messages'), chatInput: document.getElementById('chat-input'), sendButton: document.getElementById('send-button'), saveChatBtn: document.getElementById('save-chat-btn'), clearChatBtn: document.getElementById('clear-chat-btn'), nextStepBtn: document.getElementById('next-step-btn'), markCompleteBtn: document.getElementById('mark-complete-btn'), toast: document.getElementById('toast'), toastMessage: document.getElementById('toast-message'), interactionTabs: document.querySelectorAll('.interaction-tab'), tabContents: document.querySelectorAll('.tab-content'), aiStatusText: document.getElementById('ai-status-text'), callInterface: document.querySelector('.call-interface') };

            // --- Global State ---
            let state = { /* (stejné) */ supabase: null, currentUser: null, currentProfile: null, currentTopic: null, currentPlanId: null, currentSessionId: null, geminiChatContext: [], excalidrawAPI: null, excalidrawElements: [], excalidrawRoot: null, geminiIsThinking: false, thinkingIndicatorId: null, topicLoadInProgress: false, lastExplanationTimestamp: 0, activeInteractionTab: 'explanation-tab' };

            // --- Utility Functions ---
            const sanitizeHTML = (str) => { const temp = document.createElement('div'); temp.textContent = str || ''; return temp.innerHTML; };
            const getInitials = (profile, email) => { /* (stejné) */ if (!profile && !email) return '?'; let initials = ''; if (profile?.first_name) initials += profile.first_name[0]; if (profile?.last_name) initials += profile.last_name[0]; if (initials) return initials.toUpperCase(); if (profile?.username) return profile.username[0].toUpperCase(); if (email) return email[0].toUpperCase(); return 'U'; };
            const showToast = (message, type = 'info', duration = 4000) => { /* (stejné) */ if (!uiElements.toast || !uiElements.toastMessage) return; console.log(`Toast (${type}): ${message}`); uiElements.toastMessage.textContent = message; const icon = uiElements.toast.querySelector('i'); uiElements.toast.className = 'toast ' + type; icon.className = `fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}`; uiElements.toast.style.transition = 'none'; uiElements.toast.style.transform = 'translateX(calc(100% + 30px))'; uiElements.toast.style.opacity = '0'; void uiElements.toast.offsetWidth; uiElements.toast.style.transition = 'all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55)'; uiElements.toast.classList.add('show'); setTimeout(() => uiElements.toast.classList.remove('show'), duration); };
            const renderMarkdown = (element, markdownText) => { /* (stejné) */ if (!element) return; try { marked.setOptions({ gfm: true, breaks: true }); element.innerHTML = marked.parse(markdownText || ''); } catch (e) { console.error("Markdown rendering error:", e); element.innerHTML = `<p style="color:red;">Chyba renderování Markdownu.</p><pre>${sanitizeHTML(markdownText)}</pre>`; } };
            const autoResizeTextarea = () => { /* (stejné) */ if (!uiElements.chatInput) return; uiElements.chatInput.style.height = 'auto'; const scrollHeight = uiElements.chatInput.scrollHeight; const maxHeight = 150; uiElements.chatInput.style.height = `${Math.min(scrollHeight, maxHeight)}px`; uiElements.chatInput.style.overflowY = scrollHeight > maxHeight ? 'scroll' : 'hidden'; };
            const generateSessionId = () => `session_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
            const formatTimestamp = (date = new Date()) => date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
            const updateAIStatus = (text) => { if (uiElements.aiStatusText) uiElements.aiStatusText.textContent = text; };

            // --- Initialization Functions ---
            const initializeSupabase = () => { /* (stejné) */ console.log("Initializing Supabase..."); try { if (typeof window.supabase === 'undefined' || typeof window.supabase.createClient !== 'function') throw new Error("Supabase library not loaded."); state.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); if (!state.supabase) throw new Error("Supabase client creation failed."); console.log("Supabase client initialized."); return true; } catch (error) { console.error("Supabase initialization failed:", error); showToast("Chyba připojení k DB.", "error", 10000); return false; } };
            const initializeUI = () => { /* (stejné) */ console.log("Initializing UI..."); if (!initializeExcalidraw()) { showToast("Chyba inicializace Excalidraw!", "error", 10000); return false; } const lastTab = sessionStorage.getItem('activeVyukaTab'); switchInteractionTab(lastTab || 'explanation-tab'); setupEventListeners(); initTooltips(); manageUIState('initial'); return true; };
            const initializeApp = async () => { /* (stejné) */ console.log("DOM Loaded. Initializing..."); if (!initializeSupabase()) return; if (!initializeUI()) return; console.log("Loading user profile..."); await loadUserProfile(); if (state.currentUser) { console.log("User logged in, loading topic..."); await loadNextUncompletedTopic(); } else { handleLoggedOutUser(); } };

            // --- UI State Management ---
            const manageUIState = (mode) => { /* (stejné) */ console.log("Managing UI State:", mode); const isUserInteractionPossible = ['learning', 'chatting'].includes(mode); const isTopicLoading = ['loadingUser', 'loadingTopic', 'requestingExplanation'].includes(mode); const showCallInterface = !!state.currentTopic || isTopicLoading; if (uiElements.callInterface) { uiElements.callInterface.style.display = showCallInterface ? 'flex' : 'none'; } if (uiElements.explanationDisplay) { let content = uiElements.explanationDisplay.innerHTML; let showContent = true; switch (mode) { case 'initial': case 'loadingUser': content = "<div class='empty-state'><i class='fas fa-user-circle'></i><h3>Načítám profil...</h3></div>"; break; case 'loggedOut': content = "<div class='empty-state'><i class='fas fa-sign-in-alt'></i><h3>Nejste přihlášeni</h3></div>"; break; case 'noPlan': content = "<div class='empty-state'><i class='fas fa-calendar-times'></i><h3>Žádný aktivní plán</h3></div>"; break; case 'planComplete': content = "<div class='empty-state'><i class='fas fa-check-circle'></i><h3>Plán dokončen</h3></div>"; break; case 'error': if (!uiElements.explanationDisplay.querySelector('.step')) { content = "<div class='empty-state'><i class='fas fa-exclamation-triangle'></i><h3>Chyba</h3><p>Došlo k chybě.</p></div>"; } else { showContent = false; } break; case 'loadingTopic': content = "<div class='loading-placeholder'><i class='fas fa-spinner fa-spin'></i><p>Načítám téma...</p></div>"; break; case 'requestingExplanation': if (!uiElements.explanationDisplay.querySelector('.step')) { content = "<div class='loading-placeholder'><i class='fas fa-spinner fa-spin'></i><p>Požaduji vysvětlení...</p></div>"; } else { showContent = false; } break; case 'learning': case 'chatting': if (!uiElements.explanationDisplay.querySelector('.step') && !isTopicLoading) { content = "<div class='empty-state'><i class='fas fa-hourglass-half'></i><h3>Čekám na vysvětlení...</h3></div>"; } else { showContent = false; } break; default: showContent = false; } if (showContent) { uiElements.explanationDisplay.innerHTML = content; } } if (state.excalidrawAPI?.updateScene) { try { const viewModeEnabled = !isUserInteractionPossible && mode !== 'requestingExplanation'; state.excalidrawAPI.updateScene({ appState: { viewModeEnabled: viewModeEnabled } }); } catch (e) { console.error("Error setting Excalidraw view mode:", e); } } manageButtonStates(); };
            const manageButtonStates = () => { /* (stejné) */ const canInteract = !!state.currentTopic && !state.geminiIsThinking && !state.topicLoadInProgress; const isLearningState = !!state.currentTopic && !state.topicLoadInProgress; if (uiElements.sendButton) { uiElements.sendButton.disabled = !canInteract; uiElements.sendButton.innerHTML = state.geminiIsThinking ? '<i class="fas fa-spinner fa-spin"></i>' : '<i class="fas fa-paper-plane"></i>'; } if (uiElements.nextStepBtn) { uiElements.nextStepBtn.disabled = !canInteract; uiElements.nextStepBtn.style.display = isLearningState ? 'inline-flex' : 'none'; } if (uiElements.markCompleteBtn) { uiElements.markCompleteBtn.disabled = !canInteract; uiElements.markCompleteBtn.style.display = isLearningState ? 'inline-flex' : 'none'; } if (uiElements.chatInput) { uiElements.chatInput.disabled = !canInteract; } };

             // --- Excalidraw Functions ---
             const initializeExcalidraw = () => { /* (stejné) */ console.log("Initializing Excalidraw..."); const container = uiElements.excalidrawContainer; if (!container) { console.error("Excalidraw container not found!"); return false; } if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof ExcalidrawLib === 'undefined') { console.error("React, ReactDOM, Excalidraw library not loaded!"); container.innerHTML = '<p>Chyba knihoven.</p>'; return false; } try { container.innerHTML = '<div class="loading-placeholder"><i class="fas fa-spinner"></i></div>'; if (state.excalidrawRoot) { state.excalidrawRoot.unmount(); state.excalidrawRoot = null; state.excalidrawAPI = null; } state.excalidrawRoot = ReactDOM.createRoot(container); const initialData = { appState: { viewBackgroundColor: "#ffffff", currentItemFontFamily: 1, currentItemFontSize: 20, theme: 'light', viewModeEnabled: true }, elements: [], scrollToContent: true }; state.excalidrawRoot.render( React.createElement(ExcalidrawLib.Excalidraw, { initialData: initialData, excalidrawAPI: (api) => { if (!state.excalidrawAPI) { state.excalidrawAPI = api; console.log("Excalidraw API ready."); const placeholder = container.querySelector('.loading-placeholder'); if (placeholder) placeholder.remove(); try { api.updateScene({ elements: [] }); } catch(e) { console.error("Error clearing scene on init", e); } } }, UIOptions: { canvasActions: { saveToActiveFile: false, loadScene: false, export: { saveFileToDisk: true }, clearCanvas: false } }, viewModeEnabled: true, zenModeEnabled: false, gridModeEnabled: false, onChange: (elements, appState) => { console.log(`[Excalidraw onChange] Elements: ${elements.length}, ViewMode: ${appState.viewModeEnabled}`); } }) ); console.log("Excalidraw component mount initiated."); return true; } catch (error) { console.error("Error mounting Excalidraw:", error); container.innerHTML = `<div class="loading-placeholder" style="color:var(--danger);"><i class="fas fa-exclamation-triangle"></i><p>Chyba Excalidraw:<br>${error.message}</p></div>`; return false; } };
            /** Safely updates the Excalidraw scene with DETAILED LOGGING. */
            const updateExcalidrawScene = (elements) => {
                 if (!state.excalidrawAPI) { console.warn("Excalidraw API not available."); return; }
                 if (!Array.isArray(elements)) { console.warn("Invalid elements data type, clearing scene.", elements); elements = []; }

                 // --- *** CRITICAL DEBUGGING LOG *** ---
                 // Log the data BEFORE any potential modification or API call
                 console.warn(`[PRE-UPDATE] Attempting Excalidraw update with ${elements.length} elements.`);
                 console.warn(`[PRE-UPDATE] Data (stringified):`, JSON.stringify(elements)); // Log the exact data being passed
                 // --- *** END CRITICAL DEBUGGING LOG *** ---

                 let currentAppState = {};
                 if (state.excalidrawAPI.getAppState) {
                      try { currentAppState = state.excalidrawAPI.getAppState(); } catch (e) { console.warn("Couldn't get appState", e); }
                 } else { console.warn("getAppState not available on API"); }
                 console.log('[PRE-UPDATE] Current App State (before merge):', JSON.stringify(currentAppState));


                 const placeholder = uiElements.excalidrawContainer?.querySelector('.loading-placeholder');
                 if (placeholder) placeholder.style.display = 'none';

                 try {
                     // Ensure view mode is OFF for the update
                     const appStateUpdate = { ...currentAppState, viewModeEnabled: false };
                     console.log('[updateScene] Updating with appState:', JSON.stringify(appStateUpdate));

                     state.excalidrawAPI.updateScene({
                         elements: elements,
                         appState: appStateUpdate
                     });
                     console.log("Excalidraw updateScene called successfully.");
                     state.excalidrawElements = elements; // Cache only after successful call

                     // Re-enable scrollToContent with checks
                     setTimeout(() => {
                         if (!state.excalidrawAPI || !state.excalidrawAPI.scrollToContent || !state.excalidrawAPI.getSceneElements) {
                              console.warn("scrollToContent function or API not available when trying to scroll."); return;
                         }
                         const currentElementsAfterUpdate = state.excalidrawAPI.getSceneElements();
                         if (currentElementsAfterUpdate?.length > 0) {
                             console.log("Attempting to scroll to content after update...");
                             try {
                                 state.excalidrawAPI.scrollToContent(currentElementsAfterUpdate, { fitToContent: true, duration: 300 });
                             } catch (scrollError) { console.warn("Error during scrollToContent:", scrollError); }
                         } else {
                             console.log("No elements to scroll to after update attempt.");
                         }
                     }, 350); // Increased delay slightly more

                 } catch (error) {
                     console.error("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
                     console.error("!!! FATAL Error during ExcalidrawLib.updateScene call:", error);
                     console.error("!!! Data that likely caused the error:", JSON.stringify(elements)); // Log the exact failing data
                     console.error("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
                     showToast("Kritická chyba při vykreslování!", "error", 6000);
                 }
             };

            // --- User Profile & Auth ---
            const loadUserProfile = async () => { /* (stejné) */ if (!state.supabase) return; try { const { data: { user }, error: userError } = await state.supabase.auth.getUser(); if (userError) throw userError; if (user) { state.currentUser = user; const { data: profile } = await state.supabase.from('profiles').select('*').eq('id', user.id).single(); state.currentProfile = profile; console.log("User profile loaded:", state.currentProfile); } else { state.currentUser = null; state.currentProfile = null; console.log("No user logged in."); } } catch (error) { console.error('Error loading user profile:', error); state.currentUser = null; state.currentProfile = null; } finally { updateUserInfoUI(); } };
            const updateUserInfoUI = () => { /* (stejné) */ if (uiElements.userName && uiElements.userAvatar) { if (state.currentProfile || state.currentUser) { const email = state.currentUser?.email; const initials = getInitials(state.currentProfile, email); const displayName = `${state.currentProfile?.first_name || ''} ${state.currentProfile?.last_name || ''}`.trim() || state.currentProfile?.username || email?.split('@')[0] || 'Uživatel'; uiElements.userName.textContent = displayName; if (state.currentProfile?.avatar_url) { uiElements.userAvatar.innerHTML = `<img src="${state.currentProfile.avatar_url}" alt="${initials}">`; } else { uiElements.userAvatar.innerHTML = ''; uiElements.userAvatar.textContent = initials; } } else { uiElements.userName.textContent = 'Nepřihlášen'; uiElements.userAvatar.innerHTML = '?'; } } };
            const handleLoggedOutUser = () => { /* (stejné) */ console.warn("User not logged in."); updateAIStatus("Přihlaste se prosím."); if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder">Nejste přihlášeni</span>'; manageUIState('loggedOut'); };

            // --- Event Listeners Setup ---
            const setupEventListeners = () => { /* (stejné) */ console.log("Setting up event listeners..."); if (uiElements.mobileMenuToggle && uiElements.sidebar && uiElements.sidebarOverlay) { uiElements.mobileMenuToggle.addEventListener('click', (e) => { e.stopPropagation(); uiElements.sidebar.classList.toggle('active'); uiElements.sidebarOverlay.classList.toggle('active'); }); uiElements.sidebarOverlay.addEventListener('click', () => { uiElements.sidebar.classList.remove('active'); uiElements.sidebarOverlay.classList.remove('active'); }); document.querySelector('main')?.addEventListener('click', () => { if (uiElements.sidebar?.classList.contains('active')) { uiElements.sidebar.classList.remove('active'); uiElements.sidebarOverlay.classList.remove('active'); } }); } if (uiElements.interactionTabs.length > 0 && uiElements.tabContents.length > 0) { uiElements.interactionTabs.forEach(tab => { tab.addEventListener('click', () => switchInteractionTab(tab.dataset.tab)); }); } if (uiElements.chatInput && uiElements.sendButton) { uiElements.chatInput.addEventListener('input', autoResizeTextarea); uiElements.chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey && !state.geminiIsThinking) { e.preventDefault(); handleSendMessage(); } }); uiElements.sendButton.addEventListener('click', handleSendMessage); } if (uiElements.clearChatBtn) uiElements.clearChatBtn.addEventListener('click', confirmClearChat); if (uiElements.saveChatBtn) uiElements.saveChatBtn.addEventListener('click', saveChatToPDF); if (uiElements.nextStepBtn) uiElements.nextStepBtn.addEventListener('click', requestNextStep); if (uiElements.markCompleteBtn) uiElements.markCompleteBtn.addEventListener('click', handleMarkTopicComplete); window.addEventListener('resize', () => { if (window.innerWidth > 992 && uiElements.sidebar?.classList.contains('active')) { uiElements.sidebar.classList.remove('active'); uiElements.sidebarOverlay.classList.remove('active'); } }); };
            const initTooltips = () => { /* (stejné) */ try { if (window.jQuery && window.jQuery.fn.tooltipster) window.jQuery('.btn-tooltip:not(.tooltipstered)').tooltipster({ theme: 'tooltipster-shadow', animation: 'fade', delay: 100, side: 'top' }); } catch (e) { console.error("Tooltipster init error:", e); } };

             // --- Topic Loading and Progress ---
            const loadNextUncompletedTopic = async () => { /* (stejné) */ if (!state.currentUser || state.topicLoadInProgress || !state.supabase) return; state.topicLoadInProgress = true; if(uiElements.explanationDisplay) uiElements.explanationDisplay.innerHTML = ''; if (uiElements.chatMessages) uiElements.chatMessages.innerHTML = ''; updateExcalidrawScene([]); state.geminiChatContext = []; state.lastExplanationTimestamp = 0; if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder"><i class="fas fa-spinner fa-spin"></i> Hledám téma...</span>'; updateAIStatus('Hledám téma...'); manageUIState('loadingTopic'); try { const { data: activePlans, error: planError } = await state.supabase.from('study_plans').select('id').eq('user_id', state.currentUser.id).eq('status', 'active').limit(1); if (planError) throw planError; if (!activePlans || activePlans.length === 0) { console.log("No active plan."); if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder">Žádný plán</span>'; manageUIState('noPlan'); return; } state.currentPlanId = activePlans[0].id; const { data: nextActivities, error: activityError } = await state.supabase.from('plan_activities').select('id, title, description, topic_id').eq('plan_id', state.currentPlanId).eq('completed', false).order('day_of_week').order('time_slot').limit(1); if (activityError) throw activityError; if (nextActivities && nextActivities.length > 0) { const nextActivity = nextActivities[0]; let topicName = nextActivity.title || '?'; let topicDescription = nextActivity.description || ''; if (nextActivity.topic_id) { try { const { data: topicData } = await state.supabase.from('exam_topics').select('name, description').eq('id', nextActivity.topic_id).maybeSingle(); if (topicData) { topicName = topicData.name || topicName; topicDescription = topicData.description || topicDescription; } } catch (topicError) { console.error("Error fetching topic:", topicError); } } state.currentTopic = { activity_id: nextActivity.id, plan_id: state.currentPlanId, name: topicName, description: topicDescription, user_id: state.currentUser.id, topic_id: nextActivity.topic_id }; console.log("Topic set:", state.currentTopic); if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = `Téma: <strong>${sanitizeHTML(state.currentTopic.name)}</strong>`; await startLearningSession(); } else { console.log("All activities complete."); if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder">Plán dokončen!</span>'; manageUIState('planComplete'); } } catch (error) { console.error('Error loading topic:', error); if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder" style="color:var(--danger);">Chyba</span>'; manageUIState('error'); } finally { state.topicLoadInProgress = false; manageButtonStates(); } };
            const handleMarkTopicComplete = async () => { /* (stejné) */ if (!state.currentTopic || state.topicLoadInProgress) return; console.log(`Marking activity ${state.currentTopic.activity_id} complete.`); state.topicLoadInProgress = true; manageButtonStates(); if(uiElements.markCompleteBtn) uiElements.markCompleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; try { const { error } = await state.supabase.from('plan_activities').update({ completed: true, updated_at: new Date().toISOString() }).eq('id', state.currentTopic.activity_id); if (error) throw error; showToast(`Téma dokončeno.`, "success"); state.currentTopic = null; await loadNextUncompletedTopic(); } catch (error) { console.error(`Error marking activity complete:`, error); showToast("Chyba při označování.", "error"); state.topicLoadInProgress = false; manageButtonStates(); } finally { if(uiElements.markCompleteBtn) uiElements.markCompleteBtn.innerHTML = '<i class="fas fa-check-circle"></i> Téma dokončeno'; } };

            // --- Learning Session Management ---
            const startLearningSession = async () => { /* (stejné) */ if (!state.currentTopic) { manageUIState('error'); return; } console.log(`Starting session for: "${state.currentTopic.name}"`); state.currentSessionId = generateSessionId(); updateAIStatus(`Vysvětluje: ${state.currentTopic.name}`); manageUIState('requestingExplanation'); if (uiElements.chatMessages) uiElements.chatMessages.innerHTML = ''; state.geminiChatContext = []; state.lastExplanationTimestamp = 0; updateExcalidrawScene([]); if (state.excalidrawAPI?.updateScene) { try { state.excalidrawAPI.updateScene({ appState: { viewModeEnabled: false } }); } catch (e) { console.error("Error setting view mode:", e); } } const initialPrompt = _buildInitialPrompt(); await sendToGemini(initialPrompt, 'explanation'); };
            const switchInteractionTab = (tabId) => { /* (stejné) */ if (!tabId || !uiElements.interactionTabs || !uiElements.tabContents) return; uiElements.interactionTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabId)); uiElements.tabContents.forEach(content => content.classList.toggle('active', content.id === `${tabId}-content`)); state.activeInteractionTab = tabId; sessionStorage.setItem('activeVyukaTab', tabId); console.log(`Switched to tab: ${tabId}`); if (tabId === 'chat-tab' && uiElements.chatMessages) uiElements.chatMessages.scrollTop = uiElements.chatMessages.scrollHeight; };
            const requestNextStep = async () => { /* (stejné) */ if (state.geminiIsThinking || !state.currentTopic) return; console.log("Requesting next step..."); updateGeminiThinkingState(true); const prompt = `Pokračuj ve vysvětlování tématu "${state.currentTopic.name}". Naváž na předchozí krok. **DŮRAZNĚ POUŽIJ Excalidraw pro řešení PŘÍKLADŮ krok za krokem.** Použij fontFamily 1 nebo 2 a fontSize 20 nebo 28. Formát: \`EXCALIDRAW_SCENE: \`\`\`json [ ... ] \`\`\`\`. Přidej krátký souhrn: \`CHAT_SUMMARY: [Tvůj souhrn]\`.`; await sendToGemini(prompt, 'explanation'); };

             // --- Chat Functionality ---
            const addChatMessage = async (message, sender, saveToDb = true, timestamp = new Date()) => { /* (stejné) */ if (!uiElements.chatMessages) return; const messageId = `msg-${Date.now()}-${Math.random().toString(16).substring(2, 8)}`; const avatarInitial = sender === 'user' ? getInitials(state.currentProfile, state.currentUser?.email) : 'AI'; const messageDiv = document.createElement('div'); messageDiv.className = `chat-message ${sender === 'gemini' ? 'model' : sender}`; messageDiv.id = messageId; const bubbleDiv = document.createElement('div'); bubbleDiv.className = 'message-bubble'; renderMarkdown(bubbleDiv, message); messageDiv.innerHTML = `<div class="message-avatar">${avatarInitial}</div>`; messageDiv.appendChild(bubbleDiv); messageDiv.innerHTML += `<div class="message-timestamp">${formatTimestamp(timestamp)}</div>`; uiElements.chatMessages.appendChild(messageDiv); messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' }); if (saveToDb && state.supabase && state.currentUser && state.currentTopic && state.currentSessionId) { const dataToSave = { user_id: state.currentUser.id, session_id: state.currentSessionId, topic_id: state.currentTopic.topic_id || null, topic_name: state.currentTopic.name || null, role: sender === 'gemini' ? 'model' : 'user', content: message }; if (!dataToSave.session_id || !dataToSave.role || !dataToSave.content) { console.error("Missing fields for chat save."); return; } console.log("Attempting chat save..."); try { const { error } = await state.supabase.from('chat_history').insert(dataToSave); if (error) { console.error("DB chat save error:", error); } else { console.log("Chat message saved."); } } catch (dbError) { console.error("Exception during chat save:", dbError); } } };
            const updateGeminiThinkingState = (isThinking) => { /* (stejné) */ state.geminiIsThinking = isThinking; manageButtonStates(); if (isThinking) addThinkingIndicator(); else removeThinkingIndicator(); };
            const addThinkingIndicator = () => { /* (stejné) */ if (state.thinkingIndicatorId || !uiElements.chatMessages) return; const indicatorDiv = document.createElement('div'); indicatorDiv.className = 'chat-message model'; state.thinkingIndicatorId = `thinking-${Date.now()}`; indicatorDiv.id = state.thinkingIndicatorId; indicatorDiv.innerHTML = `<div class="message-avatar">AI</div><div class="message-thinking-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>`; uiElements.chatMessages.appendChild(indicatorDiv); indicatorDiv.scrollIntoView({ behavior: 'smooth', block: 'end' }); };
            const removeThinkingIndicator = () => { /* (stejné) */ if (state.thinkingIndicatorId) { const indicator = document.getElementById(state.thinkingIndicatorId); if (indicator) indicator.remove(); state.thinkingIndicatorId = null; } };
            const handleSendMessage = async () => { /* (stejné) */ const messageText = uiElements.chatInput.value.trim(); if (!messageText || state.geminiIsThinking || !state.currentTopic) return; uiElements.chatInput.value = ''; autoResizeTextarea(); uiElements.chatInput.focus(); const userTimestamp = new Date(); await addChatMessage(messageText, 'user', true, userTimestamp); state.geminiChatContext.push({ role: "user", parts: [{ text: messageText }] }); updateGeminiThinkingState(true); await sendToGemini(messageText, 'chat'); };
            const confirmClearChat = () => { /* (stejné) */ if (confirm("Opravdu chcete vymazat historii chatu a kresbu?")) { clearCurrentChatSessionHistory(); } };
            const clearCurrentChatSessionHistory = async () => { /* (stejné - ověřeno) */ if (uiElements.chatMessages) uiElements.chatMessages.innerHTML = ''; state.geminiChatContext = []; updateExcalidrawScene([]); showToast("Historie chatu a kresba vymazána.", "info"); console.log("Chat cleared."); if (state.supabase && state.currentUser && state.currentSessionId) { try { console.log(`Deleting chat history for session: ${state.currentSessionId}`); const { error } = await state.supabase.from('chat_history').delete().eq('user_id', state.currentUser.id).eq('session_id', state.currentSessionId); if (error) { console.error("Error deleting DB chat history:", error); showToast("Chyba při mazání historie z DB.", "error"); } else { console.log("DB chat history deleted."); } } catch (dbError) { console.error("Exception during DB chat deletion:", dbError); showToast("Výjimka při mazání historie z DB.", "error"); } } };
            const saveChatToPDF = async () => { /* (stejné) */ if (!uiElements.chatMessages || uiElements.chatMessages.children.length === 0) { showToast("Není co uložit.", "warning"); return; } showToast("Generuji PDF...", "info", 2000); const chatContainer = document.createElement('div'); const pdfStyles = ` <style> body { font-family: 'Poppins', sans-serif; font-size: 10pt; } .pdf-header { text-align: center; margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 10px; } .chat-message { margin-bottom: 10px; max-width: 85%; page-break-inside: avoid; } .chat-message.user { margin-left: 15%; text-align: right; } .message-bubble { padding: 8px 12px; border-radius: 10px; background-color: #f1f1f1; display: inline-block; border: 1px solid #eee; text-align: left; } .chat-message.user .message-bubble { background-color: #e1ffc7; } .message-timestamp { font-size: 8pt; color: #888; margin-top: 3px; display: block; } .chat-message.user .message-timestamp { text-align: right; } </style> `; chatContainer.innerHTML = pdfStyles; const headerDiv = document.createElement('div'); headerDiv.className = 'pdf-header'; headerDiv.innerHTML = `<h1>Chat - ${sanitizeHTML(state.currentTopic?.name || '?')}</h1><p>${new Date().toLocaleString('cs-CZ')}</p>`; chatContainer.appendChild(headerDiv); Array.from(uiElements.chatMessages.children).forEach(msg => { if (msg.classList.contains('chat-message')) { const clone = msg.cloneNode(true); const avatar = clone.querySelector('.message-avatar'); if(avatar) avatar.remove(); chatContainer.appendChild(clone); } }); const filename = `chat-justax-${state.currentTopic?.name?.replace(/[^a-z0-9]/gi, '_') || 'vyuka'}.pdf`; const options = { margin: 15, filename: filename, image: { type: 'jpeg', quality: 0.95 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }; try { await html2pdf().set(options).from(chatContainer).save(); showToast("Chat uložen jako PDF!", "success"); } catch (pdfError) { console.error("PDF export error:", pdfError); showToast("Nepodařilo se exportovat PDF.", "error"); } };

             // --- Gemini Interaction & Excalidraw Processing ---
             const parseExcalidrawScene = (responseText) => { /* (stejné) */ console.log("Parsing Excalidraw data..."); EXCALIDRAW_SCENE_REGEX.lastIndex = 0; const match = EXCALIDRAW_SCENE_REGEX.exec(responseText); let sceneData = null; let cleanedText = responseText; if (match && match[1]) { console.log("Found EXCALIDRAW_SCENE block."); try { let jsonString = match[1].trim().replace(/,\s*([}\]])/g, '$1'); sceneData = JSON.parse(jsonString); if (!Array.isArray(sceneData)) { sceneData = null; } else { console.log(`Parsed ${sceneData.length} elements.`); cleanedText = cleanedText.replace(match[0], '').trim(); } } catch (e) { console.error("Failed to parse Excalidraw JSON:", e); sceneData = null; } } else { console.log("No EXCALIDRAW_SCENE block."); } return { cleanedText, sceneData }; };
             const validateExcalidrawElements = (elements) => { /* (stejné) */ if (!Array.isArray(elements)) return { isValid: false, invalidElements: [{ index: -1, reason: "Not an array" }] }; const invalidElements = []; const requiredProps = { text: ['type', 'x', 'y', 'width', 'height', 'text', 'fontSize', 'fontFamily'], line: ['type', 'x', 'y', 'width', 'height', 'points'], arrow: ['type', 'x', 'y', 'width', 'height', 'points'], }; const numericProps = ['x', 'y', 'width', 'height', 'angle', 'strokeWidth', 'fontSize']; elements.forEach((el, index) => { let issues = []; if (typeof el !== 'object' || el === null || !el.type) issues.push("Not object or missing type"); else { const propsToCheck = requiredProps[el.type] || ['type', 'x', 'y', 'width', 'height']; for (const prop of propsToCheck) { if (el[prop] === undefined || el[prop] === null) issues.push(`Missing prop: ${prop}`); } for (const prop of numericProps) { if (el[prop] !== undefined && typeof el[prop] !== 'number') issues.push(`Non-numeric prop: ${prop}`); } if (el.width < 0) issues.push("Negative width"); if (el.height < 0) issues.push("Negative height"); if (['line', 'arrow'].includes(el.type)) { if (!Array.isArray(el.points) || el.points.length < 2 || el.points.some(p => !Array.isArray(p) || p.length !== 2 || typeof p[0] !== 'number' || typeof p[1] !== 'number')) issues.push("Invalid points array"); } } if (issues.length > 0) invalidElements.push({ index, element: el, reason: issues.join(', ') }); }); const overallIsValid = invalidElements.length === 0; if (!overallIsValid) console.error(`Validation failed: ${invalidElements.length} invalid elements.`); else console.log("Validation successful."); return { isValid: overallIsValid, invalidElements }; };
             const addDefaultExcalidrawProps = (elements) => { /* (stejné - používá fontFamily: 2 pro text) */ if (!Array.isArray(elements)) return elements; console.log("Patching elements..."); return elements.map(el => { if (typeof el !== 'object' || el === null) return el; el.x = (typeof el.x === 'number') ? el.x : 0; el.y = (typeof el.y === 'number') ? el.y : 0; el.width = (typeof el.width === 'number' && el.width >= 0) ? el.width : 10; el.height = (typeof el.height === 'number' && el.height >= 0) ? el.height : 10; el.angle = (typeof el.angle === 'number') ? el.angle : 0; el.strokeWidth = (typeof el.strokeWidth === 'number') ? el.strokeWidth : 1; el.opacity = (typeof el.opacity === 'number' && el.opacity >= 0 && el.opacity <= 100) ? el.opacity : 100; el.strokeColor = (typeof el.strokeColor === 'string') ? el.strokeColor : '#000000'; const defaults = { fillStyle: 'hachure', strokeStyle: 'solid', roughness: 0, seed: Date.now(), version: 1, versionNonce: Date.now()+1, isDeleted: false, boundElements: null, updated: Date.now(), link: null, locked: false, groupIds: [], frameId: null, roundness: null, startBinding: null, endBinding: null, startArrowhead: null, endArrowhead: null }; for (const key in defaults) { if (el[key] === undefined) el[key] = defaults[key]; } if (el.type === 'text') { el.fontSize = (typeof el.fontSize === 'number' && el.fontSize > 0) ? el.fontSize : 20; el.fontFamily = (typeof el.fontFamily === 'number' && [1,2,3].includes(el.fontFamily)) ? el.fontFamily : 2; /* Use 2 (Helvetica) */ console.log(`Patching text - fontFamily set to: ${el.fontFamily}`); el.text = (typeof el.text === 'string') ? el.text : '?'; el.textAlign = el.textAlign ?? 'left'; el.verticalAlign = el.verticalAlign ?? 'top'; el.baseline = el.baseline ?? 18; } if (['rectangle', 'ellipse', 'diamond'].includes(el.type)) { el.backgroundColor = el.backgroundColor ?? 'transparent'; el.strokeSharpness = el.strokeSharpness ?? (el.type === 'rectangle' ? 'sharp' : 'round'); } if (['line', 'arrow'].includes(el.type)) { if (!Array.isArray(el.points) || el.points.length < 2 || el.points.some(p => !Array.isArray(p) || p.length !== 2 || typeof p[0] !== 'number' || typeof p[1] !== 'number')) { console.warn("Patching: Invalid points data for line/arrow, using default.", el.points); el.points = [[0, 0], [el.width || 10, el.height || 10]]; } el.lastCommittedPoint = el.lastCommittedPoint ?? null; el.startArrowhead = el.startArrowhead ?? null; el.endArrowhead = el.endArrowhead ?? (el.type === 'arrow' ? 'arrow' : null); } return el; }); };
             /** Processes Gemini response, FILTERING invalid elements before update. */
            const processGeminiResponse = (rawResponseText, targetArea, timestamp) => {
                 removeThinkingIndicator();
                 let chatSummary = null;
                 const summaryMatch = rawResponseText.match(CHAT_SUMMARY_REGEX);
                 let textForProcessing = rawResponseText;
                 if (summaryMatch && summaryMatch[1]) { chatSummary = summaryMatch[1].trim(); textForProcessing = rawResponseText.replace(summaryMatch[0], '').trim(); console.log("Extracted Chat Summary:", chatSummary); }

                 let { cleanedText, sceneData } = parseExcalidrawScene(textForProcessing);
                 let finalElementsToRender = []; // Elements that will actually be sent to updateScene

                 if (sceneData) {
                     console.log(`Parsed ${sceneData.length} elements initially.`);
                     // --- VALIDATE FIRST ---
                     const validationResult = validateExcalidrawElements(sceneData);
                     if (!validationResult.isValid) {
                         console.warn("Filtering invalid Excalidraw elements BEFORE patching.");
                         const invalidIndices = new Set(validationResult.invalidElements.map(inv => inv.index));
                         const filteredSceneData = sceneData.filter((_, index) => !invalidIndices.has(index));
                         console.log(`Filtered ${invalidIndices.size} invalid elements. ${filteredSceneData.length} remain.`);
                         sceneData = filteredSceneData; // Use the filtered data
                         if (filteredSceneData.length !== validationResult.invalidElements.length + filteredSceneData.length) { // Check count match
                            showToast(`Varování: AI data pro kresbu byla částečně neplatná.`, "warning");
                         }
                     }
                     // --- PATCH VALID (or filtered) elements ---
                     if (sceneData.length > 0) {
                         finalElementsToRender = addDefaultExcalidrawProps(sceneData);
                         console.log(`Attempting update with ${finalElementsToRender.length} valid/patched elements.`);
                         updateExcalidrawScene(finalElementsToRender);
                     } else {
                         console.log("No valid Excalidraw elements left after filtering to update scene.");
                         // Optionally clear scene if needed, or just do nothing
                         // updateExcalidrawScene([]);
                     }
                 }

                 const textToDisplayInExplanation = cleanedText;
                 const textToDisplayInChat = chatSummary || (targetArea === 'chat' ? cleanedText : null);

                 // --- Update UI ---
                  if (targetArea === 'explanation') {
                     console.log("Processing for EXPLANATION area.");
                     const placeholder = uiElements.explanationDisplay?.querySelector('.loading-placeholder, .empty-state'); if (placeholder) placeholder.remove();
                     const isFirstStep = !uiElements.explanationDisplay?.querySelector('.step'); if (isFirstStep && uiElements.explanationDisplay) uiElements.explanationDisplay.innerHTML = '';
                     if (textToDisplayInExplanation.trim()) { const stepDiv = document.createElement('div'); stepDiv.className = 'step'; renderMarkdown(stepDiv, textToDisplayInExplanation); uiElements.explanationDisplay?.appendChild(stepDiv); state.lastExplanationTimestamp = Date.now(); if (uiElements.explanationScrollContent) setTimeout(() => stepDiv.scrollIntoView({ behavior: "smooth", block: "end" }), 100); }
                     else if (finalElementsToRender.length > 0) { const noteDiv = document.createElement('div'); noteDiv.className = 'step'; noteDiv.innerHTML = '<p><i>(AI aktualizovala kreslící plochu.)</i></p>'; uiElements.explanationDisplay?.appendChild(noteDiv); }
                     else { console.log("No text or valid scene data for explanation."); }
                     if (chatSummary) { addChatMessage(chatSummary, 'gemini', true, timestamp); } else if (textToDisplayInExplanation.trim() || finalElementsToRender.length > 0) { addChatMessage(`AI pokračovala... ${finalElementsToRender.length > 0 ? '(Kresba akt.)' : ''}`, 'gemini', false, timestamp); }
                     manageUIState('learning');
                 } else if (targetArea === 'chat') {
                     console.log("Processing for CHAT area.");
                     if (textToDisplayInChat?.trim()) { addChatMessage(textToDisplayInChat, 'gemini', true, timestamp); }
                     else if (finalElementsToRender.length > 0) { addChatMessage("(Aktualizoval/a jsem kresbu.)", 'gemini', false, timestamp); }
                     else { addChatMessage("(Nerozumím / Nemám co říct)", 'gemini', false, timestamp); }
                     manageUIState('chatting');
                 }

                 if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') { setTimeout(() => { console.log("MathJax: Queuing typeset..."); window.MathJax.typesetPromise().then(() => console.log("MathJax: Complete.")).catch(err => console.error('MathJax error:', err)); }, 200); }
             };


            // --- Prompts ---
            const _buildInitialPrompt = () => { /* (stejné) */ let prompt = `Jako AI Tutor "Justax" začni vysvětlovat ZÁKLADY tématu "${state.currentTopic.name}" pro studenta 9. třídy ZŠ (CERMAT).`; if (state.currentTopic.description) { prompt += ` Popis tématu: "${state.currentTopic.description}".`; } prompt += ` Buď podrobný, přátelský, krok za krokem. Toto je PRVNÍ krok. **POUŽIJ Excalidraw k VIZUALIZACI** základu nebo jednoduchého PŘÍKLADU. Použij fontFamily 1 nebo 2, fontSize 20 nebo 28. Formát: \`EXCALIDRAW_SCENE: \`\`\`json [ ... ] \`\`\`\`. Přidej KRÁTKÝ souhrn pro chat: \`CHAT_SUMMARY: [Tvůj souhrn]\`.`; return prompt; }
            const _buildGeminiPayloadContents = (userPromptText, targetArea) => { /* (stejné) */ const systemInstructionText = `Jsi AI Tutor "Justax", expert na matematiku pro 9. třídu ZŠ v ČR (CERMAT). Téma: "${state.currentTopic.name}"${state.currentTopic.description ? ` (${state.currentTopic.description})` : ''}. Styl: PŘÁTELSKÝ, TRPĚLIVÝ, PODROBNÝ. Postupuj krok za krokem. Používej PŘESNÉ termíny. Použij Markdown a MathJax ($...$ nebo $$...$$). VŽDY ČESKY. POKYNY: 1. KROK ZA KROKEM: 1 logický krok na odpověď. 2. INTERAKTIVITA: Pokládej otázky. 3. EXCALIDRAW: * POUŽÍVEJ ČASTO pro řešení PŘÍKLADŮ KROK ZA KROKEM. * FORMÁT: \`EXCALIDRAW_SCENE: \`\`\`json [ ... ] \`\`\`\`. JSON MUSÍ BÝT VALIDNÍ. * OBSAH: Piš kroky řešení ČITELNĚ. Barva #000000. FONT: fontFamily: 1 nebo 2. Velikost 20 nebo 28. STRUKTURA: Přehledně. JEDNODUCHOST: Základní tvary, roughness: 0. AKTUALIZACE: Vždy KOMPLETNÍ scéna. Pro smazání pošli \`[]\`. BODY PRO ARROW/LINE: [[0,0],[50,30]]. 4. DÉLKA: Vysvětlení delší, chat stručný. 5. CHAT SUMMARY: Na konec odpovědi přidej: \`CHAT_SUMMARY: [Tvůj souhrn]\`.`; const historyForApi = state.geminiChatContext.filter(item => item.role === 'user' || item.role === 'model').slice(-MAX_GEMINI_HISTORY_TURNS * 2); const currentRequestContent = { role: "user", parts: [{ text: userPromptText }] }; const contentsPayload = [ { role: "user", parts: [{ text: systemInstructionText }] }, { role: "model", parts: [{ text: "Rozumím." }] }, ...historyForApi, currentRequestContent ]; return contentsPayload; };
            const sendToGemini = async (userPromptText, targetArea) => { /* (stejné) */ if (!GEMINI_API_KEY || !GEMINI_API_KEY.startsWith('AIzaSy')) { showToast("Chyba: AI není nakonfigurována.", "error"); updateGeminiThinkingState(false); return; } if (!state.currentTopic) { showToast("Chyba: Není téma.", "error"); updateGeminiThinkingState(false); return; } console.log(`Sending to Gemini (Target: ${targetArea})...`); updateAIStatus('AI přemýšlí...'); const requestTimestamp = new Date(); updateGeminiThinkingState(true); const contentsPayload = _buildGeminiPayloadContents(userPromptText, targetArea); const requestBody = { contents: contentsPayload, generationConfig: { temperature: 0.5, topP: 0.95, topK: 40, maxOutputTokens: 8192 }, safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" } ] }; try { const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) }); if (!response.ok) { const errorBody = await response.text(); throw new Error(`Chyba API (${response.status}): ${errorBody.substring(0, 100)}`); } const data = await response.json(); const candidate = data.candidates?.[0]; if (!candidate) { const promptFeedback = data.promptFeedback; if (promptFeedback?.blockReason) throw new Error(`Obsah blokován: ${promptFeedback.blockReason}.`); throw new Error('Chybná odpověď AI.'); } if (candidate.finishReason && !["STOP", "MAX_TOKENS"].includes(candidate.finishReason)) console.warn(`Gemini finishReason: ${candidate.finishReason}`); const geminiResponseText = candidate.content?.parts?.[0]?.text; if (!geminiResponseText) throw new Error('AI vrátila prázdnou odpověď.'); state.geminiChatContext.push({ role: "user", parts: [{ text: userPromptText }] }); state.geminiChatContext.push({ role: "model", parts: [{ text: geminiResponseText }] }); processGeminiResponse(geminiResponseText, targetArea, requestTimestamp); updateAIStatus(state.currentTopic ? `Vysvětluje: ${state.currentTopic.name}` : 'Připraven'); } catch (error) { console.error('Gemini request error:', error); showToast(`Chyba AI: ${error.message}`, "error"); handleGeminiError(error.message, targetArea, requestTimestamp); updateAIStatus('Chyba'); } finally { updateGeminiThinkingState(false); } };
            const handleGeminiError = (errorMessage, targetArea, timestamp) => { /* (stejné) */ const errorMsg = `Omluva, nastala chyba: ${errorMessage}`; removeThinkingIndicator(); addChatMessage(errorMsg, 'gemini', false, timestamp); if (targetArea === 'explanation' && uiElements.explanationDisplay) { const errorP = document.createElement('p'); errorP.style.color = 'var(--danger)'; errorP.textContent = errorMsg; uiElements.explanationDisplay.appendChild(errorP); if(uiElements.explanationScrollContent) uiElements.explanationScrollContent.scrollTop = uiElements.explanationScrollContent.scrollHeight; } updateAIStatus('Chyba'); manageButtonStates(); };

            // --- Run Application ---
            document.addEventListener('DOMContentLoaded', initializeApp);

        } catch (e) {
            // --- Fatal Error Handling ---
            console.error("FATAL SCRIPT ERROR:", e);
            document.body.innerHTML = `<div style="padding: 20px; text-align: center; font-family: sans-serif; color: red;"><h1>Kritická chyba</h1><p>Aplikace nemohla být spuštěna.</p><pre>${e.message}\n${e.stack}</pre></div>`;
        }
    </script>

</body>
</html>