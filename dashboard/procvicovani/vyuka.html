<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Výuka na Tabuli (Verze z Original + Fix)</title> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        if (typeof window.MathJax === 'undefined') {
            window.MathJax = {
                tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']], processEscapes: true },
                options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], ignoreHtmlClass: 'tex2jax_ignore' },
                startup: { ready: () => { MathJax.startup.defaultReady(); MathJax.startup.promise.then(() => console.log('MathJax loaded and ready.')); } }
            };
        } else { console.warn("window.MathJax already defined."); }
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@excalidraw/excalidraw@0.17.3/dist/excalidraw.production.min.js" crossorigin></script>

    <style>
        /* --- CSS Styly --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; scroll-behavior: smooth; }
        :root {
            --primary-rgb: 67, 97, 238; --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9;
            --success: #06d6a0; --danger: #f72585; --warning: #f8961e; --info: #4cc9f0;
            --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d; --gray-light: #dee2e6;
            --gray-dark: #343a40; --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3);
            --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee); --white: #ffffff;
            --sidebar-width: 260px; --transition-speed: 0.3s; --card-radius: 14px;
            --shadow-sm: 0 2px 6px rgba(0, 0, 0, 0.05); --shadow-md: 0 5px 12px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1); --text-primary: #2d3748;
            --text-secondary: #4a5568; --text-muted: #718096; --page-bg: #f0f2f5;
            --panel-bg: var(--white); --avatar-size: 38px;
            --board-bg-light: #FFF0F5; /* Jemnější růžová (LavenderBlush) */
            --board-bg-dark: #4B0082; /* Tmavší pro dark mode */
            --element-color-light: #000000; /* ČERNÁ */
            --element-color-dark: #F0F0F0; /* Světlá pro dark mode */
        }
        html, body { height: 100%; overflow: hidden; }
        body { background-color: var(--page-bg); color: var(--text-primary); min-height: 100vh; display: flex; font-size: 15px; }

        /* --- Sidebar --- */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 1050; box-shadow: var(--shadow-lg); transition: transform var(--transition-speed) ease, width var(--transition-speed) ease; }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; } .sidebar-logo { font-size: 1.6rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.8rem; transition: transform 0.2s ease; } .sidebar-logo:hover { transform: scale(1.03); } .sidebar-logo i { font-size: 1.8rem; } .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; } .sidebar-item { margin-bottom: 0.5rem; } .sidebar-link { display: flex; align-items: center; padding: 0.85rem 1.1rem; color: rgba(255, 255, 255, 0.9); text-decoration: none; border-radius: 10px; transition: all 0.2s ease; font-weight: 500; position: relative; } .sidebar-link i { margin-right: 0.8rem; font-size: 1.25rem; width: 24px; text-align: center; transition: transform 0.2s ease; } .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.2); color: var(--white); } .sidebar-link:hover i { transform: scale(1.1); } .sidebar-link.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 65%; background-color: var(--white); border-radius: 0 4px 4px 0; } .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.85rem; color: rgba(255, 255, 255, 0.7); text-align: center; flex-shrink: 0; } .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.1); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.15); flex-shrink: 0;} .user-avatar { width: 42px; height: 42px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.8rem; font-weight: 500; overflow: hidden; color: var(--white); border: 2px solid rgba(255, 255, 255, 0.4); } .user-avatar img { width: 100%; height: 100%; object-fit: cover; } .user-info { flex-grow: 1; line-height: 1.3; } .user-name { font-weight: 600; font-size: 0.95rem; } .user-role { font-size: 0.8rem; opacity: 0.8; }

        /* --- Hlavní obsah --- */
        main { flex: 1; margin-left: var(--sidebar-width); transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); height: 100vh; display: flex; flex-direction: column; overflow: hidden; background-color: var(--page-bg); }
        .main-header { padding: 1rem 1.75rem; background-color: var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; z-index: 100; border-bottom: 1px solid var(--gray-light); }
        .header-content h1 { font-size: 1.5rem; font-weight: 600; color: var(--dark); margin: 0; } .header-actions { display: flex; align-items: center; gap: 0.75rem; } .header-actions button, .header-actions a { font-size: 0.9rem; padding: 0.6rem 1.2rem; }
        .topic-bar { padding: 0.7rem 1.75rem; background-color: var(--light); border-bottom: 1px solid var(--gray-light); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; flex-shrink: 0; min-height: 60px; }
        #current-topic-display { font-size: 1.1rem; font-weight: 500; color: var(--text-secondary); flex-grow: 1; } #current-topic-display strong { color: var(--primary); font-weight: 600; } #current-topic-display .placeholder { font-style: italic; color: var(--text-muted); } #current-topic-display .fa-spinner { margin-right: 0.5rem; }

        /* --- Learning Interface - Nový layout (Tabule + Chat) --- */
        .learning-interface {
            flex-grow: 1; /* Zabere zbytek výšky */
            display: flex;
            overflow: hidden; /* Zabrání scrollbaru na tomto kontejneru */
            padding: 1.2rem;
            gap: 1.2rem;
            /* Výpočet výšky pro zbývající prostor */
            height: calc(100vh - 65px - 60px - 2.4rem); /* vh - main-header - topic-bar - padding */
        }

        /* --- Excalidraw Oblast --- */
        .excalidraw-area {
            flex: 3 1 70%; /* Větší poměr */
            display: flex; flex-direction: column;
            background-color: var(--panel-bg); border-radius: var(--card-radius);
            box-shadow: var(--shadow-md); overflow: hidden; border: 1px solid var(--gray-light);
            min-height: 0; position: relative;
        }
        .excalidraw-header { padding: 0.8rem 1.25rem; border-bottom: 1px solid var(--gray-light); display: flex; align-items: center; justify-content: space-between; background-color: #fdfdff; flex-shrink: 0; }
        .excalidraw-header h2 { font-size: 1.1rem; font-weight: 600; color: var(--dark); margin: 0; display: flex; align-items: center; gap: 0.7rem;}
        .excalidraw-header h2 i { color: var(--primary); }
        .excalidraw-header-controls { display: flex; gap: 0.5rem; }
        .excalidraw-header-controls button { font-size: 0.8rem; padding: 0.3rem 0.6rem; background-color: var(--light); border: 1px solid var(--gray-light); border-radius: 6px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease;}
        .excalidraw-header-controls button:hover:not(:disabled) { background-color: var(--gray-light); color: var(--dark); border-color: var(--gray); }
        .excalidraw-header-controls button:disabled { opacity: 0.5; cursor: not-allowed; }
        .excalidraw-header-controls button i { margin-right: 0.3rem; }

        #excalidraw-container {
            flex-grow: 1; position: relative; overflow: auto; /* <<< UMOŽŇUJE SCROLLOVÁNÍ OBSAHU >>> */
            min-height: 0; background-color: var(--board-bg-light); /* RŮŽOVÁ */
            border-radius: 0 0 var(--card-radius) var(--card-radius);
        }
        /* Styl scrollbaru pro Webkit (Chrome, Safari) */
        #excalidraw-container::-webkit-scrollbar { width: 10px; height: 10px; }
        #excalidraw-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 5px; }
        #excalidraw-container::-webkit-scrollbar-thumb { background-color: var(--gray-light); border-radius: 5px; border: 2px solid transparent; background-clip: content-box;}
        #excalidraw-container::-webkit-scrollbar-thumb:hover { background-color: var(--gray); }
        /* Styl scrollbaru pro Firefox */
        #excalidraw-container { scrollbar-width: thin; scrollbar-color: var(--gray-light) rgba(0,0,0,0.05); }

        #excalidraw-container > .excalidraw-wrapper { width: 100% !important; height: 100% !important; display: flex !important; flex-direction: column !important; }
        /* Výška samotného Excalidraw elementu se přizpůsobí obsahu, ale musí mít min-height */
        #excalidraw-container .excalidraw { width: 100% !important; min-height: 100% !important; height: auto !important; border: none !important; }

        #excalidraw-container .loading-placeholder { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; color: var(--text-muted); background-color: rgba(255, 255, 255, 0.8); z-index: 5; }
        #excalidraw-container .loading-placeholder i { font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem; animation: spinPulse 2s infinite ease-in-out; }
        #excalidraw-container .loading-placeholder p { font-size: 1rem; }
        @keyframes spinPulse { 0% { transform: scale(1) rotate(0deg); opacity: 0.7; } 50% { transform: scale(1.1) rotate(180deg); opacity: 1; } 100% { transform: scale(1) rotate(360deg); opacity: 0.7; } }

        /* --- Chat Panel --- */
        .chat-panel {
            flex: 1 1 30%; /* Menší poměr */
            max-width: 400px; min-width: 300px;
            display: flex; flex-direction: column;
            background-color: var(--panel-bg); border-radius: var(--card-radius);
            box-shadow: var(--shadow-md); overflow: hidden; border: 1px solid var(--gray-light);
            min-height: 0; /* Důležité pro flexbox */
        }
        .chat-header { padding: 0.9rem 1.25rem; border-bottom: 1px solid var(--gray-light); background-color: #fdfdff; font-size: 1.1rem; font-weight: 600; color: var(--dark); display: flex; align-items: center; gap: 0.7rem; flex-shrink: 0; }
        .chat-header i { color: var(--secondary); }

        /* Chat Area (vnitřek beze změny) */
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        .chat-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; scrollbar-color: var(--gray-light) var(--panel-bg); min-height: 0; }
        .chat-messages::-webkit-scrollbar { width: 8px; } .chat-messages::-webkit-scrollbar-track { background: var(--panel-bg); } .chat-messages::-webkit-scrollbar-thumb { background-color: var(--gray-light); border-radius: 4px; border: 2px solid var(--panel-bg); }
        .chat-message { display: flex; gap: 0.7rem; max-width: 95%; align-items: flex-end; margin-bottom: 1rem; }
        .chat-message.user { margin-left: auto; flex-direction: row-reverse; }
        .message-avatar { width: var(--avatar-size); height: var(--avatar-size); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 0.9rem; flex-shrink: 0; box-shadow: var(--shadow-sm); border: 2px solid var(--panel-bg); }
        .chat-message.user .message-avatar { background: var(--success); color: white; } .chat-message.model .message-avatar { background: var(--primary); color: white; }
        .message-bubble { padding: 0.7rem 1.1rem; border-radius: 16px; line-height: 1.55; word-wrap: break-word; box-shadow: var(--shadow-sm); position: relative; background-color: var(--white); color: var(--text-primary); border: 1px solid #eef2f7; }
        .chat-message.model .message-bubble { border-bottom-left-radius: 5px; background: #f8faff; } .chat-message.user .message-bubble { background: var(--gradient-1); color: white; border: none; border-bottom-right-radius: 5px; }
        .message-timestamp { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; display: block; text-align: left; opacity: 0.8; } .chat-message.user .message-timestamp { text-align: right; }
        .message-thinking-indicator { background: var(--white); display: flex; align-items: center; padding: 0.7rem 1rem; border-radius: 16px; box-shadow: var(--shadow-sm); border: 1px solid #eef2f7; width: fit-content; border-bottom-left-radius: 5px;}
        .typing-dot { width: 6px; height: 6px; background-color: var(--gray); border-radius: 50%; margin: 0 2px; display: inline-block; animation: typing 1.3s infinite ease-in-out; } .typing-dot:nth-child(2) { animation-delay: 0.2s; } .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.5; } 30% { transform: translateY(-3px); opacity: 1; } }
        .chat-input-area { flex-shrink: 0; padding: 0.8rem 1rem; background-color: #f8f9fa; border-top: 1px solid var(--gray-light); display: flex; align-items: flex-end; gap: 0.7rem; }
        .chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--gray-light); border-radius: 18px; font-size: 0.9rem; resize: none; max-height: 110px; overflow-y: auto; transition: border-color 0.2s ease, box-shadow 0.2s ease; line-height: 1.4; background-color: var(--white); } .chat-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1); }
        .send-button { padding: 0 1rem; border-radius: 18px; font-weight: 600; font-size: 0.9rem; cursor: pointer; border: none; background: var(--gradient-1); color: white; transition: all 0.3s ease; flex-shrink: 0; height: 38px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); } .send-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(var(--primary-rgb), 0.2); } .send-button:active:not(:disabled) { transform: translateY(-1px); box-shadow: 0 3px 6px rgba(var(--primary-rgb), 0.15); } .send-button i { font-size: 1em; } .send-button .fa-spinner { margin: 0; }
        .chat-controls { flex-shrink: 0; padding: 0.4rem 1rem; font-size: 0.75rem; color: var(--text-muted); text-align: right; background-color: #f8f9fa; border-top: 1px solid var(--gray-light); } .chat-controls button { background:none; border:none; color: var(--text-muted); cursor:pointer; font-size: 0.9em; padding: 2px 5px; margin-left: 8px; transition: color 0.2s ease; } .chat-controls button:hover { color: var(--primary); }

        /* --- Common Elements & Responsiveness --- */
         .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.7rem 1.4rem; border-radius: 8px; font-weight: 500; font-size: 0.9rem; text-decoration: none; transition: all 0.25s ease; cursor: pointer; border: none; gap: 0.5rem; line-height: 1.5; } .btn-primary { background: var(--gradient-1); color: white; box-shadow: var(--shadow-sm); } .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); background: linear-gradient(135deg, var(--primary-light), var(--secondary)); } .btn-secondary { background-color: var(--white); color: var(--text-secondary); border: 1px solid var(--gray-light); box-shadow: var(--shadow-sm); } .btn-secondary:hover:not(:disabled) { background-color: #f8f9fa; color: var(--primary); border-color: var(--primary-light); } .btn-success { background: linear-gradient(135deg, var(--success), #05a381); color: white; box-shadow: var(--shadow-sm); } .btn-success:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); background: linear-gradient(135deg, #0cd1a7, var(--success));} .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; background: var(--gray); color: var(--white); border: none; } .btn i { font-size: 1em; }
         .loading-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; text-align: center; font-style: italic; color: var(--text-muted); flex-grow: 1; min-height: 150px; } .loading-placeholder i { margin-bottom: 1rem; font-size: 2.2rem; color: var(--primary-light); animation: spin 1.5s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }
         .empty-state { text-align: center; padding: 1.5rem; color: var(--text-secondary); flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100px; } .empty-state i { font-size: 2.5rem; margin-bottom: 1rem; color: var(--gray-light); opacity: 0.7; } .empty-state h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.6rem; color: var(--dark); } .empty-state p { margin-bottom: 1rem; max-width: 400px; margin-left: auto; margin-right: auto; line-height: 1.5; font-size: 0.9rem;}
         .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; color: var(--dark); font-size: 1.6rem; margin-right: 1rem; padding: 0.5rem; z-index: 1060; transition: color 0.2s ease; } .mobile-menu-toggle:hover { color: var(--primary); }
         .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.55); z-index: 1040; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(5px); } .sidebar-overlay.active { display: block; opacity: 1; }
         .toast { position: fixed; bottom: 20px; right: 20px; background-color: var(--white); color: var(--text-primary); border-radius: 8px; padding: 1rem 1.2rem; box-shadow: var(--shadow-lg); max-width: 320px; z-index: 1001; display: flex; align-items: center; transform: translateX(calc(100% + 30px)); opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); } .toast.show { transform: translateX(0); opacity: 1; } .toast.success { border-left: 4px solid var(--success); } .toast.success i { color: var(--success); } .toast.error { border-left: 4px solid var(--danger); } .toast.error i { color: var(--danger); } .toast.warning { border-left: 4px solid var(--warning); } .toast.warning i { color: var(--warning); } .toast.info { border-left: 4px solid var(--info); } .toast.info i { color: var(--info); } .toast i { margin-right: 0.8rem; font-size: 1.3rem; }
         mjx-math { display: inline-block; font-size: 1.05em; }
         .message-bubble mjx-math { color: var(--secondary); }
         .chat-message.user .message-bubble mjx-math { color: #e0e0ff; }

         @media (max-width: 1200px) { .chat-panel { flex-basis: 30%; max-width: 360px; } .learning-interface { padding: 1rem; gap: 1rem; height: calc(100vh - 65px - 60px - 2rem); } }
         @media (max-width: 992px) { :root { --sidebar-width: 80px; } .sidebar { width: 80px; } .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; } .sidebar-link i { margin-right: 0; font-size: 1.5rem; } .sidebar-logo i { margin-right: 0; } .sidebar-header, .sidebar-link { justify-content: center; } .user-profile { justify-content: center; padding: 0.75rem 0; } .user-avatar { margin-right: 0; } main { margin-left: 80px; width: calc(100% - 80px); } .learning-interface { flex-direction: column; height: calc(100vh - 65px - 60px - 1.6rem); padding: 0.8rem; gap: 0.8rem;} .excalidraw-area { flex: 6 1 60%; order: 1; } .chat-panel { width: 100%; flex: 4 1 40%; order: 2; max-width: none; } }
         @media (max-width: 576px) { :root { --sidebar-width: 0; } .sidebar { transform: translateX(-100%); z-index: 1050; width: 260px; } .sidebar.active { transform: translateX(0); } .sidebar.active .sidebar-logo span, .sidebar.active .sidebar-link span, .sidebar.active .user-info, .sidebar.active .sidebar-footer { display: block; } .sidebar.active .sidebar-link i { margin-right: 0.75rem; font-size: 1.25rem; } .sidebar.active .sidebar-header, .sidebar.active .sidebar-link { justify-content: flex-start; } .sidebar.active .user-profile { justify-content: flex-start; padding: 1rem; } .sidebar.active .user-avatar { margin-right: 0.75rem; } main { margin-left: 0; width: 100%; } .mobile-menu-toggle { display: block; } .main-header { padding: 0.7rem 1rem; } .header-content h1 { font-size: 1.15rem; } .learning-interface { padding: 0.5rem; gap: 0.5rem; height: calc(100vh - 58px - 55px - 1rem); } .excalidraw-area { flex-basis: 55%; } .chat-panel { flex-basis: 45%; } .chat-input { padding: 0.6rem 0.9rem; font-size: 0.85rem; } .send-button { height: 36px; padding: 0 0.8rem; } .message-bubble { padding: 0.6rem 0.9rem; } #continue-btn { padding: 0.5rem 1rem; font-size: 0.85rem; } }

         /* Dark Mode */
         @media (prefers-color-scheme: dark) {
             :root { --white: #1a202c; --light: #2d3748; --dark: #e2e8f0; --gray-light: #4a5568; --text-primary: #e2e8f0; --text-secondary: #cbd5e0; --text-muted: #a0aec0; --dark-bg: #171923; --page-bg: #131720; --panel-bg: #1e2533; --element-color: var(--element-color-dark); }
             body { background-color: var(--dark-bg); } main { background-color: var(--page-bg); }
             .main-header { background-color: var(--panel-bg); border-bottom-color: var(--gray-light); }
             .mobile-menu-toggle { color: var(--dark); } .topic-bar { background-color: var(--light); border-bottom-color: var(--gray-light); }
             .excalidraw-area, .chat-panel { background-color: var(--panel-bg); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); border-color: var(--gray-light); }
             .excalidraw-header { background-color: #242c3b; border-bottom-color: var(--gray-light); }
             .chat-header { background-color: #242c3b; border-bottom-color: var(--gray-light); }
             #excalidraw-container { background-color: var(--board-bg-dark); /* Tmavší růžová */ }
             #excalidraw-container .loading-placeholder { background-color: rgba(30, 37, 51, 0.8); }
             .chat-messages { scrollbar-color: var(--gray) var(--panel-bg); } .chat-messages::-webkit-scrollbar-track { background: var(--panel-bg); } .chat-messages::-webkit-scrollbar-thumb { border-color: var(--panel-bg); }
             .message-avatar { border-color: var(--panel-bg); }
             .message-bubble { background-color: var(--light); color: var(--text-primary); border-color: #3b4458; }
             .chat-message.user .message-bubble { background: var(--gradient-2); color: #1a202c; }
             .message-thinking-indicator { background: var(--light); border-color: #3b4458;} .typing-dot { background-color: #8494a6; }
             .chat-input-area { background-color: #242c3b; border-top-color: var(--gray-light); }
             .chat-input { background-color: var(--dark-bg); color: var(--text-primary); border-color: var(--gray-light); } .chat-input::placeholder { color: var(--text-muted); }
             .chat-input:focus { box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.2); }
             .chat-controls { background-color: #242c3b; border-top-color: var(--gray-light); } .chat-controls button { color: var(--text-muted); } .chat-controls button:hover { color: var(--primary-light); }
             .btn-secondary { background-color: var(--light); color: var(--text-secondary); border-color: var(--gray-light); } .btn-secondary:hover:not(:disabled) { background-color: #4a5568; color: var(--white); border-color: #6c757d; }
             .btn:disabled { background: #4a5568; color: #a0aec0; }
             .empty-state i { color: #4a5568; } .toast { background-color: var(--panel-bg); border-color: var(--gray-light); color: var(--text-primary); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);}
             .message-bubble mjx-math { color: var(--primary-light); }
             .chat-message.user .message-bubble mjx-math { color: #1a202c; }
             .excalidraw-header-controls button { background-color: var(--light); color: var(--text-secondary); border-color: var(--gray-light);}
             .excalidraw-header-controls button:hover { background-color: var(--gray-light); color: var(--dark); border-color: var(--gray);}
         }
    </style>
</head>
<body>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header"> <a href="/" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
        <ul class="sidebar-menu">
             <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Dashboard</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li>
        </ul>
        <div class="user-profile"> <div class="user-avatar" id="user-avatar">?</div> <div class="user-info"> <div class="user-name" id="user-name">Načítání...</div> <div class="user-role">Student</div> </div> </div>
        <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main>
        <div class="main-header">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="mobile-menu-toggle" id="mobile-menu-toggle"> <i class="fas fa-bars"></i> </button>
                    <h1>Výuka na tabuli</h1>
                </div>
                <div class="header-actions">
                     <button class="btn btn-success btn-tooltip" id="mark-complete-btn" style="display: none;" title="Označit aktuální téma jako probrané">
                         <i class="fas fa-check-circle"></i> Dokončit téma
                     </button>
                     <a href="/dashboard/procvicovani/main.html" class="btn btn-secondary">
                         <i class="fas fa-times"></i> Ukončit výuku
                     </a>
                </div>
            </div>
        </div>
        <div class="topic-bar">
             <div id="current-topic-display"><span class="placeholder">Načítám data...</span></div>
             <button class="btn btn-primary btn-tooltip" id="continue-btn" style="display: none;" title="Požádat AI o další část vysvětlení na tabuli">
                 <i class="fas fa-forward"></i> Pokračuj
             </button>
        </div>
        <div class="learning-interface" style="display: none;">
            <div class="excalidraw-area">
                <div class="excalidraw-header">
                    <h2><i class="fas fa-chalkboard"></i> Interaktivní tabule</h2>
                     <div class="excalidraw-header-controls">
                         <button id="clear-board-btn" class="btn-tooltip" title="Vymazat obsah tabule">
                             <i class="fas fa-eraser"></i> Vyčistit tabuli
                         </button>
                     </div>
                </div>
                <div id="excalidraw-container">
                    <div class="loading-placeholder"><i class="fas fa-spinner"></i><p>Načítám kreslící plochu...</p></div>
                </div>
            </div>
            <div class="chat-panel">
                <div class="chat-header"><i class="fas fa-comments"></i> Chat s AI Tutorem</div>
                <section class="chat-area">
                     <div class="chat-messages" id="chat-messages">
                         <div class="empty-state">
                             <i class="fas fa-chalkboard-teacher"></i>
                             <h3>Vítejte!</h3>
                             <p>AI Tutor začne vysvětlovat na tabuli. Můžete se ptát zde v chatu nebo použít tlačítko "Pokračuj".</p>
                         </div>
                     </div>
                     <div class="chat-input-area">
                         <textarea class="chat-input" id="chat-input" placeholder="Zeptejte se na něco k tabuli..." rows="1"></textarea>
                         <button class="send-button" id="send-button" title="Odeslat zprávu">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                     <div class="chat-controls">
                         <button id="clear-chat-btn" class="btn-tooltip" title="Vymazat historii tohoto chatu"> <i class="fas fa-trash-alt"></i> Vymazat chat </button>
                         | <button id="save-chat-btn" class="btn-tooltip" title="Uložit chat jako PDF"> <i class="fas fa-save"></i> Uložit chat </button>
                     </div>
                </section>
            </div>
        </div>
    </main>
    <div class="toast" id="toast"> <i class="fas fa-info-circle"></i> <div id="toast-message">Operace úspěšná.</div> </div>

    <script>
        // Wrap the entire script in a try-catch block for robust error handling
        try {
            // --- Constants & Configuration ---
            const SUPABASE_URL = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
            const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // !!! Production: Use a secure method !!!
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            const EXCALIDRAW_SCENE_REGEX = /EXCALIDRAW_SCENE:\s*```json\s*(\[[\s\S]*?\])\s*```\s*/gim;
            const MAX_GEMINI_HISTORY_TURNS = 8;
            const VERTICAL_SPACING = 60;
            const BOARD_BACKGROUND_LIGHT = "#FFF0F5"; // LavenderBlush
            const BOARD_BACKGROUND_DARK = "#4B0082"; // Indigo
            const ELEMENT_COLOR_LIGHT = "#000000"; // Černá
            const ELEMENT_COLOR_DARK = "#EAEAEA"; // Světle šedá

            // --- DOM Elements Cache ---
            const uiElements = {
                userAvatar: document.getElementById('user-avatar'), userName: document.getElementById('user-name'),
                mobileMenuToggle: document.getElementById('mobile-menu-toggle'), sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'), currentTopicDisplay: document.getElementById('current-topic-display'),
                excalidrawContainer: document.getElementById('excalidraw-container'), excalidrawWrapper: null,
                chatMessages: document.getElementById('chat-messages'), chatInput: document.getElementById('chat-input'),
                sendButton: document.getElementById('send-button'), saveChatBtn: document.getElementById('save-chat-btn'),
                clearChatBtn: document.getElementById('clear-chat-btn'), continueBtn: document.getElementById('continue-btn'),
                markCompleteBtn: document.getElementById('mark-complete-btn'), clearBoardBtn: document.getElementById('clear-board-btn'),
                toast: document.getElementById('toast'), toastMessage: document.getElementById('toast-message'),
                learningInterface: document.querySelector('.learning-interface'), chatPanel: document.querySelector('.chat-panel'),
            };

            // --- Global State ---
            let state = {
                supabase: null, currentUser: null, currentProfile: null,
                currentTopic: null, currentPlanId: null, currentSessionId: null,
                geminiChatContext: [], excalidrawAPI: null, excalidrawElements: [],
                excalidrawRoot: null, geminiIsThinking: false, thinkingIndicatorId: null,
                topicLoadInProgress: false, lowestY: 50,
                isDarkMode: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
            };

            // --- Utility Functions ---
            const sanitizeHTML = (str) => { const t = document.createElement('div'); t.textContent = str || ''; return t.innerHTML; };
            const getInitials = (p, e) => { if (!p && !e) return '?'; let i = ''; if (p?.first_name) i += p.first_name[0]; if (p?.last_name) i += p.last_name[0]; if (i) return i.toUpperCase(); if (p?.username) return p.username[0].toUpperCase(); if (e) return e[0].toUpperCase(); return 'U'; };
            const showToast = (message, type = 'info', duration = 4000) => { if (!uiElements.toast || !uiElements.toastMessage) return; console.log(`Toast (${type}): ${message}`); uiElements.toastMessage.textContent = message; const icon = uiElements.toast.querySelector('i'); uiElements.toast.className = 'toast ' + type; icon.className = `fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}`; uiElements.toast.style.transition = 'none'; uiElements.toast.style.transform = 'translateX(calc(100% + 30px))'; uiElements.toast.style.opacity = '0'; void uiElements.toast.offsetWidth; uiElements.toast.style.transition = 'all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55)'; uiElements.toast.classList.add('show'); setTimeout(() => uiElements.toast.classList.remove('show'), duration); };
            const renderMarkdown = (el, text) => { if (!el) return; try { marked.setOptions({ gfm: true, breaks: true }); el.innerHTML = marked.parse(text || ''); } catch (e) { el.innerHTML = `<p style="color:red;">Chyba renderování.</p>`; } };
            const autoResizeTextarea = () => { if (!uiElements.chatInput) return; uiElements.chatInput.style.height = 'auto'; const sh = uiElements.chatInput.scrollHeight; const mh = 110; uiElements.chatInput.style.height = `${Math.min(sh, mh)}px`; uiElements.chatInput.style.overflowY = sh > mh ? 'scroll' : 'hidden'; };
            const generateSessionId = () => `session_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
            const formatTimestamp = (d = new Date()) => d.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
            const updateCurrentLowestY = () => { let maxEndY = 0; state.excalidrawElements.forEach(el => { if (el && typeof el.y === 'number' && typeof el.height === 'number') { maxEndY = Math.max(maxEndY, el.y + el.height); } }); state.lowestY = maxEndY + VERTICAL_SPACING; console.log(`Calculated next available Y: ${state.lowestY}`); };
            const getBoardBackgroundColor = () => state.isDarkMode ? BOARD_BACKGROUND_DARK : BOARD_BACKGROUND_LIGHT;
            const getElementColor = () => state.isDarkMode ? ELEMENT_COLOR_DARK : ELEMENT_COLOR_LIGHT;

            // --- Initialization ---
            const initializeSupabase = () => { try { if (!window.supabase) throw new Error("Supabase lib not loaded."); state.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); if (!state.supabase) throw new Error("Client creation failed."); console.log("Supabase initialized."); return true; } catch (error) { console.error("Supabase init failed:", error); showToast("Chyba DB.", "error", 10000); return false; } };
            const initializeUI = () => { try { if (!initializeExcalidraw()) { throw new Error("Excalidraw initialization failed."); } setupEventListeners(); initTooltips(); manageUIState('initial'); return true; } catch(error) { console.error("UI Init failed:", error); showToast(`Chyba UI: ${error.message}`, "error", 10000); return false; }};
            const initializeApp = async () => { console.log("DOM Loaded. Initializing Board Tutor..."); if (!initializeSupabase()) return; if (!initializeUI()) return; manageUIState('loadingUser'); try { await loadUserProfile(); if (state.currentUser) { await loadNextUncompletedTopic(); } else { handleLoggedOutUser(); } } catch (error) { console.error("App initialization error:", error); manageUIState('error'); showToast("Chyba při startu aplikace.", "error"); }};

            // --- UI State & Button Management ---
            const manageUIState = (mode) => { console.log("UI State:", mode); const isLearning = ['learning', 'chatting', 'requestingExplanation'].includes(mode); const showLearningInterface = !!state.currentTopic || mode === 'loadingTopic' || mode === 'requestingExplanation' || mode === 'noPlan' || mode === 'planComplete' || mode === 'error'; if (uiElements.learningInterface) uiElements.learningInterface.style.display = showLearningInterface ? 'flex' : 'none'; if (uiElements.chatMessages && !isLearning && mode !== 'loadingUser') { let emptyStateHTML = ''; switch (mode) { case 'initial': case 'loadingUser': emptyStateHTML = "<div class='empty-state'><i class='fas fa-user-circle'></i><h3>Načítám...</h3></div>"; break; case 'loggedOut': emptyStateHTML = "<div class='empty-state'><i class='fas fa-sign-in-alt'></i><h3>Nejste přihlášeni</h3></div>"; break; case 'noPlan': emptyStateHTML = "<div class='empty-state'><i class='fas fa-calendar-times'></i><h3>Žádný aktivní plán</h3></div>"; break; case 'planComplete': emptyStateHTML = "<div class='empty-state'><i class='fas fa-check-circle'></i><h3>Plán dokončen!</h3></div>"; break; case 'error': emptyStateHTML = "<div class='empty-state'><i class='fas fa-exclamation-triangle'></i><h3>Chyba</h3></div>"; break; default: emptyStateHTML = ''; } if (emptyStateHTML || uiElements.chatMessages.children.length === 0 || ['loggedOut', 'noPlan', 'planComplete', 'error'].includes(mode)) { uiElements.chatMessages.innerHTML = emptyStateHTML; } } try { if (state.excalidrawAPI?.updateScene) { state.excalidrawAPI.updateScene({ appState: { viewModeEnabled: !isLearning } }); } } catch (e) { console.error("Error setting Excalidraw view mode:", e); } manageButtonStates(); };
            const manageButtonStates = () => { const canInteract = !!state.currentTopic && !state.geminiIsThinking && !state.topicLoadInProgress; if (uiElements.sendButton) { uiElements.sendButton.disabled = !canInteract; uiElements.sendButton.innerHTML = state.geminiIsThinking ? '<i class="fas fa-spinner fa-spin"></i>' : '<i class="fas fa-paper-plane"></i>'; } if (uiElements.continueBtn) { uiElements.continueBtn.disabled = !canInteract; uiElements.continueBtn.style.display = canInteract ? 'inline-flex' : 'none'; } if (uiElements.markCompleteBtn) { uiElements.markCompleteBtn.disabled = !canInteract; uiElements.markCompleteBtn.style.display = canInteract ? 'inline-flex' : 'none'; } if (uiElements.chatInput) { uiElements.chatInput.disabled = !canInteract; } if (uiElements.clearBoardBtn) { uiElements.clearBoardBtn.disabled = !state.excalidrawAPI || state.excalidrawElements.length === 0; } };

             // --- Excalidraw Functions ---
             const initializeExcalidraw = () => {
                console.log("Initializing Excalidraw...");
                const container = uiElements.excalidrawContainer;
                if (!container) { console.error("Excalidraw container not found!"); return false; }
                if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof ExcalidrawLib === 'undefined') { console.error("React/Excalidraw lib not loaded!"); return false; }
                try {
                    container.innerHTML = '<div class="loading-placeholder"><i class="fas fa-spinner"></i><p>Načítám kreslící plochu...</p></div>';
                    if (state.excalidrawRoot) { state.excalidrawRoot.unmount(); }

                    state.excalidrawRoot = ReactDOM.createRoot(container);
                    const initialAppState = {
                        viewBackgroundColor: getBoardBackgroundColor(), currentItemFontFamily: 2,
                        currentItemFontSize: 24, theme: state.isDarkMode ? 'dark' : 'light',
                        viewModeEnabled: true, gridSize: null, currentItemStrokeColor: getElementColor()
                    };

                    state.excalidrawRoot.render(
                        React.createElement(ExcalidrawLib.Excalidraw, {
                            initialData: { appState: initialAppState, elements: [] },
                            excalidrawAPI: (api) => {
                                if (!state.excalidrawAPI) {
                                    state.excalidrawAPI = api; console.log("Excalidraw API ready.");
                                    uiElements.excalidrawWrapper = container.querySelector('.excalidraw-wrapper');
                                    const placeholder = container.querySelector('.loading-placeholder'); if (placeholder) placeholder.remove();
                                    try { api.updateScene({ elements: [], appState: { viewBackgroundColor: getBoardBackgroundColor() } }); } catch(e) { console.error("Error clearing scene on init", e); }
                                }
                            },
                            UIOptions: { canvasActions: { saveToActiveFile: false, loadScene: false, export: { saveFileToDisk: true }, clearCanvas: false } },
                            viewModeEnabled: true, zenModeEnabled: false, gridModeEnabled: false,
                            theme: state.isDarkMode ? 'dark' : 'light',
                        })
                    );
                    console.log("Excalidraw component mount initiated.");
                    return true;
                } catch (error) { console.error("Error mounting Excalidraw:", error); container.innerHTML = `<div class="loading-placeholder" style="color:var(--danger);"><i class="fas fa-exclamation-triangle"></i><p>Chyba Excalidraw:<br>${error.message}</p></div>`; return false; }
            };
            // --- updateExcalidrawScene - Handles adding/clearing elements and scrolling ---
            const updateExcalidrawScene = (newElements = []) => {
                if (!state.excalidrawAPI) { console.warn("Excalidraw API not ready."); return; }
                if (!Array.isArray(newElements)) { console.warn("Invalid elements data:", newElements); return; }

                let elementsToUpdate = [];
                let shouldScroll = false;

                if (newElements.length > 0) {
                    // Append new elements
                    const yOffset = state.lowestY;
                    console.log(`Applying Y offset: ${yOffset} to ${newElements.length} new elements.`);
                    const processedNewElements = addDefaultExcalidrawProps(newElements).map(el => ({
                        ...el,
                        y: (typeof el.y === 'number' ? el.y + yOffset : yOffset) // Apply offset to Y
                    }));
                    state.excalidrawElements = [...state.excalidrawElements, ...processedNewElements]; // Update global state
                    elementsToUpdate = state.excalidrawElements; // Use the combined list for the update call
                    updateCurrentLowestY(); // Recalculate lowest Y based on the updated global state
                    shouldScroll = true;
                    console.log(`Appended ${processedNewElements.length} elements. New lowestY: ${state.lowestY}`);
                } else {
                    // Handle clearing (newElements is an empty array)
                    state.excalidrawElements = [];
                    elementsToUpdate = [];
                    state.lowestY = 50; // Reset Y position
                    console.log("Clearing board.");
                }

                // Validate the final list before sending
                const validationResult = validateExcalidrawElements(elementsToUpdate);
                if (!validationResult.isValid) {
                     console.error("Validation failed for final elements list. Aborting updateScene.");
                     showToast("Chyba: Neplatná data pro tabuli.", "error");
                     return;
                }

                try {
                    let currentAppState = state.excalidrawAPI.getAppState ? state.excalidrawAPI.getAppState() : {};
                    state.excalidrawAPI.updateScene({
                        elements: elementsToUpdate, // Send the full, potentially updated list
                        appState: { ...currentAppState, viewModeEnabled: false, viewBackgroundColor: getBoardBackgroundColor() }
                    });
                    console.log("Excalidraw updateScene successful.");

                    // Scroll container to bottom ONLY if new elements were added
                    if (shouldScroll && uiElements.excalidrawContainer) {
                        setTimeout(() => {
                            uiElements.excalidrawContainer.scrollTo({ top: uiElements.excalidrawContainer.scrollHeight, behavior: 'smooth' });
                            console.log("Scrolled Excalidraw container to bottom.");
                        }, 150); // Delay to allow rendering
                    }
                 } catch (error) { console.error("!!! Error during Excalidraw updateScene:", error); showToast("Chyba při aktualizaci tabule!", "error", 6000); }
                 manageButtonStates(); // Update button states (e.g., clear button)
             };
            const clearExcalidrawBoard = () => {
                 if (!state.excalidrawAPI) { showToast("Tabule není připravena.", "warning"); return; }
                 if (state.excalidrawElements.length === 0) { showToast("Tabule je již prázdná.", "info"); return; }
                 if (!confirm("Opravdu chcete smazat celý obsah tabule?")) return;
                 try {
                     updateExcalidrawScene([]); // Call updateScene with empty array to clear state and view
                     console.log("Excalidraw board cleared by user.");
                     showToast("Tabule vymazána.", "info");
                 } catch (error) { console.error("Error clearing board:", error); showToast("Chyba při mazání tabule.", "error"); }
             };

            // --- User Profile & Auth ---
            const loadUserProfile = async () => { if (!state.supabase) return; try { const { data: { user } } = await state.supabase.auth.getUser(); if (user) { state.currentUser = user; const { data: profile } = await state.supabase.from('profiles').select('*').eq('id', user.id).single(); state.currentProfile = profile; console.log("Profile loaded:", state.currentProfile); } else { state.currentUser = null; state.currentProfile = null; } } catch (error) { console.error('Error loading profile:', error); state.currentUser = null; state.currentProfile = null; showToast("Chyba načítání profilu.", "error"); } finally { updateUserInfoUI(); } };
            const updateUserInfoUI = () => { if (uiElements.userName && uiElements.userAvatar) { if (state.currentUser) { const email = state.currentUser.email; const initials = getInitials(state.currentProfile, email); const name = `${state.currentProfile?.first_name || ''} ${state.currentProfile?.last_name || ''}`.trim() || state.currentProfile?.username || email?.split('@')[0] || 'Uživatel'; uiElements.userName.textContent = name; uiElements.userAvatar.innerHTML = state.currentProfile?.avatar_url ? `<img src="${state.currentProfile.avatar_url}" alt="${initials}">` : initials; } else { uiElements.userName.textContent = 'Nepřihlášen'; uiElements.userAvatar.innerHTML = '?'; } } };
            const handleLoggedOutUser = () => { console.warn("User not logged in."); if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder">Nejste přihlášeni</span>'; showToast("Prosím, přihlaste se.", "warning"); manageUIState('loggedOut'); };

            // --- Event Listeners Setup ---
            const setupEventListeners = () => {
                 console.log("Setting up event listeners...");
                 // Mobile Menu
                 if (uiElements.mobileMenuToggle) uiElements.mobileMenuToggle.addEventListener('click', (e) => { e.stopPropagation(); uiElements.sidebar?.classList.toggle('active'); uiElements.sidebarOverlay?.classList.toggle('active'); });
                 if (uiElements.sidebarOverlay) uiElements.sidebarOverlay.addEventListener('click', () => { uiElements.sidebar?.classList.remove('active'); uiElements.sidebarOverlay?.classList.remove('active'); });
                 // Chat
                 if (uiElements.chatInput) uiElements.chatInput.addEventListener('input', autoResizeTextarea);
                 if (uiElements.sendButton) uiElements.sendButton.addEventListener('click', handleSendMessage);
                 if (uiElements.chatInput) uiElements.chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });
                 if (uiElements.clearChatBtn) uiElements.clearChatBtn.addEventListener('click', confirmClearChat);
                 if (uiElements.saveChatBtn) uiElements.saveChatBtn.addEventListener('click', saveChatToPDF);
                 // Learning Controls
                 if (uiElements.continueBtn) uiElements.continueBtn.addEventListener('click', requestContinue);
                 if (uiElements.markCompleteBtn) uiElements.markCompleteBtn.addEventListener('click', handleMarkTopicComplete);
                 if (uiElements.clearBoardBtn) uiElements.clearBoardBtn.addEventListener('click', clearExcalidrawBoard);
                 // Dark Mode Change Listener
                 window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                     state.isDarkMode = event.matches; console.log("Dark mode changed:", state.isDarkMode);
                     try {
                         if (state.excalidrawAPI?.updateScene) {
                            // Update background, theme and re-patch elements with correct color
                            state.excalidrawAPI.updateScene({
                                 appState: { theme: state.isDarkMode ? 'dark' : 'light', viewBackgroundColor: getBoardBackgroundColor() },
                                 elements: addDefaultExcalidrawProps(state.excalidrawElements) // Re-apply defaults for new colors
                            });
                         }
                     } catch(e) { console.error("Error updating theme on change", e); }
                 });
                 // Window Resize
                 window.addEventListener('resize', () => { if (window.innerWidth > 992) { uiElements.sidebar?.classList.remove('active'); uiElements.sidebarOverlay?.classList.remove('active'); } });
             };
            const initTooltips = () => { try { if (window.jQuery?.fn.tooltipster) { window.jQuery('.btn-tooltip:not(.tooltipstered)').tooltipster({ theme: 'tooltipster-shadow', animation: 'fade', delay: 100, side: 'top' }); } } catch (e) { console.error("Tooltipster error:", e); } };

             // --- Topic Loading and Progress ---
            const loadNextUncompletedTopic = async () => {
                if (!state.currentUser || state.topicLoadInProgress || !state.supabase) return;
                state.topicLoadInProgress = true; state.currentTopic = null;
                // Reset State for New Topic
                if (uiElements.chatMessages) uiElements.chatMessages.innerHTML = '<div class="empty-state"><i class="fas fa-book-open"></i><h3>Načítám další téma...</h3></div>';
                state.excalidrawElements = []; state.lowestY = 50; updateExcalidrawScene([]); // Clear board and reset Y
                state.geminiChatContext = []; // Clear context for new topic
                if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder"><i class="fas fa-spinner fa-spin"></i> Hledám...</span>';
                manageUIState('loadingTopic');

                try {
                    const { data: plans, error: planError } = await state.supabase.from('study_plans').select('id').eq('user_id', state.currentUser.id).eq('status', 'active').limit(1);
                    if (planError) throw planError;
                    if (!plans || plans.length === 0) { manageUIState('noPlan'); return; }
                    state.currentPlanId = plans[0].id;
                    const { data: activities, error: activityError } = await state.supabase.from('plan_activities').select('id, title, description, topic_id').eq('plan_id', state.currentPlanId).eq('completed', false).order('day_of_week').order('time_slot').limit(1);
                    if (activityError) throw activityError;

                    if (activities && activities.length > 0) {
                        const activity = activities[0];
                        let name = activity.title || 'N/A', desc = activity.description || '';
                        if (activity.topic_id) { try { const { data: topic } = await state.supabase.from('exam_topics').select('name, description').eq('id', activity.topic_id).single(); if (topic) { name = topic.name || name; desc = topic.description || desc; } } catch(e){ console.warn("Could not fetch topic details", e) } }
                        state.currentTopic = { activity_id: activity.id, plan_id: state.currentPlanId, name, description: desc, user_id: state.currentUser.id, topic_id: activity.topic_id };
                        if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = `Téma: <strong>${sanitizeHTML(name)}</strong>`;
                        await startLearningSession();
                    } else { manageUIState('planComplete'); }
                } catch (error) { console.error('Error loading topic:', error); showToast(`Chyba: ${error.message}`, "error"); manageUIState('error');
                } finally { state.topicLoadInProgress = false; manageButtonStates(); }
            };
            const handleMarkTopicComplete = async () => { if (!state.currentTopic || !state.supabase || state.topicLoadInProgress) return; state.topicLoadInProgress = true; manageButtonStates(); try { await state.supabase.from('plan_activities').update({ completed: true, updated_at: new Date().toISOString() }).eq('id', state.currentTopic.activity_id); showToast(`Téma "${state.currentTopic.name}" dokončeno.`, "success"); await loadNextUncompletedTopic(); } catch (error) { console.error(`Error marking complete:`, error); showToast("Chyba při označování tématu.", "error"); state.topicLoadInProgress = false; manageButtonStates(); } };

            // --- Learning Session & Chat ---
            const startLearningSession = async () => { if (!state.currentTopic) return; state.currentSessionId = generateSessionId(); manageUIState('requestingExplanation'); const prompt = _buildInitialPrompt(); await sendToGemini(prompt); };
            const requestContinue = async () => { if (state.geminiIsThinking || !state.currentTopic) return; const prompt = `Pokračuj ve vysvětlování tématu "${state.currentTopic.name}" na tabuli. Naváž na předchozí obsah. Nový obsah umísti POD Y=${state.lowestY}. Použij barvu "${getElementColor()}", font Helvetica 24px (family:2). JEN Excalidraw JSON.`; await sendToGemini(prompt); };
            const addChatMessage = async (message, sender, saveToDb = true, timestamp = new Date()) => { if (!uiElements.chatMessages) return; const id = `msg-${Date.now()}`; const avatar = sender === 'user' ? getInitials(state.currentProfile, state.currentUser?.email) : 'AI'; const div = document.createElement('div'); div.className = `chat-message ${sender === 'gemini' ? 'model' : sender}`; div.id = id; const avatarDiv = `<div class="message-avatar">${avatar}</div>`; const bubbleDiv = document.createElement('div'); bubbleDiv.className = 'message-bubble'; renderMarkdown(bubbleDiv, message); const timeDiv = `<div class="message-timestamp">${formatTimestamp(timestamp)}</div>`; div.innerHTML = avatarDiv + bubbleDiv.outerHTML + timeDiv; const empty = uiElements.chatMessages.querySelector('.empty-state'); if(empty) empty.remove(); uiElements.chatMessages.appendChild(div); div.scrollIntoView({ behavior: 'smooth', block: 'end' }); if (saveToDb && state.supabase && state.currentUser && state.currentTopic && state.currentSessionId) { try { await state.supabase.from('chat_history').insert({ user_id: state.currentUser.id, session_id: state.currentSessionId, topic_id: state.currentTopic.topic_id, topic_name: state.currentTopic.name, role: sender === 'gemini' ? 'model' : 'user', content: message }); } catch (e) { console.error("Chat save error:", e); showToast("Chyba ukládání chatu.", "error");} } };
            const updateGeminiThinkingState = (isThinking) => { state.geminiIsThinking = isThinking; manageButtonStates(); if (isThinking) addThinkingIndicator(); else removeThinkingIndicator(); };
            const addThinkingIndicator = () => { if (state.thinkingIndicatorId || !uiElements.chatMessages) return; const id = `thinking-${Date.now()}`; const div = document.createElement('div'); div.className = 'chat-message model'; div.id = id; div.innerHTML = `<div class="message-avatar">AI</div><div class="message-thinking-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>`; const empty = uiElements.chatMessages.querySelector('.empty-state'); if(empty) empty.remove(); uiElements.chatMessages.appendChild(div); div.scrollIntoView({ behavior: 'smooth', block: 'end' }); state.thinkingIndicatorId = id; };
            const removeThinkingIndicator = () => { if (state.thinkingIndicatorId) { document.getElementById(state.thinkingIndicatorId)?.remove(); state.thinkingIndicatorId = null; } };
            const handleSendMessage = async () => { const text = uiElements.chatInput?.value.trim(); if (!text || state.geminiIsThinking || !state.currentTopic) return; await addChatMessage(text, 'user'); state.geminiChatContext.push({ role: "user", parts: [{ text }] }); if (uiElements.chatInput) { uiElements.chatInput.value = ''; autoResizeTextarea(); uiElements.chatInput.focus(); } manageUIState('chatting'); updateGeminiThinkingState(true); const prompt = `Student se ptá: "${text}". Odpověz stručně k tématu "${state.currentTopic.name}". Pokud je to vhodné, AKTUALIZUJ tabuli Excalidraw (přidej nové prvky POD Y=${state.lowestY}, barva="${getElementColor()}", font Helvetica 24px). JEN Excalidraw JSON.`; await sendToGemini(prompt); };
            const confirmClearChat = () => { if (confirm("Opravdu vymazat chat?")) clearCurrentChatSessionHistory(); };
            const clearCurrentChatSessionHistory = async () => { if (uiElements.chatMessages) uiElements.chatMessages.innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><h3>Chat vymazán</h3></div>'; state.geminiChatContext = []; showToast("Historie chatu vymazána.", "info"); if (state.supabase && state.currentUser && state.currentSessionId) { try { await state.supabase.from('chat_history').delete().match({ user_id: state.currentUser.id, session_id: state.currentSessionId }); } catch (e) { console.error("DB clear chat error:", e); } } };
            const saveChatToPDF = async () => { if (!uiElements.chatMessages || uiElements.chatMessages.children.length === 0) { showToast("Není co uložit.", "warning"); return; } if (typeof html2pdf === 'undefined') { showToast("Chyba: PDF knihovna.", "error"); return; } showToast("Generuji PDF...", "info", 3000); const el = document.createElement('div'); el.style.padding="20mm"; el.innerHTML=`<style>body{font-family:Poppins,sans-serif;font-size:10pt;line-height:1.5;color:#333}.user{margin-left:10%}.model{margin-right:10%}.msg{margin-bottom:10px;max-width:90%;page-break-inside:avoid}.bubble{padding:8px 12px;border-radius:12px;background:#eee;display:inline-block;}.user .bubble{background:#dcf8c6;}.time{font-size:8pt;color:#888;margin-top:3px;display:block;}.user .time{text-align:right;}h1{font-size:16pt;color:#3f37c9;text-align:center;margin-bottom:5px}p{font-size:9pt;color:#6c757d;text-align:center;margin:0 0 10px}hr{border:0;border-top:1px solid #ccc;margin:10px 0}</style><h1>Chat - ${sanitizeHTML(state.currentTopic?.name||'Neznámé')}</h1><p>${new Date().toLocaleString('cs-CZ')}</p><hr>`; Array.from(uiElements.chatMessages.children).forEach(m=>{if(m.classList.contains('chat-message')&&!m.id.startsWith('thinking-')){const c=m.cloneNode(true);c.querySelector('.message-avatar')?.remove();c.classList.add(m.classList.contains('user')?'user':'model','msg');c.querySelector('.message-bubble').classList.add('bubble');c.querySelector('.message-timestamp').classList.add('time');el.appendChild(c);}}); const fn=`chat-${state.currentTopic?.name?.replace(/[^a-z0-9]/gi,'_')||'vyuka'}.pdf`; try{await html2pdf().set({margin:15,filename:fn,jsPDF:{unit:'mm',format:'a4'}}).from(el).save();showToast("Chat uložen!", "success");}catch(e){console.error("PDF Error:",e);showToast("Chyba PDF.", "error");} };

             // --- Gemini Interaction & Excalidraw Processing ---
            const parseExcalidrawScene = (text) => { EXCALIDRAW_SCENE_REGEX.lastIndex = 0; const match = EXCALIDRAW_SCENE_REGEX.exec(text); let data = null, cleaned = text; if (match?.[1]) { try { data = JSON.parse(match[1].trim().replace(/,\s*([}\]])/g, '$1')); if (!Array.isArray(data)) data = null; else cleaned = text.replace(match[0], '').trim(); } catch (e) { console.error("Excalidraw JSON parse error:", e); data = null; } } return { cleanedText: cleaned, sceneData: data }; };
            const validateExcalidrawElements = (elements) => { if (!Array.isArray(elements)) return { isValid: false }; let isValid = true; elements.forEach((el, i) => { if (typeof el !== 'object' || !el?.type || (el.type === 'text' && typeof el.text !== 'string')) { console.error(`Invalid element [${i}]:`, el); isValid = false; }}); return { isValid }; };
             // Replace Nullish Coalescing (??) with ternary or || for compatibility
            const addDefaultExcalidrawProps = (elements) => {
                if (!Array.isArray(elements)) return [];
                const color = getElementColor();
                const defaultSeed = Math.random() * 1e9 | 0;
                return elements.map((el) => {
                    if (typeof el !== 'object' || el === null) return el;
                    // Helper for safe fallback
                    const fallback = (value, def) => (value !== null && value !== undefined) ? value : def;

                    const defaults = {
                        x: fallback(el.x, 0), y: fallback(el.y, 0),
                        width: fallback(el.width, 50), height: fallback(el.height, 20),
                        angle: fallback(el.angle, 0), strokeColor: color, // Always use current element color
                        backgroundColor: fallback(el.backgroundColor, 'transparent'),
                        fillStyle: fallback(el.fillStyle, 'hachure'),
                        strokeWidth: fallback(el.strokeWidth, 1),
                        strokeStyle: fallback(el.strokeStyle, 'solid'),
                        roughness: 0, opacity: 100,
                        strokeSharpness: fallback(el.strokeSharpness, 'sharp'),
                        seed: fallback(el.seed, defaultSeed),
                        version: fallback(el.version, 2),
                        versionNonce: fallback(el.versionNonce, (Math.random() * 1e9 | 0)),
                        isDeleted: false, groupIds: fallback(el.groupIds, []),
                        frameId: fallback(el.frameId, null), boundElements: fallback(el.boundElements, null),
                        updated: Date.now(), link: fallback(el.link, null), locked: fallback(el.locked, false)
                    };
                    const textDefaults = { fontSize: 24, fontFamily: 2, textAlign: 'left', verticalAlign: 'top', baseline: 18 };
                    const lineDefaults = { points: [[0, 0], [defaults.width, defaults.height]], startArrowhead: null, endArrowhead: null };
                    const arrowDefaults = { ...lineDefaults, endArrowhead: 'arrow' };

                    let typeDefaults = {};
                    if (el.type === 'text') typeDefaults = textDefaults;
                    else if (el.type === 'line') typeDefaults = lineDefaults;
                    else if (el.type === 'arrow') typeDefaults = arrowDefaults;

                    const patched = { ...defaults, ...typeDefaults, ...el };
                    patched.width = Math.max(1, patched.width || 1);
                    patched.height = Math.max(1, patched.height || 1);
                    if (patched.type === 'text' && typeof patched.text !== 'string') { patched.text = String(patched.text || ''); }
                    // Ensure points are valid for lines/arrows
                    if (['line', 'arrow'].includes(patched.type)) {
                         if (!Array.isArray(patched.points) || patched.points.length < 2 || patched.points.some(p => !Array.isArray(p) || p.length !== 2)) {
                              console.warn("Invalid points found, resetting:", patched.points);
                              patched.points = [[0,0], [patched.width, patched.height]];
                         }
                    }
                    return patched;
                });
            };
            const processGeminiResponse = (rawText, timestamp) => { removeThinkingIndicator(); let { cleanedText, sceneData } = parseExcalidrawScene(rawText); if (sceneData) { if (validateExcalidrawElements(sceneData).isValid) { updateExcalidrawScene(sceneData); addChatMessage("(AI aktualizovala tabuli)", 'gemini', false, timestamp); } else { console.error("Invalid Excalidraw data received."); showToast("Chyba dat tabule od AI.", "error"); addChatMessage("(AI poslala neplatná data pro tabuli)", 'gemini', false, timestamp); } } else if (cleanedText.trim()) { console.warn("AI sent text, expected Excalidraw:", cleanedText); addChatMessage(`AI: ${cleanedText}`, 'gemini', true, timestamp); showToast("AI odpověděla textem.", "warning"); } else { console.log("AI sent no usable content."); addChatMessage("(AI neposlala aktualizaci)", 'gemini', false, timestamp); } manageUIState('learning'); };
            const _buildInitialPrompt = () => { return `Jako AI Tutor vysvětli ZÁKLADY tématu "${state.currentTopic.name}". VŠE kresli POUZE na Excalidraw. Pozadí ${getBoardBackgroundColor()}, prvky barvou "${getElementColor()}", font Helvetica 24px (family:2). Umísti obsah na Y=50. Formát: \`EXCALIDRAW_SCENE: \`\`\`json [ ... ] \`\`\`\`. Žádný jiný text.`; };
            const _buildGeminiPayloadContents = (userPrompt) => { const color = getElementColor(); const system = `Jsi AI Tutor "Justax". Vyučuješ téma: "${state.currentTopic.name}". Vysvětluj VŠE POUZE kreslením na Excalidraw. NEPOSÍLEJ TEXT MIMO JSON.
PRAVIDLA KRESLENÍ:
1. NOVÝ obsah umísti POD existující (aktuální nejnižší Y je ${state.lowestY}). Přičti k Y nových prvků alespoň ${VERTICAL_SPACING}.
2. Pozadí=${getBoardBackgroundColor()}, všechny prvky kresli barvou "${color}".
3. Font Helvetica 24px (family:2). Řeš příklady krok za krokem. Piš čitelně.
4. Posílej JEN JSON NOVÝCH prvků: \`EXCALIDRAW_SCENE: \`\`\`json [ ... ] \`\`\`\`. ŽÁDNÝ JINÝ TEXT.`; const history = state.geminiChatContext.slice(-MAX_GEMINI_HISTORY_TURNS * 2); const current = { role: "user", parts: [{ text: userPrompt }] }; const modelAck = { role: "model", parts: [{ text: `Rozumím. Budu kreslit na tabuli (${getBoardBackgroundColor()}), prvky ${color}, font Helvetica 24px, pod Y=${state.lowestY}. Pošlu jen JSON.` }]}; return [{ role: "user", parts:[{text:system}] }, modelAck, ...history, current]; };
            const sendToGemini = async (prompt) => { if (!GEMINI_API_KEY || GEMINI_API_KEY.startsWith('YOUR_')) {showToast("Chyba: AI Key.", "error"); updateGeminiThinkingState(false); return;} if (!state.currentTopic) {showToast("Chyba: Není téma.", "error"); updateGeminiThinkingState(false); return;} if (!navigator.onLine) {showToast("Chyba: Offline.", "error"); updateGeminiThinkingState(false); return;} console.log(`Sending: "${prompt.substring(0, 100)}..."`); const timestamp = new Date(); updateGeminiThinkingState(true); const contents = _buildGeminiPayloadContents(prompt); const body = { contents, generationConfig: { temperature: 0.5, topP: 0.95, topK: 40, maxOutputTokens: 8192 }, safetySettings: [{ category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }] }; try { const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }); if (!response.ok) { let errorText = `API Error (${response.status})`; try { const errData = await response.json(); errorText += `: ${errData?.error?.message || 'Unknown'}`; } catch (e) { errorText += `: ${await response.text()}`; } throw new Error(errorText); } const data = await response.json(); const candidate = data.candidates?.[0]; if (data.promptFeedback?.blockReason) throw new Error(`Blokováno: ${data.promptFeedback.blockReason}.`); if (!candidate) throw new Error('Chybná odpověď AI.'); if (candidate.finishReason && !["STOP", "MAX_TOKENS"].includes(candidate.finishReason)) { if(candidate.finishReason === 'SAFETY') throw new Error('Blokováno filtrem AI.'); console.warn(`Gemini finishReason: ${candidate.finishReason}.`); } const text = candidate.content?.parts?.[0]?.text; if (!text) { if (candidate.finishReason === 'MAX_TOKENS') throw new Error('Max. délka odpovědi.'); else throw new Error('Prázdná odpověď AI.'); } if (!prompt.startsWith('Pokračuj')) { state.geminiChatContext.push({ role: "user", parts: [{ text: prompt }] }); state.geminiChatContext.push({ role: "model", parts: [{ text }] }); if (state.geminiChatContext.length > MAX_GEMINI_HISTORY_TURNS * 2) state.geminiChatContext.splice(0, state.geminiChatContext.length - MAX_GEMINI_HISTORY_TURNS * 2); } processGeminiResponse(text, timestamp); } catch (error) { console.error('Gemini Error:', error); showToast(`Chyba AI: ${error.message}`, "error"); handleGeminiError(error.message, timestamp); } finally { updateGeminiThinkingState(false); } };
            const handleGeminiError = (msg, time) => { addChatMessage(`Chyba: ${msg}`, 'gemini', false, time); manageButtonStates(); };

            // --- Run Application ---
            document.addEventListener('DOMContentLoaded', initializeApp);

        } catch (e) {
            // --- Fatal Error Handling ---
            console.error("FATAL SCRIPT ERROR:", e);
            document.body.innerHTML = `<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:#fdd;color:#800;padding:40px;text-align:center;font-family:sans-serif;z-index:9999;"><h1>Chyba Aplikace</h1><p>Nelze spustit.</p><p><a href="#" onclick="location.reload()">Obnovit</a></p><details><summary>Detaily</summary><pre style="margin-top:10px;padding:10px;background:#fff;border:1px solid #f5c6cb;font-size:0.8em;white-space:pre-wrap;">${e.message}\n${e.stack}</pre></details></div>`;
        }
    </script>

</body>
</html>