<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Interaktivní Výuka</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        // MathJax Configuration
        if (typeof window.MathJax === 'undefined') {
            window.MathJax = {
                tex: { inlineMath: [['\\(', '\\)']], displayMath: [['$$', '$$']], processEscapes: true, processEnvironments: true },
                options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' },
                startup: { ready: () => { MathJax.startup.defaultReady(); MathJax.startup.promise.then(() => console.log('MathJax loaded and ready.')); } }
            };
        } else {
             console.warn("window.MathJax already defined.");
        }
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- CSS Styles (Added canvas size adjustments) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; scroll-behavior: smooth; }
        :root {
            --primary-rgb: 67, 97, 238; --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9; --success: #06d6a0; --danger: #f72585; --warning: #f8961e; --info: #4cc9f0; --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d; --gray-light: #dee2e6; --gray-dark: #343a40; --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3); --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee); --white: #ffffff; --sidebar-width: 260px; --transition-speed: 0.3s; --card-radius: 16px; --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06); --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.08); --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.12); --text-primary: #2d3748; --text-secondary: #4a5568; --text-muted: #718096; --call-bg: #f4f7fe; --call-panel-bg: var(--white); --avatar-size: 48px;
        }
        body { background-color: var(--call-bg); color: var(--text-primary); min-height: 100vh; display: flex; overflow: hidden; font-size: 15px; }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 1050; box-shadow: var(--shadow-lg); transition: transform var(--transition-speed) ease, width var(--transition-speed) ease; }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; }
        .sidebar-logo { font-size: 1.6rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.8rem; transition: transform 0.2s ease; }
        .sidebar-logo:hover { transform: scale(1.05); }
        .sidebar-logo i { font-size: 1.8rem; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .sidebar-item { margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.85rem 1.1rem; color: rgba(255, 255, 255, 0.88); text-decoration: none; border-radius: var(--card-radius); transition: all 0.2s ease; font-weight: 500; position: relative; }
        .sidebar-link i { margin-right: 0.8rem; font-size: 1.25rem; width: 24px; text-align: center; transition: transform 0.2s ease; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.18); color: var(--white); }
        .sidebar-link:hover i { transform: scale(1.1); }
        .sidebar-link.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 70%; background-color: var(--white); border-radius: 0 4px 4px 0; }
        .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.85rem; color: rgba(255, 255, 255, 0.7); text-align: center; }
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.1); border-radius: var(--card-radius); border: 1px solid rgba(255, 255, 255, 0.2); }
        .user-avatar { width: 42px; height: 42px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.8rem; font-weight: 500; overflow: hidden; color: var(--white); border: 2px solid rgba(255, 255, 255, 0.5); }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; line-height: 1.3; }
        .user-name { font-weight: 600; font-size: 0.95rem; }
        .user-role { font-size: 0.8rem; opacity: 0.8; }

        /* Main Content Area */
        main { flex: 1; margin-left: var(--sidebar-width); transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); height: 100vh; display: flex; flex-direction: column; overflow: hidden; background-color: var(--call-bg); }
        .main-header { padding: 1rem 1.75rem; background-color: var(--white); box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; z-index: 100; border-bottom: 1px solid var(--gray-light); }
        .header-content h1 { font-size: 1.6rem; font-weight: 600; color: var(--dark); margin: 0; }
        .header-actions button, .header-actions a { font-size: 0.9rem; padding: 0.6rem 1.2rem; }
        .topic-loading-bar { padding: 0.9rem 1.75rem; background-color: var(--light); border-bottom: 1px solid var(--gray-light); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; flex-shrink: 0; }
        #current-topic-display { font-size: 1.05rem; font-weight: 500; color: var(--text-secondary); }
        #current-topic-display strong { color: var(--primary); font-weight: 600; }
        #current-topic-display .placeholder { font-style: italic; color: var(--text-muted); }
        #current-topic-display .fa-spinner { margin-right: 0.5rem; }

        /* Videocall Interface Layout */
        .call-interface { flex-grow: 1; display: flex; overflow: hidden; padding: 1.75rem; gap: 1.75rem; }
        .ai-presenter-area { flex-grow: 1; /* Takes up remaining space */ display: flex; flex-direction: column; background-color: var(--call-panel-bg); border-radius: var(--card-radius); box-shadow: var(--shadow-md); overflow: hidden; border: 1px solid var(--gray-light); transition: box-shadow 0.3s ease; }
        .ai-presenter-area:hover { box-shadow: var(--shadow-lg); }
        .ai-presenter-header { padding: 0.8rem 1.35rem; border-bottom: 1px solid var(--gray-light); display: flex; align-items: center; gap: 0.8rem; background-color: #fcfdff; flex-shrink: 0; }
        .ai-avatar-placeholder { width: var(--avatar-size); height: var(--avatar-size); background: var(--gradient-1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.6rem; flex-shrink: 0; box-shadow: var(--shadow-sm); }
        .ai-presenter-info h2 { font-size: 1.15rem; font-weight: 600; color: var(--dark); margin: 0; }
        .ai-presenter-info p { font-size: 0.88rem; color: var(--text-secondary); margin: 0; }
        .whiteboard-main-container { flex-grow: 1; position: relative; overflow: hidden; border-radius: 0 0 var(--card-radius) var(--card-radius); background-color: #fdfdfd; display: flex; justify-content: center; align-items: center; padding: 15px; }
        #drawingCanvas { max-width: 100%; max-height: 100%; background-color: #fff; border: 1px dashed var(--gray-light); object-fit: contain; border-radius: 8px; }
        .canvas-controls { position: absolute; bottom: 15px; right: 15px; display: flex; gap: 8px; background-color: rgba(255, 255, 255, 0.9); padding: 8px 10px; border-radius: var(--card-radius); box-shadow: var(--shadow-sm); border: 1px solid var(--gray-light); }
        .canvas-controls button { padding: 6px 12px; font-size: 0.9em; line-height: 1; min-width: auto; background-color: var(--white); border: 1px solid var(--gray-light); color: var(--text-secondary); transition: all 0.2s ease; }
        .canvas-controls button:hover { background-color: var(--light); color: var(--primary); border-color: var(--primary-light); transform: scale(1.05); }

        /* Interaction Panel */
        .interaction-panel {
            /* width: 450px; /* Original */
            width: 400px; /* Reduced width to give more space to canvas */
            flex-shrink: 0; /* Prevent shrinking */
            display: flex;
            flex-direction: column;
            background-color: var(--call-panel-bg);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            border: 1px solid var(--gray-light);
            transition: box-shadow 0.3s ease;
        }
        .interaction-panel:hover { box-shadow: var(--shadow-lg); }
        .interaction-tabs { display: flex; border-bottom: 1px solid var(--gray-light); background-color: #fcfdff; flex-shrink: 0; }
        .interaction-tab { flex: 1; text-align: center; padding: 1rem 1rem; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; border-bottom: 3px solid transparent; font-size: 1rem; position: relative; }
        .interaction-tab:hover { color: var(--primary); background-color: rgba(var(--primary-rgb), 0.04); }
        .interaction-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; background-color: var(--call-panel-bg); }
        .interaction-tab i { margin-right: 0.6rem; }
        .interaction-content-area { flex-grow: 1; overflow: hidden; position: relative; background-color: var(--call-panel-bg); }
        .tab-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; visibility: hidden; opacity: 0; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .tab-content.active { visibility: visible; opacity: 1; transition: opacity 0.3s ease; }

        /* Explanation Tab */
        .explanation-scroll-content { flex-grow: 1; padding: 1.75rem; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--gray-light) transparent; }
        .explanation-scroll-content::-webkit-scrollbar { width: 8px; } .explanation-scroll-content::-webkit-scrollbar-track { background: transparent; } .explanation-scroll-content::-webkit-scrollbar-thumb { background-color: var(--gray-light); border-radius: 4px; border: 2px solid var(--call-panel-bg); }
        #explanation-display { line-height: 1.75; font-size: 0.98rem; }
        #explanation-display .step { margin-bottom: 1.5rem; padding: 1.2rem; border-radius: 10px; background-color: #fdfdff; border: 1px solid #f0f0f5; animation: fadeIn 0.5s ease forwards; }
        #explanation-display .step:last-child { margin-bottom: 0; }
        #explanation-display h3 { color: var(--secondary); margin-top: 0; margin-bottom: 0.8rem; font-size: 1.15rem; padding-bottom: 0.3rem; border-bottom: 1px solid var(--gray-light); }
        #explanation-display code { background-color: rgba(var(--primary-rgb), 0.1); padding: 0.2rem 0.5rem; border-radius: 5px; font-size: 0.92em; color: var(--secondary); border: 1px solid rgba(var(--primary-rgb), 0.15); }
        #explanation-display pre { margin: 1.1rem 0; } #explanation-display pre code { display: block; background-color: #2f3542; color: #e8e8e8; padding: 1.1rem; border-radius: 10px; font-size: 0.9rem; line-height: 1.65; white-space: pre-wrap; word-wrap: break-word; border: 1px solid #414a5c; }
        #explanation-display strong { color: var(--dark); font-weight: 600; } #explanation-display blockquote { border-left: 4px solid var(--primary-light); padding-left: 1.2rem; margin: 1.1rem 0 1.1rem 0.5rem; color: #5a6e8a; font-style: italic; background-color: #f8faff; border-radius: 0 8px 8px 0; }
        #explanation-display ul, #explanation-display ol { margin-left: 1.5rem; margin-bottom: 1rem; padding-left: 1.2rem; } #explanation-display li { margin-bottom: 0.6rem; }
        .explanation-controls { flex-shrink: 0; margin-top: auto; padding: 1.2rem 1.75rem; border-top: 1px solid var(--gray-light); text-align: center; background-color: #f8f9fa; display: flex; justify-content: space-between; gap: 1rem; }
        .explanation-controls .btn { flex: 1; }

        /* Chat Tab */
        #chat-tab-content { display: flex; flex-direction: column; height: 100%; }
        .chat-messages { flex-grow: 1; padding: 1.5rem; overflow-y: auto; scrollbar-color: var(--gray-light) var(--call-panel-bg); }
        .chat-messages::-webkit-scrollbar-track { background: var(--call-panel-bg); } .chat-messages::-webkit-scrollbar-thumb { border-color: var(--call-panel-bg); }
        .chat-input-area { flex-shrink: 0; padding: 1.1rem 1.5rem; background-color: #f8f9fa; border-top: 1px solid var(--gray-light); display: flex; align-items: flex-end; gap: 0.9rem; }
        .chat-message { display: flex; gap: 0.9rem; max-width: 90%; align-items: flex-end; margin-bottom: 1.2rem; animation: fadeIn 0.4s ease forwards; }
        .chat-message.user { margin-left: auto; flex-direction: row-reverse; }
        .message-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1rem; flex-shrink: 0; box-shadow: var(--shadow-sm); border: 2px solid var(--call-panel-bg); }
        .chat-message.user .message-avatar { background: var(--success); color: white; } .chat-message.model .message-avatar { background: var(--primary); color: white; }
        .message-bubble { padding: 1rem 1.35rem; border-radius: 20px; line-height: 1.65; word-wrap: break-word; box-shadow: var(--shadow-md); position: relative; background-color: var(--white); color: var(--text-primary); border: 1px solid #eef2f7; }
        .chat-message.model .message-bubble { border-bottom-left-radius: 6px; }
        .chat-message.user .message-bubble { background: var(--gradient-1); color: white; border: none; border-bottom-right-radius: 6px; }
        .message-bubble code { background-color: rgba(var(--primary-rgb), 0.12); padding: 0.15em 0.4em; border-radius: 5px; font-size: 0.92em; color: var(--secondary); border: 1px solid rgba(var(--primary-rgb), 0.15); }
        .chat-message.user .message-bubble code { background-color: rgba(255, 255, 255, 0.25); color: #fff; border: 1px solid rgba(255, 255, 255, 0.3); }
        .message-bubble pre { margin: 0.6rem 0; } .message-bubble pre code { display: block; background-color: #2f3542; color: #e8e8e8; padding: 0.9rem; border-radius: 8px; font-size: 0.88rem; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; border: 1px solid #414a5c; }
        .chat-message.user .message-bubble pre code { background-color: rgba(0,0,0,0.35); color: #eee; }
        .message-timestamp { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; display: block; text-align: left; opacity: 0.9; }
        .chat-message.user .message-timestamp { text-align: right; }
        .message-thinking-indicator { background: var(--white); display: flex; align-items: center; padding: 1rem 1.35rem; border-radius: 20px; box-shadow: var(--shadow-sm); border: 1px solid #eef2f7; width: fit-content; border-bottom-left-radius: 6px;}
        .typing-dot { width: 8px; height: 8px; background-color: var(--gray); border-radius: 50%; margin: 0 3px; display: inline-block; animation: typing 1.3s infinite ease-in-out; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; } .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.6; } 30% { transform: translateY(-4px); opacity: 1; } }
        .chat-input { flex-grow: 1; padding: 0.9rem 1.2rem; border: 1px solid var(--gray-light); border-radius: 25px; font-size: 1rem; resize: none; max-height: 160px; overflow-y: auto; transition: border-color 0.2s ease, box-shadow 0.2s ease; line-height: 1.5; background-color: var(--white); }
        .chat-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(var(--primary-rgb), 0.1); }
        .send-button { padding: 0 1.5rem; border-radius: 25px; font-weight: 600; font-size: 1rem; cursor: pointer; border: none; background: var(--gradient-1); color: white; transition: all 0.3s ease; flex-shrink: 0; height: 48px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); }
        .send-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(var(--primary-rgb), 0.25); }
        .send-button:active:not(:disabled) { transform: translateY(-1px); box-shadow: 0 3px 8px rgba(var(--primary-rgb), 0.2); }
        .send-button i { font-size: 1.15em; } .send-button .fa-spinner { margin: 0; }
        .chat-controls { flex-shrink: 0; padding: 0.6rem 1.5rem; font-size: 0.85rem; color: var(--text-muted); text-align: right; background-color: #f8f9fa; border-top: 1px solid var(--gray-light); }
        .chat-controls button { background:none; border:none; color: var(--text-muted); cursor:pointer; font-size: 0.95em; padding: 3px 6px; margin-left: 12px; transition: color 0.2s ease; }
        .chat-controls button:hover { color: var(--primary); }

        /* Utility & State Styles */
        .loading-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; text-align: center; font-style: italic; color: var(--text-muted); flex-grow: 1; }
        .loading-placeholder i { margin-bottom: 1rem; font-size: 2.5rem; color: var(--primary-light); }
        .empty-state { text-align: center; padding: 3rem 1.5rem; color: var(--text-secondary); margin-top: 2rem; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .empty-state i { font-size: 4rem; margin-bottom: 1.75rem; color: var(--gray-light); opacity: 0.8; }
        .empty-state h3 { font-size: 1.3rem; font-weight: 600; margin-bottom: 1rem; color: var(--dark); }
        .empty-state p { margin-bottom: 1.75rem; max-width: 500px; margin-left: auto; margin-right: auto; line-height: 1.6; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.6rem; border-radius: 10px; font-weight: 500; font-size: 0.95rem; text-decoration: none; transition: all 0.25s ease; cursor: pointer; border: none; gap: 0.6rem; line-height: 1.5; }
        .btn-primary { background: var(--gradient-1); color: white; box-shadow: var(--shadow-sm); } .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); background: linear-gradient(135deg, var(--primary-light), var(--secondary)); }
        .btn-secondary { background-color: var(--white); color: var(--text-secondary); border: 1px solid var(--gray-light); box-shadow: var(--shadow-sm); } .btn-secondary:hover:not(:disabled) { background-color: #f8f9fa; color: var(--primary); border-color: var(--primary-light); }
        .btn-success { background: linear-gradient(135deg, var(--success), #05a381); color: white; box-shadow: var(--shadow-sm); } .btn-success:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); background: linear-gradient(135deg, #0cd1a7, var(--success));}
        .btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none !important; box-shadow: none !important; background: var(--gray); color: var(--white); border: none; }
        .btn i { font-size: 1.05em; }

        /* Responsiveness & Mobile Menu */
        .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; color: var(--dark); font-size: 1.6rem; margin-right: 1rem; padding: 0.5rem; z-index: 1060; transition: color 0.2s ease; }
        .mobile-menu-toggle:hover { color: var(--primary); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.55); z-index: 1040; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(6px); }
        .sidebar-overlay.active { display: block; opacity: 1; }
        @keyframes fadeIn { 0% { opacity: 0; transform: translateY(8px); } 100% { opacity: 1; transform: translateY(0); } }

        @media (max-width: 1200px) {
            .interaction-panel {
                /* width: 400px; /* Original reduced */
                width: 360px; /* Further reduce for mid-large screens */
            }
            .call-interface { padding: 1.5rem; gap: 1.5rem; }
        }
        @media (max-width: 992px) {
             :root { --sidebar-width: 80px; }
             .sidebar { width: 80px; }
             .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; }
             .sidebar-link i { margin-right: 0; font-size: 1.5rem; }
             .sidebar-logo i { margin-right: 0; }
             .sidebar-header, .sidebar-link { justify-content: center; }
             .user-profile { justify-content: center; padding: 0.75rem 0; }
             .user-avatar { margin-right: 0; }
             main { margin-left: 80px; width: calc(100% - 80px); }
             .call-interface { flex-direction: column; padding: 1.2rem; gap: 1.2rem; }
             .interaction-panel {
                 width: 100%; /* Full width in column layout */
                 height: 48vh; /* Adjust height as needed */
                 order: 2;
                 /* Reset fixed width from larger screens */
             }
             .ai-presenter-area {
                 height: 48vh; /* Adjust height as needed */
                 order: 1;
             }
        }
        @media (max-width: 768px) { .main-header { padding: 0.9rem 1.2rem; } .header-content h1 { font-size: 1.4rem; } .interaction-panel { height: 50vh; } .ai-presenter-area { height: 45vh; } .interaction-tab { padding: 0.85rem 0.5rem; font-size: 0.95rem; } .chat-input { font-size: 0.95rem; padding: 0.8rem 1.1rem; } .send-button { height: 44px; padding: 0 1.2rem; } .btn { padding: 0.7rem 1.4rem; font-size: 0.9rem; } }
        @media (max-width: 576px) { :root { --sidebar-width: 0; } .sidebar { transform: translateX(-100%); z-index: 1050; width: 260px; } .sidebar.active { transform: translateX(0); } .sidebar.active .sidebar-logo span, .sidebar.active .sidebar-link span, .sidebar.active .user-info, .sidebar.active .sidebar-footer { display: block; } .sidebar.active .sidebar-link i { margin-right: 0.75rem; } .sidebar.active .sidebar-header, .sidebar.active .sidebar-link { justify-content: flex-start; } .sidebar.active .user-profile { justify-content: flex-start; padding: 1rem; } .sidebar.active .user-avatar { margin-right: 0.75rem; } main { margin-left: 0; width: 100%; } .mobile-menu-toggle { display: block; } .main-header { padding: 0.8rem 1rem; } .header-content h1 { font-size: 1.25rem; } .call-interface { padding: 1rem; gap: 1rem; } .interaction-panel { height: 55vh; } .ai-presenter-area { height: 40vh; } .message-bubble { padding: 0.8rem 1.1rem; } .chat-input { padding: 0.7rem 1rem; } .send-button { height: 42px; padding: 0 1rem; } }
        @media (prefers-color-scheme: dark) {
             /* Dark mode styles (без изменений) */
             :root { --white: #1a202c; --light: #2d3748; --dark: #e2e8f0; --gray-light: #4a5568; --text-primary: #e2e8f0; --text-secondary: #cbd5e0; --text-muted: #a0aec0; --dark-bg: #171923; --call-bg: #131720; --call-panel-bg: #1e2533; }
             body { background-color: var(--dark-bg); }
             main { background-color: var(--call-bg); }
             .main-header { background-color: var(--call-panel-bg); border-bottom-color: var(--gray-light); }
             .mobile-menu-toggle { color: var(--dark); }
             .ai-presenter-area, .interaction-panel { background-color: var(--call-panel-bg); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); border-color: var(--gray-light); }
             .ai-presenter-header { background-color: #242c3b; border-bottom-color: var(--gray-light); }
             .whiteboard-main-container { background-color: #1a202c; }
             #drawingCanvas { background-color: #283044; border-color: #4a5568; }
             .canvas-controls { background-color: rgba(45, 55, 72, 0.85); border-color: var(--gray-light); }
             .canvas-controls button { background-color: var(--light); border-color: var(--gray-light); color: var(--text-secondary); }
             .canvas-controls button:hover { background-color: #4a5568; color: var(--white); }
             .interaction-tabs { background-color: #242c3b; border-bottom-color: var(--gray-light); }
             .interaction-tab { color: var(--text-secondary); } .interaction-tab:hover { color: var(--primary-light); background-color: rgba(72, 149, 239, 0.1); } .interaction-tab.active { color: var(--primary-light); border-bottom-color: var(--primary-light); background-color: var(--call-panel-bg); }
             .tab-content { background-color: var(--call-panel-bg); }
             .explanation-scroll-content { scrollbar-color: var(--gray) var(--call-panel-bg); } .explanation-scroll-content::-webkit-scrollbar-thumb { border-color: var(--call-panel-bg); }
             #explanation-display .step { background-color: #232a37; border-color: #3b4458; }
             #explanation-display pre code { background-color: #161a22; color: #d1d5db; border-color: #363d4b; }
             #explanation-display code { background-color: rgba(72, 149, 239, 0.2); color: var(--primary-light); border-color: rgba(72, 149, 239, 0.3); }
             #explanation-display strong { color: #f0f2f5; }
             #explanation-display blockquote { border-left-color: var(--primary); color: #a0b3d0; background-color: #242c3b; }
             .explanation-controls { background-color: #242c3b; border-top-color: var(--gray-light); }
             .chat-messages { scrollbar-color: var(--gray) var(--call-panel-bg); } .chat-messages::-webkit-scrollbar-track { background: var(--call-panel-bg); } .chat-messages::-webkit-scrollbar-thumb { border-color: var(--call-panel-bg); }
             .message-avatar { border-color: var(--call-panel-bg); }
             .message-bubble { background-color: var(--light); color: var(--text-primary); border-color: #3b4458; }
             .chat-message.user .message-bubble { background: var(--gradient-2); color: #1a202c; }
             .message-bubble code { background-color: rgba(255,255,255,0.1); color: var(--text-primary); border-color: rgba(255,255,255,0.15); }
             .chat-message.user .message-bubble code { background-color: rgba(0, 0, 0, 0.2); color: #2d3748; border-color: rgba(0,0,0,0.25); }
             .message-bubble pre code { background-color: #161a22; color: #d1d5db; border-color: #363d4b; }
             .chat-message.user .message-bubble pre code { background-color: rgba(0,0,0,0.3); color: #eee; }
             .message-thinking-indicator { background: var(--light); border-color: #3b4458;} .typing-dot { background-color: #8494a6; }
             .chat-input-area { background-color: #242c3b; border-top-color: var(--gray-light); }
             .chat-input { background-color: var(--dark-bg); color: var(--text-primary); border-color: var(--gray-light); }
             .chat-input::placeholder { color: var(--text-muted); }
             .chat-input:focus { box-shadow: 0 0 0 4px rgba(var(--primary-rgb), 0.25); }
             .chat-controls { background-color: #242c3b; border-top-color: var(--gray-light); } .chat-controls button { color: var(--text-muted); } .chat-controls button:hover { color: var(--primary-light); }
             .btn-secondary { background-color: var(--light); color: var(--text-secondary); border-color: var(--gray-light); } .btn-secondary:hover:not(:disabled) { background-color: #4a5568; color: var(--white); border-color: #6c757d; }
             .btn-success { background: linear-gradient(135deg, var(--success), #05a381); } .btn-success:hover:not(:disabled) { background: linear-gradient(135deg, #0cd1a7, var(--success));}
             .btn:disabled { background: #4a5568; color: #a0aec0; }
             .topic-loading-bar { background-color: var(--light); border-bottom-color: var(--gray-light); }
             .empty-state i { color: #4a5568; }
             .toast { background-color: var(--call-panel-bg); border-color: var(--gray-light); color: var(--text-primary); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);}
        }
        .toast { position: fixed; bottom: 20px; right: 20px; background-color: var(--white); color: var(--text-primary); border-radius: 10px; padding: 1.1rem 1.3rem; box-shadow: var(--shadow-lg); max-width: 350px; z-index: 1001; display: flex; align-items: center; transform: translateY(150px); opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); } .toast.show { transform: translateY(0); opacity: 1; } .toast.success { border-left: 5px solid var(--success); } .toast.error { border-left: 5px solid var(--danger); } .toast.warning { border-left: 5px solid var(--warning); } .toast.info { border-left: 5px solid var(--info); } .toast i { margin-right: 1rem; font-size: 1.4rem; } .toast.success i { color: var(--success); } .toast.error i { color: var(--danger); } .toast.warning i { color: var(--warning); } .toast.info i { color: var(--info); }
    </style>
</head>
<body>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
     <aside id="sidebar" class="sidebar">
         <div class="sidebar-header"> <a href="/" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
          <ul class="sidebar-menu"> <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Dashboard</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li> </ul>
          <div class="user-profile"> <div class="user-avatar" id="user-avatar">?</div> <div class="user-info"> <div class="user-name" id="user-name">Načítání...</div> <div class="user-role">Student</div> </div> </div>
          <div class="sidebar-footer"> &copy; 2025 Justax </div>
     </aside>

    <main>
        <div class="main-header">
             <div class="header-content">
                 <div style="display: flex; align-items: center; gap: 1rem;">
                      <button class="mobile-menu-toggle" id="mobile-menu-toggle"> <i class="fas fa-bars"></i> </button>
                      <h1>Interaktivní výuka</h1>
                 </div>
                 <div class="header-actions">
                      <a href="/dashboard/procvicovani/main.html" class="btn btn-secondary"> <i class="fas fa-times"></i> Ukončit výuku </a>
                 </div>
             </div>
        </div>
        <div class="topic-loading-bar">
             <div id="current-topic-display"><span class="placeholder">Načítám data...</span></div>
        </div>
        <div class="call-interface" style="display: none;">
             <div class="ai-presenter-area">
                 <div class="ai-presenter-header">
                     <div class="ai-avatar-placeholder"> <i class="fas fa-robot"></i> </div>
                     <div class="ai-presenter-info">
                         <h2>AI Tutor Justax</h2>
                         <p id="ai-status-text">Čekání na téma...</p>
                     </div>
                 </div>
                 <div class="whiteboard-main-container">
                     <canvas id="drawingCanvas"></canvas>
                     <div class="canvas-controls" style="display: none;" id="canvas-controls">
                          <button id="clear-canvas-btn" class="btn btn-secondary btn-sm btn-tooltip" title="Vymazat kresbu"> <i class="fas fa-eraser"></i> </button>
                     </div>
                 </div>
             </div>
             <div class="interaction-panel">
                 <div class="interaction-tabs">
                     <div class="interaction-tab active" data-tab="explanation-tab"> <i class="fas fa-chalkboard-teacher"></i> Vysvětlení </div>
                     <div class="interaction-tab" data-tab="chat-tab"> <i class="fas fa-comments"></i> Chat </div>
                 </div>
                 <div class="interaction-content-area">
                     <div id="explanation-tab-content" class="tab-content active">
                         <div class="explanation-scroll-content">
                             <div id="explanation-display"><div class="empty-state"> <i class="fas fa-book-reader"></i> <h3>Výuka připravena</h3> <p>Počkejte na automatické načtení tématu.</p> </div></div>
                         </div>
                         <div class="explanation-controls">
                             <button class="btn btn-primary btn-tooltip" id="next-step-btn" style="display: none;" title="Požádat AI o další krok"> <i class="fas fa-forward"></i> Další krok </button>
                             <button class="btn btn-success btn-tooltip" id="mark-complete-btn" style="display: none;" title="Označit téma jako dokončené"> <i class="fas fa-check-circle"></i> Téma dokončeno </button>
                         </div>
                     </div>
                     <div id="chat-tab-content" class="tab-content">
                         <section class="chat-area" style="display: flex; flex-direction: column; height: 100%;">
                             <div class="chat-messages" id="chat-messages"></div>
                             <div class="chat-input-area">
                                 <textarea class="chat-input" id="chat-input" placeholder="Napiš svou otázku..." rows="1"></textarea>
                                 <button class="send-button" id="send-button" title="Odeslat zprávu"> <i class="fas fa-paper-plane"></i> </button>
                             </div>
                             <div class="chat-controls">
                                 <button id="clear-chat-btn" class="btn-tooltip" title="Vymazat historii tohoto chatu"> <i class="fas fa-trash-alt"></i> Vymazat chat </button> |
                                 <button id="save-chat-btn" class="btn-tooltip" title="Uložit chat jako PDF"> <i class="fas fa-save"></i> Uložit PDF </button>
                             </div>
                         </section>
                     </div>
                 </div>
             </div>
        </div>
    </main>
    <div class="toast" id="toast"> <i class="fas fa-info-circle"></i> <div id="toast-message">Operace úspěšná.</div> </div>

    <script>
        try {
            // --- Constants & Config ---
            const SUPABASE_URL = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
            const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // Test key
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            // Regex for the NEW command format: PŘÍKAZ: ```json { "type": "CMD", "data": {...} } ```
            const CANVAS_COMMAND_BLOCK_REGEX = /PŘÍKAZ:\s*```json\s*(\{[\s\S]*?\})\s*```\s*/g;


            // --- DOM Elements Cache ---
            const uiElements = { /* ... (cache elements as before) ... */
                userAvatar: document.getElementById('user-avatar'),
                userName: document.getElementById('user-name'),
                mobileMenuToggle: document.getElementById('mobile-menu-toggle'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                currentTopicDisplay: document.getElementById('current-topic-display'),
                explanationDisplay: document.getElementById('explanation-display'),
                explanationScrollContent: document.querySelector('.explanation-scroll-content'),
                canvasContainer: document.querySelector('.whiteboard-main-container'),
                canvas: document.getElementById('drawingCanvas'),
                canvasControls: document.getElementById('canvas-controls'),
                clearCanvasBtn: document.getElementById('clear-canvas-btn'),
                chatMessages: document.getElementById('chat-messages'),
                chatInput: document.getElementById('chat-input'),
                sendButton: document.getElementById('send-button'),
                saveChatBtn: document.getElementById('save-chat-btn'),
                clearChatBtn: document.getElementById('clear-chat-btn'),
                nextStepBtn: document.getElementById('next-step-btn'),
                markCompleteBtn: document.getElementById('mark-complete-btn'),
                toast: document.getElementById('toast'),
                toastMessage: document.getElementById('toast-message'),
                interactionTabs: document.querySelectorAll('.interaction-tab'),
                tabContents: document.querySelectorAll('.tab-content'),
                aiStatusText: document.getElementById('ai-status-text'),
                callInterface: document.querySelector('.call-interface')
            };

            // --- Global State ---
            let state = { /* ... (state variables as before) ... */
                supabase: null,
                currentUser: null,
                currentProfile: null,
                currentTopic: null, // Stores { activity_id, plan_id, name, description, user_id, topic_id }
                currentPlanId: null,
                currentSessionId: null,
                geminiChatContext: [],
                canvasCtx: null,
                geminiIsThinking: false,
                thinkingIndicatorId: null,
                topicLoadInProgress: false,
                canvasWidth: 600,
                canvasHeight: 400,
                lastExplanationTimestamp: 0,
                isCanvasInitialized: false
            };

            // --- Utility Functions ---
            const sanitizeHTML = (str) => { const temp = document.createElement('div'); temp.textContent = str || ''; return temp.innerHTML; };
            const getInitials = (profile, email) => { if (!profile && !email) return '?'; let initials = ''; if (profile?.first_name) initials += profile.first_name[0]; if (profile?.last_name) initials += profile.last_name[0]; if (initials) return initials.toUpperCase(); if (profile?.username) return profile.username[0].toUpperCase(); if (email) return email[0].toUpperCase(); return 'U'; };
            const showToast = (message, type = 'info', duration = 4000) => { if (!uiElements.toast || !uiElements.toastMessage) return; console.log(`Toast (${type}): ${message}`); uiElements.toastMessage.textContent = message; const icon = uiElements.toast.querySelector('i'); uiElements.toast.className = 'toast ' + type; icon.className = `fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}`; uiElements.toast.classList.add('show'); setTimeout(() => uiElements.toast.classList.remove('show'), duration); };
            const renderMarkdown = (element, markdownText) => { if (!element) return; try { element.innerHTML = marked.parse(markdownText || ''); if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') { setTimeout(() => { console.log("MathJax: Queuing typeset for element:", element); window.MathJax.typesetPromise([element]).then(() => console.log("MathJax: Typesetting complete for:", element)).catch(err => console.error('MathJax typesetting error:', err)); }, 50); } } catch (e) { console.error("Markdown rendering error:", e); element.innerHTML = `<p style="color:red;">Chyba.</p><pre>${sanitizeHTML(markdownText)}</pre>`; } };
            const autoResizeTextarea = () => { if (!uiElements.chatInput) return; uiElements.chatInput.style.height = 'auto'; const scrollHeight = uiElements.chatInput.scrollHeight; const maxHeight = 150; uiElements.chatInput.style.height = `${Math.min(scrollHeight, maxHeight)}px`; uiElements.chatInput.style.overflowY = scrollHeight > maxHeight ? 'scroll' : 'hidden'; };
            const generateSessionId = () => `session_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
            const formatTimestamp = (date = new Date()) => date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
            const updateAIStatus = (text) => { if (uiElements.aiStatusText) uiElements.aiStatusText.textContent = text; };

            // --- Initialization Functions ---
            const initializeSupabase = () => { console.log("Initializing Supabase..."); try { state.supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); if (!state.supabase) throw new Error("Supabase client creation failed."); console.log("Supabase client initialized."); return true; } catch (error) { console.error("Supabase initialization failed:", error); showToast("Chyba připojení k databázi.", "error", 10000); return false; } };
            const initializeUI = () => { console.log("Initializing UI elements and Canvas..."); if (!initializeCanvas()) { showToast("Chyba inicializace kreslící plochy!", "error", 10000); if(uiElements.callInterface) uiElements.callInterface.style.display = 'none'; if(uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder" style="color:var(--danger);">Chyba kreslící plochy</span>'; state.isCanvasInitialized = false; return false; } state.isCanvasInitialized = true; setupEventListeners(); initTooltips(); manageUIState('initial'); manageButtonStates(); return true; };
            const initializeApp = async () => { console.log("DOM Loaded. Initializing Justax AI Tutor..."); if (!initializeSupabase()) return; if (!initializeUI()) return; console.log("Loading user profile..."); await loadUserProfile(); if (state.currentUser) { console.log("User logged in, loading topic..."); await loadNextUncompletedTopic(); } else { handleLoggedOutUser(); } };

            // --- UI State Management ---
            const manageUIState = (mode) => { /* ... (function as before) ... */
                console.log("Managing UI State:", mode);
                 const showCallInterface = mode === 'learning' || mode === 'requestingExplanation' || mode === 'loadingTopic';
                 if (uiElements.callInterface) uiElements.callInterface.style.display = showCallInterface ? 'flex' : 'none';
                 if (mode === 'initial' || mode === 'loggedOut' || mode === 'noPlan' || mode === 'planComplete' || mode === 'error') {
                     let message = "<div class='empty-state'><i class='fas fa-book-reader'></i><h3>Výuka připravena</h3><p>Čekám na data...</p></div>";
                     if(mode === 'loggedOut') message = "<div class='empty-state'><i class='fas fa-sign-in-alt'></i><h3>Nejste přihlášeni</h3><p>Přihlaste se prosím pro zahájení výuky.</p></div>";
                     if(mode === 'noPlan') message = "<div class='empty-state'><i class='fas fa-calendar-times'></i><h3>Žádný plán</h3><p>Nemáte aktivní studijní plán.</p></div>";
                     if(mode === 'planComplete') message = "<div class='empty-state'><i class='fas fa-check-circle'></i><h3>Plán dokončen</h3><p>Gratulujeme, všechna témata jsou hotová!</p></div>";
                     if(mode === 'error') message = "<div class='empty-state'><i class='fas fa-exclamation-triangle'></i><h3>Chyba</h3><p>Při načítání dat došlo k chybě.</p></div>";
                     if(uiElements.explanationDisplay) uiElements.explanationDisplay.innerHTML = message;
                 } else if (mode === 'loadingTopic') {
                     if(uiElements.explanationDisplay) uiElements.explanationDisplay.innerHTML = "<div class='loading-placeholder'><i class='fas fa-spinner fa-spin'></i><p>Načítám téma...</p></div>";
                 } else if (mode === 'requestingExplanation') {
                     if(uiElements.explanationDisplay && (!uiElements.explanationDisplay.hasChildNodes() || uiElements.explanationDisplay.querySelector('.empty-state, .loading-placeholder'))) {
                         uiElements.explanationDisplay.innerHTML = "<div class='loading-placeholder'><i class='fas fa-spinner fa-spin'></i><p>Požaduji úvodní vysvětlení...</p></div>";
                     }
                 }
            };
            const manageButtonStates = () => { /* ... (function as before) ... */
                const enableSend = !state.geminiIsThinking && !!state.currentTopic;
                 const enableNext = !state.geminiIsThinking && !!state.currentTopic;
                 const enableComplete = !state.geminiIsThinking && !!state.currentTopic;

                 if (uiElements.sendButton) uiElements.sendButton.disabled = !enableSend;
                 if (uiElements.sendButton) uiElements.sendButton.innerHTML = state.geminiIsThinking ? '<i class="fas fa-spinner fa-spin"></i>' : '<i class="fas fa-paper-plane"></i>';
                 if (uiElements.nextStepBtn) uiElements.nextStepBtn.disabled = !enableNext;
                 if (uiElements.nextStepBtn) uiElements.nextStepBtn.style.display = state.currentTopic ? 'inline-flex' : 'none';
                 if (uiElements.markCompleteBtn) uiElements.markCompleteBtn.disabled = !enableComplete;
                 if (uiElements.markCompleteBtn) uiElements.markCompleteBtn.style.display = state.currentTopic ? 'inline-flex' : 'none';
            };

            // --- Canvas Functions ---
            const initializeCanvas = () => { /* ... (function as before) ... */ if (!uiElements.canvas) { console.error("Canvas element not found!"); return false; } try { state.canvasCtx = uiElements.canvas.getContext('2d', { willReadFrequently: false }); if (!state.canvasCtx) throw new Error("Failed to get 2D context"); resizeCanvas(); clearCanvas(); console.log("Canvas initialized successfully."); if (uiElements.canvasControls) uiElements.canvasControls.style.display = 'flex'; return true; } catch (e) { console.error("Canvas initialization failed:", e); if (uiElements.canvasContainer) uiElements.canvasContainer.innerHTML = "<p style='color:red; padding:1rem;'>Chyba: Nelze inicializovat kreslící plochu.</p>"; return false; } };
            const resizeCanvas = () => { /* ... (function as before) ... */ if (!uiElements.canvas || !uiElements.canvasContainer || !state.canvasCtx) return; const containerStyle = window.getComputedStyle(uiElements.canvasContainer); const containerWidth = uiElements.canvasContainer.clientWidth - parseFloat(containerStyle.paddingLeft) - parseFloat(containerStyle.paddingRight); const containerHeight = uiElements.canvasContainer.clientHeight - parseFloat(containerStyle.paddingTop) - parseFloat(containerStyle.paddingBottom); const maxWidth = 1200; const maxHeight = 800; state.canvasWidth = Math.max(100, Math.min(containerWidth, maxWidth)); state.canvasHeight = Math.max(100, Math.min(containerHeight, maxHeight)); if (uiElements.canvas.width !== state.canvasWidth || uiElements.canvas.height !== state.canvasHeight) { uiElements.canvas.width = state.canvasWidth; uiElements.canvas.height = state.canvasHeight; uiElements.canvas.style.width = `${state.canvasWidth}px`; uiElements.canvas.style.height = `${state.canvasHeight}px`; clearCanvas(); console.log(`Canvas resized to: ${state.canvasWidth}x${state.canvasHeight}. Content cleared.`); } };
            const clearCanvas = () => { /* ... (function as before) ... */ if (!state.canvasCtx) return; state.canvasCtx.clearRect(0, 0, uiElements.canvas.width, uiElements.canvas.height); console.log("Canvas cleared."); };
            const handleCanvasDrawCommand = (command, data) => { /* ... (function as before) ... */ if (!state.canvasCtx) { console.error("Canvas context not available for drawing."); return; } console.log(`Executing Canvas Command: ${command}`, data); state.canvasCtx.save(); try { state.canvasCtx.strokeStyle = data.color || '#000000'; state.canvasCtx.fillStyle = data.fillColor || data.color || '#000000'; state.canvasCtx.lineWidth = typeof data.lineWidth === 'number' && data.lineWidth > 0 ? data.lineWidth : 1; state.canvasCtx.font = data.font || '16px Poppins'; state.canvasCtx.textAlign = data.textAlign || 'left'; state.canvasCtx.textBaseline = data.textBaseline || 'alphabetic'; if (data.lineDash && Array.isArray(data.lineDash)) { state.canvasCtx.setLineDash(data.lineDash); } else { state.canvasCtx.setLineDash([]); } switch (command) { case 'CLEAR_CANVAS': clearCanvas(); break; case 'DRAW_LINE': if (data.x1 != null && data.y1 != null && data.x2 != null && data.y2 != null) { state.canvasCtx.beginPath(); state.canvasCtx.moveTo(data.x1, data.y1); state.canvasCtx.lineTo(data.x2, data.y2); state.canvasCtx.stroke(); } else console.warn("DRAW_LINE: Missing coordinates", data); break; case 'DRAW_RECT': if (data.x != null && data.y != null && data.width != null && data.height != null) { if (data.filled === true) { state.canvasCtx.fillRect(data.x, data.y, data.width, data.height); } else { state.canvasCtx.strokeRect(data.x, data.y, data.width, data.height); } } else console.warn("DRAW_RECT: Missing properties", data); break; case 'DRAW_CIRCLE': if (data.x != null && data.y != null && data.radius != null && data.radius > 0) { state.canvasCtx.beginPath(); state.canvasCtx.arc(data.x, data.y, data.radius, 0, Math.PI * 2); if (data.filled === true) { state.canvasCtx.fill(); } else { state.canvasCtx.stroke(); } } else console.warn("DRAW_CIRCLE: Missing or invalid properties", data); break; case 'DRAW_TEXT': if (data.text != null && data.x != null && data.y != null) { state.canvasCtx.fillStyle = data.color || '#000000'; const lines = String(data.text).split('\\n'); const fontSizeMatch = state.canvasCtx.font.match(/(\d+)(px|pt|em|rem)/); const fontSize = fontSizeMatch ? parseFloat(fontSizeMatch[1]) : 16; const lineHeight = fontSize * 1.2 || 20; lines.forEach((line, index) => { state.canvasCtx.fillText(line, data.x, data.y + (index * lineHeight)); }); } else console.warn("DRAW_TEXT: Missing properties", data); break; default: console.warn("Unknown canvas command:", command); } } catch (e) { console.error(`Error executing canvas command ${command}:`, e, data); } finally { state.canvasCtx.restore(); } };

            // --- User Profile & Auth ---
            const loadUserProfile = async () => { /* ... (function as before) ... */ if (!state.supabase) return; try { const { data: { user }, error: userError } = await state.supabase.auth.getUser(); if (userError) throw userError; if (user) { state.currentUser = user; const { data: profile, error: profileError } = await state.supabase.from('profiles').select('*').eq('id', user.id).single(); if (profileError && profileError.code !== 'PGRST116') throw profileError; state.currentProfile = profile; console.log("User profile loaded:", state.currentProfile); } else { state.currentUser = null; state.currentProfile = null; console.log("No user logged in."); } } catch (error) { console.error('Error loading user profile:', error); state.currentUser = null; state.currentProfile = null; showToast("Nepodařilo se načíst profil.", "error"); } finally { updateUserInfoUI(); } };
            const updateUserInfoUI = () => { /* ... (function as before) ... */ if (uiElements.userName && uiElements.userAvatar) { if (state.currentProfile || state.currentUser) { const email = state.currentUser?.email; const initials = getInitials(state.currentProfile, email); const displayName = `${state.currentProfile?.first_name || ''} ${state.currentProfile?.last_name || ''}`.trim() || state.currentProfile?.username || email?.split('@')[0] || 'Uživatel'; uiElements.userName.textContent = displayName; if (state.currentProfile?.avatar_url) { uiElements.userAvatar.innerHTML = `<img src="${state.currentProfile.avatar_url}" alt="${initials}">`; } else { uiElements.userAvatar.innerHTML = ''; uiElements.userAvatar.textContent = initials; } } else { uiElements.userName.textContent = 'Nepřihlášen'; uiElements.userAvatar.innerHTML = '?'; } } };
            const handleLoggedOutUser = () => { /* ... (function as before) ... */ console.warn("User not logged in."); updateAIStatus("Přihlaste se pro zahájení výuky."); if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder">Nejste přihlášeni</span>'; showToast("Prosím, přihlaste se.", "warning"); manageUIState('loggedOut'); manageButtonStates(); };

             // --- Event Listeners Setup ---
            const setupEventListeners = () => { /* ... (function as before) ... */
                console.log("Setting up event listeners...");
                if (uiElements.mobileMenuToggle && uiElements.sidebar && uiElements.sidebarOverlay) { uiElements.mobileMenuToggle.addEventListener('click', (e) => { e.stopPropagation(); uiElements.sidebar.classList.toggle('active'); uiElements.sidebarOverlay.classList.toggle('active'); }); uiElements.sidebarOverlay.addEventListener('click', () => { uiElements.sidebar.classList.remove('active'); uiElements.sidebarOverlay.classList.remove('active'); }); document.querySelector('main')?.addEventListener('click', () => { if (uiElements.sidebar?.classList.contains('active')) { uiElements.sidebar.classList.remove('active'); uiElements.sidebarOverlay.classList.remove('active'); } }); } else { console.warn("Mobile menu elements not found."); }
                if (uiElements.interactionTabs.length > 0 && uiElements.tabContents.length > 0) { uiElements.interactionTabs.forEach(tab => { tab.addEventListener('click', () => switchInteractionTab(tab.dataset.tab)); }); } else { console.warn("Interaction tab elements not found."); }
                if (uiElements.chatInput && uiElements.sendButton) { uiElements.chatInput.addEventListener('input', autoResizeTextarea); uiElements.chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if (!state.geminiIsThinking) handleSendMessage(); } }); uiElements.sendButton.addEventListener('click', () => { if (!state.geminiIsThinking) handleSendMessage(); }); } else { console.warn("Chat input/send elements not found."); }
                if (uiElements.clearChatBtn) uiElements.clearChatBtn.addEventListener('click', confirmClearChat);
                if (uiElements.saveChatBtn) uiElements.saveChatBtn.addEventListener('click', saveChatToPDF);
                if (uiElements.nextStepBtn) uiElements.nextStepBtn.addEventListener('click', requestNextStep);
                if (uiElements.markCompleteBtn) uiElements.markCompleteBtn.addEventListener('click', handleMarkTopicComplete);
                if (uiElements.clearCanvasBtn) { uiElements.clearCanvasBtn.addEventListener('click', () => { clearCanvas(); showToast("Kresba vymazána.", "info"); }); }
                window.addEventListener('resize', () => { if (window.innerWidth > 992 && uiElements.sidebar?.classList.contains('active')) { uiElements.sidebar.classList.remove('active'); uiElements.sidebarOverlay.classList.remove('active'); } resizeCanvas(); });
            };
            const initTooltips = () => { /* ... (function as before) ... */ try { if (window.jQuery && window.jQuery.fn.tooltipster) { window.jQuery('.btn-tooltip:not(.tooltipstered)').tooltipster({ theme: 'tooltipster-shadow', animation: 'fade', delay: 100, side: 'top' }); } else { console.warn("jQuery or Tooltipster not fully loaded for initTooltips."); } } catch (e) { console.error("Tooltipster initialization error:", e); } };

            // --- Topic Loading and Progress ---
            const loadNextUncompletedTopic = async () => { /* ... (function as before) ... */
                 if (!state.currentUser || state.topicLoadInProgress || !state.supabase) { console.log("Skipping topic load:", { loggedIn: !!state.currentUser, loading: state.topicLoadInProgress }); return; }
                state.topicLoadInProgress = true;
                if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder"><i class="fas fa-spinner fa-spin"></i> Hledám další téma...</span>';
                updateAIStatus('Hledám téma...');
                manageUIState('loadingTopic');
                manageButtonStates();

                try {
                    const { data: activePlans, error: planError } = await state.supabase.from('study_plans').select('id').eq('user_id', state.currentUser.id).eq('status', 'active').order('created_at', { ascending: false }).limit(1);
                    if (planError) throw planError;

                    if (!activePlans || activePlans.length === 0) { console.log("No active study plan found."); if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder">Žádný aktivní studijní plán</span>'; showToast("Nemáte aktivní studijní plán.", "warning"); updateAIStatus("Nemáte aktivní plán."); manageUIState('noPlan'); state.topicLoadInProgress = false; return; }
                    state.currentPlanId = activePlans[0].id;
                    console.log("Active plan ID:", state.currentPlanId);

                    const { data: nextActivities, error: activityError } = await state.supabase.from('plan_activities').select('id, title, description, day_of_week, time_slot, topic_id, completed').eq('plan_id', state.currentPlanId).eq('completed', false).order('day_of_week', { ascending: true }).order('time_slot', { ascending: true }).limit(1);
                    if (activityError) throw activityError;

                    if (nextActivities && nextActivities.length > 0) {
                        const nextActivity = nextActivities[0];
                        console.log("Next activity found:", nextActivity);
                        let topicName = nextActivity.title || 'Nespecifikované téma';
                        let topicDescription = nextActivity.description || '';

                        if (nextActivity.topic_id) {
                            const { data: topicData, error: topicError } = await state.supabase.from('exam_topics').select('name, description').eq('id', nextActivity.topic_id).single();
                            if (topicError && topicError.code !== 'PGRST116') { console.warn(`Could not fetch topic details for ID ${nextActivity.topic_id}:`, topicError); }
                            if (topicData) { topicName = topicData.name || topicName; topicDescription = topicData.description || topicDescription; }
                        }

                        state.currentTopic = { activity_id: nextActivity.id, plan_id: state.currentPlanId, name: topicName, description: topicDescription, user_id: state.currentUser.id, topic_id: nextActivity.topic_id };
                        console.log("Current topic set:", state.currentTopic);
                        if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = `Aktuální téma: <strong>${sanitizeHTML(state.currentTopic.name)}</strong>`;
                        await startLearningSession();

                    } else { console.log("All activities completed."); if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder">Gratulujeme, plán dokončen!</span>'; showToast("Všechna témata v plánu jsou dokončena!", "success"); updateAIStatus("Plán dokončen."); manageUIState('planComplete'); }
                } catch (error) { console.error('Error loading next topic:', error); if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder" style="color:var(--danger);">Chyba</span>'; showToast(`Nepodařilo se načíst téma: ${error.message}`, "error"); updateAIStatus("Chyba načítání."); manageUIState('error');
                } finally { state.topicLoadInProgress = false; manageButtonStates(); }
            };
            const handleMarkTopicComplete = async () => { /* ... (function as before) ... */
                 if (!state.currentTopic || !state.currentTopic.activity_id || !state.supabase || state.topicLoadInProgress) return;
                console.log(`Marking activity ${state.currentTopic.activity_id} as complete.`);
                state.topicLoadInProgress = true;
                manageButtonStates();
                if(uiElements.markCompleteBtn) uiElements.markCompleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ukládám...';

                try {
                    const { error } = await state.supabase.from('plan_activities').update({ completed: true, updated_at: new Date().toISOString() }).eq('id', state.currentTopic.activity_id);
                    if (error) throw error;
                    showToast(`Téma "${state.currentTopic.name}" dokončeno.`, "success");
                    state.currentTopic = null;
                    if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder">Načítám další...</span>';
                    if (uiElements.explanationDisplay) uiElements.explanationDisplay.innerHTML = '';
                    if (uiElements.chatMessages) uiElements.chatMessages.innerHTML = '';
                    clearCanvas();
                    state.geminiChatContext = [];
                    state.lastExplanationTimestamp = 0;
                    await loadNextUncompletedTopic();
                } catch (error) {
                    console.error(`Error marking activity ${state.currentTopic?.activity_id} complete:`, error);
                    showToast("Chyba při označování tématu.", "error");
                    state.topicLoadInProgress = false;
                    manageButtonStates();
                } finally {
                    if(uiElements.markCompleteBtn) uiElements.markCompleteBtn.innerHTML = '<i class="fas fa-check-circle"></i> Téma dokončeno';
                }
            };

            // --- Learning Session Management ---
            const startLearningSession = async () => { /* ... (function as before) ... */
                 if (!state.currentTopic || !state.currentUser || !state.supabase || !state.isCanvasInitialized) { console.error("Cannot start session:", { topic: !!state.currentTopic, user: !!state.currentUser, supabase: !!state.supabase, canvas: state.isCanvasInitialized }); updateAIStatus('Chyba: Nelze zahájit výuku.'); manageUIState('error'); return; }
                console.log(`Starting session for: "${state.currentTopic.name}" (Activity ID: ${state.currentTopic.activity_id})`);
                state.currentSessionId = generateSessionId();
                updateAIStatus(`Vysvětluje: ${state.currentTopic.name}`);
                manageUIState('requestingExplanation');
                manageButtonStates();
                if (uiElements.chatMessages) uiElements.chatMessages.innerHTML = '';
                state.geminiChatContext = [];
                state.lastExplanationTimestamp = 0;
                clearCanvas();
                updateGeminiThinkingState(true);
                let initialPrompt = `Jako AI Tutor "Justax" začni vysvětlovat ZÁKLADY tématu "${state.currentTopic.name}" pro studenta 9. třídy ZŠ (přijímačky CERMAT).`;
                if (state.currentTopic.description) { initialPrompt += ` Popis tématu pro kontext: "${state.currentTopic.description}".`; }
                initialPrompt += ` Buď podrobný, přátelský a postupuj krok za krokem. Toto je ÚPLNĚ PRVNÍ krok vysvětlení tohoto tématu. Vhodně použij příklad nebo výzvu k použití KRESLÍCÍ PLOCHY (použij příkazy pro kreslení ve formátu \`PŘÍKAZ: \`\`\`json { "type": "NAZEV_PRIKAZU", "data": { ... } } \`\`\`\`). Ukonči odpověď krátkým shrnutím pro chat ve formátu: \`CHAT_SUMMARY: [Zde tvůj krátký souhrn první části]\`.`;
                await sendToGemini(initialPrompt, 'explanation');
            };
            const switchInteractionTab = (tabId) => { /* ... (function as before) ... */ uiElements.interactionTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabId)); uiElements.tabContents.forEach(content => content.classList.toggle('active', content.id === `${tabId}-content`)); console.log(`Switched to tab: ${tabId}`); };
            const requestNextStep = async () => { /* ... (function as before) ... */ if (state.geminiIsThinking || !state.currentTopic) return; console.log("Requesting next step..."); updateGeminiThinkingState(true); manageButtonStates(); const prompt = `Pokračuj ve vysvětlování tématu "${state.currentTopic.name}". Naváž na předchozí krok. Nezapomeň na možnost využití kreslící plochy a ukončení shrnutím pro chat (CHAT_SUMMARY:).`; await sendToGemini(prompt, 'explanation'); };

            // --- Chat Functionality ---
            const addChatMessage = async (message, sender, saveToDb = true, timestamp = new Date()) => { /* ... (function as before, uses 'model' role) ... */
                 if (!uiElements.chatMessages) return;
                const messageId = `msg-${Date.now()}-${Math.random().toString(16).substring(2, 8)}`;
                const avatarInitial = sender === 'user' ? getInitials(state.currentProfile, state.currentUser?.email) : 'AI';
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender === 'gemini' ? 'model' : sender}`;
                messageDiv.id = messageId;
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'message-bubble';
                renderMarkdown(bubbleDiv, message);
                messageDiv.innerHTML = `<div class="message-avatar">${avatarInitial}</div>`;
                messageDiv.appendChild(bubbleDiv);
                messageDiv.innerHTML += `<div class="message-timestamp">${formatTimestamp(timestamp)}</div>`;
                uiElements.chatMessages.appendChild(messageDiv);
                uiElements.chatMessages.scrollTop = uiElements.chatMessages.scrollHeight;
                if (saveToDb && state.supabase && state.currentUser && state.currentTopic && state.currentSessionId) {
                    const dataToSave = { user_id: state.currentUser?.id || null, session_id: state.currentSessionId, topic_id: state.currentTopic?.topic_id || null, topic_name: state.currentTopic?.name || null, role: sender === 'gemini' ? 'model' : 'user', content: message };
                    if (!dataToSave.session_id || !dataToSave.role || !dataToSave.content) { console.error("Supabase chat save error: Missing required fields (session_id, role, content).", dataToSave); showToast("Ошибка: Не удалось сохранить сообщение, отсутствуют обязательные данные.", "error"); return; }
                    console.log("Attempting to save chat message:", dataToSave);
                    try { const { error } = await state.supabase.from('chat_history').insert(dataToSave); if (error) { console.error("Supabase chat save error:", error); console.error("Data sent:", dataToSave); showToast(`Chyba ukládání chatu: ${error.message}`, 'error'); } else { console.log("Chat message saved to DB."); } } catch (dbError) { console.error("Exception during chat save:", dbError); console.error("Data sent:", dataToSave); showToast(`Výjimka při ukládání chatu: ${dbError.message}`, 'error'); }
                }
            };
            const updateGeminiThinkingState = (isThinking) => { /* ... (function as before) ... */ state.geminiIsThinking = isThinking; manageButtonStates(); if (isThinking) { addThinkingIndicator(); } else { removeThinkingIndicator(); } };
            const addThinkingIndicator = () => { /* ... (function as before) ... */ if (state.thinkingIndicatorId || !uiElements.chatMessages) return; const indicatorDiv = document.createElement('div'); indicatorDiv.className = 'chat-message model'; state.thinkingIndicatorId = `thinking-${Date.now()}`; indicatorDiv.id = state.thinkingIndicatorId; indicatorDiv.innerHTML = `<div class="message-avatar">AI</div><div class="message-thinking-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>`; uiElements.chatMessages.appendChild(indicatorDiv); uiElements.chatMessages.scrollTop = uiElements.chatMessages.scrollHeight; };
            const removeThinkingIndicator = () => { /* ... (function as before) ... */ if (state.thinkingIndicatorId) { const indicator = document.getElementById(state.thinkingIndicatorId); if (indicator) indicator.remove(); state.thinkingIndicatorId = null; } };
            const handleSendMessage = async () => { /* ... (function as before) ... */ const messageText = uiElements.chatInput.value.trim(); if (!messageText || state.geminiIsThinking || !state.currentTopic) return; uiElements.chatInput.value = ''; autoResizeTextarea(); uiElements.chatInput.focus(); const userTimestamp = new Date(); await addChatMessage(messageText, 'user', true, userTimestamp); state.geminiChatContext.push({ role: "user", parts: [{ text: messageText }] }); updateGeminiThinkingState(true); await sendToGemini(messageText, 'chat'); };
            const confirmClearChat = () => { /* ... (function as before) ... */ if (confirm("Opravdu chcete vymazat historii tohoto chatu?\nTato akce je nevratná.")) { clearCurrentChatSessionHistory(); } };
            const clearCurrentChatSessionHistory = async () => { /* ... (function as before) ... */ if (uiElements.chatMessages) uiElements.chatMessages.innerHTML = ''; state.geminiChatContext = []; showToast("Historie chatu vymazána.", "info"); console.log("Chat history cleared for this session."); if (state.supabase && state.currentUser && state.currentSessionId) { try { console.log(`Deleting chat history from DB for session: ${state.currentSessionId}`); const { error } = await state.supabase.from('chat_history').delete().eq('user_id', state.currentUser.id).eq('session_id', state.currentSessionId); if (error) { console.error("Error deleting chat history from DB:", error); showToast("Chyba při mazání historie z databáze.", "error"); } else { console.log("Chat history deleted from DB."); } } catch(dbError) { console.error("Exception during DB chat history deletion:", dbError); } } };
            const saveChatToPDF = async () => { /* ... (function as before) ... */
                 if (!uiElements.chatMessages || uiElements.chatMessages.children.length === 0) { showToast("Není co uložit.", "warning"); return; }
                 showToast("Generuji PDF...", "info", 2000);
                 const chatContainer = document.createElement('div'); chatContainer.id = "pdf-export-content";
                 const pdfStyles = `...`; chatContainer.innerHTML = pdfStyles; // Styles omitted for brevity
                 const headerDiv = document.createElement('div'); headerDiv.className = 'pdf-header'; headerDiv.innerHTML = `<h1>Záznam chatu - ${sanitizeHTML(state.currentTopic?.name || 'Neznámé téma')}</h1><p>Exportováno: ${new Date().toLocaleString('cs-CZ')}</p>`; chatContainer.appendChild(headerDiv);
                 Array.from(uiElements.chatMessages.children).forEach(msgElement => { if (msgElement.classList.contains('chat-message')) { const clone = msgElement.cloneNode(true); chatContainer.appendChild(clone); } });
                 const filename = `chat-justax-${state.currentTopic?.name?.replace(/[^a-z0-9]/gi, '_') || 'vyuka'}-${formatTimestamp().replace(/[:\s]/g, '')}.pdf`;
                 const options = { margin: 15, filename: filename, image: { type: 'jpeg', quality: 0.95 }, html2canvas: { scale: 2, useCORS: true, logging: false, letterRendering: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                 try { await html2pdf().set(options).from(chatContainer).save(); showToast("Chat uložen jako PDF!", "success"); } catch (pdfError) { console.error("Chyba exportu PDF:", pdfError); showToast("Nepodařilo se exportovat chat do PDF.", "error"); }
             };


             // --- Gemini Interaction & AI Drawing (FIXED PARSER for NEW format) ---
             // --- *** CORRECTED VERSION *** ---
             const parseAndProcessCanvasCommands = (responseText) => {
                let cleanedText = responseText; // Work on a copy
                const commandMatches = [];
                let match;
                // New Regex for PŘÍKAZ: ```json { "type": "CMD", "data": {...} } ```
                const NEW_COMMAND_BLOCK_REGEX = /PŘÍKAZ:\s*```json\s*(\{[\s\S]*?\})\s*```\s*/g;
                NEW_COMMAND_BLOCK_REGEX.lastIndex = 0; // Reset regex index

                console.log("Parsing for NEW canvas command blocks (PŘÍKAZ: ```json...``` format)...");

                // First pass: find all command blocks
                while ((match = NEW_COMMAND_BLOCK_REGEX.exec(responseText)) !== null) {
                     commandMatches.push({
                         fullMatch: match[0], // The entire matched string "PŘÍKAZ: ```json...``` "
                         jsonString: match[1] // The inner JSON string "{ ... }"
                     });
                }

                if (commandMatches.length > 0) {
                    console.log(`Found ${commandMatches.length} NEW canvas command blocks.`);
                    // Second pass: execute commands and remove them from the text
                    commandMatches.forEach(block => {
                        // Replace the *entire* matched block string from the cleanedText copy
                        // Use a simple string replace. If multiple identical blocks exist, this might remove only the first.
                        // A more robust approach would use indices, but for typical AI output this is often sufficient.
                        if (cleanedText.includes(block.fullMatch)) {
                            cleanedText = cleanedText.replace(block.fullMatch, '');
                            console.log(`Removed block starting with: ${block.fullMatch.substring(0, 50)}...`);
                        } else {
                            console.warn(`Block already removed or not found in remaining text: ${block.fullMatch.substring(0, 50)}...`);
                        }

                        // Parse the inner JSON and execute
                        try {
                            const parsedJson = JSON.parse(block.jsonString);
                            const commandType = parsedJson.type; // Get command from "type" field
                            const commandData = parsedJson.data; // Get data from "data" field

                            if (commandType && commandData) {
                                // Ensure canvas commands run only if canvas is ready
                                if (state.isCanvasInitialized) {
                                    handleCanvasDrawCommand(commandType, commandData); // Execute drawing
                                } else {
                                     console.warn(`Canvas not initialized, skipping command: ${commandType}`);
                                }
                            } else {
                                 console.warn("Parsed JSON is missing 'type' or 'data' field:", parsedJson);
                            }
                        } catch (e) {
                            console.error(`Failed to parse JSON or execute command:`, e, "\nJSON String:", block.jsonString);
                        }
                    });
                } else {
                    console.log("No NEW canvas command blocks found in the response.");
                }

                console.log("Finished parsing canvas commands. Returning cleaned text.");
                return cleanedText.trim(); // Return the text with commands removed
             };
             // --- *** END OF CORRECTED PARSER *** ---

            const sendToGemini = async (promptText, targetArea) => {
                 /* ... (Error checks as before) ... */
                 if (!GEMINI_API_KEY || !GEMINI_API_KEY.startsWith('AIzaSy')) { showToast("Chyba: AI není správně nakonfigurována.", "error"); updateGeminiThinkingState(false); return; }
                 if (!state.currentTopic) { showToast("Chyba: Není vybráno žádné téma.", "error"); updateGeminiThinkingState(false); return; }

                 console.log(`Sending to Gemini (Target: ${targetArea}): "${promptText.substring(0, 100)}..."`);
                 updateAIStatus('AI přemýšlí...');
                 const requestTimestamp = new Date();
                 updateGeminiThinkingState(true);

                 // --- Updated System Instruction ---
                 const systemInstructionText = `Jsi AI Tutor "Justax", expert na matematiku pro 9. třídu ZŠ v ČR (přijímačky CERMAT). Vyučuješ téma: "${state.currentTopic.name}"${state.currentTopic.description ? ` (Popis: "${state.currentTopic.description}")` : ''}.
                 Tvůj styl je PŘÁTELSKÝ, TRPĚLIVÝ a PODROBNÝ. Vysvětluj krok za krokem, používej PŘESNÉ matematické termíny a jednoduché příklady.
                 Důsledně používej Markdown pro formátování textu a MathJax pro matematické vzorce (blokové vzorce: $$...$$, inline vzorce: \\(...\\)). Odpovídej VŽDY ČESKY.

                 DŮLEŽITÉ POKYNY PRO TEBE:
                 1.  **KROK ZA KROKEM:** V záložce "Vysvětlení" se drž JEDNOHO logického kroku nebo konceptu na odpověď. Buď systematický a postupný. Nezahlcuj studenta příliš mnoha informacemi najednou.
                 2.  **INTERAKTIVITA:** Pravidelně pokládej studentovi KONTROLNÍ OTÁZKY ("Zkus si teď sám:", "Co si myslíš, že bude další krok?", "Je ti tento postup jasný?") nebo ho vyzývej k zamyšlení. Počkej na jeho reakci (pomocí tlačítka "Další krok" nebo odpovědi v chatu).
                 3.  **KRESLÍCÍ PLOCHA (HTML5 Canvas):** Pro vizualizaci (geometrie, grafy, číselné osy, kroky řešení rovnic, vzorce) MŮŽEŠ na KONEC své textové odpovědi přidat JEDEN NEBO VÍCE speciálních bloků s příkazy pro kreslení. Každý blok MUSÍ mít TENTO PŘESNÝ FORMÁT JSON: \`PŘÍKAZ: \`\`\`json { "type": "NAZEV_PRIKAZU", "data": { /* JSON data pro příkaz */ } } \`\`\`\`.
                     * Používej POUZE tyto hodnoty pro pole "type" (case-sensitive): "CLEAR_CANVAS", "DRAW_LINE", "DRAW_RECT", "DRAW_CIRCLE", "DRAW_TEXT".
                     * Objekt "data" MUSÍ obsahovat VŠECHNY potřebné parametry pro daný příkaz (např. souřadnice x, y, rozměry, text, color).
                     * Příklad pro text: \`PŘÍKAZ: \`\`\`json { "type": "DRAW_TEXT", "data": { "text": "a = 5", "x": 50, "y": 50, "color": "#3f37c9", "font": "bold 16px Poppins" } } \`\`\`\`
                     * Příklad pro vymazání: \`PŘÍKAZ: \`\`\`json { "type": "CLEAR_CANVAS", "data": {} } \`\`\`\`
                     * Aktuální rozměry plátna jsou ${state.canvasWidth}px (šířka) x ${state.canvasHeight}px (výška). Souřadnice [0, 0] je LEVÝ HORNÍ roh.
                     * Kresli PŘEHLEDNĚ a SROZUMITELNĚ. Vyhni se PŘEKRÝVÁNÍ textu a důležitých prvků. Používej KONZISTENTNÍ styl. Před složitějším obrázkem VŽDY použij CLEAR_CANVAS. Koordináty volte tak, aby se vešly na plátno (0 až ${state.canvasWidth} pro x, 0 až ${state.canvasHeight} pro y).
                 4.  **DÉLKA ODPOVĚDI:** Pro záložku "Vysvětlení" buď podrobný, ale stručný v rámci jednoho kroku. Pro "Chat" odpovídej stručněji a přímo na dotaz studenta.
                 5.  **VÝSTUP DO CHATU (SHRNUTÍ):** POKUD generuješ delší odpověď pro "Vysvětlení", na ÚPLNÝ konec celé odpovědi (i za případné kreslící příkazy) PŘIDEJ krátký, výstižný souhrn pro zobrazení v chatu, ve formátu: \`CHAT_SUMMARY: [Zde tvůj krátký souhrn jednoho až dvou vět]\`. Pokud odpovídáš přímo v chatu (target 'chat'), CHAT_SUMMARY nepřidávej.`;
                 // --- End of Updated System Instruction ---

                 const historyForApi = state.geminiChatContext.filter(item => item.role === 'user' || item.role === 'model');
                 const currentRequestContent = { role: "user", parts: [{ text: promptText }] };
                 let contentsPayload;

                 if (historyForApi.length === 0) {
                     contentsPayload = [{ role: "user", parts: [{ text: systemInstructionText + "\n\n---\n\nStudentův dotaz/požadavek: " + promptText }] }];
                 } else {
                     contentsPayload = [...historyForApi, currentRequestContent];
                 }

                 const requestBody = { /* ... (requestBody as before) ... */
                     contents: contentsPayload,
                     generationConfig: { temperature: 0.6, topP: 0.95, topK: 40, maxOutputTokens: 4096 },
                     safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" } ]
                 };

                 try {
                     console.log("Sending payload to Gemini:", JSON.stringify(requestBody).substring(0, 500) + "...");
                     const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                     if (!response.ok) { const errorBody = await response.text(); console.error("Gemini API Error Response:", errorBody); throw new Error(`Chyba Gemini API (${response.status}): ${errorBody.substring(0, 100)}`); }
                     const data = await response.json();
                     console.log("Raw Gemini Response:", data);
                     const candidate = data.candidates?.[0];
                     if (!candidate) { console.error("Invalid response structure from Gemini:", data); const promptFeedback = data.promptFeedback; if (promptFeedback?.blockReason) { throw new Error(`Obsah blokován: ${promptFeedback.blockReason}. Detail: ${promptFeedback.safetyRatings?.map(r => `${r.category}: ${r.probability}`).join(', ')}`); } throw new Error('Chybná struktura odpovědi od AI.'); }
                     if (candidate.finishReason && !["STOP", "MAX_TOKENS"].includes(candidate.finishReason)) { console.warn(`Gemini generation stopped unexpectedly: ${candidate.finishReason}`); }
                     const geminiResponseText = candidate.content?.parts?.[0]?.text;
                     if (!geminiResponseText) { console.warn("Gemini returned empty text content."); throw new Error('AI vrátila prázdnou odpověď.'); }

                     state.geminiChatContext.push({ role: "model", parts: [{ text: geminiResponseText }] });
                     processGeminiResponse(geminiResponseText, targetArea, requestTimestamp); // Changed from await, processGeminiResponse should be sync now regarding DOM updates
                     updateAIStatus(state.currentTopic ? `Vysvětluje: ${state.currentTopic.name}` : 'Připraven');

                 } catch (error) {
                     console.error('Error sending/processing Gemini request:', error);
                     showToast(`Chyba komunikace s AI: ${error.message}`, "error");
                     handleGeminiError(error.message, targetArea, requestTimestamp);
                     updateAIStatus('Nastala chyba');
                 } finally {
                     updateGeminiThinkingState(false);
                 }
             };

             // Process response (Handles parsing and rendering)
             const processGeminiResponse = (rawResponseText, targetArea, timestamp) => {
                 removeThinkingIndicator();
                 let chatSummary = null;
                 const summaryRegex = /CHAT_SUMMARY:\s*([\s\S]*)/;
                 const summaryMatch = rawResponseText.match(summaryRegex);
                 let textForProcessing = rawResponseText;

                 if (summaryMatch && summaryMatch[1]) {
                     chatSummary = summaryMatch[1].trim();
                     textForProcessing = rawResponseText.replace(summaryRegex, '').trim();
                     console.log("Extracted Chat Summary:", chatSummary);
                 }

                 // Process canvas commands AND get the remaining text WITHOUT commands
                 // This function now correctly removes the NEW command format
                 const textToDisplay = parseAndProcessCanvasCommands(textForProcessing);

                 if (targetArea === 'explanation') {
                     console.log("Processing for EXPLANATION area.");
                     const placeholder = uiElements.explanationDisplay.querySelector('.loading-placeholder, .empty-state');
                     if (placeholder) placeholder.remove();

                     const isFirstStep = uiElements.explanationDisplay.querySelectorAll('.step').length === 0 && state.lastExplanationTimestamp === 0;
                     if (isFirstStep) { uiElements.explanationDisplay.innerHTML = ''; console.log("First explanation step, clearing initial placeholder."); }
                     else { console.log("Appending explanation step."); }

                     const stepDiv = document.createElement('div'); stepDiv.className = 'step';
                     renderMarkdown(stepDiv, textToDisplay); // Render the CLEANED text
                     uiElements.explanationDisplay.appendChild(stepDiv);
                     state.lastExplanationTimestamp = Date.now();

                     if(uiElements.explanationScrollContent) { uiElements.explanationScrollContent.scrollTop = uiElements.explanationScrollContent.scrollHeight; }

                     if (chatSummary) { addChatMessage(chatSummary, 'gemini', true, timestamp); }
                     else if (textToDisplay.trim()) { addChatMessage(`AI pokračovala ve vysvětlení (viz záložka Vysvětlení).`, 'gemini', false, timestamp); }
                      manageUIState('learning');
                      manageButtonStates();

                 } else { // Target is 'chat'
                     console.log("Processing for CHAT area.");
                     if (textToDisplay.trim()) { addChatMessage(textToDisplay, 'gemini', true, timestamp); }
                     else if (chatSummary) { addChatMessage(chatSummary, 'gemini', true, timestamp); }
                     else {
                         if (rawResponseText !== textForProcessing) { console.log("Chat response contained only canvas commands."); }
                         else { addChatMessage("(AI neposkytla textovou odpověď)", 'gemini', false, timestamp); console.warn("AI chat response was empty after processing commands."); }
                     }
                 }

                 if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') { setTimeout(() => window.MathJax.typesetPromise(), 50); }
             };

             const handleGeminiError = (errorMessage, targetArea, timestamp) => { /* ... (function as before) ... */
                const errorMsg = `Omlouvám se, nastala chyba při zpracování: ${errorMessage}`;
                removeThinkingIndicator();
                addChatMessage(errorMsg, 'gemini', false, timestamp);
                if (targetArea === 'explanation' && uiElements.explanationDisplay) {
                    const errorP = document.createElement('p');
                    errorP.style.color = 'var(--danger)';
                    errorP.style.marginTop = '1rem';
                    errorP.style.fontWeight = 'bold';
                    errorP.textContent = errorMsg;
                    uiElements.explanationDisplay.appendChild(errorP);
                    if(uiElements.explanationScrollContent) uiElements.explanationScrollContent.scrollTop = uiElements.explanationScrollContent.scrollHeight;
                }
                updateAIStatus('Nastala chyba');
                manageButtonStates();
             };


            // --- Run Application ---
             initializeApp();

        } catch (e) {
            // Fatal Error Handling
            console.error("FATAL SCRIPT ERROR:", e);
            document.body.innerHTML = `<div style="padding: 30px; text-align: center; font-family: sans-serif; color: #dc3545;"><h1>Nastala kritická chyba</h1><p>Omlouváme se, aplikace nemohla být spuštěna.</p><p>Zkuste prosím obnovit stránku.</p><pre style="margin-top: 20px; padding: 15px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; text-align: left; font-size: 12px; white-space: pre-wrap; word-wrap: break-word;">${e.message}\n${e.stack}</pre></div>`;
        }
    </script>

</body>
</html>