<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Výuka s AI (Videocall Interface)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        window.MathJax = {
          tex: { inlineMath: [['\\(', '\\)']], displayMath: [['$$', '$$']], processEscapes: true, processEnvironments: true },
          options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' },
          startup: { ready: () => { MathJax.startup.defaultReady(); MathJax.startup.promise.then(() => console.log('MathJax loaded and ready.')); } }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* --- Reset & Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; scroll-behavior: smooth; }
        :root {
            --primary-rgb: 67, 97, 238;
            --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9; --success: #06d6a0; --danger: #f72585; --warning: #f8961e; --info: #4cc9f0; --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d; --gray-light: #dee2e6; --gray-dark: #343a40; --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3); --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee); --white: #ffffff; --sidebar-width: 260px; --transition-speed: 0.3s; --card-radius: 12px; /* Slightly smaller radius */ --shadow-sm: 0 2px 6px rgba(0, 0, 0, 0.05); --shadow-md: 0 5px 12px rgba(0, 0, 0, 0.07); --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1); --text-primary: #2d3748; --text-secondary: #4a5568; --text-muted: #718096; --call-bg: #f0f2f5; --call-panel-bg: var(--white); --avatar-size: 50px;
        }
        body { background-color: var(--call-bg); color: var(--text-primary); min-height: 100vh; display: flex; overflow: hidden; /* Prevent body scroll */ }

        /* --- Sidebar (Minimal changes) --- */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 1050; box-shadow: var(--shadow-lg); transition: transform var(--transition-speed) ease, width var(--transition-speed) ease; }
        /* ... other sidebar styles remain the same ... */
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; }
        .sidebar-logo { font-size: 1.5rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo i { font-size: 1.75rem; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .sidebar-item { margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; color: rgba(255, 255, 255, 0.85); text-decoration: none; border-radius: 12px; transition: all 0.2s ease; font-weight: 500; }
        .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; width: 24px; text-align: center; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--white); }
        .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); text-align: center; }
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.1); border-radius: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-weight: 500; overflow: hidden; color: var(--white); }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; }
        .user-name { font-weight: 600; font-size: 0.95rem; }
        .user-role { font-size: 0.8rem; opacity: 0.8; }

        /* --- Main Content Area (Wrapper for Call Interface) --- */
        main { flex: 1; margin-left: var(--sidebar-width); transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); height: 100vh; display: flex; flex-direction: column; overflow: hidden; background-color: var(--call-bg); }
        .main-header { padding: 1rem 1.5rem; background-color: var(--white); box-shadow: var(--shadow-sm); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; z-index: 100; border-bottom: 1px solid var(--gray-light); }
        .header-content h1 { font-size: 1.5rem; font-weight: 600; color: var(--dark); margin: 0; }
        .header-actions button, .header-actions a { font-size: 0.9rem; padding: 0.6rem 1.2rem; }

        /* --- Videocall Interface Layout --- */
        .call-interface { flex-grow: 1; display: flex; overflow: hidden; padding: 1.5rem; gap: 1.5rem; }

        /* Left Side: AI Presenter Area (Avatar + Whiteboard) */
        .ai-presenter-area { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--call-panel-bg); border-radius: var(--card-radius); box-shadow: var(--shadow-md); overflow: hidden; }
        .ai-presenter-header { padding: 0.75rem 1.25rem; border-bottom: 1px solid var(--gray-light); display: flex; align-items: center; gap: 0.75rem; background-color: var(--light); }
        .ai-avatar-placeholder { width: var(--avatar-size); height: var(--avatar-size); background: var(--gradient-1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0; box-shadow: var(--shadow-sm); }
        .ai-presenter-info h2 { font-size: 1.1rem; font-weight: 600; color: var(--dark); margin: 0; }
        .ai-presenter-info p { font-size: 0.85rem; color: var(--text-secondary); margin: 0; }
        .whiteboard-main-container { flex-grow: 1; position: relative; /* For tldraw positioning */ overflow: hidden; /* Crucial */ border-radius: 0 0 var(--card-radius) var(--card-radius); /* Match parent */ }
        #tldraw-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; } /* Wrapper for tldraw instance */
        #tldraw-wrapper > div { border-radius: inherit; } /* Ensure tldraw respects parent radius */
        #tldraw-wrapper > p { /* Styling for placeholder/error message inside */ padding: 2rem; text-align: center; font-style: italic; color: var(--text-muted); }

        /* Right Side: Interaction Panel (Tabs: Explanation, Chat) */
        .interaction-panel { width: 400px; /* Fixed width for chat/explanation */ flex-shrink: 0; display: flex; flex-direction: column; background-color: var(--call-panel-bg); border-radius: var(--card-radius); box-shadow: var(--shadow-md); overflow: hidden; }
        .interaction-tabs { display: flex; border-bottom: 1px solid var(--gray-light); background-color: var(--light); flex-shrink: 0; }
        .interaction-tab { flex: 1; text-align: center; padding: 0.9rem 1rem; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; border-bottom: 3px solid transparent; font-size: 0.95rem; }
        .interaction-tab:hover { color: var(--primary); background-color: rgba(var(--primary-rgb), 0.05); }
        .interaction-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }
        .interaction-tab i { margin-right: 0.5rem; }

        .interaction-content-area { flex-grow: 1; overflow: hidden; position: relative; /* Needed for absolute positioning of tab content */ }
        .tab-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; visibility: hidden; opacity: 0; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .tab-content.active { visibility: visible; opacity: 1; transition: opacity 0.3s ease; }

        /* Explanation Tab Content */
        #explanation-tab-content { padding: 1.5rem; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--gray-light) transparent; }
        #explanation-tab-content::-webkit-scrollbar { width: 8px; }
        #explanation-tab-content::-webkit-scrollbar-track { background: transparent; }
        #explanation-tab-content::-webkit-scrollbar-thumb { background-color: var(--gray-light); border-radius: 4px; border: 2px solid var(--call-panel-bg); }
        #explanation-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; color: var(--dark); }
        #explanation-display { line-height: 1.7; }
        #explanation-display p:last-child { margin-bottom: 0; }
        #explanation-display .step { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed var(--gray-light); }
        #explanation-display .step:last-child { border-bottom: none; padding-bottom: 0; }
        #explanation-display h3 { color: var(--secondary); margin-top: 1.5rem; margin-bottom: 0.7rem; font-size: 1.1rem; }
        #explanation-display code { background-color: rgba(var(--primary-rgb), 0.1); padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.95em; color: var(--secondary); }
        #explanation-display pre { margin: 1rem 0; }
        #explanation-display pre code { display: block; background-color: var(--gray-dark); color: #e0e0e0; padding: 1rem; border-radius: 8px; font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
        #explanation-display strong { color: var(--dark); font-weight: 600; }
        #explanation-display blockquote { border-left: 3px solid var(--primary-light); padding-left: 1rem; margin: 1rem 0 1rem 0.5rem; color: var(--text-secondary); font-style: italic; }
        #explanation-display ul, #explanation-display ol { margin-left: 1.5rem; margin-bottom: 1rem; padding-left: 1rem; }
        #explanation-display li { margin-bottom: 0.5rem; }
        .explanation-controls { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--gray-light); text-align: center; }

        /* Chat Tab Content */
        #chat-tab-content { padding: 0; /* Chat area handles its own padding */ }
        .chat-area { height: 100%; background-color: transparent; box-shadow: none; border: none; border-radius: 0; }
        .chat-header { display: none; /* Header is handled by interaction panel */ }
        .chat-messages { padding: 1.25rem; scrollbar-color: var(--gray-light) var(--call-panel-bg); /* Adjust scrollbar track */ }
         .chat-messages::-webkit-scrollbar-track { background: var(--call-panel-bg); }
        .chat-messages::-webkit-scrollbar-thumb { border-color: var(--call-panel-bg); }
        .chat-input-area { padding: 1rem 1.25rem; background-color: var(--light); border-top: 1px solid var(--gray-light); }
        /* Inherit message bubble styles from previous version */
        .chat-message { display: flex; gap: 0.8rem; max-width: 88%; align-items: flex-end; }
        .chat-message.user { margin-left: auto; flex-direction: row-reverse; }
        .message-avatar { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1rem; flex-shrink: 0; box-shadow: var(--shadow-sm); border: 2px solid var(--call-panel-bg); } /* Use panel bg for border */
        .chat-message.user .message-avatar { background: var(--success); color: white; }
        .chat-message.gemini .message-avatar { background: var(--primary); color: white; }
        .message-bubble { padding: 0.9rem 1.2rem; border-radius: 20px; line-height: 1.6; word-wrap: break-word; box-shadow: var(--shadow-sm); position: relative; transition: transform 0.2s ease; background-color: var(--light); color: var(--text-primary); border: 1px solid #e9ecef; border-bottom-left-radius: 6px; }
        .message-bubble:hover { transform: scale(1.01); }
        .chat-message.user .message-bubble { background: var(--gradient-1); color: white; border: none; border-bottom-right-radius: 6px; border-bottom-left-radius: 20px; }
        .message-bubble code { background-color: rgba(var(--primary-rgb), 0.1); padding: 0.1em 0.3em; border-radius: 4px; font-size: 0.9em; color: var(--secondary); }
        .chat-message.user .message-bubble code { background-color: rgba(255, 255, 255, 0.2); color: #fff; }
        .message-bubble pre { margin: 0.5rem 0; }
        .message-bubble pre code { display: block; background-color: var(--gray-dark); color: #e0e0e0; padding: 0.8rem; border-radius: 6px; font-size: 0.85rem; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
        .chat-message.user .message-bubble pre code { background-color: rgba(0,0,0,0.3); color: #eee; }
        .message-timestamp { font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; display: block; text-align: left; opacity: 0.8; }
        .chat-message.user .message-timestamp { text-align: right; }
        .message-thinking-indicator { background: var(--light); display: flex; align-items: center; padding: 0.9rem 1.2rem; }
        .typing-dot { width: 7px; height: 7px; background-color: var(--gray); border-radius: 50%; margin: 0 2px; display: inline-block; animation: typing 1.2s infinite ease-in-out; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.5; } 30% { transform: translateY(-3px); opacity: 1; } }
        .chat-input { flex-grow: 1; padding: 0.8rem 1.1rem; border: 1px solid var(--gray-light); border-radius: 22px; font-size: 1rem; resize: none; max-height: 150px; overflow-y: auto; transition: border-color 0.2s ease, box-shadow 0.2s ease; line-height: 1.4; }
        .chat-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.15); }
        .send-button { padding: 0 1.3rem; border-radius: 22px; font-weight: 500; font-size: 1rem; cursor: pointer; border: none; background: var(--gradient-1); color: white; transition: all 0.3s ease; flex-shrink: 0; height: 44px; display: flex; align-items: center; justify-content: center; }
        .send-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(var(--primary-rgb), 0.2); }
        .send-button i { font-size: 1.1em; }
        .send-button .fa-spinner { margin: 0; }

        /* Topic Loading Bar */
        .topic-loading-bar { padding: 1rem 1.5rem; background-color: var(--light); border-bottom: 1px solid var(--gray-light); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; flex-shrink: 0; }
        #current-topic-display { font-size: 1rem; font-weight: 500; color: var(--text-secondary); }
        #current-topic-display strong { color: var(--primary); font-weight: 600; }
        #current-topic-display .placeholder { font-style: italic; color: var(--text-muted); }

        /* Utility & State Styles */
        .loading-placeholder { display: flex; align-items: center; justify-content: center; padding: 3rem; text-align: center; font-style: italic; color: var(--text-muted); flex-grow: 1; }
        .loading-placeholder i { margin-right: 0.75rem; font-size: 1.5rem; }
        .empty-state { text-align: center; padding: 3rem 1.5rem; color: var(--text-secondary); margin-top: 2rem; }
        .empty-state i { font-size: 3.5rem; margin-bottom: 1.5rem; color: var(--gray-light); }
        .empty-state h3 { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; color: var(--dark); }
        .empty-state p { margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.7rem 1.4rem; border-radius: 8px; /* Less round */ font-weight: 500; font-size: 0.9rem; text-decoration: none; transition: all 0.2s ease; cursor: pointer; border: none; gap: 0.5rem; line-height: 1.4; }
        .btn-primary { background: var(--gradient-1); color: white; box-shadow: var(--shadow-sm); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); background: linear-gradient(135deg, var(--primary-light), var(--secondary)); }
        .btn-secondary { background-color: var(--light); color: var(--text-secondary); border: 1px solid var(--gray-light); box-shadow: var(--shadow-sm); }
        .btn-secondary:hover:not(:disabled) { background-color: #e9ecef; color: var(--dark); border-color: #ced4da; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; background: var(--gray-light); }
        .btn i { font-size: 1em; }

        /* --- Responsiveness Adjustments for New Layout --- */
        .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; color: var(--dark); font-size: 1.5rem; margin-right: 1rem; padding: 0.5rem; z-index: 1060; /* Above sidebar */ }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1040; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        .sidebar-overlay.active { display: block; opacity: 1; }

        @media (max-width: 1200px) {
             .interaction-panel { width: 340px; }
             .call-interface { padding: 1rem; gap: 1rem; }
             .main-header { padding: 0.75rem 1rem; }
             .header-content h1 { font-size: 1.3rem; }
        }
        @media (max-width: 992px) {
             :root { --sidebar-width: 80px; }
             main { margin-left: 80px; width: calc(100% - 80px); }
             /* Sidebar collapsed styles */
             .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; } .sidebar-link i { margin-right: 0; font-size: 1.5rem; } .sidebar-logo i { margin-right: 0; } .sidebar-header, .sidebar-link { justify-content: center; } .user-profile { justify-content: center; padding: 0.75rem 0; } .user-avatar { margin-right: 0; }
             /* Layout change for tablet */
             .call-interface { flex-direction: column; }
             .ai-presenter-area { /* Takes full width, whiteboard might need height adjustment */ }
             .interaction-panel { width: 100%; max-height: 50vh; /* Limit interaction panel height */ }
             .whiteboard-main-container { min-height: 300px; /* Ensure whiteboard has space */ }
        }
         @media (max-width: 768px) {
              main { padding: 0; /* Remove main padding, handle in children */ }
              .main-header { padding: 0.75rem; border-radius: 0; }
              .call-interface { padding: 0.75rem; gap: 0.75rem; }
              .interaction-panel { max-height: 45vh; }
              .ai-avatar-placeholder { width: 40px; height: 40px; font-size: 1.2rem; }
              .ai-presenter-info h2 { font-size: 1rem; }
              .interaction-tab { padding: 0.75rem 0.5rem; font-size: 0.9rem; }
              .chat-messages { padding: 1rem; gap: 0.75rem; }
              .chat-input-area { padding: 0.75rem 1rem; }
         }

        @media (max-width: 576px) {
             :root { --sidebar-width: 0; }
             main { margin-left: 0; width: 100%; }
             .sidebar { transform: translateX(-100%); width: 260px; z-index: 1050; }
             .sidebar.active { transform: translateX(0); .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: block; } .sidebar-link i { margin-right: 0.75rem; } .sidebar-header, .sidebar-link { justify-content: flex-start; } .user-profile { justify-content: flex-start; padding: 1rem; } .user-avatar { margin-right: 0.75rem; } }
             .mobile-menu-toggle { display: block; }
             .header-content h1 { font-size: 1.2rem; }
             .call-interface { padding: 0.5rem; gap: 0.5rem; }
             .interaction-panel { max-height: 40vh; } /* Further limit height on small screens */
              .whiteboard-main-container { min-height: 250px; }
              .ai-presenter-header { padding: 0.5rem 0.75rem; }
              .message-bubble { padding: 0.7rem 1rem; }
              .chat-input { font-size: 0.9rem; }
              .send-button { height: 38px; padding: 0 1rem; }
        }

        /* --- Dark mode Adjustments --- */
        @media (prefers-color-scheme: dark) {
             :root { --white: #1a202c; --light: #2d3748; --dark: #e2e8f0; --gray-light: #4a5568; --text-primary: #e2e8f0; --text-secondary: #cbd5e0; --text-muted: #a0aec0; --dark-bg: #171923; /* Renamed for clarity */ --call-bg: #131720; /* Darker call background */ --call-panel-bg: #1e2533; /* Panel background */ }
             body { background-color: var(--dark-bg); }
             main { background-color: var(--call-bg); }
             .main-header { background-color: var(--call-panel-bg); border-bottom-color: var(--gray-light); }
             .mobile-menu-toggle { color: var(--dark); }
             .ai-presenter-area, .interaction-panel { background-color: var(--call-panel-bg); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
             .ai-presenter-header { background-color: var(--light); border-bottom-color: var(--gray-light); }
             .whiteboard-main-container { background-color: var(--dark-bg); /* Ensure contrast for whiteboard itself */ }
             .interaction-tabs { background-color: var(--light); border-bottom-color: var(--gray-light); }
             .interaction-tab { color: var(--text-secondary); }
             .interaction-tab:hover { color: var(--primary-light); background-color: rgba(72, 149, 239, 0.1); }
             .interaction-tab.active { color: var(--primary-light); border-bottom-color: var(--primary-light); }
             /* Explanation Dark */
             #explanation-tab-content { scrollbar-color: var(--gray) var(--call-panel-bg); }
             #explanation-tab-content::-webkit-scrollbar-thumb { border-color: var(--call-panel-bg); }
             #explanation-display pre code { background-color: #1a202c; color: #d1d5db; }
             #explanation-display code { background-color: rgba(72, 149, 239, 0.15); color: var(--primary-light); }
             #explanation-display strong { color: var(--light); }
             #explanation-display blockquote { border-left-color: var(--primary); color: var(--text-secondary); }
             /* Chat Dark */
             .chat-messages { scrollbar-color: var(--gray) var(--call-panel-bg); }
             .chat-messages::-webkit-scrollbar-track { background: var(--call-panel-bg); }
             .chat-messages::-webkit-scrollbar-thumb { border-color: var(--call-panel-bg); }
             .message-avatar { border-color: var(--call-panel-bg); }
             .message-bubble { background-color: var(--light); color: var(--text-primary); border-color: var(--gray-light); }
             .chat-message.user .message-bubble { background: var(--gradient-2); color: var(--dark); } /* Changed user gradient for dark */
             .message-bubble code { background-color: rgba(255,255,255,0.1); color: var(--text-primary); }
             .chat-message.user .message-bubble code { background-color: rgba(0, 0, 0, 0.2); color: var(--light); } /* Adjust user code bg */
             .message-bubble pre code { background-color: #1a202c; color: #d1d5db; }
             .chat-message.user .message-bubble pre code { background-color: rgba(0,0,0,0.3); color: #eee; }
             .message-thinking-indicator { background: var(--light); }
             .typing-dot { background-color: var(--gray); }
             .chat-input-area { background-color: var(--light); border-top-color: var(--gray-light); }
             .chat-input { background-color: var(--dark-bg); color: var(--text-primary); border-color: var(--gray-light); }
             .chat-input::placeholder { color: var(--text-muted); }
             .chat-input:focus { box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.2); }
             /* Buttons Dark */
             .btn-secondary { background-color: var(--light); color: var(--text-secondary); border-color: var(--gray-light); }
             .btn-secondary:hover:not(:disabled) { background-color: var(--gray-light); color: var(--dark); }
             .topic-loading-bar { background-color: var(--light); border-bottom-color: var(--gray-light); }
        }

        /* Toast notification */
        .toast { position: fixed; bottom: 20px; right: 20px; background-color: var(--white); color: var(--text-primary); border-radius: 8px; padding: 1rem; box-shadow: var(--shadow-lg); max-width: 300px; z-index: 1060; /* Above sidebar overlay */ display: flex; align-items: center; transform: translateY(120px); opacity: 0; transition: all 0.4s ease-in-out; border-left: 4px solid var(--primary); }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left-color: var(--success); } .toast.error { border-left-color: var(--danger); } .toast.warning { border-left-color: var(--warning); }
        .toast i { margin-right: 0.75rem; font-size: 1.25rem; }
        .toast.success i { color: var(--success); } .toast.error i { color: var(--danger); } .toast.warning i { color: var(--warning); }
        @media (prefers-color-scheme: dark) { .toast { background-color: var(--call-panel-bg); border-color: var(--gray-light); color: var(--text-primary); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);} }

    </style>
</head>
<body>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header"> <a href="/" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
         <ul class="sidebar-menu"> <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Dashboard</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li> </ul>
         <div class="user-profile"> <div class="user-avatar" id="user-avatar">?</div> <div class="user-info"> <div class="user-name" id="user-name">Načítání...</div> <div class="user-role">Student</div> </div> </div>
         <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main>
        <div class="main-header">
            <div class="header-content">
                 <div style="display: flex; align-items: center; gap: 1rem;">
                      <button class="mobile-menu-toggle" id="mobile-menu-toggle"> <i class="fas fa-bars"></i> </button>
                      <h1>Interaktivní výuka</h1>
                 </div>
                 <div class="header-actions">
                      <a href="/dashboard/procvicovani/main.html" class="btn btn-secondary"> <i class="fas fa-times"></i> Ukončit výuku </a>
                 </div>
            </div>
        </div>

        <div class="topic-loading-bar">
             <div id="current-topic-display">
                  <span class="placeholder">Načítám další téma z plánu...</span>
             </div>
             <button class="btn btn-primary btn-tooltip" id="load-next-topic-btn" title="Načíst další nedokončené téma ze studijního plánu">
                  <i class="fas fa-sync-alt"></i> Načíst další téma
             </button>
        </div>


        <div class="call-interface">

            <div class="ai-presenter-area">
                <div class="ai-presenter-header">
                    <div class="ai-avatar-placeholder">
                        <i class="fas fa-robot"></i> </div>
                    <div class="ai-presenter-info">
                        <h2>AI Tutor Justax</h2>
                        <p id="ai-status-text">Vysvětluje téma...</p>
                    </div>
                </div>
                <div class="whiteboard-main-container">
                    <div id="tldraw-wrapper">
                        <p>Inicializace interaktivní došky...</p>
                    </div>
                </div>
            </div>

            <div class="interaction-panel">
                <div class="interaction-tabs">
                    <div class="interaction-tab active" data-tab="explanation-tab">
                        <i class="fas fa-chalkboard-teacher"></i> Vysvětlení
                    </div>
                    <div class="interaction-tab" data-tab="chat-tab">
                        <i class="fas fa-comments"></i> Chat
                    </div>
                </div>
                <div class="interaction-content-area">
                    <div id="explanation-tab-content" class="tab-content active">
                         <h2 id="explanation-title" style="display:none;">Vysvětlení</h2> <div id="explanation-display">
                              <div class="empty-state">
                                   <i class="fas fa-book-reader"></i>
                                   <h3>Připraveno k učení</h3>
                                   <p>Až se načte téma, zde se objeví vysvětlení od AI.</p>
                              </div>
                         </div>
                         <div class="explanation-controls">
                              <button class="btn btn-primary" id="next-step-btn" style="display: none;" title="Požádat AI o další krok nebo pokračování">
                                   <i class="fas fa-forward"></i> Pokračovat / Další krok
                              </button>
                         </div>
                    </div>
                    <div id="chat-tab-content" class="tab-content">
                        <section class="chat-area">
                            <div class="chat-messages" id="chat-messages">
                                </div>
                            <div class="chat-input-area">
                                <textarea class="chat-input" id="chat-input" placeholder="Napiš svou otázku..." rows="1"></textarea>
                                <button class="send-button" id="send-button" title="Odeslat zprávu">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                             <div style="padding: 0.5rem 1.25rem; font-size: 0.8rem; color: var(--text-muted); text-align: right; background-color: var(--light); border-top: 1px solid var(--gray-light);">
                                 <button id="clear-chat-btn" class="btn-tooltip" style="background:none; border:none; color: var(--text-muted); cursor:pointer; font-size: 0.9em; padding: 2px 5px;" title="Vymazat historii tohoto chatu">
                                     <i class="fas fa-trash-alt"></i> Vymazat chat
                                 </button>
                                  |
                                 <button id="save-chat-btn" class="btn-tooltip" style="background:none; border:none; color: var(--text-muted); cursor:pointer; font-size: 0.9em; padding: 2px 5px;" title="Uložit chat jako PDF">
                                     <i class="fas fa-save"></i> Uložit PDF
                                 </button>
                             </div>
                        </section>
                    </div>
                </div>
            </div>

        </div> </main>

    <div class="toast" id="toast"> <i class="fas fa-info-circle"></i> <div id="toast-message">Operace úspěšná.</div> </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // --- Constants & Config ---
            const SUPABASE_URL = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
            const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // WARNING: Test key only! Use backend in production.
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            const TLDR AW_CDN_URL = 'https://unpkg.com/tldraw@1.24.2/dist/tldraw.js';

            // --- DOM Elements ---
            const userAvatarEl = document.getElementById('user-avatar');
            const userNameEl = document.getElementById('user-name');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const currentTopicDisplay = document.getElementById('current-topic-display');
            const loadNextTopicBtn = document.getElementById('load-next-topic-btn');
            const explanationDisplay = document.getElementById('explanation-display'); // Target for explanation content
            const explanationTitle = document.getElementById('explanation-title'); // Title within the tab
            const tldrawWrapper = document.getElementById('tldraw-wrapper'); // Wrapper for tldraw instance/placeholder
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const saveChatBtn = document.getElementById('save-chat-btn');
            const clearChatBtn = document.getElementById('clear-chat-btn');
            const nextStepBtn = document.getElementById('next-step-btn');
            const toastEl = document.getElementById('toast');
            const toastMessageEl = document.getElementById('toast-message');
            const interactionTabs = document.querySelectorAll('.interaction-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const aiStatusText = document.getElementById('ai-status-text');

            // --- Global State ---
            let supabase = null;
            let currentUser = null;
            let currentProfile = null;
            let currentTopic = null; // { id: string, name: string, activity_id: number }
            let currentSessionId = null;
            let geminiChatContext = [];
            let tldrawApp = null;
            let tldrawScriptLoaded = false;
            let geminiIsThinking = false;
            let thinkingIndicatorId = null;

            // --- Helper Functions ---
            const sanitizeHTML = (str) => { /* ... */ const temp = document.createElement('div'); temp.textContent = str || ''; return temp.innerHTML; };
            const getInitials = (profile, email) => { /* ... */ if (!profile) return email ? email[0].toUpperCase() : '?'; let i = (profile.first_name?.[0]||'')+(profile.last_name?.[0]||''); return i.toUpperCase() || profile.username?.[0].toUpperCase() || email?.[0].toUpperCase() || '?'; };
            const showToast = (message, type = 'info', duration = 4000) => { /* ... */ if (!toastEl || !toastMessageEl) return; toastMessageEl.textContent = message; const icon = toastEl.querySelector('i'); icon.className = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-circle' : type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle'; toastEl.className = 'toast ' + type; toastEl.classList.add('show'); setTimeout(() => toastEl.classList.remove('show'), duration); };
            const renderMarkdown = (element, markdownText) => { /* ... */ try { if (!element) return; element.innerHTML = marked.parse(markdownText || '', { breaks: true, gfm: true }); if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') { setTimeout(() => window.MathJax.typesetPromise([element]).catch(e=>console.error("MathJax error:",e)), 50); } } catch (e) { console.error("Markdown rendering error:", e); if (element) element.innerHTML = `<p style="color: red;">Chyba zobrazení obsahu.</p>`; }};
            const autoResizeTextarea = () => { /* ... */ chatInput.style.height = 'auto'; chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px'; };
            const generateSessionId = () => `session_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
            const formatTimestamp = (date) => date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
            const updateAIStatus = (text) => { if (aiStatusText) aiStatusText.textContent = text; };

             // --- Initialization Functions ---

             /**
              * Dynamically loads the tldraw script and sets a flag when done.
              */
             const loadTldrawScript = () => {
                 return new Promise((resolve, reject) => {
                     if (document.querySelector(`script[src="${TLDR AW_CDN_URL}"]`)) {
                         console.log("tldraw script tag already exists.");
                         // Assume it might load, or check if window.tldraw exists after a delay
                         setTimeout(() => {
                             if (typeof tldraw !== 'undefined') {
                                 tldrawScriptLoaded = true;
                                 resolve();
                             } else {
                                 console.warn("tldraw script tag existed, but library not found globally after delay.");
                                 reject(new Error("tldraw library failed to initialize globally."));
                             }
                         }, 500); // Wait 500ms
                         return;
                     }

                     console.log("Dynamically loading tldraw script...");
                     const script = document.createElement('script');
                     script.src = TLDR AW_CDN_URL;
                     script.async = true;
                     script.onload = () => {
                         console.log("tldraw script loaded successfully via dynamic load.");
                         tldrawScriptLoaded = true;
                         resolve();
                     };
                     script.onerror = (err) => {
                         console.error("Failed to load tldraw script:", err);
                         tldrawScriptLoaded = false;
                         reject(err);
                     };
                     document.body.appendChild(script);
                 });
             };

            /**
             * Initializes the tldraw instance if the script is loaded and container exists.
             */
            const initializeTldrawInstance = () => {
                 // Check if already initialized
                 if (tldrawApp) {
                     console.log("tldraw instance already exists.");
                     return true;
                 }

                 // Check if script *should* be loaded (flag set by loadTldrawScript)
                 if (!tldrawScriptLoaded) {
                     console.warn("Attempted to init tldraw instance, but script not loaded yet.");
                     if (tldrawWrapper) tldrawWrapper.innerHTML = "<p>Čekání na načtení knihovny pro došku...</p>";
                     return false;
                 }

                 // Check if the global `tldraw` object is available
                 if (typeof tldraw === 'undefined' || !tldraw.Tldraw) {
                      console.error("tldraw script loaded, but global 'tldraw.Tldraw' is not defined!");
                      if (tldrawWrapper) tldrawWrapper.innerHTML = "<p style='color: red;'>Chyba: Knižnice tldraw není správně definována.</p>";
                      return false;
                 }

                 const containerElement = document.getElementById('tldraw-wrapper'); // Use the wrapper ID
                 console.log("Attempting to initialize tldraw instance...");
                 console.log("tldraw global object check:", typeof tldraw, tldraw.Tldraw);
                 console.log("tldraw container check:", containerElement);

                 if (tldraw.Tldraw && containerElement) {
                     try {
                         console.log("Creating tldraw instance...");
                         containerElement.innerHTML = ''; // Clear placeholder
                         tldrawApp = new tldraw.Tldraw({
                             container: containerElement,
                             showUI: true,
                             readOnly: false,
                             darkMode: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
                         });
                         console.log("tldraw instance CREATED successfully.", tldrawApp);
                         return true; // Success
                     } catch (error) {
                         console.error("Failed to initialize tldraw INSTANCE:", error);
                         if (containerElement) {
                             containerElement.innerHTML = "<p style='padding: 1rem; color: red;'>Chyba při vytváření instance interaktivní došky.</p>";
                         }
                         return false; // Failure
                     }
                 } else {
                     console.warn("Could not initialize tldraw - library or container missing at the time of call.");
                     if (!containerElement) console.error("Element #tldraw-wrapper not found!");
                     if (containerElement) containerElement.innerHTML = "<p style='padding: 1rem; color: orange;'>Interaktivní doška není dostupná (knihovna/kontejner nenalezen).</p>";
                     return false; // Failure
                 }
             };

            const initializeApp = async () => {
                 // Initialize Supabase
                 try {
                     if (window.supabase?.createClient) {
                         supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                         console.log("Supabase client initialized.");
                     } else {
                         throw new Error("Supabase library not loaded correctly.");
                     }
                 } catch (error) {
                     console.error("Supabase initialization failed:", error);
                     showToast("Kritická chyba: Nepodařilo se připojit k databázi.", "error", 15000);
                     // Optionally disable UI elements
                     return; // Stop initialization
                 }

                 setupEventListeners();
                 initTooltips();

                 // Load tldraw script in parallel with user profile
                 const tldrawPromise = loadTldrawScript().catch(err => {
                     console.error("tldraw script loading failed permanently.", err);
                     showToast("Nepodařilo se načíst knihovnu pro interaktivní došku.", "error", 7000);
                     // Update UI to show whiteboard is unavailable
                     if (tldrawWrapper) tldrawWrapper.innerHTML = "<p style='padding: 1rem; color: red;'>Interaktivní doška nemohla být načtena.</p>";
                 });
                 const profilePromise = loadUserProfile();

                 // Wait for both profile loading and potentially tldraw loading
                 await Promise.all([profilePromise, tldrawPromise]);

                 if (currentUser) {
                     // Attempt to initialize tldraw instance now that script *should* be loaded
                     initializeTldrawInstance();
                     // Load first topic
                     await loadNextTopicFromPlan();
                 } else {
                     currentTopicDisplay.innerHTML = '<span class="placeholder"><i class="fas fa-sign-in-alt"></i> Pro zahájení výuky se prosím přihlaste.</span>';
                     loadNextTopicBtn.disabled = true;
                     hideLearningUI();
                 }
             };

            const loadUserProfile = async () => { /* ... same ... */ };
            const updateUserInfoUI = () => { /* ... same ... */ };
            const setupEventListeners = () => {
                /* ... sidebar toggles ... */
                if (mobileMenuToggle) mobileMenuToggle.addEventListener('click', () => { sidebar?.classList.toggle('active'); sidebarOverlay?.classList.toggle('active'); });
                if (sidebarOverlay) sidebarOverlay.addEventListener('click', () => { sidebar?.classList.remove('active'); sidebarOverlay?.classList.remove('active'); });
                window.addEventListener('resize', () => { if (window.innerWidth > 576 && sidebar?.classList.contains('active')) { sidebar.classList.remove('active'); sidebarOverlay?.classList.remove('active'); } });

                if (loadNextTopicBtn) loadNextTopicBtn.addEventListener('click', loadNextTopicFromPlan);
                if (sendButton) sendButton.addEventListener('click', handleSendMessage);
                if (chatInput) { /* ... keypress, input events ... */ chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } }); chatInput.addEventListener('input', autoResizeTextarea); }
                if (saveChatBtn) saveChatBtn.addEventListener('click', saveChatToPDF);
                if (clearChatBtn) clearChatBtn.addEventListener('click', confirmClearChat);
                if (nextStepBtn) nextStepBtn.addEventListener('click', requestNextStep);

                // Tab switching
                interactionTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const targetTabId = tab.dataset.tab;

                        interactionTabs.forEach(t => t.classList.remove('active'));
                        tabContents.forEach(c => c.classList.remove('active'));

                        tab.classList.add('active');
                        const targetContent = document.getElementById(targetTabId + '-content');
                        if (targetContent) {
                            targetContent.classList.add('active');
                        }
                         // Auto-focus input when switching to chat tab
                         if (targetTabId === 'chat-tab') {
                             chatInput.focus();
                         }
                    });
                });
             };
            const initTooltips = () => { /* ... same ... */ };

            // --- Topic Loading and Learning Session ---
             const loadNextTopicFromPlan = async () => { /* ... same (uses startLearningSession) ... */ if (!currentUser || !supabase) { showToast("Nelze načíst téma, nejste přihlášeni.", "warning"); return; } currentTopicDisplay.innerHTML = '<span class="placeholder"><i class="fas fa-spinner fa-spin"></i> Hledám další téma v plánu...</span>'; loadNextTopicBtn.disabled = true; hideLearningUI(); try { const { data: activePlan, error: planError } = await supabase.from('study_plans').select('id').eq('user_id', currentUser.id).eq('status', 'active').order('created_at', { ascending: false }).limit(1).maybeSingle(); if (planError) throw planError; if (!activePlan) throw new Error("Nebyl nalezen žádný aktivní studijní plán."); const { data: nextActivity, error: activityError } = await supabase.from('plan_activities').select('id, title, day_of_week, time_slot').eq('plan_id', activePlan.id).eq('completed', false).order('day_of_week', { ascending: true }).order('time_slot', { ascending: true }).limit(1).maybeSingle(); if (activityError) throw activityError; if (!nextActivity) throw new Error("Všechny aktivity v plánu jsou dokončeny!"); currentTopic = { id: `activity_${nextActivity.id}`, name: nextActivity.title, activity_id: nextActivity.id }; currentTopicDisplay.innerHTML = `Aktuální téma: <strong>${sanitizeHTML(currentTopic.name)}</strong>`; await startLearningSession(); } catch (error) { console.error("Chyba při načítání dalšího tématu:", error); showToast(error.message || "Nepodařilo se načíst další téma.", "error"); currentTopicDisplay.innerHTML = `<span class="placeholder" style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> ${error.message || 'Chyba načítání tématu.'}</span>`; } finally { loadNextTopicBtn.disabled = false; } };
             const startLearningSession = async () => { /* ... same (includes deleting history, resetting tldraw) ... */ if (!currentTopic || !currentUser || !supabase) { console.error("startLearningSession called without necessary data"); return; } console.log(`Preparing to start session for topic: ${currentTopic.name} (Activity ID: ${currentTopic.activity_id})`); console.log(`Deleting previous chat history for user: ${currentUser.id}...`); try { const { error: deleteError } = await supabase .from('chat_history') .delete() .eq('user_id', currentUser.id); if (deleteError) { console.error("Error deleting previous chat history, continuing session anyway:", deleteError); showToast("Nepodařilo se vymazat starou historii chatu, může se zobrazit smíchaná.", "warning", 6000); } else { console.log("Previous chat history deleted successfully."); } } catch (delCatchError) { console.error("Unexpected error during chat history deletion:", delCatchError); showToast("Neočekávaná chyba při mazání staré historie.", "error", 6000); } currentSessionId = generateSessionId(); console.log(`Starting NEW session ${currentSessionId} for topic: ${currentTopic.name}`); updateAIStatus(`Vysvětluje: ${currentTopic.name}`); // Reset content and state
 explanationDisplay.innerHTML = '<div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Požaduji úvodní vysvětlení od AI...</div>'; nextStepBtn.style.display = 'none'; chatMessages.innerHTML = ''; geminiChatContext = []; // Show relevant UI parts
 // Attempt to initialize tldraw instance AGAIN here, in case it failed earlier
 if (!tldrawApp) {
     initializeTldrawInstance(); // Try again
 }
 // Reset tldraw canvas if the instance exists
 if (tldrawApp && tldrawApp.resetDocument) {
      try { tldrawApp.resetDocument(); console.log("tldraw reset for new session."); } catch (e) { console.warn("Could not reset tldraw:", e); }
 }
 // Add first message and save it
 await addChatMessage(`Ahoj! Jsem připravený ti pomoct s tématem: **${sanitizeHTML(currentTopic.name)}**. Začneme se základy. Řekni **"pokračuj"** nebo polož otázku.`, 'gemini', true); // Request initial explanation
 updateGeminiThinkingState(true); await sendToGemini(`Začni vysvětlovat ZÁKLADY tématu "${currentTopic.name}" pro 9. třídu ZŠ (přijímačky CERMAT). Rozděl to na malé kroky. Toto je PRVNÍ KROK.`, 'explanation'); // State updated in finally block
 nextStepBtn.style.display = 'inline-flex'; };
             const hideLearningUI = () => { /* ... hides elements ... */ explanationDisplay.innerHTML = ''; nextStepBtn.style.display = 'none'; chatMessages.innerHTML = ''; if (tldrawApp && tldrawApp.resetDocument) tldrawApp.resetDocument(); currentTopic = null; currentSessionId = null; geminiChatContext = []; updateAIStatus('Čekání na téma...'); };
             const requestNextStep = async () => { /* ... same ... */ };

             // --- Chat Functionality ---
             const addChatMessage = async (message, sender, saveToDb = false, timestamp = new Date()) => { /* ... same ... */ };
             const updateGeminiThinkingState = (isThinking) => { /* ... same ... */ };
             const addThinkingIndicator = () => { /* ... same ... */ };
             const removeThinkingIndicator = () => { /* ... same ... */ };
             const handleSendMessage = async () => { /* ... same ... */ };
             const confirmClearChat = () => { /* ... same ... */ };
             const clearCurrentChatSessionHistory = async () => { /* ... same ... */ };
             const saveChatToPDF = async () => { /* ... same ... */ };


            // --- Gemini Interaction ---
            const sendToGemini = async (promptText, targetArea) => {
                 if (!GEMINI_API_KEY || GEMINI_API_KEY.startsWith('YOUR_')) { showToast("Chyba: Chybí API klíč.", "error", 8000); handleGeminiError("Chybí API klíč.", targetArea, new Date()); return; }
                 if (!currentTopic) { showToast("Chyba: Není vybráno téma.", "error"); handleGeminiError("Není vybráno téma.", targetArea, new Date()); return; }

                 console.log(`Posílám Gemini (cíl: ${targetArea}): "${promptText}"`);
                 updateAIStatus('Přemýšlím...');
                 const timestamp = new Date();
                 // updateGeminiThinkingState(true) is called before this function

                 const systemInstructionText = `Jsi AI Tutor "Justax", expert na matematiku pro 9. třídu ZŠ v ČR (přijímačky CERMAT). Vyučuješ téma: "${currentTopic.name}". Tvůj styl je PŘÁTELSKÝ, TRPĚLIVÝ a PODROBNÝ. Vysvětluj krok za krokem, používej příklady. Důsledně používej Markdown (nadpisy **, seznamy *, tučně **, kurzívu *) a MathJax (blok: $$...$$, inline: \\(...\\)). Odpovídej VŽDY ČESKY. Vyzývej studenta k použití interaktivní došky ("Zkus si načrtnout...", "Napiš si na došku..."). Nekresli na došku sám. Aktivně pokládej otázky. Udržuj odpovědi zaměřené na jeden krok/myšlenku.`;

                 // Build context for API
                 const historyForApi = [...geminiChatContext];
                 const currentRequestContent = { role: "user", parts: [{ text: promptText }] };

                 // Clean history: Remove system instructions if accidentally included
                 const cleanHistory = historyForApi.filter(item => item.role === 'user' || item.role === 'model');

                 const requestBody = {
                     contents: [currentRequestContent], // Only the current user prompt
                     systemInstruction: { parts: [{ text: systemInstructionText }] },
                     history: cleanHistory.length > 0 ? cleanHistory : undefined,
                     generationConfig: { temperature: 0.6, topP: 0.95, topK: 40, maxOutputTokens: 4096 },
                     safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" } ]
                 };

                 try {
                     const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                     if (!response.ok) {
                         const errorBody = await response.json();
                         console.error("Gemini API Error Response:", errorBody);
                         throw new Error(errorBody.error?.message || `Chyba API (${response.status})`);
                     }
                     const data = await response.json();
                     console.log("Gemini API Raw Response:", data); // Log raw response

                     // Check for blocked content or missing parts
                     if (data.candidates && data.candidates[0].finishReason === "SAFETY") {
                         console.warn("Gemini response blocked due to safety settings.");
                         throw new Error("Odpověď byla blokována z bezpečnostních důvodů.");
                     }
                      if (!data.candidates || !data.candidates[0]?.content?.parts || !data.candidates[0]?.content?.parts[0]?.text) {
                          console.error("Invalid response structure from Gemini:", data);
                          throw new Error('Neplatná nebo prázdná odpověď od Gemini.');
                      }

                     const geminiResponseText = data.candidates[0].content.parts[0].text;
                     geminiChatContext.push({ role: "model", parts: [{ text: geminiResponseText }] }); // Add AI response to context
                     processGeminiResponse(geminiResponseText, targetArea, timestamp);
                     updateAIStatus(`Vysvětluje: ${currentTopic.name}`);

                 } catch (error) {
                     console.error('Chyba komunikace s Gemini:', error);
                     showToast(`Chyba AI: ${error.message}`, "error");
                     handleGeminiError(error.message, targetArea, timestamp);
                     updateAIStatus('Nastala chyba');
                 } finally {
                     updateGeminiThinkingState(false); // Ensure thinking state is always turned off
                 }
            };

            // --- Processing Gemini Response ---
            const processGeminiResponse = (responseText, targetArea, timestamp) => {
                 removeThinkingIndicator();
                 const mainExplanationText = responseText.trim();

                 if (targetArea === 'explanation') {
                      const loadingDiv = explanationDisplay.querySelector('.loading-placeholder');
                      if (loadingDiv) loadingDiv.remove(); // Remove placeholder/loader

                       // Clear previous content ONLY if it was the initial load message
                       if (explanationDisplay.querySelector('.empty-state')) {
                            explanationDisplay.innerHTML = '';
                       }

                      // Append as a new step
                      const stepDiv = document.createElement('div');
                      stepDiv.className = 'step';
                      renderMarkdown(stepDiv, mainExplanationText);
                      explanationDisplay.appendChild(stepDiv);
                      // Scroll to the new step
                       setTimeout(() => stepDiv.scrollIntoView({ behavior: 'smooth', block: 'end' }), 100);
                      // Save response to DB associated with the chat
                      addChatMessage(responseText, 'gemini', true, timestamp);
                      if (nextStepBtn) nextStepBtn.style.display = 'inline-flex';
                 } else { // Chat or fallback
                      addChatMessage(mainExplanationText, 'gemini', true, timestamp);
                 }
            };

            // --- Handling Gemini Errors ---
            const handleGeminiError = (errorMessage, targetArea, timestamp) => {
                 removeThinkingIndicator();
                 updateGeminiThinkingState(false);
                 const errorText = `Omlouvám se, při komunikaci s AI nastala chyba. Zkuste to prosím znovu.\n*(Detail: ${errorMessage})*`;

                 if (targetArea === 'explanation') {
                      const loadingDiv = explanationDisplay.querySelector('.loading-placeholder');
                      if (loadingDiv) loadingDiv.remove();
                      const errorDiv = document.createElement('div');
                      errorDiv.className = 'step'; // Display as a step for consistency
                      errorDiv.style.color = 'var(--danger)';
                      errorDiv.style.fontWeight = '500';
                      renderMarkdown(errorDiv, errorText); // Use markdown rendering
                      explanationDisplay.appendChild(errorDiv);
                       setTimeout(() => errorDiv.scrollIntoView({ behavior: 'smooth', block: 'end' }), 100);
                      addChatMessage(errorText, 'gemini', true, timestamp);
                      if (nextStepBtn) {
                           nextStepBtn.disabled = false;
                           nextStepBtn.innerHTML = '<i class="fas fa-redo"></i> Požádat znovu';
                           nextStepBtn.style.display = 'inline-flex';
                      }
                 } else {
                      addChatMessage(errorText, 'gemini', true, timestamp);
                 }
            };

            // --- Run Application ---
            initializeApp();
        });
    </script>

</body>
</html>