<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Výuka na Tabuli</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        if (typeof window.MathJax === 'undefined') {
            window.MathJax = {
                tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']], processEscapes: true },
                options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], ignoreHtmlClass: 'tex2jax_ignore' },
                startup: { ready: () => { MathJax.startup.defaultReady(); MathJax.startup.promise.then(() => console.log('MathJax loaded and ready.')); } }
            };
        } else { console.warn("window.MathJax already defined."); }
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@excalidraw/excalidraw@0.17.3/dist/excalidraw.production.min.js" crossorigin></script>

    <style>
        /* --- CSS Styly --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; scroll-behavior: smooth; }
        :root {
            --primary-rgb: 67, 97, 238; --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9;
            --success: #06d6a0; --danger: #f72585; --warning: #f8961e; --info: #4cc9f0;
            --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d; --gray-light: #dee2e6;
            --gray-dark: #343a40; --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3);
            --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee); --white: #ffffff;
            --sidebar-width: 260px; --transition-speed: 0.3s; --card-radius: 14px;
            --shadow-sm: 0 2px 6px rgba(0, 0, 0, 0.05); --shadow-md: 0 5px 12px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1); --text-primary: #2d3748;
            --text-secondary: #4a5568; --text-muted: #718096; --page-bg: #f0f2f5; /* Světlejší pozadí stránky */
            --panel-bg: var(--white); --avatar-size: 38px; --pink-board-bg: #FFD1DC; /* Růžová pro tabuli */
            --black-text: #000000; /* Černá pro text/tvary */
        }
        body { background-color: var(--page-bg); color: var(--text-primary); min-height: 100vh; display: flex; overflow: hidden; font-size: 15px; }

        /* Sidebar (beze změny) */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 1050; box-shadow: var(--shadow-lg); transition: transform var(--transition-speed) ease, width var(--transition-speed) ease; }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; } .sidebar-logo { font-size: 1.6rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.8rem; transition: transform 0.2s ease; } .sidebar-logo:hover { transform: scale(1.03); } .sidebar-logo i { font-size: 1.8rem; } .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; } .sidebar-item { margin-bottom: 0.5rem; } .sidebar-link { display: flex; align-items: center; padding: 0.85rem 1.1rem; color: rgba(255, 255, 255, 0.9); text-decoration: none; border-radius: 10px; transition: all 0.2s ease; font-weight: 500; position: relative; } .sidebar-link i { margin-right: 0.8rem; font-size: 1.25rem; width: 24px; text-align: center; transition: transform 0.2s ease; } .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.2); color: var(--white); } .sidebar-link:hover i { transform: scale(1.1); } .sidebar-link.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 65%; background-color: var(--white); border-radius: 0 4px 4px 0; } .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.85rem; color: rgba(255, 255, 255, 0.7); text-align: center; } .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.1); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.15); } .user-avatar { width: 42px; height: 42px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.8rem; font-weight: 500; overflow: hidden; color: var(--white); border: 2px solid rgba(255, 255, 255, 0.4); } .user-avatar img { width: 100%; height: 100%; object-fit: cover; } .user-info { flex-grow: 1; line-height: 1.3; } .user-name { font-weight: 600; font-size: 0.95rem; } .user-role { font-size: 0.8rem; opacity: 0.8; }

        /* Main Content Area */
        main { flex: 1; margin-left: var(--sidebar-width); transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); height: 100vh; display: flex; flex-direction: column; overflow: hidden; background-color: var(--page-bg); }
        .main-header { padding: 1rem 1.75rem; background-color: var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; z-index: 100; border-bottom: 1px solid var(--gray-light); }
        .header-content h1 { font-size: 1.5rem; font-weight: 600; color: var(--dark); margin: 0; } .header-actions button, .header-actions a { font-size: 0.9rem; padding: 0.6rem 1.2rem; }
        .topic-bar { padding: 0.9rem 1.75rem; background-color: var(--light); border-bottom: 1px solid var(--gray-light); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; flex-shrink: 0; }
        #current-topic-display { font-size: 1.05rem; font-weight: 500; color: var(--text-secondary); } #current-topic-display strong { color: var(--primary); font-weight: 600; } #current-topic-display .placeholder { font-style: italic; color: var(--text-muted); } #current-topic-display .fa-spinner { margin-right: 0.5rem; }

        /* Learning Interface - New Layout */
        .learning-interface {
            flex-grow: 1;
            display: flex;
            overflow: hidden;
            padding: 1.2rem; /* Menší padding */
            gap: 1.2rem;     /* Menší mezera */
        }

        /* Excalidraw Area */
        .excalidraw-area {
            flex-grow: 3; /* Zabere více místa */
            display: flex;
            flex-direction: column;
            background-color: var(--panel-bg);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            border: 1px solid var(--gray-light);
            height: 100%; /* Plná výška flex kontejneru */
            min-height: 0;
            position: relative; /* Pro loading overlay */
        }
        .excalidraw-header { padding: 0.8rem 1.25rem; border-bottom: 1px solid var(--gray-light); display: flex; align-items: center; justify-content: space-between; background-color: #fdfdff; flex-shrink: 0; }
        .excalidraw-header h2 { font-size: 1.1rem; font-weight: 600; color: var(--dark); margin: 0; display: flex; align-items: center; gap: 0.7rem;}
        .excalidraw-header h2 i { color: var(--primary); }
        .excalidraw-header-controls button { font-size: 0.8rem; padding: 0.4rem 0.8rem;} /* Menší tlačítka */
        #excalidraw-container {
            flex-grow: 1;
            position: relative;
            overflow: auto; /* Umožní scrolling celé plochy */
            min-height: 0;
            background-color: var(--pink-board-bg); /* <<< Růžové pozadí >>> */
            border-radius: 0 0 var(--card-radius) var(--card-radius);
        }
        #excalidraw-container > .excalidraw-wrapper { width: 100% !important; height: 100% !important; display: flex !important; flex-direction: column !important; }
        #excalidraw-container .excalidraw { width: 100% !important; height: auto !important; /* Výška bude dána obsahem */ min-height: 100%; /* Minimálně výška kontejneru */ border: none !important; }
        #excalidraw-container .loading-placeholder { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; color: var(--text-muted); background-color: rgba(255, 255, 255, 0.8); z-index: 5; }
        #excalidraw-container .loading-placeholder i { font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem; animation: spinPulse 2s infinite ease-in-out; }
        #excalidraw-container .loading-placeholder p { font-size: 1rem; }
        @keyframes spinPulse { 0% { transform: scale(1) rotate(0deg); opacity: 0.7; } 50% { transform: scale(1.1) rotate(180deg); opacity: 1; } 100% { transform: scale(1) rotate(360deg); opacity: 0.7; } }

        /* Chat Panel */
        .chat-panel {
            width: 360px; /* Pevnější šířka pro chat */
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background-color: var(--panel-bg);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            border: 1px solid var(--gray-light);
            height: 100%; /* Plná výška flex kontejneru */
            min-height: 0;
        }
        .chat-header { padding: 0.9rem 1.25rem; border-bottom: 1px solid var(--gray-light); background-color: #fdfdff; font-size: 1.1rem; font-weight: 600; color: var(--dark); display: flex; align-items: center; gap: 0.7rem; flex-shrink: 0; }
        .chat-header i { color: var(--secondary); }

        /* Chat Area (beze změny vnitřního stylu) */
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        .chat-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; scrollbar-color: var(--gray-light) var(--panel-bg); min-height: 0; }
        .chat-messages::-webkit-scrollbar { width: 8px; } .chat-messages::-webkit-scrollbar-track { background: var(--panel-bg); } .chat-messages::-webkit-scrollbar-thumb { background-color: var(--gray-light); border-radius: 4px; border: 2px solid var(--panel-bg); }
        .chat-message { display: flex; gap: 0.7rem; max-width: 95%; align-items: flex-end; margin-bottom: 1rem; }
        .chat-message.user { margin-left: auto; flex-direction: row-reverse; }
        .message-avatar { width: var(--avatar-size); height: var(--avatar-size); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 0.9rem; flex-shrink: 0; box-shadow: var(--shadow-sm); border: 2px solid var(--panel-bg); }
        .chat-message.user .message-avatar { background: var(--success); color: white; } .chat-message.model .message-avatar { background: var(--primary); color: white; }
        .message-bubble { padding: 0.7rem 1.1rem; border-radius: 16px; line-height: 1.55; word-wrap: break-word; box-shadow: var(--shadow-sm); position: relative; background-color: var(--white); color: var(--text-primary); border: 1px solid #eef2f7; }
        .chat-message.model .message-bubble { border-bottom-left-radius: 5px; background: #f8faff; } .chat-message.user .message-bubble { background: var(--gradient-1); color: white; border: none; border-bottom-right-radius: 5px; }
        .message-timestamp { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; display: block; text-align: left; opacity: 0.8; } .chat-message.user .message-timestamp { text-align: right; }
        .message-thinking-indicator { background: var(--white); display: flex; align-items: center; padding: 0.7rem 1rem; border-radius: 16px; box-shadow: var(--shadow-sm); border: 1px solid #eef2f7; width: fit-content; border-bottom-left-radius: 5px;}
        .typing-dot { width: 6px; height: 6px; background-color: var(--gray); border-radius: 50%; margin: 0 2px; display: inline-block; animation: typing 1.3s infinite ease-in-out; } .typing-dot:nth-child(2) { animation-delay: 0.2s; } .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.5; } 30% { transform: translateY(-3px); opacity: 1; } }
        .chat-input-area { flex-shrink: 0; padding: 0.8rem 1rem; background-color: #f8f9fa; border-top: 1px solid var(--gray-light); display: flex; align-items: flex-end; gap: 0.7rem; }
        .chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--gray-light); border-radius: 18px; font-size: 0.9rem; resize: none; max-height: 110px; overflow-y: auto; transition: border-color 0.2s ease, box-shadow 0.2s ease; line-height: 1.4; background-color: var(--white); } .chat-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1); }
        .send-button { padding: 0 1rem; border-radius: 18px; font-weight: 600; font-size: 0.9rem; cursor: pointer; border: none; background: var(--gradient-1); color: white; transition: all 0.3s ease; flex-shrink: 0; height: 38px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); } .send-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(var(--primary-rgb), 0.2); } .send-button:active:not(:disabled) { transform: translateY(-1px); box-shadow: 0 3px 6px rgba(var(--primary-rgb), 0.15); } .send-button i { font-size: 1em; } .send-button .fa-spinner { margin: 0; }
        .chat-controls { flex-shrink: 0; padding: 0.4rem 1rem; font-size: 0.75rem; color: var(--text-muted); text-align: right; background-color: #f8f9fa; border-top: 1px solid var(--gray-light); } .chat-controls button { background:none; border:none; color: var(--text-muted); cursor:pointer; font-size: 0.9em; padding: 2px 5px; margin-left: 8px; transition: color 0.2s ease; } .chat-controls button:hover { color: var(--primary); }

        /* Common Elements */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.7rem 1.4rem; border-radius: 8px; font-weight: 500; font-size: 0.9rem; text-decoration: none; transition: all 0.25s ease; cursor: pointer; border: none; gap: 0.5rem; line-height: 1.5; }
        .btn-primary { background: var(--gradient-1); color: white; box-shadow: var(--shadow-sm); } .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); background: linear-gradient(135deg, var(--primary-light), var(--secondary)); }
        .btn-secondary { background-color: var(--white); color: var(--text-secondary); border: 1px solid var(--gray-light); box-shadow: var(--shadow-sm); } .btn-secondary:hover:not(:disabled) { background-color: #f8f9fa; color: var(--primary); border-color: var(--primary-light); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; background: var(--gray); color: var(--white); border: none; } .btn i { font-size: 1em; }
        .loading-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; text-align: center; font-style: italic; color: var(--text-muted); flex-grow: 1; min-height: 150px; } .loading-placeholder i { margin-bottom: 1rem; font-size: 2.2rem; color: var(--primary-light); animation: spin 1.5s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 2rem 1.5rem; color: var(--text-secondary); flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 150px; } .empty-state i { font-size: 3rem; margin-bottom: 1.25rem; color: var(--gray-light); opacity: 0.7; } .empty-state h3 { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.8rem; color: var(--dark); } .empty-state p { margin-bottom: 1.25rem; max-width: 450px; margin-left: auto; margin-right: auto; line-height: 1.55; }
        .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; color: var(--dark); font-size: 1.6rem; margin-right: 1rem; padding: 0.5rem; z-index: 1060; transition: color 0.2s ease; } .mobile-menu-toggle:hover { color: var(--primary); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.55); z-index: 1040; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(5px); } .sidebar-overlay.active { display: block; opacity: 1; }
        .toast { position: fixed; bottom: 20px; right: 20px; background-color: var(--white); color: var(--text-primary); border-radius: 8px; padding: 1rem 1.2rem; box-shadow: var(--shadow-lg); max-width: 320px; z-index: 1001; display: flex; align-items: center; transform: translateX(calc(100% + 30px)); opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); } .toast.show { transform: translateX(0); opacity: 1; } .toast.success { border-left: 4px solid var(--success); } .toast.success i { color: var(--success); } .toast.error { border-left: 4px solid var(--danger); } .toast.error i { color: var(--danger); } .toast.warning { border-left: 4px solid var(--warning); } .toast.warning i { color: var(--warning); } .toast.info { border-left: 4px solid var(--info); } .toast.info i { color: var(--info); } .toast i { margin-right: 0.8rem; font-size: 1.3rem; }

        /* MathJax specific (if needed) */
        mjx-math { display: inline-block; }

        /* Responsiveness */
        @media (max-width: 1200px) {
            .chat-panel { width: 320px; }
            .learning-interface { padding: 1rem; gap: 1rem; }
        }
        @media (max-width: 992px) {
            :root { --sidebar-width: 80px; }
            .sidebar { width: 80px; }
            .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; }
            .sidebar-link i { margin-right: 0; font-size: 1.5rem; } .sidebar-logo i { margin-right: 0; }
            .sidebar-header, .sidebar-link { justify-content: center; }
            .user-profile { justify-content: center; padding: 0.75rem 0; } .user-avatar { margin-right: 0; }
            main { margin-left: 80px; width: calc(100% - 80px); }
             /* Stack vertically on medium screens */
            .learning-interface { flex-direction: column; }
            .excalidraw-area { height: 60vh; /* Excalidraw gets more vertical space */ flex-grow: 1; order: 1;}
            .chat-panel { width: 100%; height: 40vh; /* Chat gets less */ flex-grow: 1; order: 2;}
            #excalidraw-container { min-height: 250px; }
        }
        @media (max-width: 768px) {
            .main-header { padding: 0.8rem 1.2rem; } .header-content h1 { font-size: 1.3rem; }
            .chat-panel { width: 100%; height: 45vh; }
            .excalidraw-area { height: 55vh; }
        }
        @media (max-width: 576px) {
            :root { --sidebar-width: 0; }
            .sidebar { transform: translateX(-100%); z-index: 1050; width: 260px; }
            .sidebar.active { transform: translateX(0); }
            .sidebar.active .sidebar-logo span, .sidebar.active .sidebar-link span, .sidebar.active .user-info, .sidebar.active .sidebar-footer { display: block; }
            .sidebar.active .sidebar-link i { margin-right: 0.75rem; font-size: 1.25rem; }
            .sidebar.active .sidebar-header, .sidebar.active .sidebar-link { justify-content: flex-start; }
            .sidebar.active .user-profile { justify-content: flex-start; padding: 1rem; }
            .sidebar.active .user-avatar { margin-right: 0.75rem; }
            main { margin-left: 0; width: 100%; }
            .mobile-menu-toggle { display: block; }
            .main-header { padding: 0.7rem 1rem; } .header-content h1 { font-size: 1.15rem; }
            .learning-interface { padding: 0.6rem; gap: 0.6rem; }
            .chat-panel { width: 100%; height: 40vh; } /* Even less height for chat on mobile */
            .excalidraw-area { height: 60vh; min-height: 200px; }
            .chat-input { padding: 0.6rem 0.9rem; font-size: 0.85rem; } .send-button { height: 36px; padding: 0 0.8rem; }
            .message-bubble { padding: 0.6rem 0.9rem; }
        }

        /* Dark Mode Styles (simplified, adjust as needed) */
        @media (prefers-color-scheme: dark) {
            :root { --white: #1a202c; --light: #2d3748; --dark: #e2e8f0; --gray-light: #4a5568; --text-primary: #e2e8f0; --text-secondary: #cbd5e0; --text-muted: #a0aec0; --dark-bg: #171923; --page-bg: #131720; --panel-bg: #1e2533; --pink-board-bg: #5e2134; /* Tmavší růžová pro dark mode */ }
            body { background-color: var(--dark-bg); } main { background-color: var(--page-bg); }
            .main-header { background-color: var(--panel-bg); border-bottom-color: var(--gray-light); }
            .mobile-menu-toggle { color: var(--dark); } .topic-bar { background-color: var(--light); border-bottom-color: var(--gray-light); }
            .excalidraw-area, .chat-panel { background-color: var(--panel-bg); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); border-color: var(--gray-light); }
            .excalidraw-header { background-color: #242c3b; border-bottom-color: var(--gray-light); }
            .chat-header { background-color: #242c3b; border-bottom-color: var(--gray-light); }
            #excalidraw-container { background-color: var(--pink-board-bg); }
            #excalidraw-container .loading-placeholder { background-color: rgba(30, 37, 51, 0.8); }
            .chat-messages { scrollbar-color: var(--gray) var(--panel-bg); } .chat-messages::-webkit-scrollbar-track { background: var(--panel-bg); } .chat-messages::-webkit-scrollbar-thumb { border-color: var(--panel-bg); }
            .message-avatar { border-color: var(--panel-bg); }
            .message-bubble { background-color: var(--light); color: var(--text-primary); border-color: #3b4458; }
            .chat-message.user .message-bubble { background: var(--gradient-2); color: #1a202c; }
            .message-thinking-indicator { background: var(--light); border-color: #3b4458;} .typing-dot { background-color: #8494a6; }
            .chat-input-area { background-color: #242c3b; border-top-color: var(--gray-light); }
            .chat-input { background-color: var(--dark-bg); color: var(--text-primary); border-color: var(--gray-light); } .chat-input::placeholder { color: var(--text-muted); }
            .chat-input:focus { box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.2); }
            .chat-controls { background-color: #242c3b; border-top-color: var(--gray-light); } .chat-controls button { color: var(--text-muted); } .chat-controls button:hover { color: var(--primary-light); }
            .btn-secondary { background-color: var(--light); color: var(--text-secondary); border-color: var(--gray-light); } .btn-secondary:hover:not(:disabled) { background-color: #4a5568; color: var(--white); border-color: #6c757d; }
            .btn:disabled { background: #4a5568; color: #a0aec0; }
            .empty-state i { color: #4a5568; } .toast { background-color: var(--panel-bg); border-color: var(--gray-light); color: var(--text-primary); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);}
        }
    </style>
</head>
<body>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header"> <a href="/" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
        <ul class="sidebar-menu">
             <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Dashboard</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li>
        </ul>
        <div class="user-profile"> <div class="user-avatar" id="user-avatar">?</div> <div class="user-info"> <div class="user-name" id="user-name">Načítání...</div> <div class="user-role">Student</div> </div> </div>
        <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main>
        <div class="main-header">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 1rem;"> <button class="mobile-menu-toggle" id="mobile-menu-toggle"> <i class="fas fa-bars"></i> </button> <h1>Výuka na tabuli</h1> </div>
                <div class="header-actions"> <a href="/dashboard/procvicovani/main.html" class="btn btn-secondary"> <i class="fas fa-times"></i> Ukončit výuku </a> </div>
            </div>
        </div>
        <div class="topic-bar">
             <div id="current-topic-display"><span class="placeholder">Načítám data...</span></div>
             <button class="btn btn-primary btn-tooltip" id="continue-btn" style="display: none;" title="Požádat AI o další část vysvětlení na tabuli">
                 <i class="fas fa-forward"></i> Pokračuj
             </button>
        </div>
        <div class="learning-interface" style="display: none;">
            <div class="excalidraw-area">
                <div class="excalidraw-header">
                    <h2><i class="fas fa-chalkboard"></i> Interaktivní tabule</h2>
                    </div>
                <div id="excalidraw-container">
                    <div class="loading-placeholder"><i class="fas fa-spinner"></i><p>Načítám kreslící plochu...</p></div>
                </div>
            </div>
            <div class="chat-panel">
                <div class="chat-header"><i class="fas fa-comments"></i> Chat s AI Tutorem</div>
                <section class="chat-area">
                     <div class="chat-messages" id="chat-messages">
                         <div class="empty-state">
                             <i class="fas fa-microphone-alt"></i>
                             <h3>Jsem tu pro tebe!</h3>
                             <p>Zeptej se mě na cokoli k aktuálnímu tématu, nebo klikni na "Pokračuj".</p>
                         </div>
                     </div>
                     <div class="chat-input-area">
                         <textarea class="chat-input" id="chat-input" placeholder="Zeptej se AI..." rows="1"></textarea>
                         <button class="send-button" id="send-button" title="Odeslat zprávu">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                     <div class="chat-controls">
                         <button id="clear-chat-btn" class="btn-tooltip" title="Vymazat historii tohoto chatu"> <i class="fas fa-trash-alt"></i> Vymazat </button>
                         | <button id="save-chat-btn" class="btn-tooltip" title="Uložit chat jako PDF"> <i class="fas fa-save"></i> Uložit PDF </button>
                     </div>
                </section>
            </div>
        </div>
    </main>
    <div class="toast" id="toast"> <i class="fas fa-info-circle"></i> <div id="toast-message">Operace úspěšná.</div> </div>

    <script>
        // Wrap the entire script in a try-catch block for robust error handling
        try {
            // --- Constants & Configuration ---
            const SUPABASE_URL = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
            const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // !!! Production: Use a secure method !!!
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            const EXCALIDRAW_SCENE_REGEX = /EXCALIDRAW_SCENE:\s*```json\s*(\[[\s\S]*?\])\s*```\s*/gim;
            const MAX_GEMINI_HISTORY_TURNS = 8; // Slightly reduced history for potentially larger scene data
            const VERTICAL_SPACING = 75; // Space between new content blocks on the board
            const PINK_BACKGROUND = "#FFD1DC"; // Růžová barva pozadí
            const BLACK_COLOR = "#000000"; // Černá barva pro prvky

            // --- DOM Elements Cache ---
            const uiElements = {
                userAvatar: document.getElementById('user-avatar'),
                userName: document.getElementById('user-name'),
                mobileMenuToggle: document.getElementById('mobile-menu-toggle'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                currentTopicDisplay: document.getElementById('current-topic-display'),
                excalidrawContainer: document.getElementById('excalidraw-container'),
                chatMessages: document.getElementById('chat-messages'),
                chatInput: document.getElementById('chat-input'),
                sendButton: document.getElementById('send-button'),
                saveChatBtn: document.getElementById('save-chat-btn'),
                clearChatBtn: document.getElementById('clear-chat-btn'),
                continueBtn: document.getElementById('continue-btn'), // Nové tlačítko
                toast: document.getElementById('toast'),
                toastMessage: document.getElementById('toast-message'),
                learningInterface: document.querySelector('.learning-interface'), // Updated selector
                 chatPanel: document.querySelector('.chat-panel'), // Updated selector
            };

            // --- Global State ---
            let state = {
                supabase: null,
                currentUser: null,
                currentProfile: null,
                currentTopic: null,
                currentPlanId: null,
                currentSessionId: null,
                geminiChatContext: [],
                excalidrawAPI: null,
                excalidrawElements: [], // Holds ALL elements for the infinite board
                excalidrawRoot: null,
                geminiIsThinking: false,
                thinkingIndicatorId: null,
                topicLoadInProgress: false,
                lowestY: 50, // Starting Y position for new content
            };

            // --- Utility Functions ---
            const sanitizeHTML = (str) => { /* ... (stejná jako předtím) ... */ const temp = document.createElement('div'); temp.textContent = str || ''; return temp.innerHTML; };
            const getInitials = (profile, email) => { /* ... (stejná jako předtím) ... */ if (!profile && !email) return '?'; let initials = ''; if (profile?.first_name) initials += profile.first_name[0]; if (profile?.last_name) initials += profile.last_name[0]; if (initials) return initials.toUpperCase(); if (profile?.username) return profile.username[0].toUpperCase(); if (email) return email[0].toUpperCase(); return 'U'; };
            const showToast = (message, type = 'info', duration = 4000) => { /* ... (stejná jako předtím) ... */ if (!uiElements.toast || !uiElements.toastMessage) return; console.log(`Toast (${type}): ${message}`); uiElements.toastMessage.textContent = message; const icon = uiElements.toast.querySelector('i'); uiElements.toast.className = 'toast ' + type; icon.className = `fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}`; uiElements.toast.style.transition = 'none'; uiElements.toast.style.transform = 'translateX(calc(100% + 30px))'; uiElements.toast.style.opacity = '0'; void uiElements.toast.offsetWidth; uiElements.toast.style.transition = 'all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55)'; uiElements.toast.classList.add('show'); setTimeout(() => uiElements.toast.classList.remove('show'), duration); };
            const renderMarkdown = (element, markdownText) => { /* ... (stejná jako předtím) ... */ if (!element) return; try { marked.setOptions({ gfm: true, breaks: true, }); element.innerHTML = marked.parse(markdownText || ''); } catch (e) { console.error("Markdown rendering error:", e); element.innerHTML = `<p style="color:red;">Chyba renderování Markdownu.</p><pre>${sanitizeHTML(markdownText)}</pre>`; } };
            const autoResizeTextarea = () => { /* ... (stejná jako předtím) ... */ if (!uiElements.chatInput) return; uiElements.chatInput.style.height = 'auto'; const scrollHeight = uiElements.chatInput.scrollHeight; const maxHeight = 110; uiElements.chatInput.style.height = `${Math.min(scrollHeight, maxHeight)}px`; uiElements.chatInput.style.overflowY = scrollHeight > maxHeight ? 'scroll' : 'hidden'; };
            const generateSessionId = () => `session_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
            const formatTimestamp = (date = new Date()) => date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
            const updateCurrentLowestY = () => {
                if (state.excalidrawElements.length === 0) {
                    state.lowestY = 50; // Reset if board is empty
                    return;
                }
                let maxEndY = 0;
                state.excalidrawElements.forEach(el => {
                    if (el && typeof el.y === 'number' && typeof el.height === 'number') {
                        maxEndY = Math.max(maxEndY, el.y + el.height);
                    }
                });
                state.lowestY = maxEndY + VERTICAL_SPACING; // Add spacing for the next block
                console.log(`Calculated next available Y: ${state.lowestY}`);
            };


            // --- Initialization Functions ---
            const initializeSupabase = () => { /* ... (stejná jako předtím) ... */ console.log("Initializing Supabase..."); try { if (typeof window.supabase === 'undefined' || typeof window.supabase.createClient !== 'function') { throw new Error("Supabase library not loaded or invalid."); } state.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); if (!state.supabase) { throw new Error("Supabase client creation failed."); } console.log("Supabase client initialized."); return true; } catch (error) { console.error("Supabase initialization failed:", error); showToast("Chyba připojení k databázi. Obnovte stránku.", "error", 10000); return false; } };
            const initializeUI = () => { /* ... (inicializace Excalidraw a listenerů) ... */ console.log("Initializing UI elements and Excalidraw..."); if (!initializeExcalidraw()) { showToast("Kritická chyba: Nepodařilo se inicializovat kreslící plochu!", "error", 10000); if (uiElements.learningInterface) uiElements.learningInterface.style.display = 'none'; if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder" style="color:var(--danger);">Chyba inicializace Excalidraw</span>'; return false; } setupEventListeners(); initTooltips(); manageUIState('initial'); return true; };
            const initializeApp = async () => { /* ... (stejná jako předtím) ... */ console.log("DOM Loaded. Initializing Justax AI Tutor (Board Mode)..."); if (!initializeSupabase()) return; if (!initializeUI()) return; console.log("Loading user profile..."); manageUIState('loadingUser'); await loadUserProfile(); if (state.currentUser) { console.log("User logged in, loading topic..."); await loadNextUncompletedTopic(); } else { handleLoggedOutUser(); } };

            // --- UI State Management ---
            const manageUIState = (mode) => {
                console.log("Managing UI State:", mode);
                const isLearning = ['learning', 'chatting', 'requestingExplanation'].includes(mode);
                const showLearningInterface = !!state.currentTopic || mode === 'loadingTopic' || mode === 'requestingExplanation';

                if (uiElements.learningInterface) {
                    uiElements.learningInterface.style.display = showLearningInterface ? 'flex' : 'none';
                }

                // Handle initial/error states for chat
                 if (uiElements.chatMessages && !isLearning && mode !== 'loadingUser') {
                     let emptyStateHTML = '';
                     switch (mode) {
                        case 'initial':
                        case 'loadingUser':
                             emptyStateHTML = "<div class='empty-state'><i class='fas fa-user-circle'></i><h3>Načítám profil...</h3></div>"; break;
                        case 'loggedOut':
                             emptyStateHTML = "<div class='empty-state'><i class='fas fa-sign-in-alt'></i><h3>Nejste přihlášeni</h3><p>Přihlaste se prosím.</p></div>"; break;
                        case 'noPlan':
                             emptyStateHTML = "<div class='empty-state'><i class='fas fa-calendar-times'></i><h3>Žádný aktivní plán</h3><p>Vytvořte si plán v sekci Procvičování.</p></div>"; break;
                        case 'planComplete':
                             emptyStateHTML = "<div class='empty-state'><i class='fas fa-check-circle'></i><h3>Plán dokončen</h3><p>Gratulujeme!</p></div>"; break;
                        case 'error':
                             emptyStateHTML = "<div class='empty-state'><i class='fas fa-exclamation-triangle'></i><h3>Chyba</h3><p>Při načítání dat došlo k chybě.</p></div>"; break;
                        default: emptyStateHTML = ''; // Keep existing messages if learning/chatting
                     }
                     // Only update if not already learning/chatting OR if there are no messages yet
                     if (emptyStateHTML || uiElements.chatMessages.children.length === 0) {
                        uiElements.chatMessages.innerHTML = emptyStateHTML;
                     }
                 }

                // Update Excalidraw view mode
                if (state.excalidrawAPI?.updateScene) {
                    try {
                        // Always allow interaction when learning/chatting
                        const viewModeEnabled = !isLearning;
                        state.excalidrawAPI.updateScene({ appState: { viewModeEnabled: viewModeEnabled } });
                    } catch (e) { console.error("Error setting Excalidraw view mode:", e); }
                }
                manageButtonStates();
            };
            const manageButtonStates = () => {
                const canInteract = !!state.currentTopic && !state.geminiIsThinking && !state.topicLoadInProgress;

                if (uiElements.sendButton) {
                    uiElements.sendButton.disabled = !canInteract;
                    uiElements.sendButton.innerHTML = state.geminiIsThinking ? '<i class="fas fa-spinner fa-spin"></i>' : '<i class="fas fa-paper-plane"></i>';
                }
                 if (uiElements.continueBtn) {
                    uiElements.continueBtn.disabled = !canInteract;
                    uiElements.continueBtn.style.display = canInteract ? 'inline-flex' : 'none'; // Show only when interaction is possible
                 }
                if (uiElements.chatInput) {
                    uiElements.chatInput.disabled = !canInteract;
                }
            };

             // --- Excalidraw Functions ---
             const initializeExcalidraw = () => {
                 console.log("Initializing Excalidraw...");
                 const container = uiElements.excalidrawContainer;
                 if (!container) { console.error("Excalidraw container not found!"); return false; }
                 if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof ExcalidrawLib === 'undefined') { console.error("React, ReactDOM, or Excalidraw library not loaded!"); container.innerHTML = '<p style="color:red; padding: 1rem;">Chyba: Potřebné knihovny (React, Excalidraw) nebyly načteny.</p>'; return false; }
                 try {
                     container.innerHTML = '<div class="loading-placeholder"><i class="fas fa-spinner"></i><p>Načítám kreslící plochu...</p></div>';
                     if (state.excalidrawRoot) { console.warn("Excalidraw already initialized, unmounting first."); state.excalidrawRoot.unmount(); state.excalidrawRoot = null; state.excalidrawAPI = null; }

                     state.excalidrawRoot = ReactDOM.createRoot(container);
                     const initialData = {
                         appState: {
                             viewBackgroundColor: PINK_BACKGROUND, // <<< Růžové pozadí >>>
                             currentItemFontFamily: 2, // Helvetica
                             currentItemFontSize: 24,
                             theme: 'light',
                             viewModeEnabled: true,
                             gridSize: null, // Vypneme mřížku
                             currentItemStrokeColor: BLACK_COLOR // Default stroke color
                         },
                         elements: [], scrollToContent: true
                     };

                     state.excalidrawRoot.render(
                         React.createElement(ExcalidrawLib.Excalidraw, {
                             initialData: initialData,
                             excalidrawAPI: (api) => {
                                 if (!state.excalidrawAPI) {
                                     state.excalidrawAPI = api; console.log("Excalidraw API ready.");
                                     const placeholder = container.querySelector('.loading-placeholder'); if (placeholder) placeholder.remove();
                                     try { api.updateScene({ elements: [], appState: { viewBackgroundColor: PINK_BACKGROUND } }); } catch(e) { console.error("Error clearing scene on init", e); }
                                 }
                             },
                             // Přizpůsobení UI Excalidraw (můžeme skrýt nepotřebné nástroje)
                             UIOptions: {
                                 canvasActions: {
                                     saveToActiveFile: false, loadScene: false, export: { saveFileToDisk: true }, clearCanvas: false, /* others? */
                                 },
                                 tools: { image: false } // Skryjeme např. vkládání obrázků
                             },
                             viewModeEnabled: true, zenModeEnabled: false, gridModeEnabled: false,
                             theme: 'light', // Vynutíme světlý motiv pro nástroje
                             onChange: (elements, appState) => { /* state.excalidrawElements = elements; // Raději spravujeme explicitně při updateScene */ }
                         })
                     );
                     console.log("Excalidraw component mount initiated.");
                     return true;
                 } catch (error) {
                     console.error("Error mounting Excalidraw:", error);
                     container.innerHTML = `<div class="loading-placeholder" style="color:var(--danger);"><i class="fas fa-exclamation-triangle"></i><p>Chyba Excalidraw:<br>${error.message}</p></div>`;
                     return false;
                 }
             };
             // --- updateExcalidrawScene - AKTUALIZOVÁNO pro přidávání prvků a posun ---
             const updateExcalidrawScene = (newElements) => {
                 if (!state.excalidrawAPI) { console.warn("Excalidraw API not available."); return; }
                 if (!Array.isArray(newElements) || newElements.length === 0) { console.log("No new elements to add to scene."); return; }

                 // 1. Připravíme nové prvky (aplikujeme defaulty a posuneme Y)
                 const yOffset = state.lowestY; // Y, kam se umístí HORNÍ okraj nových prvků
                 console.log(`Applying Y offset: ${yOffset}`);
                 const processedNewElements = addDefaultExcalidrawProps(newElements).map(el => {
                     if (el && typeof el.y === 'number') {
                         el.y += yOffset; // Posuneme Y souřadnici
                     }
                     // <<< ZAJIŠTĚNÍ BARVY >>>
                     el.strokeColor = BLACK_COLOR;
                     if (el.type === 'text') {
                        el.fontFamily = 2; // Helvetica
                        el.fontSize = 24;
                     }
                     // <<< KONEC ZAJIŠTĚNÍ BARVY >>>
                     return el;
                 });

                 // 2. Spojíme staré a nové prvky
                 const combinedElements = [...state.excalidrawElements, ...processedNewElements];

                 // 3. Aktualizujeme `lowestY` na základě NOVĚ přidaných prvků
                 updateCurrentLowestY(); // Tato funkce teď pracuje s state.excalidrawElements, které se za chvíli aktualizují

                 // 4. Logování a validace (volitelné, ale doporučené)
                 console.groupCollapsed(`[Excalidraw Update] Appending ${processedNewElements.length} elements. Total: ${combinedElements.length}.`);
                 console.log("Processed new elements:", JSON.stringify(processedNewElements));
                 const validationResult = validateExcalidrawElements(processedNewElements); // Validujeme jen nové
                 if (!validationResult.isValid) {
                    console.error("Validation failed for NEW elements. Aborting update.");
                    showToast("Chyba: AI poslala neplatná data pro tabuli.", "error");
                    console.groupEnd();
                    return; // Neaktualizujeme scénu s nevalidními novými prvky
                 }
                 console.groupEnd();

                 // 5. Aktualizace Excalidraw scény
                 try {
                     let currentAppState = state.excalidrawAPI.getAppState ? state.excalidrawAPI.getAppState() : {};
                     state.excalidrawAPI.updateScene({
                         elements: combinedElements,
                         appState: {
                             ...currentAppState,
                             viewModeEnabled: false,
                             viewBackgroundColor: PINK_BACKGROUND // Ujistíme se, že pozadí je správně
                         }
                     });
                     console.log("Excalidraw updateScene called successfully with combined elements.");
                     state.excalidrawElements = combinedElements; // Aktualizujeme globální stav

                     // 6. Posunutí pohledu na nové prvky
                     setTimeout(() => {
                         if (state.excalidrawAPI?.scrollToContent && processedNewElements.length > 0) {
                             console.log("Scrolling to newly added content...");
                             try {
                                 // Použijeme jen NOVÉ prvky pro určení oblasti, na kterou se má scrollovat
                                 state.excalidrawAPI.scrollToContent(processedNewElements, { fitToContent: false, duration: 500 });
                             } catch (scrollError) { console.warn("Error during scrollToContent:", scrollError); }
                         }
                     }, 300);

                 } catch (error) {
                     console.error("!!! Error during Excalidraw updateScene call:", error);
                     showToast("Chyba při aktualizaci tabule!", "error", 6000);
                     // Zde neobnovujeme state.excalidrawElements, abychom neztratili předchozí stav
                 }
             };

            // --- User Profile & Auth ---
            const loadUserProfile = async () => { /* ... (stejná jako předtím) ... */ if (!state.supabase) { console.error("Supabase not initialized."); return; } try { const { data: { user }, error: userError } = await state.supabase.auth.getUser(); if (userError) throw userError; if (user) { state.currentUser = user; const { data: profile, error: profileError } = await state.supabase.from('profiles').select('*').eq('id', user.id).single(); if (profileError && profileError.code !== 'PGRST116') throw profileError; state.currentProfile = profile; console.log("User profile loaded:", state.currentProfile); } else { state.currentUser = null; state.currentProfile = null; console.log("No user logged in."); } } catch (error) { console.error('Error loading user profile:', error); state.currentUser = null; state.currentProfile = null; showToast("Nepodařilo se načíst profil.", "error"); } finally { updateUserInfoUI(); } };
            const updateUserInfoUI = () => { /* ... (stejná jako předtím) ... */ if (uiElements.userName && uiElements.userAvatar) { if (state.currentProfile || state.currentUser) { const email = state.currentUser?.email; const initials = getInitials(state.currentProfile, email); const displayName = `${state.currentProfile?.first_name || ''} ${state.currentProfile?.last_name || ''}`.trim() || state.currentProfile?.username || email?.split('@')[0] || 'Uživatel'; uiElements.userName.textContent = displayName; if (state.currentProfile?.avatar_url) { uiElements.userAvatar.innerHTML = `<img src="${state.currentProfile.avatar_url}" alt="${initials}">`; } else { uiElements.userAvatar.innerHTML = ''; uiElements.userAvatar.textContent = initials; } } else { uiElements.userName.textContent = 'Nepřihlášen'; uiElements.userAvatar.innerHTML = '?'; } } };
            const handleLoggedOutUser = () => { /* ... (stejná jako předtím) ... */ console.warn("User not logged in."); if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder">Nejste přihlášeni</span>'; showToast("Prosím, přihlaste se.", "warning"); manageUIState('loggedOut'); };

            // --- Event Listeners Setup ---
            const setupEventListeners = () => { console.log("Setting up event listeners..."); if (uiElements.mobileMenuToggle && uiElements.sidebar && uiElements.sidebarOverlay) { /* ... (listeners pro menu) ... */ uiElements.mobileMenuToggle.addEventListener('click', (e) => { e.stopPropagation(); uiElements.sidebar.classList.toggle('active'); uiElements.sidebarOverlay.classList.toggle('active'); }); uiElements.sidebarOverlay.addEventListener('click', () => { uiElements.sidebar.classList.remove('active'); uiElements.sidebarOverlay.classList.remove('active'); }); document.querySelector('main')?.addEventListener('click', () => { if (uiElements.sidebar?.classList.contains('active')) { uiElements.sidebar.classList.remove('active'); uiElements.sidebarOverlay.classList.remove('active'); } }); } else { console.warn("Mobile menu elements not found."); } if (uiElements.chatInput && uiElements.sendButton) { /* ... (listeners pro chat) ... */ uiElements.chatInput.addEventListener('input', autoResizeTextarea); uiElements.chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if (!state.geminiIsThinking) handleSendMessage(); } }); uiElements.sendButton.addEventListener('click', () => { if (!state.geminiIsThinking) handleSendMessage(); }); } else { console.warn("Chat input/send elements not found."); } if (uiElements.clearChatBtn) uiElements.clearChatBtn.addEventListener('click', confirmClearChat); if (uiElements.saveChatBtn) uiElements.saveChatBtn.addEventListener('click', saveChatToPDF); if (uiElements.continueBtn) uiElements.continueBtn.addEventListener('click', requestContinue); // <<< Změna: Listener pro nové tlačítko
 window.addEventListener('resize', () => { if (window.innerWidth > 992 && uiElements.sidebar?.classList.contains('active')) { uiElements.sidebar.classList.remove('active'); uiElements.sidebarOverlay.classList.remove('active'); } }); };
            const initTooltips = () => { /* ... (stejná jako předtím) ... */ try { if (window.jQuery && window.jQuery.fn.tooltipster) { window.jQuery('.btn-tooltip:not(.tooltipstered)').tooltipster({ theme: 'tooltipster-shadow', animation: 'fade', delay: 100, side: 'top' }); } else { console.warn("jQuery or Tooltipster not fully loaded for initTooltips."); } } catch (e) { console.error("Tooltipster initialization error:", e); } };

             // --- Topic Loading and Progress ---
            const loadNextUncompletedTopic = async () => {
                if (!state.currentUser || state.topicLoadInProgress || !state.supabase) { return; }
                state.topicLoadInProgress = true;
                state.currentTopic = null;
                if (uiElements.chatMessages) uiElements.chatMessages.innerHTML = ''; // Vyčistit chat
                state.excalidrawElements = []; // <<< Vyčistit pole prvků pro novou tabuli >>>
                state.lowestY = 50; // <<< Resetovat Y pozici >>>
                updateExcalidrawScene([]); // Vyčistit kreslící plochu
                state.geminiChatContext = [];
                if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder"><i class="fas fa-spinner fa-spin"></i> Hledám další téma...</span>';
                manageUIState('loadingTopic');

                try {
                    const { data: activePlans, error: planError } = await state.supabase.from('study_plans').select('id').eq('user_id', state.currentUser.id).eq('status', 'active').order('created_at', { ascending: false }).limit(1);
                    if (planError) throw planError;
                    if (!activePlans || activePlans.length === 0) { /* ... (zpracování bez plánu) ... */ console.log("No active study plan found."); if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder">Žádný aktivní studijní plán</span>'; showToast("Nemáte aktivní studijní plán.", "warning"); manageUIState('noPlan'); return; }
                    state.currentPlanId = activePlans[0].id;
                    const { data: nextActivities, error: activityError } = await state.supabase.from('plan_activities').select('id, title, description, topic_id, completed').eq('plan_id', state.currentPlanId).eq('completed', false).order('day_of_week', { ascending: true }).order('time_slot', { ascending: true }).limit(1);
                    if (activityError) throw activityError;

                    if (nextActivities && nextActivities.length > 0) {
                        const nextActivity = nextActivities[0];
                        let topicName = nextActivity.title || 'Nespecifikované téma';
                        let topicDescription = nextActivity.description || '';
                        if (nextActivity.topic_id) { /* ... (načtení detailů tématu) ... */ try { const { data: topicData, error: topicError } = await state.supabase.from('exam_topics').select('name, description').eq('id', nextActivity.topic_id).single(); if (topicError && topicError.code !== 'PGRST116') { console.warn(`Could not fetch topic details for ID ${nextActivity.topic_id}:`, topicError); } else if (topicData) { topicName = topicData.name || topicName; topicDescription = topicData.description || topicDescription; } } catch (topicFetchError) { console.error("Error fetching topic details:", topicFetchError); } }
                        state.currentTopic = { activity_id: nextActivity.id, plan_id: state.currentPlanId, name: topicName, description: topicDescription, user_id: state.currentUser.id, topic_id: nextActivity.topic_id };
                        if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = `Aktuální téma: <strong>${sanitizeHTML(state.currentTopic.name)}</strong>`;
                        await startLearningSession(); // Začne kreslit první část
                    } else { /* ... (zpracování dokončeného plánu) ... */ console.log("All activities completed."); if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder">Gratulujeme, plán dokončen!</span>'; showToast("Všechna témata v plánu jsou dokončena!", "success"); manageUIState('planComplete'); }
                } catch (error) { /* ... (zpracování chyby) ... */ console.error('Error loading next topic:', error); if (uiElements.currentTopicDisplay) uiElements.currentTopicDisplay.innerHTML = '<span class="placeholder" style="color:var(--danger);">Chyba načítání tématu</span>'; showToast(`Nepodařilo se načíst další téma: ${error.message}`, "error"); manageUIState('error');
                } finally { state.topicLoadInProgress = false; manageButtonStates(); }
            };
            // handleMarkTopicComplete - Nyní jen označí a načte další, nemaže UI explicitně (to dělá loadNext...)
            const handleMarkTopicComplete = async () => { if (!state.currentTopic || !state.supabase || state.topicLoadInProgress) return; state.topicLoadInProgress = true; manageButtonStates(); try { const { error } = await state.supabase.from('plan_activities').update({ completed: true, updated_at: new Date().toISOString() }).eq('id', state.currentTopic.activity_id); if (error) throw error; showToast(`Téma "${state.currentTopic.name}" dokončeno.`, "success"); await loadNextUncompletedTopic(); // Načte další (a vyčistí UI)
 } catch (error) { console.error(`Error marking activity complete:`, error); showToast("Chyba při označování tématu.", "error"); state.topicLoadInProgress = false; manageButtonStates(); } };

            // --- Learning Session Management ---
            const startLearningSession = async () => { if (!state.currentTopic || !state.currentUser) { return; } state.currentSessionId = generateSessionId(); manageUIState('requestingExplanation'); const initialPrompt = _buildInitialPrompt(); await sendToGemini(initialPrompt); };
            const requestContinue = async () => { // <<< Nová funkce pro tlačítko Pokračuj >>>
                 if (state.geminiIsThinking || !state.currentTopic) return;
                 console.log("Requesting continuation...");
                 const prompt = `Pokračuj ve vysvětlování tématu "${state.currentTopic.name}" na tabuli. Naváž na předchozí obsah. Nezapomeň umístit nový obsah POD existující (aktuální nejnižší Y je cca ${state.lowestY}). Použij Excalidraw pro VŠECHEN text, vzorce a příklady s černou barvou (#000000) a fontem Helvetica (fontFamily: 2, fontSize: 24).`;
                 await sendToGemini(prompt);
             };

             // --- Chat Functionality ---
            const addChatMessage = async (message, sender, saveToDb = true, timestamp = new Date()) => { /* ... (stejná jako předtím, ale bez renderování do explanation) ... */ if (!uiElements.chatMessages) return; const messageId = `msg-${Date.now()}-${Math.random().toString(16).substring(2, 8)}`; const avatarInitial = sender === 'user' ? getInitials(state.currentProfile, state.currentUser?.email) : 'AI'; const messageDiv = document.createElement('div'); messageDiv.className = `chat-message ${sender === 'gemini' ? 'model' : sender}`; messageDiv.id = messageId; const avatarDiv = document.createElement('div'); avatarDiv.className = 'message-avatar'; avatarDiv.textContent = avatarInitial; const bubbleDiv = document.createElement('div'); bubbleDiv.className = 'message-bubble'; renderMarkdown(bubbleDiv, message); // Renderuje jen Markdown v chatu
 const timestampDiv = document.createElement('div'); timestampDiv.className = 'message-timestamp'; timestampDiv.textContent = formatTimestamp(timestamp); messageDiv.appendChild(avatarDiv); messageDiv.appendChild(bubbleDiv); messageDiv.appendChild(timestampDiv); uiElements.chatMessages.appendChild(messageDiv); messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' }); if (saveToDb && state.supabase && state.currentUser && state.currentTopic && state.currentSessionId) { /* ... (ukládání do DB - stejné) ... */ const dataToSave = { user_id: state.currentUser.id, session_id: state.currentSessionId, topic_id: state.currentTopic.topic_id || null, topic_name: state.currentTopic.name || null, role: sender === 'gemini' ? 'model' : 'user', content: message }; if (!dataToSave.session_id || !dataToSave.role || !dataToSave.content) { console.error("Supabase chat save error: Missing required fields.", dataToSave); showToast("Chyba: Nelze uložit zprávu, chybí data.", "error"); return; } console.log("Attempting to save chat message:", { ...dataToSave, content: dataToSave.content.substring(0,100)+"..." }); try { const { error } = await state.supabase.from('chat_history').insert(dataToSave); if (error) { console.error("Supabase chat save error:", error); console.error("Data that caused error:", dataToSave); showToast(`Chyba ukládání chatu do DB: ${error.message}`, 'error'); } else { console.log("Chat message saved to DB."); } } catch (dbError) { console.error("Exception during chat save:", dbError); console.error("Data during exception:", dataToSave); showToast(`Výjimka při ukládání chatu: ${dbError.message}`, 'error'); } } };
            const updateGeminiThinkingState = (isThinking) => { /* ... (stejná jako předtím) ... */ state.geminiIsThinking = isThinking; manageButtonStates(); if (isThinking) { addThinkingIndicator(); } else { removeThinkingIndicator(); } };
            const addThinkingIndicator = () => { /* ... (stejná jako předtím) ... */ if (state.thinkingIndicatorId || !uiElements.chatMessages) return; const indicatorDiv = document.createElement('div'); indicatorDiv.className = 'chat-message model'; state.thinkingIndicatorId = `thinking-${Date.now()}`; indicatorDiv.id = state.thinkingIndicatorId; indicatorDiv.innerHTML = `<div class="message-avatar">AI</div><div class="message-thinking-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>`; uiElements.chatMessages.appendChild(indicatorDiv); indicatorDiv.scrollIntoView({ behavior: 'smooth', block: 'end' }); };
            const removeThinkingIndicator = () => { /* ... (stejná jako předtím) ... */ if (state.thinkingIndicatorId) { const indicator = document.getElementById(state.thinkingIndicatorId); if (indicator) { indicator.remove(); } state.thinkingIndicatorId = null; } };
            const handleSendMessage = async () => { /* ... (stejná jako předtím) ... */ const messageText = uiElements.chatInput.value.trim(); if (!messageText || state.geminiIsThinking || !state.currentTopic) { return; } const userTimestamp = new Date(); await addChatMessage(messageText, 'user', true, userTimestamp); state.geminiChatContext.push({ role: "user", parts: [{ text: messageText }] }); uiElements.chatInput.value = ''; autoResizeTextarea(); uiElements.chatInput.focus(); manageUIState('chatting'); updateGeminiThinkingState(true); await sendToGemini(messageText); }; // Cíl je teď implicitně tabule + chat
            const confirmClearChat = () => { /* ... (stejná jako předtím) ... */ if (confirm("Opravdu chcete vymazat historii tohoto chatu a celou tabuli?\nTato akce je nevratná.")) { clearCurrentChatSessionHistory(); } };
            const clearCurrentChatSessionHistory = async () => { /* ... (stejná jako předtím, ale maže i state.excalidrawElements) ... */ if (uiElements.chatMessages) uiElements.chatMessages.innerHTML = ''; state.geminiChatContext = []; state.excalidrawElements = []; state.lowestY = 50; updateExcalidrawScene([]); showToast("Historie chatu a tabule vymazána.", "info"); console.log("Chat history and Excalidraw cleared."); if (state.supabase && state.currentUser && state.currentSessionId) { /* ... (mazání z DB - stejné) ... */ try { console.log(`Attempting to delete chat history from DB for session: ${state.currentSessionId} and user: ${state.currentUser.id}`); const { data, error } = await state.supabase.from('chat_history').delete().eq('user_id', state.currentUser.id).eq('session_id', state.currentSessionId); if (error) { console.error("Error deleting chat history from DB:", error); showToast("Chyba při mazání historie z databáze.", "error"); } else { console.log("Chat history successfully deleted from DB. Response data:", data); } } catch (dbError) { console.error("Exception during DB chat history deletion:", dbError); showToast("Nastala výjimka při mazání historie z DB.", "error"); } } else { console.warn("Skipping DB deletion: Supabase client, user, or session ID not available."); } };
            const saveChatToPDF = async () => { /* ... (stejná jako předtím) ... */ if (!uiElements.chatMessages || uiElements.chatMessages.children.length === 0) { showToast("Není co uložit.", "warning"); return; } if (typeof html2pdf === 'undefined') { showToast("Chyba: Knihovna pro generování PDF není načtena.", "error"); console.error("html2pdf library is not available."); return; } showToast("Generuji PDF...", "info", 3000); const chatContainer = document.createElement('div'); chatContainer.id = "pdf-export-content"; chatContainer.style.padding = "20mm"; const pdfStyles = ` <style> body { font-family: 'Poppins', Arial, sans-serif; font-size: 10pt; line-height: 1.5; color: #333; } .pdf-header { text-align: center; margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 10px; } .pdf-header h1 { font-size: 16pt; margin: 0 0 5px 0; color: #3f37c9; } .pdf-header p { font-size: 9pt; color: #6c757d; margin: 0; } .chat-message { margin-bottom: 12px; max-width: 90%; page-break-inside: avoid; } .chat-message.user { margin-left: 10%; } .chat-message.model { margin-right: 10%; } .message-bubble { padding: 9px 13px; border-radius: 12px; background-color: #f1f3f5; border: 1px solid #dee2e6; display: inline-block; max-width: 100%; word-wrap: break-word; text-align: left; } .chat-message.user .message-bubble { background-color: #e6f7ff; border-color: #b3e0ff; } .chat-message.model .message-bubble { background-color: #f8f9fa; border-color: #e9ecef; } .message-timestamp { font-size: 8pt; color: #888; margin-top: 4px; display: block; } .chat-message.user .message-timestamp { text-align: right; } .chat-message.model .message-timestamp { text-align: left; } code { font-family: 'Courier New', Courier, monospace; background-color: #e9ecef; padding: 1px 4px; border-radius: 3px; font-size: 0.9em; color: #c7254e; border: 1px solid #ced4da; } pre { margin: 6px 0; page-break-inside: avoid; } pre code { display: block; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-size: 0.85em; color: #212529; } mjx-math { display: inline-block; } </style> `; chatContainer.innerHTML = pdfStyles; const headerDiv = document.createElement('div'); headerDiv.className = 'pdf-header'; headerDiv.innerHTML = `<h1>Záznam chatu - ${sanitizeHTML(state.currentTopic?.name || 'Neznámé téma')}</h1><p>Exportováno: ${new Date().toLocaleString('cs-CZ')}</p>`; chatContainer.appendChild(headerDiv); Array.from(uiElements.chatMessages.children).forEach(msgElement => { if (msgElement.classList.contains('chat-message') && !msgElement.querySelector('.message-thinking-indicator')) { const clone = msgElement.cloneNode(true); const avatar = clone.querySelector('.message-avatar'); if(avatar) avatar.remove(); chatContainer.appendChild(clone); } }); const filename = `chat-justax-${state.currentTopic?.name?.replace(/[^a-z0-9]/gi, '_') || 'vyuka'}-${formatTimestamp().replace(/[:\s]/g, '')}.pdf`; const options = { margin: 15, filename: filename, image: { type: 'jpeg', quality: 0.95 }, html2canvas: { scale: 2, useCORS: true, logging: false, letterRendering: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } }; try { await html2pdf().set(options).from(chatContainer).save(); showToast("Chat uložen jako PDF!", "success"); } catch (pdfError) { console.error("Chyba exportu PDF:", pdfError); showToast("Nepodařilo se exportovat chat do PDF.", "error"); } };

             // --- Gemini Interaction & Excalidraw Processing ---
            const parseExcalidrawScene = (responseText) => { /* ... (stejná jako předtím) ... */ EXCALIDRAW_SCENE_REGEX.lastIndex = 0; const match = EXCALIDRAW_SCENE_REGEX.exec(responseText); let sceneData = null; let cleanedText = responseText; if (match && match[1]) { console.log("Found EXCALIDRAW_SCENE block."); try { let jsonString = match[1].trim().replace(/,\s*([}\]])/g, '$1'); sceneData = JSON.parse(jsonString); if (!Array.isArray(sceneData)) { console.warn("Parsed Excalidraw data is not an array:", sceneData); sceneData = null; } else { console.log(`Successfully parsed ${sceneData.length} Excalidraw elements.`); cleanedText = cleanedText.replace(match[0], '').trim(); } } catch (e) { console.error("Failed to parse Excalidraw JSON:", e, "\nJSON String (Attempted):", match[1]); cleanedText = responseText; sceneData = null; showToast("Chyba parsování dat pro kresbu od AI.", "warning"); } } return { cleanedText, sceneData }; };
            const validateExcalidrawElements = (elements) => { /* ... (stejná jako předtím) ... */ if (!Array.isArray(elements)) { console.error("Validation failed: Input is not an array."); return { isValid: false, invalidElementsDetails: [{ index: -1, reason: "Input is not an array", element: elements }] }; } const invalidElementsDetails = []; const requiredPropsByType = { text: ['type', 'x', 'y', 'width', 'height', 'text', 'fontSize', 'fontFamily'], line: ['type', 'x', 'y', 'width', 'height', 'points'], arrow: ['type', 'x', 'y', 'width', 'height', 'points'], rectangle: ['type', 'x', 'y', 'width', 'height'], ellipse: ['type', 'x', 'y', 'width', 'height'], }; const numericProps = ['x', 'y', 'width', 'height', 'angle', 'strokeWidth', 'fontSize', 'opacity']; elements.forEach((el, index) => { let elementIssues = []; if (typeof el !== 'object' || el === null) { elementIssues.push("Element is not an object or is null."); } else if (!el.type || typeof el.type !== 'string') { elementIssues.push("Missing or invalid 'type' property."); } else { const requiredProps = requiredPropsByType[el.type] || ['type', 'x', 'y', 'width', 'height']; for (const prop of requiredProps) { if (el[prop] === undefined || el[prop] === null) { elementIssues.push(`Missing or null required property: '${prop}'.`); } } for (const prop of numericProps) { if (el[prop] !== undefined && el[prop] !== null && typeof el[prop] !== 'number') { elementIssues.push(`Non-numeric value for property '${prop}': ${JSON.stringify(el[prop])}.`); } } if (typeof el.width === 'number' && el.width < 0) elementIssues.push(`Negative width: ${el.width}.`); if (typeof el.height === 'number' && el.height < 0) elementIssues.push(`Negative height: ${el.height}.`); if (typeof el.opacity === 'number' && (el.opacity < 0 || el.opacity > 100)) elementIssues.push(`Invalid opacity: ${el.opacity}.`); if (el.type === 'text' && typeof el.text !== 'string') { elementIssues.push("Invalid 'text' property (must be string)."); } if (['line', 'arrow'].includes(el.type)) { if (!Array.isArray(el.points) || el.points.length < 2) { elementIssues.push("Invalid 'points' array (must be array with at least 2 points)."); } else { const hasInvalidPoint = el.points.some(p => !Array.isArray(p) || p.length !== 2 || typeof p[0] !== 'number' || typeof p[1] !== 'number'); if (hasInvalidPoint) { elementIssues.push("Invalid point format within 'points' array (each point must be [number, number])."); } } } } if (elementIssues.length > 0) { invalidElementsDetails.push({ index, reasons: elementIssues, element: el }); } }); const overallIsValid = invalidElementsDetails.length === 0; if (!overallIsValid) { console.error(`Excalidraw data validation failed. Found issues in ${invalidElementsDetails.length} element(s).`); invalidElementsDetails.forEach(inv => { console.error(`--> Invalid Element (Index ${inv.index}): Reasons: ${inv.reasons.join(', ')}`); console.log("Problematic Element Data:"); console.dir(inv.element); }); } else { console.log("Excalidraw data validation successful."); } return { isValid: overallIsValid, invalidElementsDetails }; };
            // addDefaultExcalidrawProps - Zajišťuje černé prvky a font
            const addDefaultExcalidrawProps = (elements) => {
                if (!Array.isArray(elements)) return elements;
                console.log("Patching Excalidraw elements...");
                const defaultSeed = Math.floor(Math.random() * 2 ** 31);
                return elements.map((el, index) => {
                    if (typeof el !== 'object' || el === null) { return el; }
                    // Základní vlastnosti
                    el.x = (typeof el.x === 'number') ? el.x : 0;
                    el.y = (typeof el.y === 'number') ? el.y : 0;
                    el.width = (typeof el.width === 'number' && el.width > 0) ? el.width : 50;
                    el.height = (typeof el.height === 'number' && el.height > 0) ? el.height : 20;
                    el.angle = el.angle ?? 0;
                    el.strokeColor = BLACK_COLOR; // <<< Vynucená černá >>>
                    el.backgroundColor = el.backgroundColor ?? 'transparent';
                    el.fillStyle = el.fillStyle ?? 'hachure';
                    el.strokeWidth = el.strokeWidth ?? 1;
                    el.strokeStyle = el.strokeStyle ?? 'solid';
                    el.roughness = 0; // Vždy hladké čáry
                    el.opacity = 100; // Vždy plně viditelné
                    el.strokeSharpness = el.strokeSharpness ?? (['line', 'arrow', 'freedraw'].includes(el.type) ? 'round' : 'sharp');
                    el.seed = el.seed ?? defaultSeed;
                    el.version = el.version ?? 2;
                    el.versionNonce = el.versionNonce ?? Math.floor(Math.random() * 2 ** 31);
                    el.isDeleted = el.isDeleted ?? false;
                    el.groupIds = el.groupIds ?? [];
                    el.frameId = el.frameId ?? null;
                    el.boundElements = el.boundElements ?? null;
                    el.updated = el.updated ?? Date.now();
                    el.link = el.link ?? null;
                    el.locked = el.locked ?? false;

                    // Specifické pro typ
                    if (el.type === 'text') {
                        el.fontSize = 24; // <<< Vynucená velikost >>>
                        el.fontFamily = 2; // <<< Vynucený font (Helvetica) >>>
                        el.text = (typeof el.text === 'string') ? el.text : '';
                        el.textAlign = el.textAlign ?? 'left';
                        el.verticalAlign = el.verticalAlign ?? 'top';
                        el.baseline = el.baseline ?? 18;
                    } else if (['line', 'arrow', 'freedraw'].includes(el.type)) {
                        if (!Array.isArray(el.points) || el.points.length < (el.type === 'freedraw' ? 1: 2)) {
                             el.points = (el.type === 'freedraw' ? [[0,0]] : [[0, 0], [el.width, el.height]]);
                        }
                        el.lastCommittedPoint = el.lastCommittedPoint ?? null;
                        el.startBinding = el.startBinding ?? null;
                        el.endBinding = el.endBinding ?? null;
                        el.startArrowhead = el.startArrowhead ?? null;
                        el.endArrowhead = el.endArrowhead ?? (el.type === 'arrow' ? 'arrow' : null);
                    }
                    return el;
                });
            };
             // --- processGeminiResponse - ZJEDNODUŠENO, jen pro Excalidraw ---
             const processGeminiResponse = (rawResponseText, timestamp) => {
                 removeThinkingIndicator();
                 // 1. Extrahuj POUZE data pro Excalidraw
                 let { cleanedText, sceneData } = parseExcalidrawScene(rawResponseText);
                 // cleanedText nyní obsahuje vše ostatní, co nebylo Excalidraw scénou

                 // 2. Zpracuj Excalidraw data, pokud existují
                 if (sceneData) {
                     const validationResult = validateExcalidrawElements(sceneData); // Validace syrových dat
                     if (validationResult.isValid) {
                         console.log("Valid new scene data received from AI.");
                         updateExcalidrawScene(sceneData); // Přidá nové prvky s posunem Y
                         addChatMessage("(AI aktualizovala tabuli)", 'gemini', false, timestamp); // Krátká zpráva do chatu
                     } else {
                         console.error("Invalid Excalidraw data received from AI, update skipped.");
                         showToast("Chyba: AI vrátila neplatná data pro tabuli.", "error");
                         addChatMessage("(AI poslala neplatná data pro tabuli, zkuste to znovu nebo položte jiný dotaz)", 'gemini', false, timestamp);
                     }
                 } else {
                     console.log("No Excalidraw scene data found in response.");
                      // Pokud AI neposlala kresbu, ale poslala nějaký text (který neměl být), zobrazíme ho v chatu jako fallback
                      if (cleanedText.trim()) {
                         console.warn("AI sent text content instead of only Excalidraw:", cleanedText);
                         addChatMessage(`AI odpověděla textem (místo kresby): "${cleanedText.substring(0,100)}..."`, 'gemini', true, timestamp);
                         showToast("AI neaktualizovala tabuli, odpověď je v chatu.", "warning");
                      } else {
                         addChatMessage("(AI neposlala žádnou aktualizaci tabule)", 'gemini', false, timestamp);
                      }
                 }

                 manageUIState('learning'); // Nebo 'chatting' pokud přišlo z chatu? Zůstaneme v 'learning'

                 // MathJax se už neřeší, vše je na tabuli
             };


            // --- _buildInitialPrompt - Změněno pro nový styl ---
            const _buildInitialPrompt = () => {
                 return `Jako AI Tutor "Justax" začni vysvětlovat ZÁKLADY tématu "${state.currentTopic.name}" pro studenta 9. třídy ZŠ (přijímačky CERMAT). ${state.currentTopic.description ? `Popis: "${state.currentTopic.description}".` : ''}
VEŠKERÉ vysvětlení, text, vzorce, příklady a kroky řešení piš POUZE na kreslící plochu Excalidraw. NEPOUŽÍVEJ Markdown.
Toto je PRVNÍ krok. Nakresli úvodní informace nebo jednoduchý příklad.
DŮLEŽITÉ PRO EXCALIDRAW:
* Pozadí plochy je RŮŽOVÉ (#FFC0CB).
* Všechny prvky (text, čáry, tvary) musí mít ČERNOU barvu tahu (\`strokeColor: "${BLACK_COLOR}"\`).
* Použij font Helvetica (\`fontFamily: 2\`) a velikost písma \`fontSize: 24\`.
* Umísti obsah poblíž horního okraje (např. Y kolem 50).
* Na konec odpovědi přidej JSON data pro Excalidraw ve formátu: \`EXCALIDRAW_SCENE: \`\`\`json [ ... ] \`\`\`\`.`;
             }
            // --- _buildGeminiPayloadContents - Změněno pro nový styl ---
            const _buildGeminiPayloadContents = (userPromptText) => {
                const systemInstructionText = `Jsi AI Tutor "Justax", expert na matematiku pro 9. třídu ZŠ v ČR (přijímačky CERMAT). Vyučuješ téma: "${state.currentTopic.name}"${state.currentTopic.description ? ` (Popis: "${state.currentTopic.description}")` : ''}.
TVŮJ HLAVNÍ ÚKOL: Vysvětluj VŠE POUZE kreslením na plochu Excalidraw. NEPOSÍLEJ žádný text mimo Excalidraw scénu.

PRAVIDLA PRO KRESLENÍ (Excalidraw):
1.  **VŠE NA TABULI:** Veškerý text, vysvětlení, vzorce, příklady, kroky řešení, otázky pro studenta - VŠE MUSÍ být jako prvky ve scéně Excalidraw.
2.  **VERTIKÁLNÍ POSUN:** Aktuální nejnižší bod obsahu na tabuli je Y = ${state.lowestY}. NOVÝ obsah, který generuješ, MUSÍŠ umístit POD tuto hodnotu. Přičti k Y souřadnicím nových prvků alespoň ${VERTICAL_SPACING}, aby byl dostatečný odstup.
3.  **BARVY:** Pozadí je RŮŽOVÉ (#FFC0CB). Všechny prvky (text, čáry, tvary, šipky) MUSÍ mít ČERNOU barvu tahu (\`strokeColor: "${BLACK_COLOR}"\`). Výplně (`backgroundColor`) mohou být průhledné nebo světlé.
4.  **TEXT:** Použij VŽDY font Helvetica (\`fontFamily: 2\`) a velikost písma \`fontSize: 24\`. Text musí být čitelný. Použij \`\\n\` pro nové řádky.
5.  **PŘÍKLADY:** Řeš příklady KROK ZA KROKEM. Každý krok (úprava rovnice, výpočet, geometrický krok) zapiš jako samostatný textový prvek nebo skupinu prvků pod předchozí krok. Používej šipky pro naznačení postupu.
6.  **PŘEHLEDNOST:** Kresli čistě, nepřekrývej prvky. Používej základní tvary a hladké čáry (`roughness: 0`).
7.  **AKTUALIZACE:** Posílej VŽDY JEN NOVÉ prvky, které chceš přidat pod existující obsah. Neposílej znovu celou scénu.
8.  **FORMÁT:** Odpověď MUSÍ obsahovat POUZE JSON data pro NOVÉ prvky Excalidraw ve formátu: \`EXCALIDRAW_SCENE: \`\`\`json [ { /* nový prvek 1 */ }, ... ] \`\`\`\`. ŽÁDNÝ DALŠÍ TEXT MIMO TENTO BLOK! Žádný CHAT_SUMMARY.`;

                // Sestavení historie (bez systémového promptu přímo zde)
                const historyForApi = state.geminiChatContext.slice(-MAX_GEMINI_HISTORY_TURNS * 2); // Omezíme historii
                const currentRequestContent = { role: "user", parts: [{ text: userPromptText }] };
                // První zpráva v payloadu je systémová instrukce
                const contentsPayload = [
                    { role: "user", parts: [{ text: systemInstructionText }] },
                    { role: "model", parts: [{ text: "Rozumím. Budu veškeré vysvětlení a příklady kreslit přímo na tabuli Excalidraw s růžovým pozadím a černými prvky, umisťovat nový obsah pod existující a posílat pouze JSON s novými prvky." }] }, // Model potvrzuje instrukce
                    ...historyForApi,
                    currentRequestContent
                ];
                return contentsPayload;
            };
            // --- sendToGemini - Upraveno pro nový cíl (jen Excalidraw) ---
            const sendToGemini = async (userPromptText) => {
                if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') { /* ... (kontrola klíče) ... */ showToast("Chyba: AI není správně nakonfigurována.", "error"); updateGeminiThinkingState(false); return; }
                if (!state.currentTopic) { /* ... (kontrola tématu) ... */ showToast("Chyba: Není téma.", "error"); updateGeminiThinkingState(false); return; }
                if (!navigator.onLine) { /* ... (kontrola připojení) ... */ showToast("Chyba: Jste offline.", "error"); updateGeminiThinkingState(false); return; }
                console.log(`Sending to Gemini: "${userPromptText.substring(0, 100)}..."`);
                const requestTimestamp = new Date();
                updateGeminiThinkingState(true);
                const contentsPayload = _buildGeminiPayloadContents(userPromptText); // Sestaví payload s novými instrukcemi
                const requestBody = { contents: contentsPayload, generationConfig: { temperature: 0.5, topP: 0.95, topK: 40, maxOutputTokens: 8192 }, safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" } ] };

                try {
                    console.log("Sending payload (first 500 chars):", JSON.stringify(requestBody).substring(0, 500) + "...");
                    const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                    if (!response.ok) { const errorBody = await response.text(); throw new Error(`Chyba Gemini API (${response.status}): ${errorBody.substring(0, 150)}`); }
                    const data = await response.json();
                    const candidate = data.candidates?.[0];
                    if (data.promptFeedback?.blockReason) { throw new Error(`Obsah blokován: ${data.promptFeedback.blockReason}.`); }
                    if (!candidate) { throw new Error('Chybná struktura odpovědi od AI.'); }
                    if (candidate.finishReason && !["STOP", "MAX_TOKENS"].includes(candidate.finishReason)) { console.warn(`Gemini finishReason: ${candidate.finishReason}.`); if(candidate.finishReason === 'SAFETY') { throw new Error('Odpověď blokována filtrem AI.'); } }
                    const geminiResponseText = candidate.content?.parts?.[0]?.text;
                    if (!geminiResponseText) { if (candidate.finishReason === 'MAX_TOKENS') { throw new Error('AI dosáhla max. délky odpovědi.'); } else { throw new Error('AI vrátila prázdnou odpověď.'); } }

                    // Přidáme do historie JEN pokud to nebyl automatický pokyn "Pokračuj"
                    if (userPromptText !== `Pokračuj ve vysvětlování tématu "${state.currentTopic.name}" na tabuli. Naváž na předchozí obsah. Nezapomeň umístit nový obsah POD existující (aktuální nejnižší Y je cca ${state.lowestY}). Použij Excalidraw pro VŠECHEN text, vzorce a příklady s černou barvou (#000000) a fontem Helvetica (fontFamily: 2, fontSize: 24).`) {
                         state.geminiChatContext.push({ role: "user", parts: [{ text: userPromptText }] });
                         // Model odpověď (celou, vč. Excalidraw bloku) ukládáme JEN pro kontext, nezobrazuje se
                         state.geminiChatContext.push({ role: "model", parts: [{ text: geminiResponseText }] });
                         if (state.geminiChatContext.length > MAX_GEMINI_HISTORY_TURNS * 2) {
                             state.geminiChatContext = state.geminiChatContext.slice(-MAX_GEMINI_HISTORY_TURNS * 2);
                         }
                    }

                    processGeminiResponse(geminiResponseText, requestTimestamp); // Zpracuje hlavně Excalidraw
                } catch (error) {
                    console.error('Error sending/processing Gemini request:', error);
                    showToast(`Chyba komunikace s AI: ${error.message}`, "error", 6000);
                    handleGeminiError(error.message, requestTimestamp);
                } finally {
                    updateGeminiThinkingState(false);
                }
            };
            // handleGeminiError - Zjednodušeno
            const handleGeminiError = (errorMessage, timestamp) => {
                const errorMsg = `Omlouvám se, nastala chyba: ${errorMessage}`;
                removeThinkingIndicator();
                addChatMessage(errorMsg, 'gemini', false, timestamp); // Zobrazí chybu v chatu
                manageButtonStates();
            };

            // --- Run Application ---
            document.addEventListener('DOMContentLoaded', initializeApp);

        } catch (e) {
            // --- Fatal Error Handling ---
            console.error("FATAL SCRIPT ERROR:", e);
            document.body.innerHTML = `<div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f8d7da; color: #721c24; padding: 40px; text-align: center; font-family: sans-serif; z-index: 9999;"> <h1 style="font-size: 2em; margin-bottom: 20px;">Nastala kritická chyba aplikace</h1> <p style="font-size: 1.1em; margin-bottom: 15px;">Omlouváme se, aplikace nemohla být správně spuštěna. Problém byl zaznamenán.</p> <p style="margin-bottom: 25px;">Zkuste prosím <a href="#" onclick="window.location.reload();" style="color: #721c24; font-weight: bold;">obnovit stránku</a>.</p> <details style="margin-top: 20px; text-align: left; background-color: #fff; padding: 15px; border: 1px solid #f5c6cb; border-radius: 5px;"> <summary style="cursor: pointer; font-weight: bold;">Technické detaily chyby</summary> <pre style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.8em; white-space: pre-wrap; word-wrap: break-word;">${e.message}\n${e.stack}</pre> </details> </div>`;
        }
    </script>

</body>
</html>