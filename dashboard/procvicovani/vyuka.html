<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Výuka s AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        window.MathJax = { /* ... (konfigurace MathJax stejná) ... */ };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/tldraw@1.24.2/dist/tldraw.js"></script>

    <style>
        /* --- CSS STYLES (stejné jako v předchozí odpovědi) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; scroll-behavior: smooth; }
        :root { /* ... (proměnné stejné) ... */ }
        body { background-color: #f6f8ff; color: var(--text-primary); min-height: 100vh; display: flex; overflow-x: hidden; }
        /* --- Sidebar (stejné) --- */
        .sidebar { /* ... */ }
        .sidebar-header { /* ... */ }
        .sidebar-logo { /* ... */ }
        .sidebar-menu { /* ... */ }
        .sidebar-item { /* ... */ }
        .sidebar-link { /* ... */ }
        .sidebar-footer { /* ... */ }
        .user-profile { /* ... */ }
        .user-avatar { /* ... */ }
        .user-info { /* ... */ }
        .user-name { /* ... */ }
        .user-role { /* ... */ }
        /* --- Hlavní obsah --- */
        main { flex: 1; margin-left: var(--sidebar-width); padding: 1.5rem 2rem; transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .dashboard-header { /* ... */ }
        .header-content { /* ... */ }
        .header-title-section { /* ... */ }
        .header-content h1 { /* ... */ }
        .header-actions { /* ... */ }
        /* --- Struktura layoutu Výuky --- */
        .learning-layout { display: flex; flex-grow: 1; gap: 1.5rem; overflow: hidden; }
        .left-panel { flex: 1; display: flex; flex-direction: column; gap: 1.5rem; min-width: 400px; overflow: hidden; }
        .right-panel { width: 450px; flex-shrink: 0; display: flex; flex-direction: column; overflow: hidden; }
        /* --- Levé komponenty --- */
        .section { /* ... */ }
        @keyframes fadeIn { /* ... */ }
        .section-title { /* ... */ }
        /* --- Nová sekce pro načítání tématu --- */
        .topic-loading-section { flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
        #current-topic-display { font-size: 1.1rem; font-weight: 500; color: var(--text-secondary); }
        #current-topic-display strong { color: var(--primary); }
        #current-topic-display .placeholder { font-style: italic; color: var(--text-muted); }

        .explanation-section { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #explanation-content { /* ... */ }
        #explanation-content .step { /* ... */ }
        #explanation-content h3 { /* ... */ }
        .whiteboard-section { /* ... */ }
        .whiteboard-container { /* ... */ }
        /* --- Pravý panel (Chat) --- */
        .chat-area { /* ... */ }
        .chat-header { /* ... */ }
        .chat-header h3 { /* ... */ }
        .chat-actions button { /* ... */ }
        .chat-messages { /* ... */ }
        .chat-message { /* ... */ }
        .chat-message.user { /* ... */ }
        .message-avatar { /* ... */ }
        .chat-message.user .message-avatar { /* ... */ }
        .chat-message.gemini .message-avatar { /* ... */ }
        .message-bubble { /* ... */ }
        .chat-message.user .message-bubble { /* ... */ }
        .chat-message.gemini .message-bubble { /* ... */ }
        .message-bubble p:last-child { /* ... */ }
        .message-bubble code { /* ... */ }
        .chat-message.user .message-bubble code { /* ... */ }
        .message-timestamp { /* ... */ }
        .chat-message.gemini .message-timestamp { /* ... */ }
        .message-thinking-indicator { /* ... */ }
        .typing-dot { /* ... */ }
        @keyframes typing { /* ... */ }
        .chat-input-area { /* ... */ }
        .chat-input { /* ... */ }
        .chat-input:focus { /* ... */ }
        .send-button { /* ... */ }
        .send-button:hover:not(:disabled) { /* ... */ }
        .send-button:disabled { /* ... */ }
        .send-button i { /* ... */ }
        .send-button .fa-spinner { /* ... */ }
        /* --- Utility & State Styles --- */
        .loading { /* ... */ }
        .loading::after { /* ... */ }
        @keyframes loading-spinner { /* ... */ }
        .empty-state { /* ... */ }
        .empty-state i { /* ... */ }
        .empty-state h3 { /* ... */ }
        .empty-state p { /* ... */ }
        .btn { /* ... */ }
        .btn-primary { /* ... */ }
        .btn-primary:hover:not(:disabled) { /* ... */ }
        .btn-secondary { /* ... */ }
        .btn-secondary:hover { /* ... */ }
        .btn:disabled { /* ... */ }
        .btn i { /* ... */ }
        /* --- Responsiveness --- */
        .mobile-menu-toggle { /* ... */ }
        .sidebar-overlay { /* ... */ }
        .sidebar-overlay.active { /* ... */ }
        @media (max-width: 1200px) { /* ... */ }
        @media (max-width: 992px) { /* ... */ }
        @media (max-width: 768px) { /* ... */ }
        @media (max-width: 576px) { /* ... */ }
        /* --- Dark mode --- */
        @media (prefers-color-scheme: dark) { /* ... (stejné jako předtím, včetně tldraw stylů) ... */ }
        /* --- Toast notification --- */
        .toast { /* ... */ }
        .toast.show { /* ... */ }
        .toast.success { /* ... */ }
        .toast.error { /* ... */ }
        .toast.warning { /* ... */ }
        .toast i { /* ... */ }
        .toast.success i { /* ... */ }
        .toast.error i { /* ... */ }
        .toast.warning i { /* ... */ }
        @media (prefers-color-scheme: dark) { .toast { /* ... */ } }
    </style>
</head>
<body>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header"> <a href="/" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
         <ul class="sidebar-menu"> <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Dashboard</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li> </ul>
         <div class="user-profile"> <div class="user-avatar" id="user-avatar">?</div> <div class="user-info"> <div class="user-name" id="user-name">Načítání...</div> <div class="user-role">Student</div> </div> </div>
         <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main>
         <div class="dashboard-header">
            <div class="header-content"> <div class="header-title-section"> <button class="mobile-menu-toggle" id="mobile-menu-toggle"> <i class="fas fa-bars"></i> </button> <h1>Interaktivní výuka</h1> </div> <div class="header-actions"> <a href="/dashboard/procvicovani/main.html" class="btn btn-secondary"> <i class="fas fa-arrow-left"></i> Zpět na přehled </a> </div> </div>
         </div>

         <div class="learning-layout">

             <div class="left-panel">
                 <section class="section topic-loading-section">
                     <div id="current-topic-display">
                          <span class="placeholder">Načítám další téma z plánu...</span>
                     </div>
                     <button class="btn btn-primary" id="load-next-topic-btn">
                          <i class="fas fa-sync-alt"></i> Načíst další téma z plánu
                     </button>
                 </section>

                 <section id="explanation-container" class="section explanation-section" style="display: none;">
                      <h2 class="section-title" id="explanation-title"><i class="fas fa-chalkboard-teacher"></i> Vysvětlení tématu</h2>
                      <div id="explanation-content">
                           </div>
                       <div style="text-align: center; margin-top: 1rem;">
                            <button class="btn btn-secondary" id="next-step-btn" style="display: none;"><i class="fas fa-forward"></i> Pokračovat / Další krok</button>
                       </div>
                 </section>

                 <section id="whiteboard-container-section" class="section whiteboard-section" style="display: none;">
                      <h2 class="section-title"><i class="fas fa-pencil-ruler"></i> Interaktivní doška</h2>
                      <div class="whiteboard-container" id="tldraw-container">
                           </div>
                 </section>
             </div>

             <div id="chat-panel" class="right-panel" style="display: none;">
                 <section class="chat-area">
                      <div class="chat-header"> <h3><i class="fas fa-comments"></i> Chat s AI</h3> <div class="chat-actions"> <button id="save-chat-btn" title="Uložit chat jako PDF" class="btn-tooltip"> <i class="fas fa-save"></i> </button> <button id="clear-chat-btn" title="Vymazat historii chatu" class="btn-tooltip"> <i class="fas fa-trash-alt"></i> </button> </div> </div>
                       <div class="chat-messages" id="chat-messages">
                            </div>
                       <div class="chat-input-area"> <textarea class="chat-input" id="chat-input" placeholder="Napiš svou otázku..." rows="1"></textarea> <button class="send-button" id="send-button"> <i class="fas fa-paper-plane"></i> </button> </div>
                 </section>
             </div>

         </div> </main>

      <div class="toast" id="toast"> <i class="fas fa-check-circle"></i> <div id="toast-message">Operace úspěšná.</div> </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // --- Supabase & Gemini Init ---
            const supabaseUrl = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
            const supabase = window.supabase?.createClient ? window.supabase.createClient(supabaseUrl, supabaseKey) : null;
            const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // POUZE PRO TESTOVÁNÍ!
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

            // --- DOM Elements ---
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            // const topicSelect = document.getElementById('topic-select'); // Odstraněno
            // const startLearningBtn = document.getElementById('start-learning-btn'); // Odstraněno
            const currentTopicDisplay = document.getElementById('current-topic-display');
            const loadNextTopicBtn = document.getElementById('load-next-topic-btn');
            const explanationContainer = document.getElementById('explanation-container');
            const explanationTitle = document.getElementById('explanation-title');
            const explanationContent = document.getElementById('explanation-content');
            const whiteboardContainerSection = document.getElementById('whiteboard-container-section');
            const tldrawContainer = document.getElementById('tldraw-container');
            const chatPanel = document.getElementById('chat-panel');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const saveChatBtn = document.getElementById('save-chat-btn');
            const clearChatBtn = document.getElementById('clear-chat-btn');
            const nextStepBtn = document.getElementById('next-step-btn');
            const toastEl = document.getElementById('toast');
            const toastMessageEl = document.getElementById('toast-message');

            // --- Global Variables ---
            let currentUser = null;
            let currentProfile = null;
            // let availableTopics = []; // Nahrazeno načítáním z plánu
            let currentTopic = null; // { id: '...', name: '...', activity_id: '...' }
            let currentSessionId = null;
            let chatHistory = [];
            let tldrawApp = null;
            let geminiIsThinking = false;

            // --- Helper Functions (stejné) ---
             const sanitizeHTML = (str) => { /* ... */ const temp = document.createElement('div'); temp.textContent = str || ''; return temp.innerHTML; };
             const getInitials = (profile, email) => { /* ... */ if (!profile) return email ? email[0].toUpperCase() : '?'; let i = (profile.first_name?.[0]||'')+(profile.last_name?.[0]||''); return i.toUpperCase() || profile.username?.[0].toUpperCase() || email?.[0].toUpperCase() || '?'; };
             const showToast = (message, type = 'success', duration = 4000) => { /* ... */ if (!toastEl || !toastMessageEl) return; toastMessageEl.textContent = message; const icon = toastEl.querySelector('i'); icon.className = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-exclamation-triangle'; toastEl.className = 'toast ' + type; toastEl.classList.add('show'); setTimeout(() => toastEl.classList.remove('show'), duration); };
             const renderMarkdown = (element, markdownText) => { /* ... */ try { element.innerHTML = marked.parse(markdownText || ''); if (window.MathJax) setTimeout(() => window.MathJax.typesetPromise([element]).catch(e=>console.error("MathJax:",e)), 0); } catch (e) { console.error("Markdown:", e); element.innerHTML = `<p style="color: red;">Chyba zobrazení.</p>`; }};
             const autoResizeTextarea = () => { /* ... */ chatInput.style.height = 'auto'; chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px'; };
             const generateSessionId = () => `session_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
             const formatTimestamp = (date) => date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });

            // --- Initialization ---
            const initializeApp = async () => {
                if (!supabase) { showToast("Chyba: Supabase klient není inicializován.", "error"); return; }
                setupEventListeners();
                initTooltips();
                await loadUserProfile();
                if (currentUser) {
                     initializeTldraw(); // Init tldraw až po přihlášení
                     await loadNextTopicFromPlan(); // Automaticky načte první téma
                } else {
                     // Zobrazit zprávu, že je potřeba se přihlásit
                     currentTopicDisplay.innerHTML = '<span class="placeholder"><i class="fas fa-sign-in-alt"></i> Pro zahájení výuky se prosím přihlaste.</span>';
                     loadNextTopicBtn.disabled = true;
                }
            };

            const loadUserProfile = async () => { /* ... (stejné) ... */ };
            const updateUserInfoUI = () => { /* ... (stejné) ... */ };
            const setupEventListeners = () => { /* ... (sidebar, mobile menu stejné) ... */ if (mobileMenuToggle) mobileMenuToggle.addEventListener('click', () => { sidebar?.classList.toggle('active'); sidebarOverlay?.classList.toggle('active'); }); if (sidebarOverlay) sidebarOverlay.addEventListener('click', () => { sidebar?.classList.remove('active'); sidebarOverlay?.classList.remove('active'); }); window.addEventListener('resize', () => { if (window.innerWidth > 576 && sidebar?.classList.contains('active')) { sidebar.classList.remove('active'); sidebarOverlay?.classList.remove('active'); } }); /* ODSTRANĚNO: topicSelect listener */ /* ODSTRANĚNO: startLearningBtn listener */ if (loadNextTopicBtn) loadNextTopicBtn.addEventListener('click', loadNextTopicFromPlan); if (sendButton) sendButton.addEventListener('click', handleSendMessage); if (chatInput) { chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } }); chatInput.addEventListener('input', autoResizeTextarea); } if (saveChatBtn) saveChatBtn.addEventListener('click', saveChatToPDF); if (clearChatBtn) clearChatBtn.addEventListener('click', confirmClearChat); if (nextStepBtn) nextStepBtn.addEventListener('click', requestNextStep); };
            const initTooltips = () => { /* ... (stejné) ... */ };
            const initializeTldraw = () => { /* ... (stejné, volá se po přihlášení) ... */ if (typeof tldraw !== 'undefined' && tldraw.Tldraw && tldrawContainer) { try { console.log("Initializing tldraw..."); tldrawApp = new tldraw.Tldraw({ container: tldrawContainer, showUI: true, readOnly: false }); console.log("tldraw initialized:", tldrawApp); /* whiteboardContainerSection se zobrazí až po startLearningSession */ } catch (error) { console.error("Failed to initialize tldraw:", error); tldrawContainer.innerHTML = "<p style='padding: 1rem; color: red;'>Chyba inicializace interaktivní došky.</p>"; /* whiteboardContainerSection se zobrazí až po startLearningSession */ } } else { console.warn("tldraw library or container not found."); whiteboardContainerSection.style.display = 'flex'; tldrawContainer.innerHTML = "<p style='padding: 1rem; color: orange;'>Interaktivní doška není dostupná.</p>"; } };

            // --- Topic Loading and Learning Session ---
            const loadNextTopicFromPlan = async () => {
                if (!currentUser || !supabase) {
                    showToast("Nelze načíst téma, nejste přihlášeni.", "warning");
                    return;
                }
                 currentTopicDisplay.innerHTML = '<span class="placeholder"><i class="fas fa-spinner fa-spin"></i> Hledám další téma v plánu...</span>';
                 loadNextTopicBtn.disabled = true; // Deaktivovat během načítání
                 hideLearningUI(); // Skryje UI předchozího tématu

                 try {
                     // 1. Najít aktivní plán
                     const { data: activePlan, error: planError } = await supabase
                          .from('study_plans')
                          .select('id')
                          .eq('user_id', currentUser.id)
                          .eq('status', 'active')
                          .order('created_at', { ascending: false })
                          .limit(1)
                          .single(); // Očekáváme max jeden aktivní

                      if (planError) {
                           if (planError.code === 'PGRST116') { // No active plan found
                                throw new Error("Nebyl nalezen žádný aktivní studijní plán.");
                           }
                           throw planError; // Jiná chyba DB
                      }
                      if (!activePlan) throw new Error("Nebyl nalezen žádný aktivní studijní plán.");

                      // 2. Najít první nedokončenou aktivitu v tomto plánu
                      const { data: nextActivity, error: activityError } = await supabase
                           .from('plan_activities')
                           .select('id, title, day_of_week, time_slot') // Přidáme day/time pro řazení
                           .eq('plan_id', activePlan.id)
                           .eq('completed', false)
                           .order('day_of_week', { ascending: true })
                           .order('time_slot', { ascending: true })
                           .limit(1)
                           .single(); // Chceme jen jednu

                      if (activityError) {
                          if (activityError.code === 'PGRST116') { // No incomplete activities found
                               throw new Error("Všechny aktivity v plánu jsou dokončeny!");
                           }
                           throw activityError; // Jiná chyba DB
                      }
                     if (!nextActivity) throw new Error("Nebyly nalezeny žádné další nedokončené aktivity.");

                     // Máme další téma/aktivitu
                     currentTopic = {
                          id: `activity_${nextActivity.id}`, // Použijeme ID aktivity jako unikátní ID tématu v této session
                          name: nextActivity.title,
                          activity_id: nextActivity.id // Uložíme si ID aktivity pro případné označení jako dokončené
                     };

                      currentTopicDisplay.innerHTML = `Aktuální téma: <strong>${sanitizeHTML(currentTopic.name)}</strong>`;
                     loadNextTopicBtn.disabled = false; // Znovu aktivovat
                     await startLearningSession(); // Automaticky spustí session s novým tématem

                 } catch (error) {
                     console.error("Chyba při načítání dalšího tématu:", error);
                     showToast(error.message || "Nepodařilo se načíst další téma.", "error");
                     currentTopicDisplay.innerHTML = `<span class="placeholder" style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> ${error.message || 'Chyba načítání tématu.'}</span>`;
                     loadNextTopicBtn.disabled = false; // Znovu aktivovat
                 }
             };

            const startLearningSession = async () => {
                if (!currentTopic) {
                    console.error("startLearningSession voláno bez currentTopic");
                    return;
                }
                currentSessionId = generateSessionId(); // Nová session pro nové téma
                console.log(`Starting session ${currentSessionId} for topic: ${currentTopic.name} (Activity ID: ${currentTopic.activity_id})`);

                // Zobrazí UI
                explanationContainer.style.display = 'block';
                whiteboardContainerSection.style.display = 'flex';
                chatPanel.style.display = 'flex';

                explanationTitle.innerHTML = `<i class="fas fa-chalkboard-teacher"></i> Vysvětlení: ${sanitizeHTML(currentTopic.name)}`;
                explanationContent.innerHTML = '<div class="loading">Požaduji úvodní vysvětlení od AI...</div>';
                nextStepBtn.style.display = 'none';

                chatMessages.innerHTML = '';
                chatHistory = [];
                await addChatMessage(`Ahoj! Jsem připravený ti pomoct s tématem: **${sanitizeHTML(currentTopic.name)}**. Začneme se základy. Řekni **"pokračuj"** nebo polož otázku.`, 'gemini', true); // Uložíme první zprávu

                if (tldrawApp) { /* ... (reset tldraw stejný) ... */ try { tldrawApp.resetDocument(); console.log("tldraw reset."); } catch (e) { console.warn("Could not reset tldraw:", e); } }

                updateGeminiThinkingState(true);
                await sendToGemini(`Začni vysvětlovat ZÁKLADY tématu "${currentTopic.name}" pro 9. třídu ZŠ (přijímačky CERMAT). Rozděl to na malé kroky. Toto je PRVNÍ KROK.`, 'explanation');
                updateGeminiThinkingState(false);
                nextStepBtn.style.display = 'inline-flex';
            };

             const hideLearningUI = () => {
                  explanationContainer.style.display = 'none';
                  whiteboardContainerSection.style.display = 'none';
                  chatPanel.style.display = 'none';
                  explanationContent.innerHTML = '';
                  chatMessages.innerHTML = '';
                  if (tldrawApp) tldrawApp.resetDocument();
                  currentTopic = null;
                  currentSessionId = null;
                  chatHistory = [];
             };

            const requestNextStep = async () => { /* ... (stejné jako předtím) ... */ };

            // --- Chat Functionality (včetně DB ukládání a mazání) ---
             const addChatMessage = async (message, sender, saveToDb = false, timestamp = new Date()) => { /* ... (logika stejná, ověřuje currentSessionId a currentTopic před uložením do DB) ... */
                 const messageId = `msg_${Date.now()}_${Math.random().toString(16).slice(2)}`;
                 const messageDiv = document.createElement('div');
                 messageDiv.classList.add('chat-message', sender);
                 messageDiv.id = messageId;

                 const avatarDiv = document.createElement('div');
                 avatarDiv.classList.add('message-avatar');
                 avatarDiv.innerHTML = sender === 'user' ? sanitizeHTML(getInitials(currentProfile, currentUser?.email)) : '<i class="fas fa-robot"></i>';

                 const bubbleDiv = document.createElement('div');
                 bubbleDiv.classList.add('message-bubble');
                 renderMarkdown(bubbleDiv, message); // Use Markdown render

                 const timeDiv = document.createElement('div');
                 timeDiv.classList.add('message-timestamp');
                 timeDiv.textContent = formatTimestamp(timestamp);

                 messageDiv.appendChild(avatarDiv);
                 messageDiv.appendChild(bubbleDiv);
                 bubbleDiv.appendChild(timeDiv);
                 chatMessages.appendChild(messageDiv);
                 chatMessages.scrollTop = chatMessages.scrollHeight;

                 if (saveToDb && supabase && currentUser && currentSessionId && currentTopic) {
                      try {
                           const { error } = await supabase.from('chat_history').insert({
                                user_id: currentUser.id,
                                session_id: currentSessionId,
                                topic_id: currentTopic.id, // Použijeme ID z currentTopic (např. 'rovnice')
                                topic_name: currentTopic.name,
                                role: sender === 'user' ? 'user' : 'model',
                                content: message,
                                created_at: timestamp.toISOString()
                           });
                           if (error) throw error;
                           console.log(`Message saved (Session: ${currentSessionId}, Sender: ${sender})`);
                      } catch (dbError) {
                           console.error("DB save error:", dbError);
                           showToast("Chyba ukládání zprávy.", "error");
                           const errorIndicator = document.createElement('i');
                           errorIndicator.className = 'fas fa-exclamation-circle';
                           errorIndicator.style.cssText = 'color: var(--danger); font-size: 0.8em; margin-left: 5px;';
                           errorIndicator.title = `DB Error: ${dbError.message}`;
                           bubbleDiv.appendChild(errorIndicator);
                      }
                 }
                 return messageId;
              };
             const updateGeminiThinkingState = (isThinking) => { /* ... (stejné) ... */ };
             const addThinkingIndicator = () => { /* ... (stejné) ... */ };
             const removeThinkingIndicator = () => { /* ... (stejné) ... */ };
             const handleSendMessage = async () => { /* ... (stejné, ověří currentTopic) ... */ };
             const confirmClearChat = () => { /* ... (stejné, ověří currentSessionId) ... */ };
             const clearChatHistory = async () => { /* ... (stejné, používá currentSessionId) ... */ };
             const saveChatToPDF = () => { /* ... (stejné, používá currentTopic.name) ... */ };

            // --- Gemini Interaction ---
             const sendToGemini = async (promptText, targetArea) => { /* ... (stejné, ověří currentTopic, POUŽIJE NOVÝ PROMPT) ... */
                if (!GEMINI_API_KEY || GEMINI_API_KEY.startsWith('YOUR_')) { /* ... */ }
                if (!currentTopic) { /* ... */ }

                console.log(`Posílám Gemini (cíl: ${targetArea}): "${promptText}"`);
                const timestamp = new Date();
                 updateGeminiThinkingState(true); // Přesunuto sem, aby se indikátor zobrazil hned

                // --- !! AKTUALIZOVANÝ PROMPT (bez whiteboard-target) !! ---
                 const systemInstructionText = `Jsi AI Tutor "Justax", expert na matematiku pro 9. třídu ZŠ v ČR (přijímačky CERMAT). Vyučuješ téma: "${currentTopic.name}". Tvůj styl je jako PŘÁTELSKÝ, TRPĚLIVÝ a PODROBNÝ UČITEL. Vysvětluj krok za krokem, používej příklady. Důsledně používej Markdown pro formátování (nadpisy **, seznamy *, tučně **, kurzívu *) a MathJax syntax pro matematiku (blokové: $$...$$, inline: \\(...\\)). Odpovídej VŽDY ČESKY.

                 DŮLEŽITÉ POKYNY PRO VÝUKU:
                 1.  **KROK ZA KROKEM:** Nepokrývej příliš mnoho informací najednou. Zaměř se na jeden koncept nebo krok postupu v jedné odpovědi. Počkej na reakci studenta ("pokračuj", otázka) než přejdeš dál.
                 2.  **INTERAKTIVITA:** Aktivně zapojuj studenta. Pokládej otázky ("Co si myslíš, jaký bude další krok?", "Chápeš tento pojem?", "Chceš vidět další příklad?").
                 3.  **"BÍLÁ DOŠKA" (Konceptuálně):** Student má k dispozici interaktivní došku. Můžeš ho VYZVAT, aby si na ni něco zkusil nakreslit nebo napsat ("Zkus si teď na došce načrtnout...", "Můžeš si na došce zapsat hlavní kroky..."). Ty na došku NEKRESLÍŠ, pouze poskytuješ textové vysvětlení a příklady.
                 4.  **DÉLKA ODPOVĚDI:** Drž odpovědi relativně stručné a zaměřené na jeden krok/myšlenku.
                 5.  **REAKCE NA VSTUP:** Pečlivě čti poslední zprávu uživatele a reaguj na ni. Pokud nerozumíš, požádej o upřesnění. Pokud uživatel řekne "pokračuj" nebo "další krok", vysvětli následující logický krok tématu.`;

                 const historyLimit = 4;
                 const recentHistory = chatHistory.slice(-historyLimit);
                 const requestContents = [ { role: "user", parts: [{ text: `${systemInstructionText}\n\n**Kontext:**\n${recentHistory.map(m => `${m.role === 'user' ? 'Student' : 'Tutor'}: ${m.parts[0].text}`).join('\n')}\n\n**Aktuální požadavek studenta:**\n${promptText}` }] } ];

                 try {
                     const response = await fetch(GEMINI_API_URL, { /* ... (stejné fetch options) ... */ });
                     if (!response.ok) { /* ... (stejná error handling) ... */ }
                     const data = await response.json();
                     if (!data.candidates || !data.candidates[0]?.content?.parts[0]?.text) { /* ... */ }
                     const geminiResponseText = data.candidates[0].content.parts[0].text;
                     chatHistory.push({ role: "model", parts: [{ text: geminiResponseText }] });
                     processGeminiResponse(geminiResponseText, targetArea, timestamp); // Předáme čas pro DB
                 } catch (error) { /* ... (stejná error handling) ... */ }
                  finally {
                     updateGeminiThinkingState(false); // Ukončíme stav přemýšlení vždy
                 }
             };

             // Zpracování odpovědi - již nehledá whiteboard-target
             const processGeminiResponse = (responseText, targetArea, timestamp) => {
                 removeThinkingIndicator();
                 const mainExplanationText = responseText.trim(); // Celá odpověď je hlavní text

                 if (targetArea === 'explanation') {
                     const stepDiv = document.createElement('div');
                     stepDiv.className = 'step';
                     renderMarkdown(stepDiv, mainExplanationText);
                     explanationContent.appendChild(stepDiv);
                     explanationContent.scrollTop = explanationContent.scrollHeight;
                     // Uložíme odpověď do DB
                     addChatMessage(responseText, 'gemini', true, timestamp); // Uložíme celou odpověď
                     nextStepBtn.style.display = 'inline-flex'; // Zobrazíme tlačítko Další krok
                 } else { // Chat nebo fallback
                      addChatMessage(mainExplanationText, 'gemini', true, timestamp);
                 }
             };

             const handleGeminiError = (errorMessage, targetArea, timestamp) => { /* ... (stejné, ale volá updateGeminiThinkingState(false)) ... */ removeThinkingIndicator(); updateGeminiThinkingState(false); const errorText = `Omlouvám se, nastala chyba: ${errorMessage}`; if (targetArea === 'explanation') { const errorDiv = document.createElement('p'); errorDiv.style.color = 'red'; errorDiv.textContent = errorText; explanationContent.appendChild(errorDiv); explanationContent.scrollTop = explanationContent.scrollHeight; addChatMessage(errorText, 'gemini', true, timestamp); } else { addChatMessage(errorText, 'gemini', true, timestamp); } if (targetArea === 'explanation' && nextStepBtn) { nextStepBtn.disabled = false; nextStepBtn.innerHTML = '<i class="fas fa-redo"></i> Zkusit znovu'; nextStepBtn.onclick = requestNextStep; } };

            // --- Run Application ---
            initializeApp();
        });
    </script>

</body>
</html>