<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {/* Используем оригинальный title из вашего файла */}
    <title>Justax - Výuka s AI (Videocall Interface v2.1)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    {/* MathJax Configuration */}
    <script>
        if (typeof window.MathJax === 'undefined') {
            window.MathJax = {
                tex: { inlineMath: [['\\(', '\\)']], displayMath: [['$$', '$$']], processEscapes: true, processEnvironments: true },
                options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' },
                startup: { ready: () => { MathJax.startup.defaultReady(); MathJax.startup.promise.then(() => console.log('MathJax loaded and ready.')); } }
            };
        } else {
             console.warn("window.MathJax already defined, skipping default config assignment.");
        }
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    {/* Supabase & Marked */}
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    {/* jQuery & Tooltipster */}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>

    {/* PDF Export */}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    {/* Excalidraw Dependencies & Library - СИНХРОННАЯ ЗАГРУЗКА (БЕЗ DEFER) */}
    {/* Важен порядок: React -> ReactDOM -> Excalidraw */}
    <script src="https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17.0.2/umd/react-dom.production.min.js" crossorigin></script>
    {/* Excalidraw БЕЗ defer */}
    <script src="https://cdn.jsdelivr.net/npm/@excalidraw/excalidraw@0.17.0/dist/excalidraw.production.min.js" crossorigin></script>

    <style>
        /* --- ВАШИ ОРИГИНАЛЬНЫЕ CSS СТИЛИ --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; scroll-behavior: smooth; }
        :root {
            --primary-rgb: 67, 97, 238; --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9; --success: #06d6a0; --danger: #f72585; --warning: #f8961e; --info: #4cc9f0; --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d; --gray-light: #dee2e6; --gray-dark: #343a40; --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3); --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee); --white: #ffffff; --sidebar-width: 260px; --transition-speed: 0.3s; --card-radius: 12px; --shadow-sm: 0 2px 6px rgba(0, 0, 0, 0.05); --shadow-md: 0 5px 12px rgba(0, 0, 0, 0.07); --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1); --text-primary: #2d3748; --text-secondary: #4a5568; --text-muted: #718096; --call-bg: #f0f2f5; --call-panel-bg: var(--white); --avatar-size: 50px;
        }
        body { background-color: var(--call-bg); color: var(--text-primary); min-height: 100vh; display: flex; overflow: hidden; }

        /* --- Sidebar --- */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 1050; box-shadow: var(--shadow-lg); transition: transform var(--transition-speed) ease, width var(--transition-speed) ease; }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; }
        .sidebar-logo { font-size: 1.5rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo i { font-size: 1.75rem; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .sidebar-item { margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; color: rgba(255, 255, 255, 0.85); text-decoration: none; border-radius: 12px; transition: all 0.2s ease; font-weight: 500; }
        .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; width: 24px; text-align: center; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--white); }
        .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); text-align: center; }
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.1); border-radius: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-weight: 500; overflow: hidden; color: var(--white); }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; }
        .user-name { font-weight: 600; font-size: 0.95rem; }
        .user-role { font-size: 0.8rem; opacity: 0.8; }

        /* --- Main Content Area --- */
        main { flex: 1; margin-left: var(--sidebar-width); transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); height: 100vh; display: flex; flex-direction: column; overflow: hidden; background-color: var(--call-bg); }
        .main-header { padding: 1rem 1.5rem; background-color: var(--white); box-shadow: var(--shadow-sm); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; z-index: 100; border-bottom: 1px solid var(--gray-light); }
        .header-content h1 { font-size: 1.5rem; font-weight: 600; color: var(--dark); margin: 0; }
        .header-actions button, .header-actions a { font-size: 0.9rem; padding: 0.6rem 1.2rem; }

        /* --- Videocall Interface Layout --- */
        .call-interface { flex-grow: 1; display: flex; overflow: hidden; padding: 1.5rem; gap: 1.5rem; }

        /* Left Side: AI Presenter Area */
        .ai-presenter-area { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--call-panel-bg); border-radius: var(--card-radius); box-shadow: var(--shadow-md); overflow: hidden; border: 1px solid var(--gray-light); }
        .ai-presenter-header { padding: 0.75rem 1.25rem; border-bottom: 1px solid var(--gray-light); display: flex; align-items: center; gap: 0.75rem; background-color: var(--light); }
        .ai-avatar-placeholder { width: var(--avatar-size); height: var(--avatar-size); background: var(--gradient-1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0; box-shadow: var(--shadow-sm); }
        .ai-presenter-info h2 { font-size: 1.1rem; font-weight: 600; color: var(--dark); margin: 0; }
        .ai-presenter-info p { font-size: 0.85rem; color: var(--text-secondary); margin: 0; }
        .whiteboard-main-container { flex-grow: 1; position: relative; overflow: hidden; border-radius: 0 0 var(--card-radius) var(--card-radius); background-color: var(--white); }

        /* Specific styles for Excalidraw container (replacing tldraw-wrapper styles) */
        #excalidraw-container { height: 100%; width: 100%; display: flex; align-items: center; justify-content: center;}
        #excalidraw-container .excalidraw-wrapper { height: 100% !important; width: 100% !important; } /* Ensure Excalidraw fills the container */
        #excalidraw-container > p { padding: 2rem; text-align: center; font-style: italic; color: var(--text-muted); } /* Style for loading message */


        /* Right Side: Interaction Panel */
        .interaction-panel { width: 420px; flex-shrink: 0; display: flex; flex-direction: column; background-color: var(--call-panel-bg); border-radius: var(--card-radius); box-shadow: var(--shadow-md); overflow: hidden; border: 1px solid var(--gray-light); }
        .interaction-tabs { display: flex; border-bottom: 1px solid var(--gray-light); background-color: var(--light); flex-shrink: 0; }
        .interaction-tab { flex: 1; text-align: center; padding: 0.9rem 1rem; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; border-bottom: 3px solid transparent; font-size: 0.95rem; position: relative; }
        .interaction-tab:hover { color: var(--primary); background-color: rgba(var(--primary-rgb), 0.05); }
        .interaction-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; background-color: var(--call-panel-bg); }
        .interaction-tab.active::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 1px; background-color: var(--gray-light); }
        .interaction-tab i { margin-right: 0.5rem; }

        .interaction-content-area { flex-grow: 1; overflow: hidden; position: relative; }
        .tab-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; visibility: hidden; opacity: 0; transition: opacity 0.3s ease, visibility 0s linear 0.3s; background-color: var(--call-panel-bg); }
        .tab-content.active { visibility: visible; opacity: 1; transition: opacity 0.3s ease; }

        /* Explanation Tab Content */
        .explanation-scroll-content { flex-grow: 1; padding: 1.5rem; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--gray-light) transparent; }
        .explanation-scroll-content::-webkit-scrollbar { width: 8px; } .explanation-scroll-content::-webkit-scrollbar-track { background: transparent; } .explanation-scroll-content::-webkit-scrollbar-thumb { background-color: var(--gray-light); border-radius: 4px; border: 2px solid var(--call-panel-bg); }
        #explanation-title { display: none; }
        #explanation-display { line-height: 1.7; }
        #explanation-display p:last-child { margin-bottom: 0; }
        #explanation-display .step { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed var(--gray-light); }
        #explanation-display .step:last-child { border-bottom: none; padding-bottom: 0; }
        #explanation-display h3 { color: var(--secondary); margin-top: 1.5rem; margin-bottom: 0.7rem; font-size: 1.1rem; }
        #explanation-display code { background-color: rgba(var(--primary-rgb), 0.1); padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.95em; color: var(--secondary); }
        #explanation-display pre { margin: 1rem 0; }
        #explanation-display pre code { display: block; background-color: var(--gray-dark); color: #e0e0e0; padding: 1rem; border-radius: 8px; font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
        #explanation-display strong { color: var(--dark); font-weight: 600; }
        #explanation-display blockquote { border-left: 3px solid var(--primary-light); padding-left: 1rem; margin: 1rem 0 1rem 0.5rem; color: var(--text-secondary); font-style: italic; }
        #explanation-display ul, #explanation-display ol { margin-left: 1.5rem; margin-bottom: 1rem; padding-left: 1rem; }
        #explanation-display li { margin-bottom: 0.5rem; }
        .explanation-controls { flex-shrink: 0; margin-top: auto; padding: 1rem 1.5rem; border-top: 1px solid var(--gray-light); text-align: center; background-color: var(--light); display: flex; justify-content: space-around; gap: 1rem; }

        /* Chat Tab Content */
        .chat-messages { flex-grow: 1; padding: 1.25rem; overflow-y: auto; scrollbar-color: var(--gray-light) var(--call-panel-bg); }
        .chat-messages::-webkit-scrollbar-track { background: var(--call-panel-bg); } .chat-messages::-webkit-scrollbar-thumb { border-color: var(--call-panel-bg); }
        .chat-input-area { flex-shrink: 0; padding: 1rem 1.25rem; background-color: var(--light); border-top: 1px solid var(--gray-light); display: flex; align-items: flex-end; gap: 0.8rem; }
        .chat-message { display: flex; gap: 0.8rem; max-width: 88%; align-items: flex-end; margin-bottom: 1rem; }
        .chat-message.user { margin-left: auto; flex-direction: row-reverse; }
        .message-avatar { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1rem; flex-shrink: 0; box-shadow: var(--shadow-sm); border: 2px solid var(--call-panel-bg); }
        .chat-message.user .message-avatar { background: var(--success); color: white; }
        .chat-message.gemini .message-avatar { background: var(--primary); color: white; }
        .message-bubble { padding: 0.9rem 1.2rem; border-radius: 18px; line-height: 1.6; word-wrap: break-word; box-shadow: var(--shadow-sm); position: relative; transition: transform 0.2s ease; background-color: var(--light); color: var(--text-primary); border: 1px solid #e9ecef; }
        .chat-message.gemini .message-bubble { border-bottom-left-radius: 5px; }
        .chat-message.user .message-bubble { background: var(--gradient-1); color: white; border: none; border-bottom-right-radius: 5px; }
        .message-bubble code { background-color: rgba(var(--primary-rgb), 0.1); padding: 0.1em 0.3em; border-radius: 4px; font-size: 0.9em; color: var(--secondary); }
        .chat-message.user .message-bubble code { background-color: rgba(255, 255, 255, 0.2); color: #fff; }
        .message-bubble pre { margin: 0.5rem 0; }
        .message-bubble pre code { display: block; background-color: var(--gray-dark); color: #e0e0e0; padding: 0.8rem; border-radius: 6px; font-size: 0.85rem; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
        .chat-message.user .message-bubble pre code { background-color: rgba(0,0,0,0.3); color: #eee; }
        .message-timestamp { font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; display: block; text-align: left; opacity: 0.8; }
        .chat-message.user .message-timestamp { text-align: right; }
        .message-thinking-indicator { background: var(--light); display: flex; align-items: center; padding: 0.9rem 1.2rem; border-radius: 18px; box-shadow: var(--shadow-sm); border: 1px solid #e9ecef; width: fit-content; }
        .typing-dot { width: 7px; height: 7px; background-color: var(--gray); border-radius: 50%; margin: 0 2px; display: inline-block; animation: typing 1.2s infinite ease-in-out; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; } .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.5; } 30% { transform: translateY(-3px); opacity: 1; } }
        .chat-input { flex-grow: 1; padding: 0.8rem 1.1rem; border: 1px solid var(--gray-light); border-radius: 22px; font-size: 1rem; resize: none; max-height: 150px; overflow-y: auto; transition: border-color 0.2s ease, box-shadow 0.2s ease; line-height: 1.4; }
        .chat-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.15); }
        .send-button { padding: 0 1.3rem; border-radius: 22px; font-weight: 500; font-size: 1rem; cursor: pointer; border: none; background: var(--gradient-1); color: white; transition: all 0.3s ease; flex-shrink: 0; height: 44px; display: flex; align-items: center; justify-content: center; }
        .send-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(var(--primary-rgb), 0.2); }
        .send-button i { font-size: 1.1em; } .send-button .fa-spinner { margin: 0; }
        .chat-controls { padding: 0.5rem 1.25rem; font-size: 0.8rem; color: var(--text-muted); text-align: right; background-color: var(--light); border-top: 1px solid var(--gray-light); flex-shrink: 0; }
        .chat-controls button { background:none; border:none; color: var(--text-muted); cursor:pointer; font-size: 0.9em; padding: 2px 5px; margin-left: 10px; }
        .chat-controls button:hover { color: var(--primary); }

        /* Topic Loading Bar */
        .topic-loading-bar { padding: 1rem 1.5rem; background-color: var(--light); border-bottom: 1px solid var(--gray-light); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; flex-shrink: 0; }
        #current-topic-display { font-size: 1rem; font-weight: 500; color: var(--text-secondary); }
        #current-topic-display strong { color: var(--primary); font-weight: 600; }
        #current-topic-display .placeholder { font-style: italic; color: var(--text-muted); }
        #load-next-topic-btn { display: none; } /* Button removed in original */

        /* Utility & State Styles */
        .loading-placeholder { display: flex; align-items: center; justify-content: center; padding: 3rem; text-align: center; font-style: italic; color: var(--text-muted); flex-grow: 1; }
        .loading-placeholder i { margin-right: 0.75rem; font-size: 1.5rem; }
        .empty-state { text-align: center; padding: 3rem 1.5rem; color: var(--text-secondary); margin-top: 2rem; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .empty-state i { font-size: 3.5rem; margin-bottom: 1.5rem; color: var(--gray-light); }
        .empty-state h3 { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; color: var(--dark); }
        .empty-state p { margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.7rem 1.4rem; border-radius: 8px; font-weight: 500; font-size: 0.9rem; text-decoration: none; transition: all 0.2s ease; cursor: pointer; border: none; gap: 0.5rem; line-height: 1.4; }
        .btn-primary { background: var(--gradient-1); color: white; box-shadow: var(--shadow-sm); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); background: linear-gradient(135deg, var(--primary-light), var(--secondary)); }
        .btn-secondary { background-color: var(--light); color: var(--text-secondary); border: 1px solid var(--gray-light); box-shadow: var(--shadow-sm); }
        .btn-secondary:hover:not(:disabled) { background-color: #e9ecef; color: var(--dark); border-color: #ced4da; }
        .btn-success { background: linear-gradient(135deg, var(--success), #05a381); color: white; box-shadow: var(--shadow-sm); }
        .btn-success:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); background: linear-gradient(135deg, #0cd1a7, var(--success));}
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; background: var(--gray); color: var(--white); }
        .btn i { font-size: 1em; }

        /* Responsiveness & Mobile Menu */
        .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; color: var(--dark); font-size: 1.5rem; margin-right: 1rem; padding: 0.5rem; z-index: 1060; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1040; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        .sidebar-overlay.active { display: block; opacity: 1; }

        @media (max-width: 1200px) {
             :root { --sidebar-width: 240px; }
             .interaction-panel { width: 380px; }
        }
        @media (max-width: 992px) {
             .sidebar { transform: translateX(-100%); }
             .sidebar.active { transform: translateX(0); }
             main { margin-left: 0; width: 100%; }
             .mobile-menu-toggle { display: block; }
             .call-interface { flex-direction: column; padding: 1rem; gap: 1rem; }
             .ai-presenter-area { height: 50vh; /* Adjust height as needed */ min-height: 300px; }
             .interaction-panel { width: 100%; max-height: calc(50vh - 80px); /* Adjust based on header/gaps */ min-height: 250px; }
             .explanation-scroll-content { padding: 1rem; }
             .chat-messages { padding: 1rem; }
             .chat-input-area { padding: 0.75rem 1rem; }
             .main-header { padding: 0.75rem 1rem; }
             .header-content h1 { font-size: 1.2rem; }
        }
        @media (max-width: 768px) {
             :root { --sidebar-width: 220px; }
              .ai-presenter-area { height: 45vh; }
              .interaction-panel { max-height: calc(55vh - 70px); }
             .interaction-tab { padding: 0.8rem 0.5rem; font-size: 0.9rem; }
             .btn { padding: 0.6rem 1.2rem; font-size: 0.85rem; }
             .header-actions a { padding: 0.5rem 1rem; }
        }
        @media (max-width: 576px) {
             .sidebar { width: 100%; max-width: 280px; }
             .sidebar-logo span { display: inline; }
             .ai-presenter-area { height: 40vh; min-height: 250px; }
             .interaction-panel { max-height: calc(60vh - 60px); min-height: 200px; }
             .interaction-tab i { margin-right: 0.3rem; }
             .chat-input { font-size: 0.95rem; padding: 0.7rem 1rem; }
             .send-button { padding: 0 1.1rem; height: 40px; }
             .message-bubble { padding: 0.8rem 1rem; font-size: 0.95rem; }
             .message-avatar { width: 32px; height: 32px; font-size: 0.9rem; }
             .explanation-controls button { padding: 0.6rem 1rem; }
              .chat-controls { font-size: 0.75rem; padding: 0.4rem 1rem; }
              .chat-controls button { margin-left: 5px; font-size: 0.85em;}
              .toast { min-width: 250px; bottom: 15px; right: 15px; padding: 0.9rem 1.2rem; font-size: 0.9rem; }
        }

        /* Dark mode Adjustments */
        @media (prefers-color-scheme: dark) {
             :root { --white: #1a202c; --light: #2d3748; --dark: #e2e8f0; --gray-light: #4a5568; --text-primary: #e2e8f0; --text-secondary: #cbd5e0; --text-muted: #a0aec0; --dark-bg: #171923; --call-bg: #131720; --call-panel-bg: #1e2533; }
             body { background-color: var(--dark-bg); }
             main { background-color: var(--call-bg); }
             .main-header { background-color: var(--call-panel-bg); border-bottom-color: var(--gray-light); }
             .mobile-menu-toggle { color: var(--dark); }
             .ai-presenter-area, .interaction-panel { background-color: var(--call-panel-bg); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); border-color: var(--gray-light); }
             .ai-presenter-header { background-color: var(--light); border-bottom-color: var(--gray-light); }
             .whiteboard-main-container { background-color: var(--dark-bg); }
             #excalidraw-container { background-color: var(--dark-bg); } /* Adjusted for Excalidraw */
             .interaction-tabs { background-color: var(--light); border-bottom-color: var(--gray-light); }
             .interaction-tab { color: var(--text-secondary); }
             .interaction-tab:hover { color: var(--primary-light); background-color: rgba(72, 149, 239, 0.1); }
             .interaction-tab.active { color: var(--primary-light); border-bottom-color: var(--primary-light); background-color: var(--call-panel-bg); }
             .tab-content { background-color: var(--call-panel-bg); }
             .explanation-scroll-content { scrollbar-color: var(--gray) var(--call-panel-bg); }
             .explanation-scroll-content::-webkit-scrollbar-thumb { border-color: var(--call-panel-bg); }
             #explanation-display pre code { background-color: #1a202c; color: #d1d5db; }
             #explanation-display code { background-color: rgba(72, 149, 239, 0.15); color: var(--primary-light); }
             #explanation-display strong { color: var(--light); }
             #explanation-display blockquote { border-left-color: var(--primary); color: var(--text-secondary); }
             .explanation-controls { background-color: var(--light); border-top-color: var(--gray-light); }
             .chat-messages { scrollbar-color: var(--gray) var(--call-panel-bg); }
             .chat-messages::-webkit-scrollbar-track { background: var(--call-panel-bg); }
             .chat-messages::-webkit-scrollbar-thumb { border-color: var(--call-panel-bg); }
             .message-avatar { border-color: var(--call-panel-bg); }
             .message-bubble { background-color: var(--light); color: var(--text-primary); border-color: var(--gray-light); }
             .chat-message.user .message-bubble { background: var(--gradient-2); color: var(--dark); }
             .message-bubble code { background-color: rgba(255,255,255,0.1); color: var(--text-primary); }
             .chat-message.user .message-bubble code { background-color: rgba(0, 0, 0, 0.2); color: var(--light); }
             .message-bubble pre code { background-color: #1a202c; color: #d1d5db; }
             .chat-message.user .message-bubble pre code { background-color: rgba(0,0,0,0.3); color: #eee; }
             .message-thinking-indicator { background: var(--light); border-color: var(--gray-light);}
             .typing-dot { background-color: var(--gray); }
             .chat-input-area { background-color: var(--light); border-top-color: var(--gray-light); }
             .chat-input { background-color: var(--dark-bg); color: var(--text-primary); border-color: var(--gray-light); }
             .chat-input::placeholder { color: var(--text-muted); }
             .chat-input:focus { box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.2); }
             .chat-controls { background-color: var(--light); border-top-color: var(--gray-light); }
             .chat-controls button { color: var(--text-muted); }
             .chat-controls button:hover { color: var(--primary-light); }
             .btn-secondary { background-color: var(--light); color: var(--text-secondary); border-color: var(--gray-light); }
             .btn-secondary:hover:not(:disabled) { background-color: var(--gray-light); color: var(--dark); }
             .btn-success { background: linear-gradient(135deg, var(--success), #05a381); }
             .btn-success:hover:not(:disabled) { background: linear-gradient(135deg, #0cd1a7, var(--success));}
             .btn:disabled { background: var(--gray); color: var(--text-muted); }
             .topic-loading-bar { background-color: var(--light); border-bottom-color: var(--gray-light); }
             .empty-state i { color: var(--light); }
             .toast { background-color: var(--call-panel-bg); border-color: var(--gray-light); color: var(--text-primary); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);}
        }

        /* Toast notification */
        .toast { position: fixed; bottom: 20px; right: 20px; background-color: var(--white); color: var(--text-primary); padding: 1rem 1.5rem; border-radius: var(--card-radius); box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 1rem; z-index: 1100; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s, transform 0.3s ease; transform: translateY(20px); min-width: 300px; border: 1px solid var(--gray-light); }
        .toast.show { opacity: 1; visibility: visible; transform: translateY(0); transition: opacity 0.3s ease, visibility 0s, transform 0.3s ease; }
        .toast i { font-size: 1.3rem; }
        .toast.success i { color: var(--success); } .toast.error i { color: var(--danger); } .toast.warning i { color: var(--warning); } .toast.info i { color: var(--info); }

    </style>
</head>
<body>
    <script>
        try {
            document.addEventListener('DOMContentLoaded', async function() {
                console.log("DOM Loaded. Initializing application...");

                // --- Constants & Config ---
                const SUPABASE_URL = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
                const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // Test key
                const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                const DRAW_COMMAND_REGEX = /DRAW_ON_WHITEBOARD:\s*```json\s*([\s\S]*?)\s*```/g;
                const EXCALIDRAW_INIT_CHECK_INTERVAL = 250; // Zvýšeno na 250ms
                const EXCALIDRAW_INIT_MAX_RETRIES = 20; // Zvýšeno na 20 pokusů (~5 sekund)

                // --- DOM Elements ---
                const userAvatarEl = document.getElementById('user-avatar');
                const userNameEl = document.getElementById('user-name');
                const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
                const sidebar = document.getElementById('sidebar');
                const sidebarOverlay = document.getElementById('sidebar-overlay');
                const currentTopicDisplay = document.getElementById('current-topic-display');
                const explanationDisplay = document.getElementById('explanation-display');
                const explanationScrollContent = document.querySelector('.explanation-scroll-content');
                // Změna: Používáme #excalidraw-container místo #tldraw-wrapper
                const excalidrawContainer = document.getElementById('excalidraw-container');
                const chatMessages = document.getElementById('chat-messages');
                const chatInput = document.getElementById('chat-input');
                const sendButton = document.getElementById('send-button');
                const saveChatBtn = document.getElementById('save-chat-btn');
                const clearChatBtn = document.getElementById('clear-chat-btn');
                const nextStepBtn = document.getElementById('next-step-btn');
                const markCompleteBtn = document.getElementById('mark-complete-btn');
                const toastEl = document.getElementById('toast');
                const toastMessageEl = document.getElementById('toast-message');
                const interactionTabs = document.querySelectorAll('.interaction-tab');
                const tabContents = document.querySelectorAll('.tab-content');
                const aiStatusText = document.getElementById('ai-status-text');
                const callInterface = document.querySelector('.call-interface');

                // --- Global State ---
                let supabase = null;
                let currentUser = null;
                let currentProfile = null;
                let currentTopic = null;
                let currentPlanId = null;
                let currentSessionId = null;
                let geminiChatContext = [];
                let excalidrawAPI = null; // Nahrazuje tldrawApp
                let ExcalidrawLib = null; // Reference na Excalidraw knihovnu
                let geminiIsThinking = false;
                let thinkingIndicatorId = null;
                let topicLoadInProgress = false;
                let excalidrawInitRetries = 0; // Počítadlo pro inicializaci Excalidraw

                // --- Helper Functions ---
                const sanitizeHTML = (str) => { const temp = document.createElement('div'); temp.textContent = str || ''; return temp.innerHTML; };
                const getInitials = (profile, email) => { /* ... */ };
                const showToast = (message, type = 'info', duration = 4000) => { /* ... */ };
                const renderMarkdown = (element, markdownText) => { /* ... */ };
                const autoResizeTextarea = () => { /* ... */ };
                const generateSessionId = () => `session_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
                const formatTimestamp = (date) => date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
                const updateAIStatus = (text) => { if (aiStatusText) aiStatusText.textContent = text; };

                // --- Initialization Functions ---

                // Robustnější inicializace Excalidraw
                const tryInitializeExcalidrawWhenReady = () => {
                    console.log(`Attempting Excalidraw init (Retry: ${excalidrawInitRetries}/${EXCALIDRAW_INIT_MAX_RETRIES})`);
                    if (excalidrawAPI) { console.log("Excalidraw already initialized."); return; }

                    if (typeof React !== 'undefined' && typeof ReactDOM !== 'undefined' && typeof Excalidraw !== 'undefined') {
                        if (initializeExcalidraw()) { console.log("Excalidraw successfully initialized after check."); }
                        else { console.error("Excalidraw initialization function failed even though libraries seem loaded."); }
                    } else {
                        excalidrawInitRetries++;
                        if (excalidrawInitRetries <= EXCALIDRAW_INIT_MAX_RETRIES) {
                            console.log(`Libraries not ready, retrying in ${EXCALIDRAW_INIT_CHECK_INTERVAL}ms...`);
                            setTimeout(tryInitializeExcalidrawWhenReady, EXCALIDRAW_INIT_CHECK_INTERVAL);
                        } else {
                            console.error(`Excalidraw libraries failed to load after ${EXCALIDRAW_INIT_MAX_RETRIES} retries.`);
                            if (excalidrawContainer) excalidrawContainer.innerHTML = "<p style='color: red; padding: 1rem;'>Chyba: Knihovny pro kreslení se nepodařilo načíst včas.</p>";
                            showToast("Chyba načítání kreslící plochy.", "error", 10000);
                        }
                    }
                };

                 const initializeExcalidraw = () => {
                    console.log("Executing initializeExcalidraw function...");
                    if (excalidrawAPI) { console.log("Excalidraw instance already exists."); return true; }

                    // Explicitní kontrola PŘED použitím - jako poslední záchrana
                    if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof Excalidraw === 'undefined') {
                         console.error("FATAL: React, ReactDOM, or Excalidraw missing JUST BEFORE RENDER.");
                         return false;
                    }

                    ExcalidrawLib = Excalidraw;
                    if (!excalidrawContainer) { console.error("Element #excalidraw-container not found!"); return false; }

                    try {
                        const ExcalidrawComponent = () => {
                            const excalidrawRef = React.useRef(null);
                            React.useEffect(() => {
                                excalidrawAPI = excalidrawRef.current;
                                console.log("Excalidraw API reference obtained:", excalidrawAPI ? 'OK' : 'Failed');
                            }, []);

                            // Vracíme React element
                            return React.createElement(
                                "div", { style: { height: "100%", width: "100%" }, className: "excalidraw-wrapper" },
                                React.createElement(ExcalidrawLib.Excalidraw, {
                                    ref: excalidrawRef,
                                    theme: window.matchMedia?.('(prefers-color-scheme: dark)').matches ? 'dark' : 'light',
                                    initialData: { elements: [], appState: { viewBackgroundColor: window.matchMedia?.('(prefers-color-scheme: dark)').matches ? '#1e2533' : '#ffffff' } },
                                    UIOptions: { canvasActions: { changeViewBackgroundColor: true, clearCanvas: true, loadScene: false } }
                                })
                            );
                        };
                        ReactDOM.render(React.createElement(ExcalidrawComponent), excalidrawContainer);
                        console.log("Excalidraw component render initiated.");
                        return true;
                    } catch (error) {
                        console.error("Failed to render Excalidraw component:", error);
                        if (excalidrawContainer) excalidrawContainer.innerHTML = `<p style='color: red; padding: 1rem;'>Chyba vykreslení kreslící plochy: ${error.message}</p>`;
                        showToast("Chyba vykreslení kreslení.", "error");
                        return false;
                    }
                 };

                const initializeApp = async () => {
                    try {
                        supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        if (!supabase) throw new Error("Supabase client creation failed.");
                        console.log("Supabase client initialized.");
                    } catch (error) { console.error("Supabase initialization failed:", error); /* ... */ return; }

                    setupEventListeners();
                    initTooltips();

                    // *** Start checking for Excalidraw readiness AFTER main setup ***
                    tryInitializeExcalidrawWhenReady();

                    await loadUserProfile();
                    if (currentUser) { await loadNextUncompletedTopic(); }
                    else { /* ... */ }
                };

                // --- User Profile, Event Listeners, Tooltips ---
                const loadUserProfile = async () => { /* ... (beze změny) ... */ };
                const updateUserInfoUI = () => { /* ... (beze změny) ... */ };
                const setupEventListeners = () => { /* ... (beze změny) ... */ };
                const initTooltips = () => { /* ... (beze změny) ... */ };

                // --- Topic Loading and Progress ---
                const loadNextUncompletedTopic = async () => { /* ... (beze změny) ... */ };
                const handleMarkTopicComplete = async () => { /* ... (beze změny) ... */ };

                 // --- Learning Session Management ---
                 const startLearningSession = async () => { /* ... (stejné, volá initializeExcalidraw) ... */ };
                 const showLearningUI = () => { /* ... (beze změny) ... */ };
                 const hideLearningUI = () => { /* ... (beze změny) ... */ };
                 const switchInteractionTab = (tabId) => { /* ... (beze změny) ... */ };
                 const requestNextStep = async () => { /* ... (beze změny) ... */ };

                 // --- Chat Functionality ---
                 const addChatMessage = async (message, sender, saveToDb = false, timestamp = new Date()) => {
                    // ... (vytvoření HTML) ...
                     if (!chatMessages) return;
                     const messageId = `${sender}_${timestamp.getTime()}_${Math.random().toString(16).slice(2)}`;
                     const messageDiv = document.createElement('div'); messageDiv.classList.add('chat-message', sender); messageDiv.id = messageId;
                     const avatarDiv = document.createElement('div'); avatarDiv.classList.add('message-avatar'); avatarDiv.innerHTML = sender === 'user' ? getInitials(currentProfile, currentUser?.email) : '<i class="fas fa-robot"></i>';
                     const bubbleDiv = document.createElement('div'); bubbleDiv.classList.add('message-bubble'); renderMarkdown(bubbleDiv, message);
                     const timestampDiv = document.createElement('div'); timestampDiv.classList.add('message-timestamp'); timestampDiv.textContent = formatTimestamp(timestamp); bubbleDiv.appendChild(timestampDiv);
                     if (sender === 'user') { messageDiv.appendChild(bubbleDiv); messageDiv.appendChild(avatarDiv); } else { messageDiv.appendChild(avatarDiv); messageDiv.appendChild(bubbleDiv); }
                     chatMessages.appendChild(messageDiv);
                     requestAnimationFrame(() => { chatMessages.scrollTop = chatMessages.scrollHeight; });

                    // --- SUPABASE CHAT SAVE (s opravou názvů + kontrolou activity_id) ---
                    if (saveToDb && supabase && currentUser && currentTopic && currentSessionId) {
                        const dataToSave = {
                            user_id: currentUser.id,
                            session_id: currentSessionId,
                            topic_name: currentTopic.name,
                            role: sender, // Correct column name
                            content: message, // Correct column name
                            created_at: timestamp.toISOString(),
                            // topic_id: null, // Add if you have topic ID
                        };
                        // Conditionally add activity_id if it exists
                        if (currentTopic.activity_id) {
                            // !! VERIFY this column name in your DB !!
                            dataToSave.activity_id = currentTopic.activity_id;
                            console.log(`Including activity_id: ${currentTopic.activity_id}`);
                        } else {
                             console.warn("activity_id not found in currentTopic, skipping for DB insert.");
                        }

                        console.log("Attempting to save to chat_history:", dataToSave);
                        try {
                            const { error } = await supabase.from('chat_history').insert(dataToSave);
                            if (error) {
                                console.error("Error saving chat message to Supabase:", error);
                                let userMessage = `Chyba ukládání zprávy: ${error.message}`;
                                if (error.code === '42703' || (error.message.includes("column") && error.message.includes("does not exist"))) {
                                    const wrongCol = error.message.match(/column "(\w+)"/);
                                    userMessage = `Chyba DB: Sloupec '${wrongCol ? wrongCol[1] : '?'}' neexistuje.`;
                                } else if (error.message.includes("violates not-null constraint")) {
                                     const missingCol = error.message.match(/null value in column "(\w+)"/);
                                     userMessage = `Chyba DB: Povinný sloupec '${missingCol ? missingCol[1] : '?'}' není vyplněn.`;
                                }
                                showToast(userMessage, "error", 7000);
                            } else { console.log("Chat message saved to DB."); }
                        } catch (dbError) { console.error("Exception during chat save:", dbError); /* ... */ }
                    }
                 };
                const updateGeminiThinkingState = (isThinking) => { /* ... (beze změny) ... */ };
                const addThinkingIndicator = () => { /* ... (beze změny) ... */ };
                const removeThinkingIndicator = () => { /* ... (beze změny) ... */ };
                const handleSendMessage = async () => { /* ... (beze změny) ... */ };
                const confirmClearChat = () => { /* ... (beze změny) ... */ };
                const clearCurrentChatSessionHistory = async () => { /* ... (beze změny) ... */ };
                const saveChatToPDF = async () => { /* ... (beze změny) ... */ };

                 // --- Gemini Interaction & AI Drawing ---
                 const parseAndDrawAiOutput = async (responseText) => {
                     // Use the retry check before attempting draw operations
                     if (!excalidrawAPI) {
                          console.warn("Excalidraw API not ready in parseAndDraw. Skipping drawing.");
                          return responseText; // Skip drawing if not ready
                     }
                      if (typeof excalidrawAPI.updateScene !== 'function' || typeof excalidrawAPI.getSceneElements !== 'function') {
                          console.warn("Excalidraw API methods not available. Skipping drawing.");
                          return responseText;
                      }
                     // ... (rest of the drawing logic remains the same) ...
                      let remainingText = responseText;
                      const elementsToDraw = [];
                      let match;
                      DRAW_COMMAND_REGEX.lastIndex = 0;
                      while ((match = DRAW_COMMAND_REGEX.exec(responseText)) !== null) {
                          try {
                              const jsonString = match[1];
                              if (jsonString.trim().startsWith('[')) {
                                  const commandData = JSON.parse(jsonString);
                                  if (Array.isArray(commandData)) {
                                      commandData.forEach(element => {
                                          if(typeof element === 'object' && element !== null && element.id && element.type) {
                                              elementsToDraw.push({
                                                  isDeleted: false, version: 1,
                                                  ...element,
                                                  x: Number(element.x ?? 0), y: Number(element.y ?? 0), width: Number(element.width ?? 100), height: Number(element.height ?? 100), angle: Number(element.angle ?? 0), strokeWidth: Number(element.strokeWidth ?? 1), roughness: Number(element.roughness ?? 0), opacity: Number(element.opacity ?? 100),
                                                  seed: element.seed ?? Math.floor(Math.random() * 100000),
                                                  versionNonce: element.versionNonce ?? Math.random() * 1000000
                                              });
                                          } else { console.warn("Skipping invalid element:", element); }
                                      });
                                  } else { console.warn("Skipping DRAW block - not array:", commandData); }
                                  remainingText = remainingText.replace(match[0], '').trim();
                              } else { console.warn("Skipping DRAW block - does not start with '[':", jsonString.substring(0, 50) + '...'); }
                          } catch (e) { console.error("Failed to parse DRAW JSON:", e, "Content:", match[1].substring(0, 100) + '...'); }
                      }
                      if (elementsToDraw.length > 0) {
                          console.log("Excalidraw elements:", JSON.stringify(elementsToDraw));
                          showToast("AI kreslí...", "info", 1500);
                          try {
                              const existingElements = excalidrawAPI.getSceneElements() || [];
                              excalidrawAPI.updateScene({ elements: [...existingElements, ...elementsToDraw] });
                              await new Promise(r => setTimeout(r, 150));
                              if (typeof excalidrawAPI.zoomToFit === 'function') {
                                   const elementIds = elementsToDraw.map(el => el.id);
                                   if (elementIds.length > 0) { excalidrawAPI.zoomToFit(elementIds, 0.9); console.log("Zoomed to new elements."); }
                              } else { console.log("Drawing executed (zoom unavailable)."); }
                          } catch (drawError) { console.error("Excalidraw draw error:", drawError); showToast("Chyba kreslení.", "error"); }
                      } else { console.log("No valid DRAW commands found."); }
                      return remainingText.trim();
                 };
                 const sendToGemini = async (promptText, targetArea) => { /* ... (Implementace beze změny) ... */ };
                 const processGeminiResponse = async (rawResponseText, targetArea, timestamp) => { /* ... (Implementace beze změny) ... */ };
                 const handleGeminiError = (errorMessage, targetArea, timestamp) => { /* ... (Implementace beze změny) ... */ };

                // --- Run Application ---
                initializeApp();

            }); // End DOMContentLoaded
        } catch (e) {
            // --- Fatal Error Handling ---
            console.error("FATAL SCRIPT ERROR:", e);
             document.body.innerHTML = `<div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #fff5f5; color: #d00; padding: 40px; font-family: sans-serif; text-align: center; z-index: 9999;"><h1>FATÁLNÍ CHYBA SKRIPTU</h1><p>Omlouváme se, ale aplikace nemohla být spuštěna kvůli závažné chybě.</p><p>Zkuste prosím obnovit stránku (F5). Pokud problém přetrvává, kontaktujte podporu.</p><hr style="margin: 20px 0; border-color: #fcc;"><pre style="text-align: left; background-color: #ffeaea; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 0.8em;">${e.message}\n${e.stack}</pre></div>`;
        }
    </script>

</body>
</html>