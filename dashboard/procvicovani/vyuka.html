<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Výuka s AI (Excalidraw Robustní Init)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    {/* MathJax Configuration */}
    <script>
        if (typeof window.MathJax === 'undefined') {
            window.MathJax = {
                tex: { inlineMath: [['\\(', '\\)']], displayMath: [['$$', '$$']], processEscapes: true, processEnvironments: true },
                options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' },
                startup: { ready: () => { MathJax.startup.defaultReady(); MathJax.startup.promise.then(() => console.log('MathJax loaded and ready.')); } }
            };
        } else {
             console.warn("window.MathJax already defined, skipping default config assignment.");
        }
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    {/* Supabase & Marked */}
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    {/* jQuery & Tooltipster */}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>

    {/* PDF Export */}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    {/* Excalidraw Dependencies & Library - SPRÁVNÉ POŘADÍ a DEFER */}
    <script src="https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17.0.2/umd/react-dom.production.min.js" crossorigin></script>
    {/* Přidán atribut DEFER */}
    <script src="https://cdn.jsdelivr.net/npm/@excalidraw/excalidraw@0.17.0/dist/excalidraw.production.min.js" crossorigin defer></script>

    <style>
        /* --- CSS Styly (kompletní) --- */
         * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; scroll-behavior: smooth; }
        :root { /* ... CSS variables ... */ }
        body { background-color: var(--call-bg); color: var(--text-primary); min-height: 100vh; display: flex; overflow: hidden; }
        .sidebar { /* ... Sidebar styles ... */ }
        main { /* ... Main styles ... */ }
        .main-header { /* ... Header styles ... */ }
        .call-interface { /* ... Interface layout styles ... */ }
        .ai-presenter-area { /* ... AI area styles ... */ }
        .whiteboard-main-container { /* ... Whiteboard container styles ... */ }
        #excalidraw-container { height: 100%; width: 100%; }
        #excalidraw-container .excalidraw-wrapper { height: 100% !important; }
        .interaction-panel { /* ... Interaction panel styles ... */ }
        .interaction-tabs { /* ... Tabs styles ... */ }
        .interaction-content-area { /* ... Content area styles ... */ }
        .tab-content { /* ... Tab content styles ... */ }
        .explanation-scroll-content { /* ... Explanation styles ... */ }
        .chat-messages { /* ... Chat messages styles ... */ }
        .chat-input-area { /* ... Chat input styles ... */ }
        .topic-loading-bar { /* ... Topic bar styles ... */ }
        .loading-placeholder { /* ... Utility styles ... */ }
        .empty-state { /* ... Utility styles ... */ }
        .btn { /* ... Button styles ... */ }
        .mobile-menu-toggle { /* ... Responsive styles ... */ }
        .sidebar-overlay { /* ... Responsive styles ... */ }
        @media (max-width: 1200px) { /* ... Responsive styles ... */ }
        @media (max-width: 992px) { /* ... Responsive styles ... */ }
        @media (max-width: 768px) { /* ... Responsive styles ... */ }
        @media (max-width: 576px) { /* ... Responsive styles ... */ }
        @media (prefers-color-scheme: dark) { /* ... Dark mode styles ... */ }
        .toast { /* ... Toast styles ... */ }
    </style>
</head>
<body>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
     <aside id="sidebar" class="sidebar">
        <div class="sidebar-header"> <a href="/" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
         <ul class="sidebar-menu">
            <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Dashboard</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li>
         </ul>
         <div class="user-profile">
            <div class="user-avatar" id="user-avatar">?</div>
            <div class="user-info">
                <div class="user-name" id="user-name">Načítání...</div>
                <div class="user-role">Student</div>
            </div>
         </div>
         <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main>
        <div class="main-header">
            <div class="header-content">
                 <div style="display: flex; align-items: center; gap: 1rem;">
                      <button class="mobile-menu-toggle" id="mobile-menu-toggle"> <i class="fas fa-bars"></i> </button>
                      <h1>Interaktivní výuka</h1>
                 </div>
                 <div class="header-actions">
                      <a href="/dashboard/procvicovani/main.html" class="btn btn-secondary"> <i class="fas fa-times"></i> Ukončit výuku </a>
                 </div>
            </div>
        </div>
        <div class="topic-loading-bar">
             <div id="current-topic-display"><span class="placeholder">Načítám data...</span></div>
        </div>
        <div class="call-interface" style="display: none;">
             <div class="ai-presenter-area">
                 <div class="ai-presenter-header">
                     <div class="ai-avatar-placeholder"> <i class="fas fa-robot"></i> </div>
                     <div class="ai-presenter-info">
                         <h2>AI Tutor Justax</h2>
                         <p id="ai-status-text">Čekání na téma...</p>
                     </div>
                 </div>
                 <div class="whiteboard-main-container">
                     <div id="excalidraw-container">
                         <p style="padding: 2rem; text-align: center; font-style: italic; color: var(--text-muted);">Inicializace kreslící plochy...</p>
                     </div>
                 </div>
             </div>
             <div class="interaction-panel">
                 <div class="interaction-tabs">
                     <div class="interaction-tab active" data-tab="explanation-tab"> <i class="fas fa-chalkboard-teacher"></i> Vysvětlení </div>
                     <div class="interaction-tab" data-tab="chat-tab"> <i class="fas fa-comments"></i> Chat </div>
                 </div>
                 <div class="interaction-content-area">
                     <div id="explanation-tab-content" class="tab-content active">
                         <div class="explanation-scroll-content">
                             <div id="explanation-display"><div class="empty-state"> <i class="fas fa-book-reader"></i> <h3>Výuka připravena</h3> <p>Počkejte na automatické načtení tématu.</p> </div></div>
                         </div>
                         <div class="explanation-controls">
                             <button class="btn btn-primary btn-tooltip" id="next-step-btn" style="display: none;" title="Požádat AI o další krok"> <i class="fas fa-forward"></i> Další krok </button>
                             <button class="btn btn-success btn-tooltip" id="mark-complete-btn" style="display: none;" title="Označit téma jako dokončené"> <i class="fas fa-check-circle"></i> Téma dokončeno </button>
                         </div>
                     </div>
                     <div id="chat-tab-content" class="tab-content">
                         <section class="chat-area" style="display: flex; flex-direction: column; height: 100%;">
                             <div class="chat-messages" id="chat-messages"></div>
                             <div class="chat-input-area">
                                 <textarea class="chat-input" id="chat-input" placeholder="Napiš svou otázku..." rows="1"></textarea>
                                 <button class="send-button" id="send-button" title="Odeslat zprávu"> <i class="fas fa-paper-plane"></i> </button>
                             </div>
                             <div class="chat-controls">
                                 <button id="clear-chat-btn" class="btn-tooltip" title="Vymazat historii tohoto chatu"> <i class="fas fa-trash-alt"></i> Vymazat chat </button> |
                                 <button id="save-chat-btn" class="btn-tooltip" title="Uložit chat jako PDF"> <i class="fas fa-save"></i> Uložit PDF </button>
                             </div>
                         </section>
                     </div>
                 </div>
             </div>
        </div>
    </main>
    <div class="toast" id="toast"> <i class="fas fa-info-circle"></i> <div id="toast-message">Operace úspěšná.</div> </div>

    <script>
        try {
            document.addEventListener('DOMContentLoaded', async function() {
                console.log("DOM Loaded. Initializing application...");

                // --- Constants & Config ---
                const SUPABASE_URL = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
                const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // Test key
                const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                const DRAW_COMMAND_REGEX = /DRAW_ON_WHITEBOARD:\s*```json\s*([\s\S]*?)\s*```/g;
                const EXCALIDRAW_INIT_CHECK_INTERVAL = 200; // ms
                const EXCALIDRAW_INIT_MAX_RETRIES = 15; // ~3 seconds total

                // --- DOM Elements ---
                const userAvatarEl = document.getElementById('user-avatar');
                const userNameEl = document.getElementById('user-name');
                const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
                const sidebar = document.getElementById('sidebar');
                const sidebarOverlay = document.getElementById('sidebar-overlay');
                const currentTopicDisplay = document.getElementById('current-topic-display');
                const explanationDisplay = document.getElementById('explanation-display');
                const explanationScrollContent = document.querySelector('.explanation-scroll-content');
                const excalidrawContainer = document.getElementById('excalidraw-container');
                const chatMessages = document.getElementById('chat-messages');
                const chatInput = document.getElementById('chat-input');
                const sendButton = document.getElementById('send-button');
                const saveChatBtn = document.getElementById('save-chat-btn');
                const clearChatBtn = document.getElementById('clear-chat-btn');
                const nextStepBtn = document.getElementById('next-step-btn');
                const markCompleteBtn = document.getElementById('mark-complete-btn');
                const toastEl = document.getElementById('toast');
                const toastMessageEl = document.getElementById('toast-message');
                const interactionTabs = document.querySelectorAll('.interaction-tab');
                const tabContents = document.querySelectorAll('.tab-content');
                const aiStatusText = document.getElementById('ai-status-text');
                const callInterface = document.querySelector('.call-interface');

                // --- Global State ---
                let supabase = null;
                let currentUser = null;
                let currentProfile = null;
                let currentTopic = null;
                let currentPlanId = null;
                let currentSessionId = null;
                let geminiChatContext = [];
                let excalidrawAPI = null;
                let ExcalidrawLib = null;
                let geminiIsThinking = false;
                let thinkingIndicatorId = null;
                let topicLoadInProgress = false;
                let excalidrawInitRetries = 0; // Počítadlo pro inicializaci

                // --- Helper Functions ---
                const sanitizeHTML = (str) => { /* ... */ };
                const getInitials = (profile, email) => { /* ... */ };
                const showToast = (message, type = 'info', duration = 4000) => { /* ... */ };
                const renderMarkdown = (element, markdownText) => { /* ... */ };
                const autoResizeTextarea = () => { /* ... */ };
                const generateSessionId = () => `session_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
                const formatTimestamp = (date) => date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
                const updateAIStatus = (text) => { if (aiStatusText) aiStatusText.textContent = text; };

                // --- Initialization Functions ---

                // *** OPRAVA: Robustnější inicializace Excalidraw s kontrolou a opakováním ***
                const tryInitializeExcalidrawWhenReady = () => {
                    console.log(`Attempting Excalidraw init (Retry: ${excalidrawInitRetries}/${EXCALIDRAW_INIT_MAX_RETRIES})`);
                    if (excalidrawAPI) {
                        console.log("Excalidraw already initialized.");
                        return; // Already done
                    }

                    if (typeof React !== 'undefined' && typeof ReactDOM !== 'undefined' && typeof Excalidraw !== 'undefined') {
                        // Libraries are ready, proceed with initialization
                        if (initializeExcalidraw()) {
                            console.log("Excalidraw successfully initialized after check.");
                        } else {
                            console.error("Excalidraw initialization function failed even though libraries seem loaded.");
                        }
                    } else {
                        // Libraries not ready, schedule retry if limit not reached
                        excalidrawInitRetries++;
                        if (excalidrawInitRetries <= EXCALIDRAW_INIT_MAX_RETRIES) {
                            console.log(`Libraries not ready, retrying in ${EXCALIDRAW_INIT_CHECK_INTERVAL}ms...`);
                            setTimeout(tryInitializeExcalidrawWhenReady, EXCALIDRAW_INIT_CHECK_INTERVAL);
                        } else {
                            console.error(`Excalidraw libraries failed to load after ${EXCALIDRAW_INIT_MAX_RETRIES} retries.`);
                            if (excalidrawContainer) excalidrawContainer.innerHTML = "<p style='color: red; padding: 1rem;'>Chyba: Knihovny pro kreslení se nepodařilo načíst včas.</p>";
                            showToast("Chyba načítání kreslící plochy.", "error", 10000);
                        }
                    }
                };

                 const initializeExcalidraw = () => {
                    // Note: This function NOW assumes React/ReactDOM/Excalidraw are defined
                    // The check happens in tryInitializeExcalidrawWhenReady
                    console.log("Executing initializeExcalidraw function...");
                    if (excalidrawAPI) { console.log("Excalidraw instance already exists."); return true; }

                    ExcalidrawLib = Excalidraw;
                    if (!excalidrawContainer) { console.error("Element #excalidraw-container not found!"); return false; }

                    try {
                        const ExcalidrawComponent = () => {
                            const excalidrawRef = React.useRef(null);
                            React.useEffect(() => {
                                excalidrawAPI = excalidrawRef.current;
                                console.log("Excalidraw API reference obtained:", excalidrawAPI ? 'OK' : 'Failed');
                            }, []);

                            return React.createElement(/* ... (React element definition) ... */);
                        };
                        ReactDOM.render(React.createElement(ExcalidrawComponent), excalidrawContainer);
                        console.log("Excalidraw component render initiated.");
                        // No need for timeout check here, API ref is set in useEffect
                        return true;
                    } catch (error) {
                        console.error("Failed to render Excalidraw component:", error);
                        if (excalidrawContainer) excalidrawContainer.innerHTML = `<p style='color: red; padding: 1rem;'>Chyba vykreslení kreslící plochy: ${error.message}</p>`;
                        showToast("Chyba vykreslení kreslení.", "error");
                        return false;
                    }
                 };

                const initializeApp = async () => {
                    try {
                        supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        if (!supabase) throw new Error("Supabase client creation failed.");
                        console.log("Supabase client initialized.");
                    } catch (error) { /* ... (Error handling) ... */ return; }

                    setupEventListeners();
                    initTooltips();

                    // *** Start checking for Excalidraw readiness AFTER main setup ***
                    tryInitializeExcalidrawWhenReady();

                    await loadUserProfile();
                    if (currentUser) { await loadNextUncompletedTopic(); }
                    else { /* ... (Handle not logged in) ... */ }
                };

                // --- User Profile, Event Listeners, Tooltips ---
                const loadUserProfile = async () => { /* ... (beze změny) ... */ };
                const updateUserInfoUI = () => { /* ... (beze změny) ... */ };
                const setupEventListeners = () => { /* ... (beze změny) ... */ };
                const initTooltips = () => { /* ... (beze změny) ... */ };

                // --- Topic Loading and Progress ---
                const loadNextUncompletedTopic = async () => { /* ... (beze změny) ... */ };
                const handleMarkTopicComplete = async () => { /* ... (beze změny) ... */ };

                 // --- Learning Session Management ---
                 const startLearningSession = async () => { /* ... (stejné jako v předchozím kroku, volá initializeExcalidraw pokud API není dostupné) ... */ };
                 const showLearningUI = () => { /* ... (beze změny) ... */ };
                 const hideLearningUI = () => { /* ... (beze změny) ... */ };
                 const switchInteractionTab = (tabId) => { /* ... (beze změny) ... */ };
                 const requestNextStep = async () => { /* ... (beze změny) ... */ };

                 // --- Chat Functionality ---
                 const addChatMessage = async (message, sender, saveToDb = false, timestamp = new Date()) => {
                     // ... (vytvoření HTML elementů zprávy - beze změny) ...
                     if (!chatMessages) return;
                     const messageId = `${sender}_${timestamp.getTime()}_${Math.random().toString(16).slice(2)}`;
                     const messageDiv = document.createElement('div'); messageDiv.classList.add('chat-message', sender); messageDiv.id = messageId;
                     const avatarDiv = document.createElement('div'); avatarDiv.classList.add('message-avatar'); avatarDiv.innerHTML = sender === 'user' ? getInitials(currentProfile, currentUser?.email) : '<i class="fas fa-robot"></i>';
                     const bubbleDiv = document.createElement('div'); bubbleDiv.classList.add('message-bubble'); renderMarkdown(bubbleDiv, message);
                     const timestampDiv = document.createElement('div'); timestampDiv.classList.add('message-timestamp'); timestampDiv.textContent = formatTimestamp(timestamp); bubbleDiv.appendChild(timestampDiv);
                     if (sender === 'user') { messageDiv.appendChild(bubbleDiv); messageDiv.appendChild(avatarDiv); } else { messageDiv.appendChild(avatarDiv); messageDiv.appendChild(bubbleDiv); }
                     chatMessages.appendChild(messageDiv);
                     requestAnimationFrame(() => { chatMessages.scrollTop = chatMessages.scrollHeight; });

                    // --- SUPABASE CHAT SAVE (OPRAVA NÁZVŮ SLOUPCŮ + KONTROLA activity_id) ---
                    if (saveToDb && supabase && currentUser && currentTopic && currentSessionId) {
                        const dataToSave = {
                            user_id: currentUser.id,
                            session_id: currentSessionId,
                            topic_name: currentTopic.name,
                            role: sender,       // Správný název sloupce
                            content: message,     // Správný název sloupce
                            created_at: timestamp.toISOString(),
                            // topic_id: null, // Lze přidat, pokud máte ID tématu
                        };

                        // Přidat activity_id POUZE pokud existuje a má hodnotu
                        if (currentTopic.activity_id) {
                            dataToSave.activity_id = currentTopic.activity_id;
                            console.log(`Including activity_id: ${currentTopic.activity_id}`);
                        } else {
                            console.warn("activity_id not found in currentTopic, skipping for DB insert.");
                            // Pokud je activity_id ve vaší DB povinné (NOT NULL),
                            // zde byste museli buď zajistit jeho přítomnost v currentTopic,
                            // nebo ho v DB povolit jako NULL.
                        }

                        console.log("Attempting to save to chat_history:", dataToSave);
                        try {
                            const { error } = await supabase.from('chat_history').insert(dataToSave);
                            if (error) {
                                console.error("Error saving chat message to Supabase:", error);
                                let userMessage = `Chyba ukládání zprávy: ${error.message}`;
                                if (error.code === '42703' || (error.message.includes("column") && error.message.includes("does not exist"))) {
                                    const wrongCol = error.message.match(/column "(\w+)"/);
                                    userMessage = `Chyba DB: Sloupec '${wrongCol ? wrongCol[1] : '?'}' neexistuje. Zkontrolujte názvy (role, content, activity_id?) a schéma DB.`;
                                } else if (error.message.includes("violates not-null constraint")) {
                                     const missingCol = error.message.match(/null value in column "(\w+)"/);
                                     // Pokud chybí activity_id a je povinné:
                                     if (missingCol && missingCol[1] === 'activity_id' && !dataToSave.activity_id) {
                                          userMessage = `Chyba DB: Povinný sloupec 'activity_id' chybí nebo nebyl nalezen v datech tématu.`;
                                     } else {
                                          userMessage = `Chyba DB: Povinný sloupec '${missingCol ? missingCol[1] : '?'}' není vyplněn.`;
                                     }
                                }
                                showToast(userMessage, "error", 7000);
                            } else {
                                console.log("Chat message saved to DB.");
                            }
                        } catch (dbError) { /* ... (Error handling) ... */ }
                    }
                 };
                const updateGeminiThinkingState = (isThinking) => { /* ... (Implementace beze změny) ... */ };
                const addThinkingIndicator = () => { /* ... (Implementace beze změny) ... */ };
                const removeThinkingIndicator = () => { /* ... (Implementace beze změny) ... */ };
                const handleSendMessage = async () => { /* ... (Implementace beze změny) ... */ };
                const confirmClearChat = () => { /* ... (Implementace beze změny) ... */ };
                const clearCurrentChatSessionHistory = async () => { /* ... (Implementace beze změny) ... */ };
                const saveChatToPDF = async () => { /* ... (Implementace beze změny) ... */ };

                 // --- Gemini Interaction & AI Drawing ---
                 const parseAndDrawAiOutput = async (responseText) => { /* ... (Implementace beze změny, s kontrolou API) ... */ };
                 const sendToGemini = async (promptText, targetArea) => { /* ... (Implementace beze změny, s upraveným systemInstructionText) ... */ };
                 const processGeminiResponse = async (rawResponseText, targetArea, timestamp) => { /* ... (Implementace beze změny, extrahuje summary, volá parseAndDraw, renderuje) ... */ };
                 const handleGeminiError = (errorMessage, targetArea, timestamp) => { /* ... (Implementace beze změny) ... */ };

                // --- Run Application ---
                initializeApp();

            }); // End DOMContentLoaded
        } catch (e) {
            // --- Fatal Error Handling ---
            console.error("FATAL SCRIPT ERROR:", e);
            document.body.innerHTML = `... (Fatal error message HTML) ...`; // Stejné jako předtím
        }
    </script>

</body>
</html>