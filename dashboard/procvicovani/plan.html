<!DOCTYPE html>
<html lang="cs" data-theme="light"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Studijní plán</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/umd/index.min.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- ОБЩИЕ СТИЛИ + Темный режим --- */
        :root {
            /* ... (все переменные из предыдущего ответа) ... */
             --primary-rgb: 67, 97, 238; --primary: #4361ee; --primary-light: #4895ef; --primary-dark: #3a0ca3;
            --secondary-rgb: 63, 55, 201; --secondary: #3f37c9;
            --success-rgb: 16, 185, 129; --success: #10b981; --success-light: #a7f3d0; --success-bg: #f0fdf4;
            --success-alt: #06d6a0;
            --danger-rgb: 247, 37, 133; --danger: #f72585; --danger-light: #fecdd3; --danger-bg: #fff1f2;
            --warning-rgb: 248, 150, 30; --warning: #f8961e; --warning-light: #fed7aa; --warning-bg: #fffbeb;
            --info-rgb: 72, 149, 239; --info: #4895ef; --info-light: #bfdbfe; --info-bg: #eff6ff;
            --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d;
            --gray-100: #f8f9fa; --gray-200: #e9ecef; --gray-300: #dee2e6;
            --gray-400: #ced4da; --gray-500: #adb5bd; --gray-600: #6c757d;
            --gray-700: #495057; --gray-800: #343a40; --gray-900: #212529;
            --white: #ffffff; --black: #000000;
            --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3);
            --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee);
            --gradient-3: linear-gradient(135deg, #f72585, #7209b7);
            --gradient-4: linear-gradient(135deg, #f8961e, #f3722c);
            --gradient-success: linear-gradient(135deg, var(--success), var(--success-dark));
             --gradient-warning: linear-gradient(135deg, var(--warning), #f3722c);
             --gradient-danger: linear-gradient(135deg, var(--danger), #b5179e);
             --gradient-info: linear-gradient(135deg, var(--info), var(--primary-light));

            /* Sémantické barvy - Světlý režim (default) */
            --bg-color: #f9fafb;
            --card-bg-color: var(--white);
            --card-bg-color-rgb: 255, 255, 255;
            --text-primary: var(--gray-800);
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: var(--gray-200);
            --input-bg: var(--white);
            --input-border: var(--gray-300);
            --input-focus-border: var(--primary-light);
            --input-focus-shadow: rgba(var(--primary-rgb), 0.15);
            --skeleton-bg: #f3f4f6;
            --skeleton-highlight: #e5e7eb;

             /* Размеры и переходы */
            --sidebar-width: 260px;
            --transition-speed: 0.3s;
            --transition-bezier: cubic-bezier(0.4, 0, 0.2, 1);
            --card-radius: 14px;
            --button-radius: 8px;
            --form-element-radius: 6px;

            /* Тени */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.07);
        }
        /* --- Базовые стили --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--bg-color); color: var(--text-primary); min-height: 100vh; display: flex; overflow: hidden; line-height: 1.6; font-size: 15px; transition: background-color 0.3s, color 0.3s; }

        /* --- Sidebar Styles --- */
        .sidebar { /* ... (styles from previous response) ... */ width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 1000; box-shadow: var(--shadow-lg); transition: transform var(--transition-speed) var(--transition-bezier), width var(--transition-speed) var(--transition-bezier); }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; position: relative; min-height: 40px; }
        #sidebar-close-toggle { display: none; position: absolute; right: -5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: rgba(255, 255, 255, 0.8); font-size: 1.6rem; cursor: pointer; padding: 0.5rem; line-height: 1; }
        .sidebar-logo { font-size: 1.5rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo i { font-size: 1.75rem; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        .sidebar-menu::-webkit-scrollbar { width: 5px; }
        .sidebar-menu::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 3px;}
        .sidebar-menu::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.3); border-radius: 3px; }
        .sidebar-menu { scrollbar-width: thin; scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.05); }
        .sidebar-item { margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.8rem 1rem; color: rgba(255, 255, 255, 0.85); text-decoration: none; border-radius: var(--button-radius); transition: background-color 0.2s ease, color 0.2s ease; font-weight: 500; position: relative; }
        .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; width: 24px; text-align: center; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--white); }
        .sidebar-link.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); height: 60%; width: 4px; background-color: var(--white); border-radius: 0 3px 3px 0; }
        .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); text-align: center; flex-shrink: 0;}
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.08); border-radius: 12px; border: 1px solid rgba(255,255,255, 0.1); flex-shrink: 0;}
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-weight: 500; overflow: hidden; flex-shrink: 0; color: var(--white); }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; overflow: hidden; }
        .user-name { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-role { font-size: 0.8rem; opacity: 0.8; white-space: nowrap;}

        /* --- Main Content Styles --- */
        main { flex: 1; margin-left: var(--sidebar-width); padding: 1.5rem 2rem; transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); overflow-y: auto; height: 100vh; }
        main:not(.loaded) { opacity: 0; }
        main.loaded { opacity: 1; animation: fadeInMain 0.4s ease-out forwards; }
        @keyframes fadeInMain { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Header Styles --- */
        .dashboard-header { margin-bottom: 2rem; background-color: rgba(var(--card-bg-color-rgb), 0.8); backdrop-filter: blur(8px); border-radius: var(--card-radius); padding: 1rem 1.75rem; box-shadow: none; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; position: sticky; top: 0; z-index: 900; border-bottom: 1px solid transparent; transition: box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease; }
         body.scrolled .dashboard-header { box-shadow: var(--shadow-md); border-bottom-color: var(--border-color); background-color: rgba(var(--card-bg-color-rgb), 0.95); }
        .header-content { display: flex; align-items: center; gap: 1rem; flex-grow: 1; }
        .header-content h1 { font-size: 1.75rem; font-weight: 600; color: var(--text-primary); margin: 0; }

        /* --- Button Styles --- */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.7rem 1.4rem; border-radius: var(--button-radius); font-weight: 500; font-size: 0.9rem; text-decoration: none; transition: all 0.3s ease; cursor: pointer; border: none; gap: 0.5rem; }
        .btn-primary { background: var(--gradient-1); color: white; box-shadow: var(--shadow-sm); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); background: linear-gradient(135deg, var(--primary-light), var(--secondary)); }
        .btn-secondary { background-color: var(--card-bg-color); color: var(--text-secondary); border: 1px solid var(--border-color); box-shadow: var(--shadow-xs); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--gray-100); border-color: var(--gray-medium); }
        .btn-success { background: linear-gradient(135deg, var(--success), var(--success-dark)); color: white; box-shadow: 0 4px 10px rgba(var(--success-rgb), 0.2); }
        .btn-success:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(var(--success-rgb), 0.25); }
        .btn-lg { padding: 0.75rem 2rem; font-size: 1rem; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn i { margin-right: 0.4em; }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 1rem; margin: 1.5rem 0; justify-content: center; }

        /* --- Section Styles --- */
        .main-content { display: flex; flex-direction: column; gap: 1.75rem; }
        .section { background-color: var(--card-bg-color); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); animation: fadeIn 0.5s ease forwards; border: 1px solid var(--border-color); position: relative; }
         .section.has-tabs { padding-top: 0; }
         .section:not(.has-tabs) { padding: 1.75rem; } /* Apply padding only if no tabs */
         .section.has-tabs > .tab-content-area { padding: 1.75rem; }
        .section-title { font-size: 1.4rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .section-title i { font-size: 0.9em; color: var(--primary); margin-right: 0.6rem; }
        .section-subtitle { font-size: 1.1rem; font-weight: 500; margin-bottom: 1rem; color: var(--text-primary); }
        .section-text { font-size: 1rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 1.5rem; }

        /* --- Tab Styles --- */
        .plan-tabs { display: flex; margin-bottom: 0; border-bottom: 1px solid var(--border-color); overflow-x: auto; scrollbar-width: none; background-color: var(--card-bg-color); border-radius: var(--card-radius) var(--card-radius) 0 0; padding: 0 0.75rem; }
        .plan-tabs::-webkit-scrollbar { display: none; }
        .plan-tab { padding: 0.9rem 1.75rem; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.3s ease; white-space: nowrap; font-size: 0.95rem; }
        .plan-tab:hover { color: var(--primary); }
        .plan-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .tab-content-area { /* Wrapper for tab panes */ }

        /* --- Loading/Empty/Error States --- */
        .loader-container { display: flex; justify-content: center; align-items: center; min-height: 200px; padding: 2rem; }
        .loader { width: 40px; height: 40px; border: 4px solid rgba(var(--primary-rgb), 0.2); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; }
        .ai-loading { display: flex; align-items: center; gap: 1rem; margin: 2rem 0; font-style: italic; color: var(--text-muted); justify-content: center; }
        .ai-loading-spinner { width: 24px; height: 24px; border: 3px solid rgba(var(--primary-rgb), 0.2); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .message-box { background-color: var(--info-bg); border-left: 4px solid var(--info); padding: 1.5rem; margin: 1rem 0; border-radius: var(--button-radius); border: 1px solid var(--info-light); }
        .message-box h3 { color: var(--info); margin: 0 0 0.75rem 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem; }
        .message-box p { color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.5; font-size: 0.95rem; }
        .message-box.warning { background-color: var(--warning-bg); border-left-color: var(--warning); border-color: var(--warning-light); }
        .message-box.warning h3 { color: var(--warning); }
        .message-box.error { background-color: var(--danger-bg); border-left-color: var(--danger); border-color: var(--danger-light); }
        .message-box.error h3 { color: var(--danger); }
        .error-container { display: none; margin-bottom: 1.5rem; }
        .error-message { background-color: rgba(var(--danger-rgb), 0.05); border-left: 4px solid var(--danger); color: var(--danger); padding: 1rem; margin: 1rem 0; border-radius: 8px; font-size: 0.9rem; display: flex; align-items: center; }
        .error-message i { margin-right: 0.75rem; font-size: 1.25rem; }

        /* --- Plan Specific Styles --- */
        .plan-content { /* ... (styles from previous) ... */ margin-top: 1rem; padding: 1.75rem; background-color: var(--light); border-radius: var(--card-radius); border: 1px solid var(--border-color); line-height: 1.7; }
        .step-navigation { display: flex; justify-content: space-between; margin-bottom: 1.5rem; margin-top: 1rem; }
        .plan-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .plan-meta { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; }
        .plan-date { font-size: 0.9rem; color: var(--text-muted); }
        .plan-actions { display: flex; gap: 1rem; flex-shrink: 0; }
        .plan-history { margin-top: 1rem; }
        .history-item { /* ... (styles from previous) ... */ background-color: var(--card-bg-color); border-radius: var(--button-radius); padding: 1.25rem 1.5rem; margin-bottom: 1rem; box-shadow: var(--shadow-xs); display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; cursor: pointer; border: 1px solid var(--border-color); }
        .locked-overlay { /* ... (styles from previous) ... */ }

        /* --- Calendar Styles --- */
        .schedule-section { padding: 0; border: none; box-shadow: none; background: none; position: relative; } /* Added position relative */
        .calendar-scroll-container { overflow-x: auto; padding-bottom: 10px; margin-top: 0; border: 1px solid var(--border-color); border-radius: var(--card-radius); background-color: var(--card-bg-color); box-shadow: var(--shadow-sm); min-height: 300px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(180px, 1fr)); min-width: calc(7 * 180px); }
        .calendar-day-cell { border-left: 1px solid var(--border-color); min-height: 250px; display: flex; flex-direction: column; position: relative; }
        .calendar-day-cell:first-child { border-left: none; }
        .calendar-day-header { padding: 0.75rem 0.5rem; font-weight: 600; text-align: center; background-color: var(--gray-100); border-bottom: 1px solid var(--border-color); font-size: 0.9rem; color: var(--text-secondary); position: sticky; top: 0; z-index: 10; }
        .calendar-day-cell.today .calendar-day-header { background-color: rgba(var(--success-rgb), 0.1); color: var(--success-dark); font-weight: 700; }
        .calendar-day-cell.today { background-color: rgba(var(--success-rgb), 0.03); }
        .calendar-activities { padding: 0.75rem; flex-grow: 1; display: flex; flex-direction: column; gap: 0.75rem; overflow-y: auto; }
        .calendar-activity { /* ... (styles from previous) ... */ }

        /* --- Skeleton Styles --- */
        .skeleton { background-color: var(--skeleton-bg); border-radius: 4px; position: relative; overflow: hidden; }
        .skeleton::after { content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, var(--skeleton-highlight), transparent); animation: skeleton-loading 1.5s infinite linear; }
        @keyframes skeleton-loading { 0% { left: -150%; } 100% { left: 150%; } }
        .skeleton.title-sm { height: 14px; width: 60%; margin-bottom: 0.6rem; }
        .skeleton.value-lg { height: 30px; width: 40%; margin-bottom: 0.5rem; border-radius: 6px; }
        .skeleton.text-sm { height: 12px; width: 70%; }
        .skeleton-activity-item { display:flex; gap: 0.75rem; padding: 0.5rem 0; }
        .skeleton.activity-icon-placeholder { width: 16px; height: 16px; flex-shrink: 0; background-color: var(--skeleton-bg); border-radius: 3px; }
        .skeleton.activity-line { width: 80%; height: 14px; margin-bottom: 4px; background-color: var(--skeleton-bg); }
        .skeleton.activity-line-short { width: 50%; height: 10px; background-color: var(--skeleton-bg); }
        /* Loading class for containers */
        .loading > .loader-container, .loading > .ai-loading { display: flex; }
        .loading > *:not(.loader-container):not(.ai-loading) { display: none !important; } /* Hide content when loading */
        .schedule-day.loading .loading-skeleton { display: flex; } /* Show skeleton */
        .schedule-day.loading .calendar-activities { visibility: hidden; } /* Hide real activities */
        .history-item .loading-skeleton { display: none; width: 100%; }
        .history-item.loading .loading-skeleton { display: block; }
        .history-item.loading > *:not(.loading-skeleton) { visibility: hidden; }

        /* Initial Loading Overlay */
        .initial-loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 1100; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 1rem; transition: opacity 0.5s ease-out; }
        .initial-loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .initial-loading-overlay .loading-spinner { width: 35px; height: 35px; border-width: 4px; border-color: var(--primary); border-top-color: transparent; animation: spin 0.8s linear infinite;}
        .initial-loading-overlay p { color: var(--text-secondary); font-size: 1.1rem;}

        /* Toast */
        .toast-container { /* ... */ }
        .toast { /* ... */ }

        /* Responsivita */
        @media (max-width: 992px) { /* ... */ }
        @media (max-width: 768px) { /* ... */ }
        @media (max-width: 576px) { /* ... */ }
        .mobile-menu-toggle { /* ... */ }
        .sidebar-overlay { /* ... */ }
        .dashboard-footer { /* ... */ }

        /* Dark Mode */
        [data-theme="dark"] { /* Dark mode overrides using data attribute */
            --bg-color: #131720; --card-bg-color: #1e2533;
            --card-bg-color-rgb: 30, 37, 51;
            --text-primary: #e2e8f0; --text-secondary: #94a3b8; --text-muted: #64748b;
            --border-color: #334155; --light: #2d3748; --white: #1a202c;
            --skeleton-bg: #334155; --skeleton-highlight: #475569;
            --input-bg: #2d3748; --input-border: #4a5568;
        }
         [data-theme="dark"] body { background-color: var(--bg-color); color: var(--text-primary); }
         [data-theme="dark"] .section, [data-theme="dark"] .dashboard-header, /* ... other elements ... */ [data-theme="dark"] .schedule-day { background-color: var(--card-bg-color); border-color: var(--border-color); }
         [data-theme="dark"] .plan-content { background-color: #1A202C; }
         [data-theme="dark"] .plan-content h1, /* ... other h tags ... */ { color: var(--text-primary); border-bottom-color: var(--border-color); }
         [data-theme="dark"] .plan-content strong { color: var(--primary-light); }
         [data-theme="dark"] .plan-content code { background-color: rgba(var(--primary-rgb), 0.15); color: var(--success-light); }
         [data-theme="dark"] .plan-content blockquote { border-left-color: var(--primary-light); }
         [data-theme="dark"] .calendar-day-header { background-color: var(--light); border-bottom-color: var(--border-color); color: var(--text-secondary); }
         [data-theme="dark"] .calendar-day-cell.today .calendar-day-header { background-color: rgba(var(--success-rgb), 0.2); color: var(--success); }
         [data-theme="dark"] .calendar-day-cell.today { background-color: rgba(var(--success-rgb), 0.06); }
         [data-theme="dark"] .calendar-activity:hover { border-left-color: var(--secondary); background-color: var(--light);}
         [data-theme="dark"] .calendar-activity .activity-checkbox input:checked + .activity-content .activity-title { color: var(--text-muted); }
         [data-theme="dark"] .history-status.active { background-color: rgba(var(--info-rgb), 0.15); color: var(--info); }
         [data-theme="dark"] .history-status.completed { background-color: rgba(var(--primary-rgb), 0.15); color: var(--primary); }
         [data-theme="dark"] .history-status.inactive { background-color: rgba(108, 117, 125, 0.15); color: var(--text-muted); }
         [data-theme="dark"] .mobile-menu-toggle { color: var(--text-primary); }
         [data-theme="dark"] .dashboard-footer { border-top-color: var(--border-color); }
         [data-theme="dark"] .btn-secondary { background-color: var(--light); color: var(--text-secondary); border: 1px solid var(--border-color); }
         [data-theme="dark"] .btn-secondary:hover:not(:disabled) { background-color: #4a5568; border-color: #6c757d; color: var(--white); }
         [data-theme="dark"] .initial-loading-overlay { background-color: var(--bg-color); }
         [data-theme="dark"] .toast { border: 1px solid var(--border-color); color: var(--text-primary);}
          @media (max-width: 576px) { [data-theme="dark"] .calendar-day-cell { background-color: var(--card-bg-color); } }
        /* --- END OF STYLES --- */
    </style>
</head>
<body>
    <div class="initial-loading-overlay" id="initial-loader">
         <div class="loading-spinner"></div>
         <p>Načítání plánu...</p>
     </div>

    <div id="sidebar-overlay" class="sidebar-overlay"></div>
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header"> <button class="mobile-menu-toggle" id="sidebar-close-toggle"> <i class="fas fa-times"></i> </button> <a href="/dashboard/dashboard.html" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
        <ul class="sidebar-menu">
            <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Nástěnka</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li>
        </ul>
        <div class="user-profile"> <div class="user-avatar" id="user-avatar">?</div> <div class="user-info"> <div class="user-name" id="user-name">Načítání...</div> <div class="user-role">Student</div> </div> </div>
        <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main id="main-content" style="display: none;">
        <div class="error-container" id="global-error"></div>

        <header class="dashboard-header">
            <div class="header-content">
                <h1>Personalizovaný studijní plán</h1>
                <button class="mobile-menu-toggle" id="mobile-menu-toggle"> <i class="fas fa-bars"></i> </button>
            </div>
        </header>

        <section class="section has-tabs">
            <div class="plan-tabs">
                <div class="plan-tab active" data-tab="current">Aktuální plán</div>
                <div class="plan-tab" data-tab="history">Historie plánů</div>
                <div class="plan-tab" data-tab="create">Vytvořit nový</div>
            </div>

            <div class="tab-content-area">
                <div class="tab-pane active" id="current">
                    <div id="currentPlanContainer" class="loading">
                        <div class="loader-container" id="currentPlanLoader"> <div class="loader"></div></div>
                        <div id="currentPlanContentWrapper" style="display:none;">
                             <div id="scheduleViewPlaceholder"></div> </div>
                    </div>
                </div>

                <div class="tab-pane" id="history">
                     <div id="historyPlanContainer" class="loading">
                        <h2 class="section-title"><i class="fas fa-history"></i> Historie studijních plánů</h2>
                        <div class="loader-container" id="historyLoader"> <div class="loader"></div> </div>
                        <div id="historyPlanContent" class="plan-history" style="display:none;">
                            <div class="history-item loading"><div class="loading-skeleton"><div class="skeleton text-sm"></div><div class="skeleton title-sm"></div></div></div>
                             <div class="history-item loading"><div class="loading-skeleton"><div class="skeleton text-sm"></div><div class="skeleton title-sm"></div></div></div>
                             <div class="history-item loading"><div class="loading-skeleton"><div class="skeleton text-sm"></div><div class="skeleton title-sm"></div></div></div>
                        </div>
                     </div>
                </div>

                <div class="tab-pane" id="create">
                     <div id="createPlanContainer" class="loading">
                        <div class="loader-container" id="createPlanLoader"> <div class="loader"></div> </div>
                        <div id="createPlanContent" style="display:none;"></div>
                     </div>
                </div>

                 <div class="tab-pane" id="detail-view-pane" style="display: none;">
                     <div id="planDetailContainer" class="loading">
                        <div class="step-navigation"> <button class="btn btn-secondary btn-sm" id="backToSourceTabBtn"> <i class="fas fa-arrow-left"></i> Zpět </button> </div>
                        <h2 class="section-title" id="planDetailTitle">Detail plánu</h2>
                        <div class="ai-loading" id="planLoading" style="display: none;"> <div class="ai-loading-spinner"></div> <div>Načítám/Generuji...</div> </div>
                        <div class="plan-content" id="planContent" style="display:none;"></div>
                        <div class="action-buttons" id="planActions" style="display:none;"></div>
                    </div>
                 </div>
            </div>
        </section>

        <template id="lockedPlanTemplate"> <div style="position: relative; min-height: 300px;"> <div class="locked-overlay"> <div class="locked-icon"> <i class="fas fa-lock"></i> </div> <h3 class="locked-title">Vytvoření nového plánu není dostupné</h3> <p class="locked-message">Nový studijní plán můžete vytvořit jednou týdně. Váš poslední plán byl vytvořen nedávno.</p> <div class="timer-container" id="timerContainer"> Další plán můžete vytvořit za: <span id="nextPlanTimer">počítám...</span> </div> <button class="btn btn-primary" id="viewCurrentPlanBtnLocked"> <i class="fas fa-eye"></i> Zobrazit aktuální plán </button> </div> </div> </template>
        <template id="createPlanFormTemplate"> <h2 class="section-title"><i class="fas fa-plus-circle"></i> Vytvořit nový studijní plán</h2> <div id="diagnosticInfo"> </div> <p class="section-text">Personalizovaný studijní plán bude vytvořen na základě výsledků vašeho posledního diagnostického testu.</p> <div class="action-buttons"> <button class="btn btn-primary btn-lg" id="generatePlanBtn"> <i class="fas fa-magic"></i> Vygenerovat studijní plán </button> </div> </template>
        <template id="noDiagnosticTemplate"> <div class="message-box warning"> <h3><i class="fas fa-exclamation-circle"></i> Nejprve absolvujte diagnostický test</h3> <p>Pro vytvoření personalizovaného studijního plánu je nejprve potřeba dokončit diagnostický test.</p> <button class="btn btn-primary" id="goToTestBtn"> <i class="fas fa-play"></i> Přejít k testu </button> </div> </template>
        <template id="historyItemTemplate"> <div class="history-item" data-plan-id=""> <div class="history-info"> <div class="history-date">Vytvořeno: -</div> <div class="history-title">Studijní plán</div> </div> <div class="history-meta"> <span class="history-status active">Stav</span> <span class="history-progress"></span> </div> </div> </template>
        <template id="promptCreatePlanTemplate"> <div class="message-box info"><h3><i class="fas fa-clipboard-check"></i> Diagnostický test dokončen</h3><p>Váš poslední diagnostický test je připraven k analýze. Můžete nyní vygenerovat nový personalizovaný studijní plán.</p><button class="btn btn-primary" id="createNewPlanFromPromptBtn"><i class="fas fa-plus-circle"></i> Vytvořit studijní plán</button></div> </template>
        <template id="noActivePlanTemplate"> <div class="message-box info"> <h3><i class="fas fa-info-circle"></i> Žádný aktivní plán</h3> <p>Momentálně nemáte žádný aktivní studijní plán. Pokud jste již absolvoval/a diagnostický test, můžete si <a href="#" onclick="event.preventDefault(); document.querySelector('.plan-tab[data-tab=\'create\']').click();">vytvořit nový</a>.</p> <p>Pokud jste test ještě nedělal/a, přejděte prosím na <a href="test1.html">stránku testování</a>.</p> </div> </template>
        <template id="scheduleTemplate"> <div id="scheduleSection" class="schedule-section loading"> <div class="plan-header plan-header-dynamic" style="margin-bottom: 1.5rem;"></div> <div class="calendar-scroll-container"> <div class="calendar-grid" id="dailySchedule"> </div> </div> <div class="step-navigation" style="margin-top: 1.5rem;"> <button class="btn btn-secondary btn-sm" id="backToTabsBtn"> <i class="fas fa-arrow-left"></i> Zpět na přehled </button> </div> </div> </template>
        <template id="scheduleDaySkeletonTemplate"> <div class="schedule-day loading"> <div class="schedule-day-header"><div class="skeleton title-sm" style="width: 60%; margin: 0 auto; height: 16px;"></div></div> <div class="schedule-activities"> <div class="skeleton-activity-item"><div class="skeleton activity-icon-placeholder"></div><div class="skeleton-content"><div class="skeleton activity-line"></div><div class="skeleton activity-line-short"></div></div></div> <div class="skeleton-activity-item"><div class="skeleton activity-icon-placeholder"></div><div class="skeleton-content"><div class="skeleton activity-line"></div></div></div> </div> </div> </template>
        <template id="historySkeletonTemplate"> <div class="history-item loading"><div class="loading-skeleton"><div class="skeleton text-sm" style="width: 80px; height:12px; margin-bottom: 4px;"></div><div class="skeleton title-sm" style="width: 60%;"></div></div></div> </template>

        <footer class="dashboard-footer"> <p>&copy; 2025 Justax. Všechna práva vyhrazena.</p> </footer>
    </main>

    <div class="toast-container" id="toast-container"></div>

    <script>
        // Обновленный JavaScript для plan.html
        (function() {
            // --- START: Инициализация и Конфигурация ---
            const supabaseUrl = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
            const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // WARNING: Keep secure
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

            let supabase = null;
            let currentUser = null;
            let currentProfile = null;
            let latestDiagnosticData = null;
            let currentStudyPlan = null;
            let currentPlanActivities = [];
            let previousPlans = [];
            let planCreateAllowed = false;
            let nextPlanCreateTime = null;
            let planTimerInterval = null;
            let activeTab = 'current'; // Default active tab ID
            let currentView = 'tabs'; // 'tabs', 'detail', 'schedule'
            let lastGeneratedMarkdown = null;
            let lastGeneratedActivitiesJson = null;
            let isLoading = { page: true, current: false, history: false, create: false, detail: false, schedule: false };
            const topicIcons = { "Algebra": "fa-square-root-alt", "Aritmetika": "fa-calculator", "Geometrie": "fa-draw-polygon", "Logika": "fa-brain", "Logické úlohy": "fa-brain", "Statistika": "fa-chart-bar", "Čísla a aritmetické operace": "fa-calculator", "Práce s daty": "fa-chart-bar", "Problémové úlohy": "fa-lightbulb", "Proporce a procenta": "fa-percentage", "default": "fa-book" };
            const topicMap = { 1: "Čísla a aritmetické operace", 2: "Algebra", 3: "Geometrie", 4: "Práce s daty", 5: "Problémové úlohy", 6: "Proporce a procenta", 7: "Logické úlohy" };
            const activityVisuals = { test: { name: 'Test', icon: 'fa-vial', class: 'test' }, exercise: { name: 'Cvičení', icon: 'fa-pencil-alt', class: 'exercise' }, badge: { name: 'Odznak', icon: 'fa-medal', class: 'badge' }, diagnostic: { name: 'Diagnostika', icon: 'fa-clipboard-check', class: 'diagnostic' }, lesson: { name: 'Lekce', icon: 'fa-book-open', class: 'lesson' }, plan_generated: { name: 'Plán vytvořen', icon: 'fa-calendar-alt', class: 'plan_generated' }, level_up: { name: 'Nová úroveň', icon: 'fa-level-up-alt', class: 'level_up' }, other: { name: 'Ostatní', icon: 'fa-info-circle', class: 'other' }, default: { name: 'Aktivita', icon: 'fa-check-circle', class: 'default' } };

            // DOM Cache
            const ui = { /* ... (same as previous) ... */ }; // All ui elements defined here

            // --- Helper Functions ---
            // (All helper functions defined here using standard function declarations)
            // showToast, showError, hideError, sanitizeHTML, getInitials, formatDate,
            // toggleMobileMenu, updateUserInfoUI, handleScroll, getDeclension,
            // initTooltips, setLoadingState, renderHistorySkeletons, renderScheduleSkeletons,
            // displayPlanContent, renderWeeklySchedule, renderNoDiagnosticAvailable,
            // renderLockedPlanSection, startPlanTimer, updateNextPlanTimer, renderPlanCreationForm,
            // renderPromptCreatePlan, renderNoActivePlan, renderPlanHistory,
            // exportPlanToPDFWithStyle, handleActivityCompletionToggle, updatePlanProgress
            // ... (Полные реализации этих функций из предыдущего ответа) ...
             function showToast(message, type = 'info', duration = 4000) { if (!ui.toastContainer) return; try { const toastId = `toast-${Date.now()}`; const toastElement = document.createElement('div'); toastElement.className = `toast ${type}`; toastElement.id = toastId; toastElement.setAttribute('role', 'alert'); toastElement.setAttribute('aria-live', 'assertive'); toastElement.innerHTML = `<i class="toast-icon"></i><div class="toast-content"><div class="toast-message">${sanitizeHTML(message)}</div></div><button type="button" class="toast-close" aria-label="Zavřít">&times;</button>`; const icon = toastElement.querySelector('.toast-icon'); icon.className = `toast-icon fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}`; toastElement.querySelector('.toast-close').addEventListener('click', () => { toastElement.classList.remove('show'); setTimeout(() => toastElement.remove(), 400); }); ui.toastContainer.appendChild(toastElement); requestAnimationFrame(() => { toastElement.classList.add('show'); }); setTimeout(() => { if (toastElement.parentElement) { toastElement.classList.remove('show'); setTimeout(() => toastElement.remove(), 400); } }, duration); } catch (e) { console.error("Chyba při zobrazování toastu:", e); } }
             function showError(message, isGlobal = false) { console.error("Došlo k chybě:", message); if (isGlobal && ui.globalError) { ui.globalError.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><div>${sanitizeHTML(message)}</div></div>`; ui.globalError.style.display = 'block'; } else { showToast(message, 'error', 6000); } }
             function hideError() { if (ui.globalError) ui.globalError.style.display = 'none'; }
             function sanitizeHTML(str) { const t = document.createElement('div'); t.textContent = str || ''; return t.innerHTML; }
             function getInitials(profile) { if (!profile) return '?'; const f = profile.first_name?.[0] || ''; const l = profile.last_name?.[0] || ''; const nameInitial = (f + l).toUpperCase(); const usernameInitial = profile.username?.[0].toUpperCase() || ''; const emailInitial = profile.email?.[0].toUpperCase() || ''; return nameInitial || usernameInitial || emailInitial || '?'; }
             function formatDate(dateString) { if (!dateString) return '-'; try { const d = new Date(dateString); if (isNaN(d.getTime())) return '-'; return d.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'numeric', year: 'numeric' }); } catch (e) { return '-'; } }
             function toggleMobileMenu() { ui.sidebar?.classList.toggle('active'); ui.sidebarOverlay?.classList.toggle('active'); }
             function updateUserInfoUI() { if (!ui.sidebarName || !ui.sidebarAvatar) return; if (currentUser && currentProfile) { const displayName = `${currentProfile.first_name || ''} ${currentProfile.last_name || ''}`.trim() || currentProfile.username || currentUser.email?.split('@')[0] || 'Uživatel'; ui.sidebarName.textContent = displayName; const initials = getInitials(currentProfile); ui.sidebarAvatar.innerHTML = currentProfile.avatar_url ? `<img src="${currentProfile.avatar_url}" alt="${displayName}">` : initials; } else { ui.sidebarName.textContent = 'Nepřihlášen'; ui.sidebarAvatar.textContent = '?'; } }
             function handleScroll() { if (!ui.mainContent || !ui.dashboardHeader) return; document.body.classList.toggle('scrolled', ui.mainContent.scrollTop > 10); }
             function getDeclension(number, singular, plural1, plural2) { number = Math.abs(number); if (number === 1) return singular; if (number >= 2 && number <= 4) return plural1; return plural2; }
             function initTooltips() { try { if (window.jQuery?.fn.tooltipster) { window.jQuery('.btn-tooltip:not(.tooltipstered)').tooltipster({ theme: 'tooltipster-shadow', animation: 'fade', delay: 100, side: 'top' }); } } catch (e) { console.error("Chyba inicializace Tooltipster:", e); } }
             function setLoadingState(sectionKey, isLoadingFlag) { const sectionMap = { page: ui.mainContent, current: ui.currentPlanContainer, history: ui.historyPlanContainer, create: ui.createPlanContainer, detail: ui.planDetailContainer, schedule: document.getElementById(ui.scheduleSectionId || 'scheduleSection') }; const loaderMap = { current: ui.currentPlanLoader, history: ui.historyLoader, create: ui.createPlanLoader, detail: ui.planLoading, schedule: null }; const contentMap = { current: ui.currentPlanContentWrapper, history: ui.historyPlanContent, create: ui.createPlanContent, detail: ui.planContent, schedule: document.querySelector(`#${ui.scheduleSectionId || 'scheduleSection'} .calendar-scroll-container`) }; if (sectionKey === 'all') { Object.keys(isLoading).forEach(key => setLoadingState(key, isLoadingFlag)); return; } if (isLoading[sectionKey] === isLoadingFlag && sectionKey !== 'page') return; isLoading[sectionKey] = isLoadingFlag; console.log(`[SetLoading] ${sectionKey}: ${isLoadingFlag}`); const container = sectionMap[sectionKey]; const loader = loaderMap[sectionKey]; const content = contentMap[sectionKey]; if (loader) loader.style.display = isLoadingFlag ? 'flex' : 'none'; if (container && sectionKey !== 'page') container.classList.toggle('loading', isLoadingFlag); if (isLoadingFlag) { if (content) content.style.display = 'none'; } if (sectionKey === 'history') renderHistorySkeletons(isLoadingFlag ? 5 : 0); if (sectionKey === 'schedule') renderScheduleSkeletons(isLoadingFlag ? 7 : 0); }
             function renderHistorySkeletons(count) { if (!ui.historyPlanContent) return; ui.historyPlanContent.innerHTML = ''; if (count <= 0) { ui.historyPlanContent.style.display = 'block'; return; } ui.historyPlanContent.style.display = 'block'; let skeletonHTML = ''; const skeletonTemplate = ui.historySkeletonTemplate?.content.innerHTML || '<div class="history-item loading"><div class="loading-skeleton"><div class="skeleton text-sm"></div><div class="skeleton title-sm"></div></div></div>'; for (let i = 0; i < count; i++) { skeletonHTML += skeletonTemplate; } ui.historyPlanContent.innerHTML = skeletonHTML; }
             function renderScheduleSkeletons(count) { const grid = document.getElementById('dailySchedule'); if (!grid) return; grid.innerHTML = ''; if (count <= 0) { grid.style.display = 'grid'; return; }; grid.style.display = 'grid'; let skeletonHTML = ''; const skeletonTemplate = ui.scheduleDaySkeletonTemplate?.content.innerHTML || '<div class="schedule-day loading"><div class="schedule-day-header"><div class="skeleton title-sm"></div></div><div class="schedule-activities"><div class="skeleton-activity-item"><div class="skeleton activity-icon-placeholder"></div><div class="skeleton-content"><div class="skeleton activity-line"></div><div class="skeleton activity-line-short"></div></div></div></div></div>'; for (let i = 0; i < count; i++) { skeletonHTML += skeletonTemplate; } grid.innerHTML = skeletonHTML; }
             function displayPlanContent(markdownContent) { if (!ui.planContent) return; try { const htmlContent = marked.parse(markdownContent || ''); ui.planContent.innerHTML = htmlContent; ui.planContent.style.display = 'block'; if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') { setTimeout(() => { window.MathJax.typesetPromise([ui.planContent]).catch(e => console.error("MathJax chyba:", e)); }, 0); } } catch (e) { console.error("Chyba při renderování Markdown:", e); ui.planContent.innerHTML = "<p>Chyba při zobrazování obsahu plánu.</p>"; ui.planContent.style.display = 'block'; } }
             function renderWeeklySchedule(activities, planId) { const gridContainer = document.getElementById('dailySchedule'); if (!gridContainer) { console.error("Grid kontejner #dailySchedule nenalezen!"); return; } renderScheduleSkeletons(0); if (!activities || activities.length === 0) { gridContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--text-muted);">Pro tento plán nebyly nalezeny žádné aktivity.</p>'; return; } const daysOrder = [1, 2, 3, 4, 5, 6, 0]; const dayNames = { 0: 'Neděle', 1: 'Pondělí', 2: 'Úterý', 3: 'Středa', 4: 'Čtvrtek', 5: 'Pátek', 6: 'Sobota' }; const todayIndex = new Date().getDay(); const activitiesByDay = {}; daysOrder.forEach(dayIndex => activitiesByDay[dayIndex] = []); activities.forEach(activity => { if (activitiesByDay[activity.day_of_week] !== undefined) activitiesByDay[activity.day_of_week].push(activity); }); for (let i = 0; i < 7; i++) { const dayIndex = daysOrder[i]; const dayName = dayNames[dayIndex]; const dayCell = document.createElement('div'); dayCell.className = 'calendar-day-cell'; if (dayIndex === todayIndex) dayCell.classList.add('today'); const dayHeader = document.createElement('div'); dayHeader.className = 'calendar-day-header'; dayHeader.textContent = dayName + (dayIndex === todayIndex ? ' (Dnes)' : ''); dayCell.appendChild(dayHeader); const activitiesContainer = document.createElement('div'); activitiesContainer.className = 'calendar-activities'; const dayActivities = activitiesByDay[dayIndex].sort((a, b) => (a.time_slot || '').localeCompare(b.time_slot || '')); if (dayActivities.length > 0) { dayActivities.forEach(activity => { if (!activity.id) return; const activityElement = document.createElement('div'); activityElement.className = `calendar-activity ${activity.completed ? 'completed' : ''}`; const timeDisplay = activity.time_slot ? `<span class="activity-time-display">${activity.time_slot}</span>` : ''; activityElement.innerHTML = `<div class="activity-checkbox"><input type="checkbox" id="schedule-activity-${activity.id}" ${activity.completed ? 'checked' : ''} data-activity-id="${activity.id}" data-plan-id="${planId}"><div class="activity-content"><div class="activity-title">${timeDisplay}${sanitizeHTML(activity.title || 'Aktivita')}</div><div class="activity-desc">${sanitizeHTML(activity.description || '')}</div></div></div>`; const checkbox = activityElement.querySelector('input[type="checkbox"]'); if(checkbox) { checkbox.addEventListener('change', function() { handleActivityCompletionToggle(this.dataset.activityId, this.checked, this.dataset.planId); }); } activityElement.addEventListener('click', (e) => { if (!e.target.matches('input[type="checkbox"]')) activityElement.classList.toggle('expanded'); }); activitiesContainer.appendChild(activityElement); }); } else { activitiesContainer.innerHTML = '<p style="text-align:center; color: var(--text-muted); font-size: 0.85rem; padding-top: 1rem;">Žádné aktivity</p>'; } dayCell.appendChild(activitiesContainer); gridContainer.appendChild(dayCell); } console.log("Kalendářový harmonogram úspěšně vyrenderován."); }
             function renderNoDiagnosticAvailable(container) { if (!container || !ui.noDiagnosticTemplate) return; const node = ui.noDiagnosticTemplate.content.cloneNode(true); const btn = node.getElementById('goToTestBtn'); if(btn) btn.addEventListener('click', () => { window.location.href = 'test1.html'; }); container.innerHTML = ''; container.appendChild(node); container.style.display = 'block'; }
             function renderLockedPlanSection(container) { if(!container || !ui.lockedPlanTemplate) return; const node = ui.lockedPlanTemplate.content.cloneNode(true); const timerEl = node.getElementById('nextPlanTimer'); if(timerEl) updateNextPlanTimer(timerEl); const viewBtn = node.getElementById('viewCurrentPlanBtnLocked'); if(viewBtn) viewBtn.addEventListener('click', () => switchTab('current')); container.innerHTML = ''; container.appendChild(node); container.style.display = 'block'; startPlanTimer(); }
             function startPlanTimer() { if (planTimerInterval) clearInterval(planTimerInterval); planTimerInterval = setInterval(() => { const timerElement = document.getElementById('nextPlanTimer'); if (timerElement) updateNextPlanTimer(timerElement); else clearInterval(planTimerInterval); }, 1000); }
             function updateNextPlanTimer(timerElement) { if (!nextPlanCreateTime) return; const now = new Date(); const timeDiff = nextPlanCreateTime - now; if (timeDiff <= 0) { timerElement.textContent = 'Nyní můžete vytvořit nový plán'; clearInterval(planTimerInterval); planCreateAllowed = true; setTimeout(checkPlanCreationAvailability, 1000); return; } const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24)); const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60)); const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000); timerElement.textContent = `${days} ${getDeclension(days, 'den', 'dny', 'dní')} ${hours} ${getDeclension(hours, 'hodina', 'hodiny', 'hodin')} ${minutes} ${getDeclension(minutes, 'minuta', 'minuty', 'minut')} ${seconds} ${getDeclension(seconds, 'sekunda', 'sekundy', 'sekund')}`; }
             function renderPlanCreationForm(container) { if (!container || !ui.createPlanFormTemplate || !latestDiagnosticData) return; const node = ui.createPlanFormTemplate.content.cloneNode(true); const diagInfo = node.getElementById('diagnosticInfo'); if(diagInfo) diagInfo.innerHTML = ` <p class="section-text">Plán bude vycházet z testu ze dne: <strong>${formatDate(latestDiagnosticData.completed_at)}</strong> (Skóre: ${latestDiagnosticData.total_score}/?).</p>`; const genBtn = node.getElementById('generatePlanBtn'); if(genBtn) genBtn.addEventListener('click', function() { this.disabled = true; this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generuji...'; generateStudyPlan(); }); container.innerHTML = ''; container.appendChild(node); container.style.display = 'block'; }
             function renderPromptCreatePlan(container) { if (!container || !ui.promptCreatePlanTemplate) return; const node = ui.promptCreatePlanTemplate.content.cloneNode(true); const btn = node.getElementById('createNewPlanFromPromptBtn'); if(btn) btn.addEventListener('click', () => switchTab('create')); container.innerHTML = ''; container.appendChild(node); container.style.display = 'block'; }
             function renderNoActivePlan(container) { if (!container || !ui.noActivePlanTemplate) return; const node = ui.noActivePlanTemplate.content.cloneNode(true); container.innerHTML = ''; container.appendChild(node); container.style.display = 'block'; }
             function renderPlanHistory(plans) { if(!ui.historyPlanContent) return; renderHistorySkeletons(0); if (!plans || plans.length === 0) { ui.historyPlanContent.innerHTML = `<div class="message-box info"><h3>Žádná historie</h3><p>Zatím jste nevytvořili žádné studijní plány.</p></div>`; ui.historyPlanContent.style.display = 'block'; return; } ui.historyPlanContent.innerHTML = ''; const fragment = document.createDocumentFragment(); plans.forEach(plan => { const node = ui.historyItemTemplate.content.cloneNode(true); const item = node.querySelector('.history-item'); const dateEl = node.querySelector('.history-date'); const titleEl = node.querySelector('.history-title'); const statusEl = node.querySelector('.history-status'); const progressEl = node.querySelector('.history-progress'); if(item) item.dataset.planId = plan.id; if(dateEl) dateEl.textContent = `Vytvořeno: ${formatDate(plan.created_at)}`; if(titleEl) titleEl.textContent = plan.title || "Studijní plán"; if(statusEl) { const statusText = plan.status === 'active' ? 'Aktivní' : plan.status === 'completed' ? 'Dokončený' : 'Neaktivní'; statusEl.textContent = statusText; statusEl.className = `history-status ${plan.status || 'inactive'}`; } if(progressEl) progressEl.textContent = `${plan.progress || 0}% hotovo`; item?.addEventListener('click', () => showPlanDetail(plan)); fragment.appendChild(node); }); ui.historyPlanContent.appendChild(fragment); ui.historyPlanContent.style.display = 'block'; }
             async function exportPlanToPDFWithStyle(plan) { /* ... (Implementation from previous response) ... */ if (!plan) return; if (!plan.plan_content_markdown) { showToast('Načítám data pro PDF...', 'info', 2000); try { const { data: fullPlanData, error } = await supabase.from('study_plans').select('plan_content_markdown, title, created_at, estimated_completion_date').eq('id', plan.id).single(); if (error) throw error; plan = { ...plan, ...fullPlanData }; } catch (fetchError) { showToast('Chyba: Nelze načíst data pro export.', 'error'); return; } } const exportContainer = document.createElement('div'); exportContainer.id = 'pdf-export-content'; const pdfStyles = `<style> body { font-family: 'Poppins', Arial, sans-serif; font-size: 10pt; color: #333; line-height: 1.5; } #pdf-export-content { padding: 18mm 13mm; } .pdf-header { text-align: center; margin-bottom: 12mm; border-bottom: 1px solid #ccc; padding-bottom: 4mm; } .pdf-header h1 { color: #4361ee; font-size: 18pt; margin: 0 0 4px 0; font-weight: 600; } .pdf-header p { color: #6c757d; font-size: 9pt; margin: 0; } .student-info { background-color: #f8f9fa; padding: 8mm 10mm; border-radius: 8px; border: 1px solid #eee; margin-bottom: 10mm; font-size: 9pt; break-inside: avoid; } .student-info h2 { color: #3f37c9; font-size: 12pt; margin: 0 0 6px 0; padding-bottom: 3px; border-bottom: 1px dotted #ccc; font-weight: 600;} .student-info p { margin: 0 0 3px 0; line-height: 1.4; } .student-info strong { font-weight: 600; color: #1e2a3a; } .pdf-content h2, .pdf-content h3, .pdf-content h4 { margin-top: 7mm; margin-bottom: 3mm; padding-bottom: 2px; font-weight: 600; break-after: avoid; } .pdf-content h2 { font-size: 13pt; color: #3f37c9; border-bottom: 1px solid #eee; } .pdf-content h3 { font-size: 11.5pt; color: #1e2a3a; border-bottom: 1px dotted #ccc; } .pdf-content h4 { font-size: 10.5pt; color: #4361ee; border-bottom: none; margin-top: 5mm; } .pdf-content p, .pdf-content li { margin-bottom: 2.5mm; color: #333; text-align: left; } .pdf-content ul, .pdf-content ol { padding-left: 5mm; margin-left: 3mm; margin-bottom: 4mm; break-inside: avoid;} .pdf-content li { margin-bottom: 1.5mm; } .pdf-content strong { font-weight: 600; color: #000; } .pdf-content em { font-style: italic; color: #555; } .pdf-content code { font-family: 'Courier New', Courier, monospace; background-color: #f0f0f0; padding: 1px 4px; border-radius: 3px; font-size: 9pt; color: #c7254e; } .pdf-content pre { background-color: #f8f9fa; border: 1px solid #eee; padding: 3mm; margin: 4mm 0; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; font-size: 9pt; break-inside: avoid; } .pdf-content blockquote { border-left: 3px solid #ccc; padding-left: 4mm; margin: 4mm 0 4mm 2mm; color: #555; font-style: italic; break-inside: avoid; } .pdf-content hr { border: none; border-top: 1px dashed #ccc; margin: 6mm 0; } .pdf-content ul > li > strong:first-child { display: inline-block; margin-right: 5px; color: #3f37c9; } .pdf-content ul > li em { display: block; margin-top: 2mm; padding-left: 5mm; color: #06a086; font-size: 9pt; } .pdf-footer { text-align: center; margin-top: 10mm; padding-top: 5mm; border-top: 1px solid #ccc; color: #888; font-size: 8pt; } .pdf-day-block { break-before: auto; break-inside: avoid; } .pdf-content ul { break-inside: avoid; } </style> `; exportContainer.innerHTML = pdfStyles; const pdfTitle = plan.title ? plan.title.replace(/\s*\(\d{1,2}\.\d{1,2}\.\d{4}\)$/, '').trim() : 'Studijní plán'; const headerHTML = `<div class="pdf-header"><h1>${sanitizeHTML(pdfTitle)}</h1><p>Vytvořeno: ${formatDate(plan.created_at)}</p></div>`; exportContainer.innerHTML += headerHTML; if (currentUser && ui.sidebarName.textContent !== 'Načítání...') { exportContainer.innerHTML += `<div class="student-info"><h2>Informace o studentovi</h2><p><strong>Student:</strong> ${ui.sidebarName.textContent}</p><p><strong>Datum vytvoření plánu:</strong> ${formatDate(plan.created_at)}</p>${plan.estimated_completion_date ? `<p><strong>Předpokládané dokončení:</strong> ${formatDate(plan.estimated_completion_date)}</p>` : ''}</div>`; } const contentDiv = document.createElement('div'); contentDiv.className = 'pdf-content'; try { const rawHtml = marked.parse(plan.plan_content_markdown || ''); contentDiv.innerHTML = rawHtml; const daysCzech = ['Pondělí', 'Úterý', 'Středa', 'Čtvrtek', 'Pátek', 'Sobota', 'Neděle']; contentDiv.querySelectorAll('h3').forEach(h3 => { const text = h3.textContent.trim(); if (daysCzech.some(day => text.startsWith(day))) h3.classList.add('pdf-day-block'); }); } catch (e) { contentDiv.innerHTML = '<p>Chyba při zpracování obsahu.</p>'; } exportContainer.appendChild(contentDiv); exportContainer.innerHTML += `<div class="pdf-footer">&copy; ${new Date().getFullYear()} Justax.space</div>`; const options = { margin: [18, 13, 18, 13], filename: `studijni-plan-${formatDate(plan.created_at).replace(/\./g, '-')}.pdf`, image: { type: 'jpeg', quality: 0.95 }, html2canvas: { scale: 2, useCORS: true, logging: false, letterRendering: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: ['css', 'avoid-all'] } }; if (typeof html2pdf === 'function') { console.log("Starting PDF generation..."); showToast('Generuji PDF...', 'info', 5000); html2pdf().set(options).from(exportContainer).save().then(() => { showToast('PDF vygenerováno!', 'success'); }).catch(err => { showToast('Chyba exportu PDF.', 'error'); }); } else { showToast('Chyba: Knihovna PDF není načtena.', 'error'); } }
             async function handleActivityCompletionToggle(activityId, isCompleted, planId) { if (!supabase) return; try { const { error: updateError } = await supabase.from('plan_activities').update({ completed: isCompleted, updated_at: new Date().toISOString() }).eq('id', activityId); if (updateError) throw updateError; console.log(`Aktivita ${activityId} označena jako ${isCompleted ? 'dokončená' : 'nedokončená'}`); // No need to reload full schedule, just update UI visually
                const activityElement = document.getElementById(`schedule-activity-${activityId}`)?.closest('.calendar-activity'); if (activityElement) activityElement.classList.toggle('completed', isCompleted); await updatePlanProgress(planId); } catch (error) { console.error(`Chyba aktualizace stavu aktivity ${activityId}:`, error); showToast('Nepodařilo se aktualizovat stav aktivity', 'error'); const checkbox = document.getElementById(`schedule-activity-${activityId}`); if (checkbox) checkbox.checked = !isCompleted; const activityElement = checkbox?.closest('.calendar-activity'); if (activityElement) activityElement.classList.toggle('completed', !isCompleted); } }
             async function updatePlanProgress(planId) { if (!planId || !supabase) return; try { const { data: activities, error: activitiesError } = await supabase.from('plan_activities').select('completed').eq('plan_id', planId); if (activitiesError) throw activitiesError; if (!activities || activities.length === 0) return; const completedCount = activities.filter(a => a.completed).length; const progress = Math.round((completedCount / activities.length) * 100); const { error: planUpdateError } = await supabase.from('study_plans').update({ progress: progress, updated_at: new Date().toISOString() }).eq('id', planId); if (planUpdateError) throw planUpdateError; console.log(`Pokrok plánu ${planId} aktualizován na ${progress}%`); if (currentStudyPlan && currentStudyPlan.id === planId) currentStudyPlan.progress = progress; } catch (error) { console.error(`Chyba při aktualizaci pokroku plánu ${planId}:`, error); } }


            // --- Core Application Logic ---
            // ИСПРАВЛЕНО: switchView and switchTab
             function switchView(view, targetTabId = null) {
                 console.log(`[SwitchView] Switching to view: ${view}, targetTabId: ${targetTabId}`);
                 currentView = view;
                 if(targetTabId !== null) activeTab = targetTabId;

                 const scheduleElem = document.getElementById(ui.scheduleSectionId || 'scheduleSection');

                 // Hide all view containers first
                 ui.tabPaneCurrent.style.display = 'none';
                 ui.tabPaneHistory.style.display = 'none';
                 ui.tabPaneCreate.style.display = 'none';
                 if (ui.tabPaneDetailView) ui.tabPaneDetailView.style.display = 'none';
                 if (scheduleElem) scheduleElem.style.display = 'none'; // Hide schedule view specifically

                 // Deactivate all tabs visually
                 ui.planTabs.forEach(t => t.classList.remove('active'));

                 // Show the requested view and activate corresponding tab button
                 if (view === 'tabs') {
                     const tabToShow = activeTab || 'current';
                     const paneToShow = document.getElementById(tabToShow); // Get the tab pane
                     const tabButton = document.querySelector(`.plan-tab[data-tab="${tabToShow}"]`);
                     if (paneToShow) paneToShow.style.display = 'block'; // Show the pane
                     if (tabButton) tabButton.classList.add('active'); // Activate the tab button
                     console.log(`[SwitchView] Switched to tabs view, active tab: ${activeTab}`);
                 } else if (view === 'detail' && ui.tabPaneDetailView && ui.planDetailContainer) {
                      ui.tabPaneDetailView.style.display = 'block'; // Show the detail PANE
                      ui.planDetailContainer.style.display = 'block'; // Show the detail container inside
                      const sourceTabButton = document.querySelector(`.plan-tab[data-tab="${activeTab}"]`); // Keep original tab active
                      if (sourceTabButton) sourceTabButton.classList.add('active');
                     console.log(`[SwitchView] Switched to detail view (from tab: ${activeTab})`);
                 } else if (view === 'schedule') {
                     if (scheduleElem) {
                          scheduleElem.style.display = 'block'; // Show schedule view
                          const currentTabButton = document.querySelector(`.plan-tab[data-tab="current"]`);
                          if(currentTabButton) currentTabButton.classList.add('active'); // Activate 'current' tab visually
                          console.log(`[SwitchView] Switched to schedule view`);
                     } else {
                          console.error("Schedule element not found for schedule view!");
                          switchView('tabs', 'current'); // Fallback to current tab if schedule fails
                     }
                 }
                 window.scrollTo(0, 0);
             }

             async function switchTab(tabId) {
                 if (!supabase) return;
                 console.log(`[SwitchTab] Activating tab: ${tabId}`);

                 // Only load data if switching to a new tab (or initial load)
                 const needsLoad = tabId !== activeTab || !document.getElementById(tabId)?.dataset.loaded;

                 activeTab = tabId;
                 switchView('tabs', tabId); // Switch view layout first

                 if (needsLoad) {
                     setLoadingState(tabId, true);
                     try {
                         if (tabId === 'current') await loadCurrentPlan();
                         else if (tabId === 'history') await loadPlanHistory();
                         else if (tabId === 'create') await checkPlanCreationAvailability();
                         // Mark tab as loaded (optional)
                         const pane = document.getElementById(tabId);
                         if(pane) pane.dataset.loaded = 'true';
                     } catch (error) {
                         console.error(`Error loading data for tab ${tabId}:`, error);
                         showError(`Nepodařilo se načíst data pro záložku '${tabId}'.`, false);
                         setLoadingState(tabId, false);
                     }
                 } else {
                      console.log(`[SwitchTab] Tab ${tabId} already loaded or active.`);
                 }
             }

            async function loadCurrentPlan() { /* ... (Refined version) ... */ }
            async function showFullSchedule(plan) { /* ... (Refined version) ... */ }
            async function showPlanDetail(plan) { /* ... (Refined version) ... */ }
            async function loadPlanHistory() { /* ... (Refined version) ... */ }
            async function checkPlanCreationAvailability() { /* ... (Refined version) ... */ }
            async function generateStudyPlan() { /* ... */ }
            async function generatePlanContentWithGemini(testData, topicsData) { /* ... */ }
            async function saveGeneratedPlan(markdownContent, activitiesArray, topicsData) { /* ... */ }

            // --- App Initialization ---
             // ИСПРАВЛЕНО: Все функции объявлены ДО initializePage
             function initializeSupabase() { try { if (typeof window.supabase === 'undefined' || typeof window.supabase.createClient !== 'function') { throw new Error("Supabase library not loaded."); } supabase = window.supabase.createClient(supabaseUrl, supabaseKey); if (!supabase) throw new Error("Supabase client creation failed."); console.log('[Supabase] Client initialized.'); return true; } catch (error) { console.error('[Supabase] Initialization failed:', error); showError("Kritická chyba: Nelze se připojit.", true); if (ui.initialLoader) { ui.initialLoader.innerHTML = `<p style="color: var(--danger);">Chyba připojení. Obnovte stránku.</p>`;} return false; } }

            async function initializePage() {
                console.log("🚀 [Init Plan] Starting...");
                 if (!initializeSupabase()) {
                     if (ui.initialLoader) { ui.initialLoader.classList.add('hidden'); ui.initialLoader.style.display='none';}
                     return;
                  }

                if (ui.initialLoader) { ui.initialLoader.style.display = 'flex'; ui.initialLoader.classList.remove('hidden'); }
                if (ui.mainContent) { ui.mainContent.style.display = 'none'; ui.mainContent.classList.remove('loaded'); }

                try {
                    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                    if (sessionError) throw new Error(`Nepodařilo se ověřit přihlášení: ${sessionError.message}`);

                    if (session?.user) {
                        currentUser = session.user;
                        currentProfile = await fetchUserProfile(currentUser.id);
                        updateUserInfoUI();

                        if (!currentProfile) {
                            showError("Profil nenalezen.", true);
                            if (ui.initialLoader) { ui.initialLoader.classList.add('hidden'); setTimeout(() => { if(ui.initialLoader) ui.initialLoader.style.display = 'none'; }, 300); }
                            if (ui.mainContent) { ui.mainContent.style.display = 'block'; }
                            return;
                        }

                         setupEventListeners(); // Setup listeners AFTER profile load
                         applyTheme(currentProfile); // Apply theme AFTER profile load

                         await switchTab('current'); // Load initial tab data

                        // Hide loader AFTER initial tab data attempt
                        if (ui.initialLoader) { ui.initialLoader.classList.add('hidden'); setTimeout(() => { if (ui.initialLoader) ui.initialLoader.style.display = 'none'; }, 300); }
                        if (ui.mainContent) { ui.mainContent.style.display = 'block'; requestAnimationFrame(() => { ui.mainContent.classList.add('loaded'); }); }
                        console.log("✅ [Init Plan] Page initialized.");

                    } else {
                        console.log("[Init Plan] Not logged in. Redirecting...");
                        window.location.href = '/auth/index.html';
                    }
                } catch (error) {
                    console.error("❌ [Init Plan] Error:", error);
                    if (ui.initialLoader && !ui.initialLoader.classList.contains('hidden')) { ui.initialLoader.innerHTML = `<p style="color: var(--danger);">Chyba (${error.message}). Obnovte.</p>`; }
                    else { showError(`Chyba inicializace: ${error.message}`, true); }
                    if (ui.mainContent) ui.mainContent.style.display = 'none';
                    setLoadingState('all', false);
                }
            }
            // ИСПРАВЛЕНО: Добавлена функция applyTheme
             function applyTheme(profile) {
                 const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                 const savedPreference = profile?.preferences?.dark_mode;
                 // Use saved preference if it exists (true or false), otherwise fallback to OS preference
                 const useDark = typeof savedPreference === 'boolean' ? savedPreference : prefersDark;
                 document.documentElement.setAttribute('data-theme', useDark ? 'dark' : 'light');
                 console.log(`[Theme] Applied theme: ${useDark ? 'dark' : 'light'}`);
             }

            // --- Event Listeners Setup ---
             function setupEventListeners() {
                 if (ui.mobileMenuToggle) ui.mobileMenuToggle.addEventListener('click', toggleMobileMenu);
                 if (ui.sidebarOverlay) ui.sidebarOverlay.addEventListener('click', toggleMobileMenu);
                 if (ui.sidebarCloseToggle) ui.sidebarCloseToggle.addEventListener('click', toggleMobileMenu);
                 ui.planTabs.forEach(tab => { tab.addEventListener('click', () => switchTab(tab.dataset.tab)); });
                 if(ui.backToSourceTabBtn) ui.backToSourceTabBtn.addEventListener('click', () => switchView('tabs', activeTab));
                 window.addEventListener('resize', () => { if (window.innerWidth > 992 && ui.sidebar?.classList.contains('active')) closeMenu(); });
                  if(ui.mainContent) ui.mainContent.addEventListener('scroll', handleScroll);
                  // Listener for OS theme changes (only applies if user hasn't set a preference)
                  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                      if (currentProfile && typeof currentProfile.preferences?.dark_mode !== 'boolean') {
                          applyTheme(currentProfile);
                      }
                  });
             }

            // --- Запуск ---
             // ИСПРАВЛЕНО: Вызов initializePage с задержкой после DOMContentLoaded
             document.addEventListener('DOMContentLoaded', () => {
                 setTimeout(initializePage, 0);
             });

        })(); // Конец IIFE
    </script>
</body>
</html>