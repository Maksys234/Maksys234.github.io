<!DOCTYPE html>
<html lang="cs" data-theme="light"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Studijní plán</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- Оригинальные стили из твоего plan.html --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        :root {
            --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9;
            --success: #06d6a0; --danger: #f72585; --warning: #f8961e; --info: #4895ef;
            --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d; --gray-light: #dee2e6;
            --gray-dark: #343a40; --white: #ffffff;
            /* --- ДОБАВЛЕНЫ/ИЗМЕНЕНЫ ПЕРЕМЕННЫЕ --- */
            --primary-rgb: 67, 97, 238;
            --secondary-rgb: 63, 55, 201;
            --success-rgb: 6, 214, 160;
            --danger-rgb: 247, 37, 133;
            --warning-rgb: 248, 150, 30;
            --info-rgb: 72, 149, 239;
            --gray-100: #f8f9fa; --gray-200: #e9ecef; --gray-300: #dee2e6;
            --gray-400: #ced4da; --gray-500: #adb5bd; --gray-600: #6c757d;
            --gray-700: #495057; --gray-800: #343a40; --gray-900: #212529;
             --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3);
            --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee);
            --gradient-3: linear-gradient(135deg, #f72585, #7209b7);
            --gradient-4: linear-gradient(135deg, #f8961e, #f3722c);
             /* Sémantické barvy (default light) */
            --bg-color: #f9fafb;
            --card-bg-color: var(--white);
            --card-bg-color-rgb: 255, 255, 255;
            --text-primary: var(--gray-800);
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: var(--gray-200);
            --input-bg: var(--white);
            --input-border: var(--gray-300);
            --input-focus-border: var(--primary-light);
            --input-focus-shadow: rgba(var(--primary-rgb), 0.15);
            --skeleton-bg: #f3f4f6;
            --skeleton-highlight: #e5e7eb;
             /* Размеры и переходы */
            --sidebar-width: 260px; /* <-- НОВАЯ ШИРИНА */
            --transition-speed: 0.3s;
            --transition-bezier: cubic-bezier(0.4, 0, 0.2, 1);
            --card-radius: 14px;
            --button-radius: 8px;
            --form-element-radius: 6px;
             /* Тени */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.07);
        }
        body { background-color: var(--bg-color); color: var(--text-primary); min-height: 100vh; display: flex; overflow-x: hidden; transition: background-color 0.3s, color 0.3s; }

        /* --- НОВЫЕ/ИЗМЕНЕННЫЕ СТИЛИ ДЛЯ SIDEBAR --- */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 1000; box-shadow: var(--shadow-lg); transition: transform var(--transition-speed) var(--transition-bezier), width var(--transition-speed) var(--transition-bezier); }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; position: relative; min-height: 40px; }
        #sidebar-close-toggle { display: none; position: absolute; right: -5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: rgba(255, 255, 255, 0.8); font-size: 1.6rem; cursor: pointer; padding: 0.5rem; line-height: 1; }
        .sidebar-logo { font-size: 1.5rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo i { font-size: 1.75rem; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
         .sidebar-menu::-webkit-scrollbar { width: 5px; }
         .sidebar-menu::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 3px;}
         .sidebar-menu::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.3); border-radius: 3px; }
         .sidebar-menu { scrollbar-width: thin; scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.05); }
        .sidebar-item { margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.8rem 1rem; color: rgba(255, 255, 255, 0.85); text-decoration: none; border-radius: var(--button-radius); transition: background-color 0.2s ease, color 0.2s ease; font-weight: 500; position: relative; }
        .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; width: 24px; text-align: center; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--white); }
        .sidebar-link.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); height: 60%; width: 4px; background-color: var(--white); border-radius: 0 3px 3px 0; }
        .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); text-align: center; flex-shrink: 0;}
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.08); border-radius: 12px; border: 1px solid rgba(255,255,255, 0.1); flex-shrink: 0;}
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-weight: 500; overflow: hidden; color: var(--white); border: 2px solid rgba(255,255,255, 0.3); flex-shrink: 0;}
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; overflow: hidden; }
        .user-name { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-role { font-size: 0.8rem; opacity: 0.8; white-space: nowrap;}
        /* Мобильное меню и оверлей */
        .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; font-size: 1.5rem; color: var(--text-primary); padding: 0.5rem; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.55); z-index: 999; opacity: 0; transition: opacity var(--transition-speed) ease; backdrop-filter: blur(4px); }
        .sidebar-overlay.active { display: block; opacity: 1; }
         /* --- КОНЕЦ НОВЫХ СТИЛЕЙ SIDEBAR --- */

        /* --- Основной контент (Стили из оригинала + использование новых переменных) --- */
        main { flex: 1; margin-left: var(--sidebar-width); padding: 1.5rem 2rem; transition: margin var(--transition-speed) var(--transition-bezier); width: calc(100% - var(--sidebar-width)); overflow-y: auto; height: 100vh;} /* Добавлено overflow и height */
         main:not(.loaded) { opacity: 0; } /* Скрыто до загрузки */
         main.loaded { opacity: 1; animation: fadeInMain 0.4s ease-out forwards; }
         @keyframes fadeInMain { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .dashboard-header { margin-bottom: 2rem; background-color: var(--card-bg-color); border-radius: var(--card-radius); padding: 1rem 1.75rem; box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 900; border-bottom: 1px solid transparent; transition: box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease; }
         body.scrolled .dashboard-header { box-shadow: var(--shadow-md); border-bottom-color: var(--border-color); background-color: rgba(var(--card-bg-color-rgb), 0.95); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .header-content h1 { font-size: 1.75rem; font-weight: 600; color: var(--text-primary); }
        .main-content { display: flex; flex-direction: column; gap: 1.75rem; }
        .section { background-color: var(--card-bg-color); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); padding: 1.75rem; border: 1px solid var(--border-color); }
         .section.has-tabs { padding-top: 0; }
         .section.has-tabs > .tab-content-area { padding: 1.75rem; }
        .section-title { font-size: 1.4rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .section-title i { font-size: 0.9em; color: var(--primary); margin-right: 0.6rem; }
        .section-subtitle { font-size: 1.1rem; font-weight: 500; margin-bottom: 1rem; color: var(--text-primary); }
        .section-text { font-size: 1rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 1.5rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.7rem 1.4rem; border-radius: var(--button-radius); font-weight: 500; font-size: 0.9rem; text-decoration: none; transition: all 0.3s ease; cursor: pointer; border: none; gap: 0.5rem; }
        .btn-primary { background: var(--gradient-1); color: white; box-shadow: var(--shadow-sm); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); background: linear-gradient(135deg, var(--primary-light), var(--secondary)); }
        .btn-secondary { background-color: var(--card-bg-color); color: var(--text-secondary); border: 1px solid var(--border-color); box-shadow: var(--shadow-xs); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--gray-100); border-color: var(--gray-medium); }
        .btn-success { background: linear-gradient(135deg, var(--success), var(--success-dark)); color: white; box-shadow: 0 4px 10px rgba(var(--success-rgb), 0.2); }
        .btn-success:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(var(--success-rgb), 0.25); }
        .btn-lg { padding: 0.75rem 2rem; font-size: 1rem; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn i { margin-right: 0.4em; }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 1rem; margin: 1.5rem 0; justify-content: center; }
        .plan-tabs { display: flex; margin-bottom: 0; border-bottom: 1px solid var(--border-color); overflow-x: auto; scrollbar-width: none; background-color: var(--card-bg-color); border-radius: var(--card-radius) var(--card-radius) 0 0; padding: 0 0.75rem; }
        .plan-tabs::-webkit-scrollbar { display: none; }
        .plan-tab { padding: 0.9rem 1.75rem; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.3s ease; white-space: nowrap; font-size: 0.95rem; }
        .plan-tab:hover { color: var(--primary); }
        .plan-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-pane { display: none; } .tab-pane.active { display: block; }
        .tab-content-area { /* wrapper */ }
        .ai-loading { display: flex; align-items: center; gap: 1rem; margin: 2rem 0; font-style: italic; color: var(--text-muted); justify-content: center; }
        .ai-loading-spinner { width: 24px; height: 24px; border: 3px solid rgba(var(--primary-rgb), 0.2); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .plan-content { margin-top: 1rem; padding: 1.75rem; background-color: var(--light); border-radius: var(--card-radius); border: 1px solid var(--border-color); line-height: 1.7; }
        /* ... (стили для markdown h1, h2, code и т.д. как раньше) ... */
         .step-navigation { display: flex; justify-content: space-between; margin-bottom: 1.5rem; margin-top: 1rem; }
         .message-box { background-color: var(--info-bg); border-left: 4px solid var(--info); padding: 1.5rem; margin: 1rem 0; border-radius: var(--button-radius); border: 1px solid var(--info-light); }
         /* ... (стили для .message-box.warning/error) ... */
         .plan-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
         .plan-meta { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; }
         .plan-date { font-size: 0.9rem; color: var(--text-muted); }
         .plan-actions { display: flex; gap: 1rem; flex-shrink: 0; }
         .plan-history { margin-top: 1rem; }
         .history-item { background-color: var(--card-bg-color); border-radius: var(--button-radius); padding: 1.25rem 1.5rem; margin-bottom: 1rem; box-shadow: var(--shadow-xs); display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; cursor: pointer; border: 1px solid var(--border-color); position: relative; min-height: 60px; }
         /* ... (стили history item и locked overlay) ... */
         .loader-container { display: flex; justify-content: center; align-items: center; min-height: 200px; padding: 2rem; }
         .loader { width: 40px; height: 40px; border: 4px solid rgba(var(--primary-rgb), 0.2); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; }
        /* --- Календарь/Расписание (оригинальные стили) --- */
        .schedule-section { padding: 0; border: none; box-shadow: none; background: none; position: relative; }
        .calendar-scroll-container { overflow-x: auto; padding-bottom: 10px; margin-top: 0; border: 1px solid var(--border-color); border-radius: var(--card-radius); background-color: var(--card-bg-color); box-shadow: var(--shadow-sm); min-height: 300px; position: relative; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(180px, 1fr)); min-width: calc(7 * 180px); }
        .calendar-day-cell { border-left: 1px solid var(--border-color); min-height: 250px; display: flex; flex-direction: column; position: relative; }
        .calendar-day-cell:first-child { border-left: none; }
        .calendar-day-header { padding: 0.75rem 0.5rem; font-weight: 600; text-align: center; background-color: var(--gray-100); border-bottom: 1px solid var(--border-color); font-size: 0.9rem; color: var(--text-secondary); position: sticky; top: 0; z-index: 10; }
        .calendar-day-cell.today .calendar-day-header { background-color: rgba(var(--success-rgb), 0.1); color: var(--success-dark); font-weight: 700; }
        .calendar-day-cell.today { background-color: rgba(var(--success-rgb), 0.03); }
        .calendar-activities { padding: 0.75rem; flex-grow: 1; display: flex; flex-direction: column; gap: 0.75rem; overflow-y: auto; }
        .calendar-activity { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-left: 4px solid var(--primary); border-radius: var(--form-element-radius); padding: 0.6rem 0.8rem; font-size: 0.85rem; box-shadow: var(--shadow-xs); transition: all 0.2s ease; cursor: pointer; }
         .calendar-activity:hover { transform: translateY(-2px) scale(1.01); box-shadow: var(--shadow-sm); border-left-color: var(--secondary); }
        .calendar-activity .activity-checkbox { gap: 0.6rem; align-items: center; display: flex; }
         .calendar-activity .activity-checkbox input[type="checkbox"] { min-width: 16px; height: 16px; margin-top: 0; cursor: pointer; accent-color: var(--primary); }
        .calendar-activity .activity-content { flex-grow: 1; }
        .calendar-activity .activity-title { font-weight: 500; color: var(--text-primary); font-size: 0.9rem; margin-bottom: 2px; line-height: 1.3; }
         .calendar-activity .activity-time-display { font-weight: 600; color: var(--primary); margin-right: 6px; font-size: 0.85em; }
        .calendar-activity .activity-desc { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; padding-left: calc(16px + 0.6rem); display: none; line-height: 1.4; }
        .calendar-activity.expanded .activity-desc { display: block; }
        .calendar-activity .activity-checkbox input:checked + .activity-content .activity-title { text-decoration: line-through; opacity: 0.7; color: var(--text-muted); }
        /* Skeleton styles */
        .skeleton { background-color: var(--skeleton-bg); border-radius: 4px; position: relative; overflow: hidden; }
        .skeleton::after { content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, var(--skeleton-highlight), transparent); animation: skeleton-loading 1.5s infinite linear; }
        @keyframes skeleton-loading { 0% { left: -150%; } 100% { left: 150%; } }
        .skeleton.title-sm { height: 14px; width: 60%; margin-bottom: 0.6rem; }
        .skeleton.value-lg { height: 30px; width: 40%; margin-bottom: 0.5rem; border-radius: 6px; }
        .skeleton.text-sm { height: 12px; width: 70%; }
        .schedule-day .loading-skeleton { display: none; flex-direction: column; width: 100%; height: 100%; padding: 0.75rem; }
        .schedule-day.loading .loading-skeleton { display: flex; }
        .schedule-day.loading > *:not(.loading-skeleton) { visibility: hidden; }
        .skeleton.activity-icon-placeholder { width: 16px; height: 16px; flex-shrink: 0; background-color: var(--skeleton-bg); border-radius: 3px; }
        .skeleton.activity-line { width: 80%; height: 14px; margin-bottom: 4px; background-color: var(--skeleton-bg); }
        .skeleton.activity-line-short { width: 50%; height: 10px; background-color: var(--skeleton-bg); }
        .skeleton-activity-item { display:flex; gap: 0.75rem; padding: 0.5rem 0; }
         .history-item .loading-skeleton { display: none; width: 100%; padding: 0.5rem 0;}
         .history-item.loading .loading-skeleton { display: block; }
         .history-item.loading > *:not(.loading-skeleton) { visibility: hidden; }

        /* Initial Loading Overlay (НОВЫЙ) */
        .initial-loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 1100; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 1rem; transition: opacity 0.5s ease-out; }
        .initial-loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .initial-loading-overlay .loading-spinner { width: 35px; height: 35px; border-width: 4px; border-color: var(--primary); border-top-color: transparent; animation: spin 0.8s linear infinite;}
        .initial-loading-overlay p { color: var(--text-secondary); font-size: 1.1rem;}

        /* Toast */
        .toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1050; display: flex; flex-direction: column; gap: 0.75rem; max-width: 380px; pointer-events: none; }
        .toast { /* ... */ }
        /* Error Message Container */
         .error-container { display: none; margin-bottom: 1.5rem; }
         .error-message { /* ... */ }

        /* Responsive styles (объединены/обновлены) */
        @media (max-width: 992px) { :root { --sidebar-width: 80px; } main { margin-left: 80px; width: calc(100% - 80px); } .sidebar { width: 80px; } .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; } .sidebar-link i { margin-right: 0; font-size: 1.5rem; } .sidebar-logo i { margin-right: 0; } .sidebar-header, .sidebar-link { justify-content: center; } .user-profile { justify-content: center; padding: 0.75rem; } .user-avatar { margin-right: 0; } .mobile-menu-toggle { display: block; } #sidebar-close-toggle { display: none !important; } /* ... (остальные от 992px) ... */ }
        @media (max-width: 768px) { /* ... */ }
        @media (max-width: 576px) { :root { --sidebar-width: 0; } main { margin-left: 0; width: 100%; } .sidebar { transform: translateX(-100%); width: 260px; z-index: 1000;} .sidebar.active { transform: translateX(0); } .sidebar.active .sidebar-logo span, .sidebar.active .sidebar-link span, .sidebar.active .user-info, .sidebar.active .sidebar-footer { display: block; } .sidebar.active .sidebar-link i { margin-right: 0.75rem; } .sidebar.active .sidebar-header, .sidebar.active .sidebar-link { justify-content: flex-start; } .sidebar.active .user-profile { padding: 1rem; } .sidebar.active .user-avatar { margin-right: 0.75rem; } .sidebar.active #sidebar-close-toggle { display: block; } /* ... (остальные от 576px) ... */ }

        /* Dark Mode (с использованием data-theme) */
        [data-theme="dark"] {
             --bg-color: #131720; --card-bg-color: #1e2533;
             /* ... (все переменные для темного режима) ... */
        }
        [data-theme="dark"] body { /* ... */ }
        [data-theme="dark"] .section, [data-theme="dark"] .dashboard-header, /* ... */ [data-theme="dark"] .calendar-activity { /* ... */ }
        /* ... (все остальные переопределения для темного режима) ... */
    </style>
</head>
<body>
    <div class="initial-loading-overlay" id="initial-loader">
         <div class="loading-spinner"></div>
         <p>Načítání plánu...</p>
     </div>

    <div id="sidebar-overlay" class="sidebar-overlay"></div>
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header"> <button class="mobile-menu-toggle" id="sidebar-close-toggle"> <i class="fas fa-times"></i> </button> <a href="/dashboard/dashboard.html" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
        <ul class="sidebar-menu">
            <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Nástěnka</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li>
        </ul>
        <div class="user-profile"> <div class="user-avatar" id="user-avatar">?</div> <div class="user-info"> <div class="user-name" id="user-name">Načítání...</div> <div class="user-role">Student</div> </div> </div>
        <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main id="main-content" style="display: none;">
        <div class="error-container" id="global-error"></div>
        <header class="dashboard-header"> </header>
        <div class="main-content">
            <div class="plan-tabs"> </div>
            <div class="section current-plan-section" id="currentPlanSection"> </div>
            <div class="section history-plan-section" id="historyPlanSection" style="display: none;"> </div>
            <div class="section create-plan-section" id="createPlanSection" style="display: none;"> </div>
            <div class="section plan-section" id="planSection" style="display: none;"> </div>
            <div class="section schedule-section" id="scheduleSection" style="display: none;"> </div>
            </div>
        <footer class="dashboard-footer"> <p>&copy; 2025 Justax. Všechna práva vyhrazena.</p> </footer>
    </main>

    <div class="toast" id="toast"> </div>

    <script>
        // --- Оригинальный JavaScript из твоего plan.html ---
        // (Добавлены только: инициализация Supabase, проверка auth,
        //  загрузка профиля, обновление сайдбара, тема, управление лоадером)

        // --- START: Добавленные глобальные переменные ---
        const supabaseUrl_global = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
        const supabaseKey_global = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
        const GEMINI_API_KEY_global = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // WARNING: Keep secure
        const GEMINI_API_URL_global = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY_global}`;
        let supabaseClient_global = null; // Переименовано, чтобы избежать конфликтов
        let currentUser_global = null;
        let currentProfile_global = null;
        // --- END: Добавленные глобальные переменные ---

        // --- START: Добавленные Helper Functions ---
        // (Функции showToast, showError, hideError, sanitizeHTML, getInitials, formatDate, toggleMobileMenu, applyTheme)
        // Важно: Убедись, что эти функции не конфликтуют с именами в твоем оригинальном коде.
        // Если конфликтуют, переименуй их здесь и в вызовах.
         function showToast(message, type = 'info', duration = 4000) { /* ... Реализация ... */ }
         function showError(message, isGlobal = false) { /* ... Реализация ... */ }
         function hideError() { /* ... Реализация ... */ }
         function sanitizeHTML(str) { /* ... Реализация ... */ }
         function getInitials(profile) { /* ... Реализация ... */ }
         function formatDate(dateString) { /* ... Реализация ... */ }
         function toggleMobileMenu() { /* ... Реализация ... */ }
         function applyTheme(profile) { /* ... Реализация ... */ }
         function updateUserInfoUI(profileData, userEmail) { // Обновляет ТОЛЬКО НОВЫЙ сайдбар
            const sidebarUserName = document.getElementById('user-name'); // ID в новом сайдбаре
            const sidebarUserAvatar = document.getElementById('user-avatar'); // ID в новом сайдбаре
             if (!sidebarUserName || !sidebarUserAvatar) return;
             if (currentUser_global && profileData) {
                 const displayName = `${profileData.first_name || ''} ${profileData.last_name || ''}`.trim() || profileData.username || userEmail?.split('@')[0] || 'Uživatel';
                 sidebarUserName.textContent = displayName;
                 const initials = getInitials(profileData);
                 sidebarUserAvatar.innerHTML = profileData.avatar_url ? `<img src="${profileData.avatar_url}" alt="${initials}">` : initials;
             } else {
                 sidebarUserName.textContent = 'Nepřihlášen';
                 sidebarUserAvatar.textContent = '?';
             }
         }
         async function fetchUserProfile(userId) { // Новая функция для загрузки профиля
            if (!supabaseClient_global || !userId) return null;
            console.log(`[Profile] Fetching profile for user ID: ${userId}`);
            try {
                const { data: profile, error } = await supabaseClient_global.from('profiles').select('*').eq('id', userId).single();
                if (error && error.code !== 'PGRST116') throw error;
                return profile; // Возвращает профиль или null
            } catch (error) {
                console.error('[Profile] Exception fetching profile:', error);
                showToast('Nepodařilo se načíst data profilu.', 'error');
                return null;
            }
         }
        // --- END: Добавленные Helper Functions ---


        // ==============================================
        //          ТВОЙ ОРИГИНАЛЬНЫЙ КОД JavaScript ИЗ plan.html
        // ==============================================
        // (Сюда вставляется ВЕСЬ твой оригинальный JS код)
        // Важно:
        // 1. Замени все использования `supabase.createClient(...)` на `supabaseClient_global = supabase.createClient(...)` (если они есть в глобальной области).
        // 2. Замени все использования `currentUser` на `currentUser_global`, если они есть в глобальной области или передаются как параметры.
        // 3. Убедись, что твой код не объявляет функции или переменные с такими же именами, как добавленные хелперы (showToast, showError и т.д.), или переименуй конфликтующие.

        // --- Пример интеграции проверки Auth в начало твоего кода ---
        // Найди место, где ты инициализируешь Supabase в твоем оригинальном коде
        // или просто добавь это в самое начало твоего скрипта:

        async function initializeOriginalAppLogic() {
            console.log("Starting ORIGINAL App Logic Initialization");

            // --- START: ДОБАВЛЕННЫЙ КОД АВТОРИЗАЦИИ ---
            try {
                 if (typeof supabase === 'undefined' || typeof supabase.createClient !== 'function') {
                     throw new Error("Supabase library not loaded correctly.");
                 }
                 supabaseClient_global = supabase.createClient(supabaseUrl_global, supabaseKey_global);
                 console.log("Supabase client initialized (within original logic).");

                 const { data: { session }, error: sessionError } = await supabaseClient_global.auth.getSession();
                 if (sessionError) throw sessionError;

                 if (!session || !session.user) {
                     console.log('User not logged in (checked in original logic), redirecting...');
                     window.location.href = '/auth/index.html';
                     return; // Stop execution
                 }
                 currentUser_global = session.user;
                 console.log("User authenticated (checked in original logic):", currentUser_global.id);

                 currentProfile_global = await fetchUserProfile(currentUser_global.id); // Используем новую функцию
                 console.log("Profile fetched (within original logic):", currentProfile_global);

                 updateUserInfoUI(currentProfile_global, currentUser_global.email); // Обновляем новый сайдбар
                 applyTheme(currentProfile_global); // Применяем тему

                 // Добавляем слушатели для нового сайдбара
                 const mobileMenuToggle = document.getElementById('mobileMenuToggle'); // ID в новом header
                 const sidebar = document.getElementById('sidebar');
                 const sidebarOverlay = document.getElementById('sidebar-overlay');
                 const sidebarCloseToggle = document.getElementById('sidebar-close-toggle'); // Кнопка закрытия в сайдбаре

                 if (mobileMenuToggle) mobileMenuToggle.addEventListener('click', toggleMobileMenu);
                 if (sidebarOverlay) sidebarOverlay.addEventListener('click', toggleMobileMenu);
                 if (sidebarCloseToggle) sidebarCloseToggle.addEventListener('click', toggleMobileMenu);
                 window.addEventListener('resize', () => { if (window.innerWidth > 992 && sidebar?.classList.contains('active')) toggleMobileMenu(); }); // Используем toggleMobileMenu


            } catch (error) {
                 console.error("Critical Auth/Profile error in original logic wrapper:", error);
                 showError(`Chyba ověření/profilu: ${error.message}`, true);
                 // Скрыть главный лоадер и показать ошибку, если возможно
                 const initialLoaderEl = document.getElementById('initial-loader');
                 const mainContentEl = document.getElementById('main-content');
                 if (initialLoaderEl) { initialLoaderEl.classList.add('hidden'); initialLoaderEl.style.display = 'none'; }
                 if (mainContentEl) mainContentEl.style.display = 'block'; // Показать main для ошибки
                 return; // Остановить выполнение
            }
            // --- END: ДОБАВЛЕННЫЙ КОД АВТОРИЗАЦИИ ---


            // --- ЗДЕСЬ НАЧИНАЕТСЯ ТВОЯ ОРИГИНАЛЬНАЯ ЛОГИКА ---
            // (Твои оригинальные объявления переменных, DOM кэш, функции loadCurrentPlan,
            // loadPlanHistory, generateStudyPlan, setupEventListeners и т.д.)

            // Пример: Если у тебя была функция init()
             // function init() {
             //    // ... твой оригинальный код ...
             //    loadCurrentPlan(); // Вызов твоей функции
             //    setupEventListeners(); // Вызов твоей функции слушателей
             // }
             // init(); // Вызов твоей инициализации

            // --- ДОБАВЛЕНО: Скрытие лоадера и показ контента ---
            // Этот код должен выполниться ПОСЛЕ того, как твоя основная логика отработает
            // и подготовит контент к показу (даже если это просто сообщение об ошибке или пустом состоянии)
            // Помести его в самый конец твоего основного потока выполнения скрипта
            // или в конец твоей главной инициализирующей функции.
            console.log("Attempting to hide loader and show main content...");
            const initialLoaderEl = document.getElementById('initial-loader');
            const mainContentEl = document.getElementById('main-content');
            if (initialLoaderEl) {
                 initialLoaderEl.classList.add('hidden');
                 setTimeout(() => { if (initialLoaderEl) initialLoaderEl.style.display = 'none'; }, 300);
                 console.log("Initial loader hidden.");
            } else { console.warn("Initial loader element not found."); }
            if (mainContentEl) {
                 mainContentEl.style.display = 'block';
                 requestAnimationFrame(() => mainContentEl.classList.add('loaded'));
                 console.log("Main content shown.");
            } else { console.error("Main content element not found!"); }
            // --- КОНЕЦ ДОБАВЛЕННОГО КОДА ---
        }

        // Вызов основной логики твоего скрипта (замени на твой реальный вызов)
        // Если твой скрипт просто выполнялся без функции init, то этот вызов не нужен,
        // просто убедись, что код скрытия лоадера добавлен в самый конец.
         // document.addEventListener('DOMContentLoaded', initializeOriginalAppLogic); // Если у тебя был listener
         initializeOriginalAppLogic(); // Или прямой вызов, если listener'а не было


    </script>

</body>
</html>