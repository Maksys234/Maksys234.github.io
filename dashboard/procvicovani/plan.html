<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Studijní plán</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/all.min.css">

    <link rel="stylesheet" href="css/tooltipster.bundle.min.css">

    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* --- Základní CSS STYLES (Site Theme) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        :root { --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9; --success: #06d6a0; --danger: #f72585; --warning: #f8961e; --info: #4895ef; --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d; --gray-light: #dee2e6; --gray-dark: #343a40; --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3); --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee); --gradient-3: linear-gradient(135deg, #f72585, #7209b7); --gradient-4: linear-gradient(135deg, #f8961e, #f3722c); --white: #ffffff; --sidebar-width: 260px; --transition-speed: 0.3s; --card-radius: 16px; --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05); --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.07); --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1); --text-primary: #2d3748; --text-secondary: #4a5568; --text-muted: #718096; }
        body { background-color: #f6f8ff; color: var(--text-primary); min-height: 100vh; display: flex; overflow-x: hidden; }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 100; box-shadow: var(--shadow-lg); transition: transform var(--transition-speed) ease, width var(--transition-speed) ease; }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; }
        .sidebar-logo { font-size: 1.5rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo i { font-size: 1.75rem; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .sidebar-item { margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; color: rgba(255, 255, 255, 0.85); text-decoration: none; border-radius: 12px; transition: all 0.2s ease; font-weight: 500; }
        .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; width: 24px; text-align: center; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--white); }
        .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); text-align: center; }
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.1); border-radius: 12px; backdrop-filter: blur(5px); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-weight: 500; overflow: hidden; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15); }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; }
        .user-name { font-weight: 600; font-size: 0.95rem; }
        .user-role { font-size: 0.8rem; opacity: 0.8; }
        main { flex: 1; margin-left: var(--sidebar-width); padding: 1.5rem 2rem; transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); }
        .dashboard-header { margin-bottom: 2rem; background-color: var(--white); border-radius: var(--card-radius); padding: 1.25rem 1.5rem; box-shadow: var(--shadow-sm); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-content h1 { font-size: 1.75rem; font-weight: 600; color: var(--dark); }
        .main-content { display: flex; flex-direction: column; gap: 1.75rem; }
        .section { background-color: var(--white); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); padding: 1.5rem; animation: fadeIn 0.5s ease forwards; }
        .section-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1.25rem; color: var(--dark); }
        .section-subtitle { font-size: 1.1rem; font-weight: 500; margin-bottom: 1rem; color: var(--dark); }
        .section-text { font-size: 1rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 1.5rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; font-size: 0.95rem; text-decoration: none; transition: all 0.3s ease; cursor: pointer; border: none; gap: 0.5rem; }
        .btn-primary { background: var(--gradient-1); color: white; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.2); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(67, 97, 238, 0.25); }
        .btn-secondary { background-color: var(--light); color: var(--text-secondary); border: 1px solid var(--gray-light); }
        .btn-secondary:hover { background-color: var(--gray-light); color: var(--dark); }
        .btn-success { background: linear-gradient(135deg, #4cc9f0, #38b2ac); color: white; box-shadow: 0 4px 10px rgba(76, 201, 240, 0.2); }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(76, 201, 240, 0.25); }
        .btn-lg { padding: 0.75rem 2rem; font-size: 1rem; }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 1rem; margin: 1.5rem 0; justify-content: center; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .ai-loading { display: flex; align-items: center; gap: 1rem; margin: 2rem 0; font-style: italic; color: var(--text-muted); justify-content: center; }
        .ai-loading-spinner { width: 24px; height: 24px; border: 3px solid rgba(67, 97, 238, 0.2); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s ease-in-out infinite; }

        /* Styly pro Zobrazení PLÁNU (Markdown) */
        .plan-content { margin-top: 1rem; padding: 1.5rem; background-color: #f9f9ff; border-radius: var(--card-radius); border-left: 4px solid var(--primary); line-height: 1.7; }
        .plan-content h1, .plan-content h2, .plan-content h3, .plan-content h4 { color: var(--primary); margin-bottom: 0.8rem; font-weight: 600; padding-bottom: 0.3rem; border-bottom: 1px solid var(--gray-light); }
        .plan-content h1 { font-size: 1.6rem; }
        .plan-content h2 { font-size: 1.4rem; margin-top: 2rem; }
        .plan-content h3 { font-size: 1.2rem; margin-top: 1.5rem; color: var(--dark); border-bottom: none;}
        .plan-content h4 { font-size: 1.1rem; margin-top: 1.2rem; color: var(--secondary); border-bottom: none; }
        .plan-content p { margin-bottom: 1rem; }
        .plan-content ul, .plan-content ol { margin-left: 1.5rem; margin-bottom: 1rem; padding-left: 1rem; }
        .plan-content li { margin-bottom: 0.7rem; }
        .plan-content li::marker { color: var(--primary); }
        .plan-content strong { color: var(--secondary); font-weight: 600; }
        .plan-content code { background-color: rgba(67, 97, 238, 0.1); padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.9rem; font-family: 'Courier New', Courier, monospace; }
        .plan-content blockquote { border-left: 3px solid var(--primary-light); padding-left: 1rem; margin: 1rem 0; color: var(--text-secondary); font-style: italic; }
        .plan-content hr { border: none; border-top: 1px dashed var(--gray-light); margin: 2rem 0; }
        .plan-content em { font-style: italic; color: var(--text-secondary); }

        /* Styly pro Navigaci a Zprávy */
        .step-navigation { display: flex; justify-content: space-between; margin-bottom: 1.5rem; }
        .notest-message { background-color: rgba(255, 214, 102, 0.2); border-left: 4px solid var(--warning); padding: 1.5rem; margin: 2rem 0; border-radius: var(--card-radius); }
        .notest-message h3 { color: var(--warning); margin-bottom: 0.75rem; font-size: 1.2rem; }
        .notest-message p { color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.5; }
        .notest-message.error { background-color: rgba(247, 37, 133, 0.1); border-left-color: var(--danger); }
        .notest-message.error h3 { color: var(--danger); }
        .notest-message.info { background-color: rgba(72, 149, 239, 0.1); border-left-color: var(--info); }
        .notest-message.info h3 { color: var(--info); }

        /* Styly pro Záhlaví Plánu a Aktivity (v kalendáři) */
        .plan-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .plan-meta { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; }
        .plan-date { font-size: 0.9rem; color: var(--text-muted); }
        .plan-actions { display: flex; gap: 1rem; flex-shrink: 0; }
        .activity-checkbox { display: flex; gap: 0.75rem; align-items: flex-start; }
        .activity-checkbox input[type="checkbox"] { min-width: 18px; height: 18px; margin-top: 3px; cursor: pointer; }
        .activity-checkbox .activity-content { text-decoration: none; transition: all 0.2s ease; }
        .activity-checkbox input[type="checkbox"]:checked + .activity-content { text-decoration: line-through; opacity: 0.7; }

        /* Styly pro Historii Plánů */
        .plan-history { margin-top: 2rem; }
        .history-item { background-color: var(--white); border-radius: var(--card-radius); padding: 1.25rem; margin-bottom: 1rem; box-shadow: var(--shadow-sm); display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; cursor: pointer; }
        .history-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .history-date { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .history-title { font-weight: 600; color: var(--dark); }
        .history-status { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .history-status.active { background-color: rgba(76, 201, 240, 0.15); color: #4cc9f0; }
        .history-status.completed { background-color: rgba(67, 97, 238, 0.15); color: var(--primary); }
        .history-status.inactive { background-color: rgba(108, 117, 125, 0.15); color: var(--gray);}

        /* Styly pro Tooltipy */
        .tooltip-inner { background-color: var(--dark); color: var(--white); border-radius: 4px; padding: 0.5rem 0.75rem; font-size: 0.9rem; max-width: 250px; box-shadow: var(--shadow-md); }
        /* Specifický tooltip pro popis aktivity */
        .tooltipster-activity-desc .tooltipster-content { padding: 5px 8px !important; }
        .tooltipster-activity-desc .tooltipster-content div { max-width: 250px; font-size: 0.85rem !important; line-height: 1.4 !important; padding: 3px !important; }

        /* Styly pro Sekci Vytvořit Nový - Zamknuto */
        .locked-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(26, 32, 44, 0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: var(--card-radius); color: white; padding: 2rem; text-align: center; }
        .locked-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.9; }
        .locked-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; }
        .locked-message { font-size: 1rem; margin-bottom: 1.5rem; opacity: 0.9; max-width: 500px; }
        .timer-container { margin: 1rem 0 2rem; font-size: 1.2rem; font-weight: 600; }

        /* Styly pro Záložky */
        .plan-tabs { display: flex; margin-bottom: 2rem; border-bottom: 1px solid var(--gray-light); overflow-x: auto; scrollbar-width: none; }
        .plan-tabs::-webkit-scrollbar { display: none; }
        .plan-tab { padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.3s ease; white-space: nowrap; }
        .plan-tab:hover { color: var(--primary); }
        .plan-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* Styly pro Loader */
        .loader-container { display: flex; justify-content: center; align-items: center; min-height: 200px; }
        .loader { width: 40px; height: 40px; border: 4px solid rgba(67, 97, 238, 0.2); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animated { animation: fadeIn 0.5s ease forwards; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Styly pro KALENDÁŘ a POSUVNÍK --- */
         .schedule-section { padding-top: 0; } /* Odstraní horní padding sekce */
         .calendar-scroll-container {
            overflow-x: auto;
            padding-bottom: 10px; /* Mezera pod gridem pro stín šipek */
            margin-top: 0; /* Reset margin */
            border: 1px solid var(--gray-light);
            border-radius: var(--card-radius);
            background-color: var(--white);
            position: relative; /* Pro absolutní pozici šipek */
        }
         /* Šipky pro posuvník */
         .scroll-arrow {
             position: absolute;
             top: 50%;
             transform: translateY(-50%);
             background-color: rgba(255, 255, 255, 0.8);
             border: 1px solid var(--gray-light);
             border-radius: 50%;
             width: 30px;
             height: 30px;
             display: flex;
             align-items: center;
             justify-content: center;
             cursor: pointer;
             z-index: 20; /* Nad obsahem */
             box-shadow: var(--shadow-sm);
             opacity: 0; /* Defaultně skryté */
             transition: opacity 0.3s ease;
             color: var(--text-secondary);
             pointer-events: none; /* Defaultně neklikatelné */
         }
         /* Pouze aktivní šipky jsou klikatelné */
         .scroll-arrow:not(.disabled) {
              pointer-events: auto;
         }
         /* Šipky se objeví při najetí na kontejner (pokud nejsou disabled) */
         .calendar-scroll-container:hover .scroll-arrow:not(.disabled) {
            opacity: 0.8;
         }
         /* Hover efekt pro aktivní šipky */
         .calendar-scroll-container .scroll-arrow:not(.disabled):hover {
              background-color: var(--white);
              color: var(--primary);
              opacity: 1;
         }
         .scroll-arrow.left { left: 10px; } /* Odsazení od kraje */
         .scroll-arrow.right { right: 10px; }
         /* Neaktivní šipky jsou úplně skryté */
         .scroll-arrow.disabled {
             opacity: 0 !important;
             cursor: default;
         }

        /* Kalendářová mřížka */
        .calendar-grid {
            display: grid;
            /* 7 sloupců, každý min 200px široký */
            grid-template-columns: repeat(7, minmax(200px, 1fr));
            /* Minimální šířka celého gridu = 7 * 200px */
            min-width: calc(7 * 200px);
        }
        .calendar-day-cell {
            border-left: 1px solid var(--gray-light);
            min-height: 300px; /* Minimální výška buňky dne */
            display: flex;
            flex-direction: column;
            position: relative; /* Pro případné další pozicování */
        }
        /* První buňka nemá levý okraj */
        .calendar-day-cell:first-child { border-left: none; }
        /* Záhlaví dne */
        .calendar-day-header {
             padding: 0.75rem 0.5rem;
             font-weight: 600;
             text-align: center;
             background-color: #f8f9fa; /* var(--light) */
             border-bottom: 1px solid var(--gray-light);
             font-size: 0.9rem;
             color: var(--text-secondary);
             position: sticky; /* Přilepení nahoře při skrolování */
             top: 0;
             z-index: 10; /* Nad aktivitami */
        }
        /* Zvýraznění dnešního dne */
        .calendar-day-cell.today .calendar-day-header {
            background-color: rgba(6, 214, 160, 0.15); /* --success s průhledností */
            color: var(--success);
            font-weight: 700;
        }
        .calendar-day-cell.today {
            background-color: rgba(6, 214, 160, 0.03); /* Velmi jemné pozadí */
        }
        /* Kontejner pro aktivity v daný den */
        .calendar-activities {
            padding: 0.75rem;
            flex-grow: 1; /* Zabere zbývající místo v buňce */
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Mezera mezi aktivitami */
            overflow-y: auto; /* Skrolování, pokud je aktivit moc */
        }
        /* Samotná aktivita v kalendáři */
        .calendar-activity {
            background-color: var(--white);
            border: 1px solid var(--gray-light);
            border-left: 4px solid var(--primary); /* Levý barevný pruh */
            border-radius: 6px;
            padding: 0.6rem 0.8rem;
            font-size: 0.85rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            cursor: default; /* Není rozklikávací, info v tooltipu */
            position: relative; /* Pro tooltip */
        }
        .calendar-activity:hover {
            transform: translateY(-2px) scale(1.01); /* Lehký hover efekt */
            box-shadow: var(--shadow-md);
            border-left-color: var(--secondary);
        }
        .calendar-activity .activity-checkbox { /* Upravíme checkbox v kalendáři */
             gap: 0.6rem;
             align-items: center; /* Zarovnáme checkbox a text vertikálně */
        }
        .calendar-activity .activity-checkbox input[type="checkbox"] {
            margin-top: 0; /* Reset margin */
            transform: scale(1.1); /* Lehce zvětšíme checkbox */
            cursor: pointer;
        }
        .calendar-activity .activity-title {
            font-weight: 500;
            color: var(--dark);
            font-size: 0.9rem; /* Trochu větší font */
            margin-bottom: 2px; /* Menší mezera pod titulkem */
            line-height: 1.3;
        }
        /* Zobrazení času u aktivity */
        .calendar-activity .activity-time-display {
            font-weight: 600;
            color: var(--primary);
            margin-right: 6px;
            font-size: 0.85em; /* Menší než hlavní text aktivity */
        }
        /* Popis aktivity - skrytý, zobrazí se v tooltipu */
        .calendar-activity .activity-desc {
             display: none;
        }
        /* Přeškrtnutí dokončené aktivity */
        .calendar-activity .activity-checkbox input:checked + .activity-content .activity-title {
            text-decoration: line-through;
            opacity: 0.7;
        }


        /* Responsivní úpravy */
        @media (max-width: 1300px) { .calendar-grid { grid-template-columns: repeat(7, minmax(160px, 1fr)); min-width: calc(7 * 160px); } }
        @media (max-width: 992px) { :root { --sidebar-width: 80px; } .sidebar { width: 80px; } .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; } .sidebar-link i { margin-right: 0; font-size: 1.5rem; } .sidebar-logo i { margin-right: 0; } .sidebar-header, .sidebar-link { justify-content: center; } .user-profile { justify-content: center; padding: 0.75rem 0; } .user-avatar { margin-right: 0; } main { margin-left: 80px; width: calc(100% - 80px); } .calendar-grid { grid-template-columns: repeat(7, minmax(150px, 1fr)); min-width: calc(7 * 150px); } }
        @media (max-width: 768px) { main { padding: 1rem; } .header-content { flex-direction: column; align-items: flex-start; gap: 1rem; } .plan-header { flex-direction: column; gap: 1rem; } .plan-actions { width: 100%; justify-content: center; } .plan-tabs { overflow-x: auto; white-space: nowrap; padding-bottom: 0.5rem; } .plan-tab { padding: 0.75rem 1rem; font-size: 0.9rem; } .calendar-grid { grid-template-columns: repeat(7, minmax(130px, 1fr)); min-width: calc(7 * 130px); } .scroll-arrow { display: none; } /* Skryjeme šipky na tabletu */ }
         @media (max-width: 576px) { :root { --sidebar-width: 0; } .sidebar { transform: translateX(-100%); z-index: 1000; width: 260px; } .sidebar.active { transform: translateX(0); } .sidebar.active .sidebar-logo span, .sidebar.active .sidebar-link span, .sidebar.active .user-info, .sidebar.active .sidebar-footer { display: block; } .sidebar.active .sidebar-link i { margin-right: 0.75rem; } .sidebar.active .sidebar-header, .sidebar.active .sidebar-link { justify-content: flex-start; } .sidebar.active .user-profile { justify-content: flex-start; padding: 1rem; } .sidebar.active .user-avatar { margin-right: 0.75rem; } main { margin-left: 0; width: 100%; } .mobile-menu-toggle { display: block; } .calendar-scroll-container { border: none; border-radius: 0; margin-left: -1rem; margin-right: -1rem; } .calendar-grid { display: block; min-width: unset; } /* Změna na blokové zobrazení */ .calendar-day-cell { border-left: none; border-bottom: 1px solid var(--gray-light); min-height: auto; border-radius: 0; margin-bottom: 1rem; background-color: var(--white); box-shadow: var(--shadow-sm);} /* Dny pod sebou */ .calendar-day-cell:last-child { border-bottom: none; margin-bottom: 0; } .scroll-arrow { display: none; } /* Skryjeme šipky na mobilu */ }
        .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; color: var(--dark); font-size: 1.5rem; margin-right: 1rem; }
        .mobile-menu-visible .sidebar { transform: translateX(0); }

        /* Dark mode úpravy */
        @media (prefers-color-scheme: dark) {
             :root { --white: #1a202c; --light: #2d3748; --dark: #e2e8f0; --gray-light: #4a5568; --text-primary: #e2e8f0; --text-secondary: #cbd5e0; --text-muted: #a0aec0; --dark-bg: #1e2533;}
             body { background-color: #171923; }
             .section, .dashboard-header { background-color: var(--dark-bg); }
             .plan-content { background-color: #1e2533; }
             .notest-message { background-color: rgba(255, 214, 102, 0.1); }
             .history-item { background-color: var(--dark-bg); }
             .toast { background-color: var(--dark-bg); border-color: var(--gray-light);}
             .mobile-menu-toggle { color: var(--dark); }
            /* Dark mode pro kalendář */
             .calendar-scroll-container { background-color: var(--dark-bg); border-color: var(--gray-light); }
             .calendar-grid { background-color: transparent; }
             .calendar-day-cell { border-left-color: var(--gray-light); background-color: var(--dark-bg); }
             .calendar-day-header { background-color: var(--light); border-bottom-color: var(--gray-light); color: var(--text-secondary); }
             .calendar-day-cell.today .calendar-day-header { background-color: rgba(6, 214, 160, 0.2); color: var(--success); }
             .calendar-day-cell.today { background-color: rgba(6, 214, 160, 0.06); }
             .calendar-activity { background-color: var(--light); border-color: var(--gray-light); border-left-color: var(--primary); }
              @media (max-width: 576px) { .calendar-day-cell { border-bottom-color: var(--gray-light); background-color: var(--dark-bg); } }
              .scroll-arrow { background-color: rgba(45, 55, 72, 0.8); border-color: var(--gray-light); color: var(--text-muted); }
              .scroll-arrow:not(.disabled):hover { background-color: var(--light); color: var(--primary-light); }
        }

         /* Toast notification */
         .toast { position: fixed; bottom: 20px; right: 20px; background-color: var(--white); color: var(--text-primary); border-radius: 8px; padding: 1rem; box-shadow: var(--shadow-lg); max-width: 300px; z-index: 1001; display: flex; align-items: center; transform: translateY(120px); opacity: 0; transition: all 0.4s ease-in-out; }
         .toast.show { transform: translateY(0); opacity: 1; }
         .toast.success { border-left: 4px solid #10b981; }
         .toast.error { border-left: 4px solid var(--danger); }
         .toast.warning { border-left: 4px solid var(--warning); }
         .toast i { margin-right: 0.75rem; font-size: 1.25rem; }
         .toast.success i { color: #10b981; }
         .toast.error i { color: var(--danger); }
         .toast.warning i { color: var(--warning); }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header"> <a href="/" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
        <ul class="sidebar-menu"> <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Dashboard</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li> </ul>
        <div class="user-profile"> <div class="user-avatar" id="user-avatar">MS</div> <div class="user-info"> <div class="user-name" id="user-name">Načítání...</div> <div class="user-role" id="user-role">Student</div> </div> </div>
        <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main>
        <div class="dashboard-header">
             <div class="header-content">
                <h1>Personalizovaný studijní plán</h1>
                <button class="mobile-menu-toggle" id="mobileMenuToggle"> <i class="fas fa-bars"></i> </button>
            </div>
        </div>

        <div class="main-content">
            <div class="plan-tabs">
                 <div class="plan-tab active" data-tab="current">Aktuální plán</div>
                 <div class="plan-tab" data-tab="history">Historie plánů</div>
                 <div class="plan-tab" data-tab="create">Vytvořit nový</div>
            </div>

            <div class="section current-plan-section" id="currentPlanSection" style="display: none;">
                <div class="loader-container" id="currentPlanLoader" style="display: none;"> <div class="loader"></div> </div>
                <div id="currentPlanContent">
                    </div>
            </div>

            <div class="section history-plan-section" id="historyPlanSection" style="display: none;">
                 <h2 class="section-title">Historie studijních plánů</h2>
                 <div class="loader-container" id="historyLoader"> <div class="loader"></div> </div>
                 <div id="historyPlanContent" class="plan-history"></div>
            </div>

            <div class="section create-plan-section" id="createPlanSection" style="display: none;">
                 <div id="planCreateContent"></div>
            </div>

            <div class="section plan-section" id="planSection" style="display: none;">
                 <div class="step-navigation">
                     <button class="btn btn-secondary" id="genericBackBtn"> <i class="fas fa-arrow-left"></i> Zpět </button>
                 </div>
                <h2 class="section-title">Detail plánu / Návrh</h2>
                <div class="ai-loading" id="planLoading" style="display: none;"> <div class="ai-loading-spinner"></div> <div>Načítám/Generuji...</div> </div>
                <div class="plan-content" id="planContent" style="display: none;"></div>
                <div class="action-buttons" id="planActions" style="display: none;"></div>
            </div>

             <div class="section schedule-section" id="scheduleSection" style="display: none;">
                 <div class="calendar-scroll-container" id="calendarScrollContainer">
                      <div class="scroll-arrow left disabled" id="scrollLeftArrow"><i class="fas fa-chevron-left"></i></div>
                      <div class="scroll-arrow right disabled" id="scrollRightArrow"><i class="fas fa-chevron-right"></i></div>
                      <div class="daily-schedule" id="dailyScheduleContainer">
                          <div class="loader-container"><div class="loader"></div></div> </div>
                 </div>
                 <div class="step-navigation" style="margin-top: 1.5rem;">
                     <button class="btn btn-secondary" id="backToTabsBtn"> <i class="fas fa-arrow-left"></i> Zpět na záložky </button>
                 </div>
             </div>

            <template id="lockedPlanTemplate">
                 <div style="position: relative; min-height: 300px;"> <div class="locked-overlay"> <div class="locked-icon"> <i class="fas fa-lock"></i> </div> <h3 class="locked-title">Vytvoření nového plánu není dostupné</h3> <p class="locked-message">Nový studijní plán můžete vytvořit jednou týdně, abyste měli dostatek času pracovat na aktuálním. Váš poslední plán byl vytvořen nedávno.</p> <div class="timer-container" id="timerContainer"> Další plán můžete vytvořit za: <span id="nextPlanTimer">počítám...</span> </div> <button class="btn btn-primary" id="viewCurrentPlanBtnLocked"> <i class="fas fa-eye"></i> Zobrazit aktuální plán </button> </div> </div>
             </template>
             <template id="createPlanFormTemplate">
                 <h2 class="section-title">Vytvořit nový studijní plán</h2> <div id="diagnosticInfo"> </div> <p class="section-text">Personalizovaný studijní plán bude vytvořen na základě výsledků vašeho posledního diagnostického testu. Zaměří se na vaše slabší oblasti a pomůže vám efektivně se připravit.</p> <div class="action-buttons"> <button class="btn btn-primary btn-lg" id="generatePlanBtn"> <i class="fas fa-magic"></i> Vygenerovat studijní plán </button> </div>
              </template>
             <template id="noDiagnosticTemplate">
                  <div class="notest-message error"> <h3><i class="fas fa-exclamation-circle"></i> Nejprve absolvujte diagnostický test</h3>
                      <p>Pro vytvoření personalizovaného studijního plánu je nejprve potřeba dokončit diagnostický test na stránce Procvičování, který nám pomůže identifikovat vaše silné a slabé stránky.</p>
                      <button class="btn btn-primary" id="goToTestBtn"> <i class="fas fa-play"></i> Přejít k testu </button>
                  </div>
              </template>
            <template id="historyItemTemplate">
                 <div class="history-item" data-plan-id=""> <div class="history-info"> <div class="history-date">Vytvořeno: -</div> <div class="history-title">Studijní plán</div> </div> <div class="history-meta"> <span class="history-status active">Stav</span> </div> </div>
             </template>
            <template id="promptCreatePlanTemplate">
                 <div class="notest-message info">
                     <h3><i class="fas fa-clipboard-check"></i> Diagnostický test dokončen</h3>
                     <p>Váš poslední diagnostický test je připraven k analýze. Můžete nyní vygenerovat nový personalizovaný studijní plán.</p>
                     <button class="btn btn-primary" id="createNewPlanFromPromptBtn"><i class="fas fa-plus-circle"></i> Vytvořit studijní plán</button>
                </div>
             </template>
        </div>
    </main>

     <div class="toast" id="toast">
         <i class="fas fa-check-circle"></i>
         <div id="toast-message">Operace byla úspěšně dokončena.</div>
     </div>

    <script src="js/jquery-3.7.1.min.js" defer></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

    <script src="js/chart.js" defer></script>

    <script src="js/marked.min.js" defer></script>

    <script src="js/html2pdf.bundle.min.js" defer></script>

    <script src="js/tooltipster.bundle.min.js" defer></script>


    <script>
        // ==============================================
        //          Inicializace Supabase & Gemini
        // ==============================================
        const supabaseUrl = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
        let supabaseClient = null;
        const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // <--- ZDE VLOŽTE VÁŠ KLÍČ
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`; // Updated model

        // ==============================================
        //          DOM Elementy
        // ==============================================
        const currentPlanSection = document.getElementById('currentPlanSection');
        const historyPlanSection = document.getElementById('historyPlanSection');
        const createPlanSection = document.getElementById('createPlanSection');
        const planSection = document.getElementById('planSection'); // Detail/Návrh Markdown
        const scheduleSection = document.getElementById('scheduleSection'); // Kalendář
        const planLoading = document.getElementById('planLoading'); // Loader pro detail/návrh
        const planContent = document.getElementById('planContent'); // Obsah pro detail/návrh
        const dailyScheduleContainer = document.getElementById('dailyScheduleContainer'); // Kontejner pro mřížku kalendáře
        const calendarScrollContainer = document.getElementById('calendarScrollContainer');
        const scrollLeftArrow = document.getElementById('scrollLeftArrow');
        const scrollRightArrow = document.getElementById('scrollRightArrow');
        const planActions = document.getElementById('planActions'); // Tlačítka u detailu/návrhu
        const currentPlanLoader = document.getElementById('currentPlanLoader'); // Loader v záložce Aktuální
        const currentPlanContent = document.getElementById('currentPlanContent'); // Obsah v záložce Aktuální (výzva/chyba)
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const planCreateContent = document.getElementById('planCreateContent'); // Obsah v záložce Vytvořit
        const historyLoader = document.getElementById('historyLoader'); // Loader v záložce Historie
        const historyPlanContent = document.getElementById('historyPlanContent'); // Obsah v záložce Historie
        const planTabs = document.querySelectorAll('.plan-tab');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const backToTabsBtn = document.getElementById('backToTabsBtn'); // Tlačítko Zpět v kalendáři
        const genericBackBtn = document.getElementById('genericBackBtn'); // Tlačítko Zpět v detailu/návrhu

        // Vzory (Templates)
        const lockedPlanTemplate = document.getElementById('lockedPlanTemplate');
        const createPlanFormTemplate = document.getElementById('createPlanFormTemplate');
        const noDiagnosticTemplate = document.getElementById('noDiagnosticTemplate');
        const historyItemTemplate = document.getElementById('historyItemTemplate');
        const promptCreatePlanTemplate = document.getElementById('promptCreatePlanTemplate');

        // Globální proměnné
        let currentUser = null; let currentProfile = null; let latestDiagnosticData = undefined; /* Use undefined to differentiate from null (error) and false (not found) */ let currentStudyPlan = null; let previousPlans = []; let planCreateAllowed = false; let nextPlanCreateTime = null; let planTimerInterval = null; let currentTab = 'current';
        let lastGeneratedMarkdown = null;
        let lastGeneratedActivitiesJson = null;

        const topicIcons = { "Čísla a aritmetické operace": "fa-calculator", "Algebra": "fa-square-root-alt", "Geometrie": "fa-draw-polygon", "Práce s daty": "fa-chart-bar", "Problémové úlohy": "fa-lightbulb", "Proporce a procenta": "fa-percentage", "Logické úlohy": "fa-brain", "default": "fa-book" };
        const topicMap = { 1: "Čísla a aritmetické operace", 2: "Algebra", 3: "Geometrie", 4: "Práce s daty", 5: "Problémové úlohy", 6: "Proporce a procenta", 7: "Logické úlohy" };

        // ==============================================
        //          Pomocné Funkce
        // ==============================================
        function formatDate(dateString) { if(!dateString) return '-'; const date = new Date(dateString); return date.toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric' }); }
        function showLoader(sectionElement, loaderElement) { if(loaderElement) loaderElement.style.display = 'flex'; const contentElement = sectionElement.querySelector('#currentPlanContent, #historyPlanContent, #planCreateContent, #planContent, #dailyScheduleContainer'); if (contentElement) contentElement.style.display = 'none'; }
        function hideLoader(loaderElement) { if(loaderElement) loaderElement.style.display = 'none'; }
        function showGlobalError(message) { const errorContainer = document.getElementById('global-error'); if(errorContainer) { errorContainer.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><div>${message}</div></div>`; errorContainer.style.display = 'block';} else { console.error("Global error container not found!"); alert(message); } }
        function sanitizeHTML(str) { if (str === null || str === undefined) return ''; const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; }
        function getInitials(profileData) { if (!profileData) return 'U'; const first = profileData.first_name?.[0] || ''; const last = profileData.last_name?.[0] || ''; const usernameInitial = profileData.username?.[0] || ''; const emailInitial = profileData.email?.[0] || ''; return (first + last).toUpperCase() || usernameInitial.toUpperCase() || emailInitial.toUpperCase() || 'U'; }
        function toggleMobileMenu() { const sidebar = document.querySelector('.sidebar'); sidebar?.classList.toggle('active'); const overlay = document.querySelector('.sidebar-overlay'); overlay?.classList.toggle('active'); }
        function showToast(message, type = 'success', duration = 4000) { const toast = document.getElementById('toast'); const toastMessage = document.getElementById('toast-message'); if (!toast || !toastMessage) return; toastMessage.textContent = message; const icon = toast.querySelector('i'); icon.className = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-circle' : type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle'; toast.className = 'toast ' + type; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, duration); }
        function initTooltips() {
             try {
                 // Check if jQuery and Tooltipster are loaded
                 if (typeof window.$ !== 'undefined' && typeof window.$.fn.tooltipster === 'function') {
                     // Odstraníme existující instance před inicializací nových
                     window.$('.btn-tooltip.tooltipstered, .calendar-activity.tooltipstered').tooltipster('destroy');

                     window.$('.btn-tooltip, .calendar-activity').tooltipster({
                          theme: 'tooltipster-shadow', // Použijeme vestavěné téma nebo vlastní
                          trigger: 'hover', // Zobrazí se při najetí myší
                          animation: 'fade', // Animace zobrazení/skrytí
                          delay: 150, // Malé zpoždění před zobrazením
                          side: ['top', 'bottom'], // Preferované strany zobrazení
                          contentAsHTML: true, // Povolíme HTML v obsahu tooltipu
                          interactive: false, // Tooltip není interaktivní
                          // Získání obsahu pro tooltip
                          functionInit: function(instance, helper) {
                               let content = '';
                               const origin = $(helper.origin);
                               // Tooltip pro aktivity v kalendáři
                               if (origin.hasClass('calendar-activity')) {
                                    const descElement = origin.find('.activity-desc');
                                    const rawDesc = descElement.length > 0 ? descElement.html() : ''; // Získáme HTML popis
                                    if (rawDesc.trim() !== '') {
                                         // Obalíme popis divem pro styling a omezení šířky
                                         content = `<div class="tooltip-activity-content">${rawDesc}</div>`;
                                    } else {
                                         instance.destroy(); // Pokud není popis, zničíme tooltip
                                         return; // Ukončíme funkci
                                    }
                               // Tooltip pro běžná tlačítka (z atributu title)
                               } else if (origin.is('[title]') && origin.attr('title').trim() !== '') {
                                    content = origin.attr('title');
                               } else {
                                   instance.destroy(); // Zničíme tooltip, pokud není obsah
                                   return;
                               }
                               instance.content(content); // Nastavíme obsah tooltipu
                          },
                          // Po připravení tooltipu můžeme přidat vlastní třídu
                          functionReady: function(instance, helper) {
                              if ($(helper.origin).hasClass('calendar-activity')) {
                                   instance.tooltip().addClass('tooltipster-activity-desc'); // Přidáme třídu pro specifické styly
                              }
                          }
                      });
                     // console.log("Tooltips initialized/updated.");
                 } else {
                     // Log warning only if Tooltipster related elements exist, but library failed to load
                     if (document.querySelector('.btn-tooltip, .calendar-activity')) {
                          console.warn("Tooltipster or jQuery not available or failed to load. Tooltips will not work.");
                     }
                 }
             } catch (e) { console.error("Error initializing Tooltipster:", e); }
         }
        window.addEventListener('resize', () => { if (window.innerWidth > 992) { document.querySelector('.sidebar')?.classList.remove('active'); document.querySelector('.sidebar-overlay')?.classList.remove('active'); } updateScrollArrows(); });

        // ==============================================
        //          Inicializace a Navigace
        // ==============================================
        async function initializeApp() {
            try {
                // Check if Supabase is loaded
                if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
                     const { createClient } = supabase;
                     supabaseClient = createClient(supabaseUrl, supabaseKey);
                     console.log("Supabase client initialized.");
                } else {
                    // Supabase failed to load - crucial dependency
                     throw new Error("Supabase library failed to load. Cannot initialize application.");
                }

                // Check if Marked is loaded (needed for rendering)
                if (typeof marked === 'undefined') {
                    console.warn("Marked.js library failed to load. Markdown rendering will not work.");
                    // We might allow the app to continue but markdown won't render
                }
                // Check if html2pdf is loaded (needed for export)
                if (typeof html2pdf === 'undefined') {
                     console.warn("html2pdf.js library failed to load. PDF export will not work.");
                     // App can continue, export button just won't work
                }


                // Initially hide all content sections
                currentPlanSection.style.display = 'none';
                historyPlanSection.style.display = 'none';
                createPlanSection.style.display = 'none';
                planSection.style.display = 'none';
                scheduleSection.style.display = 'none';

                currentUser = await getCurrentSupabaseUser();
                if (!currentUser) {
                    console.warn("Uživatel není přihlášen. Používám placeholder.");
                    currentUser = { id: 'PLACEHOLDER_USER_ID', email: 'student@example.com' };
                    currentProfile = { username: 'Testovací Student', email: 'student@example.com', points: 0 };
                } else { currentProfile = await fetchUserProfile(currentUser.id); }

                updateUserInfoUI(currentProfile, currentUser.email);
                setupEventListeners();
                await switchTab('current'); // Start with the current plan tab
                updateScrollArrows(); // Initial check for arrows

            } catch (error) {
                console.error('Chyba při inicializaci aplikace:', error);
                // Display critical error prominently
                const mainContentArea = document.querySelector('.main-content');
                if(mainContentArea) {
                    // Clear tabs and show error
                    const tabs = document.querySelector('.plan-tabs');
                    if(tabs) tabs.style.display = 'none';
                    mainContentArea.innerHTML = `<div class="section"><div class="notest-message error"><h3>Kritická chyba inicializace</h3><p>Aplikaci se nepodařilo spustit. Zkontrolujte konzoli pro detaily.</p><p><i>${sanitizeHTML(error.message)}</i></p><button onclick="location.reload()" class="btn btn-primary" style="margin-top: 1rem;">Zkusit znovu</button></div></div>`;
                } else {
                     // Fallback if main content area isn't found
                     alert(`Kritická chyba inicializace: ${error.message}`);
                }
            }
        }
        async function getCurrentSupabaseUser() { if (!supabaseClient) throw new Error("Supabase client není inicializován"); const { data: { user }, error } = await supabaseClient.auth.getUser(); if (error) { console.error("Chyba získání uživatele:", error); throw new Error("Nepodařilo se získat informace o uživateli."); } return user; }
        async function fetchUserProfile(userId) { if (!userId || !supabaseClient) return null; try { const { data: profile, error } = await supabaseClient.from('profiles').select('*').eq('id', userId).single(); if (error && error.code !== 'PGRST116') { throw error; } return profile; } catch (error) { console.error("Chyba načtení profilu:", error); return null; } }
        function updateUserInfoUI(profileData, userEmail) { const displayName = `${profileData?.first_name || ''} ${profileData?.last_name || ''}`.trim() || profileData?.username || userEmail?.split('@')[0] || 'Student'; if(userName) userName.textContent = displayName; if(userAvatar) { if (profileData?.avatar_url) { userAvatar.innerHTML = `<img src="${profileData.avatar_url}" alt="Avatar">`; } else { const initials = getInitials(profileData || { email: userEmail }); userAvatar.textContent = initials; } } }
        async function checkExistingDiagnostic(userId) { if (!userId || userId === 'PLACEHOLDER_USER_ID' || !supabaseClient) { console.warn("Kontrola testu přeskočena"); return null; } try { const { data: existingDiagnostic, error } = await supabaseClient.from('user_diagnostics').select('id, completed_at, analysis, topic_results').eq('user_id', userId).order('completed_at', { ascending: false }).limit(1); if (error) { console.error("Chyba při kontrole existujícího testu:", error); return null; } return (existingDiagnostic && existingDiagnostic.length > 0) ? existingDiagnostic[0] : false; } catch(err) { console.error("Neočekávaná chyba při kontrole testu:", err); return null; } }

        function setupEventListeners() {
            if (mobileMenuToggle) mobileMenuToggle.addEventListener('click', toggleMobileMenu);
            planTabs.forEach(tab => { tab.addEventListener('click', () => switchTab(tab.dataset.tab)); });
            if (genericBackBtn) { genericBackBtn.addEventListener('click', () => { switchTab(currentTab || 'current'); }); }
            if (backToTabsBtn) { backToTabsBtn.addEventListener('click', () => { switchTab('current'); }); } // Back from calendar goes to 'current' tab logic

             // Scroll arrows listeners
             if (scrollLeftArrow && calendarScrollContainer) { scrollLeftArrow.addEventListener('click', () => { calendarScrollContainer.scrollBy({ left: -250, behavior: 'smooth' }); }); }
             if (scrollRightArrow && calendarScrollContainer) { scrollRightArrow.addEventListener('click', () => { calendarScrollContainer.scrollBy({ left: 250, behavior: 'smooth' }); }); }
             if (calendarScrollContainer) { calendarScrollContainer.addEventListener('scroll', updateScrollArrows); }

             // Delegated listener for checkbox in calendar
             const scheduleSectionElement = document.getElementById('scheduleSection');
             if (scheduleSectionElement) {
                 scheduleSectionElement.addEventListener('change', (event) => {
                     if (event.target.matches('.calendar-activity .activity-checkbox input[type="checkbox"]')) {
                          const checkbox = event.target;
                          handleActivityCompletionToggle(checkbox.dataset.activityId, checkbox.checked, checkbox.dataset.planId);
                     }
                 });
             }
              // Delegated listener for prompt/no-diagnostic buttons IF they are rendered dynamically
             document.body.addEventListener('click', (event) => {
                 if (event.target.matches('#createNewPlanFromPromptBtn')) {
                     switchTab('create');
                 } else if (event.target.matches('#goToTestBtn')) {
                     window.location.href = 'test1.html'; // Assuming test1.html is the diagnostic test page
                 } else if (event.target.matches('#viewCurrentPlanBtnLocked')) {
                     switchTab('current');
                 }
             });
        }

        async function switchTab(tabId) {
             if (!supabaseClient) { showGlobalError("Aplikace není správně inicializována (chybí Supabase)."); return; }
             const targetTabId = tabId;
             planTabs.forEach(tab => { tab.classList.toggle('active', tab.dataset.tab === targetTabId); });

             // Hide all sections initially
             currentPlanSection.style.display = 'none';
             historyPlanSection.style.display = 'none';
             createPlanSection.style.display = 'none';
             planSection.style.display = 'none';
             scheduleSection.style.display = 'none';
             // Hide loaders as well
             hideLoader(currentPlanLoader);
             hideLoader(historyLoader);
             hideLoader(planLoading);

             try {
                 if (targetTabId === 'current') {
                     // Don't show currentPlanSection yet, let loadCurrentPlan handle its visibility and loader
                     await loadCurrentPlan();
                 } else if (targetTabId === 'history') {
                     historyPlanSection.style.display = 'block'; // Show history section container
                     await loadPlanHistory(); // This function handles its own loader
                 } else if (targetTabId === 'create') {
                     createPlanSection.style.display = 'block'; // Show create section container
                     await checkPlanCreationAvailability(); // This function handles content/loader within
                 }
                  currentTab = targetTabId; // Store the current tab
                  updateScrollArrows(); // Check arrows visibility
             } catch (error) {
                 console.error(`Chyba při přepínání na záložku ${targetTabId}:`, error);
                 // Display error in the relevant section if possible
                 const errorSection = document.getElementById(`${targetTabId}PlanSection`) || currentPlanSection; // Fallback to current
                 errorSection.style.display = 'block';
                 const errorContent = errorSection.querySelector('#currentPlanContent, #historyPlanContent, #planCreateContent');
                 if(errorContent) {
                     errorContent.innerHTML = `<div class="notest-message error"><h3>Chyba</h3><p>Nepodařilo se načíst obsah záložky.</p><p><i>${sanitizeHTML(error.message)}</i></p></div>`;
                     errorContent.style.display = 'block';
                 }
                 hideLoader(currentPlanLoader); hideLoader(historyLoader); // Ensure loaders are hidden on error
            }
        }

        // ==============================================
        //          Aktuální Plán (REVISED Logic)
        // ==============================================
        async function loadCurrentPlan() {
            console.log("loadCurrentPlan: Starting...");
            // Section visibility is handled by switchTab initially hiding all,
            // and this function deciding whether to show currentPlanSection (for message/error)
            // or call showFullSchedule (which shows scheduleSection)
            currentPlanSection.style.display = 'block'; // Assume we'll show this section initially for loader/message
            showLoader(currentPlanSection, currentPlanLoader); // Show loader IN the currentPlanSection
            currentPlanContent.innerHTML = ''; // Clear previous message/prompt
            scheduleSection.style.display = 'none';    // Ensure schedule is hidden
            planSection.style.display = 'none';        // Ensure generic plan view is hidden

            try {
                if (!supabaseClient) throw new Error("Supabase client není inicializován.");
                if (!currentUser) throw new Error('Uživatel není přihlášen');

                console.log("loadCurrentPlan: Querying active plan...");
                const { data: plans, error } = await supabaseClient
                    .from('study_plans')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('status', 'active')
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (plans && plans.length > 0) {
                    console.log("loadCurrentPlan: Active plan found.");
                    currentStudyPlan = plans[0];
                    await showFullSchedule(currentStudyPlan); // This hides currentPlanSection and shows scheduleSection
                } else {
                    console.log("loadCurrentPlan: No active plan found. Checking diagnostics...");
                    currentStudyPlan = null;
                     // Use globally stored data if available, otherwise fetch
                     if (latestDiagnosticData === undefined) {
                          latestDiagnosticData = await getLatestDiagnostic();
                     }
                    console.log("loadCurrentPlan: Diagnostic check result:", latestDiagnosticData);

                    // Keep currentPlanSection visible to display the message/prompt
                    if (latestDiagnosticData) { // Diagnostic found (truthy: not null, not false)
                        console.log("loadCurrentPlan: Diagnostic found. Rendering prompt.");
                        renderPromptCreatePlan(); // Renders into currentPlanContent
                    } else if (latestDiagnosticData === null) { // Error fetching diagnostic
                         console.error("loadCurrentPlan: Error fetching diagnostic. Rendering error message.");
                          currentPlanContent.innerHTML = `<div class="notest-message error"><h3><i class="fas fa-exclamation-circle"></i> Chyba</h3><p>Nepodařilo se ověřit stav diagnostického testu.</p></div>`;
                          currentPlanContent.style.display = 'block';
                    }
                     else { // No diagnostic (false)
                         console.log("loadCurrentPlan: No diagnostic found. Rendering no diagnostic message.");
                         renderNoDiagnosticAvailable(currentPlanContent); // Renders into currentPlanContent
                    }
                    // Ensure the content area inside the section is visible if we are showing a message/prompt
                    if (currentPlanContent.innerHTML !== '') {
                         currentPlanContent.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Chyba při načítání aktuálního plánu:', error);
                // Display error within the currentPlanSection
                currentPlanContent.innerHTML = `<div class="notest-message error"><h3><i class="fas fa-exclamation-circle"></i> Chyba</h3><p>Nepodařilo se načíst aktuální plán.</p><p><i>${sanitizeHTML(error.message)}</i></p></div>`;
                currentPlanContent.style.display = 'block';
                // currentPlanSection remains visible because we set it at the start of the function
            } finally {
                console.log("loadCurrentPlan: Finally - hiding loader.");
                hideLoader(currentPlanLoader); // Hide loader unconditionally
                initTooltips();
                updateScrollArrows(); // Update arrows visibility based on final state
            }
        }

        async function handleActivityCompletionToggle(activityId, isCompleted, planId) {
            if (!activityId || !planId) return;
             console.log(`Toggling activity ${activityId} to ${isCompleted} for plan ${planId}`);
             try {
                 const { error } = await supabaseClient
                     .from('plan_activities')
                     .update({ completed: isCompleted, updated_at: new Date().toISOString() })
                     .eq('id', activityId);
                 if (error) throw error;
                 showToast(`Aktivita byla označena jako ${isCompleted ? 'dokončená' : 'nedokončená'}.`, 'success', 2000);
                 updatePlanProgress(planId); // Recalculate progress after update
             } catch (error) {
                 console.error("Chyba při aktualizaci stavu aktivity:", error);
                 showToast('Chyba: Nepodařilo se aktualizovat aktivitu.', 'error');
                 // Revert checkbox state visually on error
                 const checkbox = document.getElementById(`schedule-activity-${activityId}`);
                 if (checkbox) checkbox.checked = !isCompleted;
             }
        }
        async function updatePlanProgress(planId) {
             if (!currentUser || !planId) return;
             try {
                 // Fetch all activities for the plan
                 const { data: activities, error: activitiesError } = await supabaseClient
                     .from('plan_activities')
                     .select('id, completed') // Select only needed fields
                     .eq('plan_id', planId);

                 if (activitiesError) throw activitiesError;
                 if (!activities || activities.length === 0) return 0; // No progress if no activities

                 const completedCount = activities.filter(a => a.completed).length;
                 const progress = Math.round((completedCount / activities.length) * 100);

                 // Update the progress in the study_plans table
                 const { error: updateError } = await supabaseClient
                     .from('study_plans')
                     .update({
                         progress: progress,
                         updated_at: new Date().toISOString()
                     })
                     .eq('id', planId);

                 if (updateError) throw updateError;

                 console.log(`Pokrok plánu ${planId} aktualizován na ${progress}%`);
                 // Optional: Update UI immediately if progress bar is visible
                 // const progressBarEl = document.querySelector(`[data-plan-id="${planId}"] .progress-bar`); // Example selector
                 // if (progressBarEl) progressBarEl.style.width = `${progress}%`;

                 return progress; // Return calculated progress
             } catch (error) {
                 console.error('Chyba při aktualizaci pokroku plánu:', error);
                 return -1; // Indicate error
             }
        }

        // Zobrazí detail HISTORICKÉHO plánu (Markdown)
        async function showPlanDetail(plan) {
             if (!plan || !plan.id) { showGlobalError("Chybí informace o plánu pro zobrazení detailu."); return; }
             currentPlanSection.style.display = 'none'; historyPlanSection.style.display = 'none'; createPlanSection.style.display = 'none'; scheduleSection.style.display = 'none';
             planSection.style.display = 'block'; // Show the generic plan detail section
             planContent.style.display = 'none'; planActions.style.display = 'none'; showLoader(planSection, planLoading);

             try {
                  // Fetch full markdown content if not already loaded (e.g., from history list)
                  let markdown = plan.plan_content_markdown;
                  if (!markdown) {
                       console.log(`Načítám plný markdown pro historický plán ID: ${plan.id}`);
                       const { data: fullPlan, error } = await supabaseClient
                           .from('study_plans')
                           .select('plan_content_markdown')
                           .eq('id', plan.id)
                           .single();
                       if (error) throw error;
                       markdown = fullPlan?.plan_content_markdown;
                  }

                  if (markdown) {
                      displayPlanContent(markdown); // Renders markdown into planContent
                      planContent.style.display = 'block';
                      planActions.innerHTML = `
                          <button class="btn btn-primary btn-tooltip" id="exportHistoryPlanBtn" title="Stáhnout plán jako PDF">
                               <i class="fas fa-file-export"></i> Exportovat PDF
                          </button>
                          <button class="btn btn-secondary btn-tooltip" id="backToHistoryBtn" title="Zpět na seznam historie">
                              <i class="fas fa-list"></i> Zpět do historie
                          </button>`;
                      planActions.style.display = 'flex';

                      document.getElementById('exportHistoryPlanBtn')?.addEventListener('click', () => {
                          // Pass the potentially updated plan object with markdown
                          exportPlanToPDFWithStyle({ ...plan, plan_content_markdown: markdown });
                      });
                      document.getElementById('backToHistoryBtn')?.addEventListener('click', () => switchTab('history'));
                      initTooltips(); // Init tooltips for the new buttons
                  } else {
                      planContent.innerHTML = `<p>Obsah tohoto plánu není k dispozici.</p>`;
                      planContent.style.display = 'block';
                      planActions.innerHTML = `<button class="btn btn-secondary" id="backToHistoryBtnEmpty"><i class="fas fa-list"></i> Zpět do historie</button>`;
                      planActions.style.display = 'flex';
                      document.getElementById('backToHistoryBtnEmpty')?.addEventListener('click', () => switchTab('history'));
                  }
             } catch(error) {
                  console.error("Chyba při zobrazování detailu historického plánu:", error);
                  planContent.innerHTML = `<div class="notest-message error"><h3>Chyba</h3><p>Nepodařilo se načíst detail plánu.</p></div>`;
                  planContent.style.display = 'block';
                  planActions.innerHTML = `<button class="btn btn-secondary" id="backToHistoryBtnError"><i class="fas fa-list"></i> Zpět do historie</button>`;
                  planActions.style.display = 'flex';
                  document.getElementById('backToHistoryBtnError')?.addEventListener('click', () => switchTab('history'));
             } finally {
                  hideLoader(planLoading);
             }
        }

        // Zobrazí AKTIVNÍ detailní týdenní harmonogram (kalendář)
        async function showFullSchedule(plan) {
            if (!supabaseClient || !plan || !plan.id) { showGlobalError("Nelze zobrazit harmonogram: chybí data plánu."); return; }
            console.log(`showFullSchedule: Zobrazuji harmonogram pro Plan ID: ${plan.id}`);

            // Hide other sections, show schedule section
            currentPlanSection.style.display = 'none';
            historyPlanSection.style.display = 'none';
            createPlanSection.style.display = 'none';
            planSection.style.display = 'none';
            scheduleSection.style.display = 'block'; // Show the schedule section

            // Remove previous dynamic header if exists
            const oldHeader = scheduleSection.querySelector('.plan-header-dynamic');
            if (oldHeader) oldHeader.remove();

            // Clear and show loader for calendar grid
            dailyScheduleContainer.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';

             // Create and insert dynamic header for the schedule
             const headerDiv = document.createElement('div');
             headerDiv.className = 'plan-header plan-header-dynamic'; // Add class for potential removal
             headerDiv.style.marginBottom = '1.5rem'; // Space between header and calendar
             headerDiv.innerHTML = `
                 <div class="plan-meta">
                     <h2 class="section-title" style="margin-bottom: 0.5rem;">${sanitizeHTML(plan.title || 'Týdenní harmonogram')}</h2>
                     <span class="plan-date">Vytvořeno: ${formatDate(plan.created_at)}</span>
                     ${plan.estimated_completion_date ? `<br><span class="plan-date">Odhad. dokončení: ${formatDate(plan.estimated_completion_date)}</span>` : ''}
                 </div>
                 <div class="plan-actions">
                      <button class="btn btn-primary btn-tooltip" id="exportSchedulePlanBtnDynamic" title="Stáhnout plán jako PDF">
                          <i class="fas fa-file-export"></i> Export
                      </button>
                 </div>
             `;
             // Insert the header *before* the calendar container
             scheduleSection.insertBefore(headerDiv, calendarScrollContainer);

             // Add listener for the newly created export button
             const exportButton = headerDiv.querySelector('#exportSchedulePlanBtnDynamic');
             if (exportButton) {
                  exportButton.addEventListener('click', async () => {
                      // Ensure markdown is loaded before exporting
                       let planToExport = { ...plan }; // Create a copy
                       if (!planToExport.plan_content_markdown) {
                           try {
                               console.log("Načítám plný markdown pro export aktivního plánu...");
                               const { data: fullPlanData, error } = await supabaseClient
                                   .from('study_plans')
                                   .select('plan_content_markdown') // Only fetch markdown
                                   .eq('id', planToExport.id)
                                   .single();
                               if (error) throw error;
                               planToExport.plan_content_markdown = fullPlanData?.plan_content_markdown;
                           } catch (fetchError) {
                               console.error("Nepodařilo se načíst markdown pro export:", fetchError);
                               showToast('Chyba: Nepodařilo se načíst data pro export.', 'error');
                               return; // Stop export if data fetch fails
                           }
                       }
                       exportPlanToPDFWithStyle(planToExport); // Export with potentially loaded markdown
                  });
                  initTooltips(); // Initialize tooltip for the export button
             }

             // Check if the back button exists
             if (!backToTabsBtn) { console.warn("Tlačítko #backToTabsBtn nebylo nalezeno."); }

             // Load and render activities
             try {
                 console.log(`showFullSchedule: Dotazuji se na aktivity s plan_id = ${plan.id}`);
                 const { data: activities, error } = await supabaseClient
                     .from('plan_activities')
                     .select('*')
                     .eq('plan_id', plan.id)
                     .order('day_of_week') // Order by day
                     .order('time_slot'); // Then by time within the day

                 if (error) { throw new Error(`Nepodařilo se načíst aktivity: ${error.message}. Zkontrolujte také RLS.`); }
                 console.log(`showFullSchedule: Aktivity získané:`, activities);

                 renderWeeklySchedule(activities || [], plan.id); // Render calendar grid
                 updateScrollArrows(); // Update scroll arrows after rendering

             } catch (error) {
                  console.error("showFullSchedule: Chyba při načítání/zobrazování aktivit:", error);
                  dailyScheduleContainer.innerHTML = `<div class="notest-message error" style="margin: 1rem;"><h3>Chyba</h3><p>Nepodařilo se načíst aktivity pro tento plán.</p><p><i>${sanitizeHTML(error.message)}</i></p></div>`;
             }
             // Loader is implicitly removed by renderWeeklySchedule or error message
        }

        function renderWeeklySchedule(activities, planId) {
            const days = ['Neděle', 'Pondělí', 'Úterý', 'Středa', 'Čtvrtek', 'Pátek', 'Sobota'];
            const todayIndex = new Date().getDay(); // 0 = Neděle, 1 = Pondělí, ...

            if (!dailyScheduleContainer) { console.error("Kontejner #dailyScheduleContainer nenalezen!"); return; }
            dailyScheduleContainer.innerHTML = ''; // Clear previous content/loader

            const gridContainer = document.createElement('div');
            gridContainer.className = 'calendar-grid';

            if (!activities) activities = [];
            if (!Array.isArray(activities)) { console.error("Data aktivit nejsou pole!", activities); activities = []; }

            // Generate grid cells for Monday to Sunday (index 1 to 0)
            for (let i = 0; i < 7; i++) {
                const dayIndex = (i + 1) % 7; // 1 (Po) -> 2 (Út) -> ... -> 6 (So) -> 0 (Ne)
                const dayName = days[dayIndex];
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day-cell';
                if (dayIndex === todayIndex) dayCell.classList.add('today'); // Highlight today

                // Day Header
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = dayName;
                dayCell.appendChild(dayHeader);

                // Activities container for the day
                const activitiesContainer = document.createElement('div');
                activitiesContainer.className = 'calendar-activities';

                // Filter and sort activities for the current day
                const dayActivities = activities
                    .filter(a => Number(a.day_of_week) === dayIndex)
                    .sort((a, b) => (a.time_slot || '99:99').localeCompare(b.time_slot || '99:99')); // Sort by time (handle nulls)

                if (dayActivities.length > 0) {
                    dayActivities.forEach(activity => {
                        if (!activity.id) { console.error("Chyba: Aktivita nemá ID!", activity); return; } // Skip if no ID

                        const activityElement = document.createElement('div');
                        activityElement.className = 'calendar-activity';

                        // Store description in data attribute ONLY if it exists
                        const descriptionContent = sanitizeHTML(activity.description || '');
                         if (descriptionContent.trim() !== '') {
                             activityElement.setAttribute('title', descriptionContent); // Use title for Tooltipster default
                         }


                        const timeDisplay = activity.time_slot ? `<span class="activity-time-display">${activity.time_slot}</span>` : '';
                        activityElement.innerHTML = `
                            <div class="activity-checkbox">
                                <input type="checkbox" id="schedule-activity-${activity.id}" ${activity.completed ? 'checked' : ''} data-activity-id="${activity.id}" data-plan-id="${planId}">
                                <div class="activity-content">
                                    <div class="activity-title">
                                        ${timeDisplay}
                                        ${sanitizeHTML(activity.title || 'Nespecifikovaná aktivita')}
                                    </div>
                                    <div class="activity-desc" style="display:none;">${descriptionContent}</div>
                                </div>
                            </div>`;
                        // Checkbox listener is delegated in setupEventListeners
                        activitiesContainer.appendChild(activityElement);
                    });
                } else {
                    // Display message if no activities for the day
                    activitiesContainer.innerHTML = '<p style="font-size: 0.8em; text-align: center; color: var(--text-muted); margin-top: 1rem; padding: 0 0.5rem;">Žádné aktivity</p>';
                }
                dayCell.appendChild(activitiesContainer);
                gridContainer.appendChild(dayCell);
            }
            dailyScheduleContainer.appendChild(gridContainer); // Append the full grid
            initTooltips(); // Re-initialize tooltips for potentially new activity elements
            console.log("Kalendářový harmonogram úspěšně vyrenderován.");
        }

        function renderPromptCreatePlan() {
             const promptFragment = promptCreatePlanTemplate.content.cloneNode(true);
             // Button listener is now handled by delegation in setupEventListeners
             currentPlanContent.innerHTML = ''; // Clear previous content
             currentPlanContent.appendChild(promptFragment);
             currentPlanContent.style.display = 'block'; // Ensure content is visible
             // Section (currentPlanSection) visibility is handled by loadCurrentPlan
        }

        function renderNoDiagnosticAvailable(container) {
             const noDiagnosticFragment = noDiagnosticTemplate.content.cloneNode(true);
             // Button listener is now handled by delegation in setupEventListeners
             container.innerHTML = ''; // Clear previous content
             container.appendChild(noDiagnosticFragment);
             container.style.display = 'block'; // Ensure content is visible
        }


        // ==============================================
        //          Historie Plánů
        // ==============================================
        async function loadPlanHistory() {
            if (!supabaseClient) { console.error("Nelze načíst historii: Supabase není inicializován."); return; }
            showLoader(historyPlanSection, historyLoader); // Show loader in the history section
            historyPlanContent.innerHTML = ''; // Clear previous history list

            try {
                if (!currentUser) throw new Error('Uživatel není přihlášen');
                const { data: plans, error } = await supabaseClient
                    .from('study_plans')
                    .select('id, title, created_at, status, progress') // Select needed fields
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false }); // Newest first

                if (error) throw error;

                previousPlans = plans || [];
                renderPlanHistory(previousPlans); // Render the list
            } catch (error) {
                console.error('Chyba při načítání historie plánů:', error);
                historyPlanContent.innerHTML = `<div class="notest-message error"><h3>Chyba</h3><p>Nepodařilo se načíst historii plánů.</p><p><i>${sanitizeHTML(error.message)}</i></p></div>`;
            } finally {
                hideLoader(historyLoader); // Hide loader
                historyPlanContent.style.display = 'block'; // Ensure content area is visible
            }
        }
        function renderPlanHistory(plans) {
            historyPlanContent.innerHTML = ''; // Clear just in case
            if (!plans || plans.length === 0) {
                historyPlanContent.innerHTML = `<div class="notest-message info"><h3>Žádná historie</h3><p>Zatím jste nevytvořili žádné studijní plány.</p></div>`;
                return;
            }
            plans.forEach(plan => {
                const historyFragment = historyItemTemplate.content.cloneNode(true);
                const historyItem = historyFragment.querySelector('.history-item');
                historyItem.dataset.planId = plan.id; // Store ID for click handling

                historyFragment.querySelector('.history-date').textContent = `Vytvořeno: ${formatDate(plan.created_at)}`;
                historyFragment.querySelector('.history-title').textContent = plan.title || "Studijní plán";

                const statusElement = historyFragment.querySelector('.history-status');
                let statusText = 'Neaktivní'; let statusClass = 'inactive';
                if (plan.status === 'active') { statusText = 'Aktivní'; statusClass = 'active'; }
                else if (plan.status === 'completed') { statusText = 'Dokončený'; statusClass = 'completed'; }

                statusElement.textContent = statusText;
                statusElement.className = `history-status ${statusClass}`; // Apply class for styling

                // Add event listener to show detail when item is clicked
                historyItem.addEventListener('click', () => showPlanDetail(plan));

                historyPlanContent.appendChild(historyFragment);
            });
        }

        // ==============================================
        //          Vytvoření Nového Plánu
        // ==============================================
         async function getLatestDiagnostic() {
            if (!currentUser || currentUser.id === 'PLACEHOLDER_USER_ID' || !supabaseClient) { console.warn("Přeskakuji hledání diagnostiky."); return false; }
            try {
                const { data, error } = await supabaseClient
                    .from('user_diagnostics')
                    .select('id, completed_at, analysis, topic_results') // Select relevant data
                    .eq('user_id', currentUser.id)
                    .order('completed_at', { ascending: false })
                    .limit(1);
                if (error) { console.error("Chyba při hledání diagnostiky:", error); return null; } // Return null on error
                return (data && data.length > 0) ? data[0] : false; // Return data or false if none found
            } catch (err) { console.error("Neočekávaná chyba při hledání diagnostiky:", err); return null; }
         }
         async function checkPlanCreationAvailability() {
            if (!currentUser || currentUser.id === 'PLACEHOLDER_USER_ID' || !supabaseClient) {
                 planCreateContent.innerHTML = `<p>Pro vytvoření plánu se prosím přihlaste.</p>`; return;
            }
            showLoader(createPlanSection, null); // Show generic loading state maybe?
            planCreateContent.innerHTML = '<div class="loader-container"><div class="loader"></div></div>'; // Loader inside the content area
            planCreateContent.style.display = 'block';

            try {
                // 1. Check last plan creation time
                const { data: lastPlan, error: lastPlanError } = await supabaseClient
                    .from('study_plans')
                    .select('created_at')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (lastPlanError) throw new Error(`Chyba při kontrole posledního plánu: ${lastPlanError.message}`);

                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                planCreateAllowed = true; // Assume allowed unless proven otherwise
                nextPlanCreateTime = null;

                if (lastPlan && lastPlan.length > 0) {
                    const lastPlanDate = new Date(lastPlan[0].created_at);
                    if (lastPlanDate > sevenDaysAgo) {
                        planCreateAllowed = false;
                        nextPlanCreateTime = new Date(lastPlanDate.getTime() + 7 * 24 * 60 * 60 * 1000);
                    }
                }

                // 2. Render based on availability
                if (!planCreateAllowed && nextPlanCreateTime) {
                    renderLockedPlanSection();
                } else {
                     // 3. Check for diagnostic test (use globally stored data if available)
                     if (latestDiagnosticData === undefined) { // If not checked before (e.g., direct navigation)
                          latestDiagnosticData = await getLatestDiagnostic();
                     }

                    if (latestDiagnosticData) { // Diagnostic exists
                        renderPlanCreationForm();
                    } else if (latestDiagnosticData === null){ // Error fetching diagnostic
                        planCreateContent.innerHTML = `<div class="notest-message error"><h3>Chyba</h3><p>Nepodařilo se ověřit stav diagnostického testu.</p></div>`;
                    }
                     else { // false - no diagnostic found
                        renderNoDiagnosticAvailable(planCreateContent); // Render "go to test" message
                    }
                }
            } catch (error) {
                console.error("Chyba při kontrole dostupnosti vytvoření plánu:", error);
                planCreateContent.innerHTML = `<div class="notest-message error"><h3>Chyba</h3><p>Nepodařilo se zkontrolovat dostupnost vytvoření plánu.</p><p><i>${sanitizeHTML(error.message)}</i></p></div>`;
            } finally {
                 // Loader is replaced by content or error message
            }
         }
         function renderNoDiagnosticAvailable(container) {
            const template = noDiagnosticTemplate.content.cloneNode(true);
            // Listener for the button inside is handled by delegation
            container.innerHTML = '';
            container.appendChild(template);
            container.style.display = 'block'; // Ensure visibility
         }
         function renderLockedPlanSection() {
            const template = lockedPlanTemplate.content.cloneNode(true);
            // Listener for the button inside is handled by delegation
            planCreateContent.innerHTML = '';
            planCreateContent.appendChild(template);
            startPlanTimer();
            planCreateContent.style.display = 'block'; // Ensure visibility
         }
         function startPlanTimer() {
            if (planTimerInterval) clearInterval(planTimerInterval);
            const timerElement = document.getElementById('nextPlanTimer');
            if (!timerElement || !nextPlanCreateTime) return;

            function update() {
                const now = new Date().getTime();
                const distance = nextPlanCreateTime.getTime() - now;
                if (distance <= 0) {
                    clearInterval(planTimerInterval);
                    checkPlanCreationAvailability(); // Re-check availability
                    return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                timerElement.textContent = `${days}${getDeclension(days,' den',' dny',' dní')}, ${hours}${getDeclension(hours,' hodina',' hodiny',' hodin')}, ${minutes}${getDeclension(minutes,' minuta',' minuty',' minut')} a ${seconds}${getDeclension(seconds,' sekunda',' sekundy',' sekund')}`;
            }
            update(); // Initial call
            planTimerInterval = setInterval(update, 1000);
         }
         function updateNextPlanTimer(timerElement) { /* Combined into startPlanTimer */ }
         function getDeclension(number, singular, plural1, plural2) { number=Math.abs(number); if (number === 1) return singular; if (number >= 2 && number <= 4) return plural1; return plural2; }
         function renderPlanCreationForm() {
             const template = createPlanFormTemplate.content.cloneNode(true);
             const diagnosticInfo = template.getElementById('diagnosticInfo');
             const generateBtn = template.getElementById('generatePlanBtn');

             if (diagnosticInfo && latestDiagnosticData) {
                 diagnosticInfo.innerHTML = `<p class="text-muted" style="margin-bottom: 1rem;">Plán bude vycházet z diagnostiky dokončené ${formatDate(latestDiagnosticData.completed_at)}.</p>`;
             }
             if (generateBtn) {
                 generateBtn.addEventListener('click', generateStudyPlan);
             }
             planCreateContent.innerHTML = '';
             planCreateContent.appendChild(template);
             planCreateContent.style.display = 'block'; // Ensure visibility
         }

        // ==============================================
        //          Generování a Ukládání Plánu
        // ==============================================
        async function generateStudyPlan() {
            if (!latestDiagnosticData || !latestDiagnosticData.topic_results) { showToast('Chyba: Chybí data z diagnostického testu.', 'error'); return; }
             if (!currentUser) { showToast('Chyba: Nejste přihlášen/a.', 'error'); return; }

             createPlanSection.style.display = 'none'; // Hide the creation form section
             planSection.style.display = 'block'; // Show the detail/loading section
             planContent.style.display = 'none'; planActions.style.display = 'none'; showLoader(planSection, planLoading); // Show loader in detail section

             try {
                 console.log("Generuji plán s Gemini...");
                 const { markdownContent, activitiesJson } = await generatePlanContentWithGemini(latestDiagnosticData.analysis, latestDiagnosticData.topic_results);

                 if (!markdownContent || !activitiesJson) { throw new Error("Generování obsahu plánu selhalo."); }
                  lastGeneratedMarkdown = markdownContent; // Store for potential saving
                  lastGeneratedActivitiesJson = activitiesJson; // Store for potential saving

                 displayPlanContent(markdownContent); // Render the generated markdown
                 planContent.style.display = 'block';
                 displayPlanGenerationConfirmation(); // Show Save/Discard buttons
                 planActions.style.display = 'flex';

             } catch (error) {
                 console.error("Chyba generování plánu:", error);
                 planContent.innerHTML = `<div class="notest-message error"><h3>Chyba generování</h3><p>Nepodařilo se vygenerovat studijní plán.</p><p><i>${sanitizeHTML(error.message)}</i></p></div>`;
                 planContent.style.display = 'block';
                 planActions.innerHTML = `<button class="btn btn-secondary" id="backToCreateTabBtnError"><i class="fas fa-arrow-left"></i> Zpět</button>`;
                 planActions.style.display = 'flex';
                 document.getElementById('backToCreateTabBtnError')?.addEventListener('click', () => switchTab('create'));
             } finally {
                  hideLoader(planLoading);
             }
        }
        async function generatePlanContentWithGemini(analysisData, topicsData) {
            // Improved prompt for better structure and JSON activities
            const prompt = `
                Jsi expert na tvorbu personalizovaných studijních plánů pro přípravu na přijímací zkoušky z matematiky na SŠ v ČR, vycházející z výsledků diagnostického testu. Tvým úkolem je vytvořit týdenní studijní plán (pondělí-neděle) ve formátu Markdown a zároveň vygenerovat pole aktivit ve formátu JSON.

                Vstupní data:
                1. Analýza testu (JSON): ${JSON.stringify(analysisData)}
                2. Výsledky podle témat (JSON): ${JSON.stringify(topicsData)}

                Požadavky na výstup:
                1. Plán v Markdownu:
                    - Struktura: Úvod (cíle, zaměření na slabiny), Týdenní rozvrh (nadpisy H3 pro každý den Po-Ne), Závěr (tipy, motivace).
                    - Obsah: Pro každý den navrhni 2-4 konkrétní aktivity (procvičování témat, opakování, teorie, mini-testy). Aktivity by měly reflektovat slabiny z analýzy a výsledků témat. Buď konkrétní (např. "Procvičování: 5 úloh na zlomky", "Opakování: Pythagorova věta").
                    - Formátování: Použij Markdown (nadpisy H2, H3, seznamy, tučné písmo). Nepoužívej H1.
                2. Aktivity v JSON:
                    - Formát: Pole objektů, kde každý objekt reprezentuje jednu aktivitu.
                    - Struktura objektu: {"day_of_week": cislo (1=Po, 2=Út, ..., 0=Ne), "time_slot": string (nepovinné, např. "Dopoledne", "16:00-17:00"), "title": string (název aktivity, např. "Procvičování rovnic"), "description": string (detailnější popis, může být prázdný)}
                    - Konzistence: Aktivity v JSON musí přesně odpovídat aktivitám popsaným v Markdownu pro daný den. Každá aktivita z Markdownu musí mít svůj JSON objekt. Pořadí aktivit v JSON pro daný den by mělo odpovídat pořadí v Markdownu.

                Důležité:
                - Zaměř se na slabiny identifikované v 'weaknesses' a tématech s nízkým 'score_percent'.
                - Zahrň i opakování silnějších témat.
                - Plán musí být realistický pro týdenní přípravu.
                - Odděl jasně Markdown část od JSON části. Použij oddělovač "---JSON AKTIVITY---".

                Výstupní formát (PŘESNĚ TENTO FORMÁT):
                [Celý plán v Markdownu]
                ---JSON AKTIVITY---
                [Pole aktivit v JSON formátu]
                `;

            try {
                console.log("Odesílám prompt Gemini...");
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.6, // Slightly more creative for planning
                            // response_mime_type: "text/plain" // Expecting mixed content
                        }
                    })
                });

                if (!response.ok) {
                     const errorBody = await response.json().catch(() => ({ error: { message: 'Nepodařilo se parsovat chybu' } }));
                     console.error("Chyba Gemini API:", response.status, errorBody);
                     throw new Error(`Chyba Gemini API: ${errorBody.error?.message || response.status}`);
                }

                const data = await response.json();
                console.log("Odpověď Gemini:", data);

                if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
                    const fullResponse = data.candidates[0].content.parts[0].text;
                    const separator = "---JSON AKTIVITY---";
                    const separatorIndex = fullResponse.indexOf(separator);

                    if (separatorIndex === -1) {
                        console.error("Oddělovač '---JSON AKTIVITY---' nenalezen v odpovědi Gemini.");
                        throw new Error("Chybný formát odpovědi od AI: chybí oddělovač.");
                    }

                    const markdownContent = fullResponse.substring(0, separatorIndex).trim();
                    let jsonString = fullResponse.substring(separatorIndex + separator.length).trim(); // Get the JSON part

                     // -----> ZAČÁTEK OPRAVY: Odstranění markdown značek ```json ... ``` <-----
                     let finalJsonString = jsonString;
                     if (finalJsonString.startsWith('```json') && finalJsonString.endsWith('```')) {
                         console.log("Detekován JSON code fence. Odstraňuji.");
                         // Odstraní ```json\n na začátku a ``` na konci
                         finalJsonString = finalJsonString.substring(7, finalJsonString.length - 3).trim();
                     } else if (finalJsonString.startsWith('```') && finalJsonString.endsWith('```')) {
                          // Fallback pro případ, že by vrátil jen ``` ... ```
                          console.log("Detekován obecný code fence. Odstraňuji.");
                          finalJsonString = finalJsonString.substring(3, finalJsonString.length - 3).trim();
                     }
                     // -----> KONEC OPRAVY <-----

                    try {
                         // Použijeme vyčištěný string pro parsování
                        const activitiesJson = JSON.parse(finalJsonString);
                        if (!Array.isArray(activitiesJson)) {
                            throw new Error("Část JSON neobsahuje validní pole aktivit.");
                        }
                        // Basic validation of activity structure
                        if (activitiesJson.length > 0) {
                             const firstActivity = activitiesJson[0];
                             if (typeof firstActivity.day_of_week !== 'number' || typeof firstActivity.title !== 'string') {
                                 throw new Error("Struktura objektu aktivity v JSON není validní.");
                             }
                        }
                        console.log("Markdown a JSON úspěšně extrahovány a JSON parsován.");
                        return { markdownContent, activitiesJson };
                    } catch (e) {
                        // Log the *cleaned* string if parsing fails
                        console.error("Chyba parsování JSON části:", e, "Vyčištěný JSON String:", finalJsonString);
                        throw new Error(`Chybný formát odpovědi od AI: nevalidní JSON. (${e.message})`);
                    }
                } else {
                    console.error("Neočekávaná struktura odpovědi Gemini (chybí text):", data);
                    throw new Error("Neočekávaná struktura odpovědi od AI.");
                }
            } catch (error) {
                console.error("Chyba komunikace s Gemini API:", error);
                throw error; // Re-throw the error to be caught by generateStudyPlan
            }
        }
        function displayPlanGenerationConfirmation() {
             planActions.innerHTML = `
                 <button class="btn btn-success btn-lg" id="savePlanBtn">
                     <i class="fas fa-save"></i> Uložit tento plán
                 </button>
                 <button class="btn btn-secondary btn-lg" id="discardPlanBtn">
                     <i class="fas fa-times"></i> Zahodit a zkusit znovu
                 </button>
             `;
             document.getElementById('savePlanBtn')?.addEventListener('click', () => saveGeneratedPlan(lastGeneratedMarkdown, lastGeneratedActivitiesJson, latestDiagnosticData?.topic_results));
             document.getElementById('discardPlanBtn')?.addEventListener('click', generateStudyPlan); // Regenerate
        }
        async function saveGeneratedPlan(markdownContent, activitiesArray, topicsData) {
             if (!markdownContent || !activitiesArray || !currentUser || !latestDiagnosticData) {
                 showToast("Chyba: Chybí data pro uložení plánu.", 'error'); return;
             }
             const saveBtn = document.getElementById('savePlanBtn');
             const discardBtn = document.getElementById('discardPlanBtn');
             if(saveBtn) { saveBtn.disabled = true; saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ukládám...'; }
             if(discardBtn) discardBtn.disabled = true;

             try {
                 // 1. Deactivate previous active plans for the user
                 console.log("Deaktivuji předchozí plány...");
                 const { error: updateError } = await supabaseClient
                     .from('study_plans')
                     .update({ status: 'inactive', updated_at: new Date().toISOString() })
                     .eq('user_id', currentUser.id)
                     .eq('status', 'active');
                 if (updateError) throw new Error(`Chyba při deaktivaci starých plánů: ${updateError.message}`);

                 // 2. Insert the new plan
                 console.log("Vkládám nový plán...");
                 const planTitle = `Studijní plán (${formatDate(new Date())})`; // Generate title
                 const estimatedCompletionDate = new Date();
                 estimatedCompletionDate.setDate(estimatedCompletionDate.getDate() + 7); // Estimate 1 week completion

                 const { data: newPlan, error: insertPlanError } = await supabaseClient
                     .from('study_plans')
                     .insert({
                         user_id: currentUser.id,
                         title: planTitle,
                         plan_content_markdown: markdownContent,
                         status: 'active', // Set as active immediately
                         diagnostic_id: latestDiagnosticData.id,
                         priority_topics: analysisDataToPriorityTopics(topicsData), // Convert topicsData if needed
                         estimated_completion_date: estimatedCompletionDate.toISOString().split('T')[0], // YYYY-MM-DD format
                         progress: 0 // Initial progress
                     })
                     .select('id') // Select the ID of the newly inserted plan
                     .single(); // Expect a single row back

                 if (insertPlanError) throw new Error(`Chyba při vkládání nového plánu: ${insertPlanError.message}`);
                 if (!newPlan || !newPlan.id) throw new Error("Nepodařilo se získat ID nového plánu.");

                 const newPlanId = newPlan.id;
                 console.log("Nový plán vložen, ID:", newPlanId);

                 // 3. Insert activities linked to the new plan
                 console.log(`Vkládám ${activitiesArray.length} aktivit pro plán ${newPlanId}...`);
                 const activitiesToInsert = activitiesArray.map(activity => ({
                     plan_id: newPlanId,
                     day_of_week: activity.day_of_week,
                     time_slot: activity.time_slot || null, // Handle optional time_slot
                     title: activity.title,
                     description: activity.description || null, // Handle optional description
                     completed: false, // Default to not completed
                     // Optional: Link to topic if possible - requires more complex logic
                     // topic_id: findTopicIdForActivity(activity.title, topicsData)
                 }));

                 const { error: insertActivitiesError } = await supabaseClient
                     .from('plan_activities')
                     .insert(activitiesToInsert);

                 if (insertActivitiesError) throw new Error(`Chyba při vkládání aktivit: ${insertActivitiesError.message}`);

                 console.log("Aktivity úspěšně vloženy.");
                 showToast("Nový studijní plán byl úspěšně uložen a aktivován!", 'success');

                 // Refresh the view to show the new active plan
                 await switchTab('current');

             } catch (error) {
                 console.error("Chyba při ukládání plánu:", error);
                 showToast(`Chyba: Nepodařilo se uložit plán. ${error.message}`, 'error', 6000);
                 if(saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = '<i class="fas fa-save"></i> Uložit tento plán'; }
                 if(discardBtn) discardBtn.disabled = false;
             }
        }
         // Helper to convert topic results to a simpler structure for priority_topics (example)
         function analysisDataToPriorityTopics(topicsData) {
            if (!topicsData) return null;
            return Object.values(topicsData)
                .filter(topic => topic.strength === 'weakness')
                .sort((a, b) => a.score - b.score) // Sort weakest first
                .slice(0, 3) // Take top 3 weaknesses
                .map(topic => ({ name: topic.name, score: topic.score })); // Simplify structure
         }
        function displayPlanContent(markdownContent) {
             if (!planContent) return;
             try {
                 // Check if Marked library is loaded before using it
                 if (typeof marked === 'function') {
                     const htmlContent = marked.parse(markdownContent || '');
                     planContent.innerHTML = htmlContent;
                 } else {
                      console.warn("Marked.js není načteno. Zobrazuji surový Markdown.");
                      planContent.innerHTML = `<pre>${sanitizeHTML(markdownContent || '')}</pre>`;
                 }

                 // Re-run MathJax typesetting for the new content
                 if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                     setTimeout(() => { // Delay slightly to ensure content is in DOM
                         window.MathJax.typesetPromise([planContent])
                             .catch(err => console.error('MathJax typesetting error:', err));
                     }, 0);
                 }
             } catch (e) {
                 console.error("Chyba při renderování Markdown:", e);
                 planContent.innerHTML = `<p style='color:red;'>Chyba při zobrazování obsahu plánu.</p><pre>${sanitizeHTML(markdownContent)}</pre>`;
             }
        }


        // ==============================================
        //          Pomocné UI Funkce (PDF, Scroll Arrows)
        // ==============================================
        async function exportPlanToPDFWithStyle(plan) {
             if (!plan || !plan.id) { showToast('Chyba: Chybí data plánu pro export.', 'error'); return; }

             // Check if html2pdf library is loaded
             if (typeof html2pdf === 'undefined') {
                  showToast('Chyba: Knihovna pro export PDF (html2pdf) není načtena.', 'error');
                  console.error("html2pdf library is not loaded.");
                  return;
             }

             // Ensure markdown content is available
             let markdown = plan.plan_content_markdown;
             if (!markdown) {
                 showToast('Načítám data pro PDF...', 'info', 2000);
                 try {
                     console.log("Načítám plný markdown pro export...");
                     const { data: fullPlanData, error } = await supabaseClient
                         .from('study_plans')
                         .select('plan_content_markdown, title, created_at, estimated_completion_date') // Fetch needed fields
                         .eq('id', plan.id)
                         .single();
                     if (error) throw error;
                     // Update the plan object with fetched data
                     plan = { ...plan, ...fullPlanData };
                     markdown = plan.plan_content_markdown;
                 } catch (fetchError) {
                      console.error("Nepodařilo se načíst markdown pro export:", fetchError);
                      showToast('Chyba: Nepodařilo se načíst data pro export.', 'error');
                      return;
                 }
             }
              if (!markdown) { showToast('Chyba: Obsah plánu pro export není k dispozici.', 'error'); return; }

             const exportContainer = document.createElement('div');
             exportContainer.id = 'pdf-export-content'; // ID pro případné stylování zvenčí

             // --- Vylepšené CSS styly pro PDF ---
             const pdfStyles = `
             <style>
                 @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
                 body { font-family: 'Poppins', Helvetica, Arial, sans-serif; font-size: 10pt; color: #2d3748; /* --text-primary */ line-height: 1.6; background-color: #ffffff; }
                 #pdf-export-content { padding: 15mm 12mm; }

                 .pdf-header { text-align: center; margin-bottom: 12mm; border-bottom: 2px solid #4361ee; /* --primary */ padding-bottom: 6mm; }
                 .pdf-header h1 { color: #3f37c9; /* --secondary */ font-size: 20pt; margin: 0 0 5px 0; font-weight: 700; }
                 .pdf-header p { color: #718096; /* --text-muted */ font-size: 9pt; margin: 0; }
                 /* .pdf-header img.logo { max-width: 100px; margin-bottom: 5mm; } */

                 .student-info { background-color: #f8f9fa; /* --light */ padding: 8mm 10mm; border-radius: 8px; border: 1px solid #dee2e6; /* --gray-light */ margin-bottom: 10mm; font-size: 9.5pt; break-inside: avoid; }
                 .student-info h2 { color: #4361ee; /* --primary */ font-size: 12pt; margin: 0 0 8px 0; padding-bottom: 4px; border-bottom: 1px solid #dee2e6; font-weight: 600; }
                 .student-info p { margin: 0 0 4px 0; line-height: 1.5; }
                 .student-info strong { font-weight: 600; color: #1e2a3a; /* --dark */ }

                 .pdf-content { margin-top: 5mm; } /* Add some top margin to content */
                 .pdf-content h2, .pdf-content h3, .pdf-content h4 { margin-top: 8mm; margin-bottom: 3mm; padding-bottom: 2px; font-weight: 600; break-after: avoid; color: #3f37c9; /* --secondary */ }
                 .pdf-content h2 { font-size: 14pt; border-bottom: 1.5px solid #4895ef; /* --primary-light */ }
                 .pdf-content h3 { font-size: 12pt; color: #1e2a3a; /* --dark */ border-bottom: 1px dashed #6c757d; /* --gray */ margin-top: 10mm; }
                 .pdf-content h4 { font-size: 11pt; color: #4361ee; /* --primary */ border-bottom: none; margin-top: 5mm; }

                 .pdf-content p, .pdf-content li { margin-bottom: 2.5mm; color: #2d3748; text-align: left; font-size: 10pt; }
                 .pdf-content ul, .pdf-content ol { padding-left: 6mm; margin-left: 0; margin-bottom: 4mm; break-inside: avoid; }
                 .pdf-content li { margin-bottom: 2mm; padding-left: 2mm; position: relative; }
                 .pdf-content ul { list-style: none; /* Remove default bullets */ }
                 .pdf-content ul > li::before { content: '•'; color: #4361ee; /* --primary */ font-weight: bold; display: inline-block; position: absolute; left: -2mm; top: 0; }
                 .pdf-content ol { list-style: decimal; }
                 .pdf-content ol > li::marker { color: #4361ee; font-weight: 600; }

                 .pdf-content strong { font-weight: 700; color: #1e2a3a; /* --dark */ }
                 .pdf-content em { font-style: italic; color: #4a5568; /* --text-secondary */ }
                 .pdf-content code { font-family: 'Courier New', Courier, monospace; background-color: #e9ecef; padding: 1.5px 5px; border-radius: 4px; font-size: 9.5pt; color: #c7254e; border: 1px solid #dee2e6; }
                 .pdf-content pre { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 4mm; margin: 5mm 0; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; font-size: 9pt; line-height: 1.4; break-inside: avoid; }
                 .pdf-content blockquote { border-left: 4px solid #4895ef; /* --primary-light */ padding-left: 5mm; margin: 5mm 0 5mm 3mm; color: #4a5568; font-style: italic; break-inside: avoid; }
                 .pdf-content hr { border: none; border-top: 1px dashed #6c757d; /* --gray */ margin: 8mm 0; }

                 .pdf-footer { text-align: center; margin-top: 15mm; padding-top: 5mm; border-top: 1px solid #dee2e6; color: #718096; font-size: 8pt; }

                 /* Page break control */
                 .pdf-day-content-wrapper { break-inside: avoid !important; page-break-inside: avoid !important; margin-bottom: 8mm; padding-top: 2mm; }
                 .pdf-content h2, .pdf-content h3, .pdf-content h4 { break-after: avoid; }
                 .pdf-content ul, .pdf-content ol, .pdf-content p, .pdf-content pre, .pdf-content blockquote { break-inside: avoid; }
             </style>
             `;
             exportContainer.innerHTML = pdfStyles;

             // Add Header
             const pdfTitle = plan.title ? plan.title.replace(/\s*\(\d{2}\.\d{2}\.\d{4}\)$/, '').trim() : 'Studijní plán';
             const headerHTML = `<div class="pdf-header"><h1>${sanitizeHTML(pdfTitle)}</h1><p>Vytvořeno: ${formatDate(plan.created_at)}</p></div>`;
             exportContainer.innerHTML += headerHTML;

             // Add Student Info Box
             if (currentUser && userName.textContent) {
                 exportContainer.innerHTML += `
                 <div class="student-info">
                     <h2>Informace o studentovi</h2>
                     <p><strong>Student:</strong> ${userName.textContent}</p>
                     <p><strong>Datum vytvoření plánu:</strong> ${formatDate(plan.created_at)}</p>
                     ${plan.estimated_completion_date ? `<p><strong>Předpokládané dokončení:</strong> ${formatDate(plan.estimated_completion_date)}</p>` : ''}
                 </div>`;
             }

             // Add Main Content (Parsed Markdown with Day Wrappers)
             const contentDiv = document.createElement('div');
             contentDiv.className = 'pdf-content';
             try {
                  // Check if Marked is loaded before parsing
                 let htmlContent;
                  if (typeof marked === 'function') {
                      htmlContent = marked.parse(markdown || ''); // Use the ensured markdown
                  } else {
                       console.warn("Marked.js není načteno pro PDF export. Zobrazuji jako preformátovaný text.");
                       htmlContent = `<pre>${sanitizeHTML(markdown || '')}</pre>`;
                  }

                 const tempWrapper = document.createElement('div');
                 tempWrapper.innerHTML = htmlContent; // Use parsed or preformatted content

                 const nodesToWrap = [];
                 let currentDayWrapper = null;
                 const daysCzech = ['Pondělí', 'Úterý', 'Středa', 'Čtvrtek', 'Pátek', 'Sobota', 'Neděle'];

                 Array.from(tempWrapper.childNodes).forEach(node => {
                     const isDayHeader = node.nodeType === Node.ELEMENT_NODE &&
                                        node.tagName === 'H3' &&
                                        daysCzech.some(day => node.textContent.trim().startsWith(day));

                     if (isDayHeader) {
                         currentDayWrapper = document.createElement('div');
                         currentDayWrapper.className = 'pdf-day-content-wrapper'; // Class for break control
                         nodesToWrap.push(currentDayWrapper);
                         currentDayWrapper.appendChild(node.cloneNode(true));
                     } else if (currentDayWrapper && node.nodeType === Node.TEXT_NODE && !node.textContent.trim()) {
                         // Ignore empty text nodes within a day block
                     } else if (currentDayWrapper) {
                         currentDayWrapper.appendChild(node.cloneNode(true));
                     } else {
                         // Content before the first day
                         nodesToWrap.push(node.cloneNode(true));
                     }
                 });

                 contentDiv.innerHTML = ''; // Clear contentDiv
                 nodesToWrap.forEach(wrappedNode => { contentDiv.appendChild(wrappedNode); }); // Append processed nodes

             } catch (e) {
                 console.error("Chyba při parsování/balení Markdown pro PDF:", e);
                 contentDiv.innerHTML = '<p style="color:red;">Chyba při zpracování obsahu plánu.</p>';
             }
             exportContainer.appendChild(contentDiv);

             // Add Footer
             exportContainer.innerHTML += `<div class="pdf-footer">&copy; ${new Date().getFullYear()} Justax.space</div>`;

             // Configure and run html2pdf
             const options = {
                 margin: [15, 12, 15, 12], // Top, Left, Bottom, Right margins in mm
                 filename: `studijni-plan-${formatDate(plan.created_at).replace(/\./g, '-')}.pdf`,
                 image: { type: 'jpeg', quality: 0.95 },
                 html2canvas: {
                     scale: 2, // Higher scale for better resolution
                     useCORS: true,
                     logging: false,
                     letterRendering: true // Improves text rendering
                 },
                 jsPDF: {
                     unit: 'mm',
                     format: 'a4',
                     orientation: 'portrait'
                 },
                 pagebreak: { mode: ['css', 'avoid-all'], before: '.pdf-day-content-wrapper' } // Try page break before day wrapper
             };

             console.log("Starting PDF generation...");
             showToast('Generuji PDF...', 'info', 5000);
             html2pdf().set(options).from(exportContainer).save()
                 .then(() => {
                     console.log("PDF generation finished.");
                     showToast('PDF bylo úspěšně vygenerováno!', 'success');
                 })
                 .catch(err => {
                     console.error("Chyba exportu PDF:", err);
                     showToast('Nepodařilo se exportovat PDF.', 'error');
                 });
        }


         // Funkce pro ovládání šipek posuvníku kalendáře
         function updateScrollArrows() {
             if (!calendarScrollContainer || !scrollLeftArrow || !scrollRightArrow) return;

             // Use requestAnimationFrame for smoother checks after render/scroll
             requestAnimationFrame(() => {
                 const scrollLeft = Math.round(calendarScrollContainer.scrollLeft);
                 const scrollWidth = Math.round(calendarScrollContainer.scrollWidth);
                 const clientWidth = Math.round(calendarScrollContainer.clientWidth);
                 const maxScrollLeft = scrollWidth - clientWidth;

                 const isScrollable = scrollWidth > clientWidth + 1; // Add tolerance

                 // Update left arrow
                 const canScrollLeft = isScrollable && scrollLeft > 5; // Add tolerance
                 scrollLeftArrow.classList.toggle('disabled', !canScrollLeft);
                 scrollLeftArrow.style.opacity = canScrollLeft ? '' : '0'; // Use opacity for showing/hiding

                 // Update right arrow
                 const canScrollRight = isScrollable && scrollLeft < maxScrollLeft - 5; // Add tolerance
                 scrollRightArrow.classList.toggle('disabled', !canScrollRight);
                 scrollRightArrow.style.opacity = canScrollRight ? '' : '0'; // Use opacity for showing/hiding

                 // console.log(`Arrows updated: L=${scrollLeft}, Max=${maxScrollLeft}, W=${scrollWidth}, CW=${clientWidth}, canL=${canScrollLeft}, canR=${canScrollRight}`);
             });
         }


        // ==============================================
        //          Spuštění Aplikace
        // ==============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded and parsed, starting application initialization...");
            // Defer initialization slightly to give libraries more time to load? (Optional)
            // setTimeout(initializeApp, 50);
            initializeApp();
        });

    </script>
</body>
</html>