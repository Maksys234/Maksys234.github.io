<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Studijní plán</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">

    <style>
        /* --- CSS STYLES (Beze změny) --- */
        /* Základní styly */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        :root { --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9; --success: #06d6a0; --danger: #f72585; --warning: #f8961e; --info: #4895ef; --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d; --gray-light: #dee2e6; --gray-dark: #343a40; --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3); --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee); --gradient-3: linear-gradient(135deg, #f72585, #7209b7); --gradient-4: linear-gradient(135deg, #f8961e, #f3722c); --white: #ffffff; --sidebar-width: 260px; --transition-speed: 0.3s; --card-radius: 16px; --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05); --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.07); --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1); --text-primary: #2d3748; --text-secondary: #4a5568; --text-muted: #718096; }
        body { background-color: #f6f8ff; color: var(--text-primary); min-height: 100vh; display: flex; overflow-x: hidden; }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 100; box-shadow: var(--shadow-lg); transition: transform var(--transition-speed) ease, width var(--transition-speed) ease; }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; }
        .sidebar-logo { font-size: 1.5rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo i { font-size: 1.75rem; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .sidebar-item { margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; color: rgba(255, 255, 255, 0.85); text-decoration: none; border-radius: 12px; transition: all 0.2s ease; font-weight: 500; }
        .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; width: 24px; text-align: center; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--white); }
        .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); text-align: center; }
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.1); border-radius: 12px; backdrop-filter: blur(5px); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-weight: 500; overflow: hidden; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15); }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; }
        .user-name { font-weight: 600; font-size: 0.95rem; }
        .user-role { font-size: 0.8rem; opacity: 0.8; }
        main { flex: 1; margin-left: var(--sidebar-width); padding: 1.5rem 2rem; transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); }
        .dashboard-header { margin-bottom: 2rem; background-color: var(--white); border-radius: var(--card-radius); padding: 1.25rem 1.5rem; box-shadow: var(--shadow-sm); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-content h1 { font-size: 1.75rem; font-weight: 600; color: var(--dark); }
        .main-content { display: flex; flex-direction: column; gap: 1.75rem; }
        .section { background-color: var(--white); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); padding: 1.5rem; animation: fadeIn 0.5s ease forwards; }
        .section-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1.25rem; color: var(--dark); }
        .section-subtitle { font-size: 1.1rem; font-weight: 500; margin-bottom: 1rem; color: var(--dark); }
        .section-text { font-size: 1rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 1.5rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; font-size: 0.95rem; text-decoration: none; transition: all 0.3s ease; cursor: pointer; border: none; gap: 0.5rem; }
        .btn-primary { background: var(--gradient-1); color: white; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.2); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(67, 97, 238, 0.25); }
        .btn-secondary { background-color: var(--light); color: var(--text-secondary); border: 1px solid var(--gray-light); }
        .btn-secondary:hover { background-color: var(--gray-light); color: var(--dark); }
        .btn-success { background: linear-gradient(135deg, #4cc9f0, #38b2ac); color: white; box-shadow: 0 4px 10px rgba(76, 201, 240, 0.2); }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(76, 201, 240, 0.25); }
        .btn-warning { background: linear-gradient(135deg, #f8961e, #f3722c); color: white; box-shadow: 0 4px 10px rgba(248, 150, 30, 0.2); }
        .btn-warning:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(248, 150, 30, 0.25); }
        .btn-danger { background: linear-gradient(135deg, #f72585, #b5179e); color: white; box-shadow: 0 4px 10px rgba(247, 37, 133, 0.2); }
        .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(247, 37, 133, 0.25); }
        .btn-lg { padding: 0.75rem 2rem; font-size: 1rem; }
        .btn-center { margin: 0 auto; display: block; width: fit-content; }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 1rem; margin: 1.5rem 0; justify-content: center; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .ai-loading { display: flex; align-items: center; gap: 1rem; margin: 2rem 0; font-style: italic; color: var(--text-muted); justify-content: center; }
        .ai-loading-spinner { width: 24px; height: 24px; border: 3px solid rgba(67, 97, 238, 0.2); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s ease-in-out infinite; }
        .plan-content { margin-top: 1rem; padding: 1.5rem; background-color: #f9f9ff; border-radius: var(--card-radius); border-left: 4px solid var(--primary); line-height: 1.7; }
        .plan-content h1, .plan-content h2, .plan-content h3, .plan-content h4 { color: var(--primary); margin-bottom: 0.8rem; font-weight: 600; padding-bottom: 0.3rem; border-bottom: 1px solid var(--gray-light); }
        .plan-content h1 { font-size: 1.6rem; }
        .plan-content h2 { font-size: 1.4rem; margin-top: 2rem; }
        .plan-content h3 { font-size: 1.2rem; margin-top: 1.5rem; color: var(--dark); border-bottom: none;}
        .plan-content h4 { font-size: 1.1rem; margin-top: 1.2rem; color: var(--secondary); border-bottom: none; }
        .plan-content p { margin-bottom: 1rem; }
        .plan-content ul, .plan-content ol { margin-left: 1.5rem; margin-bottom: 1rem; padding-left: 1rem; }
        .plan-content li { margin-bottom: 0.7rem; }
        .plan-content li::marker { color: var(--primary); }
        .plan-content strong { color: var(--secondary); font-weight: 600; }
        .plan-content code { background-color: rgba(67, 97, 238, 0.1); padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.9rem; font-family: 'Courier New', Courier, monospace; }
        .plan-content blockquote { border-left: 3px solid var(--primary-light); padding-left: 1rem; margin: 1rem 0; color: var(--text-secondary); font-style: italic; }
        .plan-content hr { border: none; border-top: 1px dashed var(--gray-light); margin: 2rem 0; }
        .plan-content em { font-style: italic; color: var(--text-secondary); }
        .daily-schedule { margin-top: 1.5rem; /* Menší mezera, když je hned pod hlavičkou */ }
        .schedule-day { background-color: var(--white); border-radius: var(--card-radius); padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow-sm); border-left: 4px solid var(--primary); }
        .schedule-day.today { border-left-color: var(--success); background-color: #f0fff9; }
        .day-name { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; color: var(--dark); display: flex; align-items: center; justify-content: space-between; }
        .day-focus { font-size: 0.9rem; font-weight: 500; color: var(--primary); background-color: rgba(67, 97, 238, 0.1); padding: 0.25rem 0.75rem; border-radius: 20px; }
        .activities { margin-top: 1rem; }
        .activity { display: flex; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px dashed var(--gray-light); gap: 1rem; }
        .activity:last-child { border-bottom: none; padding-bottom: 0; }
        .activity-time { min-width: 70px; font-weight: 600; color: var(--primary); font-size: 0.9em; }
        .activity-content { flex: 1; }
        .activity-title { font-weight: 500; color: var(--dark); margin-bottom: 0.25rem; }
        .activity-desc { font-size: 0.9rem; color: var(--text-secondary); }
        .step-navigation { display: flex; justify-content: space-between; margin-bottom: 1.5rem; }
        .notest-message { background-color: rgba(255, 214, 102, 0.2); border-left: 4px solid var(--warning); padding: 1.5rem; margin: 2rem 0; border-radius: var(--card-radius); }
        .notest-message h3 { color: var(--warning); margin-bottom: 0.75rem; font-size: 1.2rem; }
        .notest-message p { color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.5; }
        .notest-message.error { background-color: rgba(247, 37, 133, 0.1); border-left-color: var(--danger); }
        .notest-message.error h3 { color: var(--danger); }
        .notest-message.info { background-color: rgba(72, 149, 239, 0.1); border-left-color: var(--info); }
        .notest-message.info h3 { color: var(--info); }
        /* Upravená hlavička plánu a akce */
        .plan-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .plan-meta { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; }
        .plan-date { font-size: 0.9rem; color: var(--text-muted); }
        .plan-badge { display: inline-block; font-size: 0.8rem; padding: 0.25rem 0.75rem; border-radius: 20px; background: var(--gradient-1); color: white; font-weight: 500; margin-bottom: 0.5rem; width: fit-content; }
        .plan-actions { display: flex; gap: 1rem; flex-shrink: 0; }
        /* Statistiky a progress bar odstraněny z hlavního pohledu */
        /*.plan-progress { ... } */
        /*.circular-progress { ... } */
        /*.progress-value { ... } */
        /*.progress-text { ... } */
        /*.plan-stats { ... } */
        /*.plan-stat-card { ... } */
        /*.plan-stat-icon { ... } */
        /*.plan-stat-value { ... } */
        /*.plan-stat-label { ... } */
        .activity-checkbox { display: flex; gap: 0.75rem; align-items: flex-start; }
        .activity-checkbox input[type="checkbox"] { min-width: 18px; height: 18px; margin-top: 3px; cursor: pointer; }
        .activity-checkbox .activity-content { text-decoration: none; transition: all 0.2s ease; }
        .activity-checkbox input[type="checkbox"]:checked + .activity-content { text-decoration: line-through; opacity: 0.7; }
        .plan-history { margin-top: 2rem; }
        .history-item { background-color: var(--white); border-radius: var(--card-radius); padding: 1.25rem; margin-bottom: 1rem; box-shadow: var(--shadow-sm); display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; cursor: pointer; }
        .history-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .history-date { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .history-title { font-weight: 600; color: var(--dark); }
        .history-status { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .history-status.active { background-color: rgba(76, 201, 240, 0.15); color: #4cc9f0; }
        .history-status.completed { background-color: rgba(67, 97, 238, 0.15); color: var(--primary); }
        .history-status.inactive { background-color: rgba(108, 117, 125, 0.15); color: var(--gray);}
        .tooltip-inner { background-color: var(--dark); color: var(--white); border-radius: 4px; padding: 0.5rem 0.75rem; font-size: 0.9rem; max-width: 250px; box-shadow: var(--shadow-md); }
        .locked-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(26, 32, 44, 0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: var(--card-radius); color: white; padding: 2rem; text-align: center; }
        .locked-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.9; }
        .locked-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; }
        .locked-message { font-size: 1rem; margin-bottom: 1.5rem; opacity: 0.9; max-width: 500px; }
        .timer-container { margin: 1rem 0 2rem; font-size: 1.2rem; font-weight: 600; }
        .plan-tabs { display: flex; margin-bottom: 2rem; border-bottom: 1px solid var(--gray-light); }
        .plan-tab { padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .plan-tab:hover { color: var(--primary); }
        .plan-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .loader-container { display: flex; justify-content: center; align-items: center; min-height: 200px; }
        .loader { width: 40px; height: 40px; border: 4px solid rgba(67, 97, 238, 0.2); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animated { animation: fadeIn 0.5s ease forwards; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 992px) { :root { --sidebar-width: 80px; } .sidebar { width: 80px; } .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; } .sidebar-link i { margin-right: 0; font-size: 1.5rem; } .sidebar-logo i { margin-right: 0; } .sidebar-header, .sidebar-link { justify-content: center; } .user-profile { justify-content: center; padding: 0.75rem 0; } .user-avatar { margin-right: 0; } .topic-grid { grid-template-columns: 1fr; } .test-summary-content { flex-direction: column; } }
        @media (max-width: 768px) { main { padding: 1rem; } .header-content { flex-direction: column; align-items: flex-start; gap: 1rem; } .plan-header { flex-direction: column; gap: 1rem; } .plan-actions { width: 100%; justify-content: center; } .plan-tabs { overflow-x: auto; white-space: nowrap; padding-bottom: 0.5rem; } .plan-tab { padding: 0.75rem 1rem; font-size: 0.9rem; } }
        @media (max-width: 576px) { :root { --sidebar-width: 0; } .sidebar { transform: translateX(-100%); z-index: 1000; width: 260px; } .sidebar.active { transform: translateX(0); } .sidebar.active .sidebar-logo span, .sidebar.active .sidebar-link span, .sidebar.active .user-info, .sidebar.active .sidebar-footer { display: block; } .sidebar.active .sidebar-link i { margin-right: 0.75rem; } .sidebar.active .sidebar-header, .sidebar.active .sidebar-link { justify-content: flex-start; } .sidebar.active .user-profile { justify-content: flex-start; padding: 1rem; } .sidebar.active .user-avatar { margin-right: 0.75rem; } main { margin-left: 0; width: 100%; } .mobile-menu-toggle { display: block; } .plan-stat-card { min-width: 100%; } .test-stats { flex-direction: column; } }
        .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; color: var(--dark); font-size: 1.5rem; margin-right: 1rem; }
        .mobile-menu-visible .sidebar { transform: translateX(0); }
        @media (prefers-color-scheme: dark) { :root { --white: #1a202c; --light: #2d3748; --dark: #e2e8f0; --gray-light: #4a5568; --text-primary: #e2e8f0; --text-secondary: #cbd5e0; --text-muted: #a0aec0; } body { background-color: #171923; } .plan-content { background-color: #1e2533; } .test-stat-card { background-color: #2d3748; } .plan-stat-card { background-color: #2d3748; } .notest-message { background-color: rgba(255, 214, 102, 0.1); } .history-item { background-color: var(--dark-bg); } .schedule-day.today { background-color: rgba(6, 214, 160, 0.08); } .toast { background-color: var(--dark-bg); border-color: var(--gray-light);} }
         /* Toast notification */
         .toast { position: fixed; bottom: 20px; right: 20px; background-color: var(--white); color: var(--text-primary); border-radius: 8px; padding: 1rem; box-shadow: var(--shadow-lg); max-width: 300px; z-index: 1001; display: flex; align-items: center; transform: translateY(120px); opacity: 0; transition: all 0.4s ease-in-out; }
         .toast.show { transform: translateY(0); opacity: 1; }
         .toast.success { border-left: 4px solid #10b981; }
         .toast.error { border-left: 4px solid var(--danger); }
         .toast.warning { border-left: 4px solid var(--warning); }
         .toast i { margin-right: 0.75rem; font-size: 1.25rem; }
         .toast.success i { color: #10b981; }
         .toast.error i { color: var(--danger); }
         .toast.warning i { color: var(--warning); }
         /* Extra padding for schedule section */
         .schedule-section { padding-top: 0.5rem; /* Reduce top padding if header is inside */ }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header"> <a href="/" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
        <ul class="sidebar-menu"> <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Dashboard</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li> </ul>
        <div class="user-profile"> <div class="user-avatar" id="user-avatar">MS</div> <div class="user-info"> <div class="user-name" id="user-name">Načítání...</div> <div class="user-role" id="user-role">Student</div> </div> </div>
        <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main>
        <div class="dashboard-header">
            <div class="header-content">
                <h1>Personalizovaný studijní plán</h1>
                <button class="mobile-menu-toggle" id="mobileMenuToggle"> <i class="fas fa-bars"></i> </button>
            </div>
        </div>

        <div class="main-content">
            <div class="plan-tabs">
                <div class="plan-tab active" data-tab="current">Aktuální plán</div>
                <div class="plan-tab" data-tab="history">Historie plánů</div>
                <div class="plan-tab" data-tab="create">Vytvořit nový</div>
            </div>

            <div class="section current-plan-section" id="currentPlanSection" style="display: none;">
                <div class="loader-container" id="currentPlanLoader"> <div class="loader"></div> </div>
                <div id="currentPlanContent">
                    </div>
            </div>

            <div class="section history-plan-section" id="historyPlanSection" style="display: none;">
                <h2 class="section-title">Historie studijních plánů</h2>
                <div class="loader-container" id="historyLoader"> <div class="loader"></div> </div>
                <div id="historyPlanContent" class="plan-history"> </div>
            </div>

            <div class="section create-plan-section" id="createPlanSection" style="display: none;">
                <div id="planCreateContent"> </div>
            </div>

            <div class="section plan-section" id="planSection" style="display: none;">
                 <div class="step-navigation">
                     </div>
                <h2 class="section-title">Detail plánu</h2> <div class="ai-loading" id="planLoading"> <div class="ai-loading-spinner"></div> <div>Načítám/Generuji...</div> </div>
                <div class="plan-content" id="planContent" style="display: none;">
                     </div>
                <div class="action-buttons" id="planActions" style="display: none;">
                    </div>
            </div>

             <div class="section schedule-section" id="scheduleSection" style="display: none;">
                 <div class="daily-schedule" id="dailySchedule">
                      </div>
                 <div class="step-navigation" style="margin-top: 1.5rem;"> <button class="btn btn-secondary" id="backToTabsBtn"> <i class="fas fa-arrow-left"></i> Zpět na záložky </button>
                 </div>
             </div>

            <template id="lockedPlanTemplate">
                <div style="position: relative; min-height: 300px;"> <div class="locked-overlay"> <div class="locked-icon"> <i class="fas fa-lock"></i> </div> <h3 class="locked-title">Vytvoření nového plánu není dostupné</h3> <p class="locked-message">Nový studijní plán můžete vytvořit jednou týdně, abyste měli dostatek času pracovat na aktuálním. Váš poslední plán byl vytvořen nedávno.</p> <div class="timer-container" id="timerContainer"> Další plán můžete vytvořit za: <span id="nextPlanTimer">počítám...</span> </div> <button class="btn btn-primary" id="viewCurrentPlanBtnLocked"> <i class="fas fa-eye"></i> Zobrazit aktuální plán </button> </div> </div>
            </template>
             <template id="createPlanFormTemplate">
                <h2 class="section-title">Vytvořit nový studijní plán</h2> <div id="diagnosticInfo"> </div> <p class="section-text">Personalizovaný studijní plán bude vytvořen na základě výsledků vašeho posledního diagnostického testu. Zaměří se na vaše slabší oblasti a pomůže vám efektivně se připravit.</p> <div class="action-buttons"> <button class="btn btn-primary btn-lg" id="generatePlanBtn"> <i class="fas fa-magic"></i> Vygenerovat studijní plán </button> </div>
             </template>
             <template id="noDiagnosticTemplate">
                 <div class="notest-message"> <h3><i class="fas fa-exclamation-circle"></i> Nejprve absolvujte diagnostický test</h3> <p>Pro vytvoření personalizovaného studijního plánu je nejprve potřeba dokončit diagnostický test na stránce Procvičování, který nám pomůže identifikovat vaše silné a slabé stránky.</p> <button class="btn btn-primary" id="goToTestBtn"> <i class="fas fa-play"></i> Přejít k testu </button> </div>
             </template>
            <template id="historyItemTemplate">
                <div class="history-item" data-plan-id=""> <div class="history-info"> <div class="history-date">Vytvořeno: -</div> <div class="history-title">Studijní plán</div> </div> <div class="history-meta"> <span class="history-status active">Stav</span> </div> </div>
            </template>
            <template id="promptCreatePlanTemplate">
                <div class="notest-message info"><h3><i class="fas fa-clipboard-check"></i> Diagnostický test dokončen</h3><p>Váš poslední diagnostický test je připraven k analýze. Můžete nyní vygenerovat nový personalizovaný studijní plán.</p><button class="btn btn-primary" id="createNewPlanFromPromptBtn"><i class="fas fa-plus-circle"></i> Vytvořit studijní plán</button></div>
            </template>
        </div>
    </main>

     <div class="toast" id="toast">
         <i class="fas fa-check-circle"></i>
         <div id="toast-message">Operace byla úspěšně dokončena.</div>
     </div>

    <script
        src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous"
        defer>
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script> <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js" defer></script>

    <script>
        // ==============================================
        //          Inicializace Supabase & Gemini
        // ==============================================
        const supabaseUrl = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
        let supabaseClient = null; // Initialize later
        const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // <--- ZDE VLOŽTE VÁŠ KLÍČ
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;


        // ==============================================
        //          DOM Elementy
        // ==============================================
        const currentPlanSection = document.getElementById('currentPlanSection'); // Pro zobrazení výzvy/chybějícího testu
        const historyPlanSection = document.getElementById('historyPlanSection');
        const createPlanSection = document.getElementById('createPlanSection');
        const planSection = document.getElementById('planSection'); // Pro zobrazení generovaného potvrzení NEBO detailu HISTORICKÉHO plánu
        const scheduleSection = document.getElementById('scheduleSection'); // Pro zobrazení AKTIVNÍHO detailního harmonogramu
        const planLoading = document.getElementById('planLoading'); // Loader v planSection
        const planContent = document.getElementById('planContent'); // Obsah v planSection
        const dailySchedule = document.getElementById('dailySchedule'); // Kontejner pro aktivity v scheduleSection
        const planActions = document.getElementById('planActions'); // Tlačítka po generování v planSection
        const currentPlanLoader = document.getElementById('currentPlanLoader'); // Loader v currentPlanSection
        const currentPlanContent = document.getElementById('currentPlanContent'); // Obsah v currentPlanSection
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const planCreateContent = document.getElementById('planCreateContent'); // Obsah v createPlanSection
        const historyLoader = document.getElementById('historyLoader');
        const historyPlanContent = document.getElementById('historyPlanContent'); // Obsah v historyPlanSection
        const planTabs = document.querySelectorAll('.plan-tab');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const backToTabsBtn = document.getElementById('backToTabsBtn'); // Tlačítko zpět v scheduleSection

        // Vzory
        // const currentPlanTemplate = document.getElementById('currentPlanTemplate'); // ODSTRANĚNO
        const lockedPlanTemplate = document.getElementById('lockedPlanTemplate');
        const createPlanFormTemplate = document.getElementById('createPlanFormTemplate');
        const noDiagnosticTemplate = document.getElementById('noDiagnosticTemplate');
        const historyItemTemplate = document.getElementById('historyItemTemplate');
        const promptCreatePlanTemplate = document.getElementById('promptCreatePlanTemplate'); // Nová šablona

        // Globální proměnné
        let currentUser = null; let currentProfile = null; let latestDiagnosticData = null; let currentStudyPlan = null; let previousPlans = []; let planCreateAllowed = false; let nextPlanCreateTime = null; let planTimerInterval = null; let currentTab = 'current';
        let lastGeneratedMarkdown = null;
        let lastGeneratedActivitiesJson = null;

        const topicIcons = { "Čísla a aritmetické operace": "fa-calculator", "Algebra": "fa-square-root-alt", "Geometrie": "fa-draw-polygon", "Práce s daty": "fa-chart-bar", "Problémové úlohy": "fa-lightbulb", "Proporce a procenta": "fa-percentage", "Logické úlohy": "fa-brain", "default": "fa-book" };
        const topicMap = { 1: "Čísla a aritmetické operace", 2: "Algebra", 3: "Geometrie", 4: "Práce s daty", 5: "Problémové úlohy", 6: "Proporce a procenta", 7: "Logické úlohy" };

        // ==============================================
        //          Pomocné Funkce (Většinou beze změny)
        // ==============================================
        function formatDate(dateString) { if(!dateString) return '-'; const date = new Date(dateString); return date.toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric' }); }
        function showLoader(sectionElement, loaderElement) { if(loaderElement) loaderElement.style.display = 'flex'; const contentElement = sectionElement.querySelector('[id$="Content"], .plan-history, .daily-schedule, .plan-content'); if (contentElement) contentElement.style.display = 'none'; }
        function hideLoader(loaderElement) { if(loaderElement) loaderElement.style.display = 'none'; }
        function showGlobalError(message) { const errorContainer = document.getElementById('global-error'); if(errorContainer) { errorContainer.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><div>${message}</div></div>`; errorContainer.style.display = 'block';} }
        function sanitizeHTML(str) { if (str === null || str === undefined) return ''; const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; }
        function getInitials(profileData) { if (!profileData) return 'U'; const first = profileData.first_name?.[0] || ''; const last = profileData.last_name?.[0] || ''; const usernameInitial = profileData.username?.[0] || ''; const emailInitial = profileData.email?.[0] || ''; return (first + last).toUpperCase() || usernameInitial.toUpperCase() || emailInitial.toUpperCase() || 'U'; }
        function toggleMobileMenu() { const sidebar = document.querySelector('.sidebar'); sidebar?.classList.toggle('active'); const overlay = document.querySelector('.sidebar-overlay'); overlay?.classList.toggle('active'); }
        function showToast(message, type = 'success', duration = 4000) { const toast = document.getElementById('toast'); const toastMessage = document.getElementById('toast-message'); if (!toast || !toastMessage) return; toastMessage.textContent = message; const icon = toast.querySelector('i'); icon.className = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-circle' : type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle'; toast.className = 'toast ' + type; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, duration); }
        function initTooltips() { try { if (typeof window.$ !== 'undefined' && window.$.fn.tooltipster) { window.$('.btn-tooltip:not(.tooltipstered)').tooltipster({ theme: 'tooltipster-shadow', animation: 'fade', delay: 100, side: 'top' }); console.log("Tooltips initialized on new elements."); } else { console.warn("Tooltipster nebo jQuery nejsou dostupné pro inicializaci."); } } catch (e) { console.error("Chyba inicializace Tooltipster:", e); } }
        window.addEventListener('resize', () => { if (window.innerWidth > 992) { document.querySelector('.sidebar')?.classList.remove('active'); document.querySelector('.sidebar-overlay')?.classList.remove('active'); } });

        // ==============================================
        //          Inicializace a Navigace
        // ==============================================
        async function initializeApp() {
            try {
                if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
                     const { createClient } = supabase;
                     supabaseClient = createClient(supabaseUrl, supabaseKey);
                     console.log("Supabase client initialized.");
                } else {
                     throw new Error("Supabase library not loaded correctly.");
                }
                showLoader(currentPlanSection, currentPlanLoader); // Ukazuje loader v sekci pro aktuální plán/výzvu
                currentUser = await getCurrentSupabaseUser();
                if (!currentUser) {
                    console.warn("Uživatel není přihlášen. Používám placeholder.");
                    currentUser = { id: 'PLACEHOLDER_USER_ID', email: 'student@example.com' };
                    currentProfile = { username: 'Testovací Student', email: 'student@example.com', points: 0 };
                } else {
                    currentProfile = await fetchUserProfile(currentUser.id);
                }
                updateUserInfoUI(currentProfile, currentUser?.email);
                setupEventListeners();
                await switchTab('current'); // Začne načtením aktuálního stavu
                initTooltips();

            } catch (error) {
                console.error('Chyba při inicializaci aplikace:', error);
                showGlobalError('Nepodařilo se inicializovat aplikaci: ' + error.message);
                currentPlanContent.innerHTML = `<div class="notest-message error"><h3>Chyba inicializace</h3><p>${error.message}</p></div>`;
                currentPlanSection.style.display = 'block'; // Zobrazí sekci s chybou
                hideLoader(currentPlanLoader);
            }
        }
        async function getCurrentSupabaseUser() { if (!supabaseClient) throw new Error("Supabase client není inicializován"); const { data: { user }, error } = await supabaseClient.auth.getUser(); if (error) { console.error("Chyba získání uživatele:", error); throw new Error("Nepodařilo se získat informace o uživateli."); } return user; }
        async function fetchUserProfile(userId) { if (!userId || !supabaseClient) return null; try { const { data: profile, error } = await supabaseClient.from('profiles').select('*').eq('id', userId).single(); if (error && error.code !== 'PGRST116') { throw error; } return profile; } catch (error) { console.error("Chyba načtení profilu:", error); return null; } }
        function updateUserInfoUI(profileData, userEmail) { const displayName = `${profileData?.first_name || ''} ${profileData?.last_name || ''}`.trim() || profileData?.username || userEmail?.split('@')[0] || 'Student'; if(userName) userName.textContent = displayName; if(userAvatar) { if (profileData?.avatar_url) { userAvatar.innerHTML = `<img src="${profileData.avatar_url}" alt="Avatar">`; } else { const initials = getInitials(profileData || { email: userEmail }); userAvatar.textContent = initials; } } }
        async function checkExistingDiagnostic(userId) { /* ... (beze změny) ... */ }
        function setupEventListeners() {
            if (mobileMenuToggle) mobileMenuToggle.addEventListener('click', toggleMobileMenu);
            planTabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
             // Tlačítko zpět v detailu historického plánu (v planSection)
             const backBtnDetail = planSection.querySelector('.step-navigation button'); // Předpokládáme, že je tam jedno
             if (backBtnDetail) {
                 backBtnDetail.id = 'backToHistoryBtn'; // Přejmenujeme pro srozumitelnost
                 backBtnDetail.addEventListener('click', () => switchTab('history'));
             }
            // Tlačítko zpět v harmonogramu (v scheduleSection)
            if (backToTabsBtn) {
                 backToTabsBtn.addEventListener('click', () => {
                     // Jednoduchý návrat k záložkám - skryje detail, zobrazí první (current) záložku
                     scheduleSection.style.display = 'none';
                     historyPlanSection.style.display = 'none';
                     createPlanSection.style.display = 'none';
                     planSection.style.display = 'none';
                     switchTab('current'); // Znovu načte stav aktuální záložky
                 });
            }
        }
        async function switchTab(tabId) {
            if (!supabaseClient) { showGlobalError("Aplikace není správně inicializována (chybí Supabase)."); return; }
            currentTab = tabId;
            planTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabId);
            });
            // Skryj VŠECHNY hlavní sekce
            currentPlanSection.style.display = 'none';
            historyPlanSection.style.display = 'none';
            createPlanSection.style.display = 'none';
            planSection.style.display = 'none';
            scheduleSection.style.display = 'none';

            // Zobraz správnou sekci podle tabId
            if (tabId === 'current') {
                // currentPlanSection bude použita jen pro zobrazení loaderu nebo výzvy/chyby
                // Samotný plán se zobrazí v scheduleSection
                currentPlanSection.style.display = 'block'; // Zobrazí kontejner (kde je loader/výzva)
                await loadCurrentPlan(); // Tato funkce rozhodne, co zobrazit (harmonogram nebo výzvu)
            } else if (tabId === 'history') {
                historyPlanSection.style.display = 'block';
                await loadPlanHistory();
            } else if (tabId === 'create') {
                createPlanSection.style.display = 'block';
                await checkPlanCreationAvailability();
            }
        }

        // ==============================================
        //          Aktuální Plán (Zobrazuje harmonogram nebo výzvu)
        // ==============================================
        async function loadCurrentPlan() {
            if (!supabaseClient) {
                console.error("Nelze načíst plán: Supabase client není inicializován.");
                currentPlanContent.innerHTML = `<div class="notest-message error"><h3>Chyba</h3><p>Aplikace není správně inicializována.</p></div>`;
                currentPlanSection.style.display = 'block'; // Zobrazí chybovou zprávu v sekci current
                hideLoader(currentPlanLoader);
                return;
            }
            showLoader(currentPlanSection, currentPlanLoader); // Zobrazí loader v currentPlanSection
            currentPlanContent.innerHTML = ''; // Vyčistí obsah pro případnou výzvu
            scheduleSection.style.display = 'none'; // Skryje harmonogram pro jistotu
            planSection.style.display = 'none'; // Skryje detail

            try {
                if (!currentUser) throw new Error('Uživatel není přihlášen');
                const { data: plans, error } = await supabaseClient
                    .from('study_plans')
                    .select('*') // Vybíráme vše, včetně markdownu pro případný export
                    .eq('user_id', currentUser.id)
                    .eq('status', 'active')
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (plans && plans.length > 0) {
                    currentStudyPlan = plans[0];
                    // Aktivní plán nalezen -> skryjeme currentPlanSection a zobrazíme harmonogram
                    currentPlanSection.style.display = 'none';
                    await showFullSchedule(currentStudyPlan); // Zobrazí detailní harmonogram
                } else {
                    // Žádný aktivní plán -> zobrazíme výzvu v currentPlanSection
                    currentStudyPlan = null;
                    currentPlanSection.style.display = 'block'; // Ujistíme se, že sekce pro výzvu je vidět
                    const diagnostic = await getLatestDiagnostic();
                    if (diagnostic) {
                        renderPromptCreatePlan(); // Zobrazí výzvu k vytvoření plánu v currentPlanContent
                    } else {
                        renderNoDiagnosticAvailable(currentPlanContent); // Zobrazí zprávu o chybějícím testu v currentPlanContent
                    }
                }
            } catch (error) {
                console.error('Chyba při načítání aktuálního plánu:', error);
                currentPlanContent.innerHTML = `<div class="notest-message error"><h3><i class="fas fa-exclamation-circle"></i> Chyba</h3><p>Nepodařilo se načíst aktuální plán.</p></div>`;
                currentPlanSection.style.display = 'block'; // Zobrazí chybu v currentPlanSection
            } finally {
                hideLoader(currentPlanLoader);
                initTooltips(); // Re-inicializace pro případně přidaná tlačítka
            }
        }

        // Funkce renderCurrentPlan byla odstraněna

        async function loadAndRenderActivities(planId, completedElement, todayScheduleElement) { /* ... (beze změny) ... */ }
        function renderDayActivities(activities, container, planId) { /* ... (beze změny) ... */ }
        async function handleActivityCompletionToggle(activityId, isCompleted, planId) { /* ... (beze změny) ... */ }
        async function updatePlanProgress(planId) {
            // Tato funkce už nebude přímo aktualizovat UI progress baru, protože byl odstraněn
            if (!planId || !supabaseClient) return;
            try {
                const { data: activities, error: activitiesError } = await supabaseClient.from('plan_activities').select('completed').eq('plan_id', planId);
                if (activitiesError) throw activitiesError;
                if (!activities || activities.length === 0) return;
                const completedCount = activities.filter(a => a.completed).length;
                const progress = Math.round((completedCount / activities.length) * 100);
                const { error: planUpdateError } = await supabaseClient.from('study_plans').update({ progress: progress, updated_at: new Date().toISOString() }).eq('id', planId);
                if (planUpdateError) throw planUpdateError;
                console.log(`Pokrok plánu ${planId} aktualizován na ${progress}%`);
                // Aktualizace v globální proměnné, pokud je to aktuální plán
                if (currentStudyPlan && currentStudyPlan.id === planId) {
                    currentStudyPlan.progress = progress;
                }
                // Aktualizace UI pro počet dokončených aktivit, pokud je zobrazen harmonogram
                if (scheduleSection.style.display === 'block') {
                     const header = scheduleSection.querySelector('.plan-header-dynamic');
                     if (header) {
                         // Zde bychom mohli přidat zobrazení progressu, pokud bychom chtěli
                         // Např. přidáním elementu do headerDiv v showFullSchedule
                         // const progressTextElement = header.querySelector('.plan-progress-text');
                         // if(progressTextElement) progressTextElement.textContent = ` (${progress}%)`;
                     }
                }

            } catch (error) { console.error(`Chyba při aktualizaci pokroku plánu ${planId}:`, error); }
        }

         // Zobrazí detail HISTORICKÉHO plánu (Markdown)
         async function showPlanDetail(plan) {
             if (!plan || !plan.id || !supabaseClient) return;
             currentPlanSection.style.display = 'none';
             historyPlanSection.style.display = 'none';
             createPlanSection.style.display = 'none';
             scheduleSection.style.display = 'none'; // Skryje i harmonogram
             planSection.style.display = 'block'; // Zobrazí sekci pro detail
             showLoader(planSection, planLoading);
             planActions.style.display = 'none';
             planContent.style.display = 'none';

             // Přidání tlačítka Zpět specificky pro detail
             const backButtonContainer = planSection.querySelector('.step-navigation');
             if (backButtonContainer) {
                 backButtonContainer.innerHTML = `<button class="btn btn-secondary" id="backToHistoryFromDetailBtn"><i class="fas fa-arrow-left"></i> Zpět do Historie</button>`;
                 const backBtn = document.getElementById('backToHistoryFromDetailBtn');
                 if (backBtn) {
                     // Odstraníme starý listener, pokud existuje, a přidáme nový
                     backBtn.replaceWith(backBtn.cloneNode(true)); // Jednoduchý způsob odstranění všech listenerů
                     document.getElementById('backToHistoryFromDetailBtn').addEventListener('click', () => switchTab('history'));
                 }
             }


             try {
                 const { data: fullPlanData, error } = await supabaseClient
                     .from('study_plans')
                     .select('plan_content_markdown, title, created_at, estimated_completion_date') // Načteme potřebná data
                     .eq('id', plan.id)
                     .single();
                 if (error) throw error;

                 const planTitleElement = planSection.querySelector('.section-title');
                 if(planTitleElement) planTitleElement.textContent = fullPlanData.title || 'Detail studijního plánu';

                 displayPlanContent(fullPlanData.plan_content_markdown || '# Studijní plán\n\nObsah plánu není k dispozici.'); // Zobrazí Markdown

                 // Tlačítka pouze pro Export (Uložit a Regenerovat zde nemají smysl)
                 planActions.innerHTML = `
                     <button class="btn btn-success" id="exportDetailPlanBtn">
                         <i class="fas fa-file-export"></i> Export PDF
                     </button>
                 `;
                 document.getElementById('exportDetailPlanBtn').addEventListener('click', () => exportPlanToPDFWithStyle(fullPlanData)); // Použije plná načtená data
                 planActions.style.display = 'flex'; // Zobrazí tlačítka

                 planSection.scrollIntoView({ behavior: 'smooth' });
             } catch (error) {
                 console.error("Chyba načítání detailu plánu:", error);
                 planContent.innerHTML = `<div class="notest-message error"><h3>Chyba</h3><p>Nepodařilo se načíst detail plánu.</p></div>`;
                 planContent.style.display = 'block';
                 planActions.innerHTML = ''; // Skryje tlačítka při chybě
             } finally {
                 hideLoader(planLoading);
             }
         }

        // Zobrazí AKTIVNÍ detailní týdenní harmonogram
        async function showFullSchedule(plan) {
            if (!supabaseClient) { console.error("showFullSchedule: Supabase client is not initialized."); dailySchedule.innerHTML = '<p>Chyba: Aplikace není inicializována.</p>'; return; }
            if (!plan || !plan.id) { console.error("showFullSchedule: Invalid or missing plan object/ID.", plan); dailySchedule.innerHTML = '<p>Chyba: Nelze zobrazit harmonogram bez platného ID plánu.</p>'; return; }

            console.log(`showFullSchedule: Pokouším se zobrazit harmonogram pro Plan ID: ${plan.id}`, "Celý objekt plánu:", plan);

            // Skrytí ostatních sekcí a zobrazení harmonogramu
            currentPlanSection.style.display = 'none';
            historyPlanSection.style.display = 'none';
            createPlanSection.style.display = 'none';
            planSection.style.display = 'none';
            scheduleSection.style.display = 'block';

            // Odstranění starého dynamického záhlaví, pokud existuje
            const oldHeader = scheduleSection.querySelector('.plan-header-dynamic');
            if (oldHeader) {
                oldHeader.remove();
            }
             dailySchedule.innerHTML = '<div class="loader-container"><div class="loader"></div></div>'; // Zobrazí loader

             // Přidání dynamického záhlaví NAD dailySchedule
             const headerDiv = document.createElement('div');
             headerDiv.className = 'plan-header plan-header-dynamic'; // Přidána třída pro snadné nalezení/odstranění
             headerDiv.style.marginBottom = '1.5rem'; // Přidán odstup
             headerDiv.innerHTML = `
                 <div class="plan-meta">
                     <h2 class="section-title" style="margin-bottom: 0.5rem;">${sanitizeHTML(plan.title || 'Týdenní harmonogram')}</h2>
                     <span class="plan-date">Vytvořeno: ${formatDate(plan.created_at)}</span>
                     ${plan.estimated_completion_date ? `<br><span class="plan-date">Odhad. dokončení: ${formatDate(plan.estimated_completion_date)}</span>` : ''}
                 </div>
                 <div class="plan-actions">
                      <button class="btn btn-primary btn-tooltip" id="exportSchedulePlanBtnDynamic" title="Stáhnout plán jako PDF">
                          <i class="fas fa-file-export"></i> Export
                      </button>
                 </div>
             `;
             if (dailySchedule.parentNode) {
                dailySchedule.parentNode.insertBefore(headerDiv, dailySchedule);
             }

             const exportButton = headerDiv.querySelector('#exportSchedulePlanBtnDynamic');
             if (exportButton) {
                exportButton.addEventListener('click', async () => {
                    if (!plan.plan_content_markdown) { // Pokud markdown chybí v objektu
                        try {
                            console.log("Načítám plný markdown pro export...");
                            const { data: fullPlanData, error } = await supabaseClient.from('study_plans').select('plan_content_markdown').eq('id', plan.id).single();
                            if (error) throw error;
                            plan.plan_content_markdown = fullPlanData.plan_content_markdown; // Doplníme
                        } catch (fetchError) { console.error("Nepodařilo se načíst markdown pro export:", fetchError); showToast('Chyba: Nepodařilo se načíst data pro export.', 'error'); return; }
                    }
                    exportPlanToPDFWithStyle(plan); // Exportuje s markdownem
                });
                initTooltips(); // Re-inicializace pro nové tlačítko
             }

            // Úprava/ověření tlačítka Zpět (už by mělo být nastaveno v setupEventListeners)
            if (backToTabsBtn) {
                 backToTabsBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Zpět na záložky';
            } else {
                 console.warn("Tlačítko #backToTabsBtn nebylo nalezeno v scheduleSection.");
            }

            try {
                console.log(`showFullSchedule: Dotazuji se na aktivity s plan_id = ${plan.id}`);
                const { data: activities, error, status } = await supabaseClient
                    .from('plan_activities')
                    .select('*')
                    .eq('plan_id', plan.id)
                    .order('day_of_week')
                    .order('time_slot');

                if (error) { console.error(`showFullSchedule: Chyba při načítání aktivit z Supabase (Status: ${status}):`, error); throw new Error(`Nepodařilo se načíst aktivity: ${error.message}. Zkontrolujte také RLS.`); }
                console.log(`showFullSchedule: Aktivity získané ze Supabase (pro plan_id ${plan.id}):`, activities);
                renderWeeklySchedule(activities || [], plan.id);
                scheduleSection.scrollIntoView({ behavior: 'smooth' });

            } catch (error) { console.error("showFullSchedule: Celková chyba při zobrazování harmonogramu:", error); dailySchedule.innerHTML = `<p><i>Chyba při načítání nebo zobrazování harmonogramu: ${error.message}</i></p>`; }
        }

        function renderWeeklySchedule(activities, planId) { /* ... (beze změny) ... */ }

        function renderPromptCreatePlan() {
            const promptFragment = promptCreatePlanTemplate.content.cloneNode(true);
            promptFragment.getElementById('createNewPlanFromPromptBtn').addEventListener('click', () => switchTab('create'));
            currentPlanContent.innerHTML = ''; // Vyčistí předchozí obsah (např. loader)
            currentPlanContent.appendChild(promptFragment);
            currentPlanSection.style.display = 'block'; // Ujistí se, že sekce je viditelná
        }


        // ==============================================
        //          Historie Plánů (Beze změny)
        // ==============================================
        async function loadPlanHistory() { /* ... (beze změny) ... */ }
        function renderPlanHistory(plans) { /* ... (beze změny) ... */ }


        // ==============================================
        //          Vytvoření Nového Plánu (Menší úpravy v render a generate)
        // ==============================================
         async function getLatestDiagnostic() { /* ... (beze změny) ... */ }
         async function checkPlanCreationAvailability() { /* ... (beze změny) ... */ }
         function renderNoDiagnosticAvailable(container) { /* ... (beze změny) ... */ }
         function renderLockedPlanSection() { /* ... (beze změny) ... */ }
         function startPlanTimer() { /* ... (beze změny) ... */ }
         function updateNextPlanTimer(timerElement) { /* ... (beze změny) ... */ }
         function getDeclension(number, singular, plural1, plural2) { /* ... (beze změny) ... */ }
         function renderPlanCreationForm() { /* ... (beze změny) ... */ }

        // ==============================================
        //          Generování a Ukládání Plánu
        // ==============================================
         async function generateStudyPlan() {
             if (!latestDiagnosticData || !currentUser) { /* ... (chybová hláška beze změny) ... */ return; }
             createPlanSection.style.display = 'none'; // Skryje sekci pro vytvoření
             planSection.style.display = 'block'; // Zobrazí sekci pro potvrzení/loader
             showLoader(planSection, planLoading);
             planActions.style.display = 'none';
             planContent.style.display = 'none';
             lastGeneratedMarkdown = null;
             lastGeneratedActivitiesJson = null;

             try {
                  const topicsData = Object.entries(latestDiagnosticData.topic_results || {}).map(([topicKey, data]) => ({ name: data.name || topicMap[topicKey] || `Téma ${topicKey}`, questions: data.total || 0, correct: data.correct || 0, percentage: data.score || 0 })).sort((a, b) => a.percentage - b.percentage);
                  const fullMarkdownResponse = await generatePlanContentWithGemini(latestDiagnosticData, topicsData);
                  console.log("Полный ответ Gemini (перед извлечением JSON):\n", fullMarkdownResponse);

                  const jsonRegex = /```json\s*([\s\S]*?)\s*```/;
                  const jsonMatch = fullMarkdownResponse.match(jsonRegex);
                  let activitiesArray = null;
                  let planMarkdownForStorage = fullMarkdownResponse;

                  if (jsonMatch && jsonMatch[1]) {
                      const cleanedJsonString = jsonMatch[1].replace(/\u00A0/g, ' ').trim();
                      try {
                           activitiesArray = JSON.parse(cleanedJsonString);
                           planMarkdownForStorage = fullMarkdownResponse.replace(jsonRegex, '').trim();
                           lastGeneratedActivitiesJson = activitiesArray;
                           console.log("Extrahované и очищенные активности (JSON):", activitiesArray);
                      } catch (parseError) {
                           console.error("Chyba parsování OČIŠTĚNÉHO JSON z odpovědi Gemini:", parseError, "Původní extrahovaný string:", jsonMatch[1], "Očištěný string:", cleanedJsonString);
                           showToast("Varování: Nepodařilo se správně zpracovat aktivity z plánu pro harmonogram.", "warning");
                           lastGeneratedActivitiesJson = null; // Reset v případě chyby
                      }
                  } else { console.warn("JSON blok s aktivitami nebyl nalezen v odpovědi Gemini."); lastGeneratedActivitiesJson = null; }

                  lastGeneratedMarkdown = planMarkdownForStorage;
                  displayPlanGenerationConfirmation(); // Zobrazí jen potvrzení

                  // Tlačítka pro uložení, export, regeneraci
                  planActions.innerHTML = `
                     <button class="btn btn-primary" id="saveGeneratedPlanBtn"> <i class="fas fa-save"></i> Uložit tento plán </button>
                     <button class="btn btn-success" id="exportGeneratedPlanBtn"> <i class="fas fa-file-export"></i> Exportovat do PDF </button>
                     <button class="btn btn-secondary" id="regeneratePlanBtn"> <i class="fas fa-sync-alt"></i> Vygenerovat znovu </button>
                  `;
                  document.getElementById('saveGeneratedPlanBtn').addEventListener('click', () => saveGeneratedPlan(lastGeneratedMarkdown, lastGeneratedActivitiesJson, topicsData));
                  // Export používá poslední vygenerovaný markdown
                  document.getElementById('exportGeneratedPlanBtn').addEventListener('click', () => exportPlanToPDFWithStyle({ created_at: new Date(), plan_content_markdown: lastGeneratedMarkdown, title: "Nový návrh plánu" }));
                  document.getElementById('regeneratePlanBtn').addEventListener('click', () => { /* ... (logika pro regeneraci) ... */ generateStudyPlan(); });
                  planActions.style.display = 'flex';

                 // Tlačítko zpět v sekci planSection po generování
                 const backButtonContainer = planSection.querySelector('.step-navigation');
                 if (backButtonContainer) {
                     backButtonContainer.innerHTML = `<button class="btn btn-secondary" id="backToCreateFromGenBtn"><i class="fas fa-arrow-left"></i> Zpět k Vytvoření</button>`;
                     const backBtn = document.getElementById('backToCreateFromGenBtn');
                     if (backBtn) {
                         backBtn.replaceWith(backBtn.cloneNode(true)); // Odstraní listenery
                         document.getElementById('backToCreateFromGenBtn').addEventListener('click', () => switchTab('create')); // Vrátí na záložku Vytvořit
                     }
                 }


             } catch (error) {
                console.error('Chyba při generování studijního plánu:', error);
                planContent.innerHTML = `<div class="notest-message error"><h3>Chyba generování</h3><p>${error.message}</p></div>`;
                planContent.style.display = 'block';
                planActions.innerHTML = `<button class="btn btn-secondary" id="regeneratePlanBtn"> <i class="fas fa-sync-alt"></i> Vygenerovat znovu </button>`;
                document.getElementById('regeneratePlanBtn').addEventListener('click', () => { /* ... (logika pro regeneraci) ... */ generateStudyPlan(); });
                planActions.style.display = 'flex';
                // Tlačítko zpět i při chybě
                 const backButtonContainer = planSection.querySelector('.step-navigation');
                 if (backButtonContainer) {
                     backButtonContainer.innerHTML = `<button class="btn btn-secondary" id="backToCreateFromGenErrorBtn"><i class="fas fa-arrow-left"></i> Zpět k Vytvoření</button>`;
                     const backBtn = document.getElementById('backToCreateFromGenErrorBtn');
                     if (backBtn) {
                         backBtn.replaceWith(backBtn.cloneNode(true));
                         document.getElementById('backToCreateFromGenErrorBtn').addEventListener('click', () => switchTab('create'));
                     }
                 }
             } finally { hideLoader(planLoading); }
         }

        async function generatePlanContentWithGemini(testData, topicsData) {
             if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') { /* ... (kontrola klíče) ... */ }
             try {
                 const totalScore = testData.total_score || 0;
                 const totalQuestions = testData.total_questions || 1; // Upraveno na 1 pro dělení nulou
                 const analysis = testData.analysis || {};
                 const overallAssessment = analysis.summary?.overall_assessment || 'N/A';
                 const strengths = analysis.strengths?.map(s => `${s.topic} (${s.score}%)`).join(', ') || 'Nebyly identifikovány';
                 const weaknesses = analysis.weaknesses?.map(w => `${w.topic} (${w.score}%)`).join(', ') || 'Nebyly identifikovány';
                 const recommendations = analysis.recommendations?.join('\n- ') || 'Žádná specifická.';

                 const prompt = `
                 Jsi expertní AI tutor specializující se na přípravu na PŘIJÍMACÍ ZKOUŠKY z matematiky pro 9. třídu ZŠ v Česku. Tvým úkolem je vytvořit NÁROČNÝ, DETAILNÍ a KONZISTENTNÍ týdenní studijní plán v ČEŠTINĚ ve formátu Markdown, zaměřený na dosažení co nejlepšího výsledku u zkoušek. Na konci MUSÍŠ vygenerovat JSON pole aktivit pro tento plán, které PŘESNĚ ODRÁŽÍ obsah Markdown plánu pro daný den.

                 # Kontext: Student právě dokončil diagnostický test.
                 # Výsledky diagnostického testu:
                 - Celkové skóre: ${totalScore}/50 bodů
                 - Počet otázek: ${totalQuestions}
                 - Výsledky podle témat (Název tématu: Plně správně/Celkem otázek (Úspěšnost %)):
                 ${topicsData.map(topic => `  - ${topic.name}: ${topic.correct}/${topic.questions} (${topic.percentage}%)`).join('\n')}
                 # Analýza výsledků testu (Shrnutí od AI):
                 - Celkové hodnocení: ${overallAssessment}
                 - Identifikované silné stránky: ${strengths}
                 - Identifikované slabé stránky: ${weaknesses}
                 - Doporučení na základě testu: - ${recommendations}

                 # Oficiální Témata Zkoušky (CERMAT - detailně):
                 1.  **Čísla a aritmetické operace:** Přirozená čísla (do milionu), nula. Sčítání, odčítání, násobení, dělení (vlastnosti, algoritmy). Zlomky (porovnávání, sčítání/odčítání se stejným jm.). Desetinná čísla, číselná osa.
                 2.  **Algebra:** Mocniny, odmocniny (základní operace). Lineární rovnice (jedna neznámá, úpravy). Soustavy 2 lineárních rovnic (dosazovací, sčítací metoda). Mnohočleny (sčítání, odčítání, násobení, vytýkání, vzorce (a±b)², a²-b²). Výrazy s proměnnými (dosazování, úpravy).
                 3.  **Geometrie:** Základní rovinné útvary (čtverec, obdélník, trojúhelník - typy, vlastnosti, věty; kruh/kružnice - části, vlastnosti). Kreslení, náčrty. Kolmost, rovnoběžnost. Obvod, obsah rovinných útvarů. Povrch a objem těles (krychle, kvádr, válec; základy kužele, koule). Pythagorova věta. Základní konstrukční úlohy.
                 4.  **Práce s daty:** Tabulky, diagramy (čtení, interpretace, jednoduchá tvorba). Aritmetický průměr, modus, medián. Grafy závislostí (čtení, interpretace).
                 5.  **Problémové úlohy:** Slovní úlohy (převod na matematický model, řešení). Úlohy na poměr, přímá a nepřímá úměrnost, měřítko mapy. Úlohy na pohyb, společnou práci (základní typy). Aplikace matematiky. Strategie řešení.
                 6.  **Proporce a procenta:** Procento, promile. Procentová část, základ, počet procent. Jednoduché úrokování. Trojčlenka. Poměr (základní úpravy, rozdělení).
                 7.  **Logické úlohy:** Logické vztahy, jednoduché výroky, číselné řady, vzory, závislosti.

                 # TVŮJ ÚKOL (Vytvoř NÁROČNÝ, DETAILNÍ a KONZISTENTNÍ plán):
                 1.  Vytvoř DETAILNÍ týdenní studijní plán (Pondělí - Neděle) ve formátu Markdown. Musí být strukturovaný, srozumitelný a zaměřený na VÝRAZNÉ zlepšení. Dbej na přirozené formátování textu, vyhni se slovům nalepeným na sebe bez mezer.
                 2.  Plán musí pokrývat klíčové oblasti z OFICIÁLNÍCH TÉMAT, klást ZVÝŠENÝ DŮRAZ na slabé stránky (${weaknesses}), ale ZAHRNOVAT i OPAKOVÁNÍ silnějších stránek.
                 3.  Navrhni RŮZNORODÉ a KONKRÉTNÍ aktivity:
                     * Řešení KONKRÉTNÍCH TYPŮ příkladů s uvedením POČTU.
                     * Procvičování SLOVNÍCH ÚLOH zaměřených na dané téma.
                     * Používej formulace jako 'Opakování [téma/vzorce]' místo 'Opakuj [téma]'. Např.: 'Opakování vzorců pro mnohočleny'.
                     * Analýzu VYSVĚTLENÝCH příkladů (např. "Projdi řešené příklady na ...").
                     * Doporučení k ANALÝZE minulých chyb.
                     * Zařazení NÁROČNĚJŠÍCH úloh u silnějších témat.
                 4.  Buď co nejvíce SPECIFICKÝ v popisu úkolů v Markdown i JSON. Místo 'Procvičuj geometrii' uveď 'Výpočet obvodů a obsahů složených rovinných útvarů (3 úlohy)'.
                 5.  Rozděl denní studium (cca 75-100 minut) do 2-3 INTENZIVNÍCH bloků. Uveď odhadovaný čas.
                 6.  **DŮLEŽITÉ:** V poli 'description' v JSON bloku **NEUVÁDĚJ KONKRÉTNÍ ROVNICE NEBO ČÍSELNÉ ZADÁNÍ PŘÍKLADŮ**. Místo toho SLOVNĚ popiš TYP úloh, počet a zaměření (např. 'Řešení 5 lineárních rovnic se zlomky', 'Výpočet procentové části ze základu ve 4 slovních úlohách').
                 7.  **NAPROSTÁ KONZISTENCE JE KLÍČOVÁ:** JSON \`title\` a \`description\` musí být PŘÍMÝM a VĚRNÝM shrnutím aktivity popsané v odpovídajícím bloku v Markdown textu pro ten samý den a časový úsek. Žádné informace nesmí být v JSON přidány ani vynechány oproti Markdown popisu daného bloku.
                 8.  NA KONEC celého Markdown textu PŘIDEJ validní JSON blok (\`\`\`json ... \`\`\`) obsahující pole objektů pro VŠECHNY aktivity. Klíče: "day_of_week" (číslo 0-6, Neděle=0), "title" (string, název bloku), "description" (string, SLOVNÍ popis TYPU úkolů, KONZISTENTNÍ s Markdown), "time_slot" (string, čas).

                 # Požadovaný formát výstupu (Markdown + JSON na konci):
                 **Analýza diagnostiky:**
                 * Zaměření na: ${weaknesses}
                 * Udržování: ${strengths}
                 **Hlavní cíle pro tento týden:**
                 * [Použij odrážky] Výrazně zlepšit [Nejslabší téma].
                 * [Použij odrážky] Upevnit znalosti v [Druhé nejslabší téma].
                 * [Použij odrážky] Zopakovat a procvičit [Silnější téma].
                 ---
                 ### Pondělí
                 * **Fokus dne:** [Např. Složitější lineární rovnice a aplikace procent]
                 * **Blok 1 (cca 45 min): Algebra - Rovnice:** Řešení 10 složitějších lineárních rovnic se zlomky a závorkami. Důraz na správné úpravy a zkoušku.
                 * **Blok 2 (cca 40 min): Procenta - Slovní úlohy:** Řešení 5 slovních úloh na výpočet základu a procentové změny (zdražení/sleva).
                 * *Tip dne:* U rovnic si piš mezikroky a ověřuj si je.
                 ### Úterý
                 * **Fokus dne:** [Např. Geometrie - Tělesa a opakování mnohočlenů]
                 * **Blok 1 (cca 50 min): Geometrie - Objem a povrch válce:** Opakování vzorců. Výpočet objemu a povrchu válce ve 4 úlohách (včetně slovních).
                 * **Blok 2 (cca 30 min): Opakování - Mnohočleny:** Opakování vzorců (a±b)², a²-b². Rozklad 10 mnohočlenů na součin pomocí vytýkání a vzorců.
                 * *Tip dne:* Kresli si náčrty těles, pomůže ti to s představivostí.
                 * ... (atd. pro všechny dny) ...
                 ---
                 **Obecné tipy pro maximální efektivitu:**
                 * ...

                 \`\`\`json
                 [
                   { "day_of_week": 1, "title": "Algebra: Složitější rovnice", "description": "Řešení 10 složitějších lineárních rovnic se zlomky a závorkami. Důraz na správné úpravy a zkoušku.", "time_slot": "45 min" },
                   { "day_of_week": 1, "title": "Procenta: Slovní úlohy (základ, změna)", "description": "Řešení 5 slovních úloh na výpočet základu a procentové změny (zdražení/sleva).", "time_slot": "40 min" },
                   { "day_of_week": 2, "title": "Geometrie: Objem a povrch válce", "description": "Opakování vzorců. Výpočet objemu a povrchu válce ve 4 úlohách (včetně slovních).", "time_slot": "50 min" },
                   { "day_of_week": 2, "title": "Opakování: Rozklad mnohočlenů", "description": "Opakování vzorců (a±b)², a²-b². Rozklad 10 mnohočlenů na součin pomocí vytýkání a vzorců.", "time_slot": "30 min" }
                   // ... (další aktivity pro všechny dny, KONZISTENTNÍ S MARKDOWNEM) ...
                 ]
                 \`\`\`
                 `;

                 const requestData = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.6, topK: 40, topP: 0.95, maxOutputTokens: 8192 } };
                 const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData) });
                 const data = await response.json(); if (!response.ok) { console.error("Chyba Gemini API:", data); throw new Error(data.error?.message || `Chyba při komunikaci s Gemini API (${response.status})`); }
                 const geminiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text; if (!geminiResponse) { throw new Error('Prázdná odpověď od Gemini API'); }
                 return geminiResponse;
             } catch (error) {
                 console.error('Chyba při generování obsahu plánu:', error);
                 return `## Chyba při generování plánu\n\nBohužel se nepodařilo vygenerovat váš personalizovaný studijní plán.\n\n**Důvod:** ${error.message}\n\nZkuste to prosím později, nebo kontaktujte podporu. Ujistěte se, že máte platný Gemini API klíč.`;
             }
        }

         function displayPlanGenerationConfirmation() {
              planContent.innerHTML = `
                  <h3><i class="fas fa-check-circle" style="color: var(--success);"></i> Plán vygenerován!</h3>
                  <p>Váš detailní týdenní studijní plán byl úspěšně vygenerován.</p>
                  <p><strong>Uložte plán</strong>, aby se stal aktivním a jeho aktivity se zobrazily v harmonogramu. Můžete jej také exportovat nebo zkusit vygenerovat znovu.</p>
              `;
              planContent.style.display = 'block';
              hideLoader(planLoading);
         }

        async function saveGeneratedPlan(markdownContent, activitiesArray, topicsData) { /* ... (beze změny) ... */ }

        // Zobrazí Markdown obsah (používá se pro historické plány)
        function displayPlanContent(markdownContent) {
             if (!planContent) return;
             try {
                const htmlContent = marked.parse(markdownContent || '');
                planContent.innerHTML = htmlContent;
                planContent.style.display = 'block';
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                     setTimeout(() => { window.MathJax.typesetPromise([planContent]).catch(e => console.error("MathJax chyba:", e)); }, 0);
                 }
             } catch (e) {
                 console.error("Chyba při renderování Markdown:", e);
                 planContent.innerHTML = "<p>Chyba při zobrazování obsahu plánu.</p>";
                 planContent.style.display = 'block';
             }
         }

        // ==============================================
        //          Pomocné UI Funkce (Export PDF)
        // ==============================================
        // Funkce initProgressCircle a updateProgressCircle byly odstraněny

        function exportPlanToPDFWithStyle(plan) {
             if (!plan) return;
             // Zajistíme, že máme markdown pro export
             if (!plan.plan_content_markdown) {
                 console.warn("Chybí markdown obsah pro export PDF v objektu plánu.");
                 showToast('Chyba: Chybí data pro export PDF.', 'error');
                 // Zde bychom mohli zkusit znovu načíst data, pokud je to nutné
                 // Např. voláním: await loadFullPlanMarkdown(plan.id); a pak znovu exportovat
                 return;
             }

             const exportContainer = document.createElement('div');
             exportContainer.style.padding = '25px';
             exportContainer.style.fontFamily = '"Poppins", Arial, sans-serif';
             exportContainer.style.fontSize = '11pt';
             exportContainer.style.color = '#333';
             exportContainer.style.lineHeight = '1.6';

             const pdfTitle = plan.title ? plan.title.replace(/\s*\(\d{2}\.\d{2}\.\d{4}\)$/, '').trim() : 'Studijní plán';
             exportContainer.innerHTML = `<div style="text-align: center; margin-bottom: 30px;"><h1 style="color: #4361ee; font-size: 22pt; margin-bottom: 10px;">${sanitizeHTML(pdfTitle)}</h1><p style="color: #6c757d; font-size: 11pt;">Vytvořeno: ${formatDate(plan.created_at)}</p></div>`;

             if (currentUser && userName.textContent) { /* ... (info o studentovi beze změny) ... */ }

             const contentElement = document.createElement('div');
             try {
                 contentElement.innerHTML = marked.parse(plan.plan_content_markdown); // Použijeme markdown z objektu
             } catch (e) { console.error("Chyba při parsování Markdown pro PDF:", e); contentElement.innerHTML = '<p>Chyba při zpracování obsahu plánu.</p>'; }

             let dayCounter = 0;
             const daysCzech = ['Pondělí', 'Úterý', 'Středa', 'Čtvrtek', 'Pátek', 'Sobota', 'Neděle'];

             contentElement.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach((heading) => {
                heading.style.color = '#3f37c9'; heading.style.marginTop = '25px'; heading.style.marginBottom = '10px'; heading.style.borderBottom = '1px solid #eee'; heading.style.paddingBottom = '5px';
                 if (heading.tagName === 'H3' && daysCzech.some(day => heading.textContent.includes(day))) {
                      if (dayCounter > 0 && (dayCounter % 2) === 0) { heading.style.breakBefore = 'page'; heading.style.pageBreakBefore = 'always'; console.log(`Applying page break before: ${heading.textContent}`); }
                      dayCounter++;
                 }
             });
             contentElement.querySelectorAll('ul, ol').forEach(list => { list.style.marginLeft = '20px'; list.style.marginBottom = '15px'; });
             contentElement.querySelectorAll('p, li').forEach(el => { el.style.lineHeight = '1.6'; el.style.marginBottom = '8px'; el.style.color = '#333'; });
             contentElement.querySelectorAll('strong').forEach(el => { el.style.fontWeight = '600'; el.style.color = '#111'; });
             contentElement.querySelectorAll('code').forEach(el => { el.style.backgroundColor = '#f0f0f0'; el.style.padding = '2px 4px'; el.style.borderRadius = '3px'; el.style.fontSize = '90%'; el.style.color = '#c7254e'; });
             contentElement.querySelectorAll('blockquote').forEach(el => { el.style.borderLeft = '3px solid #ccc'; el.style.paddingLeft = '15px'; el.style.marginLeft = '0'; el.style.fontStyle = 'italic'; el.style.color = '#555'; });
             exportContainer.appendChild(contentElement);

             exportContainer.innerHTML += `<div style="margin-top: 40px; border-top: 1px solid #dee2e6; padding-top: 15px; text-align: center; color: #888; font-size: 10pt;">&copy; ${new Date().getFullYear()} Justax.space</div>`;

             const options = { margin: [15, 10, 15, 10], filename: `studijni-plan-${formatDate(plan.created_at).replace(/\./g, '-')}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, logging: false }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: ['css', 'avoid-all'] } };

             if (typeof html2pdf === 'function') {
                 console.log("Starting PDF generation...");
                 html2pdf().set(options).from(exportContainer).save().then(() => { console.log("PDF generation finished."); showToast('PDF bylo úspěšně vygenerováno!', 'success'); }).catch(err => { console.error("Chyba exportu PDF:", err); showToast('Nepodařilo se exportovat PDF.', 'error'); });
             } else { console.error("html2pdf library is not loaded."); showToast('Chyba: Knihovna pro export PDF není načtena.', 'error'); }
        }


        // ==============================================
        //          Spuštění Aplikace
        // ==============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded and parsed, starting application initialization...");
            initializeApp();
        });

    </script>
</body>
</html>