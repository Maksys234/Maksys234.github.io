<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Studijní plán</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        if (typeof window.MathJax === 'undefined') {
            window.MathJax = {
                tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']], processEscapes: true },
                options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], ignoreHtmlClass: 'tex2jax_ignore' },
                startup: { ready: () => { MathJax.startup.defaultReady(); MathJax.startup.promise.then(() => console.log('MathJax loaded and ready.')); } }
            };
        } else { console.warn("window.MathJax already defined."); }
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- START: FINÁLNÍ VYLEPŠENÉ CSS STYLY (v2) --- */
        :root {
            /* Paleta barev (Převzato z dashboard.html) */
            --primary-rgb: 67, 97, 238; --primary: #4361ee; --primary-light: #4895ef; --primary-dark: #3a0ca3;
            --secondary-rgb: 63, 55, 201; --secondary: #3f37c9;
            --success-rgb: 16, 185, 129; --success: #10b981; --success-light: #a7f3d0; --success-bg: #f0fdf4;
            --danger-rgb: 247, 37, 133; --danger: #f72585; --danger-light: #fecdd3; --danger-bg: #fff1f2;
            --warning-rgb: 248, 150, 30; --warning: #f8961e; --warning-light: #fed7aa; --warning-bg: #fffbeb;
            --info-rgb: 72, 149, 239; --info: #4895ef; --info-light: #bfdbfe; --info-bg: #eff6ff;
            --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d;
            --gray-100: #f8f9fa; --gray-200: #e9ecef; --gray-300: #dee2e6;
            --gray-400: #ced4da; --gray-500: #adb5bd; --gray-600: #6c757d;
            --gray-700: #495057; --gray-800: #343a40; --gray-900: #212529;
            --white: #ffffff; --black: #000000;
            --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3);
            --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee);
            --gradient-3: linear-gradient(135deg, #f72585, #7209b7);
            --gradient-4: linear-gradient(135deg, #f8961e, #f3722c);

            /* Sémantické barvy */
            --bg-color: #f9fafb; /* Světlejší pozadí */
            --card-bg-color: var(--white);
            --card-bg-color-rgb: 255, 255, 255;
            --text-primary: var(--gray-800); /* Tmavší primární text */
            --text-secondary: #4a5568; /* Standardní sekundární */
            --text-muted: #718096; /* Standardní tlumený */
            --border-color: var(--gray-200); /* Světlejší okraje */
            --input-bg: var(--white);
            --input-border: var(--gray-300);
            --skeleton-bg: #f3f4f6;
            --skeleton-highlight: #e5e7eb;

            /* Rozměry a přechody */
            --sidebar-width: 260px;
            --transition-speed: 0.3s;
            --transition-bezier: cubic-bezier(0.4, 0, 0.2, 1);
            --card-radius: 16px; /* Větší zaoblení */
            --button-radius: 10px; /* Zaoblenější tlačítka */
            --form-element-radius: 8px;

            /* Stíny */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-sm: 0 3px 6px rgba(0, 0, 0, 0.05); /* Jemnější */
            --shadow-md: 0 5px 10px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.08);
        }
        /* Základní styly */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--bg-color); color: var(--text-primary); min-height: 100vh; display: flex; overflow: hidden; line-height: 1.65; /* Větší řádkování */ font-size: 15px; }

        /* --- Sidebar (Konzistentní s dashboard.html) --- */
        .sidebar { /* ... (stejné jako předtím) ... */ width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 1000; box-shadow: var(--shadow-lg); transition: transform var(--transition-speed) var(--transition-bezier), width var(--transition-speed) var(--transition-bezier); }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; position: relative; min-height: 40px; }
        #sidebar-close-toggle { display: none; position: absolute; right: -5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: rgba(255, 255, 255, 0.8); font-size: 1.6rem; cursor: pointer; padding: 0.5rem; line-height: 1; }
        #sidebar-close-toggle:hover { color: var(--white); }
        .sidebar-logo { font-size: 1.5rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo i { font-size: 1.75rem; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
         .sidebar-menu::-webkit-scrollbar { width: 5px; }
         .sidebar-menu::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 3px;}
         .sidebar-menu::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.3); border-radius: 3px; }
         .sidebar-menu::-webkit-scrollbar-thumb:hover { background-color: rgba(255, 255, 255, 0.5); }
         .sidebar-menu { scrollbar-width: thin; scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.05); }
        .sidebar-item { margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.8rem 1rem; color: rgba(255, 255, 255, 0.85); text-decoration: none; border-radius: var(--button-radius); transition: background-color 0.2s ease, color 0.2s ease; font-weight: 500; position: relative; }
        .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; width: 24px; text-align: center; transition: transform 0.2s ease; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--white); }
        .sidebar-link:hover i { transform: scale(1.1); }
        .sidebar-link.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); height: 60%; width: 4px; background-color: var(--white); border-radius: 0 3px 3px 0; }
        .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); text-align: center; flex-shrink: 0;}
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.08); border-radius: 12px; border: 1px solid rgba(255,255,255, 0.1); transition: background-color 0.2s ease; flex-shrink: 0;}
        .user-profile:hover { background-color: rgba(255, 255, 255, 0.15); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-weight: 500; overflow: hidden; color: var(--white); border: 2px solid rgba(255,255,255, 0.3); flex-shrink: 0;}
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; overflow: hidden; }
        .user-name { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-role { font-size: 0.8rem; opacity: 0.8; white-space: nowrap; }
        /* --- Konec Sidebar --- */

        /* --- Hlavní obsah --- */
        main { flex: 1; margin-left: var(--sidebar-width); padding: 1.5rem 2rem; transition: margin var(--transition-speed) var(--transition-bezier); width: calc(100% - var(--sidebar-width)); overflow-y: auto; height: 100vh; }
        main.loaded { display: block; animation: fadeInMain 0.4s ease-out forwards; }
        @keyframes fadeInMain { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Záhlaví (převzato z dashboard.html) --- */
        .dashboard-header { margin-bottom: 2.5rem; /* Větší odsazení */ background-color: transparent; /* Průhledné v základu */ border-radius: 0; padding: 0.5rem 0; /* Menší vertikální padding */ box-shadow: none; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; position: sticky; top: 0; z-index: 900; border-bottom: 1px solid var(--border-color); transition: box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease, padding 0.2s ease; }
        body.scrolled .dashboard-header { padding: 1rem 1.75rem; margin: 0 -2rem 2.5rem -2rem; /* Vynulovat padding main */ background-color: rgba(var(--card-bg-color-rgb), 0.9); backdrop-filter: blur(8px); border-radius: 0 0 var(--card-radius) var(--card-radius); box-shadow: var(--shadow-md); border-bottom-color: transparent; }
        .header-title { display: flex; align-items: center; gap: 0.8rem; flex-grow: 1; }
        .header-title h1 { font-size: 1.7rem; /* Trochu větší */ font-weight: 600; color: var(--text-primary); margin: 0; }
        /* --- Konec Záhlaví --- */

        /* --- Všeobecné styly pro sekce a tlačítka --- */
        .main-content-wrapper { display: flex; flex-direction: column; gap: 2rem; }
        .section { background-color: var(--card-bg-color); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); padding: 2rem; /* Větší padding */ border: 1px solid var(--border-color); animation: fadeIn 0.5s ease forwards; opacity: 0; position: relative; overflow: hidden; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 1.4rem; font-weight: 600; margin: -2rem -2rem 1.75rem -2rem; /* Vytažení nad padding */ padding: 1.25rem 2rem; /* Vlastní padding */ color: var(--text-primary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 0.75rem; background-color: rgba(var(--primary-rgb), 0.02); }
        .section-title i { font-size: 1rem; color: var(--primary); width: 24px; text-align: center;}
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.8rem 1.6rem; /* Mírně větší */ border-radius: var(--button-radius); font-weight: 500; font-size: 0.95rem; text-decoration: none; transition: all 0.2s var(--transition-bezier); cursor: pointer; border: none; gap: 0.6rem; line-height: 1.4; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(var(--primary-rgb), 0.2); }
        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(var(--primary-rgb), 0.25); }
        .btn-secondary { background-color: var(--card-bg-color); color: var(--text-secondary); border: 1px solid var(--border-color); box-shadow: var(--shadow-xs); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--gray-100); border-color: var(--gray-300); color: var(--text-primary); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 2px 5px rgba(var(--success-rgb), 0.2); }
        .btn-success:hover:not(:disabled) { background: var(--success-dark); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(var(--success-rgb), 0.25); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn i { font-size: 1em; transition: transform 0.2s ease; }
        .btn:hover:not(:disabled) i.fa-sync-alt { transform: rotate(90deg); }

        /* --- Záložky (Tabs) - Vylepšený Vzhled --- */
        .tabs-wrapper { background-color: var(--card-bg-color); border-radius: var(--card-radius) var(--card-radius) 0 0; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); border-bottom: none; margin-bottom: 0; /* Navazuje na sekci */ }
        .plan-tabs { display: flex; overflow-x: auto; scrollbar-width: none; border-bottom: 1px solid var(--border-color); padding: 0.5rem 1rem 0 1rem; /* Odsazení zleva/zprava */ }
        .plan-tabs::-webkit-scrollbar { display: none; }
        .plan-tab { padding: 0.9rem 1.6rem; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.3s ease; white-space: nowrap; font-size: 1rem; position: relative; display: flex; align-items: center; gap: 0.5rem; border-radius: 6px 6px 0 0; /* Lehké zaoblení nahoře */ }
        .plan-tab i { font-size: 1.1em; opacity: 0.8; }
        .plan-tab:hover { color: var(--primary); background-color: rgba(var(--primary-rgb), 0.03); }
        .plan-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .plan-tab.active i { opacity: 1; }

        /* Sekce navazující na taby */
        .tab-linked-section { border-radius: 0 0 var(--card-radius) var(--card-radius); margin-top: -1px; /* Překrytí borderu tabů */ border-top-color: transparent; /* Skrytí horního borderu sekce */ }

        /* --- Obsah Plánu (Markdown Render) - Vylepšený Vzhled --- */
        /* Styly pro .plan-content zůstávají stejné jako v předchozí verzi */
        .plan-content { margin-top: 0; padding: 2rem 0.5rem; /* Menší boční padding */ line-height: 1.75; }
        .plan-content h1, .plan-content h2, .plan-content h3, .plan-content h4 { /* ... (stejné) ... */ color: var(--text-primary); margin-top: 1.8em; margin-bottom: 0.8em; font-weight: 600; padding-bottom: 0.4rem; }
        .plan-content h1 { font-size: 1.8rem; border-bottom: 2px solid var(--primary); display: inline-block; }
        .plan-content h2 { font-size: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .plan-content h3 { font-size: 1.25rem; color: var(--secondary); border-bottom: none; }
        .plan-content h4 { font-size: 1.1rem; color: var(--primary); border-bottom: none; }
        .plan-content p { margin-bottom: 1.2rem; color: var(--text-secondary); }
        .plan-content ul, .plan-content ol { margin-left: 1.5rem; margin-bottom: 1.2rem; padding-left: 1rem; }
        .plan-content li { margin-bottom: 0.8rem; padding-left: 0.5rem; position: relative; }
        .plan-content li::before { content: ''; position: absolute; left: -1rem; top: 0.6em; width: 6px; height: 6px; background-color: var(--primary-light); border-radius: 50%; }
        .plan-content ol li::before { content: none; }
        .plan-content strong { font-weight: 600; color: var(--text-primary); }
        .plan-content code { background-color: var(--skeleton-bg); padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.9rem; font-family: 'Courier New', Courier, monospace; color: var(--secondary); border: 1px solid var(--border-color); }
        .plan-content pre { background-color: var(--skeleton-bg); border: 1px solid var(--border-color); padding: 1.2rem; margin: 1.8rem 0; border-radius: var(--button-radius); overflow-x: auto; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
        .plan-content pre code { background-color: transparent; padding: 0; color: var(--text-secondary); border: none; }
        .plan-content blockquote { border-left: 5px solid var(--primary); padding: 0.8rem 1.5rem; margin: 1.8rem 0; background-color: rgba(var(--primary-rgb), 0.03); color: var(--text-secondary); font-style: italic; border-radius: 0 var(--button-radius) var(--button-radius) 0; }
        .plan-content hr { border: none; border-top: 1px solid var(--border-color); margin: 2.5rem 0; }


        /* --- Kalendářový pohled - Vylepšený Vzhled --- */
        .calendar-scroll-container { /* ... (stejné jako předtím) ... */ overflow-x: auto; padding-bottom: 10px; margin-top: 1rem; border: 1px solid var(--border-color); border-radius: var(--card-radius); background-color: var(--card-bg-color); box-shadow: var(--shadow-sm); }
        .calendar-grid { /* ... (stejné jako předtím) ... */ display: grid; grid-template-columns: repeat(7, minmax(220px, 1fr)); min-width: calc(7 * 220px); }
        .calendar-day-cell { /* ... (stejné jako předtím) ... */ border-left: 1px solid var(--border-color); min-height: 320px; display: flex; flex-direction: column; position: relative; transition: background-color 0.2s ease; }
        .calendar-day-cell:first-child { border-left: none; }
        .calendar-day-header { /* ... (stejné jako předtím) ... */ padding: 0.9rem 1rem; font-weight: 600; text-align: center; background-color: var(--gray-100); border-bottom: 1px solid var(--border-color); font-size: 0.9rem; color: var(--text-secondary); position: sticky; top: 0; z-index: 10; }
        .calendar-day-cell.today .calendar-day-header { /* ... (stejné jako předtím) ... */ background-color: rgba(var(--success-rgb), 0.1); color: var(--success); font-weight: 700; border-bottom-color: rgba(var(--success-rgb), 0.3); }
        .calendar-day-cell.today { /* ... (stejné jako předtím) ... */ background-color: rgba(var(--success-rgb), 0.02); }
        .calendar-activities { /* ... (stejné jako předtím) ... */ padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; gap: 0.9rem; }
        .calendar-activity { /* ... (stejné jako předtím) ... */ background-color: var(--white); border: 1px solid var(--border-color); border-left: 5px solid var(--primary); border-radius: var(--button-radius); padding: 0.8rem 1.1rem; font-size: 0.9rem; box-shadow: var(--shadow-sm); transition: all 0.2s ease; cursor: pointer; position: relative; }
        .calendar-activity:hover { /* ... (stejné jako předtím) ... */ transform: translateY(-3px) scale(1.01); box-shadow: var(--shadow-md); border-left-color: var(--secondary); }
        .calendar-activity.completed { /* ... (stejné jako předtím) ... */ border-left-color: var(--success); opacity: 0.8; }
        .calendar-activity.completed:hover { /* ... (stejné jako předtím) ... */ opacity: 1; }
        .calendar-activity .activity-header { /* ... (stejné jako předtím) ... */ display: flex; gap: 0.7rem; align-items: center; margin-bottom: 6px; }
        .calendar-activity .activity-checkbox { /* ... (stejné jako předtím) ... */ display: flex; gap: 0.7rem; align-items: center; padding-bottom: 5px;}
        .calendar-activity input[type="checkbox"] { /* ... (stejné jako předtím) ... */ margin-right: 0.7rem; width: 17px; height: 17px; cursor: pointer; accent-color: var(--primary); }
        .calendar-activity .activity-content { /* ... (stejné jako předtím) ... */ flex-grow: 1; }
        .calendar-activity .activity-title { /* ... (stejné jako předtím) ... */ font-weight: 600; color: var(--text-primary); font-size: 0.95rem; line-height: 1.35; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
        .calendar-activity .activity-time-display { /* ... (stejné jako předtím) ... */ font-weight: 600; color: var(--primary); font-size: 0.8em; background-color: rgba(var(--primary-rgb), 0.1); padding: 2px 6px; border-radius: 4px; flex-shrink: 0; }
        .calendar-activity .activity-desc { /* ... (stejné jako předtím) ... */ font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px; display: none; line-height: 1.4; padding: 0.5rem 0 0.2rem 0; border-top: 1px dashed var(--border-color); margin-left: calc(17px + 0.7rem); }
        .calendar-activity.expanded .activity-desc { /* ... (stejné jako předtím) ... */ display: block; }
        .calendar-activity input:checked ~ .activity-content .activity-title { /* ... (stejné jako předtím) ... */ text-decoration: line-through; color: var(--text-muted); }
        .calendar-activity input:checked ~ .activity-content .activity-time-display { /* ... (stejné jako předtím) ... */ color: var(--text-muted); background-color: var(--gray-100); text-decoration: line-through;}
        .calendar-activity input:checked ~ .activity-desc { /* ... (stejné jako předtím) ... */ text-decoration: line-through; color: var(--text-muted); }
        .calendar-activity .expand-icon { /* ... (stejné jako předtím) ... */ font-size: 0.8em; color: var(--text-muted); margin-left: auto; transition: transform 0.2s ease; }
        .calendar-activity.expanded .expand-icon { /* ... (stejné jako předtím) ... */ transform: rotate(180deg); }

        /* --- Historie plánů - Vylepšený Vzhled --- */
        /* Styly .plan-history a .history-item zůstávají stejné jako v předchozí verzi */
        .plan-history { margin-top: 1.5rem; display: grid; gap: 1.25rem; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
        .history-item { /* ... (stejné) ... */ background-color: var(--card-bg-color); border-radius: var(--card-radius); padding: 1.5rem; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; transition: all 0.2s ease; cursor: pointer; border: 1px solid var(--border-color); border-left: 5px solid var(--gray-400); }
        .history-item:hover { /* ... (stejné) ... */ transform: translateY(-4px); box-shadow: var(--shadow-md); border-left-color: var(--primary); }
        .history-item-header { /* ... (stejné) ... */ display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.8rem; }
        .history-item.active { /* ... (stejné) ... */ border-left-color: var(--primary); } .history-item.completed { /* ... (stejné) ... */ border-left-color: var(--success); }
        .history-info { /* ... (stejné) ... */ flex-grow: 1; }
        .history-date { /* ... (stejné) ... */ font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.3rem; }
        .history-title { /* ... (stejné) ... */ font-weight: 600; color: var(--text-primary); font-size: 1.1rem; margin-bottom: 0.5rem; line-height: 1.3; }
        .history-status { /* ... (stejné) ... */ padding: 0.3rem 0.9rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; flex-shrink: 0; }
        .history-status.active { /* ... (stejné) ... */ background-color: rgba(var(--primary-rgb), 0.1); color: var(--primary); }
        .history-status.completed { /* ... (stejné) ... */ background-color: rgba(var(--success-rgb), 0.1); color: var(--success); }
        .history-status.inactive { /* ... (stejné) ... */ background-color: rgba(108, 117, 125, 0.1); color: var(--gray); }
        .history-item-footer { /* ... (stejné) ... */ margin-top: auto; padding-top: 0.8rem; border-top: 1px dashed var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: var(--text-secondary); }
        .history-progress strong { /* ... (stejné) ... */ color: var(--primary); font-weight: 600; }
        .history-action-icon { /* ... (stejné) ... */ color: var(--primary); font-size: 1rem; transition: transform 0.2s ease; }
        .history-item:hover .history-action-icon { /* ... (stejné) ... */ transform: scale(1.1); }


        /* --- Vytvoření Plánu (Create Plan) - Vylepšený Vzhled --- */
        /* Styly .create-plan-content, .notest-message, .locked-overlay, .action-buttons, .timer-container zůstávají stejné jako v předchozí verzi */
        .create-plan-content { text-align: center; }
        .notest-message { background-color: var(--info-bg); border-left: 4px solid var(--info); padding: 2rem; margin: 1.5rem 0; border-radius: var(--card-radius); border: 1px solid var(--info-light); }
        .notest-message h3 { color: var(--info); margin-bottom: 1rem; font-size: 1.3rem; display: flex; align-items: center; gap: 0.7rem; justify-content: center; font-weight: 600;}
        .notest-message p { color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.6; max-width: 650px; margin-left: auto; margin-right: auto; font-size: 1rem;}
        .notest-message .btn { margin-top: 0.5rem; }
        .notest-message.warning { background-color: var(--warning-bg); border-left-color: var(--warning); border-color: var(--warning-light); }
        .notest-message.warning h3 { color: var(--warning); }
        .notest-message.error { background-color: var(--danger-bg); border-left-color: var(--danger); border-color: var(--danger-light); }
        .notest-message.error h3 { color: var(--danger); }
        .locked-overlay { background-color: rgba(var(--card-bg-color-rgb), 0.9); backdrop-filter: blur(5px); border-radius: var(--card-radius); padding: 3rem; text-align: center; border: 1px dashed var(--border-color); }
        .locked-icon { font-size: 4rem; margin-bottom: 1.5rem; color: var(--warning); }
        .locked-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.2rem; color: var(--text-primary); }
        .locked-message { font-size: 1.05rem; margin-bottom: 2rem; color: var(--text-secondary); max-width: 550px; margin-left: auto; margin-right: auto; }
        .timer-container { margin-bottom: 2rem; font-size: 1.2rem; font-weight: 500; color: var(--primary); }
        .timer-container strong { font-weight: 700; padding: 0 0.3ch; display: inline-block; min-width: 1.5ch; }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1.5rem; justify-content: center; }

        /* --- Navigace a Akce Plánu --- */
        /* Styly .plan-header-dynamic, .plan-meta, .plan-date, .plan-actions, .step-navigation zůstávají stejné jako v předchozí verzi */
        .plan-header-dynamic { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .plan-meta { display: flex; flex-direction: column; gap: 0.3rem; flex-grow: 1; }
        .plan-meta h2 { margin-bottom: 0.4rem !important; border-bottom: none !important; padding-bottom: 0 !important;}
        .plan-date { font-size: 0.85rem; color: var(--text-muted); }
        .plan-actions { display: flex; gap: 0.75rem; flex-shrink: 0; align-self: flex-start;}
        .step-navigation { display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }

        /* --- Loading & Skeleton States (Konzistentní) --- */
        /* Styly .loader-container, .loader, .skeleton, skeleton::after, .skeleton.*-placeholder zůstávají stejné */
        .loader-container { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 250px; text-align: center; color: var(--text-muted); font-size: 1.1rem; }
        .loader { width: 45px; height: 45px; border: 5px solid rgba(var(--primary-rgb), 0.1); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; margin-bottom: 1.2rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .skeleton { background-color: var(--skeleton-bg); border-radius: 4px; position: relative; overflow: hidden; }
        .skeleton::after { content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, var(--skeleton-highlight), transparent); animation: skeleton-loading 1.5s infinite linear; }
        @keyframes skeleton-loading { 0% { left: -150%; } 100% { left: 150%; } }
        .skeleton.title-sm { height: 14px; width: 70%; margin-bottom: 0.6rem; }
        .skeleton.text-md { height: 16px; width: 90%; margin-bottom: 0.4rem; }
        .skeleton.text-sm { height: 12px; width: 60%; }
        .skeleton.history-item-skeleton { padding: 1.5rem; display: flex; flex-direction: column; gap: 0.7rem; background-color: var(--card-bg-color); border-radius: var(--card-radius); border: 1px solid var(--border-color); }
        .skeleton.calendar-day-skeleton { padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        .skeleton.calendar-activity-skeleton { height: 50px; width: 100%; border-radius: var(--button-radius);}

        /* --- Empty State (Konzistentní) --- */
        .empty-state { padding: 3rem 2rem; text-align: center; color: var(--text-muted); display: none; background-color: transparent; border-radius: var(--card-radius); border: 1px dashed var(--border-color); margin-top: 1rem;}
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; color: var(--gray-400); }
        .empty-state h3 { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.75rem; }
        .empty-state p { margin: 0 auto 1.5rem auto; font-size: 0.95rem; max-width: 450px; }
        .empty-state .btn { margin-top: 0.5rem; }

        /* --- Toast & Error Messages (Konzistentní) --- */
        /* Styly .toast-container, .toast, .error-container, .error-message zůstávají stejné */
        .toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1050; display: flex; flex-direction: column; gap: 0.75rem; max-width: 380px; pointer-events: none; }
        .toast { padding: 1rem 1.2rem; border-radius: 10px; background: var(--card-bg-color); box-shadow: var(--shadow-lg); display: flex; align-items: flex-start; color: var(--text-primary); animation: toast-in 0.4s ease forwards; pointer-events: auto; border: 1px solid var(--border-color); border-left-width: 4px; opacity: 0; transform: translateX(100%); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { border-left-color: var(--success); } .toast.error { border-left-color: var(--danger); } .toast.info { border-left-color: var(--info); }
        .toast-icon { margin-right: 0.75rem; font-size: 1.25rem; flex-shrink: 0; margin-top: 2px; }
        .toast.success .toast-icon { color: var(--success); } .toast.error .toast-icon { color: var(--danger); } .toast.info .toast-icon { color: var(--info); }
        .toast-content { flex: 1; } .toast-title { font-weight: 600; margin-bottom: 0.25rem; font-size: 0.95rem; } .toast-message { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.4; }
        .toast-close { background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 1.3rem; padding: 0.1rem 0.2rem; margin-left: 0.5rem; line-height: 1; opacity: 0.7; transition: opacity 0.2s, color 0.2s; }
        .toast-close:hover { opacity: 1; color: var(--text-primary); }
        @keyframes toast-in { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        .error-container { display: none; margin-bottom: 1.5rem; }
        .error-message { background-color: rgba(var(--danger-rgb), 0.05); border-left: 4px solid var(--danger); color: var(--danger); padding: 1rem; margin: 1rem 0; border-radius: 8px; font-size: 0.9rem; display: flex; align-items: center; }
        .error-message i { margin-right: 0.75rem; font-size: 1.25rem; }

        /* --- Initial Loading Overlay (Konzistentní) --- */
        .initial-loading-overlay { /* ... (stejné jako předtím) ... */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 1100; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 1rem; transition: opacity 0.5s ease-out; }
        .initial-loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .initial-loading-overlay .loading-spinner { width: 35px; height: 35px; border-width: 4px; border-color: var(--primary); border-top-color: transparent; animation: loading-spinner 0.8s linear infinite;}
        .initial-loading-overlay p { color: var(--text-secondary); font-size: 1.1rem;}

        /* --- Footer (Konzistentní) --- */
        .dashboard-footer { margin-top: 2.5rem; padding: 1.5rem 0; text-align: center; color: var(--text-muted); font-size: 0.9rem; border-top: 1px solid var(--border-color); }

        /* --- Responzivita (Převzato a upraveno) --- */
        /* Styly pro .mobile-menu-toggle, .sidebar-overlay, @media (max-width: 992px), @media (max-width: 768px), @media (max-width: 576px) zůstávají stejné */
        .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; font-size: 1.5rem; color: var(--text-primary); padding: 0.5rem; margin-right: 0.5rem; z-index: 1010; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.55); z-index: 999; opacity: 0; transition: opacity var(--transition-speed) ease; backdrop-filter: blur(4px); }
        .sidebar-overlay.active { display: block; opacity: 1; }
        @media (max-width: 992px) { /* Collapsed Sidebar */ :root { --sidebar-width: 80px; } main { margin-left: 80px; width: calc(100% - 80px); } .sidebar { width: 80px; } .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; } .sidebar-link i { margin-right: 0; font-size: 1.5rem; } .sidebar-logo i { margin-right: 0; } .sidebar-header, .sidebar-link { justify-content: center; } .user-profile { justify-content: center; padding: 0.75rem; } .user-avatar { margin-right: 0; } #sidebar-close-toggle { display: none !important; } .mobile-menu-toggle { display: block; } .calendar-grid { grid-template-columns: repeat(7, minmax(180px, 1fr)); min-width: calc(7 * 180px); } }
        @media (max-width: 768px) { /* Tablet */ main { padding: 1rem; } .dashboard-header { padding: 1rem 1.25rem; top: 0; } .header-title { gap: 0.5rem; } .header-title h1 { font-size: 1.5rem; } .plan-header-dynamic { flex-direction: column; gap: 1rem; } .plan-actions { width: 100%; justify-content: center; } .plan-tabs { padding-bottom: 0.5rem; } .plan-tab { padding: 0.75rem 1rem; font-size: 0.9rem; } .calendar-grid { grid-template-columns: repeat(7, minmax(160px, 1fr)); min-width: calc(7 * 160px); } .section { padding: 1.5rem; } .plan-history { grid-template-columns: 1fr; } }
        @media (max-width: 576px) { /* Mobil */ :root { --sidebar-width: 0; } main { margin-left: 0; width: 100%; padding: 0.75rem; } .sidebar { transform: translateX(-100%); z-index: 1100; width: 260px; } .sidebar.active { transform: translateX(0); } .sidebar.active .sidebar-logo span, .sidebar.active .sidebar-link span, .sidebar.active .user-info, .sidebar.active .sidebar-footer { display: block; } .sidebar.active .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; } .sidebar.active .sidebar-header, .sidebar.active .sidebar-link { justify-content: flex-start; } .sidebar.active .user-profile { justify-content: flex-start; padding: 1rem; } .sidebar.active .user-avatar { margin-right: 0.75rem; } .sidebar.active #sidebar-close-toggle { display: block; } .header-title h1 { font-size: 1.3rem; } .calendar-scroll-container { border: none; border-radius: 0; margin-left: -0.75rem; margin-right: -0.75rem; } .calendar-grid { display: block; min-width: unset; } .calendar-day-cell { border-left: none; border-bottom: 1px solid var(--border-color); min-height: auto; border-radius: 0; margin-bottom: 1rem; background-color: var(--card-bg-color); box-shadow: var(--shadow-sm); } .calendar-day-cell:last-child { border-bottom: none; margin-bottom: 0; } .toast-container { max-width: calc(100% - 1.5rem); } .plan-history { grid-template-columns: 1fr; } }

        /* --- Dark Mode (Převzato a upraveno) --- */
        @media (prefers-color-scheme: dark) {
            :root {
                 --bg-color: #131720; --card-bg-color: #1e2533;
                 --card-bg-color-rgb: 30, 37, 51;
                 --text-primary: #e2e8f0; --text-secondary: #94a3b8; --text-muted: #64748b;
                 --border-color: #334155; --light: #2d3748; --white: #1a202c;
                 --skeleton-bg: #334155; --skeleton-highlight: #475569;
                 --danger-rgb: 247, 37, 133;
            }
             body { background-color: var(--bg-color); }
             .dashboard-header { background-color: rgba(30, 37, 51, 0.85); border-bottom-color: var(--border-color); }
             body.scrolled .dashboard-header { background-color: rgba(30, 37, 51, 0.98); }
             .section, .tabs-wrapper { background-color: var(--card-bg-color); border-color: var(--border-color); }
             .plan-content { background-color: var(--card-bg-color); } /* Upraveno pro lepší kontrast */
             .plan-content code { background-color: rgba(255, 255, 255, 0.1); color: #9ae6b4; }
             .plan-content pre { background-color: #131720; border-color: var(--border-color); }
             .plan-content pre code { color: var(--text-secondary); }
             .plan-content blockquote { border-left-color: var(--primary-light); color: var(--text-secondary); background-color: rgba(var(--primary-rgb), 0.05); }
             .plan-content hr { border-top-color: var(--border-color); }
             .calendar-scroll-container { background-color: var(--card-bg-color); border-color: var(--border-color); }
             .calendar-grid { background-color: transparent; }
             .calendar-day-cell { border-left-color: var(--border-color); background-color: var(--card-bg-color); }
             .calendar-day-header { background-color: var(--light); border-bottom-color: var(--border-color); color: var(--text-secondary); }
             .calendar-day-cell.today .calendar-day-header { background-color: rgba(var(--success-rgb), 0.1); color: var(--success); border-bottom-color: rgba(var(--success-rgb), 0.2); }
             .calendar-day-cell.today { background-color: rgba(var(--success-rgb), 0.04); }
             .calendar-activity { background-color: var(--light); border-color: var(--border-color); border-left-color: var(--primary); }
             .calendar-activity:hover { border-left-color: var(--secondary); background-color: #3a4454; }
             .calendar-activity input:checked ~ .activity-content .activity-time-display { background-color: var(--border-color); }
             .history-item { background-color: var(--card-bg-color); border-color: var(--border-color); border-left-color: var(--gray-500); }
             .history-item:hover { border-left-color: var(--primary); }
             .history-item.active { border-left-color: var(--primary); background-color: rgba(var(--primary-rgb), 0.05); }
             .history-item.completed { border-left-color: var(--success); background-color: rgba(var(--success-rgb), 0.05); }
             .notest-message { background-color: rgba(var(--info-rgb), 0.05); border-color: rgba(var(--info-rgb), 0.15); }
             .notest-message.warning { background-color: rgba(var(--warning-rgb), 0.05); border-color: rgba(var(--warning-rgb), 0.15); }
             .notest-message.error { background-color: rgba(var(--danger-rgb), 0.05); border-color: rgba(var(--danger-rgb), 0.15); }
             .locked-overlay { background-color: rgba(30, 37, 51, 0.9); } /* Tmavší overlay */
             .btn-secondary { background-color: var(--light); color: var(--text-secondary); border-color: var(--border-color); }
             .btn-secondary:hover:not(:disabled) { background-color: #4a5568; border-color: #6c757d; color: var(--white); }
             .mobile-menu-toggle { color: var(--text-primary); }
             .error-message { background-color: rgba(var(--danger-rgb), 0.1); border-left-color: var(--danger); }
             .toast { background-color: var(--card-bg-color); border-color: var(--border-color); }
             .dashboard-footer { border-top-color: var(--border-color); }
             .initial-loading-overlay { background-color: var(--bg-color); }
             .plan-tab:hover { background-color: rgba(var(--primary-rgb), 0.05); }
             @media (max-width: 576px) {
                  .calendar-day-cell { border-bottom-color: var(--border-color); background-color: var(--card-bg-color); }
             }
        }
        /* --- END: FINÁLNÍ VYLEPŠENÉ CSS STYLY (v2) --- */
    </style>
</head>
<body>
    <div class="initial-loading-overlay" id="initial-loader">
        <div class="loading-spinner"></div>
        <p>Načítání plánu...</p>
    </div>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <button class="mobile-menu-toggle" id="sidebar-close-toggle"> <i class="fas fa-times"></i> </button>
            <a href="/dashboard/dashboard.html" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a>
        </div>
        <ul class="sidebar-menu">
             <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Nástěnka</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li>
        </ul>
        <div class="user-profile">
            <div class="user-avatar" id="user-avatar">?</div>
            <div class="user-info">
                <div class="user-name" id="user-name">Načítání...</div>
                <div class="user-role" id="user-role">Student</div>
            </div>
        </div>
        <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main id="main-content" style="display:none;">
        <header class="dashboard-header">
            <div class="header-title">
                <button class="mobile-menu-toggle" id="mobile-menu-toggle"> <i class="fas fa-bars"></i> </button>
                <h1>Studijní plán</h1>
            </div>
        </header>

        <div class="error-container" id="global-error"></div>

        <div class="main-content-wrapper">
            <div class="tabs-wrapper">
                <div class="plan-tabs">
                    <div class="plan-tab active" data-tab="current"><i class="far fa-calendar-check"></i> Aktuální plán</div>
                    <div class="plan-tab" data-tab="history"><i class="fas fa-history"></i> Historie plánů</div>
                    <div class="plan-tab" data-tab="create"><i class="fas fa-plus-circle"></i> Vytvořit nový</div>
                </div>
            </div>

            <div class="section tab-linked-section" id="currentPlanSection" style="display: block; opacity: 1;"> <div class="loader-container" id="currentPlanLoader"> <div class="loader"></div> </div>
                <div id="currentPlanContent">
                    </div>
            </div>

            <div class="section tab-linked-section" id="historyPlanSection" style="display: none;">
                <h2 class="section-title"><i class="fas fa-history"></i> Historie studijních plánů</h2>
                <div class="loader-container" id="historyLoader"> <div class="loader"></div> </div>
                <div id="historyPlanContent" class="plan-history">
                    <div class="skeleton history-item-skeleton"> <div class="skeleton text-sm" style="width: 40%;"></div> <div class="skeleton title-sm" style="width: 80%; height: 16px;"></div> <div class="skeleton text-sm" style="width: 50%;"></div> </div>
                    <div class="skeleton history-item-skeleton"> <div class="skeleton text-sm" style="width: 40%;"></div> <div class="skeleton title-sm" style="width: 80%; height: 16px;"></div> <div class="skeleton text-sm" style="width: 50%;"></div> </div>
                </div>
            </div>

            <div class="section tab-linked-section" id="createPlanSection" style="display: none;">
                <div class="loader-container" id="createPlanLoader" style="display:none;"> <div class="loader"></div> </div>
                <div id="createPlanContent">
                    </div>
            </div>

            <div class="section" id="planSection" style="display: none;">
                <div class="plan-header-dynamic">
                    <h2 class="section-title" id="plan-section-title" style="margin:0; border:none; padding:0;">Detail / Návrh plánu</h2>
                    <div class="plan-actions" id="planActions">
                        </div>
                </div>
                 <div class="step-navigation" style="margin-top:0; border-top: none; padding-top: 0; margin-bottom: 1.5rem;">
                     <button class="btn btn-secondary btn-sm" id="genericBackBtn"> <i class="fas fa-arrow-left"></i> Zpět </button>
                 </div>
                <div class="loader-container" id="planLoading" style="display: none;"> <div class="loader"></div> <div>Generuji/Načítám...</div> </div>
                <div class="plan-content" id="planContent" style="display: none;">
                     </div>
            </div>

            <div class="section" id="scheduleSection" style="display: none;">
                <div id="scheduleHeaderContainer">
                    </div>
                 <div class="loader-container" id="scheduleLoader" style="display: none;"> <div class="loader"></div> </div>
                 <div class="calendar-scroll-container" id="scheduleScrollContainer" style="display: none;">
                      <div class="calendar-grid" id="dailySchedule">
                          <div class="skeleton calendar-day-skeleton"> <div class="skeleton title-sm" style="width:60%; height: 16px; margin:auto;"></div> <div class="skeleton calendar-activity-skeleton"></div> <div class="skeleton calendar-activity-skeleton" style="width: 80%;"></div> </div>
                          <div class="skeleton calendar-day-skeleton"> <div class="skeleton title-sm" style="width:60%; height: 16px; margin:auto;"></div> <div class="skeleton calendar-activity-skeleton"></div> </div>
                          </div>
                 </div>
                 <div class="step-navigation" style="margin-top: 1.5rem;">
                     <button class="btn btn-secondary" id="backToTabsBtn"> <i class="fas fa-arrow-left"></i> Zpět na záložky </button>
                 </div>
             </div>
        </div>

        <footer class="dashboard-footer">
            <p>&copy; 2025 Justax. Všechna práva vyhrazena.</p>
        </footer>
    </main>

    <div class="toast-container" id="toast-container"></div>

    <template id="lockedPlanTemplate">
        <div class="locked-overlay">
            <div class="locked-icon"> <i class="fas fa-lock"></i> </div>
            <h3 class="locked-title">Vytvoření nového plánu není dostupné</h3>
            <p class="locked-message">Nový studijní plán můžete vytvořit jednou týdně, abyste měli dostatek času pracovat na aktuálním. Váš poslední plán byl vytvořen nedávno.</p>
            <div class="timer-container" id="timerContainer"> Další plán můžete vytvořit za: <strong id="nextPlanTimer">počítám...</strong> </div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="viewCurrentPlanBtnLocked"> <i class="fas fa-eye"></i> Zobrazit aktuální plán </button>
            </div>
        </div>
    </template>
    <template id="createPlanFormTemplate">
        <div class="create-plan-content">
            <h2 class="section-title"><i class="fas fa-magic"></i> Vytvořit nový studijní plán</h2>
            <div id="diagnosticInfo" class="notest-message info" style="text-align: left;">
                </div>
            <p class="section-text" style="max-width: 700px; margin: 1.5rem auto;">Personalizovaný studijní plán bude vytvořen na základě výsledků vašeho posledního diagnostického testu. Zaměří se na vaše slabší oblasti a pomůže vám efektivně se připravit.</p>
            <div class="action-buttons">
                <button class="btn btn-primary btn-lg" id="generatePlanBtn"> <i class="fas fa-cogs"></i> Vygenerovat nový plán </button>
            </div>
        </div>
    </template>
    <template id="noDiagnosticTemplate">
        <div class="notest-message warning">
            <h3><i class="fas fa-exclamation-circle"></i> Nejprve absolvujte diagnostický test</h3>
            <p>Pro vytvoření personalizovaného studijního plánu je nejprve potřeba dokončit diagnostický test na stránce Procvičování, který nám pomůže identifikovat vaše silné a slabé stránky.</p>
            <div class="action-buttons">
                <a href="test1.html" class="btn btn-primary" id="goToTestBtn"> <i class="fas fa-play-circle"></i> Přejít k testu </a>
            </div>
        </div>
    </template>
    <template id="historyItemTemplate">
        <div class="history-item" data-plan-id="">
            <div class="history-item-header">
                <div class="history-info">
                    <div class="history-title">Studijní plán</div>
                    <div class="history-date">Vytvořeno: -</div>
                </div>
                <div class="history-meta">
                    <span class="history-status active">Stav</span>
                </div>
            </div>
             <div class="history-item-footer">
                 <div class="history-progress">Pokrok: <strong>- %</strong></div>
                 <i class="fas fa-chevron-right history-action-icon"></i>
             </div>
        </div>
    </template>
    <template id="promptCreatePlanTemplate">
        <div class="notest-message info">
            <h3><i class="fas fa-clipboard-check"></i> Připraveno k vytvoření plánu</h3>
            <p>Váš poslední diagnostický test je připraven k analýze. Můžete nyní vygenerovat nový personalizovaný studijní plán.</p>
            <div class="action-buttons">
                 <button class="btn btn-primary" id="createNewPlanFromPromptBtn"><i class="fas fa-plus-circle"></i> Vytvořit studijní plán</button>
            </div>
        </div>
    </template>
    <template id="noActivePlanTemplate">
         <div class="empty-state" style="display:flex; flex-direction: column; align-items: center; border: none; padding: 2rem 1rem;">
             <i class="far fa-calendar-times" style="font-size: 3.5rem; color: var(--primary-light); margin-bottom: 1.5rem;"></i>
             <h3 style="font-size: 1.3rem;">Žádný aktivní plán</h3>
             <p style="max-width: 500px;">Momentálně nemáte žádný aktivní studijní plán. Pokud jste již absolvoval/a diagnostický test, můžete si <a href="#" class="link-to-create-tab" style="color: var(--primary); font-weight: 500;">vytvořit nový</a>.</p>
             <p style="margin-top: 0.5rem;">Pokud jste test ještě nedělal/a, přejděte prosím na <a href="test1.html" style="color: var(--primary); font-weight: 500;">stránku testování</a>.</p>
         </div>
    </template>

    <script>
        // ==============================================
        //          Inicializace Supabase & Gemini
        // ==============================================
        const supabaseUrl = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
        let supabaseClient = null;
        const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // <--- ZDE VLOŽTE VÁŠ KLÍČ
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

        // ==============================================
        //          DOM Elementy
        // ==============================================
        const ui = {
            initialLoader: document.getElementById('initial-loader'),
            mainContent: document.getElementById('main-content'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            mobileMenuToggle: document.getElementById('mobile-menu-toggle'),
            sidebarCloseToggle: document.getElementById('sidebar-close-toggle'),
            userName: document.getElementById('user-name'),
            userAvatar: document.getElementById('user-avatar'),
            userRole: document.getElementById('user-role'),
            toastContainer: document.getElementById('toast-container'),
            globalError: document.getElementById('global-error'),
            planTabs: document.querySelectorAll('.plan-tab'),
            currentPlanSection: document.getElementById('currentPlanSection'),
            currentPlanLoader: document.getElementById('currentPlanLoader'),
            currentPlanContent: document.getElementById('currentPlanContent'),
            historyPlanSection: document.getElementById('historyPlanSection'),
            historyLoader: document.getElementById('historyLoader'),
            historyPlanContent: document.getElementById('historyPlanContent'),
            createPlanSection: document.getElementById('createPlanSection'),
            createPlanLoader: document.getElementById('createPlanLoader'),
            createPlanContent: document.getElementById('createPlanContent'),
            planSection: document.getElementById('planSection'),
            planLoading: document.getElementById('planLoading'),
            planSectionTitle: document.getElementById('plan-section-title'),
            planContent: document.getElementById('planContent'),
            planActions: document.getElementById('planActions'),
            genericBackBtn: document.getElementById('genericBackBtn'),
            scheduleSection: document.getElementById('scheduleSection'),
            scheduleLoader: document.getElementById('scheduleLoader'),
            scheduleScrollContainer: document.getElementById('scheduleScrollContainer'),
            dailyScheduleGrid: document.getElementById('dailySchedule'),
            scheduleHeaderContainer: document.getElementById('scheduleHeaderContainer'),
            backToTabsBtn: document.getElementById('backToTabsBtn'),
            // Templates
            lockedPlanTemplate: document.getElementById('lockedPlanTemplate'),
            createPlanFormTemplate: document.getElementById('createPlanFormTemplate'),
            noDiagnosticTemplate: document.getElementById('noDiagnosticTemplate'),
            historyItemTemplate: document.getElementById('historyItemTemplate'),
            promptCreatePlanTemplate: document.getElementById('promptCreatePlanTemplate'),
            noActivePlanTemplate: document.getElementById('noActivePlanTemplate')
        };

        // Globální proměnné
        let state = { /* ... (stejné jako předtím) ... */ currentUser: null, currentProfile: null, latestDiagnosticData: null, currentStudyPlan: null, previousPlans: [], planCreateAllowed: false, nextPlanCreateTime: null, planTimerInterval: null, currentTab: 'current', lastGeneratedMarkdown: null, lastGeneratedActivitiesJson: null, isLoading: { current: false, history: false, create: false, detail: false, schedule: false, generation: false }, topicMap: { 1: "Čísla a aritmetické operace", 2: "Algebra", 3: "Geometrie", 4: "Práce s daty", 5: "Problémové úlohy", 6: "Proporce a procenta", 7: "Logické úlohy" } };

        // ==============================================
        //          Pomocné Funkce (Utility)
        // ==============================================
        const formatDate = (dateString) => { /* ... (stejné jako předtím) ... */ if(!dateString) return '-'; try { const date = new Date(dateString); return date.toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric' }); } catch(e){ return '-'}};
        const showToast = (message, type = 'info', duration = 4000) => { /* ... (stejné jako předtím) ... */ if (!ui.toastContainer) return; try { const toastId = `toast-${Date.now()}`; const toastElement = document.createElement('div'); toastElement.className = `toast ${type}`; toastElement.id = toastId; toastElement.setAttribute('role', 'alert'); toastElement.setAttribute('aria-live', 'assertive'); toastElement.innerHTML = `<i class="toast-icon"></i><div class="toast-content"><div class="toast-message">${sanitizeHTML(message)}</div></div><button type="button" class="toast-close" aria-label="Zavřít">&times;</button>`; const icon = toastElement.querySelector('.toast-icon'); icon.className = `toast-icon fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}`; toastElement.querySelector('.toast-close').addEventListener('click', () => { toastElement.classList.remove('show'); setTimeout(() => toastElement.remove(), 400); }); ui.toastContainer.appendChild(toastElement); requestAnimationFrame(() => { toastElement.classList.add('show'); }); setTimeout(() => { if (toastElement.parentElement) { toastElement.classList.remove('show'); setTimeout(() => toastElement.remove(), 400); } }, duration); } catch (e) { console.error("Chyba při zobrazování toastu:", e); } };
        const sanitizeHTML = (str) => { /* ... (stejné jako předtím) ... */ const t = document.createElement('div'); t.textContent = str || ''; return t.innerHTML; };
        const getInitials = (profileData, email) => { /* ... (stejné jako předtím) ... */ if (!profileData && !email) return '?'; let i = ''; if (profileData?.first_name) i += profileData.first_name[0]; if (profileData?.last_name) i += profileData.last_name[0]; if (i) return i.toUpperCase(); if (profileData?.username) return profileData.username[0].toUpperCase(); if (email) return email[0].toUpperCase(); return 'U'; };
        const toggleMobileMenu = () => { /* ... (stejné jako předtím) ... */ ui.sidebar?.classList.toggle('active'); ui.sidebarOverlay?.classList.toggle('active'); };
        const initTooltips = () => { /* ... (stejné jako předtím) ... */ try { if (window.jQuery?.fn.tooltipster) { window.jQuery('.btn-tooltip:not(.tooltipstered)').tooltipster({ theme: 'tooltipster-shadow', animation: 'fade', delay: 100, side: 'top' }); } } catch (e) { console.error("Chyba inicializace Tooltipster:", e); } };
        const showGlobalError = (message) => { /* ... (stejné jako předtím) ... */ if(ui.globalError) { ui.globalError.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><div>${message}</div></div>`; ui.globalError.style.display = 'block';} };
        const hideGlobalError = () => { /* ... (stejné jako předtím) ... */ if(ui.globalError) ui.globalError.style.display = 'none'; };
        const setLoadingState = (sectionKey, isLoadingFlag) => { /* ... (stejné jako předtím) ... */ if (state.isLoading[sectionKey] === isLoadingFlag) return; state.isLoading[sectionKey] = isLoadingFlag; console.log(`[Loading] ${sectionKey}: ${isLoadingFlag}`); const loaderMap = { current: ui.currentPlanLoader, history: ui.historyLoader, create: ui.createPlanLoader, detail: ui.planLoading, schedule: ui.scheduleLoader, generation: ui.planLoading }; const contentMap = { current: ui.currentPlanContent, history: ui.historyPlanContent, create: ui.createPlanContent, detail: ui.planContent, schedule: ui.scheduleScrollContainer }; const sectionMap = { current: ui.currentPlanSection, history: ui.historyPlanSection, create: ui.createPlanSection, detail: ui.planSection, schedule: ui.scheduleSection }; const loader = loaderMap[sectionKey]; const content = contentMap[sectionKey]; const section = sectionMap[sectionKey]; if (loader) loader.style.display = isLoadingFlag ? 'flex' : 'none'; if (content) content.style.display = isLoadingFlag ? 'none' : (sectionKey === 'history' || sectionKey === 'schedule' ? 'grid' : 'block'); if(sectionKey === 'detail' || sectionKey === 'generation') { if (ui.planActions) ui.planActions.style.display = isLoadingFlag ? 'none' : 'flex'; if (ui.planContent) ui.planContent.style.display = isLoadingFlag ? 'none' : 'block'; } if (section && !isLoadingFlag) { if (sectionKey === state.currentTab || (['detail', 'generation', 'schedule'].includes(sectionKey))) { section.style.display = 'block'; } } if(sectionKey === 'history') renderHistorySkeletons(isLoadingFlag ? 3 : 0); if(sectionKey === 'schedule') renderScheduleSkeletons(isLoadingFlag ? 7 : 0); };
        const renderMessage = (container, type = 'info', title, message) => { /* ... (stejné jako předtím) ... */ if (!container) return; const iconMap = { info: 'fa-info-circle', warning: 'fa-exclamation-triangle', error: 'fa-exclamation-circle' }; container.innerHTML = `<div class="notest-message ${type}"><h3><i class="fas ${iconMap[type]}"></i> ${sanitizeHTML(title)}</h3><p>${sanitizeHTML(message)}</p></div>`; container.style.display = 'block'; };

        // ==============================================
        //          Inicializace a Navigace
        // ==============================================
        const initializeSupabase = () => { /* ... (stejné jako předtím) ... */ try { if (!window.supabase) throw new Error("Supabase library not loaded."); supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey); console.log("Supabase client initialized."); return true; } catch (error) { console.error("Supabase init failed:", error); showGlobalError("Chyba připojení k databázi."); return false; } };
        const setupEventListeners = () => { /* ... (stejné jako předtím) ... */ console.log("[SETUP] Setting up event listeners..."); if (ui.mobileMenuToggle) ui.mobileMenuToggle.addEventListener('click', toggleMobileMenu); if (ui.sidebarCloseToggle) ui.sidebarCloseToggle.addEventListener('click', toggleMobileMenu); if (ui.sidebarOverlay) ui.sidebarOverlay.addEventListener('click', toggleMobileMenu); ui.planTabs.forEach(tab => { tab.addEventListener('click', () => switchTab(tab.dataset.tab)); }); if (ui.genericBackBtn) { ui.genericBackBtn.addEventListener('click', () => { switchTab(state.currentTab || 'current'); }); } if (ui.backToTabsBtn) { ui.backToTabsBtn.addEventListener('click', () => { if(ui.scheduleSection) ui.scheduleSection.style.display = 'none'; if(ui.currentPlanSection) ui.currentPlanSection.style.display = 'block'; switchTab('current'); }); } const scheduleContainer = document.getElementById('dailySchedule'); if (scheduleContainer) { scheduleContainer.addEventListener('click', (event) => { const activityElement = event.target.closest('.calendar-activity'); const isCheckboxClick = event.target.matches('input[type="checkbox"]') || event.target.closest('label')?.control === event.target; if (activityElement && !isCheckboxClick) { activityElement.classList.toggle('expanded'); } }); } console.log("[SETUP] Event listeners set up."); };
        const initializeApp = async () => { /* ... (stejné jako předtím) ... */ console.log("🚀 [Init Plan] Starting..."); if (!initializeSupabase()) return; ui.initialLoader.style.display = 'flex'; ui.initialLoader.classList.remove('hidden'); ui.mainContent.style.display = 'none'; ui.mainContent.classList.remove('loaded'); hideGlobalError(); try { const { data: { user }, error } = await supabaseClient.auth.getUser(); if (error) throw new Error("Nepodařilo se ověřit uživatele."); if (!user) { window.location.href = '/auth/index.html'; return; } state.currentUser = user; state.currentProfile = await fetchUserProfile(user.id); updateUserInfoUI(); setupEventListeners(); await switchTab('current'); initTooltips(); ui.mainContent.style.display = 'block'; requestAnimationFrame(() => { ui.mainContent.classList.add('loaded'); }); console.log("✅ [Init Plan] Page Initialized."); } catch (error) { console.error("App initialization error:", error); showGlobalError(`Chyba inicializace: ${error.message}`); ui.mainContent.style.display = 'block'; if(ui.currentPlanSection) ui.currentPlanSection.style.display = 'block'; if(ui.currentPlanContent) ui.currentPlanContent.innerHTML = `<div class="notest-message error"><h3>Chyba inicializace</h3><p>${error.message}</p></div>`; } finally { ui.initialLoader.classList.add('hidden'); setTimeout(() => { ui.initialLoader.style.display = 'none'; }, 500); } };
        const fetchUserProfile = async (userId) => { /* ... (stejné jako předtím) ... */ if (!userId || !supabaseClient) return null; try { const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', userId).single(); if (error && error.code !== 'PGRST116') throw error; return data; } catch (e) { console.error("Profile fetch error:", e); return null; } };
        const updateUserInfoUI = () => { /* ... (stejné jako předtím) ... */ if (ui.userName && ui.userAvatar) { const name = `${state.currentProfile?.first_name || ''} ${state.currentProfile?.last_name || ''}`.trim() || state.currentProfile?.username || state.currentUser?.email?.split('@')[0] || 'Student'; ui.userName.textContent = name; if (state.currentProfile?.avatar_url) { ui.userAvatar.innerHTML = `<img src="${state.currentProfile.avatar_url}" alt="Avatar">`; } else { ui.userAvatar.textContent = getInitials(state.currentProfile, state.currentUser?.email); } } };

        // --- Přepínání Záložek a Skrývání/Zobrazování Sekcí ---
        const switchTab = async (tabId) => { /* ... (stejné jako předtím) ... */ if (!supabaseClient) { showGlobalError("Aplikace není správně inicializována."); return; } console.log(`Switching to tab: ${tabId}`); state.currentTab = tabId; ui.planTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabId)); ui.currentPlanSection.style.display = 'none'; ui.historyPlanSection.style.display = 'none'; ui.createPlanSection.style.display = 'none'; ui.planSection.style.display = 'none'; ui.scheduleSection.style.display = 'none'; hideGlobalError(); try { if (tabId === 'current') { ui.currentPlanSection.style.display = 'block'; await loadCurrentPlan(); } else if (tabId === 'history') { ui.historyPlanSection.style.display = 'block'; await loadPlanHistory(); } else if (tabId === 'create') { ui.createPlanSection.style.display = 'block'; await checkPlanCreationAvailability(); } } catch (error) { console.error(`Error loading tab ${tabId}:`, error); showGlobalError(`Nepodařilo se načíst záložku "${tabId}": ${error.message}`); const targetSection = document.getElementById(`${tabId}PlanSection`); const targetContent = document.getElementById(`${tabId}PlanContent`); const targetLoader = document.getElementById(`${tabId}Loader`); if (targetSection) targetSection.style.display = 'block'; if (targetLoader) targetLoader.style.display = 'none'; if (targetContent) targetContent.innerHTML = `<div class="notest-message error"><h3>Chyba</h3><p>Obsah nelze načíst.</p></div>`; } };

        // ==============================================
        //          Aktuální Plán (Sekce #currentPlanSection & #scheduleSection)
        // ==============================================
        const loadCurrentPlan = async () => { /* ... (stejné jako předtím) ... */ if (!supabaseClient || !state.currentUser) return; setLoadingState('current', true); if(ui.currentPlanContent) ui.currentPlanContent.innerHTML = ''; if(ui.scheduleSection) ui.scheduleSection.style.display = 'none'; if(ui.planSection) ui.planSection.style.display = 'none'; try { const { data: plans, error } = await supabaseClient.from('study_plans').select('*').eq('user_id', state.currentUser.id).eq('status', 'active').order('created_at', { ascending: false }).limit(1); if (error) throw error; if (plans && plans.length > 0) { state.currentStudyPlan = plans[0]; ui.currentPlanSection.style.display = 'none'; ui.scheduleSection.style.display = 'block'; await showFullSchedule(state.currentStudyPlan); } else { state.currentStudyPlan = null; ui.scheduleSection.style.display = 'none'; ui.currentPlanSection.style.display = 'block'; const diagnostic = await getLatestDiagnostic(false); if (diagnostic === null) { renderMessage(ui.currentPlanContent, 'error', 'Chyba načítání diagnostiky', 'Nepodařilo se ověřit stav vašeho diagnostického testu.'); } else if (diagnostic) { renderPromptCreatePlan(ui.currentPlanContent); } else { renderNoActivePlan(ui.currentPlanContent); } } } catch (error) { console.error("Chyba načítání aktuálního plánu:", error); renderMessage(ui.currentPlanContent, 'error', 'Chyba', 'Nepodařilo se načíst aktuální studijní plán.'); if(ui.currentPlanSection) ui.currentPlanSection.style.display = 'block'; if(ui.scheduleSection) ui.scheduleSection.style.display = 'none'; } finally { setLoadingState('current', false); } };
        const renderPromptCreatePlan = (container) => { /* ... (stejné jako předtím) ... */ if (!container || !ui.promptCreatePlanTemplate) return; const node = ui.promptCreatePlanTemplate.content.cloneNode(true); const btn = node.getElementById('createNewPlanFromPromptBtn'); if(btn) btn.addEventListener('click', () => switchTab('create')); container.innerHTML = ''; container.appendChild(node); container.style.display='block'; };
        const renderNoActivePlan = (container) => { /* ... (stejné jako předtím) ... */ if (!container || !ui.noActivePlanTemplate) return; const node = ui.noActivePlanTemplate.content.cloneNode(true); const link = node.querySelector('.link-to-create-tab'); if (link) link.addEventListener('click', (e) => { e.preventDefault(); switchTab('create'); }); container.innerHTML = ''; container.appendChild(node); container.style.display = 'block'; };

        // ==============================================
        //          Harmonogram (Sekce #scheduleSection)
        // ==============================================
        // ** OPRAVENO: showFullSchedule (odstranění starého headeru) **
        const showFullSchedule = async (plan) => { /* ... (stejné jako předtím, s opravou) ... */ if (!supabaseClient || !plan || !plan.id) return; console.log(`Show Full Schedule: Plan ID ${plan.id}`); ui.currentPlanSection.style.display = 'none'; ui.historyPlanSection.style.display = 'none'; ui.createPlanSection.style.display = 'none'; ui.planSection.style.display = 'none'; ui.scheduleSection.style.display = 'block'; setLoadingState('schedule', true); hideGlobalError(); const oldHeader = ui.scheduleHeaderContainer?.querySelector('.plan-header-dynamic'); if (oldHeader) oldHeader.remove(); if (ui.scheduleHeaderContainer) { const headerDiv = document.createElement('div'); headerDiv.className = 'plan-header plan-header-dynamic'; headerDiv.innerHTML = `<div class="plan-meta"><h2 class="section-title" style="margin-bottom: 0.4rem !important; border:none !important; padding:0 !important;">${sanitizeHTML(plan.title || 'Týdenní harmonogram')}</h2><span class="plan-date">Vytvořeno: ${formatDate(plan.created_at)}</span>${plan.estimated_completion_date ? `<span class="plan-date">Odhad. dokončení: ${formatDate(plan.estimated_completion_date)}</span>` : ''}</div><div class="plan-actions"><button class="btn btn-primary btn-tooltip" id="exportSchedulePlanBtnDynamic" title="Stáhnout plán jako PDF"><i class="fas fa-file-pdf"></i> Export</button></div>`; ui.scheduleHeaderContainer.innerHTML = ''; ui.scheduleHeaderContainer.appendChild(headerDiv); const exportBtn = ui.scheduleHeaderContainer.querySelector('#exportSchedulePlanBtnDynamic'); if(exportBtn) exportBtn.addEventListener('click', () => exportPlanToPDFWithStyle(plan)); } if (ui.backToTabsBtn) ui.backToTabsBtn.onclick = () => switchTab('current'); try { const { data: activities, error } = await supabaseClient.from('plan_activities').select('*').eq('plan_id', plan.id).order('day_of_week').order('time_slot'); if (error) throw error; renderWeeklySchedule(activities || [], plan.id); } catch (error) { console.error("Chyba načítání aktivit pro harmonogram:", error); if(ui.dailyScheduleGrid) ui.dailyScheduleGrid.innerHTML = `<p style="padding: 1rem; text-align: center; grid-column: 1 / -1; color:var(--danger);"><i>Chyba při načítání harmonogramu.</i></p>`; if(ui.scheduleScrollContainer) ui.scheduleScrollContainer.style.display = 'block'; } finally { setLoadingState('schedule', false); initTooltips(); } };
        const renderWeeklySchedule = (activities, planId) => { /* ... (stejné jako předtím) ... */ const days = ['Neděle', 'Pondělí', 'Úterý', 'Středa', 'Čtvrtek', 'Pátek', 'Sobota']; const todayIndex = new Date().getDay(); const gridContainer = ui.dailyScheduleGrid; if (!gridContainer || !ui.scheduleScrollContainer) { console.error("Grid kontejner #dailySchedule nenalezen!"); return; } gridContainer.innerHTML = ''; ui.scheduleScrollContainer.style.display = 'block'; ui.dailyScheduleGrid.style.display = 'grid'; if (!Array.isArray(activities)) activities = []; for (let i = 0; i < 7; i++) { const dayIndex = (i === 6) ? 0 : i + 1; const dayName = days[dayIndex]; const dayCell = document.createElement('div'); dayCell.className = 'calendar-day-cell'; if (dayIndex === todayIndex) dayCell.classList.add('today'); dayCell.innerHTML = `<div class="calendar-day-header">${dayName}${dayIndex === todayIndex ? ' (Dnes)' : ''}</div><div class="calendar-activities"></div>`; const activitiesContainer = dayCell.querySelector('.calendar-activities'); const dayActivities = activities.filter(a => Number(a.day_of_week) === dayIndex).sort((a, b) => (a.time_slot || '').localeCompare(b.time_slot || '')); if (dayActivities.length > 0) { dayActivities.forEach(activity => { if (!activity.id) return; const activityElement = document.createElement('div'); activityElement.className = `calendar-activity ${activity.completed ? 'completed' : ''}`; const timeDisplay = activity.time_slot ? `<span class="activity-time-display">${activity.time_slot}</span>` : ''; const expandIcon = activity.description ? `<i class="fas fa-chevron-down expand-icon"></i>` : ''; activityElement.innerHTML = `<div class="activity-checkbox"><input type="checkbox" id="schedule-activity-${activity.id}" ${activity.completed ? 'checked' : ''} data-activity-id="${activity.id}" data-plan-id="${planId}"><label for="schedule-activity-${activity.id}" class="activity-content"><div class="activity-title">${timeDisplay}${sanitizeHTML(activity.title || 'Aktivita')}${expandIcon}</div></label></div>${activity.description ? `<div class="activity-desc">${sanitizeHTML(activity.description)}</div>` : ''}`; const checkbox = activityElement.querySelector('input[type="checkbox"]'); if(checkbox) checkbox.addEventListener('change', function() { handleActivityCompletionToggle(this.dataset.activityId, this.checked, this.dataset.planId); activityElement.classList.toggle('completed', this.checked); }); if(expandIcon) { const titleDiv = activityElement.querySelector('.activity-title'); if(titleDiv) titleDiv.addEventListener('click', (e) => { const target = e.target; if (!target.matches('input[type="checkbox"]') && !target.closest('label')) { activityElement.classList.toggle('expanded'); } }); } activitiesContainer.appendChild(activityElement); }); } else { activitiesContainer.innerHTML = `<p style="text-align:center; color: var(--text-muted); font-size: 0.85rem; padding-top: 1rem;">Žádné aktivity</p>`; } gridContainer.appendChild(dayCell); } console.log("Weekly schedule rendered."); };
        const renderScheduleSkeletons = (count) => { /* ... (stejné jako předtím) ... */ if (!ui.dailyScheduleGrid || !ui.scheduleScrollContainer) return; ui.dailyScheduleGrid.innerHTML = ''; ui.dailyScheduleGrid.style.display = 'grid'; ui.scheduleScrollContainer.style.display = 'block'; if (count === 0) return; let skeletonHTML = ''; for (let i = 0; i < count; i++) { skeletonHTML += `<div class="calendar-day-cell"><div class="calendar-day-header"><div class="skeleton title-sm" style="width:60%; height: 16px; margin:auto;"></div></div><div class="calendar-activities calendar-day-skeleton"><div class="skeleton calendar-activity-skeleton"></div><div class="skeleton calendar-activity-skeleton" style="width: 80%;"></div></div></div>`; } ui.dailyScheduleGrid.innerHTML = skeletonHTML; };
        const handleActivityCompletionToggle = async (activityId, isCompleted, planId) => { /* ... (stejné jako předtím) ... */ if (!supabaseClient) return; try { const { error } = await supabaseClient.from('plan_activities').update({ completed: isCompleted, updated_at: new Date().toISOString() }).eq('id', activityId); if (error) throw error; console.log(`Aktivita ${activityId} stav: ${isCompleted}`); await updatePlanProgress(planId); } catch (error) { console.error(`Chyba aktualizace aktivity ${activityId}:`, error); showToast('Nepodařilo se aktualizovat stav aktivity.', 'error'); const checkbox = document.getElementById(`schedule-activity-${activityId}`); if(checkbox) checkbox.checked = !isCompleted; } };
        const updatePlanProgress = async (planId) => { /* ... (stejné jako předtím) ... */ if (!planId || !supabaseClient) return; try { const { data, error } = await supabaseClient.from('plan_activities').select('completed').eq('plan_id', planId); if (error) throw error; if (!data) return; const completedCount = data.filter(a => a.completed).length; const progress = data.length > 0 ? Math.round((completedCount / data.length) * 100) : 0; const { error: updateError } = await supabaseClient.from('study_plans').update({ progress: progress, updated_at: new Date().toISOString() }).eq('id', planId); if (updateError) throw updateError; console.log(`Plan ${planId} progress updated to ${progress}%`); if (state.currentStudyPlan?.id === planId) state.currentStudyPlan.progress = progress; } catch (error) { console.error(`Error updating plan progress ${planId}:`, error); } };

        // ==============================================
        //          Historie Plánů (Sekce #historyPlanSection)
        // ==============================================
        const loadPlanHistory = async () => { /* ... (stejné jako předtím) ... */ if (!supabaseClient || !state.currentUser) return; setLoadingState('history', true); if(ui.historyPlanContent) ui.historyPlanContent.innerHTML = ''; try { const { data: plans, error } = await supabaseClient.from('study_plans').select('id, title, created_at, status, progress').eq('user_id', state.currentUser.id).order('created_at', { ascending: false }); if (error) throw error; state.previousPlans = plans || []; renderPlanHistory(state.previousPlans); } catch (error) { console.error("Chyba načítání historie plánů:", error); renderMessage(ui.historyPlanContent, 'error', 'Chyba', 'Nepodařilo se načíst historii plánů.'); ui.historyPlanContent.style.display = 'block'; } finally { setLoadingState('history', false); } };
        const renderPlanHistory = (plans) => { /* ... (stejné jako předtím) ... */ if (!ui.historyPlanContent) return; if (!plans || plans.length === 0) { renderMessage(ui.historyPlanContent, 'info', 'Žádná historie', 'Zatím jste nevytvořili žádné studijní plány.'); ui.historyPlanContent.style.display = 'block'; return; } ui.historyPlanContent.innerHTML = ''; ui.historyPlanContent.style.display = 'grid'; plans.forEach(plan => { const node = ui.historyItemTemplate.content.cloneNode(true); const item = node.querySelector('.history-item'); if(item) { item.dataset.planId = plan.id; item.classList.add(plan.status || 'inactive'); const dateEl = item.querySelector('.history-date'); const titleEl = item.querySelector('.history-title'); const progressEl = item.querySelector('.history-progress'); const statusEl = item.querySelector('.history-status'); if(dateEl) dateEl.textContent = `Vytvořeno: ${formatDate(plan.created_at)}`; if(titleEl) titleEl.textContent = plan.title || "Studijní plán"; if(progressEl) progressEl.innerHTML = `Pokrok: <strong>${plan.progress ?? 0}%</strong>`; if(statusEl) { const statusText = plan.status === 'active' ? 'Aktivní' : plan.status === 'completed' ? 'Dokončený' : 'Neaktivní'; statusEl.textContent = statusText; statusEl.className = `history-status ${plan.status || 'inactive'}`; } item.addEventListener('click', () => showPlanDetail(plan)); ui.historyPlanContent.appendChild(node); } }); };
        const renderHistorySkeletons = (count) => { /* ... (stejné jako předtím) ... */ if (!ui.historyPlanContent) return; ui.historyPlanContent.innerHTML = ''; ui.historyPlanContent.style.display = 'grid'; if (count === 0) return; let skeletonHTML = ''; for (let i = 0; i < count; i++) { skeletonHTML += `<div class="skeleton history-item-skeleton"><div class="skeleton text-sm" style="width: 40%;"></div><div class="skeleton title-sm" style="width: 80%; height: 16px;"></div><div class="skeleton text-sm" style="width: 50%;"></div></div>`; } ui.historyPlanContent.innerHTML = skeletonHTML; };
        const showPlanDetail = async (plan) => { /* ... (stejné jako předtím) ... */ if (!plan || !plan.id || !supabaseClient) return; ui.currentPlanSection.style.display = 'none'; ui.historyPlanSection.style.display = 'none'; ui.createPlanSection.style.display = 'none'; ui.scheduleSection.style.display = 'none'; ui.planSection.style.display = 'block'; setLoadingState('detail', true); if(ui.planContent) ui.planContent.innerHTML = ''; if(ui.planActions) ui.planActions.innerHTML = ''; if(ui.planSectionTitle) ui.planSectionTitle.textContent = 'Načítání detailu...'; if (ui.genericBackBtn) ui.genericBackBtn.onclick = () => switchTab('history'); try { if (!plan.plan_content_markdown) { console.log("Načítám plný markdown pro detail..."); const { data: fullData, error: fetchError } = await supabaseClient.from('study_plans').select('plan_content_markdown, title, created_at').eq('id', plan.id).single(); if (fetchError) throw fetchError; plan.plan_content_markdown = fullData.plan_content_markdown; plan.title = fullData.title || plan.title; plan.created_at = fullData.created_at || plan.created_at; } if(ui.planSectionTitle) ui.planSectionTitle.textContent = plan.title || 'Detail studijního plánu'; displayPlanContent(plan.plan_content_markdown || '# Studijní plán\n\nObsah plánu není k dispozici.'); if(ui.planActions) { ui.planActions.innerHTML = `<button class="btn btn-success btn-tooltip" id="exportDetailPlanBtn" title="Stáhnout plán jako PDF"><i class="fas fa-file-pdf"></i> Export PDF</button>`; const exportButton = ui.planActions.querySelector('#exportDetailPlanBtn'); if(exportButton) exportButton.addEventListener('click', () => exportPlanToPDFWithStyle(plan)); ui.planActions.style.display = 'flex'; } ui.planSection.scrollIntoView({ behavior: 'smooth' }); initTooltips(); } catch (error) { console.error("Chyba načítání detailu plánu:", error); renderMessage(ui.planContent, 'error', 'Chyba', 'Nepodařilo se načíst detail plánu.'); if(ui.planActions) ui.planActions.innerHTML = ''; } finally { setLoadingState('detail', false); } };

        // ==============================================
        //          Vytvoření Plánu (Sekce #createPlanSection)
        // ==============================================
        const getLatestDiagnostic = async (showLoaderFlag = true) => { /* ... (stejné jako předtím) ... */ if (!state.currentUser || state.currentUser.id === 'PLACEHOLDER_USER_ID' || !supabaseClient) return null; if (showLoaderFlag) setLoadingState('create', true); try { const { data, error } = await supabaseClient.from('user_diagnostics').select('id, completed_at, total_score, total_questions, topic_results, analysis').eq('user_id', state.currentUser.id).order('completed_at', { ascending: false }).limit(1); if (error) throw error; return (data && data.length > 0) ? data[0] : null; } catch (error) { console.error("Chyba načítání diagnostiky:", error); return null; } finally { if (showLoaderFlag) setLoadingState('create', false); } };
        const checkPlanCreationAvailability = async () => { /* ... (stejné jako předtím) ... */ if (!supabaseClient || !state.currentUser) return; setLoadingState('create', true); if(ui.createPlanContent) ui.createPlanContent.innerHTML = ''; try { state.latestDiagnosticData = await getLatestDiagnostic(false); if (state.latestDiagnosticData === null) { renderMessage(ui.createPlanContent, 'error', 'Chyba', 'Nepodařilo se ověřit váš diagnostický test.'); return; } else if (!state.latestDiagnosticData) { renderNoDiagnosticAvailable(ui.createPlanContent); return; } const { data: latestPlan, error: planError } = await supabaseClient.from('study_plans').select('created_at').eq('user_id', state.currentUser.id).order('created_at', { ascending: false }).limit(1); if (planError) throw planError; let canCreate = true; if (latestPlan && latestPlan.length > 0) { const lastPlanDate = new Date(latestPlan[0].created_at); const oneWeekAgo = new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate() - 7); if (lastPlanDate > oneWeekAgo) { canCreate = false; state.nextPlanCreateTime = new Date(lastPlanDate); state.nextPlanCreateTime.setDate(state.nextPlanCreateTime.getDate() + 7); } } state.planCreateAllowed = canCreate; if (canCreate) renderPlanCreationForm(); else renderLockedPlanSection(); } catch (error) { console.error('Chyba při kontrole dostupnosti vytvoření plánu:', error); renderMessage(ui.createPlanContent, 'error', 'Chyba', 'Nepodařilo se ověřit možnost vytvoření plánu.'); } finally { setLoadingState('create', false); } };
        const renderNoDiagnosticAvailable = (container) => { /* ... (stejné jako předtím) ... */ if (!container || !ui.noDiagnosticTemplate) return; const node = ui.noDiagnosticTemplate.content.cloneNode(true); const btn = node.getElementById('goToTestBtn'); if(btn) btn.onclick = () => window.location.href = 'test1.html'; container.innerHTML = ''; container.appendChild(node); container.style.display = 'block'; };
        const renderLockedPlanSection = () => { /* ... (stejné jako předtím) ... */ if(!ui.createPlanContent || !ui.lockedPlanTemplate) return; const node = ui.lockedPlanTemplate.content.cloneNode(true); const timerEl = node.getElementById('nextPlanTimer'); const viewBtn = node.getElementById('viewCurrentPlanBtnLocked'); if(timerEl) updateNextPlanTimer(timerEl); if(viewBtn) viewBtn.addEventListener('click', () => switchTab('current')); ui.createPlanContent.innerHTML = ''; ui.createPlanContent.appendChild(node); startPlanTimer(); };
        const startPlanTimer = () => { /* ... (stejné jako předtím) ... */ if (state.planTimerInterval) clearInterval(state.planTimerInterval); state.planTimerInterval = setInterval(() => { const timerEl = document.getElementById('nextPlanTimer'); if (timerEl) updateNextPlanTimer(timerEl); else clearInterval(state.planTimerInterval); }, 1000); };
        const updateNextPlanTimer = (el) => { /* ... (stejné jako předtím) ... */ if (!state.nextPlanCreateTime || !el) return; const now = new Date(); const diff = state.nextPlanCreateTime - now; if (diff <= 0) { el.textContent = 'Nyní'; clearInterval(state.planTimerInterval); state.planCreateAllowed = true; setTimeout(checkPlanCreationAvailability, 500); return; } const d = Math.floor(diff/(1000*60*60*24)), h = Math.floor((diff%(1000*60*60*24))/(1000*60*60)), m = Math.floor((diff%(1000*60*60))/(1000*60)), s = Math.floor((diff%(1000*60))/1000); el.textContent = `${d}d ${h}h ${m}m ${s}s`; };
        const renderPlanCreationForm = () => { /* ... (stejné jako předtím) ... */ if(!ui.createPlanContent || !ui.createPlanFormTemplate || !state.latestDiagnosticData) return; const node = ui.createPlanFormTemplate.content.cloneNode(true); const diagInfo = node.getElementById('diagnosticInfo'); if(diagInfo) diagInfo.innerHTML = `<p>Plán bude vycházet z testu ze dne: <strong>${formatDate(state.latestDiagnosticData.completed_at)}</strong> (Skóre: ${state.latestDiagnosticData.total_score ?? '-'})</p>`; const genBtn = node.getElementById('generatePlanBtn'); if(genBtn) genBtn.addEventListener('click', handleGenerateClick); ui.createPlanContent.innerHTML = ''; ui.createPlanContent.appendChild(node); };
        const handleGenerateClick = function() { /* ... (stejné jako předtím) ... */ this.disabled = true; this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generuji plán...'; generateStudyPlan(); };

        // ==============================================
        //          Generování a Ukládání Plánu (Sekce #planSection)
        // ==============================================
        const generateStudyPlan = async () => { /* ... (stejné jako předtím) ... */ if (!state.latestDiagnosticData || !state.currentUser) { showToast('Chybí data pro generování.', 'error'); return; } if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') { showToast('Chyba: Nastavte platný Gemini API klíč v kódu.', 'error'); return; } ui.currentPlanSection.style.display = 'none'; ui.historyPlanSection.style.display = 'none'; ui.createPlanSection.style.display = 'none'; ui.scheduleSection.style.display = 'none'; ui.planSection.style.display = 'block'; setLoadingState('generation', true); if(ui.planContent) ui.planContent.innerHTML = ''; if(ui.planActions) ui.planActions.innerHTML = ''; state.lastGeneratedMarkdown = null; state.lastGeneratedActivitiesJson = null; if (ui.genericBackBtn) ui.genericBackBtn.onclick = () => switchTab('create'); try { const topicsData = Object.entries(state.latestDiagnosticData.topic_results || {}).map(([topicKey, data]) => ({ name: data.name || state.topicMap[topicKey] || `Téma ${topicKey}`, questions: data.total || 0, correct: data.correct || 0, percentage: data.score || 0 })).sort((a, b) => a.percentage - b.percentage); const fullMarkdownResponse = await generatePlanContentWithGemini(state.latestDiagnosticData, topicsData); const jsonRegex = /```json\s*([\s\S]*?)\s*```/; const jsonMatch = fullMarkdownResponse.match(jsonRegex); let activitiesArray = null; let planMarkdownForStorage = fullMarkdownResponse; if (jsonMatch && jsonMatch[1]) { try { activitiesArray = JSON.parse(jsonMatch[1].replace(/\u00A0/g, ' ').trim()); planMarkdownForStorage = fullMarkdownResponse.replace(jsonRegex, '').trim(); state.lastGeneratedActivitiesJson = activitiesArray; } catch (e) { console.error("Chyba parsování JSON aktivit:", e); showToast("Warning: Nepodařilo se zpracovat aktivity z plánu.", "warning"); state.lastGeneratedActivitiesJson = null; } } else { console.warn("JSON blok aktivit nenalezen."); state.lastGeneratedActivitiesJson = null; } state.lastGeneratedMarkdown = planMarkdownForStorage; if(ui.planSectionTitle) ui.planSectionTitle.textContent = 'Návrh studijního plánu'; // Update title
 displayPlanContent(state.lastGeneratedMarkdown); if(ui.planActions) { ui.planActions.innerHTML = `<button class="btn btn-primary" id="saveGeneratedPlanBtn"><i class="fas fa-save"></i> Uložit tento plán</button><button class="btn btn-success btn-tooltip" id="exportGeneratedPlanBtn" title="Stáhnout návrh jako PDF"><i class="fas fa-file-pdf"></i> Export PDF</button><button class="btn btn-secondary" id="regeneratePlanBtn"><i class="fas fa-sync-alt"></i> Vygenerovat znovu</button>`; const saveBtn = ui.planActions.querySelector('#saveGeneratedPlanBtn'); const exportBtn = ui.planActions.querySelector('#exportGeneratedPlanBtn'); const regenBtn = ui.planActions.querySelector('#regeneratePlanBtn'); if(saveBtn) saveBtn.addEventListener('click', () => saveGeneratedPlan(state.lastGeneratedMarkdown, state.lastGeneratedActivitiesJson, topicsData)); if(exportBtn) exportBtn.addEventListener('click', () => exportPlanToPDFWithStyle({ created_at: new Date(), plan_content_markdown: state.lastGeneratedMarkdown, title: "Nový návrh plánu" })); if(regenBtn) regenBtn.addEventListener('click', handleGenerateClick); ui.planActions.style.display = 'flex'; } ui.planSection.scrollIntoView({ behavior: 'smooth' }); initTooltips(); } catch (error) { console.error('Chyba generování plánu:', error); renderMessage(ui.planContent, 'error', 'Chyba generování', error.message); if(ui.planActions) { ui.planActions.innerHTML = `<button class="btn btn-secondary" id="regeneratePlanBtn"><i class="fas fa-sync-alt"></i> Vygenerovat znovu</button>`; const regenBtn = ui.planActions.querySelector('#regeneratePlanBtn'); if(regenBtn) regenBtn.addEventListener('click', handleGenerateClick); ui.planActions.style.display = 'flex'; } } finally { setLoadingState('generation', false); } };
        const generatePlanContentWithGemini = async (testData, topicsData) => { /* ... (stejné jako předtím) ... */ const totalScore = testData.total_score || 0; const totalQuestions = testData.total_questions || 1; const analysis = testData.analysis || {}; const overallAssessment = analysis.summary?.overall_assessment || 'N/A'; const strengths = analysis.strengths?.map(s => `${s.topic} (${s.score}%)`).join(', ') || 'Nebyly identifikovány'; const weaknesses = analysis.weaknesses?.map(w => `${w.topic} (${w.score}%)`).join(', ') || 'Nebyly identifikovány'; const recommendations = analysis.recommendations?.join('\n- ') || 'Žádná specifická.'; const prompt = ` Jsi expertní AI tutor specializující se na přípravu na PŘIJÍMACÍ ZKOUŠKY z matematiky pro 9. třídu ZŠ v Česku. Tvým úkolem je vytvořit NÁROČNÝ, DETAILNÍ a KONZISTENTNÍ týdenní studijní plán v ČEŠTINĚ ve formátu Markdown, zaměřený na dosažení co nejlepšího výsledku u zkoušek. Na konci MUSÍŠ vygenerovat JSON pole aktivit pro tento plán, které PŘESNĚ ODRÁŽÍ obsah Markdown plánu pro daný den. # Kontext: Student právě dokončil diagnostický test. # Výsledky diagnostického testu: - Celkové skóre: ${totalScore}/50 bodů - Počet otázek: ${totalQuestions} - Výsledky podle témat (Název tématu: Plně správně/Celkem otázek (Úspěšnost %)): ${topicsData.map(topic => `  - ${topic.name}: ${topic.correct}/${topic.questions} (${topic.percentage}%)`).join('\n')} # Analýza výsledků testu (Shrnutí od AI): - Celkové hodnocení: ${overallAssessment} - Identifikované silné stránky: ${strengths} - Identifikované slabé stránky: ${weaknesses} - Doporučení na základě testu: - ${recommendations} # Oficiální Témata Zkoušky (CERMAT - detailně): 1.  **Čísla a aritmetické operace:** Přirozená čísla (do milionu), nula. Sčítání, odčítání, násobení, dělení (vlastnosti, algoritmy). Zlomky (porovnávání, sčítání/odčítání se stejným jm.). Desetinná čísla, číselná osa. 2.  **Algebra:** Mocniny, odmocniny (základní operace). Lineární rovnice (jedna neznámá, úpravy). Soustavy 2 lineárních rovnic (dosazovací, sčítací metoda). Mnohočleny (sčítání, odčítání, násobení, vytýkání, vzorce (a±b)², a²-b²). Výrazy s proměnnými (dosazování, úpravy). 3.  **Geometrie:** Základní rovinné útvary (čtverec, obdélník, trojúhelník - typy, vlastnosti, věty; kruh/kružnice - části, vlastnosti). Kreslení, náčrty. Kolmost, rovnoběžnost. Obvod, obsah rovinných útvarů. Povrch a objem těles (krychle, kvádr, válec; základy kužele, koule). Pythagorova věta. Základní konstrukční úlohy. 4.  **Práce s daty:** Tabulky, diagramy (čtení, interpretace, jednoduchá tvorba). Aritmetický průměr, modus, medián. Grafy závislostí (čtení, interpretace). 5.  **Problémové úlohy:** Slovní úlohy (převod na matematický model, řešení). Úlohy na poměr, přímá a nepřímá úměrnost, měřítko mapy. Úlohy na pohyb, společnou práci (základní typy). Aplikace matematiky. Strategie řešení. 6.  **Proporce a procenta:** Procento, promile. Procentová část, základ, počet procent. Jednoduché úrokování. Trojčlenka. Poměr (základní úpravy, rozdělení). 7.  **Logické úlohy:** Logické vztahy, jednoduché výroky, číselné řady, vzory, závislosti. # TVŮJ ÚKOL (Vytvoř NÁROČNÝ, DETAILNÍ a KONZISTENTNÍ plán): 1.  Vytvoř DETAILNÍ týdenní studijní plán (Pondělí - Neděle) ve formátu Markdown. Musí být strukturovaný, srozumitelný a zaměřený na VÝRAZNÉ zlepšení. Dbej na přirozené formátování textu, vyhni se slovům nalepeným na sebe bez mezer. 2.  Plán musí pokrývat klíčové oblasti z OFICIÁLNÍCH TÉMAT, klást ZVÝŠENÝ DŮRAZ na slabé stránky (${weaknesses}), ale ZAHRNOVAT i OPAKOVÁNÍ silnějších stránek. 3.  Navrhni RŮZNORODÉ a KONKRÉTNÍ aktivity: * Řešení KONKRÉTNÍCH TYPŮ příkladů s uvedením POČTU. * Procvičování SLOVNÍCH ÚLOH zaměřených na dané téma. * Používej formulace jako 'Opakování [téma/vzorce]' místo 'Opakuj [téma]'. Např.: 'Opakování vzorců pro mnohočleny'. * Analýzu VYSVĚTLENÝCH příkladů (např. "Projdi řešené příklady na ..."). * Doporučení k ANALÝZE minulých chyb. * Zařazení NÁROČNĚJŠÍCH úloh u silnějších témat. 4.  Buď co nejvíce SPECIFICKÝ v popisu úkolů v Markdown i JSON. Místo 'Procvičuj geometrii' uveď 'Výpočet obvodů a obsahů složených rovinných útvarů (3 úlohy)'. 5.  Rozděl denní studium (cca 75-100 minut) do 2-3 INTENZIVNÍCH bloků. Uveď odhadovaný čas. 6.  **DŮLEŽITÉ:** V poli 'description' v JSON bloku **NEUVÁDĚJ KONKRÉTNÍ ROVNICE NEBO ČÍSELNÉ ZADÁNÍ PŘÍKLADŮ**. Místo toho SLOVNĚ popiš TYP úloh, počet a zaměření (např. 'Řešení 5 lineárních rovnic se zlomky', 'Výpočet procentové části ze základu ve 4 slovních úlohách'). 7.  **NAPROSTÁ KONZISTENCE JE KLÍČOVÁ:** JSON \`title\` a \`description\` musí být PŘÍMÝM a VĚRNÝM shrnutím aktivity popsané v odpovídajícím bloku v Markdown textu pro ten samý den a časový úsek. Žádné informace nesmí být v JSON přidány ani vynechány oproti Markdown popisu daného bloku. 8.  NA KONEC celého Markdown textu PŘIDEJ validní JSON blok (\`\`\`json ... \`\`\`) obsahující pole objektů pro VŠECHNY aktivity. Klíče: "day_of_week" (číslo 0-6, Neděle=0), "title" (string, název bloku), "description" (string, SLOVNÍ popis TYPU úkolů, KONZISTENTNÍ s Markdown), "time_slot" (string, čas). # Požadovaný formát výstupu (Markdown + JSON na konci): **Analýza diagnostiky:** * Zaměření na: ${weaknesses} * Udržování: ${strengths} **Hlavní cíle pro tento týden:** * [Použij odrážky] Výrazně zlepšit [Nejslabší téma]. * [Použij odrážky] Upevnit znalosti v [Druhé nejslabší téma]. * [Použij odrážky] Zopakovat a procvičit [Silnější téma]. --- ### Pondělí * **Fokus dne:** [Např. Složitější lineární rovnice a aplikace procent] * **Blok 1 (cca 45 min): Algebra - Rovnice:** Řešení 10 složitějších lineárních rovnic se zlomky a závorkami. Důraz na správné úpravy a zkoušku. * **Blok 2 (cca 40 min): Procenta - Slovní úlohy:** Řešení 5 slovních úloh na výpočet základu a procentové změny (zdražení/sleva). * *Tip dne:* U rovnic si piš mezikroky a ověřuj si je. ### Úterý * **Fokus dne:** [Např. Geometrie - Tělesa a opakování mnohočlenů] * **Blok 1 (cca 50 min): Geometrie - Objem a povrch válce:** Opakování vzorců. Výpočet objemu a povrchu válce ve 4 úlohách (včetně slovních). * **Blok 2 (cca 30 min): Opakování - Mnohočleny:** Opakování vzorců (a±b)², a²-b². Rozklad 10 mnohočlenů na součin pomocí vytýkání a vzorců. * *Tip dne:* Kresli si náčrty těles, pomůže ti to s představivostí. * ... (atd. pro všechny dny) ... --- **Obecné tipy pro maximální efektivitu:** * ... \`\`\`json [   { "day_of_week": 1, "title": "Algebra: Složitější rovnice", "description": "Řešení 10 složitějších lineárních rovnic se zlomky a závorkami. Důraz na správné úpravy a zkoušku.", "time_slot": "45 min" },   { "day_of_week": 1, "title": "Procenta: Slovní úlohy (základ, změna)", "description": "Řešení 5 slovních úloh na výpočet základu a procentové změny (zdražení/sleva).", "time_slot": "40 min" },   { "day_of_week": 2, "title": "Geometrie: Objem a povrch válce", "description": "Opakování vzorců. Výpočet objemu a povrchu válce ve 4 úlohách (včetně slovních).", "time_slot": "50 min" },   { "day_of_week": 2, "title": "Opakování: Rozklad mnohočlenů", "description": "Opakování vzorců (a±b)², a²-b². Rozklad 10 mnohočlenů na součin pomocí vytýkání a vzorců.", "time_slot": "30 min" }   // ... (další aktivity pro všechny dny, KONZISTENTNÍ S MARKDOWNEM) ... ] \`\`\` `; try { const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.6, topK: 40, topP: 0.95, maxOutputTokens: 8192 }, safetySettings: [{ category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }] }) }); const data = await response.json(); if (!response.ok) throw new Error(data.error?.message || `Chyba Gemini API (${response.status})`); const geminiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text; if (!geminiResponse) throw new Error('Prázdná odpověď od Gemini API'); return geminiResponse; } catch (error) { console.error('Chyba při generování obsahu plánu:', error); throw error; /* Rethrow */ } };
        const saveGeneratedPlan = async (markdownContent, activitiesArray, topicsData) => { /* ... (stejné jako předtím) ... */ if (!state.currentUser || !state.latestDiagnosticData || !markdownContent || !supabaseClient) { showToast('Chyba: Chybí data pro uložení.', 'error'); return; } const saveButton = document.getElementById('saveGeneratedPlanBtn'); if (saveButton) { saveButton.disabled = true; saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ukládám...'; } const priorityTopics = {}; topicsData.forEach((topic, index) => { priorityTopics[topic.name] = { priority: index + 1, performance: topic.percentage, focus_level: topic.percentage < 50 ? 'high' : topic.percentage < 75 ? 'medium' : 'low' }; }); let savedPlanId = null; try { const { error: deactivateError } = await supabaseClient .from('study_plans') .update({ status: 'inactive', updated_at: new Date().toISOString() }) .eq('user_id', state.currentUser.id) .eq('status', 'active'); if (deactivateError) throw deactivateError; const today = new Date(); const completionDate = new Date(today); completionDate.setDate(completionDate.getDate() + 7); const newPlanData = { user_id: state.currentUser.id, title: `Studijní plán (${formatDate(today)})`, subject: "Matematika", status: "active", diagnostic_id: state.latestDiagnosticData.id, plan_content_markdown: markdownContent, priority_topics: priorityTopics, estimated_completion_date: completionDate.toISOString().split('T')[0], progress: 0, is_auto_adjusted: true }; const { data: savedPlan, error: insertPlanError } = await supabaseClient .from('study_plans') .insert(newPlanData) .select('id') .single(); if (insertPlanError) throw insertPlanError; savedPlanId = savedPlan.id; console.log("Nový plán uložen, ID:", savedPlanId); if (activitiesArray && Array.isArray(activitiesArray) && activitiesArray.length > 0) { const activitiesToInsert = activitiesArray.map(act => { if (typeof act !== 'object' || act === null) return null; const dayOfWeek = typeof act.day_of_week === 'number' ? act.day_of_week : parseInt(act.day_of_week, 10); if (isNaN(dayOfWeek) || dayOfWeek < 0 || dayOfWeek > 6) return null; return { plan_id: savedPlanId, day_of_week: dayOfWeek, time_slot: act.time_slot || null, title: act.title || 'Nespecifikováno', description: act.description || null, completed: false }; }).filter(item => item !== null); if (activitiesToInsert.length > 0) { const { error: insertActivitiesError } = await supabaseClient.from('plan_activities').insert(activitiesToInsert); if (insertActivitiesError) { console.error("Chyba vkládání aktivit:", insertActivitiesError); showToast('Plán uložen, ale aktivity pro harmonogram selhaly.', 'warning'); } else { console.log("Aktivity úspěšně vloženy."); showToast('Studijní plán a aktivity uloženy!', 'success'); } } else { showToast('Plán uložen, ale nebyly nalezeny platné aktivity.', 'warning'); } } else { showToast('Studijní plán uložen (bez detailních aktivit).', 'info'); } state.currentStudyPlan = { ...newPlanData, id: savedPlanId }; switchTab('current'); } catch (error) { console.error("Chyba při ukládání plánu:", error); showToast(`Nepodařilo se uložit plán: ${error.message}`, 'error'); if (saveButton) { saveButton.disabled = false; saveButton.innerHTML = '<i class="fas fa-save"></i> Uložit tento plán'; } } };
        const displayPlanContent = (markdownContent) => { /* ... (stejné jako předtím) ... */ if (!ui.planContent) return; try { marked.setOptions({ gfm: true, breaks: true, sanitize: false }); const htmlContent = marked.parse(markdownContent || ''); ui.planContent.innerHTML = htmlContent; ui.planContent.style.display = 'block'; if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') { setTimeout(() => { window.MathJax.typesetPromise([ui.planContent]).catch(e => console.error("MathJax chyba:", e)); }, 0); } else { console.warn("MathJax není připraven pro renderování."); } } catch (e) { console.error("Chyba renderování Markdown:", e); ui.planContent.innerHTML = "<p style='color:red;'>Chyba zobrazení plánu.</p>"; ui.planContent.style.display = 'block'; } };

        // ==============================================
        //          Export PDF
        // ==============================================
        const exportPlanToPDFWithStyle = async (plan) => { /* ... (stejné jako předtím) ... */ if (!plan) return; if (!plan.plan_content_markdown) { showToast('Načítám data pro PDF...', 'info', 2000); try { const { data: fullPlanData, error } = await supabaseClient.from('study_plans').select('plan_content_markdown, title, created_at, estimated_completion_date').eq('id', plan.id).single(); if (error) throw error; plan = { ...plan, ...fullPlanData }; } catch (fetchError) { console.error("Nepodařilo se načíst markdown pro export:", fetchError); showToast('Chyba: Nepodařilo se načíst data pro export.', 'error'); return; } } const exportContainer = document.createElement('div'); exportContainer.id = 'pdf-export-content'; const pdfStyles = ` <style> body { font-family: 'Poppins', Arial, sans-serif; font-size: 10pt; color: #333; line-height: 1.5; } #pdf-export-content { padding: 18mm 13mm; } .pdf-header { text-align: center; margin-bottom: 12mm; border-bottom: 1px solid #ccc; padding-bottom: 4mm; } .pdf-header h1 { color: #4361ee; font-size: 18pt; margin: 0 0 4px 0; font-weight: 600; } .pdf-header p { color: #6c757d; font-size: 9pt; margin: 0; } .student-info { background-color: #f8f9fa; padding: 8mm 10mm; border-radius: 8px; border: 1px solid #eee; margin-bottom: 10mm; font-size: 9pt; break-inside: avoid; } .student-info h2 { color: #3f37c9; font-size: 12pt; margin: 0 0 6px 0; padding-bottom: 3px; border-bottom: 1px dotted #ccc; font-weight: 600;} .student-info p { margin: 0 0 3px 0; line-height: 1.4; } .student-info strong { font-weight: 600; color: #1e2a3a; } .pdf-content h2, .pdf-content h3, .pdf-content h4 { margin-top: 7mm; margin-bottom: 3mm; padding-bottom: 2px; font-weight: 600; break-after: avoid; } .pdf-content h2 { font-size: 13pt; color: #3f37c9; border-bottom: 1px solid #eee; } .pdf-content h3 { font-size: 11.5pt; color: #1e2a3a; border-bottom: 1px dotted #ccc; } .pdf-content h4 { font-size: 10.5pt; color: #4361ee; border-bottom: none; margin-top: 5mm; } .pdf-content p, .pdf-content li { margin-bottom: 2.5mm; color: #333; text-align: left; } .pdf-content ul, .pdf-content ol { padding-left: 5mm; margin-left: 3mm; margin-bottom: 4mm; break-inside: avoid;} .pdf-content li { margin-bottom: 1.5mm; } .pdf-content strong { font-weight: 600; color: #000; } .pdf-content em { font-style: italic; color: #555; } .pdf-content code { font-family: 'Courier New', Courier, monospace; background-color: #f0f0f0; padding: 1px 4px; border-radius: 3px; font-size: 9pt; color: #c7254e; } .pdf-content pre { background-color: #f8f9fa; border: 1px solid #eee; padding: 3mm; margin: 4mm 0; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; font-size: 9pt; break-inside: avoid; } .pdf-content blockquote { border-left: 3px solid #ccc; padding-left: 4mm; margin: 4mm 0 4mm 2mm; color: #555; font-style: italic; break-inside: avoid; } .pdf-content hr { border: none; border-top: 1px dashed #ccc; margin: 6mm 0; } .pdf-day-block { break-before: auto; break-inside: avoid; } .pdf-footer { text-align: center; margin-top: 10mm; padding-top: 5mm; border-top: 1px solid #ccc; color: #888; font-size: 8pt; } </style> `; exportContainer.innerHTML = pdfStyles; const pdfTitle = plan.title ? plan.title.replace(/\s*\(\d{2}\.\d{2}\.\d{4}\)$/, '').trim() : 'Studijní plán'; const headerHTML = `<div class="pdf-header"><h1>${sanitizeHTML(pdfTitle)}</h1><p>Vytvořeno: ${formatDate(plan.created_at)}</p></div>`; exportContainer.innerHTML += headerHTML; if (state.currentUser && ui.userName.textContent) { exportContainer.innerHTML += `<div class="student-info"><h2>Informace o studentovi</h2><p><strong>Student:</strong> ${ui.userName.textContent}</p><p><strong>Datum vytvoření plánu:</strong> ${formatDate(plan.created_at)}</p>${plan.estimated_completion_date ? `<p><strong>Předpokládané dokončení:</strong> ${formatDate(plan.estimated_completion_date)}</p>` : ''}</div>`; } const contentDiv = document.createElement('div'); contentDiv.className = 'pdf-content'; try { const rawHtml = marked.parse(plan.plan_content_markdown || ''); contentDiv.innerHTML = rawHtml; const daysCzech = ['Pondělí', 'Úterý', 'Středa', 'Čtvrtek', 'Pátek', 'Sobota', 'Neděle']; contentDiv.querySelectorAll('h3').forEach(h3 => { if (daysCzech.some(day => h3.textContent.trim().startsWith(day))) h3.classList.add('pdf-day-block'); }); } catch (e) { contentDiv.innerHTML = '<p>Chyba při zpracování obsahu plánu.</p>'; } exportContainer.appendChild(contentDiv); exportContainer.innerHTML += `<div class="pdf-footer">&copy; ${new Date().getFullYear()} Justax.space</div>`; const options = { margin: [18, 13, 18, 13], filename: `studijni-plan-${formatDate(plan.created_at).replace(/\./g, '-')}.pdf`, image: { type: 'jpeg', quality: 0.95 }, html2canvas: { scale: 2, useCORS: true, logging: false, letterRendering: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: ['css', 'avoid-all'] } }; if (typeof html2pdf === 'function') { showToast('Generuji PDF...', 'info', 5000); html2pdf().set(options).from(exportContainer).save().then(() => { showToast('PDF bylo úspěšně vygenerováno!', 'success'); }).catch(err => { console.error("Chyba exportu PDF:", err); showToast('Nepodařilo se exportovat PDF.', 'error'); }); } else { showToast('Chyba: Knihovna pro export PDF není načtena.', 'error'); } };

        // ==============================================
        //          Spuštění Aplikace
        // ==============================================
        document.addEventListener('DOMContentLoaded', initializeApp); // Volá initializeApp po načtení DOM

    </script>
</body>
</html>