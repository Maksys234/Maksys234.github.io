<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Studijní plán</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">

    <style>
        /* --- CSS STYLES (Без изменений) --- */
        /* Základní styly */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        :root { --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9; --success: #06d6a0; --danger: #f72585; --warning: #f8961e; --info: #4895ef; --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d; --gray-light: #dee2e6; --gray-dark: #343a40; --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3); --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee); --gradient-3: linear-gradient(135deg, #f72585, #7209b7); --gradient-4: linear-gradient(135deg, #f8961e, #f3722c); --white: #ffffff; --sidebar-width: 260px; --transition-speed: 0.3s; --card-radius: 16px; --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05); --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.07); --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1); --text-primary: #2d3748; --text-secondary: #4a5568; --text-muted: #718096; }
        body { background-color: #f6f8ff; color: var(--text-primary); min-height: 100vh; display: flex; overflow-x: hidden; }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 100; box-shadow: var(--shadow-lg); transition: transform var(--transition-speed) ease, width var(--transition-speed) ease; }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; }
        .sidebar-logo { font-size: 1.5rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo i { font-size: 1.75rem; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .sidebar-item { margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; color: rgba(255, 255, 255, 0.85); text-decoration: none; border-radius: 12px; transition: all 0.2s ease; font-weight: 500; }
        .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; width: 24px; text-align: center; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--white); }
        .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); text-align: center; }
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.1); border-radius: 12px; backdrop-filter: blur(5px); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-weight: 500; overflow: hidden; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15); }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; }
        .user-name { font-weight: 600; font-size: 0.95rem; }
        .user-role { font-size: 0.8rem; opacity: 0.8; }
        main { flex: 1; margin-left: var(--sidebar-width); padding: 1.5rem 2rem; transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); }
        .dashboard-header { margin-bottom: 2rem; background-color: var(--white); border-radius: var(--card-radius); padding: 1.25rem 1.5rem; box-shadow: var(--shadow-sm); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-content h1 { font-size: 1.75rem; font-weight: 600; color: var(--dark); }
        .main-content { display: flex; flex-direction: column; gap: 1.75rem; }
        .section { background-color: var(--white); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); padding: 1.5rem; animation: fadeIn 0.5s ease forwards; }
        .section-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1.25rem; color: var(--dark); }
        .section-subtitle { font-size: 1.1rem; font-weight: 500; margin-bottom: 1rem; color: var(--dark); }
        .section-text { font-size: 1rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 1.5rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; font-size: 0.95rem; text-decoration: none; transition: all 0.3s ease; cursor: pointer; border: none; gap: 0.5rem; }
        .btn-primary { background: var(--gradient-1); color: white; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.2); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(67, 97, 238, 0.25); }
        .btn-secondary { background-color: var(--light); color: var(--text-secondary); border: 1px solid var(--gray-light); }
        .btn-secondary:hover { background-color: var(--gray-light); color: var(--dark); }
        .btn-success { background: linear-gradient(135deg, #4cc9f0, #38b2ac); color: white; box-shadow: 0 4px 10px rgba(76, 201, 240, 0.2); }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(76, 201, 240, 0.25); }
        .btn-warning { background: linear-gradient(135deg, #f8961e, #f3722c); color: white; box-shadow: 0 4px 10px rgba(248, 150, 30, 0.2); }
        .btn-warning:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(248, 150, 30, 0.25); }
        .btn-danger { background: linear-gradient(135deg, #f72585, #b5179e); color: white; box-shadow: 0 4px 10px rgba(247, 37, 133, 0.2); }
        .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(247, 37, 133, 0.25); }
        .btn-lg { padding: 0.75rem 2rem; font-size: 1rem; }
        .btn-center { margin: 0 auto; display: block; width: fit-content; }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 1rem; margin: 1.5rem 0; justify-content: center; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .ai-loading { display: flex; align-items: center; gap: 1rem; margin: 2rem 0; font-style: italic; color: var(--text-muted); justify-content: center; }
        .ai-loading-spinner { width: 24px; height: 24px; border: 3px solid rgba(67, 97, 238, 0.2); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s ease-in-out infinite; }
        .plan-content { margin-top: 1rem; padding: 1.5rem; background-color: #f9f9ff; border-radius: var(--card-radius); border-left: 4px solid var(--primary); line-height: 1.7; }
        .plan-content h1, .plan-content h2, .plan-content h3, .plan-content h4 { color: var(--primary); margin-bottom: 0.8rem; font-weight: 600; padding-bottom: 0.3rem; border-bottom: 1px solid var(--gray-light); }
        .plan-content h1 { font-size: 1.6rem; }
        .plan-content h2 { font-size: 1.4rem; margin-top: 2rem; }
        .plan-content h3 { font-size: 1.2rem; margin-top: 1.5rem; color: var(--dark); border-bottom: none;}
        .plan-content h4 { font-size: 1.1rem; margin-top: 1.2rem; color: var(--secondary); border-bottom: none; }
        .plan-content p { margin-bottom: 1rem; }
        .plan-content ul, .plan-content ol { margin-left: 1.5rem; margin-bottom: 1rem; padding-left: 1rem; }
        .plan-content li { margin-bottom: 0.7rem; }
        .plan-content li::marker { color: var(--primary); }
        .plan-content strong { color: var(--secondary); font-weight: 600; }
        .plan-content code { background-color: rgba(67, 97, 238, 0.1); padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.9rem; font-family: 'Courier New', Courier, monospace; }
        .plan-content blockquote { border-left: 3px solid var(--primary-light); padding-left: 1rem; margin: 1rem 0; color: var(--text-secondary); font-style: italic; }
        .plan-content hr { border: none; border-top: 1px dashed var(--gray-light); margin: 2rem 0; }
        .plan-content em { font-style: italic; color: var(--text-secondary); }
        .daily-schedule { margin-top: 2rem; }
        .schedule-day { background-color: var(--white); border-radius: var(--card-radius); padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow-sm); border-left: 4px solid var(--primary); }
        .schedule-day.today { border-left-color: var(--success); background-color: #f0fff9; }
        .day-name { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; color: var(--dark); display: flex; align-items: center; justify-content: space-between; }
        .day-focus { font-size: 0.9rem; font-weight: 500; color: var(--primary); background-color: rgba(67, 97, 238, 0.1); padding: 0.25rem 0.75rem; border-radius: 20px; }
        .activities { margin-top: 1rem; }
        .activity { display: flex; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px dashed var(--gray-light); gap: 1rem; }
        .activity:last-child { border-bottom: none; padding-bottom: 0; }
        .activity-time { min-width: 70px; font-weight: 600; color: var(--primary); font-size: 0.9em; }
        .activity-content { flex: 1; }
        .activity-title { font-weight: 500; color: var(--dark); margin-bottom: 0.25rem; }
        .activity-desc { font-size: 0.9rem; color: var(--text-secondary); }
        .step-navigation { display: flex; justify-content: space-between; margin-bottom: 1.5rem; }
        .notest-message { background-color: rgba(255, 214, 102, 0.2); border-left: 4px solid var(--warning); padding: 1.5rem; margin: 2rem 0; border-radius: var(--card-radius); }
        .notest-message h3 { color: var(--warning); margin-bottom: 0.75rem; font-size: 1.2rem; }
        .notest-message p { color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.5; }
        .notest-message.error { background-color: rgba(247, 37, 133, 0.1); border-left-color: var(--danger); }
        .notest-message.error h3 { color: var(--danger); }
        .notest-message.info { background-color: rgba(72, 149, 239, 0.1); border-left-color: var(--info); }
        .notest-message.info h3 { color: var(--info); }
        .plan-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .plan-meta { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; }
        .plan-date { font-size: 0.9rem; color: var(--text-muted); }
        .plan-badge { display: inline-block; font-size: 0.8rem; padding: 0.25rem 0.75rem; border-radius: 20px; background: var(--gradient-1); color: white; font-weight: 500; margin-bottom: 0.5rem; width: fit-content; }
        .plan-actions { display: flex; gap: 1rem; flex-shrink: 0; }
        .plan-progress { margin: 2rem 0; text-align: center; }
        .circular-progress { width: 150px; height: 150px; margin: 0 auto; position: relative; }
        .progress-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; font-weight: 700; color: var(--primary); }
        .progress-text { margin-top: 1rem; font-weight: 600; color: var(--text-secondary); }
        .plan-stats { display: flex; flex-wrap: wrap; gap: 1rem; margin: 2rem 0; }
        .plan-stat-card { flex: 1; min-width: 180px; background-color: var(--light); border-radius: var(--card-radius); padding: 1rem; text-align: center; transition: all 0.3s ease; }
        .plan-stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .plan-stat-icon { font-size: 1.8rem; margin-bottom: 0.75rem; color: var(--primary); background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .plan-stat-value { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--dark); }
        .plan-stat-label { font-size: 0.9rem; color: var(--text-secondary); }
        .activity-checkbox { display: flex; gap: 0.75rem; align-items: flex-start; }
        .activity-checkbox input[type="checkbox"] { min-width: 18px; height: 18px; margin-top: 3px; cursor: pointer; }
        .activity-checkbox .activity-content { text-decoration: none; transition: all 0.2s ease; }
        .activity-checkbox input[type="checkbox"]:checked + .activity-content { text-decoration: line-through; opacity: 0.7; }
        .plan-history { margin-top: 2rem; }
        .history-item { background-color: var(--white); border-radius: var(--card-radius); padding: 1.25rem; margin-bottom: 1rem; box-shadow: var(--shadow-sm); display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; cursor: pointer; }
        .history-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .history-date { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .history-title { font-weight: 600; color: var(--dark); }
        .history-status { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .history-status.active { background-color: rgba(76, 201, 240, 0.15); color: #4cc9f0; }
        .history-status.completed { background-color: rgba(67, 97, 238, 0.15); color: var(--primary); }
        .history-status.inactive { background-color: rgba(108, 117, 125, 0.15); color: var(--gray);}
        .tooltip-inner { background-color: var(--dark); color: var(--white); border-radius: 4px; padding: 0.5rem 0.75rem; font-size: 0.9rem; max-width: 250px; box-shadow: var(--shadow-md); }
        .locked-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(26, 32, 44, 0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: var(--card-radius); color: white; padding: 2rem; text-align: center; }
        .locked-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.9; }
        .locked-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; }
        .locked-message { font-size: 1rem; margin-bottom: 1.5rem; opacity: 0.9; max-width: 500px; }
        .timer-container { margin: 1rem 0 2rem; font-size: 1.2rem; font-weight: 600; }
        .plan-tabs { display: flex; margin-bottom: 2rem; border-bottom: 1px solid var(--gray-light); }
        .plan-tab { padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .plan-tab:hover { color: var(--primary); }
        .plan-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .loader-container { display: flex; justify-content: center; align-items: center; min-height: 200px; }
        .loader { width: 40px; height: 40px; border: 4px solid rgba(67, 97, 238, 0.2); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animated { animation: fadeIn 0.5s ease forwards; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 992px) { :root { --sidebar-width: 80px; } .sidebar { width: 80px; } .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; } .sidebar-link i { margin-right: 0; font-size: 1.5rem; } .sidebar-logo i { margin-right: 0; } .sidebar-header, .sidebar-link { justify-content: center; } .user-profile { justify-content: center; padding: 0.75rem 0; } .user-avatar { margin-right: 0; } .topic-grid { grid-template-columns: 1fr; } .test-summary-content { flex-direction: column; } }
        @media (max-width: 768px) { main { padding: 1rem; } .header-content { flex-direction: column; align-items: flex-start; gap: 1rem; } .plan-header { flex-direction: column; gap: 1rem; } .plan-actions { width: 100%; justify-content: center; } .plan-tabs { overflow-x: auto; white-space: nowrap; padding-bottom: 0.5rem; } .plan-tab { padding: 0.75rem 1rem; font-size: 0.9rem; } }
        @media (max-width: 576px) { :root { --sidebar-width: 0; } .sidebar { transform: translateX(-100%); z-index: 1000; width: 260px; } .sidebar.active { transform: translateX(0); } .sidebar.active .sidebar-logo span, .sidebar.active .sidebar-link span, .sidebar.active .user-info, .sidebar.active .sidebar-footer { display: block; } .sidebar.active .sidebar-link i { margin-right: 0.75rem; } .sidebar.active .sidebar-header, .sidebar.active .sidebar-link { justify-content: flex-start; } .sidebar.active .user-profile { justify-content: flex-start; padding: 1rem; } .sidebar.active .user-avatar { margin-right: 0.75rem; } main { margin-left: 0; width: 100%; } .mobile-menu-toggle { display: block; } .plan-stat-card { min-width: 100%; } .test-stats { flex-direction: column; } }
        .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; color: var(--dark); font-size: 1.5rem; margin-right: 1rem; }
        .mobile-menu-visible .sidebar { transform: translateX(0); }
        @media (prefers-color-scheme: dark) { :root { --white: #1a202c; --light: #2d3748; --dark: #e2e8f0; --gray-light: #4a5568; --text-primary: #e2e8f0; --text-secondary: #cbd5e0; --text-muted: #a0aec0; } body { background-color: #171923; } .plan-content { background-color: #1e2533; } .test-stat-card { background-color: #2d3748; } .plan-stat-card { background-color: #2d3748; } .notest-message { background-color: rgba(255, 214, 102, 0.1); } .history-item { background-color: var(--dark-bg); } .schedule-day.today { background-color: rgba(6, 214, 160, 0.08); } .toast { background-color: var(--dark-bg); border-color: var(--gray-light);} }
         /* Toast notification */
         .toast { position: fixed; bottom: 20px; right: 20px; background-color: var(--white); color: var(--text-primary); border-radius: 8px; padding: 1rem; box-shadow: var(--shadow-lg); max-width: 300px; z-index: 1001; display: flex; align-items: center; transform: translateY(120px); opacity: 0; transition: all 0.4s ease-in-out; }
         .toast.show { transform: translateY(0); opacity: 1; }
         .toast.success { border-left: 4px solid #10b981; }
         .toast.error { border-left: 4px solid var(--danger); }
         .toast.warning { border-left: 4px solid var(--warning); }
         .toast i { margin-right: 0.75rem; font-size: 1.25rem; }
         .toast.success i { color: #10b981; }
         .toast.error i { color: var(--danger); }
         .toast.warning i { color: var(--warning); }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header"> <a href="/" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
        <ul class="sidebar-menu"> <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Dashboard</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li> </ul>
        <div class="user-profile"> <div class="user-avatar" id="user-avatar">MS</div> <div class="user-info"> <div class="user-name" id="user-name">Načítání...</div> <div class="user-role" id="user-role">Student</div> </div> </div>
        <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main>
        <div class="dashboard-header">
            <div class="header-content">
                <h1>Personalizovaný studijní plán</h1>
                <button class="mobile-menu-toggle" id="mobileMenuToggle"> <i class="fas fa-bars"></i> </button>
            </div>
        </div>

        <div class="main-content">
            <div class="plan-tabs">
                <div class="plan-tab active" data-tab="current">Aktuální plán</div>
                <div class="plan-tab" data-tab="history">Historie plánů</div>
                <div class="plan-tab" data-tab="create">Vytvořit nový</div>
            </div>

            <div class="section current-plan-section" id="currentPlanSection">
                <div class="loader-container" id="currentPlanLoader"> <div class="loader"></div> </div>
                <div id="currentPlanContent" style="display: none;"> </div>
            </div>

            <div class="section history-plan-section" id="historyPlanSection" style="display: none;">
                <h2 class="section-title">Historie studijních plánů</h2>
                <div class="loader-container" id="historyLoader"> <div class="loader"></div> </div>
                <div id="historyPlanContent" class="plan-history"> </div>
            </div>

            <div class="section create-plan-section" id="createPlanSection" style="display: none;">
                <div id="planCreateContent"> </div>
            </div>

            <div class="section plan-section" id="planSection" style="display: none;">
                 <div class="step-navigation">
                     <button class="btn btn-secondary" id="backToCreateBtn"> <i class="fas fa-arrow-left"></i> Zpět </button>
                 </div>
                <h2 class="section-title">Návrh vašeho personalizovaného plánu</h2>
                <div class="ai-loading" id="planLoading"> <div class="ai-loading-spinner"></div> <div>Vytvářím personalizovaný studijní plán... Může to chvíli trvat.</div> </div>
                <div class="plan-content" id="planContent" style="display: none;">
                     <h3><i class="fas fa-check-circle" style="color: var(--success);"></i> Plán vygenerován!</h3>
                     <p>Váš detailní týdenní studijní plán byl úspěšně vygenerován na základě vašeho diagnostického testu.</p>
                     <p>Níže naleznete tlačítka pro uložení tohoto plánu (tím se stane vaším aktivním plánem a jeho aktivity se zapíší do databáze), export do PDF nebo případné vygenerování nového návrhu.</p>
                     <p><strong>Po uložení</strong> budete moci zobrazit celý detailní plán a sledovat svůj pokrok v záložce "Aktuální plán".</p>
                </div>
                <div class="action-buttons" id="planActions" style="display: none;">
                    <button class="btn btn-primary" id="savePlanBtn"> <i class="fas fa-save"></i> Uložit tento plán </button>
                    <button class="btn btn-success" id="exportPlanBtn"> <i class="fas fa-file-export"></i> Exportovat do PDF </button>
                    <button class="btn btn-secondary" id="regeneratePlanBtn"> <i class="fas fa-sync-alt"></i> Vygenerovat znovu </button>
                </div>
            </div>

             <div class="section schedule-section" id="scheduleSection" style="display: none;">
                 <div class="step-navigation">
                     <button class="btn btn-secondary" id="backToCurrentPlanBtn"> <i class="fas fa-arrow-left"></i> Zpět k přehledu plánu </button>
                 </div>
                 <h2 class="section-title">Týdenní harmonogram</h2>
                 <div class="daily-schedule" id="dailySchedule"> </div>
             </div>


            <template id="currentPlanTemplate">
                <div class="plan-header"> <div class="plan-meta"> <span class="plan-badge" id="planBadge">Aktuální plán</span> <h2 class="section-title" id="planTitle">Personalizovaný studijní plán</h2> <span class="plan-date" id="planDate">Vytvořeno: -</span> </div> <div class="plan-actions"> <button class="btn btn-success btn-tooltip" id="viewDetailBtn" title="Zobrazit podrobnosti plánu"> <i class="fas fa-eye"></i> Podrobnosti </button> <button class="btn btn-primary btn-tooltip" id="exportCurrentPlanBtn" title="Stáhnout plán jako PDF"> <i class="fas fa-file-export"></i> Export </button> </div> </div> <div class="plan-progress"> <div class="circular-progress"> <canvas id="progressCircle" width="150" height="150"></canvas> <div class="progress-value" id="progressValue">0%</div> </div> <div class="progress-text">Celkový pokrok v plánu</div> </div> <div class="plan-stats"> <div class="plan-stat-card btn-tooltip" title="Zbývající dny do předpokládaného ukončení plánu"> <div class="plan-stat-icon"> <i class="fas fa-calendar-alt"></i> </div> <div class="plan-stat-value" id="remainingDays">-</div> <div class="plan-stat-label">Zbývajících dnů</div> </div> <div class="plan-stat-card btn-tooltip" title="Počet dokončených aktivit v plánu"> <div class="plan-stat-icon"> <i class="fas fa-tasks"></i> </div> <div class="plan-stat-value" id="completedActivities">-/-</div> <div class="plan-stat-label">Dokončeno aktivit</div> </div> <div class="plan-stat-card btn-tooltip" title="Hlavní téma, na které se zaměřit"> <div class="plan-stat-icon"> <i class="fas fa-bullseye"></i> </div> <div class="plan-stat-value" id="priorityTopic">-</div> <div class="plan-stat-label">Prioritní téma</div> </div> </div> <h3 class="section-subtitle">Dnešní aktivity</h3> <div class="schedule-day today" id="todaySchedule"> </div> <div class="action-buttons"> <button class="btn btn-primary" id="viewFullScheduleBtn"> <i class="fas fa-calendar-week"></i> Celý harmonogram </button>
                </div>
            </template>
            <template id="lockedPlanTemplate">
                <div style="position: relative; min-height: 300px;"> <div class="locked-overlay"> <div class="locked-icon"> <i class="fas fa-lock"></i> </div> <h3 class="locked-title">Vytvoření nového plánu není dostupné</h3> <p class="locked-message">Nový studijní plán můžete vytvořit jednou týdně, abyste měli dostatek času pracovat na aktuálním. Váš poslední plán byl vytvořen nedávno.</p> <div class="timer-container" id="timerContainer"> Další plán můžete vytvořit za: <span id="nextPlanTimer">počítám...</span> </div> <button class="btn btn-primary" id="viewCurrentPlanBtnLocked"> <i class="fas fa-eye"></i> Zobrazit aktuální plán </button> </div> </div>
            </template>
             <template id="createPlanFormTemplate">
                <h2 class="section-title">Vytvořit nový studijní plán</h2> <div id="diagnosticInfo"> </div> <p class="section-text">Personalizovaný studijní plán bude vytvořen na základě výsledků vašeho posledního diagnostického testu. Zaměří se na vaše slabší oblasti a pomůže vám efektivně se připravit.</p> <div class="action-buttons"> <button class="btn btn-primary btn-lg" id="generatePlanBtn"> <i class="fas fa-magic"></i> Vygenerovat studijní plán </button> </div>
             </template>
             <template id="noDiagnosticTemplate">
                 <div class="notest-message"> <h3><i class="fas fa-exclamation-circle"></i> Nejprve absolvujte diagnostický test</h3> <p>Pro vytvoření personalizovaného studijního plánu je nejprve potřeba dokončit diagnostický test na stránce Procvičování, který nám pomůže identifikovat vaše silné a slabé stránky.</p> <button class="btn btn-primary" id="goToTestBtn"> <i class="fas fa-play"></i> Přejít k testu </button> </div>
             </template>
            <template id="historyItemTemplate">
                <div class="history-item" data-plan-id=""> <div class="history-info"> <div class="history-date">Vytvořeno: -</div> <div class="history-title">Studijní plán</div> </div> <div class="history-meta"> <span class="history-status active">Stav</span> </div> </div>
            </template>
        </div>
    </main>

     <div class="toast" id="toast">
         <i class="fas fa-check-circle"></i>
         <div id="toast-message">Operace byla úspěšně dokončena.</div>
     </div>

    <script
        src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous"
        defer>
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js" defer></script>

    <script>
        // ==============================================
        //          Inicializace Supabase & Gemini
        // ==============================================
        const supabaseUrl = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
        // --- ИСПРАВЛЕНИЕ: Переменная supabaseClient будет инициализирована позже ---
        let supabaseClient = null;
        // !!! DŮLEŽITÉ: Nahraďte tento klíč vaším vlastním platným API klíčem !!!
        const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // <--- ZDE VLOŽTE VÁŠ KLÍČ
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`; // Key only once here


        // ==============================================
        //          DOM Elementy
        // ==============================================
        const currentPlanSection = document.getElementById('currentPlanSection');
        const historyPlanSection = document.getElementById('historyPlanSection');
        const createPlanSection = document.getElementById('createPlanSection');
        const planSection = document.getElementById('planSection'); // Section for showing generated plan CONFIRMATION / SAVED plan DETAIL
        const scheduleSection = document.getElementById('scheduleSection'); // Section for showing full schedule detail
        const planLoading = document.getElementById('planLoading'); // Loading indicator when generating/saving
        const planContent = document.getElementById('planContent'); // Div INSIDE planSection to show confirmation or markdown detail
        const dailySchedule = document.getElementById('dailySchedule'); // Container for weekly schedule activities
        const planActions = document.getElementById('planActions'); // Buttons after plan generation (save, export, regen)
        const currentPlanLoader = document.getElementById('currentPlanLoader');
        const currentPlanContent = document.getElementById('currentPlanContent'); // Container for the ACTIVE plan overview
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const planCreateContent = document.getElementById('planCreateContent'); // Container within createPlanSection
        const historyLoader = document.getElementById('historyLoader');
        const historyPlanContent = document.getElementById('historyPlanContent'); // Container for plan history list
        const planTabs = document.querySelectorAll('.plan-tab');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const backToCreateBtn = document.getElementById('backToCreateBtn');
        const backToCurrentPlanBtn = document.getElementById('backToCurrentPlanBtn');

        // Vzory
        const currentPlanTemplate = document.getElementById('currentPlanTemplate');
        const lockedPlanTemplate = document.getElementById('lockedPlanTemplate');
        const createPlanFormTemplate = document.getElementById('createPlanFormTemplate');
        const noDiagnosticTemplate = document.getElementById('noDiagnosticTemplate');
        const historyItemTemplate = document.getElementById('historyItemTemplate');

        // Globální proměnné
        let currentUser = null; let currentProfile = null; let latestDiagnosticData = null; let currentStudyPlan = null; let previousPlans = []; let planCreateAllowed = false; let nextPlanCreateTime = null; let planTimerInterval = null; let progressCircleInstance = null; let currentTab = 'current';
        let lastGeneratedMarkdown = null; // Store the last generated detailed plan temporarily
        let lastGeneratedActivitiesJson = null; // Store the extracted activities JSON temporarily

        const topicIcons = { "Čísla a aritmetické operace": "fa-calculator", "Algebra": "fa-square-root-alt", "Geometrie": "fa-draw-polygon", "Práce s daty": "fa-chart-bar", "Problémové úlohy": "fa-lightbulb", "Proporce a procenta": "fa-percentage", "Logické úlohy": "fa-brain", "default": "fa-book" };
        const topicMap = { 1: "Čísla a aritmetické operace", 2: "Algebra", 3: "Geometrie", 4: "Práce s daty", 5: "Problémové úlohy", 6: "Proporce a procenta", 7: "Logické úlohy" };

        // ==============================================
        //          Pomocné Funkce (Mostly unchanged)
        // ==============================================
        function formatDate(dateString) { if(!dateString) return '-'; const date = new Date(dateString); return date.toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric' }); }
        function showLoader(sectionElement, loaderElement) { if(loaderElement) loaderElement.style.display = 'flex'; const contentElement = sectionElement.querySelector('[id$="Content"], .plan-history, .daily-schedule, .plan-content'); if (contentElement) contentElement.style.display = 'none'; }
        function hideLoader(loaderElement) { if(loaderElement) loaderElement.style.display = 'none'; }
        function showGlobalError(message) { const errorContainer = document.getElementById('global-error'); if(errorContainer) { errorContainer.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><div>${message}</div></div>`; errorContainer.style.display = 'block';} }
        function sanitizeHTML(str) { if (str === null || str === undefined) return ''; const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; }
        function getInitials(profileData) { if (!profileData) return 'U'; const first = profileData.first_name?.[0] || ''; const last = profileData.last_name?.[0] || ''; const usernameInitial = profileData.username?.[0] || ''; const emailInitial = profileData.email?.[0] || ''; return (first + last).toUpperCase() || usernameInitial.toUpperCase() || emailInitial.toUpperCase() || 'U'; }
        function toggleMobileMenu() { const sidebar = document.querySelector('.sidebar'); sidebar?.classList.toggle('active'); const overlay = document.querySelector('.sidebar-overlay'); overlay?.classList.toggle('active'); }
        function showToast(message, type = 'success', duration = 4000) { const toast = document.getElementById('toast'); const toastMessage = document.getElementById('toast-message'); if (!toast || !toastMessage) return; toastMessage.textContent = message; const icon = toast.querySelector('i'); icon.className = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-circle' : type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle'; toast.className = 'toast ' + type; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, duration); }

        // Инициализация Tooltipster
        function initTooltips() {
            try {
                // Добавляем проверку, существует ли jQuery и его плагин tooltipster
                if (typeof $ !== 'undefined' && $.fn.tooltipster) {
                    // Сначала удаляем старые инстансы, чтобы избежать дублирования
                    $('.btn-tooltip').tooltipster('destroy');
                    // Инициализируем новые
                    $('.btn-tooltip').tooltipster({
                         theme: 'tooltipster-shadow', // Или другая ваша тема
                         animation: 'fade',
                         delay: 100,
                         side: 'top' // Или 'bottom', 'left', 'right'
                     });
                    console.log("Tooltips initialized/re-initialized.");
                } else {
                    // Эта строка может появляться, если initTooltips вызывается ДО того, как jQuery/Tooltipster загрузились
                    console.warn("Tooltipster nebo jQuery nejsou dostupné pro inicializaci.");
                }
            } catch (e) {
                console.error("Chyba inicializace Tooltipster:", e);
            }
        }
        window.addEventListener('resize', () => { if (window.innerWidth > 992) { document.querySelector('.sidebar')?.classList.remove('active'); document.querySelector('.sidebar-overlay')?.classList.remove('active'); } });

        // ==============================================
        //          Inicializace a Navigace
        // ==============================================
        async function initializeApp() {
            try {
                // --- ИСПРАВЛЕНИЕ: Инициализация supabaseClient здесь ---
                if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
                     const { createClient } = supabase;
                     supabaseClient = createClient(supabaseUrl, supabaseKey);
                     console.log("Supabase client initialized.");
                } else {
                     throw new Error("Supabase library not loaded correctly.");
                }
                // --- Конец исправления ---

                showLoader(currentPlanSection, currentPlanLoader);
                currentUser = await getCurrentSupabaseUser();
                if (!currentUser) {
                    console.warn("Uživatel není přihlášen. Používám placeholder.");
                    currentUser = { id: 'PLACEHOLDER_USER_ID', email: 'student@example.com' };
                    currentProfile = { username: 'Testovací Student', email: 'student@example.com', points: 0 };
                } else {
                    currentProfile = await fetchUserProfile(currentUser.id);
                }
                updateUserInfoUI(currentProfile, currentUser?.email);
                setupEventListeners();
                await switchTab('current'); // Дождитесь загрузки начальной вкладки

                // Вызов initTooltips в конце инициализации
                initTooltips(); // Init tooltips after main elements and initial tab are likely ready

            } catch (error) {
                console.error('Chyba při inicializaci aplikace:', error);
                showGlobalError('Nepodařilo se inicializovat aplikaci: ' + error.message);
                // Optionally display error to user in the UI instead of alert/console
                currentPlanSection.innerHTML = `<div class="notest-message error"><h3>Chyba inicializace</h3><p>${error.message}</p></div>`;
                currentPlanSection.style.display = 'block';
                hideLoader(currentPlanLoader);
            }
        }
        async function getCurrentSupabaseUser() { if (!supabaseClient) throw new Error("Supabase client není inicializován"); const { data: { user }, error } = await supabaseClient.auth.getUser(); if (error) { console.error("Chyba získání uživatele:", error); throw new Error("Nepodařilo se získat informace o uživateli."); } return user; }
        async function fetchUserProfile(userId) { if (!userId || !supabaseClient) return null; try { const { data: profile, error } = await supabaseClient.from('profiles').select('*').eq('id', userId).single(); if (error && error.code !== 'PGRST116') { throw error; } return profile; } catch (error) { console.error("Chyba načtení profilu:", error); return null; } }
        function updateUserInfoUI(profileData, userEmail) { const displayName = `${profileData?.first_name || ''} ${profileData?.last_name || ''}`.trim() || profileData?.username || userEmail?.split('@')[0] || 'Student'; if(userName) userName.textContent = displayName; if(userAvatar) { if (profileData?.avatar_url) { userAvatar.innerHTML = `<img src="${profileData.avatar_url}" alt="Avatar">`; } else { const initials = getInitials(profileData || { email: userEmail }); userAvatar.textContent = initials; } } }
        async function checkExistingDiagnostic(userId) { if (!userId || userId === 'PLACEHOLDER_USER_ID' || !supabaseClient) { console.warn("Kontrola testu přeskočena pro placeholder uživatele nebo neinicializovaný Supabase."); return false; } try { if (loaderSubtext) loaderSubtext.textContent = 'Kontroluji předchozí testy...'; const { data: existingDiagnostic, error } = await supabaseClient.from('user_diagnostics').select('id, completed_at').eq('user_id', userId).limit(1); if (error) { console.error("Chyba při kontrole existujícího testu:", error); alert("Nepodařilo se ověřit, zda jste již test absolvovali. Pokračuji výběrem testu."); return false; } return existingDiagnostic && existingDiagnostic.length > 0; } catch(err) { console.error("Neočekávaná chyba při kontrole testu:", err); alert("Nastala neočekávaná chyba při kontrole. Pokračuji výběrem testu."); return false; } }
        function setupEventListeners() { if (mobileMenuToggle) mobileMenuToggle.addEventListener('click', toggleMobileMenu); planTabs.forEach(tab => { tab.addEventListener('click', () => switchTab(tab.dataset.tab)); }); if (backToCreateBtn) backToCreateBtn.addEventListener('click', () => switchTab('create')); if (backToCurrentPlanBtn) backToCurrentPlanBtn.addEventListener('click', () => switchTab('current')); }
        async function switchTab(tabId) { if (!supabaseClient) { showGlobalError("Aplikace není správně inicializována (chybí Supabase)."); return; } currentTab = tabId; planTabs.forEach(tab => { tab.classList.toggle('active', tab.dataset.tab === tabId); }); currentPlanSection.style.display = 'none'; historyPlanSection.style.display = 'none'; createPlanSection.style.display = 'none'; planSection.style.display = 'none'; scheduleSection.style.display = 'none'; if (tabId === 'current') { currentPlanSection.style.display = 'block'; await loadCurrentPlan(); } else if (tabId === 'history') { historyPlanSection.style.display = 'block'; await loadPlanHistory(); } else if (tabId === 'create') { createPlanSection.style.display = 'block'; await checkPlanCreationAvailability(); } }

        // ==============================================
        //          Aktuální Plán
        // ==============================================
        async function loadCurrentPlan() { if (!supabaseClient) { console.error("Nelze načíst plán: Supabase client není inicializován."); currentPlanContent.innerHTML = `<div class="notest-message error"><h3>Chyba</h3><p>Aplikace není správně inicializována.</p></div>`; hideLoader(currentPlanLoader); currentPlanContent.style.display = 'block'; return; } showLoader(currentPlanSection, currentPlanLoader); currentPlanContent.innerHTML = ''; try { if (!currentUser) throw new Error('Uživatel není přihlášen'); const { data: plans, error } = await supabaseClient.from('study_plans').select('*').eq('user_id', currentUser.id).eq('status', 'active').order('created_at', { ascending: false }).limit(1); if (error) throw error; if (plans && plans.length > 0) { currentStudyPlan = plans[0]; renderCurrentPlan(currentStudyPlan); } else { currentStudyPlan = null; const diagnostic = await getLatestDiagnostic(); if (diagnostic) { renderPromptCreatePlan(); } else { renderNoDiagnosticAvailable(currentPlanContent); } } } catch (error) { console.error('Chyba při načítání aktuálního plánu:', error); currentPlanContent.innerHTML = `<div class="notest-message error"><h3><i class="fas fa-exclamation-circle"></i> Chyba</h3><p>Nepodařilo se načíst aktuální plán.</p></div>`; } finally { hideLoader(currentPlanLoader); currentPlanContent.style.display = 'block'; initTooltips(); /* Re-init tooltips after content load */ } }

        function renderCurrentPlan(plan) {
            const planFragment = currentPlanTemplate.content.cloneNode(true);
            planFragment.getElementById('planTitle').textContent = plan.title || 'Personalizovaný studijní plán';
            planFragment.getElementById('planDate').textContent = `Vytvořeno: ${formatDate(plan.created_at)}`;
            planFragment.getElementById('progressValue').textContent = `${plan.progress || 0}%`;
            const today = new Date();
            const estimatedEndDate = plan.estimated_completion_date ? new Date(plan.estimated_completion_date) : null;
            const daysLeft = estimatedEndDate ? Math.max(0, Math.ceil((estimatedEndDate - today) / (1000 * 60 * 60 * 24))) : '-';
            planFragment.getElementById('remainingDays').textContent = daysLeft;
            loadAndRenderActivities(plan.id, planFragment.getElementById('completedActivities'), planFragment.getElementById('todaySchedule'));
             let priorityTopic = '-';
             if (plan.priority_topics && typeof plan.priority_topics === 'object') {
                const topics = Object.entries(plan.priority_topics)
                    .filter(([, data]) => data && typeof data.priority === 'number') // Filter out entries without priority
                    .sort(([, a], [, b]) => a.priority - b.priority); // Sort by priority
                if (topics.length > 0) {
                     priorityTopic = topics[0][0] || '-'; // Get the key (topic name) of the first element
                 }
            }
            planFragment.getElementById('priorityTopic').textContent = priorityTopic;

            planFragment.getElementById('viewDetailBtn').addEventListener('click', () => showPlanDetail(plan));
            planFragment.getElementById('exportCurrentPlanBtn').addEventListener('click', () => exportPlanToPDFWithStyle(plan));
            planFragment.getElementById('viewFullScheduleBtn').addEventListener('click', () => showFullSchedule(plan));
            // Функция ручного обновления закомментирована
            // planFragment.getElementById('updateProgressBtn').addEventListener('click', () => updatePlanProgressManually(plan));
            currentPlanContent.innerHTML = '';
            currentPlanContent.appendChild(planFragment);
            initProgressCircle('progressCircle', plan.progress || 0);

            // Повторный вызов initTooltips после рендеринга
            initTooltips();
        }
        async function loadAndRenderActivities(planId, completedElement, todayScheduleElement) { if (!supabaseClient) return; try { const { data: activities, error } = await supabaseClient.from('plan_activities').select('*').eq('plan_id', planId); if (error) throw error; const totalActivities = activities?.length || 0; const completedCount = activities?.filter(a => a.completed).length || 0; if(completedElement) completedElement.textContent = `${completedCount}/${totalActivities}`; const today = new Date(); const dayOfWeek = today.getDay(); const todayActivities = activities?.filter(a => a.day_of_week === dayOfWeek) || []; renderDayActivities(todayActivities, todayScheduleElement, planId); } catch (error) { console.error("Chyba načítání aktivit plánu:", error); if(completedElement) completedElement.textContent = 'Chyba'; if(todayScheduleElement) todayScheduleElement.innerHTML = '<p>Chyba načítání dnešních aktivit.</p>'; } }
        function renderDayActivities(activities, container, planId) { if (!container) return; if (!activities || activities.length === 0) { container.innerHTML = '<p>Žádné aktivity pro dnešek.</p>'; return; } container.innerHTML = ''; const activitiesContainer = document.createElement('div'); activitiesContainer.className = 'activities'; activities.sort((a, b) => (a.time_slot || '').localeCompare(b.time_slot || '')); activities.forEach(activity => { const activityElement = document.createElement('div'); activityElement.className = 'activity'; activityElement.innerHTML = `<div class="activity-checkbox"><input type="checkbox" id="activity-${activity.id}" ${activity.completed ? 'checked' : ''}><div class="activity-content"><div class="activity-title">${sanitizeHTML(activity.title || '')} ${activity.time_slot ? `(${activity.time_slot})` : ''}</div><div class="activity-desc">${sanitizeHTML(activity.description || '')}</div></div></div>`; const checkbox = activityElement.querySelector('input[type="checkbox"]'); checkbox.addEventListener('change', function() { handleActivityCompletionToggle(activity.id, this.checked, planId); }); activitiesContainer.appendChild(activityElement); }); container.appendChild(activitiesContainer); }
        async function handleActivityCompletionToggle(activityId, isCompleted, planId) { if (!supabaseClient) return; try { const { error: updateError } = await supabaseClient.from('plan_activities').update({ completed: isCompleted, updated_at: new Date().toISOString() }).eq('id', activityId); if (updateError) throw updateError; console.log(`Aktivita ${activityId} označena jako ${isCompleted ? 'dokončená' : 'nedokončená'}`); await updatePlanProgress(planId); } catch (error) { console.error(`Chyba aktualizace stavu aktivity ${activityId}:`, error); showToast('Nepodařilo se aktualizovat stav aktivity', 'error'); const checkbox = document.getElementById(`activity-${activityId}`); if (checkbox) checkbox.checked = !isCompleted; /* Revert checkbox on error */ const checkboxSchedule = document.getElementById(`schedule-activity-${activityId}`); if(checkboxSchedule) checkboxSchedule.checked = !isCompleted; } }
        async function updatePlanProgress(planId) { if (!planId || !supabaseClient) return; try { const { data: activities, error: activitiesError } = await supabaseClient.from('plan_activities').select('completed').eq('plan_id', planId); if (activitiesError) throw activitiesError; if (!activities || activities.length === 0) return; const completedCount = activities.filter(a => a.completed).length; const progress = Math.round((completedCount / activities.length) * 100); const { error: planUpdateError } = await supabaseClient.from('study_plans').update({ progress: progress, updated_at: new Date().toISOString() }).eq('id', planId); if (planUpdateError) throw planUpdateError; console.log(`Pokrok plánu ${planId} aktualizován na ${progress}%`); if (currentStudyPlan && currentStudyPlan.id === planId) { currentStudyPlan.progress = progress; } const progressValueElement = document.getElementById('progressValue'); const completedActivitiesElement = document.getElementById('completedActivities'); if (progressValueElement) progressValueElement.textContent = `${progress}%`; if (completedActivitiesElement) completedActivitiesElement.textContent = `${completedCount}/${activities.length}`; updateProgressCircle('progressCircle', progress); } catch (error) { console.error(`Chyba při aktualizaci pokroku plánu ${planId}:`, error); } }

        // Функция ручного обновления закомментирована
        /*
        function updatePlanProgressManually(plan) { ... }
        */

         // Show Plan Details - Fetches FULL markdown content
         async function showPlanDetail(plan) {
             if (!plan || !plan.id || !supabaseClient) return;
             currentPlanSection.style.display = 'none'; historyPlanSection.style.display = 'none'; createPlanSection.style.display = 'none'; scheduleSection.style.display = 'none';
             planSection.style.display = 'block'; showLoader(planSection, planLoading); planActions.style.display = 'none'; planContent.style.display = 'none';
             try {
                 const { data: fullPlanData, error } = await supabaseClient.from('study_plans').select('plan_content_markdown, title, created_at, estimated_completion_date').eq('id', plan.id).single();
                 if (error) throw error;
                 const planTitleElement = planSection.querySelector('.section-title'); if(planTitleElement) planTitleElement.textContent = fullPlanData.title || 'Detail studijního plánu';
                 displayPlanContent(fullPlanData.plan_content_markdown || '# Studijní plán\n\nObsah plánu není k dispozici.'); // Display the fetched markdown
                 planActions.innerHTML = ` <button class="btn btn-secondary" id="backToSourceTabBtn"> <i class="fas fa-arrow-left"></i> Zpět </button> <button class="btn btn-primary" id="viewScheduleDetailBtn"> <i class="fas fa-calendar-alt"></i> Zobrazit rozvrh </button> <button class="btn btn-success" id="exportDetailPlanBtn"> <i class="fas fa-file-export"></i> Export PDF </button> `;
                 document.getElementById('backToSourceTabBtn').addEventListener('click', () => switchTab(currentTab)); document.getElementById('viewScheduleDetailBtn').addEventListener('click', () => showFullSchedule(plan)); document.getElementById('exportDetailPlanBtn').addEventListener('click', () => exportPlanToPDFWithStyle(fullPlanData)); planActions.style.display = 'flex';
                 planSection.scrollIntoView({ behavior: 'smooth' });
             } catch (error) { console.error("Chyba načítání detailu plánu:", error); planContent.innerHTML = `<div class="notest-message error"><h3>Chyba</h3><p>Nepodařilo se načíst detail plánu.</p></div>`; planContent.style.display = 'block';
             } finally { hideLoader(planLoading); }
         }

        async function showFullSchedule(plan) { if (!plan || !supabaseClient) return; planSection.style.display = 'none'; scheduleSection.style.display = 'block'; dailySchedule.innerHTML = '<div class="loader-container"><div class="loader"></div></div>'; try { const { data: activities, error } = await supabaseClient.from('plan_activities').select('*').eq('plan_id', plan.id).order('day_of_week').order('time_slot'); if (error) throw error; renderWeeklySchedule(activities || [], plan.id); scheduleSection.scrollIntoView({ behavior: 'smooth' }); } catch (error) { console.error("Chyba načítání celého rozvrhu:", error); dailySchedule.innerHTML = '<p>Nepodařilo se načíst rozvrh.</p>'; } }

        // Функция renderWeeklySchedule исправлена
        function renderWeeklySchedule(activities, planId) {
            const days = ['Neděle', 'Pondělí', 'Úterý', 'Středa', 'Čtvrtek', 'Pátek', 'Sobota'];
            dailySchedule.innerHTML = ''; // Очистка предыдущего содержимого

            if (!activities || activities.length === 0) {
                 dailySchedule.innerHTML = '<p><i>Žádné naplánované aktivity pro tento týden.</i></p>';
                 return;
            }

            for (let i = 0; i < 7; i++) {
                const dayIndex = i;
                const dayActivities = activities.filter(a => a.day_of_week === dayIndex);
                const isToday = new Date().getDay() === dayIndex;

                const dayElement = document.createElement('div');
                dayElement.className = `schedule-day ${isToday ? 'today' : ''}`;
                dayElement.innerHTML = `<div class="day-name">${days[dayIndex]} ${isToday ? '(Dnes)' : ''}</div>`;

                const activitiesContainer = document.createElement('div');
                activitiesContainer.className = 'activities';

                if (dayActivities.length === 0) {
                    activitiesContainer.innerHTML = '<p><i>Žádné aktivity pro tento den.</i></p>';
                } else {
                     // Сортировка активностей дня по time_slot, если доступно
                    dayActivities.sort((a, b) => (a.time_slot || '').localeCompare(b.time_slot || ''));

                    dayActivities.forEach(activity => {
                        const activityElement = document.createElement('div');
                        activityElement.className = 'activity';
                        activityElement.innerHTML = `
                            <div class="activity-checkbox">
                                <input type="checkbox" id="schedule-activity-${activity.id}" ${activity.completed ? 'checked' : ''}>
                                <div class="activity-content">
                                    <div class="activity-title">
                                        ${sanitizeHTML(activity.title || '')} ${activity.time_slot ? `(${activity.time_slot})` : ''}
                                    </div>
                                    <div class="activity-desc">
                                        ${sanitizeHTML(activity.description || '')}
                                    </div>
                                </div>
                            </div>`;
                        const checkbox = activityElement.querySelector('input[type="checkbox"]');
                        // Добавляем обработчик события ПОСЛЕ создания элемента
                        checkbox.addEventListener('change', function() {
                            handleActivityCompletionToggle(activity.id, this.checked, planId);
                        });
                        activitiesContainer.appendChild(activityElement);
                    });
                }
                dayElement.appendChild(activitiesContainer);
                dailySchedule.appendChild(dayElement);
            }
        }

        function renderPromptCreatePlan() { currentPlanContent.innerHTML = `<div class="notest-message info"><h3><i class="fas fa-clipboard-check"></i> Diagnostický test dokončen</h3><p>Váš poslední diagnostický test je připraven k analýze. Můžete nyní vygenerovat nový personalizovaný studijní plán.</p><button class="btn btn-primary" id="createNewPlanFromPromptBtn"><i class="fas fa-plus-circle"></i> Vytvořit studijní plán</button></div>`; document.getElementById('createNewPlanFromPromptBtn').addEventListener('click', () => switchTab('create')); }


        // ==============================================
        //          Historie Plánů
        // ==============================================
        async function loadPlanHistory() { if (!supabaseClient) { console.error("Nelze načíst historii: Supabase client není inicializován."); historyPlanContent.innerHTML = `<div class="notest-message error"><h3>Chyba</h3><p>Aplikace není správně inicializována.</p></div>`; hideLoader(historyLoader); historyPlanContent.style.display = 'block'; return; } showLoader(historyPlanSection, historyLoader); historyPlanContent.innerHTML = ''; try { if (!currentUser) throw new Error('Uživatel není přihlášen'); const { data: plans, error } = await supabaseClient.from('study_plans').select('id, title, created_at, status, progress, plan_content_markdown').eq('user_id', currentUser.id).order('created_at', { ascending: false }); if (error) throw error; previousPlans = plans || []; renderPlanHistory(previousPlans); } catch (error) { console.error('Chyba při načítání historie plánů:', error); historyPlanContent.innerHTML = `<div class="notest-message error"><h3>Chyba</h3><p>Nepodařilo se načíst historii plánů.</p></div>`; } finally { hideLoader(historyLoader); historyPlanContent.style.display = 'block'; } }
        function renderPlanHistory(plans) { historyPlanContent.innerHTML = ''; if (!plans || plans.length === 0) { historyPlanContent.innerHTML = `<div class="notest-message"><h3>Žádná historie</h3><p>Zatím jste nevytvořili žádné studijní plány.</p></div>`; return; } plans.forEach(plan => { const historyFragment = historyItemTemplate.content.cloneNode(true); const historyItem = historyFragment.querySelector('.history-item'); historyItem.dataset.planId = plan.id; historyFragment.querySelector('.history-date').textContent = `Vytvořeno: ${formatDate(plan.created_at)}`; historyFragment.querySelector('.history-title').textContent = plan.title || "Studijní plán"; const statusElement = historyFragment.querySelector('.history-status'); const statusText = plan.status === 'active' ? 'Aktivní' : plan.status === 'completed' ? 'Dokončený' : 'Neaktivní'; statusElement.textContent = statusText; statusElement.className = `history-status ${plan.status || 'inactive'}`; historyItem.addEventListener('click', () => showPlanDetail(plan)); historyPlanContent.appendChild(historyFragment); }); }


        // ==============================================
        //          Vytvoření Nového Plánu
        // ==============================================
         async function getLatestDiagnostic() { if (!currentUser || currentUser.id === 'PLACEHOLDER_USER_ID' || !supabaseClient) return null; try { const { data, error } = await supabaseClient.from('user_diagnostics').select('*').eq('user_id', currentUser.id).order('completed_at', { ascending: false }).limit(1); if (error) throw error; return (data && data.length > 0) ? data[0] : null; } catch (error) { console.error("Chyba načítání diagnostiky:", error); return null; } }
         async function checkPlanCreationAvailability() { if (!supabaseClient) { console.error("Nelze zkontrolovat dostupnost: Supabase client není inicializován."); planCreateContent.innerHTML = `<div class="notest-message error"><h3>Chyba</h3><p>Aplikace není správně inicializována.</p></div>`; return; } planCreateContent.innerHTML = '<div class="loader-container"><div class="loader"></div></div>'; try { if (!currentUser) throw new Error('Uživatel není přihlášen'); latestDiagnosticData = await getLatestDiagnostic(); if (!latestDiagnosticData) { renderNoDiagnosticAvailable(planCreateContent); return; } const { data: latestPlan, error: planError } = await supabaseClient.from('study_plans').select('created_at').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(1); if (planError) throw planError; let canCreate = true; if (latestPlan && latestPlan.length > 0) { const lastPlanDate = new Date(latestPlan[0].created_at); const oneWeekAgo = new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate() - 7); if (lastPlanDate > oneWeekAgo) { canCreate = false; nextPlanCreateTime = new Date(lastPlanDate); nextPlanCreateTime.setDate(nextPlanCreateTime.getDate() + 7); } } if (canCreate) { planCreateAllowed = true; renderPlanCreationForm(); } else { planCreateAllowed = false; renderLockedPlanSection(); } } catch (error) { console.error('Chyba při kontrole dostupnosti vytvoření plánu:', error); planCreateContent.innerHTML = `<div class="notest-message error"><h3>Chyba</h3><p>Nepodařilo se ověřit možnost vytvoření plánu.</p></div>`; } }
         function renderNoDiagnosticAvailable(container) { const noDiagFragment = noDiagnosticTemplate.content.cloneNode(true); noDiagFragment.getElementById('goToTestBtn').addEventListener('click', () => { window.location.href = 'test1.html'; }); container.innerHTML = ''; container.appendChild(noDiagFragment); }
         function renderLockedPlanSection() { const lockedFragment = lockedPlanTemplate.content.cloneNode(true); updateNextPlanTimer(lockedFragment.getElementById('nextPlanTimer')); lockedFragment.getElementById('viewCurrentPlanBtnLocked').addEventListener('click', () => switchTab('current')); planCreateContent.innerHTML = ''; planCreateContent.appendChild(lockedFragment); startPlanTimer(); }
         function startPlanTimer() { if (planTimerInterval) clearInterval(planTimerInterval); planTimerInterval = setInterval(() => { const timerElement = document.getElementById('nextPlanTimer'); if (timerElement) updateNextPlanTimer(timerElement); else clearInterval(planTimerInterval); }, 1000); }
         function updateNextPlanTimer(timerElement) { if (!nextPlanCreateTime) return; const now = new Date(); const timeDiff = nextPlanCreateTime - now; if (timeDiff <= 0) { timerElement.textContent = 'Nyní můžete vytvořit nový plán'; clearInterval(planTimerInterval); planCreateAllowed = true; setTimeout(checkPlanCreationAvailability, 1000); return; } const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24)); const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60)); const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000); timerElement.textContent = `${days} ${getDeclension(days, 'den', 'dny', 'dní')} ${hours} ${getDeclension(hours, 'hodina', 'hodiny', 'hodin')} ${minutes} ${getDeclension(minutes, 'minuta', 'minuty', 'minut')} ${seconds} ${getDeclension(seconds, 'sekunda', 'sekundy', 'sekund')}`; }
         function getDeclension(number, singular, plural1, plural2) { number = Math.abs(number); if (number === 1) return singular; if (number >= 2 && number <= 4) return plural1; return plural2; }
         function renderPlanCreationForm() { const formFragment = createPlanFormTemplate.content.cloneNode(true); const diagInfoContainer = formFragment.getElementById('diagnosticInfo'); diagInfoContainer.innerHTML = ` <p class="section-text">Plán bude vycházet z vašeho posledního testu ze dne: <strong>${formatDate(latestDiagnosticData.completed_at)}</strong> (Skóre: ${latestDiagnosticData.total_score}/50).</p>`; formFragment.getElementById('generatePlanBtn').addEventListener('click', function() { this.disabled = true; this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generuji plán...'; generateStudyPlan(); }); planCreateContent.innerHTML = ''; planCreateContent.appendChild(formFragment); }

        // ==============================================
        //          Generování a Ukládání Plánu
        // ==============================================
         async function generateStudyPlan() {
             if (!latestDiagnosticData || !currentUser) { alert('Chyba: Chybí data uživatele nebo diagnostiky pro generování plánu.'); const btn = document.getElementById('generatePlanBtn'); if(btn){ btn.disabled = false; btn.innerHTML = '<i class="fas fa-magic"></i> Vygenerovat studijní plán'; } return; }
             createPlanSection.style.display = 'none'; planSection.style.display = 'block'; showLoader(planSection, planLoading); planActions.style.display = 'none'; planContent.style.display = 'none';
             lastGeneratedMarkdown = null; // Clear previous generation results
             lastGeneratedActivitiesJson = null;

             try {
                  const topicsData = Object.entries(latestDiagnosticData.topic_results || {}).map(([topicKey, data]) => ({ name: data.name || topicMap[topicKey] || `Téma ${topicKey}`, questions: data.total || 0, correct: data.correct || 0, percentage: data.score || 0 })).sort((a, b) => a.percentage - b.percentage);

                 // Generate the FULL detailed plan markdown (including the JSON block request)
                 const fullMarkdownResponse = await generatePlanContentWithGemini(latestDiagnosticData, topicsData);

                 // Attempt to extract JSON block from the response
                  const jsonRegex = /```json\s*([\s\S]*?)\s*```/;
                  const jsonMatch = fullMarkdownResponse.match(jsonRegex);
                  let activitiesArray = null;
                  let planMarkdownForStorage = fullMarkdownResponse; // Default to full response

                  if (jsonMatch && jsonMatch[1]) {
                      // Очистка JSON строки от неразрывных пробелов (U+00A0) и других потенциально проблемных символов в начале/конце строк JSON
                      const cleanedJsonString = jsonMatch[1]
                          .replace(/\u00A0/g, ' ') // Заменяем неразрывные пробелы на обычные
                          .trim(); // Удаляем пробелы в начале и конце всего блока
                      try {
                           activitiesArray = JSON.parse(cleanedJsonString);
                           // Remove the JSON block from the markdown we save
                           planMarkdownForStorage = fullMarkdownResponse.replace(jsonRegex, '').trim();
                           lastGeneratedActivitiesJson = activitiesArray; // Store extracted JSON
                           console.log("Extrahované a očištěné aktivity (JSON):", activitiesArray);
                      } catch (parseError) {
                           console.error("Chyba parsování OČIŠTĚNÉHO JSON z odpovědi Gemini:", parseError, "Původní extrahovaný string:", jsonMatch[1], "Očištěný string:", cleanedJsonString);
                           showToast("Varování: Nepodařilo se správně zpracovat aktivity z plánu pro harmonogram.", "warning");
                           // Keep full markdown, activities will be null
                           lastGeneratedActivitiesJson = null;
                      }
                  } else {
                       console.warn("JSON blok s aktivitami nebyl nalezen v odpovědi Gemini.");
                       lastGeneratedActivitiesJson = null;
                  }

                  lastGeneratedMarkdown = planMarkdownForStorage; // Store markdown without JSON block

                 // Display confirmation message
                 displayPlanGenerationConfirmation();

                 planActions.innerHTML = ` <button class="btn btn-primary" id="saveGeneratedPlanBtn"> <i class="fas fa-save"></i> Uložit tento plán </button> <button class="btn btn-success" id="exportGeneratedPlanBtn"> <i class="fas fa-file-export"></i> Exportovat do PDF </button> <button class="btn btn-secondary" id="regeneratePlanBtn"> <i class="fas fa-sync-alt"></i> Vygenerovat znovu </button> `;
                 document.getElementById('saveGeneratedPlanBtn').addEventListener('click', () => saveGeneratedPlan(lastGeneratedMarkdown, lastGeneratedActivitiesJson, topicsData)); // Pass extracted activities
                 document.getElementById('exportGeneratedPlanBtn').addEventListener('click', () => exportPlanToPDFWithStyle({ created_at: new Date(), plan_content_markdown: lastGeneratedMarkdown, title: "Nový návrh plánu" }));
                 document.getElementById('regeneratePlanBtn').addEventListener('click', () => { const btn = document.getElementById('generatePlanBtn'); if(btn){ btn.disabled = false; btn.innerHTML = '<i class="fas fa-magic"></i> Vygenerovat studijní plán'; } generateStudyPlan(); });
                 planActions.style.display = 'flex';

             } catch (error) { /* ... error handling ... */ console.error('Chyba při generování studijního plánu:', error); planContent.innerHTML = `<div class="notest-message error"><h3>Chyba generování</h3><p>${error.message}</p></div>`; planContent.style.display = 'block'; planActions.innerHTML = `<button class="btn btn-secondary" id="regeneratePlanBtn"> <i class="fas fa-sync-alt"></i> Vygenerovat znovu </button>`; document.getElementById('regeneratePlanBtn').addEventListener('click', () => { const btn = document.getElementById('generatePlanBtn'); if(btn){ btn.disabled = false; btn.innerHTML = '<i class="fas fa-magic"></i> Vygenerovat studijní plán'; } generateStudyPlan(); }); planActions.style.display = 'flex';
             } finally { hideLoader(planLoading); }
         }

        // **UPDATED PROMPT with JSON block request** (Prompt остается тем же)
        async function generatePlanContentWithGemini(testData, topicsData) {
             if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') { console.error("Chyba: Gemini API klíč není nastaven."); return `## Chyba konfigurace\n\nNebyl nalezen platný Gemini API klíč.`; }
             try {
                 const totalScore = testData.total_score || 0; const totalQuestions = testData.total_questions || 1; const analysis = testData.analysis || {};
                 const overallAssessment = analysis.summary?.overall_assessment || 'N/A'; const strengths = analysis.strengths?.map(s => `${s.topic} (${s.score}%)`).join(', ') || 'Nebyly identifikovány'; const weaknesses = analysis.weaknesses?.map(w => `${w.topic} (${w.score}%)`).join(', ') || 'Nebyly identifikovány'; const recommendations = analysis.recommendations?.join('\n- ') || 'Žádná specifická.';
                 const prompt = `
                 Jsi expertní AI tutor specializující se na přípravu na přijímací zkoušky z matematiky pro české studenty (9. třída). Tvým úkolem je vytvořit VELMI DETAILNÍ a PERSONALIZOVANÝ týdenní studijní plán v ČEŠTINĚ ve formátu Markdown A ZÁROVEŇ vygenerovat JSON pole aktivit pro tento plán.

                 # Kontext: Student právě dokončil diagnostický test.
                 # Výsledky diagnostického testu:
                 - Celkové skóre: ${totalScore}/50 bodů
                 - Počet otázek: ${totalQuestions}
                 - Výsledky podle témat (Název tématu: Plně správně/Celkem otázek (Úspěšnost %)):
                 ${topicsData.map(topic => `  - ${topic.name}: ${topic.correct}/${topic.questions} (${topic.percentage}%)`).join('\n')}
                 # Analýza výsledků testu (Shrnutí od AI):
                 - Celkové hodnocení: ${overallAssessment}
                 - Identifikované silné stránky: ${strengths}
                 - Identifikované slabé stránky: ${weaknesses}
                 - Doporučení na základě testu: - ${recommendations}

                 # Seznam VŠECH klíčových témat pro přijímací zkoušky:
                 1. **Čísla a aritmetické operace:** Přirozená čísla, nula, operace (+,-,*,/), zlomky (porovnání, sčítání/odčítání se stejným jm.), desetinná čísla, číselná osa.
                 2. **Algebra:** Mocniny, odmocniny, lineární rovnice (i soustavy 2 neznámých), mnohočleny (operace, rozklad), proměnné.
                 3. **Geometrie:** Základní rovinné útvary (čtverec, obdélník, trojúhelník, kruh - vlastnosti), kreslení, náčrty, kolmost, rovnoběžnost, obvod/obsah/povrch/objem 3D útvarů (krychle, kvádr, válec, kužel, koule).
                 4. **Práce s daty:** Tabulky, diagramy (tvorba, čtení), průměr, modus, medián, grafy závislostí.
                 5. **Problémové úlohy:** Slovní úlohy, matematické modelování, aplikace aritmetiky/algebry v praxi, strategie řešení.
                 6. **Proporce a procenta:** Pojmy, výpočty procent, části, základu, trojčlenka, poměry.
                 7. **Logické úlohy:** Vztahy, závěry, posloupnosti, zákonitosti.

                 # TVŮJ ÚKOL:
                 1.  Vytvoř DETAILNÍ týdenní studijní plán (Pondělí - Neděle) ve formátu Markdown podle níže uvedené struktury.
                 2.  Plán musí být: Personalizovaný (zaměřený na ${weaknesses}), Detailní (konkrétní typy a počty úloh), Specifický (úlohy dle úrovně), Strukturovaný, Časově orientovaný (cca 60-90 min/den), Srozumitelný.
                 3.  **NA KONEC celého Markdown textu PŘIDEJ samostatný JSON blok**, který začíná \`\`\`json a končí \`\`\` a obsahuje pole objektů reprezentujících VŠECHNY aktivity z týdenního plánu. Každý objekt v poli musí mít klíče: "day_of_week" (číslo 0-6, Neděle=0), "title" (string, název aktivity/bloku), "description" (string, stručný popis úkolu), "time_slot" (string, odhadovaný čas, např. "30 min").

                 # Požadovaný formát výstupu (Markdown + JSON na konci):

                 ## Týdenní studijní plán (Personalizovaný)
                 **Shrnutí diagnostiky:**
                 * ...
                 **Hlavní cíle pro tento týden:**
                 * ...
                 ---
                 ### Pondělí
                 * **Fokus dne:** ...
                 * **Blok 1 (XX min):** ...
                 * **Blok 2 (YY min):** ...
                 * *Tip dne:* ...
                 ### Úterý
                 * ... (atd. pro všechny dny) ...
                 ---
                 **Obecné tipy pro studium:**
                 * ...

                 \`\`\`json
                 [
                   { "day_of_week": 1, "title": "Blok 1: Opakování pravidel rovnic", "description": "Přečti si poznámky/video. Vyřeš 5 jednoduchých rovnic typu 2x + 3 = 9.", "time_slot": "30 min" },
                   { "day_of_week": 1, "title": "Blok 2: Rovnice se závorkami", "description": "Vyřeš 5 příkladů typu 3(x - 2) = 12.", "time_slot": "25 min" },
                   { "day_of_week": 1, "title": "Blok 3: Rychlé opakování zlomků", "description": "Porovnávání zlomků (3 příklady).", "time_slot": "10 min" },
                   { "day_of_week": 2, "title": "Blok 1: Výpočet procentové části", "description": "Prostuduj metodu a vyřeš 6 slovních úloh.", "time_slot": "30 min" },
                   { "day_of_week": 2, "title": "Blok 2: Čtení z diagramu", "description": "Odpověz na 5 otázek k danému sloupcovému diagramu.", "time_slot": "20 min" }
                   // ... (další aktivity pro všechny dny) ...
                 ]
                 \`\`\`
                 `;
                const requestData = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.6, topK: 40, topP: 0.95, maxOutputTokens: 8192 /* Increased tokens slightly */ } };
                 const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData) });
                 const data = await response.json(); if (!response.ok) { console.error("Chyba Gemini API:", data); throw new Error(data.error?.message || `Chyba při komunikaci s Gemini API (${response.status})`); }
                 const geminiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text; if (!geminiResponse) { throw new Error('Prázdná odpověď od Gemini API'); }
                 console.log("Vygenerovaný plán od Gemini (včetně JSON):\n", geminiResponse); return geminiResponse;
             } catch (error) { console.error('Chyba při generování obsahu plánu:', error); return `## Chyba při generování plánu\n\nBohužel se nepodařilo vygenerovat váš personalizovaný studijní plán.\n\n**Důvod:** ${error.message}\n\nZkuste to prosím později, nebo kontaktujte podporu. Ujistěte se, že máte platný Gemini API klíč.`; }
        }

         // **UPDATED**: Displays confirmation, not the full plan
         function displayPlanGenerationConfirmation() {
              planContent.innerHTML = `
                  <h3><i class="fas fa-check-circle" style="color: var(--success);"></i> Plán vygenerován!</h3>
                  <p>Váš detailní týdenní studijní plán byl úspěšně vygenerován.</p>
                  <p><strong>Uložte plán</strong>, aby se stal aktivním a jeho aktivity se zobrazily v harmonogramu. Můžete jej také exportovat nebo zkusit vygenerovat znovu.</p>
              `;
              planContent.style.display = 'block';
              hideLoader(planLoading);
         }

         // **UPDATED**: Saves markdown AND inserts activities from JSON
         async function saveGeneratedPlan(markdownContent, activitiesArray, topicsData) {
             if (!currentUser || !latestDiagnosticData || !markdownContent || !supabaseClient) { alert('Chyba: Chybí data uživatele, diagnostiky, plánu nebo Supabase client pro uložení.'); return; }
             const saveButton = document.getElementById('saveGeneratedPlanBtn'); if(saveButton) saveButton.disabled = true; saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ukládám...';
             const priorityTopics = {}; topicsData.forEach((topic, index) => { priorityTopics[topic.name] = { priority: index + 1, performance: topic.percentage, focus_level: topic.percentage < 50 ? 'high' : topic.percentage < 75 ? 'medium' : 'low' }; });

             let savedPlanId = null; // Store the new plan ID

             try {
                 // 1. Deactivate old plans
                 const { error: deactivateError } = await supabaseClient.from('study_plans').update({ status: 'inactive', updated_at: new Date().toISOString() }).eq('user_id', currentUser.id).eq('status', 'active'); if (deactivateError) throw deactivateError;

                 // 2. Insert new plan
                 const today = new Date(); const completionDate = new Date(today); completionDate.setDate(completionDate.getDate() + 7);
                 const newPlanData = { user_id: currentUser.id, title: `Studijní plán (${formatDate(today)})`, subject: "Matematika", status: "active", diagnostic_id: latestDiagnosticData.id,
                     plan_content_markdown: markdownContent, // Store the markdown part
                     priority_topics: priorityTopics, estimated_completion_date: completionDate.toISOString().split('T')[0], progress: 0, is_auto_adjusted: true };
                 const { data: savedPlan, error: insertPlanError } = await supabaseClient.from('study_plans').insert(newPlanData).select('id').single(); if (insertPlanError) throw insertPlanError;

                 savedPlanId = savedPlan.id; // Get the ID of the newly inserted plan
                 console.log("Nový plán uložen, ID:", savedPlanId);

                 // 3. Insert activities if JSON was extracted successfully
                 if (activitiesArray && Array.isArray(activitiesArray) && activitiesArray.length > 0) {
                     console.log(`Pokouším se vložit ${activitiesArray.length} aktivit...`);
                     const activitiesToInsert = activitiesArray.map(act => ({
                         plan_id: savedPlanId,
                         day_of_week: act.day_of_week,
                         time_slot: act.time_slot || null,
                         title: act.title,
                         description: act.description || null,
                         completed: false, // Default to not completed
                     }));

                     console.log("Aktivity k vložení:", activitiesToInsert); // Добавлено для отладки

                     const { error: insertActivitiesError } = await supabaseClient
                         .from('plan_activities')
                         .insert(activitiesToInsert);

                     if (insertActivitiesError) {
                         console.error("Chyba při vkládání aktivit:", insertActivitiesError);
                         showToast('Plán uložen, ale nepodařilo se uložit aktivity pro harmonogram.', 'warning');
                     } else {
                         console.log("Aktivity úspěšně vloženy do DB.");
                         showToast('Studijní plán a aktivity byly úspěšně uloženy!', 'success');
                     }
                 } else {
                     showToast('Studijní plán uložen (bez detailních aktivit v harmonogramu).', 'info');
                 }

                 currentStudyPlan = { ...newPlanData, id: savedPlanId }; // Update global variable
                 switchTab('current'); // Switch to show the newly saved plan overview

             } catch (error) {
                 console.error("Chyba při ukládání plánu nebo aktivit:", error);
                 showToast(`Nepodařilo se uložit plán. Chyba: ${error.message || 'Neznámá chyba'}`, 'error');
                 if(saveButton) saveButton.disabled = false; saveButton.innerHTML = '<i class="fas fa-save"></i> Uložit tento plán';
             }
         }

        // Display saved plan's markdown content
        function displayPlanContent(markdownContent) {
             if (!planContent) return;
             try {
                const htmlContent = marked.parse(markdownContent || ''); // Render markdown
                planContent.innerHTML = htmlContent;
                planContent.style.display = 'block';
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                     setTimeout(() => { window.MathJax.typesetPromise([planContent]).catch(e => console.error("MathJax chyba:", e)); }, 0);
                 }
             } catch (e) {
                 console.error("Chyba při renderování Markdown:", e);
                 planContent.innerHTML = "<p>Chyba při zobrazování obsahu plánu.</p>";
                 planContent.style.display = 'block';
             }
         }

        // ==============================================
        //          Pomocné UI Funkce (Progress Circle, Tooltips, Export PDF)
        // ==============================================
        function initProgressCircle(canvasId, progressValue) { const canvas = document.getElementById(canvasId); if (!canvas) return; const ctx = canvas.getContext('2d'); const centerX = canvas.width / 2; const centerY = canvas.height / 2; const radius = 65; const lineWidth = 10; ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.beginPath(); ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI); ctx.lineWidth = lineWidth; ctx.strokeStyle = '#dee2e6'; ctx.stroke(); const angle = (progressValue / 100) * 2 * Math.PI; if (angle > 0) { ctx.beginPath(); ctx.arc(centerX, centerY, radius, -Math.PI / 2, -Math.PI / 2 + angle); ctx.lineWidth = lineWidth; const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0); gradient.addColorStop(0, '#4361ee'); gradient.addColorStop(1, '#3a0ca3'); ctx.strokeStyle = gradient; ctx.lineCap = 'round'; ctx.stroke(); } progressCircleInstance = { canvas, ctx, centerX, centerY, radius, lineWidth }; }
        function updateProgressCircle(canvasId, progressValue) { if (!progressCircleInstance) { initProgressCircle(canvasId, progressValue); return; } const { ctx, centerX, centerY, radius, lineWidth } = progressCircleInstance; ctx.clearRect(0, 0, progressCircleInstance.canvas.width, progressCircleInstance.canvas.height); ctx.beginPath(); ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI); ctx.lineWidth = lineWidth; ctx.strokeStyle = '#dee2e6'; ctx.stroke(); const angle = (progressValue / 100) * 2 * Math.PI; if (angle > 0) { ctx.beginPath(); ctx.arc(centerX, centerY, radius, -Math.PI / 2, -Math.PI / 2 + angle); ctx.lineWidth = lineWidth; const gradient = ctx.createLinearGradient(0, 0, progressCircleInstance.canvas.width, 0); gradient.addColorStop(0, '#4361ee'); gradient.addColorStop(1, '#3a0ca3'); ctx.strokeStyle = gradient; ctx.lineCap = 'round'; ctx.stroke(); } }

        // ИСПРАВЛЕННАЯ ФУНКЦИЯ ЭКСПОРТА
        function exportPlanToPDFWithStyle(plan) {
             if (!plan) return;
             const exportContainer = document.createElement('div');
             exportContainer.style.padding = '20px';
             exportContainer.style.fontFamily = 'Arial, sans-serif';
             exportContainer.innerHTML = `<div style="text-align: center; margin-bottom: 30px;"><h1 style="color: #4361ee; font-size: 24px; margin-bottom: 10px;">${sanitizeHTML(plan.title || 'Studijní plán')}</h1><p style="color: #6c757d; font-size: 14px;">Vytvořeno: ${formatDate(plan.created_at)}</p></div>`;

             // --- НАЧАЛО ИСПРАВЛЕНИЯ ---
             if (currentUser && userName.textContent) {
                 exportContainer.innerHTML += `
                     <div style="margin-bottom: 20px; background-color: #f8f9fa; padding: 15px; border-radius: 10px;">
                         <h2 style="color: #4361ee; font-size: 18px; margin-bottom: 10px;">Informace o studentovi</h2>
                         <p><strong>Student:</strong> ${userName.textContent}</p>
                         <p><strong>Datum vytvoření:</strong> ${formatDate(plan.created_at)}</p>
                         ${plan.estimated_completion_date ? `<p><strong>Předpokládané dokončení:</strong> ${formatDate(plan.estimated_completion_date)}</p>` : ''}
                     </div>`;
             }
             // --- КОНЕЦ ИСПРАВЛЕНИЯ ---

             const contentElement = document.createElement('div');
             contentElement.innerHTML = plan.plan_content_markdown ? marked.parse(plan.plan_content_markdown) : '<p>Obsah plánu není k dispozici.</p>';
             contentElement.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(heading => { heading.style.color = '#4361ee'; heading.style.marginTop = '20px'; heading.style.marginBottom = '10px'; });
             contentElement.querySelectorAll('ul, ol').forEach(list => { list.style.marginLeft = '20px'; list.style.marginBottom = '15px'; });
             contentElement.querySelectorAll('p').forEach(paragraph => { paragraph.style.lineHeight = '1.6'; paragraph.style.marginBottom = '10px'; });
             exportContainer.appendChild(contentElement);

             exportContainer.innerHTML += `<div style="margin-top: 30px; border-top: 1px solid #dee2e6; padding-top: 15px; text-align: center;"><p style="font-size: 12px; color: #6c757d;">&copy; ${new Date().getFullYear()} Justax - Personalizované studijní plány<br>www.justax.cz</p></div>`;

             const options = { margin: 15, filename: `studijni-plan-${formatDate(plan.created_at).replace(/\./g, '-')}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };

             html2pdf().set(options).from(exportContainer).save().then(() => { showToast('PDF bylo úspěšně vygenerováno!', 'success'); }).catch(err => { console.error("Chyba exportu PDF:", err); showToast('Nepodařilo se exportovat PDF.', 'error'); });
         }


        // ==============================================
        //          Spuštění Aplikace
        // ==============================================
        // Используется $(document).ready() вместо DOMContentLoaded
        $(document).ready(function() {
            console.log("jQuery DOM ready, starting application initialization...");
            initializeApp();
            // Можно попробовать вызвать initTooltips еще раз здесь, но он должен вызываться из initializeApp и renderCurrentPlan
            // initTooltips();
        });

    </script>
</body>
</html>