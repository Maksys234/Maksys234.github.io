<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Testování znalostí</title>
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* CSS styles preserved from original version */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        :root { 
            --primary: #4361ee; 
            --primary-light: #4895ef; 
            --secondary: #3f37c9; 
            --success: #06d6a0; 
            --danger: #f72585; 
            --warning: #f8961e; 
            --info: #4895ef; 
            --dark: #1e2a3a; 
            --light: #f8f9fa;
            --white: #ffffff;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --text-primary: #1e2a3a;
            --text-secondary: #6c757d;
            --text-muted: #adb5bd;
            --card-radius: 12px;
            --button-radius: 12px;
            --input-radius: 8px;
            --transition-speed: 0.3s;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --sidebar-width: 260px;
            --gradient-1: linear-gradient(135deg, var(--primary), var(--secondary));
            --gradient-2: linear-gradient(135deg, var(--primary-light), var(--primary));
        }
        
        body { background-color: #f6f8ff; color: var(--text-primary); min-height: 100vh; display: flex; overflow-x: hidden; margin: 0; padding: 0; }
        
        /* Test selector styling */
        #test-selector { display: block; }
        .test-types-container { display: flex; gap: 1.5rem; flex-wrap: wrap; margin-top: 1.5rem; justify-content: center; }
        .test-type-card { background-color: var(--white); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); padding: 1.5rem; flex: 1; min-width: 280px; max-width: 320px; transition: all 0.3s ease; border: 1px solid var(--gray-light); display: flex; flex-direction: column; cursor: pointer; }
        .test-type-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--primary-light); }
        .test-type-card.selected { border-color: var(--primary); background-color: rgba(67, 97, 238, 0.05); }
        .test-type-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; position: relative; }
        .test-type-header i { font-size: 2rem; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(67, 97, 238, 0.1); color: var(--primary); }
        .test-type-card:nth-child(2) .test-type-header i { background: rgba(76, 201, 240, 0.1); color: var(--primary-light); }
        .test-type-card:nth-child(3) .test-type-header i { background: rgba(247, 37, 133, 0.1); color: var(--danger); }
        .test-type-header h3 { font-size: 1.4rem; font-weight: 600; margin: 0; }
        .recommended-badge { position: absolute; top: -25px; right: -15px; background: var(--gradient-2); color: white; font-size: 0.75rem; padding: 0.25rem 0.7rem; border-radius: 20px; font-weight: 500; box-shadow: 0 3px 5px rgba(67, 97, 238, 0.3); }
        .test-type-description { color: var(--text-secondary); margin-bottom: 1.5rem; min-height: 60px; flex-grow: 1; }
        .test-type-features { margin-bottom: 1.5rem; flex-grow: 1; }
        .feature { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem; }
        .feature i { color: var(--success); font-size: 0.9rem; }
        .select-test-btn { width: 100%; display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: auto; }
        
        /* Responsive adjustments */
        @media (max-width: 992px) { .test-types-container { flex-direction: column; align-items: center; } .test-type-card { width: 100%; max-width: 400px; } }
        
        /* Sidebar styling */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 1000; transition: transform var(--transition-speed) ease, width var(--transition-speed) ease; }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; }
        .sidebar-logo { font-size: 1.5rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo i { font-size: 1.75rem; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .sidebar-item { margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; color: rgba(255, 255, 255, 0.85); text-decoration: none; border-radius: 12px; transition: all 0.2s ease; font-weight: 500; }
        .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; width: 24px; text-align: center; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--white); }
        .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); text-align: center; }
        
        /* User profile */
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.1); border-radius: 12px; backdrop-filter: blur(5px); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-weight: 600; color: white; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; }
        .user-name { font-weight: 600; font-size: 0.95rem; }
        .user-role { font-size: 0.8rem; opacity: 0.8; }
        
        /* Main content area */
        main { flex: 1; margin-left: var(--sidebar-width); padding: 1.5rem 2rem; transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); }
        
        /* Dashboard header */
        .dashboard-header { margin-bottom: 2rem; background-color: var(--white); border-radius: var(--card-radius); padding: 1.25rem 1.5rem; box-shadow: var(--shadow-sm); position: relative; }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .header-content h1 { font-size: 1.75rem; font-weight: 600; color: var(--dark); margin-bottom: 0.5rem; }
        .header-meta { display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap; }
        .header-meta-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-secondary); }
        
        /* Main content sections */
        .main-content { display: flex; flex-direction: column; gap: 1.75rem; }
        .section { background-color: var(--white); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); padding: 1.5rem; animation: fadeIn 0.5s ease forwards; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .section:hover { box-shadow: var(--shadow-md); }
        .section-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1.25rem; color: var(--dark); display: flex; align-items: center; gap: 0.75rem; }
        .section-subtitle { font-size: 1.1rem; font-weight: 500; margin-bottom: 1rem; color: var(--dark); }
        
        /* Test container styling */
        .test-container { display: flex; flex-direction: column; gap: 2rem; }
        .test-info { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; padding-bottom: 1rem; border-bottom: 1px solid var(--gray-light); gap: 1rem; }
        .test-title { font-size: 1.25rem; font-weight: 600; color: var(--primary); }
        .test-meta { display: flex; gap: 1.5rem; flex-wrap: wrap; }
        .meta-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-secondary); }
        
        /* Progress bar */
        .test-progress-container { position: relative; width: 100%; height: 8px; background-color: var(--gray-light); border-radius: 4px; margin: 1rem 0; overflow: hidden; }
        .test-progress-bar { position: absolute; top: 0; left: 0; height: 100%; background: var(--gradient-2); border-radius: 4px; transition: width 0.3s ease; }
        
        /* Question styling */
        .question-container { padding: 1.5rem; border-radius: var(--card-radius); border: 1px solid var(--gray-light); margin-bottom: 1.5rem; transition: transform 0.3s ease, box-shadow 0.3s ease; background-color: var(--white); }
        .question-header { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem; }
        .question-number { display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; width: 36px; height: 36px; line-height: 36px; text-align: center; background: var(--gradient-1); color: white; border-radius: 50%; font-weight: 600; }
        .question-text { font-size: 1.15rem; font-weight: 500; line-height: 1.6; flex-grow: 1; }
        .question-text p { margin-bottom: 0.75rem; }
        .question-image-container { margin: 1rem 0; text-align: center; }
        .question-image { max-width: 100%; height: auto; border-radius: 8px; box-shadow: var(--shadow-sm); }
        
        /* Answer options */
        .answer-options { display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem; }
        .answer-option { display: flex; align-items: flex-start; padding: 1rem; border-radius: 8px; border: 1px solid var(--gray-light); cursor: pointer; transition: all 0.2s ease; position: relative; }
        .answer-option:hover { background-color: rgba(67, 97, 238, 0.05); border-color: var(--primary-light); transform: translateY(-2px); }
        .answer-option.selected { background-color: rgba(67, 97, 238, 0.1); border-color: var(--primary); box-shadow: 0 4px 10px rgba(67, 97, 238, 0.15); }
        .answer-option::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 4px; background: transparent; transition: background 0.3s ease; }
        .answer-option.selected::before { background: var(--primary); }
        .answer-option input[type="radio"] { margin-right: 1rem; margin-top: 0.15em; flex-shrink: 0; transform: scale(1.2); cursor: pointer; }
        .answer-text { flex: 1; line-height: 1.5; }
        .answer-letter { font-weight: 600; margin-right: 0.5em; color: var(--primary); }
        
        /* Text input answer */
        .answer-input-container { margin-top: 1.5rem; }
        .answer-input-container label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        .answer-input { width: 100%; padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--gray-light); font-size: 1rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .answer-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15); }
        
        /* Construction answer */
        .construction-container { margin-top: 1.5rem; }
        .solution-explanation { background-color: #f9f9ff; padding: 1rem 1.5rem; border-radius: 8px; border: 1px solid var(--gray-light); margin-bottom: 1.5rem; color: var(--text-secondary); }
        .solution-explanation h4 { margin-top: 0; margin-bottom: 0.75rem; font-weight: 600; color: var(--dark); }
        .construction-textarea { width: 100%; min-height: 100px; padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--gray-light); font-size: 1rem; resize: vertical; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .construction-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15); }
        
        /* Navigation */
        .question-navigation { display: flex; justify-content: space-between; margin-top: 2rem; gap: 1rem; }
        .pagination { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; margin: 1.5rem 0; padding: 0.5rem; background-color: #fff; border-radius: 12px; box-shadow: var(--shadow-sm); }
        .page-item { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: var(--light); color: var(--text-secondary); cursor: pointer; font-weight: 500; transition: all 0.2s ease; border: 1px solid transparent; }
        .page-item:hover { background-color: var(--gray-light); color: var(--dark); transform: scale(1.1); }
        .page-item.active { background: var(--gradient-1); color: white; box-shadow: 0 4px 8px rgba(67, 97, 238, 0.2); border-color: transparent; }
        .page-item.answered { background-color: rgba(6, 214, 160, 0.7); color: white; border-color: transparent; }
        .page-item.answered.active { background: var(--gradient-1); box-shadow: 0 0 0 2px var(--success); }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 500; font-size: 0.95rem; text-decoration: none; transition: all 0.3s ease; border: none; cursor: pointer; position: relative; overflow: hidden; }
        .btn::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 0; background-color: rgba(255, 255, 255, 0.1); transition: height 0.3s ease; z-index: -1; }
        .btn:hover::after { height: 100%; }
        .btn-primary { background: var(--gradient-1); color: white; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.2); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(67, 97, 238, 0.25); }
        .btn-secondary { background-color: var(--light); color: var(--text-secondary); border: 1px solid var(--gray-light); }
        .btn-secondary:hover { background-color: var(--gray-light); color: var(--dark); }
        .btn-success { background: linear-gradient(135deg, var(--success), #04a77e); color: white; box-shadow: 0 4px 10px rgba(6, 214, 160, 0.2); }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(6, 214, 160, 0.25); }
        .btn-info { background: linear-gradient(135deg, var(--info), #3b7cde); color: white; box-shadow: 0 4px 10px rgba(72, 149, 239, 0.2); }
        .btn-info:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(72, 149, 239, 0.25); }
        .btn-lg { padding: 0.75rem 2rem; font-size: 1rem; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn-block { width: 100%; justify-content: center; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn:disabled::after { height: 0; }
        
        /* Timer */
        .test-timer { position: absolute; top: 1.25rem; right: 1.5rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; font-weight: 600; color: var(--primary); background-color: rgba(67, 97, 238, 0.1); padding: 0.5rem 1rem; border-radius: 20px; }
        .timer-warning { color: var(--warning) !important; background-color: rgba(248, 150, 30, 0.1) !important; }
        .timer-danger { color: var(--danger) !important; background-color: rgba(247, 37, 133, 0.1) !important; animation: pulse 1s ease-in-out infinite; }
        
        /* Loader */
        .test-loader { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem 1rem; text-align: center; }
        .loader-spinner { width: 50px; height: 50px; border: 4px solid rgba(67, 97, 238, 0.1); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; margin-bottom: 1.5rem; }
        .loader-text { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .loader-subtext { font-size: 0.9rem; color: var(--text-muted); }
        
        /* Results */
        .results-container { margin-top: 1.5rem; }
        .result-summary { display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center; background-color: #f9f9ff; border-radius: var(--card-radius); padding: 1.5rem 2rem; margin-bottom: 2rem; position: relative; overflow: hidden; }
        .result-summary::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at top right, rgba(67, 97, 238, 0.05), transparent 70%); z-index: 0; }
        .result-score { text-align: center; position: relative; z-index: 1; flex-basis: 150px; }
        .score-value { font-size: 3.5rem; font-weight: 700; background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1; }
        .score-label { font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .result-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1.5rem; position: relative; z-index: 1; flex-grow: 1; max-width: 600px; }
        .stat-item { text-align: center; padding: 1rem; border-radius: 12px; background-color: rgba(255, 255, 255, 0.5); backdrop-filter: blur(5px); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .stat-item:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .stat-value { font-size: 1.75rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary); }
        .stat-label { font-size: 0.85rem; color: var(--text-secondary); }
        .low-score-message { background-color: rgba(248, 150, 30, 0.1); border-left: 4px solid var(--warning); padding: 1.5rem; margin-top: 1.5rem; margin-bottom: 1rem; border-radius: var(--card-radius); }
        .low-score-message i { font-size: 1.5rem; color: var(--warning); margin-bottom: 0.75rem; display: block; }
        .low-score-message strong { color: var(--warning); }
        .low-score-message.info { background-color: rgba(67, 97, 238, 0.1); border-left-color: var(--primary-light); }
        .low-score-message.info i { color: var(--primary-light); }
        .low-score-message.info strong { color: var(--primary-light); }
        .result-actions { display: flex; justify-content: center; flex-wrap: wrap; gap: 1.5rem; margin-top: 2.5rem; }
        
        /* Topic results */
        .topic-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
        .topic-card { background-color: var(--white); border-radius: var(--card-radius); padding: 1.5rem; box-shadow: var(--shadow-sm); transition: all 0.3s ease; border-left: 4px solid var(--primary); display: flex; flex-direction: column; }
        .topic-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-md); }
        .topic-card.strength { border-left-color: var(--success); }
        .topic-card.weakness { border-left-color: var(--danger); }
        .topic-card.neutral { border-left-color: var(--warning); }
        .topic-header { display: flex; align-items: center; margin-bottom: 1.25rem; gap: 0.75rem; }
        .topic-icon { width: 48px; height: 48px; flex-shrink: 0; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--white); background: var(--gradient-1); font-size: 1.5rem; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.15); }
        .topic-card.strength .topic-icon { background: linear-gradient(135deg, var(--success), #04a77e); box-shadow: 0 4px 10px rgba(6, 214, 160, 0.15); }
        .topic-card.weakness .topic-icon { background: linear-gradient(135deg, #f72585, #b5179e); box-shadow: 0 4px 10px rgba(247, 37, 133, 0.15); }
        .topic-card.neutral .topic-icon { background: linear-gradient(135deg, #f8961e, #f3722c); box-shadow: 0 4px 10px rgba(248, 150, 30, 0.15); }
        .topic-title { font-weight: 600; font-size: 1.2rem; color: var(--dark); flex-grow: 1; }
        .topic-stats { margin-top: auto; padding-top: 1rem; }
        .topic-progress { display: flex; justify-content: space-between; margin-bottom: 0.75rem; font-size: 0.9rem; }
        .topic-progress-label { color: var(--text-secondary); }
        .topic-progress-value { font-weight: 600; color: var(--primary); }
        .topic-card.strength .topic-progress-value { color: var(--success); }
        .topic-card.weakness .topic-progress-value { color: var(--danger); }
        .topic-card.neutral .topic-progress-value { color: var(--warning); }
        .topic-progress-bar { width: 100%; height: 8px; background-color: var(--gray-light); border-radius: 4px; overflow: hidden; position: relative; }
        .topic-progress-fill { height: 100%; background: var(--gradient-1); border-radius: 4px; position: relative; overflow: hidden; transition: width 0.5s ease-out; }
        .topic-progress-fill::after { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent); animation: progressShine 2s infinite; }
        .topic-card.strength .topic-progress-fill { background: linear-gradient(135deg, var(--success), #04a77e); }
        .topic-card.weakness .topic-progress-fill { background: linear-gradient(135deg, #f72585, #b5179e); }
        .topic-card.neutral .topic-progress-fill { background: linear-gradient(135deg, #f8961e, #f3722c); }
        
        /* Error messages */
        .error-message-container { background-color: rgba(247, 37, 133, 0.1); border-left: 4px solid var(--danger); padding: 1.5rem; margin: 1rem 0; border-radius: var(--card-radius); text-align: center; }
        .error-message-container i { font-size: 2rem; color: var(--danger); margin-bottom: 1rem; display: block; }
        .error-message-container .loader-text { color: var(--danger); font-weight: 600; }
        .error-message-container .loader-subtext { color: var(--text-secondary); }
        
        /* Gemini checking overlay */
        .gemini-checking-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .gemini-spinner { width: 60px; height: 60px; border: 5px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: var(--white); animation: spin 1.2s linear infinite; margin-bottom: 1.5rem; }
        .gemini-checking-text { font-size: 1.2rem; font-weight: 500; color: white; }
        
        /* Review container */
        .review-container { margin-top: 1.5rem; }
        .review-navigation { margin-bottom: 1.5rem; display: flex; justify-content: flex-start; }
        .review-question-item { background-color: var(--white); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); padding: 1.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--primary); }
        .review-question-item.correct { border-left-color: var(--success); background-color: rgba(6, 214, 160, 0.03); }
        .review-question-item.incorrect { border-left-color: var(--danger); background-color: rgba(247, 37, 133, 0.03); }
        .review-question-item.partial { border-left-color: var(--warning); background-color: rgba(248, 150, 30, 0.03); }
        .review-question-item.skipped { border-left-color: var(--gray); background-color: rgba(108, 117, 125, 0.03); }
        .review-question-header { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem; }
        .review-question-number { display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; width: 36px; height: 36px; line-height: 36px; text-align: center; background: var(--gradient-1); color: white; border-radius: 50%; font-weight: 600; }
        .review-question-item.correct .review-question-number { background: var(--success); }
        .review-question-item.incorrect .review-question-number { background: var(--danger); }
        .review-question-item.partial .review-question-number { background: var(--warning); }
        .review-question-item.skipped .review-question-number { background: var(--gray); }
        .review-question-text { font-size: 1.1rem; font-weight: 500; line-height: 1.5; flex-grow: 1; }
        .review-answer-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--gray-light); }
        .review-answer-section h4 { font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--dark); }
        .review-user-answer, .review-correct-answer, .review-solution { margin-bottom: 1rem; padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--gray-light); line-height: 1.5; }
        .review-user-answer strong, .review-correct-answer strong, .review-solution strong { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .review-user-answer { background-color: rgba(72, 149, 239, 0.05); border-color: var(--info); }
        .review-user-answer strong { color: var(--info); }
        .review-correct-answer { background-color: rgba(6, 214, 160, 0.05); border-color: var(--success); }
        .review-correct-answer strong { color: var(--success); }
        .review-solution { background-color: #f9f9ff; }
        .review-solution strong { color: var(--text-secondary); }
        .review-solution pre { background-color: transparent; border: none; padding: 0; margin: 0; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; font-size: 0.9rem; }
        .review-solution code { background-color: transparent; padding: 0; }
        .review-score { font-weight: 600; margin-top: 1rem; text-align: right; font-size: 1.1rem; }
        .review-score .correct { color: var(--success); }
        .review-score .incorrect { color: var(--danger); }
        .review-score .partial { color: var(--warning); }
        .review-score .skipped { color: var(--gray); }
        .review-mc-option { display: block; padding: 0.5rem 0; margin-left: 1rem; position: relative; }
        .review-mc-option::before { content: attr(data-letter) ". "; font-weight: bold; position: absolute; left: -1rem; }
        .review-mc-option.user-selected { background-color: rgba(72, 149, 239, 0.1); border-radius: 4px; padding-left: 0.5rem; margin-left: 0.5rem; }
        .review-mc-option.correct-answer { color: var(--success); font-weight: bold; }
        .review-mc-option.user-selected.correct-answer { background-color: rgba(6, 214, 160, 0.1); }
        .review-mc-option.user-selected:not(.correct-answer) { color: var(--danger); background-color: rgba(247, 37, 133, 0.1); }
        
        /* Toast notifications */
        .toast { position: fixed; bottom: 20px; right: 20px; background-color: var(--white); color: var(--text-primary); border-radius: 8px; padding: 1rem; box-shadow: var(--shadow-lg); max-width: 300px; transform: translateY(100px); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; z-index: 1010; display: flex; align-items: center; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast i { margin-right: 0.75rem; font-size: 1.25rem; }
        .toast.success i { color: #10b981; }
        .toast.error i { color: var(--danger); }
        .toast.warning i { color: var(--warning); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes progressShine { 0% { left: -100%; } 50% { left: 150%; } 100% { left: 150%; } }
        .animated { animation: fadeIn 0.5s ease forwards; }
        
        /* Responsive layout */
        @media (max-width: 992px) { 
            :root { --sidebar-width: 80px; } 
            .sidebar { width: 80px; } 
            .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; } 
            .sidebar-link i { margin-right: 0; } 
            main { margin-left: 80px; width: calc(100% - 80px); }
        }
        
        @media (max-width: 768px) { 
            main { padding: 1rem; } 
            .header-content { flex-direction: column; align-items: flex-start; gap: 1rem; } 
            .test-timer { position: static; margin-top: 1rem; align-self: flex-start; } 
            .result-summary { padding: 1.25rem; flex-direction: column; gap: 1.5rem; }
        }
        
        @media (max-width: 576px) { 
            :root { --sidebar-width: 0; } 
            .sidebar { transform: translateX(-100%); z-index: 1000; width: 260px; } 
            .sidebar.active { transform: translateX(0); } 
            main { margin-left: 0; width: 100%; } 
            .mobile-menu-toggle { display: block; }
        }
        
        .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; color: var(--dark); font-size: 1.5rem; margin-right: 1rem; padding: 0.5rem; z-index: 1001; }
        .dashboard-header > .header-content > div:first-child { display: flex; align-items: center; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(2px); }
        .sidebar-overlay.active { display: block; opacity: 1; }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) { 
            :root { 
                --white: #1a202c; 
                --light: #2d3748; 
                --dark: #e2e8f0; 
                --gray-light: #4a5568; 
                --text-primary: #e2e8f0; 
                --text-secondary: #cbd5e0; 
                --text-muted: #a0aec0; 
                --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
                --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.3);
                --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.4);
            }
        }
    </style>
</head>
<body>
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <div id="toast-message">Operace úspěšná.</div>
    </div>
    
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
    
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="sidebar-logo">
                <i class="fas fa-calculator"></i>
                <span>Justax</span>
            </a>
        </div>
        
        <ul class="sidebar-menu">
            <li class="sidebar-item">
                <a href="/dashboard/dashboard.html" class="sidebar-link">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="/dashboard/procvicovani/test1.html" class="sidebar-link active">
                    <i class="fas fa-diagnoses"></i>
                    <span>Diagnostika</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="/dashboard/plan/plan.html" class="sidebar-link">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Studijní plán</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="/dashboard/progress/progress.html" class="sidebar-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Můj pokrok</span>
                </a>
            </li>
        </ul>
        
        <div class="user-profile">
            <div class="user-avatar" id="user-avatar">?</div>
            <div class="user-info">
                <div class="user-name" id="user-name">Načítání...</div>
                <div class="user-role" id="user-role">Student</div>
            </div>
        </div>
        
        <div class="sidebar-footer">&copy; 2025 Justax</div>
    </aside>

    <main>
        <div class="dashboard-header">
            <div class="header-content">
                <div>
                    <button id="mobile-menu-toggle" class="mobile-menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Testování znalostí</h1>
                </div>
                <div class="header-meta">
                    <div class="header-meta-item" id="test-level">
                        <i class="fas fa-layer-group"></i>
                        <span>Výběr testu</span>
                    </div>
                </div>
            </div>
            <div id="test-timer" class="test-timer" style="display: none;">
                <i class="fas fa-clock"></i>
                <span id="timer-value">00:00</span>
            </div>
        </div>

        <div class="main-content">
            <div id="test-selector" class="section">
                <h2 class="section-title">
                    <i class="fas fa-tasks"></i>
                    Vyberte typ diagnostického testu
                </h2>
                <div class="test-types-container">
                    <div class="test-type-card" data-test-type="quick">
                        <div class="test-type-header">
                            <i class="fas fa-bolt"></i>
                            <h3>Rychlý test</h3>
                        </div>
                        <div class="test-type-description">
                            Rychlá diagnostika vašich znalostí v 10 otázkách.
                        </div>
                        <div class="test-type-features">
                            <div class="feature">
                                <i class="fas fa-check"></i>
                                <span>10 otázek</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-check"></i>
                                <span>Trvání 10-15 minut</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-check"></i>
                                <span>Základní diagnostika</span>
                            </div>
                        </div>
                        <button class="btn btn-primary select-test-btn" data-test-type="quick">
                            <i class="fas fa-play-circle"></i>
                            Zahájit test
                        </button>
                    </div>

                    <div class="test-type-card" data-test-type="full">
                        <div class="test-type-header">
                            <i class="fas fa-clipboard-check"></i>
                            <h3>Kompletní test</h3>
                            <span class="recommended-badge">Doporučeno</span>
                        </div>
                        <div class="test-type-description">
                            Podrobná diagnostika vašich znalostí ve 20 otázkách.
                        </div>
                        <div class="test-type-features">
                            <div class="feature">
                                <i class="fas fa-check"></i>
                                <span>20 otázek</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-check"></i>
                                <span>Trvání 20-30 minut</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-check"></i>
                                <span>Přesná diagnostika</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-check"></i>
                                <span>Podrobná analýza</span>
                            </div>
                        </div>
                        <button class="btn btn-primary select-test-btn" data-test-type="full">
                            <i class="fas fa-play-circle"></i>
                            Zahájit test
                        </button>
                    </div>

                    <div class="test-type-card" data-test-type="absolute">
                        <div class="test-type-header">
                            <i class="fas fa-award"></i>
                            <h3>Absolutní test</h3>
                        </div>
                        <div class="test-type-description">
                            Kompletní diagnostika vašich znalostí ve 30 otázkách.
                        </div>
                        <div class="test-type-features">
                            <div class="feature">
                                <i class="fas fa-check"></i>
                                <span>30 otázek</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-check"></i>
                                <span>Trvání 30-45 minut</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-check"></i>
                                <span>Maximální přesnost</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-check"></i>
                                <span>Detailní analýza</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-check"></i>
                                <span>Vyšší bodové ohodnocení</span>
                            </div>
                        </div>
                        <button class="btn btn-primary select-test-btn" data-test-type="absolute">
                            <i class="fas fa-play-circle"></i>
                            Zahájit test
                        </button>
                    </div>
                </div>
            </div>

            <div id="test-loader" class="section" style="display: none;">
                <div class="test-loader">
                    <div class="loader-spinner"></div>
                    <div class="loader-text">Načítání...</div>
                    <div class="loader-subtext" id="loader-subtext">Připravujeme test</div>
                </div>
            </div>

            <div id="test-container" class="section" style="display: none;">
                <div class="test-container">
                    <div class="test-info">
                        <div class="test-title" id="current-test-title">Diagnostický test</div>
                        <div class="test-meta">
                            <div class="meta-item">
                                <i class="fas fa-question-circle"></i>
                                <span>Otázka <span id="question-count">0</span> z <span id="total-questions">0</span></span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Zodpovězeno: <span id="answered-count">0</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="test-progress-container">
                        <div id="progress-bar" class="test-progress-bar" style="width: 0%;"></div>
                    </div>

                    <div id="question-container"></div>

                    <div id="pagination" class="pagination"></div>

                    <div class="question-navigation">
                        <button id="prev-btn" class="btn btn-secondary">
                            <i class="fas fa-chevron-left"></i>
                            Předchozí
                        </button>
                        <button id="next-btn" class="btn btn-primary">
                            Další
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <button id="finish-btn" class="btn btn-success" style="display: none;">
                            <i class="fas fa-check"></i>
                            Ukončit test
                        </button>
                    </div>
                </div>
            </div>

            <div id="results-container" class="section" style="display: none;">
                <h2 class="section-title"><i class="fas fa-award"></i> Výsledky testu</h2>
                <div class="results-container">
                    <div class="result-summary">
                        <div class="result-score">
                            <div class="score-value" id="result-score">0</div>
                            <div class="score-label">z 50 bodů</div>
                            <div class="score-label">(<span id="result-percentage">0</span>%)</div>
                        </div>
                        <div class="result-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="result-correct">0</div>
                                <div class="stat-label">Správně</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="result-incorrect">0</div>
                                <div class="stat-label">Špatně</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="result-time">00:00</div>
                                <div class="stat-label">Čas</div>
                            </div>
                        </div>
                    </div>

                    <div id="low-score-message-container"></div>

                    <h3 class="section-subtitle">Výsledky podle témat</h3>
                    <div id="topic-results" class="topic-results"></div>

                    <div class="result-actions">
                        <button id="review-answers-btn" class="btn btn-info btn-lg">
                            <i class="fas fa-search"></i>
                            Prohlédnout odpovědi
                        </button>
                        <button id="continue-btn" class="btn btn-success btn-lg">
                            <i class="fas fa-forward"></i>
                            Vytvořit studijní plán
                        </button>
                        <button id="retry-btn" class="btn btn-secondary btn-lg">
                            <i class="fas fa-redo"></i>
                            Zkusit znovu
                        </button>
                    </div>
                </div>
            </div>

            <div id="review-container" class="section review-container" style="display: none;">
                <div class="review-navigation">
                    <button id="back-to-results-btn" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i>
                        Zpět na výsledky
                    </button>
                </div>
                <h2 class="section-title"><i class="fas fa-search"></i> Prohlídka odpovědí</h2>
                <div id="review-content"></div>
            </div>

            <div id="gemini-checking-overlay" class="gemini-checking-overlay" style="display: none;">
                <div class="gemini-spinner"></div>
                <div class="gemini-checking-text">Vyhodnocuji odpovědi...</div>
            </div>
        </div>
    </main>

    <script>
        // ==============================================
        //          Inicializace Supabase & Gemini
        // ==============================================
        const supabaseUrl = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtTnAi1T_IHpKwgg_FPKHuhbJfa82Bm9jWRzCII';
        const supabaseOptions = {};
        let supabaseClient = null; // Inicializujeme později
        const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // API klíč pro Gemini
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

        // DOM Elementy
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const testSelector = document.getElementById('test-selector');
        const testLoader = document.getElementById('test-loader');
        const loaderSubtext = document.getElementById('loader-subtext');
        const testContainer = document.getElementById('test-container');
        const resultsContainer = document.getElementById('results-container');
        const reviewContainer = document.getElementById('review-container');
        const reviewContent = document.getElementById('review-content');
        const testSubject = document.getElementById('test-subject');
        const testLevel = document.getElementById('test-level');
        const testTimer = document.getElementById('test-timer');
        const timerValue = document.getElementById('timer-value');
        const currentTestTitle = document.getElementById('current-test-title');
        const questionCountEl = document.getElementById('question-count');
        const totalQuestionsEl = document.getElementById('total-questions');
        const answeredCountEl = document.getElementById('answered-count');
        const progressBar = document.getElementById('progress-bar');
        const questionContainer = document.getElementById('question-container');
        const pagination = document.getElementById('pagination');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const finishBtn = document.getElementById('finish-btn');
        const resultScoreEl = document.getElementById('result-score');
        const resultPercentageEl = document.getElementById('result-percentage');
        const resultCorrectEl = document.getElementById('result-correct');
        const resultIncorrectEl = document.getElementById('result-incorrect');
        const resultTimeEl = document.getElementById('result-time');
        const topicResultsEl = document.getElementById('topic-results');
        const retryBtn = document.getElementById('retry-btn');
        const reviewAnswersBtn = document.getElementById('review-answers-btn');
        const backToResultsBtn = document.getElementById('back-to-results-btn');
        const continueBtn = document.getElementById('continue-btn');
        const geminiOverlay = document.getElementById('gemini-checking-overlay');
        const lowScoreMessageContainer = document.getElementById('low-score-message-container');

        // Globální Proměnné
        let currentUser = null;
        let currentProfile = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = []; // Pole objektů: { question_id, userAnswerValue, topic_id, topic_name, scoreAwarded, maxScore, checked_by }
        let timer = null;
        let testTime = 0;
        let testStartTime = null;
        let testEndTime = null;
        let testResultsData = {
            totalQuestions: 0,
            correctAnswers: 0, // Počet otázek s >= 1 bodem
            incorrectAnswers: 0, // Počet otázek s 0 body
            unanswered: 0,
            score: 0, // Skóre 0-50
            totalPointsAchieved: 0, // Surový počet získaných bodů
            totalMaxPossiblePoints: 0, // Surový maximální počet bodů
            percentage: 0, // Úspěšnost % (correctAnswers / totalQuestions)
            timeSpent: 0,
            topicResults: {} // Objekt s výsledky podle témat
        };
        let diagnosticId = null; // UUID uložené diagnostiky
        let selectedTestType = null;

        // Konfigurace
        const testTypeConfig = {
            quick: { questionsCount: 10, title: 'Rychlý diagnostický test', description: 'Základní prověření', multiplier: 1.0 },
            full: { questionsCount: 20, title: 'Kompletní diagnostický test', description: 'Podrobné hodnocení', multiplier: 1.5 },
            absolute: { questionsCount: 30, title: 'Absolutní test znalostí', description: 'Důkladná prověrka', multiplier: 2.0 }
        };
        
        const topicIcons = {
            "Algebra": "fa-square-root-alt", 
            "Aritmetika": "fa-calculator",
            "Geometrie": "fa-draw-polygon", 
            "Logika": "fa-brain",
            "Logické úlohy": "fa-brain", 
            "Statistika": "fa-chart-bar",
            "Čísla a aritmetické operace": "fa-calculator", 
            "Práce s daty": "fa-chart-bar",
            "Problémové úlohy": "fa-lightbulb", 
            "Proporce a procenta": "fa-percentage",
            "default": "fa-book"
        };
        
        const SCORE_THRESHOLD_FOR_SAVING = 5; // Prahová hodnota pro uložení výsledků (v bodech /50)
        const NUMERIC_TOLERANCE = 0.01; // Tolerance pro porovnávání čísel

        // --- Pomocné Funkce ---
        
        /**
         * Promíchá prvky pole náhodně.
         * @param {Array} array Pole k promíchání
         * @returns {Array} Promíchané pole
         */
                function shuffleArray(array) {
            for (let ci = array.length - 1; ci > 0; ci--) {
                const ri = Math.floor(Math.random() * (ci + 1));
                [array[ci], array[ri]] = [array[ri], array[ci]];
            }
            return array;
        }

        /**
         * Formátuje čas v sekundách na MM:SS.
         * @param {number} seconds Počet sekund
         * @returns {string} Naformátovaný čas
         */
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.round(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        /**
         * Zobrazí chybovou zprávu.
         * @param {string} message Text chybové zprávy
         */
        function showErrorMessage(message) {
            if (testSelector) testSelector.style.display = 'none';
            if (testContainer) testContainer.style.display = 'none';
            if (resultsContainer) resultsContainer.style.display = 'none';
            if (testLoader) {
                testLoader.style.display = 'block';
                const loaderText = testLoader.querySelector('.loader-text');
                if (loaderText) loaderText.textContent = 'Chyba!';
                const loaderSubtext = testLoader.querySelector('.loader-subtext');
                if (loaderSubtext) loaderSubtext.textContent = message || 'Něco se pokazilo. Zkuste to prosím znovu.';
                const loaderSpinner = testLoader.querySelector('.loader-spinner');
                if (loaderSpinner) loaderSpinner.style.borderTopColor = 'var(--danger)';
            }
        }

        /**
         * Zobrazí/skryje overlay pro kontrolu odpovědí Gemini.
         * @param {boolean} show True pro zobrazení, false pro skrytí
         */
        function showGeminiOverlay(show) {
            if (geminiOverlay) geminiOverlay.style.display = show ? 'flex' : 'none';
        }

        /**
         * Převede index na písmeno abecedy (0 -> A, 1 -> B, atd).
         * @param {number} index Index k převodu
         * @returns {string} Odpovídající písmeno
         */
        function indexToLetter(index) {
            return String.fromCharCode(65 + index);
        }

        /**
         * Zajistí bezpečný HTML výstup.
         * @param {string} str Vstupní řetězec
         * @returns {string} Bezpečný HTML řetězec
         */
        function sanitizeHTML(str) {
            if (str === null || str === undefined) return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        /**
         * Získá iniciály z profilu uživatele.
         * @param {object} profileData Data profilu
         * @returns {string} Iniciály uživatele
         */
        function getInitials(profileData) {
            if (!profileData) return 'U';
            const first = profileData.first_name?.[0] || '';
            const last = profileData.last_name?.[0] || '';
            const usernameInitial = profileData.username?.[0]?.toUpperCase() || '';
            return first && last ? `${first}${last}` : (first || last || usernameInitial || 'U');
        }

        /**
         * Zobrazí toast notifikaci.
         * @param {string} message Text zprávy
         * @param {string} type Typ notifikace ('success', 'error', 'warning')
         * @param {number} duration Doba zobrazení v ms
         */
        function showToast(message, type = 'success', duration = 4000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            if (!toast || !toastMessage) return;
            
            // Odstranit předchozí třídy
            toast.classList.remove('success', 'error', 'warning');
            
            // Přidat novou třídu podle typu
            toast.classList.add(type);
            
            // Nastavit ikonu
            const icon = toast.querySelector('i');
            if (icon) {
                icon.className = type === 'success' ? 'fas fa-check-circle' :
                                type === 'error' ? 'fas fa-exclamation-circle' : 
                                'fas fa-exclamation-triangle';
            }
            
            // Nastavit text
            toastMessage.textContent = message;
            
            // Zobrazit toast
            toast.classList.add('show');
            
            // Automaticky skrýt po určeném čase
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // --- Porovnávací Funkce (pro Fallback) ---
        /**
         * Porovná dvě hodnoty jako čísla s tolerancí a normalizací.
         * @param {string|number|null} val1
         * @param {string|number|null} val2
         * @param {number} tolerance - Povolená absolutní odchylka.
         * @returns {boolean|null} True pro shodu, False pro neshodu, Null pro nemožnost porovnat.
         */
        function compareNumericAdvanced(val1, val2, tolerance = NUMERIC_TOLERANCE) {
            if (val1 === null || val1 === undefined || val2 === null || val2 === undefined) return null;

            const normalize = (v) => {
                if (typeof v === 'number') return v;
                if (typeof v !== 'string') return NaN;
                // Odstranění mezer, nahrazení čárky tečkou, odstranění měny/procent
                let str = String(v).trim().replace(',', '.').replace(/\s+/g, '').replace(/kč|czk|%/gi, '').trim();
                if (str === '') return NaN; // Prázdný řetězec po normalizaci

                // Zlomek: 3/2, -1/4
                if (str.includes('/') && !str.startsWith('.') && !str.endsWith('.')) {
                    const parts = str.split('/');
                    if (parts.length === 2) {
                        const num = parseFloat(parts[0]);
                        const den = parseFloat(parts[1]);
                        // Kontrola, že čitatel a jmenovatel jsou čísla, a jmenovatel není 0
                        if (!isNaN(num) && !isNaN(den) && den !== 0) return num / den;
                    }
                }

                // Smíšené číslo: 1 1/2, -2 3/4
                const mixedMatch = str.match(/^(-?\d+)\s+(\d+)\/(\d+)$/);
                if (mixedMatch) {
                    const whole = parseFloat(mixedMatch[1]);
                    const num = parseFloat(mixedMatch[2]);
                    const den = parseFloat(mixedMatch[3]);
                    if (!isNaN(whole) && !isNaN(num) && !isNaN(den) && den !== 0) {
                        // Respektování znaménka celé části
                        return whole + (num / den) * (whole < 0 ? -1 : 1);
                    }
                }

                // Běžné číslo (včetně desetinných)
                return parseFloat(str);
            };

            const num1 = normalize(val1);
            const num2 = normalize(val2);

            if (isNaN(num1) || isNaN(num2)) {
                // Pokud číselné porovnání selhalo, zkusíme textové
                if (typeof val1 === 'string' && typeof val2 === 'string') {
                    // Přísnější textová normalizace před porovnáním
                    const normText1 = String(val1).trim().toLowerCase().replace(/\s+/g, '');
                    const normText2 = String(val2).trim().toLowerCase().replace(/\s+/g, '');
                    if (normText1 === normText2) {
                        console.log("[compareNumeric] Fallback to text comparison: Match.");
                        return true;
                    }
                }
                console.log("[compareNumeric] Cannot compare numerically (NaN) or textually.");
                return null; // Nemožné porovnat
            }

            // Porovnání absolutního rozdílu s tolerancí
            const areEquivalent = Math.abs(num1 - num2) < tolerance;
            return areEquivalent;
        }

        /**
         * Porovná dvě textové hodnoty s normalizací (case, trim, Ano/Ne).
         * @param {string|number|null} val1
         * @param {string|number|null} val2
         * @returns {boolean}
         */
        function compareTextAdvanced(val1, val2) {
            if (val1 === null || val1 === undefined || val2 === null || val2 === undefined) return false;
            const normalize = (v) => {
                let str = String(v).trim().toLowerCase();
                // Normalizace Ano/Ne na "ano" nebo "ne"
                if (str.startsWith('ano')) return 'ano';
                if (str.startsWith('ne')) return 'ne';
                // Odstranění písmena a tečky/závorky na začátku (pro MC)
                str = str.replace(/^[a-z][\.\)\s]*=*\s*/, '');
                return str;
            };
            const norm1 = normalize(val1);
            const norm2 = normalize(val2);
            const areEquivalent = norm1 === norm2;
            return areEquivalent;
        }

        // --- Hlavní Logika (autentizace, načítání) ---
        
        /**
         * Získá aktuálního přihlášeného uživatele.
         * @returns {Promise<Object|null>} Data uživatele nebo null
         */
        async function getCurrentSupabaseUser() {
            try {
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                if (error) {
                    console.error("Chyba získání uživatele:", error);
                    throw error;
                }
                return user;
            } catch (e) {
                console.error("Chyba při získávání uživatele:", e);
                // V případě chyby použijeme placeholder ID pro testovací účely
                return { id: 'PLACEHOLDER_USER_ID', email: 'anonymous@example.com' };
            }
        }

        /**
         * Načte profil uživatele z databáze.
         * @param {string} userId ID uživatele
         * @returns {Promise<Object|null>} Data profilu nebo null
         */
        async function fetchUserProfile(userId) {
            if (!userId) return null;
            try {
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) throw error;
                return profile;
            } catch (error) {
                console.error("Chyba načtení profilu:", error);
                return null;
            }
        }

        /**
         * Aktualizuje UI s informacemi o uživateli.
         * @param {Object} profileData Data profilu
         * @param {string} userEmail E-mail uživatele
         */
        function updateUserInfoUI(profileData, userEmail) {
            const displayName = `${profileData?.first_name || ''} ${profileData?.last_name || ''}`.trim() || 
                                profileData?.username || 
                                userEmail.split('@')[0];
            
            if (userName) userName.textContent = displayName;
            
            if (userAvatar) {
                if (profileData?.avatar_url) {
                    userAvatar.innerHTML = `<img src="${profileData.avatar_url}" alt="${displayName}" />`;
                } else {
                    const initials = getInitials(profileData);
                    userAvatar.textContent = initials;
                }
            }
        }

        /**
         * Zkontroluje, zda uživatel již absolvoval diagnostický test.
         * @param {string} userId ID uživatele
         * @returns {Promise<boolean>} True pokud test již existuje
         */
        async function checkExistingDiagnostic(userId) {
            if (!userId || userId === 'PLACEHOLDER_USER_ID') {
                console.warn("Kontrola testu přeskočena pro placeholder uživatele.");
                return false;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('user_diagnostics')
                    .select('id')
                    .eq('user_id', userId)
                    .limit(1);
                
                if (error) throw error;
                return data && data.length > 0;
            } catch (error) {
                console.error("Chyba kontroly existující diagnostiky:", error);
                return false;
            }
        }

        /**
         * Inicializuje aplikaci.
         */
        async function initializeApp() {
            try {
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey, supabaseOptions);
                
                if (!supabaseClient) throw new Error("Nepodařilo se inicializovat Supabase klienta");
                
                // Načtení přihlášeného uživatele
                currentUser = await getCurrentSupabaseUser();
                console.log("Aktuální uživatel:", currentUser);
                
                // Načtení profilu
                if (currentUser) {
                    currentProfile = await fetchUserProfile(currentUser.id);
                    console.log("Profil:", currentProfile);
                    updateUserInfoUI(currentProfile, currentUser.email);
                }
                
                // Nastavení událostí pro UI
                setupCommonEventListeners();
                
                // Kontrola existujícího testu (pro pozdější potřeby)
                const hasExistingDiagnostic = await checkExistingDiagnostic(currentUser?.id);
                console.log("Existující diagnostika:", hasExistingDiagnostic);
                
                // Nastavení historie pro správné chování tlačítka zpět
                history.replaceState({ state: 'testSelection' }, document.title, window.location.href);
                window.addEventListener('popstate', handleBackButton);
                
            } catch (error) {
                console.error("Chyba inicializace aplikace:", error);
                showErrorMessage("Nepodařilo se inicializovat aplikaci. Zkuste obnovit stránku.");
            }
        }

        /**
         * Zahájí vybraný test.
         */
        function startSelectedTest() {
            if (!selectedTestType) {
                alert('Vyberte typ testu.');
                return;
            }
            
            const config = testTypeConfig[selectedTestType];
            
            if (!config) {
                showErrorMessage(`Neznámý typ testu: ${selectedTestType}`);
                return;
            }
            
            testSelector.style.display = 'none';
            testLoader.style.display = 'block';
            testContainer.style.display = 'none';
            
            if (loaderSubtext) loaderSubtext.textContent = `Připravujeme ${config.title.toLowerCase()}...`;
            
            // Nastavení historie pro správné chování tlačítka zpět
            history.pushState({ state: 'testLoading' }, document.title, window.location.href);
            
            loadTestQuestions(selectedTestType)
                .then(() => {
                    initializeTest();
                    showQuestion(0);
                    
                    // Počkáme chvíli před skrytím loaderu pro plynulejší přechod
                    setTimeout(() => {
                        history.pushState({ state: 'testInProgress' }, document.title, window.location.href);
                    }, 500);
                })
                .catch(error => {
                    console.error("Chyba načítání testu:", error);
                    showErrorMessage("Nepodařilo se načíst test. Zkuste to znovu.");
                });
        }

        /**
         * Načte testové otázky z databáze.
         * @param {string} testType Typ testu
         * @returns {Promise<void>}
         */
        async function loadTestQuestions(testType) {
            try {
                const config = testTypeConfig[testType];
                const questionCount = config.questionsCount;
                
                // Načtení otázek z DB nebo demo otázek
                const { data: allQuestions, error: fetchError } = await supabaseClient
                    .from('test_questions')
                    .select('*')
                    .limit(100);  // Načteme víc pro náhodný výběr
                
                if (fetchError) throw fetchError;
                
                if (!allQuestions || allQuestions.length < questionCount) {
                    throw new Error(`Nedostatek otázek pro test (potřeba: ${questionCount}, nalezeno: ${allQuestions?.length || 0})`);
                }
                
                // Náhodný výběr otázek
                const shuffledQuestions = shuffleArray([...allQuestions]);
                questions = shuffledQuestions.slice(0, questionCount);
                
                // Příprava pole pro odpovědi uživatele
                userAnswers = new Array(questions.length).fill(null);
                
                console.log(`Načteno ${questions.length} otázek pro ${testType} test`);
                return;
                
            } catch (error) {
                console.error("Chyba při načítání otázek:", error);
                // V případě chyby použijeme demo otázky
                questions = generateDemoQuestions(testTypeConfig[testType].questionsCount);
                userAnswers = new Array(questions.length).fill(null);
                console.log("Použity demo otázky:", questions.length);
                return;
            }
        }

        /**
         * Inicializuje test.
         */
        function initializeTest() {
            testLoader.style.display = 'none';
            testContainer.style.display = 'block';
            resultsContainer.style.display = 'none';
            reviewContainer.style.display = 'none';
            
            // Nastavení názvu testu
            const config = testTypeConfig[selectedTestType];
            currentTestTitle.textContent = config.title;
            testLevel.textContent = `Diagnostický test`;
            
            // Nastavení počítadla otázek
            totalQuestionsEl.textContent = questions.length;
            questionCountEl.textContent = '1';
            answeredCountEl.textContent = '0';
            
            // Vytvoření navigace
            createPagination();
            updateNavigationButtons();
            
            // Spuštění časovače
            testTimer.style.display = 'block';
            startTimer();
        }

        /**
         * Zobrazí otázku s daným indexem.
         * @param {number} index Index otázky
         */
        function showQuestion(index) {
            if (index < 0 || index >= questions.length) return;
            
            const question = questions[index];
            console.log(`Zobrazuji Q#${index + 1}`, question);
            
            currentQuestionIndex = index;
            questionCountEl.textContent = (index + 1).toString();
            
            let questionHTML = `
                <div class="question-header">
                    <div class="question-number">${index + 1}</div>
                    <div class="question-text">${marked.parse(question.question_text)}</div>
                </div>
            `;
            
            // Zobrazení obrázku, pokud existuje
            if (question.image_url) {
                questionHTML += `
                    <div class="question-image-container">
                        <img src="${question.image_url}" alt="Obrázek k otázce" class="question-image">
                    </div>
                `;
            }
            
            // Různé typy otázek
            if (question.question_type === 'multiple_choice') {
                // Multiple choice
                questionHTML += `<div class="answer-options">`;
                
                if (question.options && Array.isArray(question.options)) {
                    question.options.forEach((option, optIndex) => {
                        const optionId = `q${index}-opt${optIndex}`;
                        const isSelected = userAnswers[index] && userAnswers[index].userAnswerValue === indexToLetter(optIndex);
                        
                        questionHTML += `
                            <label class="answer-option ${isSelected ? 'selected' : ''}" data-option-id="${optionId}">
                                <input type="radio" name="q${index}" value="${indexToLetter(optIndex)}" ${isSelected ? 'checked' : ''}>
                                <div class="answer-text"><span class="answer-letter">${indexToLetter(optIndex)}.</span> ${option}</div>
                            </label>
                        `;
                    });
                }
                
                questionHTML += `</div>`;
                
            } else if (question.question_type === 'construction') {
                // Otevřená konstrukční otázka
                questionHTML += `
                    <div class="construction-container">
                        <textarea class="construction-textarea" placeholder="Zapište svůj postup řešení...">${userAnswers[index]?.userAnswerValue || ''}</textarea>
                    </div>
                `;
                
            } else {
                // Text nebo numerická odpověď
                questionHTML += `
                    <div class="answer-input-container">
                        <label for="answer-input-${index}">Vaše odpověď:</label>
                        <input type="text" id="answer-input-${index}" class="answer-input" value="${userAnswers[index]?.userAnswerValue || ''}">
                    </div>
                `;
            }
            
            questionContainer.innerHTML = questionHTML;
            
            // Přidání posluchačů událostí pro interakci
            if (question.question_type === 'multiple_choice') {
                questionContainer.querySelectorAll('.answer-option').forEach(option => {
                    option.addEventListener('click', handleAnswerSelection);
                });
            } else if (question.question_type === 'construction') {
                const textarea = questionContainer.querySelector('.construction-textarea');
                if (textarea) {
                    textarea.addEventListener('input', () => {
                        saveAnswer(index, textarea.value);
                    });
                    textarea.addEventListener('blur', () => {
                        saveAnswer(index, textarea.value);
                    });
                }
            } else {
                const input = questionContainer.querySelector('.answer-input');
                if (input) {
                    input.addEventListener('input', () => {
                        saveAnswer(index, input.value);
                    });
                    input.addEventListener('blur', () => {
                        saveAnswer(index, input.value);
                    });
                }
            }
            
            // Aktualizace UI
            updatePagination();
            updateNavigationButtons();
            
            // Pokus o překreslení MathJax (pokud je v otázce matematika)
            if (window.MathJax && question.question_text.includes('$')) {
                MathJax.typeset();
            }
        }

        /**
         * Zpracuje výběr odpovědi.
         * @param {Event} event Událost kliknutí
         */
        function handleAnswerSelection(event) {
            const selectedLabel = event.currentTarget;
            const qIndex = currentQuestionIndex;
            const optionId = selectedLabel.dataset.optionId;
            const radio = selectedLabel.querySelector('input[type="radio"]');
            
            if (radio) {
                radio.checked = true;
                
                // Reset tříd
                questionContainer.querySelectorAll('.answer-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Přidat třídu vybrané odpovědi
                selectedLabel.classList.add('selected');
                
                // Uložit odpověď
                saveAnswer(qIndex, radio.value);
            }
        }

        /**
         * Uloží odpověď uživatele.
         * @param {number} qIndex Index otázky
         * @param {string} userAnswerValue Hodnota odpovědi
         */
        function saveAnswer(qIndex, userAnswerValue) {
            const question = questions[qIndex];
            if (!question) return;
            
            const wasAnsweredBefore = userAnswers[qIndex] !== null;
            const isEmptyAnswer = userAnswerValue === null || String(userAnswerValue).trim() === '';
            
            if (!isEmptyAnswer) {
                // Určení maximálního počtu bodů podle obtížnosti a typu
                let maxScore = 1;
                const difficultyInt = parseInt(question.difficulty);
                
                if (question.question_type === 'construction') {
                    maxScore = 2;
                } else if (!isNaN(difficultyInt)) {
                    if (difficultyInt >= 4) {
                        maxScore = 2;
                    }
                }
                
                userAnswers[qIndex] = {
                    question_id: question.id,
                    userAnswerValue: userAnswerValue,
                    topic_id: question.topic_id,
                    topic_name: question.topic,
                    scoreAwarded: 0, // Bude vyplněno při hodnocení
                    maxScore: maxScore,
                    checked_by: null // Bude 'gemini_scored', 'fallback_scored', 'skipped', 'error'
                };
            } else {
                userAnswers[qIndex] = null;
            }
            
            const isAnsweredNow = userAnswers[qIndex] !== null;
            
            if (wasAnsweredBefore !== isAnsweredNow) {
                const answeredCount = userAnswers.filter(a => a !== null).length;
                answeredCountEl.textContent = answeredCount.toString();
                updateProgressBar();
                updatePagination();
            }
        }

        /**
         * Vytvoří navigaci otázek.
         */
        function createPagination() {
            pagination.innerHTML = questions.map((_, i) => 
                `<div class="page-item" data-question="${i}">${i + 1}</div>`
            ).join('');
            
            pagination.querySelectorAll('.page-item').forEach(item => {
                item.addEventListener('click', () => {
                    const qIndex = parseInt(item.dataset.question, 10);
                    if (!isNaN(qIndex) && qIndex >= 0 && qIndex < questions.length) {
                        showQuestion(qIndex);
                    }
                });
            });
        }

        /**
         * Aktualizuje navigaci otázek.
         */
        function updatePagination() {
            pagination.querySelectorAll('.page-item').forEach((item, index) => {
                item.classList.remove('active', 'answered');
                
                if (index === currentQuestionIndex) {
                    item.classList.add('active');
                }
                
                if (userAnswers[index] !== null) {
                    item.classList.add('answered');
                }
            });
        }

        /**
         * Aktualizuje navigační tlačítka.
         */
        function updateNavigationButtons() {
            prevBtn.disabled = currentQuestionIndex === 0;
            nextBtn.disabled = currentQuestionIndex === questions.length - 1;
            
            finishBtn.style.display = currentQuestionIndex === questions.length - 1 ? 'flex' : 'none';
            nextBtn.style.display = currentQuestionIndex !== questions.length - 1 ? 'flex' : 'none';
        }

        /**
         * Aktualizuje indikátor postupu.
         */
        function updateProgressBar() {
            const answeredCount = userAnswers.filter(a => a !== null).length;
            const progress = (answeredCount / questions.length) * 100;
            
            progressBar.style.width = `${progress}%`;
        }

        /**
         * Spustí časovač testu.
         */
        function startTimer() {
            if (timer) clearInterval(timer);
            
            testStartTime = new Date();
            testTime = 0;
            timerValue.textContent = formatTime(testTime);
            testTimer.classList.remove('timer-warning', 'timer-danger');
            
            timer = setInterval(() => {
                testTime++;
                timerValue.textContent = formatTime(testTime);
                
                // Varování pro dlouhý čas
                const estimatedTime = questions.length * 60; // ~1 min per question
                const warningTime = estimatedTime * 0.8;
                const dangerTime = estimatedTime;
                
                if (testTime > dangerTime) {
                    testTimer.classList.add('timer-danger');
                    testTimer.classList.remove('timer-warning');
                } else if (testTime > warningTime) {
                    testTimer.classList.add('timer-warning');
                    testTimer.classList.remove('timer-danger');
                }
            }, 1000);
        }

        /**
         * Zastaví časovač testu.
         */
        function stopTimer() {
            clearInterval(timer);
            timer = null;
            testEndTime = new Date();
        }

        /**
         * Vyhodnotí odpověď uživatele pomocí Gemini API nebo fallback logiky.
         * @param {object} question - Objekt otázky.
         * @param {string|null} userAnswer - Odpověď uživatele.
         * @param {number} maxScore - Maximální možný počet bodů za otázku.
         * @returns {Promise<{score: number, checked_by: string}>} - Objekt obsahující získané skóre a metodu kontroly.
         */
        async function checkAnswerWithGemini(question, userAnswer, maxScore) {
            const { question_type, question_text, correct_answer, solution_explanation } = question;
            console.log(`--- Vyhodnocování Q#${question.question_number} (Typ: ${question_type}, Max: ${maxScore}) ---`);
            console.log(`   User Answer: `, userAnswer);
            console.log(`   Correct Answer/Explanation: `, correct_answer || solution_explanation);

            // --- Fallback Logika ---
            const runFallbackCheck = () => {
                console.warn(`   [CHECK] Používám fallback logiku pro Q#${question.question_number}`);
                let fallbackScore = 0;
                try {
                    if (userAnswer === null || String(userAnswer).trim() === "") return { score: 0, checked_by: 'fallback_empty' };

                    // 1. Numerické porovnání (pokud dává smysl)
                    if (['numeric', 'text', 'multiple_choice'].includes(question_type)) { // i MC a text můžou být čísla
                         const numericComparison = compareNumericAdvanced(userAnswer, correct_answer);
                         if (numericComparison === true) {
                             console.log(`      [Fallback] Shoda pomocí compareNumericAdvanced.`);
                             return { score: maxScore, checked_by: 'fallback_numeric' };
                         }
                    }

                    // 2. Textové/Logické porovnání (včetně Ano/Ne, MC písmen)
                    if (compareTextAdvanced(userAnswer, correct_answer)) {
                        console.log(`      [Fallback] Shoda pomocí compareTextAdvanced.`);
                        return { score: maxScore, checked_by: 'fallback_text' };
                    }

                    // 3. Fallback pro konstrukci (velmi základní)
                    if (question_type === 'construction') {
                         fallbackScore = (String(userAnswer).trim().length > 10) ? 1 : 0; // Alespoň 1 bod za snahu, pokud něco napsal
                         console.log(`      [Fallback] Construction - length check -> ${fallbackScore} bod(ů).`);
                         return { score: fallbackScore, checked_by: 'fallback_construction' };
                    }

                    // 4. Pokud nic nesedí
                    console.log(`      [Fallback] Neshoda.`);
                    return { score: 0, checked_by: 'fallback_mismatch' };

                } catch (e) {
                     console.error(`      [Fallback] Chyba při fallback porovnání Q#${question.question_number}:`, e);
                     return { score: 0, checked_by: 'fallback_error' };
                }
            };
            // --- Konec Fallback Logiky ---

             // 1. Handle empty/null answer immediately
             if (userAnswer === null || String(userAnswer).trim() === "") {
                 console.log("   [CHECK] Odpověď je prázdná nebo null. Skóre: 0");
                 return { score: 0, checked_by: 'skipped' };
             }

            // 2. Kontrola API klíče
            if (!GEMINI_API_KEY || GEMINI_API_KEY.startsWith('YOUR_') || GEMINI_API_KEY.length < 10) {
                 console.warn("   [CHECK] Chybí platný Gemini API klíč. Používám fallback.");
                 return runFallbackCheck();
            }

            // 3. Sestavení PROMPTU pro Gemini
            let prompt = `Jsi expertní AI hodnotící odpovědi na otázky z PŘIJÍMACÍCH ZKOUŠEK z matematiky/logiky v ČR (9. třída ZŠ). Tvým úkolem je PŘÍSNĚ a OBJEKTIVNĚ posoudit odpověď studenta a přiřadit skóre.`;
            prompt += `OTÁZKA:\n"""\n${question_text}\n"""\n\n`;
            prompt += `TYP OTÁZKY: ${question_type}\n`;
            prompt += `MAXIMÁLNÍ SKÓRE: ${maxScore}\n\n`;

            if (question_type === 'multiple_choice' && question.options) {
                prompt += `MOŽNOSTI:\n${question.options.map((opt, i) => `${indexToLetter(i)}. ${opt}`).join('\n')}\n\n`;
                prompt += `SPRÁVNÁ ODPOVĚĎ (Písmeno): ${String(correct_answer).trim().toUpperCase().charAt(0)}\n`;
            } else if (question_type === 'construction') {
                prompt += `OČEKÁVANÝ POSTUP / ŘEŠENÍ:\n"""\n${solution_explanation}\n"""\n\n`;
            } else {
                prompt += `SPRÁVNÁ ODPOVĚĎ:\n"""\n${correct_answer}\n"""\n\n`;
                 if(solution_explanation && solution_explanation.length > 5) { // Přidáme vysvětlení i pro jiné typy, pokud existuje
                     prompt += `VYSVĚTLENÍ/POSTUP (pro kontext):\n"""\n${solution_explanation}\n"""\n\n`;
                 }
            }

            prompt += `ODPOVĚĎ STUDENTA:\n"""\n${userAnswer}\n"""\n\n`;
            prompt += `PRAVIDLA HODNOCENÍ (aplikuj striktně):\n`;

            if (question_type === 'construction') {
                prompt += `1. Identifikuj klíčové kroky v OČEKÁVANÉM POSTUPU.\n`;
                prompt += `2. Posuď, zda popis studenta obsahuje VŠECHNY klíčové kroky ve správném logickém pořadí.\n`;
                prompt += `3. Skóre:\n`;
                prompt += `   - ${maxScore} body: Popis studenta je věcně správný, kompletní (všechny klíčové kroky) a logicky správně seřazený. Drobné formulační odchylky nebo vynechání nepodstatných detailů jsou přípustné.\n`;
                if (maxScore > 1) prompt += `   - 1 bod: Hlavní myšlenka je správná, ALE chybí JEDEN méně podstatný krok NEBO obsahuje JEDNU či DVĚ menší nepřesnosti, které zásadně nemění postup.\n`;
                prompt += `   - 0 bodů: Zásadně chybný, chybí VÍCE klíčových kroků, špatné pořadí, VÍCE než dvě chyby, nesrozumitelný, prázdný.\n`;
                prompt += `4. Hodnoť POUZE správnost a úplnost popsaného POSTUPU.\n`;
            } else if (question_type === 'multiple_choice') {
                prompt += `1. Porovnej POUZE PÍSMENO na začátku odpovědi studenta (ignoruj velikost, tečky, závorky) se správným písmenem.\n`;
                prompt += `2. SKÓRE: ${maxScore} bodů POUZE při PŘESNÉ shodě písmen, jinak 0 bodů.\n`;
            } else { // numeric, text, ano_ne
                prompt += `1. Ekvivalence: Zaměř se na matematickou/logickou správnost. Znamená odpověď studenta totéž jako správná odpověď?\n`;
                prompt += `2. Formátování (ČÍSLA): Buď flexibilní k běžným variacím ('1,5'=='1.5'; '3/2'=='1.5'; '5'=='5.00'; '10 Kč'=='10'). Tolerance pro numerickou shodu je ${NUMERIC_TOLERANCE}.\n`;
                prompt += `3. Ano/Ne: Hodnoť POUZE shodu prvního slova ("ano" == "ano", "ne" == "ne"). Ignoruj velikost, interpunkci za slovem.\n`;
                prompt += `4. Text/Symbolika (rovnice, intervaly): Vyžaduj VYŠŠÍ shodu obsahu po normalizaci mezer a velikosti písmen.\n`;
                prompt += `5. SKÓRE: ${maxScore} bodů POUZE PŘI PLNÉ ekvivalenci podle těchto pravidel, jinak 0 bodů.\n`;
            }
            prompt += `\nVÝSTUP: Vrať POUZE JSON objekt {"score": number, "reason": "stručné zdůvodnění proč"}. 'score' musí být celé číslo mezi 0 a ${maxScore} včetně.`;

            // 4. Volání Gemini API
            try {
                console.log(`   [CHECK] Posílám požadavek Gemini pro Q#${question.question_number}`);
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.1, // Nízká teplota pro konzistentní hodnocení
                            responseMimeType: "application/json",
                        },
                         safetySettings: [ // Uvolnění bezpečnostních filtrů
                           { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                           { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                           { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                           { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                         ]
                    })
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error(`   [CHECK] Gemini API Error (${response.status}) for Q#${question.question_number}:`, errorBody);
                    throw new Error(`Chyba Gemini API (${response.status})`);
                }

                const data = await response.json();
                // console.log(`   [CHECK] Gemini Raw Response Q#${question.question_number}:`, JSON.stringify(data));

                const jsonText = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                if (!jsonText) {
                     console.error(`   [CHECK] Gemini - Neplatná struktura odpovědi nebo chybí text pro Q#${question.question_number}:`, data);
                     throw new Error('Chybná struktura odpovědi od Gemini.');
                }

                console.log(`   [CHECK] Gemini JSON Text Q#${question.question_number}:`, jsonText);

                // 5. Zpracování odpovědi Gemini
                try {
                     const result = JSON.parse(jsonText);
                     console.log(`   [CHECK] Gemini Parsed Result Q#${question.question_number}:`, result);

                     if (typeof result.score !== 'number' || !Number.isInteger(result.score) || result.score < 0 || result.score > maxScore) {
                         console.warn(`   [CHECK] Gemini - Neplatné skóre ${result.score} (max ${maxScore}) pro Q#${question.question_number}. Používám fallback.`);
                         return runFallbackCheck();
                     }

                     console.log(`   [CHECK] Gemini Výsledek Q#${question.question_number}: Skóre: ${result.score}, Důvod: ${result.reason}`);
                     return { score: result.score, checked_by: 'gemini_scored' };

                 } catch (e) {
                     console.error(`   [CHECK] Gemini - Nepodařilo se parsovat JSON pro Q#${question.question_number}:`, e, "Odpověď:", jsonText);
                     return runFallbackCheck(); // Fallback při chybě parsování JSON
                 }

            } catch (error) {
                 console.error(`   [CHECK] Selhalo volání Gemini API pro Q#${question.question_number}:`, error);
                 return runFallbackCheck(); // Fallback při selhání API volání
            }
        }

        /**
         * Dokončí test a vyhodnotí výsledky.
         */
        async function finishTest() {
            stopTimer();
            showGeminiOverlay(true);
            let savedSuccessfully = false;

            try {
                await evaluateAnswers();
                calculateFinalResults();
                showGeminiOverlay(false);
                
                // Pokus o uložení výsledků do DB
                savedSuccessfully = await saveTestResults();
                
                // Zobrazení výsledků bez ohledu na uložení
                displayResults();
                
                if (savedSuccessfully) {
                    await awardPoints();
                } else {
                    console.log("Výsledky nebyly uloženy, body se nepřičítají.");
                }
                
                history.pushState({ state: 'testFinished', saved: savedSuccessfully }, document.title, window.location.href);
                
            } catch (error) {
                console.error("Chyba při dokončování testu:", error);
                showGeminiOverlay(false);
                
                // Zobrazení chybové hlášky
                if (lowScoreMessageContainer) {
                    lowScoreMessageContainer.innerHTML = `
                        <div class="error-message-container">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="loader-text">Chyba!</div>
                            <div class="loader-subtext">Chyba vyhodnocení testu: ${error.message}</div>
                        </div>
                    `;
                }
            }
        }

        /**
         * Vyhodnotí odpovědi uživatele.
         */
        async function evaluateAnswers() {
            console.log("Spouštím vyhodnocení odpovědí...");
            
            const promises = [];
            
            for (let i = 0; i < questions.length; i++) {
                const q = questions[i];
                const answerData = userAnswers[i];
                const userAnswerValue = answerData ? answerData.userAnswerValue : null;
                const maxScore = answerData ? answerData.maxScore : (() => {
                    let score = 1;
                    const d = parseInt(q.difficulty);
                    if (q.question_type === 'construction') score = 2;
                    else if (!isNaN(d) && d >= 4) score = 2;
                    return score;
                })();
                
                promises.push(
                    checkAnswerWithGemini(q, userAnswerValue, maxScore)
                        .then(result => {
                            if (userAnswers[i]) {
                                userAnswers[i].scoreAwarded = result.score;
                                userAnswers[i].checked_by = result.checked_by;
                            } else if (result.score > 0) {
                                // Neočekávaná situace - máme skóre, ale ne odpověď
                                userAnswers[i] = {
                                    question_id: q.id,
                                    userAnswerValue: null,
                                    topic_id: q.topic_id,
                                    topic_name: q.topic,
                                    scoreAwarded: result.score,
                                    maxScore: maxScore,
                                    checked_by: result.checked_by
                                };
                            }
                            
                            console.log(`Otázka ${i + 1} vyhodnocena: ${result.score}/${maxScore} bodů (${result.checked_by})`);
                        })
                        .catch(error => {
                            console.error(`Chyba při vyhodnocení otázky ${i + 1}:`, error);
                            // Fallback při chybě - 0 bodů
                            if (userAnswers[i]) {
                                userAnswers[i].scoreAwarded = 0;
                                userAnswers[i].checked_by = 'error';
                            }
                        })
                );
            }
            
            await Promise.all(promises);
            console.log("Vyhodnocení odpovědí dokončeno.");
        }

        /**
         * Vypočítá konečné výsledky testu.
         */
        function calculateFinalResults() {
            let totalRawPointsAchieved = 0;
            let totalRawMaxPossiblePoints = 0;
            let correctCount = 0; // Otázky s >= 1 bodem
            let incorrectCount = 0; // Otázky s 0 body (ale zodpovězené)
            let unansweredCount = 0;
            let topicStats = {};
            
            questions.forEach((q, index) => {
                const answer = userAnswers[index];
                const topicKey = q.topic_id || q.topic || 'unknown';
                const topicName = q.topic || 'Neznámé téma';
                
                // Inicializace statistik pro téma, pokud neexistují
                if (!topicStats[topicKey]) {
                    topicStats[topicKey] = {
                        name: topicName,
                        id: q.topic_id,
                        totalQuestions: 0,
                        fullyCorrectQuestions: 0, // Počet otázek s plným počtem bodů
                        totalPointsAchieved: 0,
                        totalMaxPoints: 0,
                        scorePercent: 0, // (fullyCorrectQuestions / totalQuestions) * 100
                        strength: 'neutral'
                    };
                }
                
                topicStats[topicKey].totalQuestions++;
                
                const maxScore = answer?.maxScore ?? 1;
                topicStats[topicKey].totalMaxPoints += maxScore;
                totalRawMaxPossiblePoints += maxScore;
                
                if (!answer || answer.userAnswerValue === null) {
                    unansweredCount++;
                } else {
                    const scoreAwarded = answer.scoreAwarded || 0;
                    topicStats[topicKey].totalPointsAchieved += scoreAwarded;
                    totalRawPointsAchieved += scoreAwarded;
                    
                    if (scoreAwarded >= 1) {
                        correctCount++;
                    } else {
                        incorrectCount++;
                    }
                    
                    // Plně správná odpověď (maximální počet bodů)
                    if (scoreAwarded === maxScore) {
                        topicStats[topicKey].fullyCorrectQuestions++;
                    }
                }
            });
            
            // Výpočet síly/slabosti témat
            Object.values(topicStats).forEach(stats => {
                stats.scorePercent = stats.totalQuestions > 0 ? 
                    Math.round((stats.fullyCorrectQuestions / stats.totalQuestions) * 100) : 0;
                
                stats.strength = stats.scorePercent >= 75 ? 'strength' : 
                                 stats.scorePercent < 50 ? 'weakness' : 'neutral';
            });
            
            const finalPercentage = questions.length > 0 ? 
                Math.round((correctCount / questions.length) * 100) : 0;
            
            // Celkové skóre 0-50 = (získané body / max možné body) * 50
            const finalScoreOutOf50 = totalRawMaxPossiblePoints > 0 ? 
                Math.round((totalRawPointsAchieved / totalRawMaxPossiblePoints) * 50) : 0;
            
            testResultsData = {
                totalQuestions: questions.length,
                correctAnswers: correctCount,
                incorrectAnswers: incorrectCount,
                unanswered: unansweredCount,
                score: finalScoreOutOf50,
                totalPointsAchieved: totalRawPointsAchieved,
                totalMaxPossiblePoints: totalRawMaxPossiblePoints,
                percentage: finalPercentage,
                timeSpent: testTime,
                topicResults: topicStats
            };
            
            console.log("Výsledky testu:", testResultsData);
        }

        /**
         * Zobrazí výsledky testu.
         */
        function displayResults() {
            if (!testContainer || !resultsContainer || !reviewContainer || !testTimer || 
                !testLevel || !resultScoreEl || !resultPercentageEl || !resultCorrectEl || 
                !resultIncorrectEl || !resultTimeEl || !topicResultsEl) {
                console.error("Chybí elementy pro zobrazení výsledků!");
                return;
            }
            
            testContainer.style.display = 'none';
            resultsContainer.style.display = 'block';
            reviewContainer.style.display = 'none';
            testTimer.style.display = 'none';
            testLevel.textContent = 'Výsledky testu';
            
            // Základní výsledky
            resultScoreEl.textContent = testResultsData.score;
            resultPercentageEl.textContent = testResultsData.percentage;
            resultCorrectEl.textContent = testResultsData.correctAnswers;
            resultIncorrectEl.textContent = testResultsData.incorrectAnswers;
            resultTimeEl.textContent = formatTime(testResultsData.timeSpent);
            
            // Tlačítko pro pokračování k plánu
            continueBtn.disabled = true; // Defaultně zakázané
            
            const saveError = continueBtn.getAttribute('data-save-error') === 'true';
            
            if (saveError) {
                console.log("Chyba ukládání detekována, tlačítko plánu zůstává neaktivní.");
                lowScoreMessageContainer.innerHTML = `
                    <div class="error-message-container">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="loader-text">Chyba ukládání!</div>
                        <div class="loader-subtext">Nepodařilo se uložit výsledky testu. Zkuste to prosím znovu.</div>
                    </div>
                `;
            } else if (testResultsData.score < SCORE_THRESHOLD_FOR_SAVING) {
                // Nízké skóre
                lowScoreMessageContainer.innerHTML = `
                    <div class="low-score-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Pro vytvoření studijního plánu potřebujete získat alespoň ${SCORE_THRESHOLD_FOR_SAVING} bodů.</strong><br>
                        Vaše skóre je příliš nízké pro vytvoření přesného studijního plánu. Zkuste test znovu po procvičení základních konceptů.
                    </div>
                `;
            } else {
                // Dostatečné skóre
                continueBtn.disabled = false;
                lowScoreMessageContainer.innerHTML = `
                    <div class="low-score-message info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Výsledky byly zpracovány.</strong><br>
                        Vaše skóre (${testResultsData.score}/50) je dostatečné pro vytvoření personalizovaného studijního plánu.
                    </div>
                `;
                console.log(`Výsledky zpracovány (skóre ${testResultsData.score} >= ${SCORE_THRESHOLD_FOR_SAVING}). Tlačítko plánu aktivováno.`);
            }
            
            // Zobrazení výsledků podle témat
            const sortedTopics = Object.values(testResultsData.topicResults || {})
                .sort((a, b) => a.name.localeCompare(b.name));
            
            let topicsHTML = '';
            
            // Pro každé téma vytvoříme kartu
            sortedTopics.forEach(topic => {
                const icon = topicIcons[topic.name] || topicIcons.default;
                const scorePercent = topic.totalQuestions > 0 ? 
                    Math.round((topic.totalPointsAchieved / topic.totalMaxPoints) * 100) : 0;
                
                topicsHTML += `
                    <div class="topic-card ${topic.strength}">
                        <div class="topic-header">
                            <div class="topic-icon">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="topic-title">${topic.name}</div>
                        </div>
                        <div class="topic-stats">
                            <div class="topic-progress">
                                <div class="topic-progress-label">Správné odpovědi:</div>
                                <div class="topic-progress-value">${topic.fullyCorrectQuestions}/${topic.totalQuestions}</div>
                            </div>
                            <div class="topic-progress-bar">
                                <div class="topic-progress-fill" style="width: ${topic.scorePercent}%"></div>
                            </div>
                            <div class="topic-progress">
                                <div class="topic-progress-label">Získané body:</div>
                                <div class="topic-progress-value">${topic.totalPointsAchieved}/${topic.totalMaxPoints}</div>
                            </div>
                            <div class="topic-progress-bar">
                                <div class="topic-progress-fill" style="width: ${scorePercent}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            topicResultsEl.innerHTML = topicsHTML;
        }

        /**
         * Vytváří podrobný objekt analýzy pro uložení do DB.
         * @param {object} results - Objekt testResultsData.
         * @param {Array} answers - Pole userAnswers.
         * @param {Array} questionsData - Pole původních objektů otázek.
         * @returns {object} - Detailní objekt analýzy.
         */
        function generateDetailedAnalysis(results, answers, questionsData) {
            console.log("Generování detailní analýzy...");
            const analysis = {
                summary: {
                    score_final_normalized: results.score, // 0-50 scale
                    total_points_achieved: results.totalPointsAchieved,
                    total_max_possible_points: results.totalMaxPossiblePoints,
                    percentage_correct_questions: results.percentage, // % otázek s >= 1 bodem
                    percentage_points_achieved: results.totalMaxPossiblePoints > 0 ? 
                        Math.round((results.totalPointsAchieved / results.totalMaxPossiblePoints) * 100) : 0, // % získaných bodů
                    time_spent_seconds: results.timeSpent,
                    total_questions: results.totalQuestions,
                    correct_questions_count: results.correctAnswers, // >= 1 bod
                    incorrect_questions_count: results.incorrectAnswers, // 0 bodů
                    unanswered_questions_count: results.unanswered,
                },
                strengths: [], // Témata s >= 75% úspěšností (plně správně)
                weaknesses: [], // Témata s < 50% úspěšností (plně správně)
                detailed_topic_performance: {}, // Detailní statistiky pro KAŽDÉ téma
                detailed_question_performance: [], // Detailní statistiky pro KAŽDOU otázku
                performance_by_type: {}, // Výkon podle typu otázky
                performance_by_difficulty: {}, // Výkon podle obtížnosti (pokud je dostupná)
                overall_assessment: "", // Celkové slovní hodnocení
                recommendations: [] // Doporučení pro studijní plán
            };

            // 1. Detailní výkon podle témat a identifikace S&W
            for (const [topicKey, stats] of Object.entries(results.topicResults || {})) {
                const topicDetail = {
                    topic_id: stats.id,
                    topic_name: stats.name,
                    total_questions_in_topic: stats.totalQuestions,
                    fully_correct_questions: stats.fullyCorrectQuestions, // s plným počtem bodů
                    partially_correct_questions: 0, // Budeme počítat níže
                    incorrect_questions: 0, // s 0 body
                    total_points_achieved: stats.totalPointsAchieved,
                    total_max_points: stats.totalMaxPoints,
                    score_percent_fully_correct: stats.scorePercent, // % plně správných
                    score_percent_points_achieved: stats.totalMaxPoints > 0 ? 
                        Math.round((stats.totalPointsAchieved / stats.totalMaxPoints) * 100) : 0, // % získaných bodů
                    strength_level: stats.strength // 'strength', 'neutral', 'weakness'
                };
                
                analysis.detailed_topic_performance[stats.name] = topicDetail;
                
                if (stats.strength === 'strength') {
                    analysis.strengths.push({ topic: stats.name, score: stats.scorePercent });
                } else if (stats.strength === 'weakness') {
                    analysis.weaknesses.push({ topic: stats.name, score: stats.scorePercent });
                }
            }
            
            analysis.strengths.sort((a, b) => b.score - a.score);
            analysis.weaknesses.sort((a, b) => a.score - b.score);

            // 2. Detailní výkon podle otázek a typů
            questionsData.forEach((q, index) => {
                const answer = answers[index];
                const qType = q.question_type;
                const difficulty = q.difficulty || 'unknown';
                const topicName = q.topic || 'Neznámé téma';

                // Agregace podle typu
                if (!analysis.performance_by_type[qType]) {
                    analysis.performance_by_type[qType] = {
                        points_achieved: 0,
                        max_points: 0,
                        total_questions: 0,
                        correct_questions: 0,
                        partial_questions: 0,
                        incorrect_questions: 0
                    };
                }
                analysis.performance_by_type[qType].total_questions++;

                // Agregace podle obtížnosti
                if (!analysis.performance_by_difficulty[difficulty]) {
                    analysis.performance_by_difficulty[difficulty] = {
                        points_achieved: 0,
                        max_points: 0,
                        total_questions: 0,
                        correct_questions: 0,
                        partial_questions: 0,
                        incorrect_questions: 0
                    };
                }
                analysis.performance_by_difficulty[difficulty].total_questions++;

                const maxQScore = answer?.maxScore ?? 1;
                analysis.performance_by_type[qType].max_points += maxQScore;
                analysis.performance_by_difficulty[difficulty].max_points += maxQScore;

                const questionDetail = {
                    question_number: q.question_number || index + 1,
                    question_id: q.id,
                    topic: topicName,
                    subtopic: q.subtopic || null,
                    type: qType,
                    difficulty: difficulty,
                    user_answer: answer?.userAnswerValue ?? null,
                    correct_answer: q.correct_answer,
                    solution_explanation: q.solution_explanation,
                    score_awarded: answer?.scoreAwarded ?? 0,
                    max_score: maxQScore,
                    checked_by: answer?.checked_by ?? 'unknown',
                    status: 'unanswered' // Výchozí stav
                };

                if (answer && answer.checked_by !== 'skipped' && answer.checked_by !== 'fallback_empty') {
                    const awardedScore = answer.scoreAwarded ?? 0;
                    analysis.performance_by_type[qType].points_achieved += awardedScore;
                    analysis.performance_by_difficulty[difficulty].points_achieved += awardedScore;

                    if (awardedScore === maxQScore) {
                        questionDetail.status = 'correct';
                        analysis.performance_by_type[qType].correct_questions++;
                        analysis.performance_by_difficulty[difficulty].correct_questions++;
                        // fullyCorrectQuestions se počítá v `calculateFinalResults`, zde nepotřebujeme znovu
                    } else if (awardedScore > 0) {
                        questionDetail.status = 'partial';
                        analysis.performance_by_type[qType].partial_questions++;
                        analysis.performance_by_difficulty[difficulty].partial_questions++;
                        if(analysis.detailed_topic_performance[topicName]) {
                            analysis.detailed_topic_performance[topicName].partially_correct_questions++;
                        }
                    } else {
                        questionDetail.status = 'incorrect';
                        analysis.performance_by_type[qType].incorrect_questions++;
                        analysis.performance_by_difficulty[difficulty].incorrect_questions++;
                        if(analysis.detailed_topic_performance[topicName]) {
                            analysis.detailed_topic_performance[topicName].incorrect_questions++;
                        }
                    }
                } else {
                    questionDetail.status = 'skipped';
                    // Nezapočítáváme body, ale otázka existuje
                }
                analysis.detailed_question_performance.push(questionDetail);
            });

            // 3. Celkové slovní hodnocení
            const score = results.score;
            if (score >= 45) analysis.overall_assessment = "Vynikající výkon! Skvělá příprava.";
            else if (score >= 38) analysis.overall_assessment = "Velmi dobrý výkon, silný základ.";
            else if (score >= 30) analysis.overall_assessment = "Dobrý výkon, s prostorem pro zlepšení v konkrétních oblastech.";
            else if (score >= 20) analysis.overall_assessment = "Průměrný výkon. Je třeba se zaměřit na identifikované slabiny.";
            else if (score >= 10) analysis.overall_assessment = "Podprůměrný výkon. Doporučuje se systematické opakování základů a cílené procvičování.";
            else analysis.overall_assessment = "Výrazně podprůměrný výkon. Nutné důkladné zopakování všech témat a intenzivní procvičování.";
            
            if (score < SCORE_THRESHOLD_FOR_SAVING) analysis.overall_assessment += " Skóre je příliš nízké pro uložení a generování optimálního studijního plánu.";

            // 4. Doporučení
            if (analysis.weaknesses.length > 0) {
                analysis.recommendations.push(`Priorita č. 1: Intenzivně se zaměřte na nejslabší témata: **${analysis.weaknesses.map(w => `${w.topic} (${w.score}%)`).join(', ')}**. Projděte si základní koncepty a pravidla v těchto oblastech.`);
                const incorrectWeakTopics = analysis.detailed_question_performance.filter(q => analysis.weaknesses.some(w => w.topic === q.topic) && q.status === 'incorrect');
                if (incorrectWeakTopics.length > 0) {
                    analysis.recommendations.push(`Analyzujte konkrétní chyby v otázkách č. ${incorrectWeakTopics.map(q => q.question_number).slice(0, 5).join(', ')} z těchto slabých témat.`);
                }
            } else if (results.percentage < 85 && Object.keys(analysis.detailed_topic_performance).length > 0) {
                // Najít téma s nejnižším % získaných bodů (pokud nejsou explicitní slabiny)
                const lowestPointsTopic = Object.values(analysis.detailed_topic_performance).sort((a,b) => a.score_percent_points_achieved - b.score_percent_points_achieved)[0];
                if(lowestPointsTopic) analysis.recommendations.push(`I když nemáte výrazné slabiny, zaměřte se na zlepšení v tématu **${lowestPointsTopic.topic_name}** (získané body: ${lowestPointsTopic.score_percent_points_achieved}%).`);
            }

            // Doporučení na základě typů otázek
            const typePerformance = Object.entries(analysis.performance_by_type)
                .map(([type, stats]) => ({ type, perc: stats.max_points > 0 ? Math.round(stats.points_achieved * 100 / stats.max_points) : 100 }))
                .sort((a, b) => a.perc - b.perc);
            if (typePerformance.length > 0 && typePerformance[0].perc < 60) {
                analysis.recommendations.push(`Zlepšete se v řešení otázek typu: **${typePerformance[0].type}** (úspěšnost bodů: ${typePerformance[0].perc}%). Zkuste jiný přístup nebo si nastudujte další příklady.`);
            }

            // Další obecná doporučení
            const incorrectQuestions = analysis.detailed_question_performance.filter(q => q.status === 'incorrect').length;
            if (incorrectQuestions > 3) { 
                analysis.recommendations.push(`Pečlivě si projděte **${incorrectQuestions} chybně zodpovězených otázek** a pochopte, kde nastala chyba.`); 
            }

            if (results.percentage < 70) { 
                analysis.recommendations.push("Opakujte klíčové vzorce a definice."); 
            }
            
            if (analysis.strengths.length > 0) { 
                analysis.recommendations.push(`Nezapomínejte udržovat silné stránky (např. **${analysis.strengths[0].topic}**) pravidelným opakováním.`); 
            }
            
            if (score >= SCORE_THRESHOLD_FOR_SAVING) { 
                analysis.recommendations.push("Využijte tuto analýzu pro **vytvoření personalizovaného studijního plánu**."); 
            }
            else { 
                analysis.recommendations.push("Po dalším procvičení zkuste diagnostický test znovu."); 
            }

            console.log("Detailní analýza vygenerována.");
            return analysis;
        }

        /**
         * Uloží výsledky testu do databáze.
         * @returns {Promise<boolean>} True pokud byly výsledky úspěšně uloženy
         */
        async function saveTestResults() {
            console.log("Spouštím saveTestResults...");
            // Znovu zkontrolovat podmínky, i když by měly být splněny, pokud se funkce volá
            if (!currentUser || currentUser.id === 'PLACEHOLDER_USER_ID') {
                console.warn("Neukládám: Není přihlášený uživatel.");
                return false; // Neuloženo
            }
            if (testResultsData.score < SCORE_THRESHOLD_FOR_SAVING) {
                console.log(`Neukládám: Výsledek (${testResultsData.score}/50) je nižší než ${SCORE_THRESHOLD_FOR_SAVING}.`);
                return false; // Neuloženo
            }

            console.log(`Pokouším se uložit výsledky (Skóre: ${testResultsData.score}/50 >= ${SCORE_THRESHOLD_FOR_SAVING})...`);
            if (continueBtn) continueBtn.disabled = true; // Zakázat tlačítko během ukládání

            try {
                // Generování podrobné analýzy
                const detailedAnalysis = generateDetailedAnalysis(testResultsData, userAnswers, questions);

                const dataToSave = {
                    user_id: currentUser.id,
                    completed_at: new Date().toISOString(),
                    total_score: testResultsData.score, // Skóre 0-50
                    total_questions: testResultsData.totalQuestions,
                    // Uložíme pole odpovědí s detailními informacemi
                    answers: userAnswers.map(a => ({
                        q_id: a?.question_id,
                        u_answer: a?.userAnswerValue,
                        score: a?.scoreAwarded,
                        max_score: a?.maxScore,
                        checked_by: a?.checked_by
                    })),
                    // Uložíme detailní výsledky podle témat z testResultsData
                    topic_results: testResultsData.topicResults,
                    // Uložíme vygenerovanou podrobnou analýzu
                    analysis: detailedAnalysis,
                    // Můžeme přidat i další metadata
                    test_type: selectedTestType
                };

                console.log("Data k uložení do user_diagnostics:", dataToSave);

                const { data, error } = await supabaseClient
                    .from('user_diagnostics')
                    .insert(dataToSave)
                    .select('id')
                    .single();

                if (error) {
                    console.error('Supabase insert error:', error);
                    throw new Error(`Supabase chyba: ${error.message} (Hint: ${error.hint})`);
                }

                diagnosticId = data.id; // Uložíme ID pro případné další použití
                console.log("Diagnostika úspěšně uložena, ID:", diagnosticId);
                if (continueBtn) continueBtn.disabled = false; // Povolit tlačítko po úspěšném uložení
                return true; // Uloženo úspěšně

            } catch (error) {
                console.error('Chyba při ukládání výsledků testu:', error);
                showToast(`Nepodařilo se uložit výsledky: ${error.message}`, 'error');
                if (continueBtn) {
                    continueBtn.disabled = true;
                    continueBtn.setAttribute('data-save-error', 'true'); // Označit chybu pro displayResults
                }
                // Nevyhazujeme zde znovu chybu, necháme finishTest zobrazit výsledky s chybovou zprávou
                return false; // Uložení selhalo
            }
        }

        /**
         * Přidělí uživateli body na základě výsledků testu.
         */
        async function awardPoints() {
            if (!selectedTestType || !testResultsData || testResultsData.totalQuestions <= 0) {
                console.warn("Nelze vypočítat body: Chybí data testu.");
                return;
            }
            
            if (!currentUser || !currentProfile || currentUser.id === 'PLACEHOLDER_USER_ID') {
                console.warn("Nelze přidělit body: Žádný přihlášený uživatel.");
                return;
            }
            
            try {
                // Výpočet bodů podle typu testu a výsledků
                const multiplier = testTypeConfig[selectedTestType].multiplier || 1.0;
                const score_perc = testResultsData.percentage / 100; // 0-1
                const n = testResultsData.totalQuestions / 10; // Normalizace počtu otázek (10 otázek = 1)
                
                const calculatedPoints = Math.round(n * score_perc * multiplier * 15); // Max cca 15-25 bodů za test
                
                if (calculatedPoints <= 0) {
                    console.log("Nebyly získány žádné body.");
                    return;
                }
                
                console.log(`Vypočítané body: ${calculatedPoints} (n=${n}, score%=${testResultsData.percentage}, multiplier=${multiplier})`);
                
                await updateUserPoints(calculatedPoints);
                await updateUserStats();
                
                showToast(`Získali jste ${calculatedPoints} bodů za dokončení testu!`, 'success');
                
            } catch (error) {
                console.error("Chyba při přidělování bodů:", error);
                showToast("Nepodařilo se přidělit body za test.", 'error');
            }
        }

        /**
         * Aktualizuje počet bodů uživatele.
         * @param {number} pointsToAdd Počet bodů k přidání
         */
        async function updateUserPoints(pointsToAdd) {
            if (!currentUser || !currentProfile || pointsToAdd <= 0) {
                console.log("Přeskakuji aktualizaci bodů:", { userId: currentUser?.id, profileId: currentProfile?.id, points: pointsToAdd });
                return;
            }
            
            try {
                const currentPoints = currentProfile.points || 0;
                const newPoints = currentPoints + pointsToAdd;
                
                // Uložení do databáze
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ points: newPoints })
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                
                // Aktualizace lokální proměnné
                currentProfile.points = newPoints;
                console.log(`Body uživatele aktualizovány: ${currentPoints} -> ${newPoints} (+${pointsToAdd})`);
                
            } catch (error) {
                console.error("Chyba při aktualizaci bodů uživatele:", error);
                throw error;
            }
        }

        /**
         * Aktualizuje statistiky uživatele.
         */
        async function updateUserStats() {
            console.log("Aktualizace user stats - přeskočeno (zatím není implementováno).");
        }

        /**
         * Zobrazí přehled odpovědí.
         */
        function displayReview() {
            if (!resultsContainer || !reviewContainer || !reviewContent) {
                console.error("Elementy pro přehled odpovědí nenalezeny!");
                return;
            }
            
            resultsContainer.style.display = 'none';
            reviewContainer.style.display = 'block';
            
            let reviewHTML = '';
            
            questions.forEach((q, index) => {
                const answer = userAnswers[index];
                const questionNum = index + 1;
                
                // Určení stavu odpovědi
                let statusClass = 'skipped';
                if (answer) {
                    if (answer.scoreAwarded === answer.maxScore) statusClass = 'correct';
                    else if (answer.scoreAwarded > 0) statusClass = 'partial';
                    else statusClass = 'incorrect';
                }
                
                reviewHTML += `
                    <div class="review-question-item ${statusClass}">
                        <div class="review-question-header">
                            <div class="review-question-number">${questionNum}</div>
                            <div class="review-question-text">${marked.parse(q.question_text)}</div>
                        </div>
                `;
                
                // Zobrazení obrázku, pokud existuje
                if (q.image_url) {
                    reviewHTML += `
                        <div class="question-image-container">
                            <img src="${q.image_url}" alt="Obrázek k otázce" class="question-image">
                        </div>
                    `;
                }
                
                // Sekce s odpověďmi
                reviewHTML += `<div class="review-answer-section">`;
                
                // Zobrazení odpovědi uživatele
                if (answer && answer.userAnswerValue) {
                    if (q.question_type === 'multiple_choice' && q.options) {
                        // Multiple choice - zobrazíme všechny možnosti a zvýrazníme vybranou
                        reviewHTML += `<h4>Možnosti:</h4>`;
                        
                        q.options.forEach((option, optIndex) => {
                            const letter = indexToLetter(optIndex);
                            const isSelected = answer.userAnswerValue === letter;
                            const isCorrect = q.correct_answer.trim().toUpperCase().charAt(0) === letter;
                            
                            let optionClass = '';
                            if (isSelected) optionClass += ' user-selected';
                            if (isCorrect) optionClass += ' correct-answer';
                            
                            reviewHTML += `<div class="review-mc-option${optionClass}" data-letter="${letter}">${option}</div>`;
                        });
                    } else {
                        reviewHTML += `<div class="review-user-answer"><strong>Vaše odpověď:</strong> ${sanitizeHTML(answer.userAnswerValue)}</div>`;
                    }
                } else {
                    reviewHTML += `<div class="review-user-answer"><strong>Vaše odpověď:</strong> <em>(Nezodpovězeno)</em></div>`;
                }
                
                if (answer && answer.checked_by !== 'skipped' && answer.checked_by !== 'fallback_empty') {
                    // Zobrazení správné odpovědi
                    if (q.question_type !== 'construction') {
                        reviewHTML += `<div class="review-correct-answer"><strong>Správná odpověď:</strong> ${sanitizeHTML(q.correct_answer)}</div>`;
                    }
                    
                    // Zobrazení řešení / vysvětlení
                    if (q.solution_explanation) {
                        reviewHTML += `<div class="review-solution"><strong>Řešení / Postup:</strong><div class="solution-content">${marked.parse(q.solution_explanation)}</div></div>`;
                    }
                    
                    // Skóre
                    reviewHTML += `<div class="review-score">`;
                    if (answer.scoreAwarded === answer.maxScore) {
                        reviewHTML += `<span class="correct">Správně: ${answer.scoreAwarded}/${answer.maxScore} bodů</span>`;
                    } else if (answer.scoreAwarded > 0) {
                        reviewHTML += `<span class="partial">Částečně správně: ${answer.scoreAwarded}/${answer.maxScore} bodů</span>`;
                    } else {
                        reviewHTML += `<span class="incorrect">Nesprávně: 0/${answer.maxScore} bodů</span>`;
                    }
                    reviewHTML += `</div>`;
                } else {
                    reviewHTML += `<div class="review-score"><span class="skipped">Nezodpovězeno: 0/${q.question_type === 'construction' ? 2 : 1} bodů</span></div>`;
                }
                
                reviewHTML += `</div></div>`;
            });
            
            reviewContent.innerHTML = reviewHTML;
            
            // Aktualizovat MathJax, pokud je potřeba
            if (window.MathJax) {
                MathJax.typeset();
            }
        }

        /**
         * Nastaví globální posluchače událostí.
         */
        function setupCommonEventListeners() {
            // Mobilní menu
            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', () => {
                    sidebar?.classList.toggle('active');
                    sidebarOverlay?.classList.toggle('active');
                });
            }
            
            // Overlay pro mobilní menu
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    sidebar?.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                });
            }
            
            // Výběr typu testu
            document.querySelectorAll('.test-type-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.test-type-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedTestType = card.dataset.testType;
                });
            });
            
            // Tlačítka výběru testu
            document.querySelectorAll('.select-test-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedTestType = btn.dataset.testType;
                    startSelectedTest();
                });
            });
            
            // Navigační tlačítka testu
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentQuestionIndex > 0) {
                        showQuestion(currentQuestionIndex - 1);
                    }
                });
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (currentQuestionIndex < questions.length - 1) {
                        showQuestion(currentQuestionIndex + 1);
                    }
                });
            }
            
            if (finishBtn) {
                finishBtn.addEventListener('click', () => {
                    // Confirmation dialog before finishing
                    const answeredCount = userAnswers.filter(a => a !== null).length;
                    const unansweredCount = questions.length - answeredCount;
                    
                    let confirmMessage = `Dokončit test?`;
                    if (unansweredCount > 0) {
                        confirmMessage = `Máte ${unansweredCount} nezodpovězených otázek. Opravdu chcete test dokončit?`;
                    }
                    
                    if (confirm(confirmMessage)) {
                        finishTest();
                    }
                });
            }
            
            // Tlačítka výsledků
            if (reviewAnswersBtn) {
                reviewAnswersBtn.addEventListener('click', displayReview);
            }
            
            if (backToResultsBtn) {
                backToResultsBtn.addEventListener('click', () => {
                    reviewContainer.style.display = 'none';
                    resultsContainer.style.display = 'block';
                });
            }
            
            if (retryBtn) {
                retryBtn.addEventListener('click', () => {
                    if (confirm('Opravdu chcete začít znovu? Váš současný postup bude ztracen.')) {
                        testSelector.style.display = 'block';
                        resultsContainer.style.display = 'none';
                        reviewContainer.style.display = 'none';
                        testLevel.textContent = 'Výběr testu';
                        history.pushState({ state: 'testSelection' }, document.title, window.location.href);
                        
                        // Reset proměnných
                        selectedTestType = null;
                        questions = [];
                        userAnswers = [];
                        currentQuestionIndex = 0;
                        document.querySelectorAll('.test-type-card').forEach(c => c.classList.remove('selected'));
                    }
                });
            }
            
            // Tlačítko na pokračování k plánu (přesměrování)
            if (continueBtn) {
                continueBtn.addEventListener('click', () => {
                    window.location.href = `/dashboard/plan/plan.html${diagnosticId ? `?diagnosticId=${diagnosticId}` : ''}`;
                });
            }
            
            // Responzivní chování
            window.addEventListener('resize', () => {
                if (window.innerWidth > 576 && sidebar?.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    sidebarOverlay?.classList.remove('active');
                }
            });
        }

        /**
         * Zpracovává tlačítko "Zpět" v prohlížeči.
         * @param {PopStateEvent} event Událost navigace
         */
        function handleBackButton(event) {
            const state = event.state ? event.state.state : null;
            const testIsRunning = testContainer && testContainer.style.display === 'block';
            const resultsAreShown = resultsContainer && resultsContainer.style.display === 'block';
            const reviewIsShown = reviewContainer && reviewContainer.style.display === 'block';
            
            console.log("Navigace zpět - stav:", state);
            
            if (reviewIsShown) {
                // Z review na results
                reviewContainer.style.display = 'none';
                if (resultsContainer) resultsContainer.style.display = 'block';
                
                history.pushState({ state: 'testFinished', saved: history.state?.saved }, document.title, window.location.href);
                return;
            } else if (state === 'testFinished' && resultsAreShown) {
                // Zůstáváme na výsledcích
                history.pushState({ state: 'testFinished', saved: history.state?.saved }, document.title, window.location.href);
                return;
            } else if (testIsRunning) {
                // If test is running, confirm exit
                if (!confirm('Opustit test? Postup nebude uložen.')) {
                    history.pushState({ state: 'testInProgress' }, document.title, window.location.href); // Stay in test state
                } else {
                    stopTimer();
                    // Go back to selection
                    if (testContainer) testContainer.style.display = 'none';
                    if (testLoader) testLoader.style.display = 'none';
                    if (testSelector) testSelector.style.display = 'block';
                    if (testTimer) testTimer.style.display = 'none';
                    if (testLevel) testLevel.textContent = 'Výběr testu';
                    history.replaceState({ state: 'testSelection' }, document.title, window.location.href);
                }
            } else if (resultsAreShown) {
                // If results are shown, go back to selection
                if(resultsContainer) resultsContainer.style.display = 'none';
                if (testSelector) testSelector.style.display = 'block';
                if(testLevel) testLevel.textContent = 'Výběr testu';
                history.replaceState({ state: 'testSelection' }, document.title, window.location.href);
            } else {
                console.log("Navigace zpět (výchozí chování nebo výběr testu).");
                if(testSelector) testSelector.style.display = 'block';
                if(testContainer) testContainer.style.display = 'none';
                if(resultsContainer) resultsContainer.style.display = 'none';
                if(reviewContainer) reviewContainer.style.display = 'none';
            }
        }

        // Generování demo otázek (pro případ, že nejsou v DB)
        function generateDemoQuestions(count) {
            const demoQuestions = [
                {
                    id: 'demo1',
                    question_number: 1,
                    question_type: 'multiple_choice',
                    question_text: 'Které z následujících čísel je největší?',
                    options: ['12.5', '12,45', '12.45', '12.54'],
                    correct_answer: 'D',
                    solution_explanation: 'Stačí porovnat čísla: 12.5 = 12.50 < 12.45 < 12.54',
                    difficulty: 2,
                    topic: 'Aritmetika'
                },
                {
                    id: 'demo2',
                    question_number: 2,
                    question_type: 'numeric',
                    question_text: 'Vypočtěte: $2^3 + 3^2$',
                    correct_answer: '17',
                    solution_explanation: '2^3 = 8, 3^2 = 9, 8 + 9 = 17',
                    difficulty: 2,
                    topic: 'Algebra'
                },
                {
                    id: 'demo3',
                    question_number: 3,
                    question_type: 'construction',
                    question_text: 'Popište postup řešení rovnice: $3x + 5 = 2$',
                    correct_answer: 'x = -1',
                    solution_explanation: '1. Odečteme 5 od obou stran: 3x = -3\n2. Vydělíme obě strany 3: x = -1',
                    difficulty: 3,
                    topic: 'Algebra'
                },
                {
                    id: 'demo4',
                    question_number: 4,
                    question_type: 'numeric',
                    question_text: 'Vypočtěte obvod čtverce, jehož obsah je 36 cm².',
                    correct_answer: '24',
                    solution_explanation: 'Obsah čtverce = a², kde a je délka strany.\nTedy a² = 36 => a = 6 cm.\nObvod čtverce = 4a = 4 · 6 = 24 cm.',
                    difficulty: 3,
                    topic: 'Geometrie'
                },
                {
                    id: 'demo5',
                    question_number: 5,
                    question_type: 'multiple_choice',
                    question_text: 'Zjednodušte výraz: $\\frac{x^2 - 4}{x - 2}$ pro $x \\neq 2$',
                    options: ['$x - 2$', '$x + 2$', '$x^2 - 2$', '$\\frac{x - 2}{x + 2}$'],
                    correct_answer: 'B',
                    solution_explanation: '$\\frac{x^2 - 4}{x - 2} = \\frac{(x - 2)(x + 2)}{x - 2} = x + 2$ pro $x \\neq 2$',
                    difficulty: 4,
                    topic: 'Algebra'
                }
            ];
            
            // Vygenerujeme další otázky, pokud je potřeba
            while (demoQuestions.length < count) {
                const index = demoQuestions.length + 1;
                demoQuestions.push({
                    id: `demo${index}`,
                    question_number: index,
                    question_type: index % 3 === 0 ? 'construction' : (index % 3 === 1 ? 'multiple_choice' : 'numeric'),
                    question_text: `Demo otázka ${index}`,
                    options: index % 3 === 1 ? ['Možnost A', 'Možnost B', 'Možnost C', 'Možnost D'] : undefined,
                    correct_answer: index % 3 === 1 ? 'A' : '42',
                    solution_explanation: `Řešení otázky ${index}`,
                    difficulty: (index % 5) + 1,
                    topic: ['Algebra', 'Geometrie', 'Aritmetika', 'Logika', 'Statistika'][index % 5]
                });
            }
            
            return demoQuestions.slice(0, count);
        }

        // Spuštění Aplikace
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>