<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Testování znalostí</title>
    <link rel="icon" href="/favicon.ico" sizes="any"> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <style>
        /* --- CSS STYLES (Zachováno z původní verze) --- */
        /* Základní styly */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        :root { --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9; --success: #06d6a0; --danger: #f72585; --warning: #f8961e; --info: #4895ef; --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d; --gray-light: #dee2e6; --gray-dark: #343a40; --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3); --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee); --gradient-3: linear-gradient(135deg, #f72585, #7209b7); --gradient-4: linear-gradient(135deg, #f8961e, #f3722c); --white: #ffffff; --sidebar-width: 260px; --transition-speed: 0.3s; --card-radius: 16px; --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05); --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.07); --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1); --text-primary: #2d3748; --text-secondary: #4a5568; --text-muted: #718096; }
        body { background-color: #f6f8ff; color: var(--text-primary); min-height: 100vh; display: flex; overflow-x: hidden; margin: 0; padding: 0; }
        #test-selector { display: block; }
        .test-types-container { display: flex; gap: 1.5rem; flex-wrap: wrap; margin-top: 1.5rem; justify-content: center; }
        .test-type-card { background-color: var(--white); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); padding: 1.5rem; flex: 1; min-width: 280px; max-width: 320px; transition: all 0.3s ease; border: 2px solid transparent; cursor: pointer; display: flex; flex-direction: column; }
        .test-type-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--primary-light); }
        .test-type-card.selected { border-color: var(--primary); background-color: rgba(67, 97, 238, 0.05); }
        .test-type-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; position: relative; }
        .test-type-header i { font-size: 2rem; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(67, 97, 238, 0.1); color: var(--primary); }
        .test-type-card:nth-child(2) .test-type-header i { background: rgba(76, 201, 240, 0.1); color: var(--primary-light); }
        .test-type-card:nth-child(3) .test-type-header i { background: rgba(247, 37, 133, 0.1); color: var(--danger); }
        .test-type-header h3 { font-size: 1.4rem; font-weight: 600; margin: 0; }
        .recommended-badge { position: absolute; top: -25px; right: -15px; background: var(--gradient-2); color: white; font-size: 0.75rem; padding: 0.25rem 0.7rem; border-radius: 20px; font-weight: 500; transform: rotate(15deg); }
        .test-type-description { color: var(--text-secondary); margin-bottom: 1.5rem; min-height: 60px; flex-grow: 1; }
        .test-type-features { margin-bottom: 1.5rem; flex-grow: 1; }
        .feature { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem; }
        .feature i { color: var(--success); font-size: 0.9rem; }
        .select-test-btn { width: 100%; display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: auto; }
        @media (max-width: 992px) { .test-types-container { flex-direction: column; align-items: center; } .test-type-card { width: 100%; max-width: 400px; } }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 100; box-shadow: var(--shadow-lg); transition: transform var(--transition-speed) ease, width var(--transition-speed) ease; }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; }
        .sidebar-logo { font-size: 1.5rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo i { font-size: 1.75rem; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .sidebar-item { margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; color: rgba(255, 255, 255, 0.85); text-decoration: none; border-radius: 12px; transition: all 0.2s ease; font-weight: 500; }
        .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; width: 24px; text-align: center; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--white); }
        .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); text-align: center; }
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.1); border-radius: 12px; backdrop-filter: blur(5px); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-weight: 500; overflow: hidden; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15); color: var(--white); }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; }
        .user-name { font-weight: 600; font-size: 0.95rem; }
        .user-role { font-size: 0.8rem; opacity: 0.8; }
        main { flex: 1; margin-left: var(--sidebar-width); padding: 1.5rem 2rem; transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); }
        .dashboard-header { margin-bottom: 2rem; background-color: var(--white); border-radius: var(--card-radius); padding: 1.25rem 1.5rem; box-shadow: var(--shadow-sm); position: relative; }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .header-content h1 { font-size: 1.75rem; font-weight: 600; color: var(--dark); margin-bottom: 0.5rem; }
        .header-meta { display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap; }
        .header-meta-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-secondary); }
        .main-content { display: flex; flex-direction: column; gap: 1.75rem; }
        .section { background-color: var(--white); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); padding: 1.5rem; animation: fadeIn 0.5s ease forwards; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .section:hover { box-shadow: var(--shadow-md); }
        .section-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1.25rem; color: var(--dark); display: flex; align-items: center; gap: 0.75rem; }
        .section-subtitle { font-size: 1.1rem; font-weight: 500; margin-bottom: 1rem; color: var(--dark); }
        .test-container { display: flex; flex-direction: column; gap: 2rem; }
        .test-info { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; padding-bottom: 1rem; border-bottom: 1px solid var(--gray-light); gap: 1rem; }
        .test-title { font-size: 1.25rem; font-weight: 600; color: var(--primary); }
        .test-meta { display: flex; gap: 1.5rem; flex-wrap: wrap; }
        .meta-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-secondary); }
        .test-progress-container { position: relative; width: 100%; height: 8px; background-color: var(--gray-light); border-radius: 4px; margin: 1rem 0; overflow: hidden; }
        .test-progress-bar { position: absolute; top: 0; left: 0; height: 100%; background: var(--gradient-2); border-radius: 4px; transition: width 0.3s ease; }
        .question-container { padding: 1.5rem; border-radius: var(--card-radius); border: 1px solid var(--gray-light); margin-bottom: 1.5rem; transition: transform 0.3s ease, box-shadow 0.3s ease; background-color: #fff; }
        .question-header { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem; }
        .question-number { display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; width: 36px; height: 36px; line-height: 36px; text-align: center; background: var(--gradient-1); color: white; font-weight: 600; border-radius: 50%; }
        .question-text { font-size: 1.15rem; font-weight: 500; line-height: 1.6; flex-grow: 1; }
        .question-text p { margin-bottom: 0.75rem; }
        .question-image-container { margin: 1rem 0; text-align: center; }
        .question-image { max-width: 100%; height: auto; border-radius: 8px; box-shadow: var(--shadow-sm); }
        .answer-options { display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem; }
        .answer-option { display: flex; align-items: flex-start; padding: 1rem; border-radius: 8px; border: 1px solid var(--gray-light); cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; background-color: #fff; }
        .answer-option:hover { background-color: rgba(67, 97, 238, 0.05); border-color: var(--primary-light); transform: translateY(-2px); }
        .answer-option.selected { background-color: rgba(67, 97, 238, 0.1); border-color: var(--primary); box-shadow: 0 4px 10px rgba(67, 97, 238, 0.15); }
        .answer-option::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 4px; background: transparent; transition: background 0.3s ease; }
        .answer-option.selected::before { background: var(--primary); }
        .answer-option input[type="radio"] { margin-right: 1rem; margin-top: 0.15em; flex-shrink: 0; transform: scale(1.2); cursor: pointer; }
        .answer-text { flex: 1; line-height: 1.5; }
        .answer-letter { font-weight: 600; margin-right: 0.5em; color: var(--primary); }
        .answer-input-container { margin-top: 1.5rem; }
        .answer-input-container label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        .answer-input { width: 100%; padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--gray-light); font-size: 1rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .answer-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15); }
        .construction-container { margin-top: 1.5rem; }
        .solution-explanation { background-color: #f9f9ff; padding: 1rem 1.5rem; border-radius: 8px; border: 1px solid var(--gray-light); margin-bottom: 1.5rem; color: var(--text-secondary); }
        .solution-explanation h4 { margin-top: 0; margin-bottom: 0.75rem; font-weight: 600; color: var(--dark); }
        .construction-textarea { width: 100%; min-height: 100px; padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--gray-light); font-size: 1rem; resize: vertical; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .construction-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15); }
        .question-navigation { display: flex; justify-content: space-between; margin-top: 2rem; gap: 1rem; }
        .pagination { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; margin: 1.5rem 0; padding: 0.5rem; background-color: #fff; border-radius: 12px; box-shadow: var(--shadow-sm); }
        .page-item { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: var(--light); color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; font-weight: 500; border: 1px solid var(--gray-light); }
        .page-item:hover { background-color: var(--gray-light); color: var(--dark); transform: scale(1.1); }
        .page-item.active { background: var(--gradient-1); color: white; box-shadow: 0 4px 8px rgba(67, 97, 238, 0.2); border-color: transparent; }
        .page-item.answered { background-color: rgba(6, 214, 160, 0.7); color: white; border-color: transparent; }
        .page-item.answered.active { background: var(--gradient-1); box-shadow: 0 0 0 2px var(--success); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 500; font-size: 0.95rem; text-decoration: none; transition: all 0.3s ease; cursor: pointer; border: none; gap: 0.5rem; position: relative; overflow: hidden; z-index: 1; line-height: 1.5; }
        .btn::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 0; background-color: rgba(255, 255, 255, 0.1); transition: height 0.3s ease; z-index: -1; }
        .btn:hover::after { height: 100%; }
        .btn-primary { background: var(--gradient-1); color: white; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.2); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(67, 97, 238, 0.25); }
        .btn-secondary { background-color: var(--light); color: var(--text-secondary); border: 1px solid var(--gray-light); }
        .btn-secondary:hover { background-color: var(--gray-light); color: var(--dark); }
        .btn-success { background: linear-gradient(135deg, var(--success), #04a77e); color: white; box-shadow: 0 4px 10px rgba(6, 214, 160, 0.2); }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(6, 214, 160, 0.25); }
        .btn-info { background: linear-gradient(135deg, var(--info), #3b7cde); color: white; box-shadow: 0 4px 10px rgba(72, 149, 239, 0.2); }
        .btn-info:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(72, 149, 239, 0.25); }
        .btn-lg { padding: 0.75rem 2rem; font-size: 1rem; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn-block { width: 100%; justify-content: center; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn:disabled::after { height: 0; }
        .test-timer { position: absolute; top: 1.25rem; right: 1.5rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; font-weight: 600; color: var(--primary); background-color: rgba(67, 97, 238, 0.1); padding: 0.5rem 1rem; border-radius: 20px; box-shadow: 0 2px 6px rgba(67, 97, 238, 0.1); backdrop-filter: blur(10px); }
        .timer-warning { color: var(--warning) !important; background-color: rgba(248, 150, 30, 0.1) !important; }
        .timer-danger { color: var(--danger) !important; background-color: rgba(247, 37, 133, 0.1) !important; animation: pulse 1s ease-in-out infinite; }
        .test-loader { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem 1rem; text-align: center; }
        .loader-spinner { width: 50px; height: 50px; border: 4px solid rgba(67, 97, 238, 0.1); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; margin-bottom: 1.5rem; }
        .loader-text { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .loader-subtext { font-size: 0.9rem; color: var(--text-muted); }
        .results-container { margin-top: 1.5rem; }
        .result-summary { display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center; background-color: #f9f9ff; border-radius: var(--card-radius); padding: 1.5rem 2rem; margin-bottom: 2rem; border-left: 4px solid var(--primary); position: relative; overflow: hidden; gap: 1.5rem; }
        .result-summary::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at top right, rgba(67, 97, 238, 0.05), transparent 70%); z-index: 0; }
        .result-score { text-align: center; position: relative; z-index: 1; flex-basis: 150px; }
        .score-value { font-size: 3.5rem; font-weight: 700; background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1; }
        .score-label { font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .result-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1.5rem; position: relative; z-index: 1; flex-grow: 1; max-width: 600px; }
        .stat-item { text-align: center; padding: 1rem; border-radius: 12px; background-color: rgba(255, 255, 255, 0.5); backdrop-filter: blur(5px); transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid var(--gray-light); }
        .stat-item:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .stat-value { font-size: 1.75rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary); }
        .stat-label { font-size: 0.85rem; color: var(--text-secondary); }
        .low-score-message { background-color: rgba(248, 150, 30, 0.1); border-left: 4px solid var(--warning); padding: 1.5rem; margin-top: 1.5rem; margin-bottom: 1rem; border-radius: var(--card-radius); text-align: center; color: var(--text-secondary); }
        .low-score-message i { font-size: 1.5rem; color: var(--warning); margin-bottom: 0.75rem; display: block; }
        .low-score-message strong { color: var(--warning); }
        .low-score-message.info { background-color: rgba(67, 97, 238, 0.1); border-left-color: var(--primary-light); }
        .low-score-message.info i { color: var(--primary-light); }
        .low-score-message.info strong { color: var(--primary-light); }
        .result-actions { display: flex; justify-content: center; flex-wrap: wrap; gap: 1.5rem; margin-top: 2.5rem; }
        .topic-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
        .topic-card { background-color: var(--white); border-radius: var(--card-radius); padding: 1.5rem; box-shadow: var(--shadow-sm); transition: all 0.3s ease; border-left: 4px solid var(--primary); position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .topic-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-md); }
        .topic-card.strength { border-left-color: var(--success); }
        .topic-card.weakness { border-left-color: var(--danger); }
        .topic-card.neutral { border-left-color: var(--warning); }
        .topic-header { display: flex; align-items: center; margin-bottom: 1.25rem; gap: 0.75rem; }
        .topic-icon { width: 48px; height: 48px; flex-shrink: 0; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--white); background: var(--gradient-1); font-size: 1.4rem; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.15); }
        .topic-card.strength .topic-icon { background: linear-gradient(135deg, var(--success), #04a77e); box-shadow: 0 4px 10px rgba(6, 214, 160, 0.15); }
        .topic-card.weakness .topic-icon { background: linear-gradient(135deg, #f72585, #b5179e); box-shadow: 0 4px 10px rgba(247, 37, 133, 0.15); }
        .topic-card.neutral .topic-icon { background: linear-gradient(135deg, #f8961e, #f3722c); box-shadow: 0 4px 10px rgba(248, 150, 30, 0.15); }
        .topic-title { font-weight: 600; font-size: 1.2rem; color: var(--dark); flex-grow: 1; }
        .topic-stats { margin-top: auto; padding-top: 1rem; }
        .topic-progress { display: flex; justify-content: space-between; margin-bottom: 0.75rem; font-size: 0.9rem; }
        .topic-progress-label { color: var(--text-secondary); }
        .topic-progress-value { font-weight: 600; color: var(--primary); }
        .topic-card.strength .topic-progress-value { color: var(--success); }
        .topic-card.weakness .topic-progress-value { color: var(--danger); }
        .topic-card.neutral .topic-progress-value { color: var(--warning); }
        .topic-progress-bar { width: 100%; height: 8px; background-color: var(--gray-light); border-radius: 4px; overflow: hidden; position: relative; }
        .topic-progress-fill { height: 100%; background: var(--gradient-1); border-radius: 4px; position: relative; overflow: hidden; transition: width 0.5s ease-out; }
        .topic-progress-fill::after { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent); animation: progressShine 2s infinite; }
        .topic-card.strength .topic-progress-fill { background: linear-gradient(135deg, var(--success), #04a77e); }
        .topic-card.weakness .topic-progress-fill { background: linear-gradient(135deg, #f72585, #b5179e); }
        .topic-card.neutral .topic-progress-fill { background: linear-gradient(135deg, #f8961e, #f3722c); }
        .error-message-container { background-color: rgba(247, 37, 133, 0.1); border-left: 4px solid var(--danger); padding: 1.5rem; margin: 1rem 0; border-radius: var(--card-radius); text-align: center; }
        .error-message-container i { font-size: 2rem; color: var(--danger); margin-bottom: 1rem; display: block; }
        .error-message-container .loader-text { color: var(--danger); font-weight: 600; }
        .error-message-container .loader-subtext { color: var(--text-secondary); }
        .gemini-checking-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1005; color: white; text-align: center; backdrop-filter: blur(5px); }
        .gemini-spinner { width: 60px; height: 60px; border: 5px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: var(--white); animation: spin 1.2s linear infinite; margin-bottom: 1.5rem; }
        .gemini-checking-text { font-size: 1.2rem; font-weight: 500; }
        .review-container { margin-top: 1.5rem; }
        .review-navigation { margin-bottom: 1.5rem; display: flex; justify-content: flex-start; }
        .review-question-item { background-color: var(--white); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); padding: 1.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--primary); }
        .review-question-item.correct { border-left-color: var(--success); background-color: rgba(6, 214, 160, 0.03); }
        .review-question-item.incorrect { border-left-color: var(--danger); background-color: rgba(247, 37, 133, 0.03); }
        .review-question-item.partial { border-left-color: var(--warning); background-color: rgba(248, 150, 30, 0.03); }
        .review-question-item.skipped { border-left-color: var(--gray); background-color: rgba(108, 117, 125, 0.03); }
        .review-question-header { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem; }
        .review-question-number { display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; width: 36px; height: 36px; line-height: 36px; text-align: center; background: var(--gray-dark); color: white; font-weight: 600; border-radius: 50%; }
        .review-question-item.correct .review-question-number { background: var(--success); }
        .review-question-item.incorrect .review-question-number { background: var(--danger); }
        .review-question-item.partial .review-question-number { background: var(--warning); }
        .review-question-item.skipped .review-question-number { background: var(--gray); }
        .review-question-text { font-size: 1.1rem; font-weight: 500; line-height: 1.5; flex-grow: 1; }
        .review-answer-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--gray-light); }
        .review-answer-section h4 { font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--dark); }
        .review-user-answer, .review-correct-answer, .review-solution { margin-bottom: 1rem; padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--gray-light); line-height: 1.5; }
        .review-user-answer strong, .review-correct-answer strong, .review-solution strong { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .review-user-answer { background-color: rgba(72, 149, 239, 0.05); border-color: var(--info); }
        .review-user-answer strong { color: var(--info); }
        .review-correct-answer { background-color: rgba(6, 214, 160, 0.05); border-color: var(--success); }
        .review-correct-answer strong { color: var(--success); }
        .review-solution { background-color: #f9f9ff; }
        .review-solution strong { color: var(--text-secondary); }
        .review-solution pre { background-color: transparent; border: none; padding: 0; margin: 0; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; font-size: 0.95em; }
        .review-solution code { background-color: transparent; padding: 0; }
        .review-score { font-weight: 600; margin-top: 1rem; text-align: right; font-size: 1.1rem; }
        .review-score .correct { color: var(--success); }
        .review-score .incorrect { color: var(--danger); }
        .review-score .partial { color: var(--warning); }
        .review-score .skipped { color: var(--gray); }
        .review-mc-option { display: block; padding: 0.5rem 0; margin-left: 1rem; position: relative; }
        .review-mc-option::before { content: attr(data-letter) ". "; font-weight: bold; position: absolute; left: -1rem; }
        .review-mc-option.user-selected { background-color: rgba(72, 149, 239, 0.1); border-radius: 4px; padding-left: 0.5rem; margin-left: 0.5rem; }
        .review-mc-option.correct-answer { color: var(--success); font-weight: bold; }
        .review-mc-option.user-selected.correct-answer { background-color: rgba(6, 214, 160, 0.1); }
        .review-mc-option.user-selected:not(.correct-answer) { color: var(--danger); background-color: rgba(247, 37, 133, 0.1); }
         /* Toast notification */
         .toast { position: fixed; bottom: 20px; right: 20px; background-color: var(--white); color: var(--text-primary); border-radius: 8px; padding: 1rem; box-shadow: var(--shadow-lg); max-width: 300px; z-index: 1001; display: flex; align-items: center; transform: translateY(120px); opacity: 0; transition: all 0.4s ease-in-out; }
         .toast.show { transform: translateY(0); opacity: 1; }
         .toast.success { border-left: 4px solid #10b981; }
         .toast.error { border-left: 4px solid var(--danger); }
         .toast.warning { border-left: 4px solid var(--warning); }
         .toast i { margin-right: 0.75rem; font-size: 1.25rem; }
         .toast.success i { color: #10b981; }
         .toast.error i { color: var(--danger); }
         .toast.warning i { color: var(--warning); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes progressShine { 0% { left: -100%; } 50% { left: 150%; } 100% { left: 150%; } }
        .animated { animation: fadeIn 0.5s ease forwards; }
        @media (max-width: 992px) { :root { --sidebar-width: 80px; } .sidebar { width: 80px; } .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; } .sidebar-link i { margin-right: 0; font-size: 1.5rem; } .sidebar-logo i { margin-right: 0; } .sidebar-header, .sidebar-link { justify-content: center; } .user-profile { justify-content: center; padding: 0.75rem 0; } .user-avatar { margin-right: 0; } main { margin-left: 80px; width: calc(100% - 80px); } }
        @media (max-width: 768px) { main { padding: 1rem; } .header-content { flex-direction: column; align-items: flex-start; gap: 1rem; } .test-timer { position: static; margin-top: 1rem; align-self: flex-start; } .test-info { flex-direction: column; align-items: flex-start; gap: 1rem; } .test-meta { width: 100%; justify-content: space-between; gap: 1rem; } .result-summary { flex-direction: column; gap: 2rem; text-align: center; padding: 1.5rem; } .result-stats { width: 100%; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; } .result-actions { flex-direction: column; gap: 1rem; } .question-navigation { flex-direction: column; gap: 1rem; } .question-navigation button { width: 100%; } }
        @media (max-width: 576px) { :root { --sidebar-width: 0; } .sidebar { transform: translateX(-100%); z-index: 1000; width: 260px; } .sidebar.active { transform: translateX(0); } .sidebar.active .sidebar-logo span, .sidebar.active .sidebar-link span, .sidebar.active .user-info, .sidebar.active .sidebar-footer { display: block; } .sidebar.active .sidebar-link i { margin-right: 0.75rem; } .sidebar.active .sidebar-header, .sidebar.active .sidebar-link { justify-content: flex-start; } .sidebar.active .user-profile { justify-content: flex-start; padding: 1rem; } .sidebar.active .user-avatar { margin-right: 0.75rem; } main { margin-left: 0; width: 100%; } .mobile-menu-toggle { display: block; } .pagination { gap: 0.35rem; } .page-item { width: 32px; height: 32px; font-size: 0.8rem; } .topic-results { grid-template-columns: 1fr; } .header-content h1 { font-size: 1.5rem; } .score-value { font-size: 3rem; } .stat-value { font-size: 1.5rem; } .result-actions { flex-direction: row; flex-wrap: wrap;} }
        .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; color: var(--dark); font-size: 1.5rem; margin-right: 1rem; padding: 0.5rem; z-index: 1001; }
        .dashboard-header > .header-content > div:first-child { display: flex; align-items: center; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        .sidebar-overlay.active { display: block; opacity: 1; }
        @media (prefers-color-scheme: dark) { :root { --white: #1a202c; --light: #2d3748; --dark: #e2e8f0; --gray-light: #4a5568; --text-primary: #e2e8f0; --text-secondary: #cbd5e0; --text-muted: #a0aec0; --dark-bg: #1e2533; } body { background-color: #171923; } .section, .dashboard-header, .question-container, .answer-option, .page-item, .test-type-card { background-color: var(--dark-bg); border-color: var(--gray-light); } .answer-input, .construction-textarea { background-color: #2d3748; color: var(--text-primary); border-color: var(--gray-light); } .solution-explanation { background-color: #2d3748; border-color: var(--gray-light); } .answer-option { background-color: #21232f; border-color: var(--gray-light); } .answer-option:hover { background-color: var(--light); } .answer-option.selected { background-color: rgba(67, 97, 238, 0.2); border-color: var(--primary); } .result-summary { background-color: #21232f; border-left-color: var(--primary); } .stat-item { background-color: rgba(45, 55, 72, 0.5); border-color: var(--gray-light); } .low-score-message { background-color: rgba(248, 150, 30, 0.15); border-left-color: var(--warning); } .low-score-message.info { background-color: rgba(67, 97, 238, 0.15); border-left-color: var(--primary-light); } .page-item { background-color: var(--light); border-color: var(--gray-light); } .page-item:hover { background-color: var(--gray-light); } .page-item.active { background: var(--gradient-1); border-color: transparent; } .page-item.answered { background-color: rgba(6, 214, 160, 0.5); border-color: transparent; } .page-item.answered.active { box-shadow: 0 0 0 2px var(--success); } .mobile-menu-toggle { color: var(--dark); } .test-type-card.selected { background-color: rgba(67, 97, 238, 0.1); } .review-question-item { background-color: var(--dark-bg); border-color: var(--gray-light); } .review-question-item.correct { background-color: rgba(6, 214, 160, 0.05); } .review-question-item.incorrect { background-color: rgba(247, 37, 133, 0.05); } .review-question-item.partial { background-color: rgba(248, 150, 30, 0.05); } .review-question-item.skipped { background-color: rgba(108, 117, 125, 0.05); } .review-user-answer, .review-correct-answer, .review-solution { border-color: var(--gray-light); } .review-user-answer { background-color: rgba(72, 149, 239, 0.1); border-color: var(--info); } .review-correct-answer { background-color: rgba(6, 214, 160, 0.1); border-color: var(--success); } .review-solution { background-color: var(--light); } .review-solution pre { color: var(--text-secondary); } .review-mc-option.user-selected { background-color: rgba(72, 149, 239, 0.15); } .review-mc-option.correct-answer { color: var(--success); } .review-mc-option.user-selected.correct-answer { background-color: rgba(6, 214, 160, 0.15); } .review-mc-option.user-selected:not(.correct-answer) { color: var(--danger); background-color: rgba(247, 37, 133, 0.15); } .toast { background-color: var(--dark-bg); border-color: var(--gray-light);} }
    </style>
</head>
<body>
    <div class="toast" id="toast"> <i class="fas fa-check-circle"></i> <div id="toast-message">Operace úspěšná.</div> </div>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header"> <a href="/" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
        <ul class="sidebar-menu"> <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Dashboard</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link active"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li> </ul>
        <div class="user-profile"> <div class="user-avatar" id="user-avatar">?</div> <div class="user-info"> <div class="user-name" id="user-name">Načítání...</div> <div class="user-role" id="user-role">Student</div> </div> </div>
        <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main>
        <div class="dashboard-header">
            <div class="header-content"> <div> <button id="mobile-menu-toggle" class="mobile-menu-toggle"> <i class="fas fa-bars"></i> </button> <h1>Testování znalostí</h1> </div> <div class="header-meta"> <div class="header-meta-item"> <i class="fas fa-graduation-cap"></i> <span id="test-subject">Matematika</span> </div> <div class="header-meta-item"> <i class="fas fa-layer-group"></i> <span id="test-level">Výběr testu</span> </div> </div> </div>
            <div id="test-timer" class="test-timer" style="display: none;"> <i class="fas fa-clock"></i> <span id="timer-value">00:00</span> </div>
        </div>
        <div class="main-content">
            <div id="test-selector" class="section">
                 <h2 class="section-title"> <i class="fas fa-tasks"></i> Vyberte typ diagnostického testu </h2>
                 <div class="test-types-container"> <div class="test-type-card" data-test-type="quick"> <div class="test-type-header"><i class="fas fa-bolt"></i><h3>Rychlý test</h3></div> <div class="test-type-description"><p>Základní prověření znalostí z <strong>každého klíčového tématu</strong>. Rychlý přehled vašich silných a slabých stránek.</p></div> <div class="test-type-features"> <div class="feature"><i class="fas fa-check"></i> cca 10 otázek</div> <div class="feature"><i class="fas fa-stopwatch"></i> 10-15 minut</div> <div class="feature"><i class="fas fa-chart-pie"></i> Základní analýza</div> </div> <button class="btn btn-primary select-test-btn"><i class="fas fa-play"></i> Spustit rychlý test</button> </div> <div class="test-type-card" data-test-type="full"> <div class="test-type-header"><i class="fas fa-graduation-cap"></i><h3>Kompletní test</h3><div class="recommended-badge">Doporučeno</div></div> <div class="test-type-description"><p>Podrobné hodnocení <strong>všech oblastí přijímaček</strong>, podobné reálnému testu. Poskytuje solidní základ pro studijní plán.</p></div> <div class="test-type-features"> <div class="feature"><i class="fas fa-check"></i> cca 20 otázek</div> <div class="feature"><i class="fas fa-stopwatch"></i> 25-30 minut</div> <div class="feature"><i class="fas fa-clipboard-list"></i> Detailní zpětná vazba</div> </div> <button class="btn btn-primary select-test-btn"><i class="fas fa-play"></i> Spustit kompletní test</button> </div> <div class="test-type-card" data-test-type="absolute"> <div class="test-type-header"><i class="fas fa-brain"></i><h3>Absolutní test</h3></div> <div class="test-type-description"><p>Nejdůkladnější prověrka. Více otázek na <strong>každé téma</strong>, včetně pokročilejších konceptů. Pro maximálně přesný plán.</p></div> <div class="test-type-features"> <div class="feature"><i class="fas fa-check"></i> cca 30+ otázek</div> <div class="feature"><i class="fas fa-stopwatch"></i> 40-50 minut</div> <div class="feature"><i class="fas fa-microscope"></i> Hloubková analýza</div> </div> <button class="btn btn-primary select-test-btn"><i class="fas fa-play"></i> Spustit absolutní test</button> </div> </div>
            </div>
            <div id="test-loader" class="section" style="display: none;"> <div class="test-loader"> <div class="loader-spinner"></div> <div class="loader-text">Načítání...</div> <div class="loader-subtext" id="loader-subtext">Ověřuji uživatele...</div> </div> </div>
            <div id="test-container" class="section" style="display: none;"> <div class="test-container"> <div class="test-info"> <div class="test-title" id="current-test-title">Diagnostický test</div> <div class="test-meta"> <div class="meta-item"><i class="fas fa-question-circle"></i><span id="question-count">0 / 0</span> otázek</div> <div class="meta-item"><i class="fas fa-check-circle"></i><span id="answered-count">0</span> zodpovězeno</div> </div> </div> <div class="test-progress-container"><div class="test-progress-bar" id="progress-bar" style="width: 0%;"></div></div> <div id="question-container" class="question-container"></div> <div class="question-navigation"> <button id="prev-btn" class="btn btn-secondary" disabled><i class="fas fa-arrow-left"></i> Předchozí</button> <button id="next-btn" class="btn btn-primary">Další <i class="fas fa-arrow-right"></i></button> </div> <div id="pagination" class="pagination"></div> <button id="finish-btn" class="btn btn-success btn-lg btn-block" style="display: none;"><i class="fas fa-check-circle"></i> Dokončit test</button> </div> </div>
            <div id="results-container" class="section" style="display: none;"> <h2 class="section-title"><i class="fas fa-award"></i> Výsledky testu</h2> <div class="results-container"> <div class="result-summary"> <div class="result-score"><div class="score-value" id="result-score">0/50</div> <div class="score-label">Celkové skóre</div></div> <div class="result-stats"> <div class="stat-item"><div class="stat-value" id="result-percentage">0%</div><div class="stat-label">Úspěšnost (celkem)</div></div> <div class="stat-item"><div class="stat-value" id="result-correct">0</div><div class="stat-label">Správně (>=1 bod)</div></div> <div class="stat-item"><div class="stat-value" id="result-incorrect">0</div><div class="stat-label">Chybně (0 bodů)</div></div> <div class="stat-item"><div class="stat-value" id="result-time">00:00</div><div class="stat-label">Čas</div></div> </div> </div> <div id="low-score-message-container"></div> <h3 class="section-subtitle">Výsledky podle témat</h3> <div id="topic-results" class="topic-results"></div> <div class="result-actions"> <button id="retry-btn" class="btn btn-secondary btn-lg"> <i class="fas fa-redo"></i> Zkusit jiný test</button> <button id="review-answers-btn" class="btn btn-info btn-lg"> <i class="fas fa-search"></i> Zobrazit odpovědi </button> <button id="continue-btn" class="btn btn-success btn-lg" disabled><i class="fas fa-tasks"></i> Přejít na studijní plán</button> </div> </div> </div>
            <div id="review-container" class="section review-container" style="display: none;"> <div class="review-navigation"> <button id="back-to-results-btn" class="btn btn-secondary"> <i class="fas fa-arrow-left"></i> Zpět k výsledkům </button> </div> <h2 class="section-title"><i class="fas fa-clipboard-check"></i> Přehled odpovědí</h2> <div id="review-content"></div> </div>
            <div id="gemini-checking-overlay" class="gemini-checking-overlay" style="display: none;"> <div class="gemini-spinner"></div> <div class="gemini-checking-text">Vyhodnocuji odpovědi...</div> </div>
        </div>
    </main>

    <script>
        // ==============================================
        //          Inicializace Supabase & Gemini
        // ==============================================
        const supabaseUrl = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
        const supabaseOptions = {};
        let supabaseClient = null; // Inicializujeme později
        const GEMINI_API_KEY = 'AIzaSyDQboM6qtC_O2sqqpaKZZffNf2zk6HrhEs'; // <<< VLOŽTE VÁŠ KLÍČ ZDE (nebo použijte bezpečnější metodu)
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

        // DOM Elementy (stejné jako předtím)
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const testSelector = document.getElementById('test-selector');
        const testLoader = document.getElementById('test-loader');
        const loaderSubtext = document.getElementById('loader-subtext');
        const testContainer = document.getElementById('test-container');
        const resultsContainer = document.getElementById('results-container');
        const reviewContainer = document.getElementById('review-container');
        const reviewContent = document.getElementById('review-content');
        const testSubject = document.getElementById('test-subject');
        const testLevel = document.getElementById('test-level');
        const testTimer = document.getElementById('test-timer');
        const timerValue = document.getElementById('timer-value');
        const currentTestTitle = document.getElementById('current-test-title');
        const questionCountEl = document.getElementById('question-count');
        const answeredCountEl = document.getElementById('answered-count');
        const progressBar = document.getElementById('progress-bar');
        const questionContainer = document.getElementById('question-container');
        const pagination = document.getElementById('pagination');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const finishBtn = document.getElementById('finish-btn');
        const resultScoreEl = document.getElementById('result-score');
        const resultPercentageEl = document.getElementById('result-percentage');
        const resultCorrectEl = document.getElementById('result-correct');
        const resultIncorrectEl = document.getElementById('result-incorrect');
        const resultTimeEl = document.getElementById('result-time');
        const topicResultsEl = document.getElementById('topic-results');
        const retryBtn = document.getElementById('retry-btn');
        const reviewAnswersBtn = document.getElementById('review-answers-btn');
        const backToResultsBtn = document.getElementById('back-to-results-btn');
        const continueBtn = document.getElementById('continue-btn');
        const geminiOverlay = document.getElementById('gemini-checking-overlay');
        const lowScoreMessageContainer = document.getElementById('low-score-message-container');

        // Globální Proměnné (stejné)
        let currentUser = null;
        let currentProfile = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = []; // Pole objektů: { question_id, userAnswerValue, topic_id, topic_name, scoreAwarded, maxScore, checked_by }
        let timer = null;
        let testTime = 0;
        let testStartTime = null;
        let testEndTime = null;
        let testResultsData = {
            totalQuestions: 0,
            correctAnswers: 0, // Počet otázek s >= 1 bodem
            incorrectAnswers: 0, // Počet otázek s 0 body
            unanswered: 0,
            score: 0, // Skóre 0-50
            totalPointsAchieved: 0, // Surový počet získaných bodů
            totalMaxPossiblePoints: 0, // Surový maximální počet bodů
            percentage: 0, // Úspěšnost % (correctAnswers / totalQuestions)
            timeSpent: 0,
            topicResults: {} // Objekt s výsledky podle témat
        };
        let diagnosticId = null; // UUID uložené diagnostiky
        let selectedTestType = null;

        // Konfigurace (stejné)
        const testTypeConfig = {
            quick: { questionsCount: 10, title: 'Rychlý diagnostický test', description: 'Základní prověření', multiplier: 1.0 },
            full: { questionsCount: 20, title: 'Kompletní diagnostický test', description: 'Podrobné hodnocení', multiplier: 1.5 },
            absolute: { questionsCount: 30, title: 'Absolutní test znalostí', description: 'Důkladná prověrka', multiplier: 2.0 }
        };
        const topicIcons = {
            "Algebra": "fa-square-root-alt", "Aritmetika": "fa-calculator",
            "Geometrie": "fa-draw-polygon", "Logika": "fa-brain",
            "Logické úlohy": "fa-brain", "Statistika": "fa-chart-bar",
            "Čísla a aritmetické operace": "fa-calculator", "Práce s daty": "fa-chart-bar",
            "Problémové úlohy": "fa-lightbulb", "Proporce a procenta": "fa-percentage",
            "default": "fa-book"
        };
        const SCORE_THRESHOLD_FOR_SAVING = 5; // Prahová hodnota pro uložení výsledků (v bodech /50)
        const NUMERIC_TOLERANCE = 0.01; // Tolerance pro porovnávání čísel

        // --- Pomocné Funkce (beze změny) ---
        function shuffleArray(array) { /* ... */ for (let ci = array.length - 1; ci > 0; ci--) { const ri = Math.floor(Math.random() * (ci + 1));[array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function formatTime(seconds) { /* ... */ const m = Math.floor(seconds / 60); const s = Math.round(seconds % 60); return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; }
        function showErrorMessage(message) { /* ... */ if (testSelector) testSelector.style.display = 'none'; if (testContainer) testContainer.style.display = 'none'; if (resultsContainer) resultsContainer.style.display = 'none'; if (reviewContainer) reviewContainer.style.display = 'none'; if (geminiOverlay) geminiOverlay.style.display = 'none'; if (testLoader) { testLoader.style.display = 'block'; testLoader.innerHTML = `<div class="test-loader error-message-container"><i class="fas fa-exclamation-triangle"></i><div class="loader-text">Chyba!</div><div class="loader-subtext">${sanitizeHTML(message)}</div><button class="btn btn-primary" style="margin-top:1.5rem;" onclick="location.reload()"><i class="fas fa-redo"></i> Zkusit znovu</button></div>`; } }
        function showGeminiOverlay(show) { /* ... */ if (geminiOverlay) geminiOverlay.style.display = show ? 'flex' : 'none'; }
        function indexToLetter(index) { /* ... */ return String.fromCharCode(65 + index); }
        function sanitizeHTML(str) { /* ... */ if (str === null || str === undefined) return ''; const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; }
        function getInitials(profileData) { /* ... */ if (!profileData) return 'U'; const first = profileData.first_name?.[0] || ''; const last = profileData.last_name?.[0] || ''; const usernameInitial = profileData.username?.[0] || ''; const emailInitial = profileData.email?.[0] || ''; return (first + last).toUpperCase() || usernameInitial.toUpperCase() || emailInitial.toUpperCase() || 'U'; }
        function showToast(message, type = 'success', duration = 4000) { /* ... */ const toast = document.getElementById('toast'); const toastMessage = document.getElementById('toast-message'); if (!toast || !toastMessage) return; toastMessage.textContent = message; const icon = toast.querySelector('i'); icon.className = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-circle' : type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle'; toast.className = 'toast ' + type; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, duration); }


        // --- ИСПРАВЛЕННЫЕ Porovnávací Funkce (pro Fallback) ---
        /**
         * Porovná dvě hodnoty jako čísla s tolerancí a normalizací.
         * @param {string|number|null} val1
         * @param {string|number|null} val2
         * @param {number} tolerance - Povolená absolutní odchylka.
         * @returns {boolean|null} True pro shodu, False pro neshodu, Null pro nemožnost porovnat.
         */
        function compareNumericAdvanced(val1, val2, tolerance = NUMERIC_TOLERANCE) {
            if (val1 === null || val1 === undefined || val2 === null || val2 === undefined) return null;

            const normalize = (v) => {
                if (typeof v === 'number') return v;
                if (typeof v !== 'string') return NaN;
                // Убираем пробелы, заменяем запятую на точку, удаляем валюту/проценты
                let str = String(v).trim().replace(',', '.').replace(/\s+/g, '').replace(/kč|czk|%/gi, '').trim();
                if (str === '') return NaN; // Handle empty strings after normalization

                // Zlomek: 3/2, -1/4
                // ИСПРАВЛЕНО: убрана некорректная и избыточная проверка str.match()
                if (str.includes('/') && !str.startsWith('.') && !str.endsWith('.')) {
                    const parts = str.split('/');
                    if (parts.length === 2) {
                        const num = parseFloat(parts[0]);
                        const den = parseFloat(parts[1]);
                        // Проверяем, что числитель и знаменатель - числа, и знаменатель не 0
                        if (!isNaN(num) && !isNaN(den) && den !== 0) return num / den;
                    }
                }

                // Smíšené číslo: 1 1/2, -2 3/4 (простая проверка)
                const mixedMatch = str.match(/^(-?\d+)\s+(\d+)\/(\d+)$/);
                if (mixedMatch) {
                    const whole = parseFloat(mixedMatch[1]);
                    const num = parseFloat(mixedMatch[2]);
                    const den = parseFloat(mixedMatch[3]);
                    if (!isNaN(whole) && !isNaN(num) && !isNaN(den) && den !== 0) {
                        // Учитываем знак целой части
                        return whole + (num / den) * (whole < 0 ? -1 : 1);
                    }
                }

                // Běžné číslo (включая десятичные)
                return parseFloat(str); // parseFloat сам обработает десятичные числа
            };

            const num1 = normalize(val1);
            const num2 = normalize(val2);

            // console.log(`[compareNumeric] Comparing normalized: '${val1}' -> ${num1} vs '${val2}' -> ${num2}`);

            if (isNaN(num1) || isNaN(num2)) {
                // Если числовое сравнение не удалось, пробуем текстовое на всякий случай
                if (typeof val1 === 'string' && typeof val2 === 'string') {
                    // Добавим более строгую текстовую нормализацию перед сравнением
                    const normText1 = String(val1).trim().toLowerCase().replace(/\s+/g, '');
                    const normText2 = String(val2).trim().toLowerCase().replace(/\s+/g, '');
                    if (normText1 === normText2) {
                        console.log("[compareNumeric] Fallback to text comparison: Match.");
                        return true;
                    }
                }
                console.log("[compareNumeric] Cannot compare numerically (NaN) or textually.");
                return null; // Возвращаем null, если сравнить не удалось
            }

            // Сравниваем абсолютную разницу с допуском
            const areEquivalent = Math.abs(num1 - num2) < tolerance;
            // console.log(`[compareNumeric] Result (tolerance ${tolerance}): ${areEquivalent}`);
            return areEquivalent;
        }

        /**
         * Porovná dvě textové hodnoty s normalizací (case, trim, Ano/Ne).
         * @param {string|number|null} val1
         * @param {string|number|null} val2
         * @returns {boolean}
         */
        function compareTextAdvanced(val1, val2) {
            if (val1 === null || val1 === undefined || val2 === null || val2 === undefined) return false;
            const normalize = (v) => {
                let str = String(v).trim().toLowerCase();
                // Normalizace Ano/Ne na "ano" nebo "ne"
                if (str.startsWith('ano')) return 'ano';
                if (str.startsWith('ne')) return 'ne';
                 // Odstranění písmena a tečky/závorky na začátku (pro MC)
                 str = str.replace(/^[a-z][\.\)\s]*=*\s*/, '');
                return str;
            };
            const norm1 = normalize(val1);
            const norm2 = normalize(val2);
            // console.log(`[compareText] Comparing normalized: '${norm1}' vs '${norm2}'`);
            const areEquivalent = norm1 === norm2;
            // console.log(`[compareText] Result: ${areEquivalent}`);
            return areEquivalent;
        }
        // --- КОНЕЦ ИСПРАВЛЕННЫХ ФУНКЦИЙ СРАВНЕНИЯ ---


        // --- Hlavní Logika (načítání, test, navigace - остальное без изменений) ---
        async function getCurrentSupabaseUser() { /* ... */ const { data: { user }, error } = await supabaseClient.auth.getUser(); if (error) { console.error("Chyba získání uživatele:", error); throw new Error("Nepodařilo se získat informace o uživateli."); } return user; }
        async function fetchUserProfile(userId) { /* ... */ if (!userId) return null; try { const { data: profile, error } = await supabaseClient.from('profiles').select('*').eq('id', userId).single(); if (error && error.code !== 'PGRST116') { throw error; } return profile; } catch (error) { console.error("Chyba načtení profilu:", error); return null; } }
        function updateUserInfoUI(profileData, userEmail) { /* ... */ const displayName = `${profileData?.first_name || ''} ${profileData?.last_name || ''}`.trim() || profileData?.username || userEmail?.split('@')[0] || 'Student'; if (userName) userName.textContent = displayName; if (userAvatar) { if (profileData?.avatar_url) { userAvatar.innerHTML = `<img src="${profileData.avatar_url}" alt="Avatar">`; } else { const initials = getInitials(profileData || { email: userEmail }); userAvatar.textContent = initials; } } }
        async function checkExistingDiagnostic(userId) { /* ... */ if (!userId || userId === 'PLACEHOLDER_USER_ID') { console.warn("Kontrola testu přeskočena pro placeholder uživatele."); return false; } try { if (loaderSubtext) loaderSubtext.textContent = 'Kontroluji předchozí testy...'; const { data: existingDiagnostic, error } = await supabaseClient.from('user_diagnostics').select('id, completed_at').eq('user_id', userId).limit(1); if (error) { console.error("Chyba při kontrole existujícího testu:", error); alert("Nepodařilo se ověřit, zda jste již test absolvovali. Pokračuji výběrem testu."); return false; } return existingDiagnostic && existingDiagnostic.length > 0; } catch (err) { console.error("Neočekávaná chyba při kontrole testu:", err); alert("Nastala neočekávaná chyba při kontrole. Pokračuji výběrem testu."); return false; } }
        async function initializeApp() { /* ... */ try { supabaseClient = supabase.createClient(supabaseUrl, supabaseKey, supabaseOptions); if (!supabaseClient) throw new Error("Nepodařilo se inicializovat Supabase."); /* Zbytek logiky */ if (testSelector) testSelector.style.display = 'none'; if (testLoader) testLoader.style.display = 'block'; if (loaderSubtext) loaderSubtext.textContent = 'Ověřuji uživatele...'; currentUser = await getCurrentSupabaseUser(); if (!currentUser) { console.warn("Uživatel není přihlášen. Používám placeholder."); currentUser = { id: 'PLACEHOLDER_USER_ID', email: 'student@example.com' }; currentProfile = { username: 'Testovací Student', email: 'student@example.com', points: 0 }; updateUserInfoUI(currentProfile, currentUser.email); } else { currentProfile = await fetchUserProfile(currentUser.id); updateUserInfoUI(currentProfile, currentUser.email); } const hasCompletedTest = await checkExistingDiagnostic(currentUser.id); if (hasCompletedTest) { if (testSelector) { testSelector.innerHTML = `<div class="section animated"><h2 class="section-title"><i class="fas fa-check-circle" style="color: var(--success);"></i> Test již dokončen</h2><p>Tento diagnostický test jste již absolvoval/a.</p><p><strong>Tento test nelze opakovat.</strong></p><div style="margin-top:1.5rem; display:flex; gap:1rem; flex-wrap:wrap;"><a href="plan.html" class="btn btn-primary"><i class="fas fa-tasks"></i> Zobrazit plán</a><a href="main.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Zpět</a></div></div>`; testSelector.style.display = 'block'; } if (testLoader) testLoader.style.display = 'none'; if (testContainer) testContainer.style.display = 'none'; if (resultsContainer) resultsContainer.style.display = 'none'; if (reviewContainer) reviewContainer.style.display = 'none'; if (testTimer) testTimer.style.display = 'none'; if (testLevel) testLevel.textContent = 'Test dokončen'; return; } if (testSelector) testSelector.style.display = 'block'; if (testLoader) testLoader.style.display = 'none'; if (testContainer) testContainer.style.display = 'none'; if (resultsContainer) resultsContainer.style.display = 'none'; if (reviewContainer) reviewContainer.style.display = 'none'; if (testTimer) testTimer.style.display = 'none'; if (testLevel) testLevel.textContent = 'Výběr testu'; document.querySelectorAll('.test-type-card').forEach(card => { card.addEventListener('click', function (event) { const testType = this.getAttribute('data-test-type'); const isButtonClicked = event.target.closest('.select-test-btn'); document.querySelectorAll('.test-type-card').forEach(c => c.classList.remove('selected')); this.classList.add('selected'); selectedTestType = testType; if (isButtonClicked) { event.stopPropagation(); startSelectedTest(); } }); }); document.querySelectorAll('.select-test-btn').forEach(button => { button.addEventListener('click', function (event) { event.stopPropagation(); const testType = this.closest('.test-type-card').getAttribute('data-test-type'); document.querySelectorAll('.test-type-card').forEach(c => c.classList.remove('selected')); this.closest('.test-type-card').classList.add('selected'); selectedTestType = testType; startSelectedTest(); }); }); setupCommonEventListeners(); history.pushState({ state: 'testSelection' }, document.title, window.location.href); window.addEventListener('popstate', handleBackButton); } catch (error) { console.error('Chyba při inicializaci aplikace:', error); showErrorMessage('Nepodařilo se inicializovat aplikaci: ' + error.message); } }
        function startSelectedTest() { /* ... */ if (!selectedTestType) { alert('Vyberte typ testu.'); return; } const config = testTypeConfig[selectedTestType]; if (!config) { showErrorMessage(`Neznámý typ testu: ${selectedTestType}`); return; } currentTestTitle.textContent = config.title; testLevel.textContent = config.description; testSelector.style.display = 'none'; testLoader.style.display = 'block'; if (loaderSubtext) loaderSubtext.textContent = 'Načítám otázky...'; testContainer.style.display = 'none'; resultsContainer.style.display = 'none'; reviewContainer.style.display = 'none'; testTimer.style.display = 'flex'; history.pushState({ state: 'testInProgress' }, document.title, window.location.href); loadTestQuestions(selectedTestType); }
        async function loadTestQuestions(testType) { /* ... */ try { const config = testTypeConfig[testType]; const questionCount = config.questionsCount; const { data: allQuestions, error: fetchError } = await supabaseClient.from('exam_questions').select('*, topic:topic_id(name), subtopic:subtopic_id(name)'); if (fetchError) throw fetchError; if (!allQuestions || allQuestions.length === 0) throw new Error("V databázi nejsou žádné otázky."); const shuffledQuestions = shuffleArray(allQuestions); const selectedQuestions = shuffledQuestions.slice(0, questionCount); questions = selectedQuestions.map((q, index) => ({ id: q.id, question_number: index + 1, question_text: q.question_text, question_type: q.question_type, options: q.options, correct_answer: q.correct_answer, solution_explanation: q.solution_explanation || "Oficiální postup není k dispozici.", topic: q.topic ? q.topic.name : "Neznámé téma", topic_id: q.topic_id, subtopic: q.subtopic ? q.subtopic.name : "", difficulty: q.difficulty, image_url: q.image_url })); console.log("Vybrané otázky:", questions); if (questions.length === 0) throw new Error("Nepodařilo se vybrat žádné otázky."); initializeTest(); } catch (error) { console.error('Chyba při načítání otázek:', error); showErrorMessage(`Nepodařilo se načíst otázky: ${error.message}`); } }
        function initializeTest() { /* ... */ testLoader.style.display = 'none'; testContainer.style.display = 'block'; resultsContainer.style.display = 'none'; reviewContainer.style.display = 'none'; testTimer.style.display = 'flex'; currentQuestionIndex = 0; userAnswers = new Array(questions.length).fill(null); testTime = 0; timerValue.textContent = formatTime(testTime); answeredCountEl.textContent = '0'; lowScoreMessageContainer.innerHTML = ''; createPagination(); startTimer(); showQuestion(0); updateProgressBar(); updateNavigationButtons(); }
        function showQuestion(index) { /* ... */ if (index < 0 || index >= questions.length) return; const question = questions[index]; console.log(`Zobrazuji Q#${index + 1}`, question); currentQuestionIndex = index; questionCountEl.textContent = `${index + 1} / ${questions.length}`; let questionHTML = `<div class="question-header"><span class="question-number">${question.question_number}</span><div class="question-text">${marked.parse(question.question_text || '')}</div></div>`; if (question.image_url) { questionHTML += `<div class="question-image-container"><img class="question-image" src="${question.image_url}" alt="Obrázek k otázce ${question.question_number}" loading="lazy"></div>`; } const userAnswerData = userAnswers[index]; const savedValue = userAnswerData ? userAnswerData.userAnswerValue : ''; switch (question.question_type) { case 'multiple_choice': questionHTML += `<div class="answer-options">`; const optionsData = question.options; if (!Array.isArray(optionsData)) { console.error("Options nejsou pole pro MC:", question.id, optionsData); questionHTML += `<div style='color:red;font-weight:bold;'>Chyba: Formát možností není pole stringů.</div>`; } else if (optionsData.length === 0) { console.warn("Chybí možnosti pro MC:", question.id); questionHTML += `<div style='color:orange;'>Varování: Chybí možnosti odpovědí.</div>`; } else { optionsData.forEach((optionText, idx) => { const optionLetter = indexToLetter(idx); const isSelected = savedValue === optionLetter; const displayText = (typeof optionText === 'string' || typeof optionText === 'number') ? marked.parseInline(String(optionText)) : `(neplatný text ${idx + 1})`; questionHTML += `<label class="answer-option ${isSelected ? 'selected' : ''}" data-option-id="${optionLetter}"><input type="radio" name="question_${question.id || index}" value="${optionLetter}" ${isSelected ? 'checked' : ''}><div class="answer-text"><span class="answer-letter">${optionLetter}.</span> ${displayText}</div></label>`; }); } questionHTML += `</div>`; break; case 'construction': questionHTML += `<div class="construction-container"><div class="answer-input-container"><label for="construction-answer-${index}">Popište svůj postup:</label><textarea id="construction-answer-${index}" class="construction-textarea" placeholder="Podrobně popište kroky...">${sanitizeHTML(savedValue)}</textarea></div></div>`; break; default: let inputType = "text"; if (question.question_type === 'numeric') { inputType = "text"; // Použijeme text, abychom zvládli čárky/tečky/zlomky } questionHTML += `<div class="answer-input-container"><label for="text-answer-${index}">Vaše odpověď:</label><input type="${inputType}" id="text-answer-${index}" class="answer-input" placeholder="Zadejte odpověď" value="${sanitizeHTML(savedValue)}"></div>`; break; } questionContainer.innerHTML = questionHTML; const textInput = questionContainer.querySelector(`#text-answer-${index}`); const constructionInput = questionContainer.querySelector(`#construction-answer-${index}`); if (textInput) { textInput.addEventListener('input', (event) => { saveAnswer(index, event.target.value); }); } if (constructionInput) { constructionInput.addEventListener('input', (event) => { saveAnswer(index, event.target.value); }); } questionContainer.querySelectorAll('.answer-option').forEach(label => { label.addEventListener('click', handleAnswerSelection); const radio = label.querySelector('input[type="radio"]'); if (radio && label.classList.contains('selected')) { radio.checked = true; } }); updatePagination(); updateNavigationButtons(); if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') { try { setTimeout(() => window.MathJax.typesetPromise([questionContainer]).catch(e => console.error("MathJax chyba:", e)), 0); } catch (e) { console.error("MathJax init chyba:", e); } } const img = questionContainer.querySelector('.question-image'); if (img) { img.loading = 'lazy'; } }
        function handleAnswerSelection(event) { /* ... */ const selectedLabel = event.currentTarget; const qIndex = currentQuestionIndex; const optionId = selectedLabel.dataset.optionId; const radio = selectedLabel.querySelector('input[type="radio"]'); questionContainer.querySelectorAll('.answer-option').forEach(label => { label.classList.remove('selected'); label.querySelector('input[type="radio"]').checked = false; }); selectedLabel.classList.add('selected'); if (radio) radio.checked = true; saveAnswer(qIndex, optionId); }
        function saveAnswer(qIndex, userAnswerValue) { /* ... */ const question = questions[qIndex]; if (!question) return; const wasAnsweredBefore = userAnswers[qIndex] !== null; const isEmptyAnswer = typeof userAnswerValue === 'string' && userAnswerValue.trim() === ''; // Určení maxScore na základě obtížnosti nebo typu
 let maxScore = 1; const difficultyInt = parseInt(question.difficulty); if (question.question_type === 'construction') { maxScore = 2; } else if (!isNaN(difficultyInt)) { if (difficultyInt >= 4) { maxScore = 3; } else if (difficultyInt === 3) { maxScore = 2; } } if (!isEmptyAnswer) { userAnswers[qIndex] = { question_id: question.id, userAnswerValue: userAnswerValue, topic_id: question.topic_id, topic_name: question.topic, scoreAwarded: null, // Bude vyplněno při vyhodnocení
 maxScore: maxScore, checked_by: null // Bude 'gemini_scored', 'fallback_scored', 'skipped', 'error'
 }; } else { userAnswers[qIndex] = null; } const isAnsweredNow = userAnswers[qIndex] !== null; if (wasAnsweredBefore !== isAnsweredNow) { const answeredCount = userAnswers.filter(a => a !== null).length; answeredCountEl.textContent = answeredCount; updateProgressBar(); updatePagination(); } console.log(`Odpověď uložena Q#${qIndex + 1} (Obtížnost: ${question.difficulty}, Max bodů: ${maxScore}):`, userAnswers[qIndex]); }
        function createPagination() { /* ... */ pagination.innerHTML = questions.map((_, i) => `<div class="page-item" data-question="${i}">${i + 1}</div>`).join(''); pagination.querySelectorAll('.page-item').forEach(item => { item.addEventListener('click', () => { showQuestion(parseInt(item.dataset.question)); }); }); updatePagination(); }
        function updatePagination() { /* ... */ pagination.querySelectorAll('.page-item').forEach((item, index) => { item.classList.remove('active', 'answered'); if (index === currentQuestionIndex) item.classList.add('active'); if (userAnswers[index] !== null) item.classList.add('answered'); }); }
        function updateNavigationButtons() { /* ... */ prevBtn.disabled = currentQuestionIndex === 0; nextBtn.disabled = currentQuestionIndex === questions.length - 1; finishBtn.style.display = currentQuestionIndex === questions.length - 1 ? 'flex' : 'none'; if (finishBtn.style.display === 'flex') { finishBtn.disabled = false; finishBtn.innerHTML = '<i class="fas fa-check-circle"></i> Dokončit test'; } }
        function updateProgressBar() { /* ... */ const answeredCount = userAnswers.filter(a => a !== null).length; const progress = (answeredCount / questions.length) * 100; progressBar.style.width = `${progress}%`; }
        function startTimer() { /* ... */ if (timer) clearInterval(timer); testStartTime = new Date(); testTime = 0; timerValue.textContent = formatTime(testTime); testTimer.classList.remove('timer-warning', 'timer-danger'); timer = setInterval(() => { testTime++; timerValue.textContent = formatTime(testTime); const config = testTypeConfig[selectedTestType]; if (!config) return; const estimatedTime = config.questionsCount * 1.5 * 60; // 90s per question avg
 const warningTime = estimatedTime * 0.8; const dangerTime = estimatedTime; if (testTime > dangerTime) { testTimer.classList.add('timer-danger'); testTimer.classList.remove('timer-warning'); } else if (testTime > warningTime) { testTimer.classList.add('timer-warning'); testTimer.classList.remove('timer-danger'); } }, 1000); }
        function stopTimer() { /* ... */ clearInterval(timer); timer = null; testEndTime = new Date(); }

        // ==============================================
        //          Odpověď a Vyhodnocení (PŘEPRACOVÁNO)
        // ==============================================

        /**
         * Vyhodnotí odpověď uživatele pomocí Gemini API nebo fallback logiky.
         * @param {object} question - Objekt otázky.
         * @param {string|null} userAnswer - Odpověď uživatele.
         * @param {number} maxScore - Maximální možný počet bodů za otázku.
         * @returns {Promise<{score: number, checked_by: string}>} - Objekt obsahující získané skóre a metodu kontroly.
         */
        async function checkAnswerWithGemini(question, userAnswer, maxScore) {
            const { question_type, question_text, correct_answer, solution_explanation } = question;
            console.log(`--- Vyhodnocování Q#${question.question_number} (Typ: ${question_type}, Max: ${maxScore}) ---`);
            console.log(`   User Answer: `, userAnswer);
            console.log(`   Correct Answer/Explanation: `, correct_answer || solution_explanation);

            // --- Fallback Logika ---
            const runFallbackCheck = () => {
                console.warn(`   [CHECK] Používám fallback logiku pro Q#${question.question_number}`);
                let fallbackScore = 0;
                try {
                    if (userAnswer === null || String(userAnswer).trim() === "") return { score: 0, checked_by: 'fallback_empty' };

                    // 1. Numerické porovnání (pokud dává smysl)
                    if (['numeric', 'text', 'multiple_choice'].includes(question_type)) { // i MC a text můžou být čísla
                         const numericComparison = compareNumericAdvanced(userAnswer, correct_answer);
                         if (numericComparison === true) {
                             console.log(`      [Fallback] Shoda pomocí compareNumericAdvanced.`);
                             return { score: maxScore, checked_by: 'fallback_numeric' };
                         }
                    }

                    // 2. Textové/Logické porovnání (včetně Ano/Ne, MC písmen)
                    if (compareTextAdvanced(userAnswer, correct_answer)) {
                        console.log(`      [Fallback] Shoda pomocí compareTextAdvanced.`);
                        return { score: maxScore, checked_by: 'fallback_text' };
                    }

                    // 3. Fallback pro konstrukci (velmi základní)
                    if (question_type === 'construction') {
                         fallbackScore = (String(userAnswer).trim().length > 10) ? 1 : 0; // Alespoň 1 bod za snahu, pokud něco napsal
                         console.log(`      [Fallback] Construction - length check -> ${fallbackScore} bod(ů).`);
                         return { score: fallbackScore, checked_by: 'fallback_construction' };
                    }

                    // 4. Pokud nic nesedí
                    console.log(`      [Fallback] Neshoda.`);
                    return { score: 0, checked_by: 'fallback_mismatch' };

                } catch (e) {
                     console.error(`      [Fallback] Chyba při fallback porovnání Q#${question.question_number}:`, e);
                     return { score: 0, checked_by: 'fallback_error' };
                }
            };
            // --- Konec Fallback Logiky ---

             // 1. Handle empty/null answer immediately
             if (userAnswer === null || String(userAnswer).trim() === "") {
                 console.log("   [CHECK] Odpověď je prázdná nebo null. Skóre: 0");
                 return { score: 0, checked_by: 'skipped' }; // Or 'fallback_empty'
             }

            // 2. Kontrola API klíče
            if (!GEMINI_API_KEY || GEMINI_API_KEY.startsWith('YOUR_') || GEMINI_API_KEY.length < 10) {
                 console.warn("   [CHECK] Chybí platný Gemini API klíč. Používám fallback.");
                 return runFallbackCheck();
            }

            // 3. Sestavení PROMPTU pro Gemini
            let prompt = `Jsi expertní AI hodnotící odpovědi na otázky z PŘIJÍMACÍCH ZKOUŠEK z matematiky/logiky v ČR (9. třída ZŠ). Tvým úkolem je PŘÍSNĚ a OBJEKTIVNĚ posoudit odpověď studenta v kontextu zadané otázky a správného řešení. Odpovídej POUZE JSON objektem ve formátu {"score": number, "reason": "stručné zdůvodnění proč"}. Žádný další text mimo JSON!\n\n`;
            prompt += `OTÁZKA:\n"""\n${question_text}\n"""\n\n`;
            prompt += `TYP OTÁZKY: ${question_type}\n`;
            prompt += `MAXIMÁLNÍ SKÓRE: ${maxScore}\n\n`;

            if (question_type === 'multiple_choice' && question.options) {
                prompt += `MOŽNOSTI:\n${question.options.map((opt, i) => `${indexToLetter(i)}. ${opt}`).join('\n')}\n\n`;
                prompt += `SPRÁVNÁ ODPOVĚĎ (Písmeno): ${String(correct_answer).trim().toUpperCase().charAt(0)}\n`;
            } else if (question_type === 'construction') {
                prompt += `OČEKÁVANÝ POSTUP / ŘEŠENÍ:\n"""\n${solution_explanation}\n"""\n\n`;
            } else {
                prompt += `SPRÁVNÁ ODPOVĚĎ:\n"""\n${correct_answer}\n"""\n\n`;
                 if(solution_explanation && solution_explanation.length > 5) { // Přidáme vysvětlení i pro jiné typy, pokud existuje
                     prompt += `VYSVĚTLENÍ/POSTUP (pro kontext):\n"""\n${solution_explanation}\n"""\n\n`;
                 }
            }

            prompt += `ODPOVĚĎ STUDENTA:\n"""\n${userAnswer}\n"""\n\n`;
            prompt += `PRAVIDLA HODNOCENÍ (aplikuj striktně):\n`;

            if (question_type === 'construction') {
                prompt += `1. Identifikuj klíčové kroky v OČEKÁVANÉM POSTUPU.\n`;
                prompt += `2. Posuď, zda popis studenta obsahuje VŠECHNY klíčové kroky ve správném logickém pořadí.\n`;
                prompt += `3. Skóre:\n`;
                prompt += `   - ${maxScore} body: Popis studenta je věcně správný, kompletní (všechny klíčové kroky) a logicky správně seřazený. Drobné formulační odchylky nebo vynechání zjevných detailů (např. "vezmi pravítko") nevadí.\n`;
                 if (maxScore > 1) prompt += `   - 1 bod: Hlavní myšlenka je správná, ALE chybí JEDEN méně podstatný krok NEBO obsahuje JEDNU či DVĚ menší nepřesnosti, které zásadně nemění výsledek.\n`;
                prompt += `   - 0 bodů: Zásadně chybný, chybí VÍCE klíčových kroků, špatné pořadí, VÍCE než dvě chyby, nesrozumitelný, prázdný.\n`;
                prompt += `4. Hodnoť POUZE správnost a úplnost popsaného POSTUPU.\n`;
            } else if (question_type === 'multiple_choice') {
                prompt += `1. Porovnej POUZE PÍSMENO na začátku odpovědi studenta (ignoruj velikost, tečky, závorky) se správným písmenem.\n`;
                prompt += `2. SKÓRE: ${maxScore} bodů POUZE při PŘESNÉ shodě písmen, jinak 0 bodů.\n`;
            } else { // numeric, text, ano_ne
                prompt += `1. Ekvivalence: Zaměř se na matematickou/logickou správnost. Znamená odpověď studenta totéž jako správná odpověď?\n`;
                prompt += `2. Formátování (ČÍSLA): Buď flexibilní k běžným variacím ('1,5'=='1.5'; '3/2'=='1.5'; '5'=='5.00'; '10 Kč'=='10'). Tolerance pro numerickou shodu je ${NUMERIC_TOLERANCE}. NEPOVOLUJ chyby měnící hodnotu (špatná číslice, znaménko).\n`;
                prompt += `3. Ano/Ne: Hodnoť POUZE shodu prvního slova ("ano" == "ano", "ne" == "ne"). Ignoruj velikost, interpunkci za slovem.\n`;
                prompt += `4. Text/Symbolika (rovnice, intervaly): Vyžaduj VYŠŠÍ shodu obsahu po normalizaci mezer a velikosti písmen.\n`;
                prompt += `5. SKÓRE: ${maxScore} bodů POUZE PŘI PLNÉ ekvivalenci podle těchto pravidel, jinak 0 bodů.\n`;
            }
            prompt += `\nVÝSTUP: Vrať POUZE JSON objekt {"score": number, "reason": "stručné zdůvodnění proč"}. 'score' musí být celé číslo mezi 0 a ${maxScore} včetně.`;

            // 4. Volání Gemini API
            try {
                console.log(`   [CHECK] Posílám požadavek Gemini pro Q#${question.question_number}`);
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.1, // Nízká teplota pro konzistentní hodnocení
                            responseMimeType: "application/json",
                        },
                         safetySettings: [ // Uvolnění bezpečnostních filtrů
                           { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                           { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                           { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                           { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                         ]
                    })
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error(`   [CHECK] Gemini API Error (${response.status}) for Q#${question.question_number}:`, errorBody);
                    throw new Error(`Chyba Gemini API (${response.status})`);
                }

                const data = await response.json();
                // console.log(`   [CHECK] Gemini Raw Response Q#${question.question_number}:`, JSON.stringify(data));

                const jsonText = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                if (!jsonText) {
                     console.error(`   [CHECK] Gemini - Neplatná struktura odpovědi nebo chybí text pro Q#${question.question_number}:`, data);
                     throw new Error('Chybná struktura odpovědi od Gemini.');
                }

                console.log(`   [CHECK] Gemini JSON Text Q#${question.question_number}:`, jsonText);

                // 5. Zpracování odpovědi Gemini
                try {
                     const result = JSON.parse(jsonText);
                     console.log(`   [CHECK] Gemini Parsed Result Q#${question.question_number}:`, result);

                     if (typeof result.score !== 'number' || !Number.isInteger(result.score) || result.score < 0 || result.score > maxScore) {
                         console.warn(`   [CHECK] Gemini - Neplatné skóre ${result.score} (max ${maxScore}) pro Q#${question.question_number}. Používám fallback.`);
                         return runFallbackCheck();
                     }

                     console.log(`   [CHECK] Gemini Výsledek Q#${question.question_number}: Skóre: ${result.score}, Důvod: ${result.reason}`);
                     return { score: result.score, checked_by: 'gemini_scored' }; // Označíme, že Gemini úspěšně ohodnotilo

                 } catch (e) {
                     console.error(`   [CHECK] Gemini - Nepodařilo se parsovat JSON pro Q#${question.question_number}:`, e, "Odpověď:", jsonText);
                     return runFallbackCheck(); // Fallback při chybě parsování JSON
                 }

            } catch (error) {
                 console.error(`   [CHECK] Selhalo volání Gemini API pro Q#${question.question_number}:`, error);
                 return runFallbackCheck(); // Fallback při selhání API volání
            }
        } 
        // --- *** КОНЕЦ checkAnswerWithGemini *** ---


        // --- Integrace s Gemini & Výsledky ---
        async function finishTest() { /* ... */ stopTimer(); showGeminiOverlay(true); let savedSuccessfully = false; try { await evaluateAnswers(); calculateFinalResults(); showGeminiOverlay(false); savedSuccessfully = await saveTestResults(); // Funkce nyní vrací boolean
 displayResults(); // Zobrazí výsledky bez ohledu na uložení
 if (savedSuccessfully) { await awardPoints(); } else { console.log("Výsledky nebyly uloženy, body se nepřičítají."); } history.pushState({ state: 'testFinished', saved: savedSuccessfully }, document.title, window.location.href); } catch (error) { console.error("Chyba při dokončování testu:", error); showGeminiOverlay(false); displayResults(); // Zobrazí i tak výsledky, které máme
 lowScoreMessageContainer.innerHTML = `<div class="error-message-container"><i class="fas fa-exclamation-triangle"></i><div class="loader-text">Chyba!</div><div class="loader-subtext">Chyba vyhodnocení/ukládání: ${error.message}. Výsledky nemusí být kompletní nebo uložené.</div></div>`; if (continueBtn) { continueBtn.disabled = true; continueBtn.setAttribute('data-save-error', 'true'); } history.pushState({ state: 'testFinishedWithError' }, document.title, window.location.href); } }
        async function evaluateAnswers() { /* ... */ console.log("Spouštím vyhodnocení odpovědí..."); const promises = []; for (let i = 0; i < questions.length; i++) { const q = questions[i]; const answerData = userAnswers[i]; // Získáme celý objekt, pokud existuje
 const userAnswerValue = answerData ? answerData.userAnswerValue : null; const maxScore = answerData ? answerData.maxScore : (()=>{let score=1; const d=parseInt(q.difficulty);if(q.question_type==='construction')score=2;else if(!isNaN(d)){if(d>=4)score=3;else if(d===3)score=2;} return score;})(); // Max skóre určíme zde
 promises.push( checkAnswerWithGemini(q, userAnswerValue, maxScore) .then(result => { if (userAnswers[i]) { userAnswers[i].scoreAwarded = result.score; userAnswers[i].checked_by = result.checked_by; } else { // Pokud odpověď neexistovala (byla null), vytvoříme záznam
 userAnswers[i] = { question_id: q.id, userAnswerValue: null, topic_id: q.topic_id, topic_name: q.topic, scoreAwarded: result.score, maxScore: maxScore, checked_by: result.checked_by }; } console.log(`   Q${i + 1} vyhodnoceno: Skóre ${result.score}/${userAnswers[i].maxScore} (by: ${result.checked_by})`); }).catch(error => { console.error(`   Chyba vyhodnocení pro Q${i + 1}:`, error); if (userAnswers[i]) { userAnswers[i].scoreAwarded = 0; userAnswers[i].checked_by = 'eval_error'; } else { userAnswers[i] = { question_id: q.id, userAnswerValue: userAnswerValue, topic_id: q.topic_id, topic_name: q.topic, scoreAwarded: 0, maxScore: maxScore, checked_by: 'eval_error' }; } }) ); } await Promise.all(promises); console.log("Vyhodnocení odpovědí dokončeno:", userAnswers); }
        function calculateFinalResults() { /* ... */ let totalRawPointsAchieved = 0; let totalRawMaxPossiblePoints = 0; let correctCount = 0; // Otázky s >= 1 bodem
 let incorrectCount = 0; // Otázky s 0 body (ale zodpovězené)
 let unansweredCount = 0; let topicStats = {}; questions.forEach((q, index) => { const answer = userAnswers[index]; const topicKey = q.topic_id || q.topic || 'unknown'; const topicName = q.topic || 'Neznámé téma'; // Inicializace statistik tématu, pokud neexistují
 if (!topicStats[topicKey]) { topicStats[topicKey] = { name: topicName, id: q.topic_id, totalQuestions: 0, fullyCorrectQuestions: 0, // Počet otázek s plným počtem bodů
 totalPointsAchieved: 0, totalMaxPoints: 0, scorePercent: 0, // (fullyCorrectQuestions / totalQuestions) * 100
 strength: 'neutral' }; } topicStats[topicKey].totalQuestions++; const maxScore = answer?.maxScore ?? 1; topicStats[topicKey].totalMaxPoints += maxScore; totalRawMaxPossiblePoints += maxScore; if (!answer || answer.checked_by === 'skipped' || answer.checked_by === 'fallback_empty') { unansweredCount++; } else { const awardedScore = answer.scoreAwarded ?? 0; totalRawPointsAchieved += awardedScore; topicStats[topicKey].totalPointsAchieved += awardedScore; if (awardedScore >= 1) { correctCount++; } if (awardedScore === maxScore) { topicStats[topicKey].fullyCorrectQuestions++; } if (awardedScore === 0) { incorrectCount++; } } }); // Výpočet procent a síly/slabiny pro každé téma
 Object.values(topicStats).forEach(stats => { stats.scorePercent = stats.totalQuestions > 0 ? Math.round((stats.fullyCorrectQuestions / stats.totalQuestions) * 100) : 0; stats.strength = stats.scorePercent >= 75 ? 'strength' : (stats.scorePercent < 50 ? 'weakness' : 'neutral'); }); // Celkové procento = počet otázek s alespoň 1 bodem / celkový počet otázek
 const finalPercentage = questions.length > 0 ? Math.round((correctCount / questions.length) * 100) : 0; // Celkové skóre 0-50 = (získané body / max možné body) * 50
 const finalScoreOutOf50 = totalRawMaxPossiblePoints > 0 ? Math.round((totalRawPointsAchieved / totalRawMaxPossiblePoints) * 50) : 0; testResultsData = { totalQuestions: questions.length, correctAnswers: correctCount, incorrectAnswers: incorrectCount, unanswered: unansweredCount, score: finalScoreOutOf50, totalPointsAchieved: totalRawPointsAchieved, totalMaxPossiblePoints: totalRawMaxPossiblePoints, percentage: finalPercentage, timeSpent: testTime, topicResults: topicStats }; console.log("Finální výsledky vypočítány:", testResultsData); }
        function displayResults() { /* ... */ if (!testContainer || !resultsContainer || !reviewContainer || !testTimer || !testLevel || !resultScoreEl || !resultPercentageEl || !resultCorrectEl || !resultIncorrectEl || !resultTimeEl || !lowScoreMessageContainer || !continueBtn || !topicResultsEl || !reviewAnswersBtn || !backToResultsBtn) { console.error("Chyba: Některé elementy výsledků nebyly nalezeny v DOM."); return; } testContainer.style.display = 'none'; resultsContainer.style.display = 'block'; reviewContainer.style.display = 'none'; testTimer.style.display = 'none'; testLevel.textContent = 'Výsledky testu'; resultScoreEl.textContent = `${testResultsData.score}/50`; resultPercentageEl.textContent = `${testResultsData.percentage}%`; resultCorrectEl.textContent = testResultsData.correctAnswers; resultIncorrectEl.textContent = testResultsData.incorrectAnswers; resultTimeEl.textContent = formatTime(testResultsData.timeSpent); const percentageLabel = document.querySelector('#result-percentage + .stat-label'); if (percentageLabel) percentageLabel.textContent = 'Úspěšnost otázek (>=1b)'; const correctLabel = document.querySelector('#result-correct + .stat-label'); if (correctLabel) correctLabel.textContent = 'Správně (>=1 bod)'; const incorrectLabel = document.querySelector('#result-incorrect + .stat-label'); if (incorrectLabel) incorrectLabel.textContent = 'Chybně (0 bodů)'; lowScoreMessageContainer.innerHTML = ''; // Vyčistit předchozí zprávy
 continueBtn.disabled = true; // Zakázat defaultně
 const saveError = continueBtn.getAttribute('data-save-error') === 'true'; if (saveError) { console.log("Chyba ukládání detekována, tlačítko plánu zůstává neaktivní."); lowScoreMessageContainer.innerHTML = `<div class="error-message-container" style="text-align:left; margin-bottom: 1rem;"><i class="fas fa-exclamation-triangle"></i><div class="loader-text">Chyba ukládání</div><div class="loader-subtext">Nepodařilo se uložit výsledky testu. Studijní plán nelze vytvořit. Zkuste test absolvovat znovu.</div></div>`; } else if (testResultsData.score < SCORE_THRESHOLD_FOR_SAVING) { lowScoreMessageContainer.innerHTML = `<div class="low-score-message warning"> <i class="fas fa-exclamation-circle"></i> <strong>Výsledek nebyl uložen.</strong><br> Vaše skóre (${testResultsData.score}/50) je nižší než ${SCORE_THRESHOLD_FOR_SAVING} bodů. Tyto výsledky nebudou použity pro generování studijního plánu. Doporučujeme další procvičování. </div>`; console.log(`Výsledky neuloženy, skóre ${testResultsData.score} < ${SCORE_THRESHOLD_FOR_SAVING}`); } else { // Úspěšně uloženo (nebo by mělo být)
 lowScoreMessageContainer.innerHTML = `<div class="low-score-message info"> <i class="fas fa-info-circle"></i> <strong>Výsledky byly zpracovány.</strong><br> Vaše skóre (${testResultsData.score}/50) může být použito pro vytvoření studijního plánu. </div>`; continueBtn.disabled = false; // Povolit tlačítko
 console.log(`Výsledky zpracovány (skóre ${testResultsData.score} >= ${SCORE_THRESHOLD_FOR_SAVING}). Tlačítko plánu aktivováno.`); } const sortedTopics = Object.values(testResultsData.topicResults || {}).sort((a, b) => a.scorePercent - b.scorePercent); topicResultsEl.innerHTML = sortedTopics.map(stats => { const icon = topicIcons[stats.name] || topicIcons.default; return `<div class="topic-card ${stats.strength}"> <div class="topic-header"> <div class="topic-icon"><i class="fas ${icon}"></i></div> <h3 class="topic-title">${stats.name}</h3> </div> <div class="topic-stats"> <div class="topic-progress"> <span class="topic-progress-label">Úspěšnost (plně spr.)</span> <span class="topic-progress-value">${stats.scorePercent}%</span> </div> <div class="topic-progress-bar"> <div class="topic-progress-fill" style="width: ${stats.scorePercent}%;"></div> </div> <div class="topic-progress" style="margin-top: 0.5rem;"> <span class="topic-progress-label">Získané body</span> <span class="topic-progress-value">${stats.totalPointsAchieved} / ${stats.totalMaxPoints}</span> </div> </div> </div>`; }).join(''); if (reviewAnswersBtn) reviewAnswersBtn.onclick = displayReview; if (backToResultsBtn) backToResultsBtn.onclick = () => { reviewContainer.style.display = 'none'; resultsContainer.style.display = 'block'; }; }


        /**
         * Vytváří EXTRÉMNĚ PODROBNÝ objekt analýzy pro uložení do DB.
         * @param {object} results - Objekt testResultsData.
         * @param {Array} answers - Pole userAnswers.
         * @param {Array} questionsData - Pole původních objektů otázek.
         * @returns {object} - Detailní objekt analýzy.
         */
        function generateDetailedAnalysis(results, answers, questionsData) {
             console.log("Generování detailní analýzy...");
             const analysis = {
                 summary: {
                     score_final_normalized: results.score, // 0-50 scale
                     total_points_achieved: results.totalPointsAchieved,
                     total_max_possible_points: results.totalMaxPossiblePoints,
                     percentage_correct_questions: results.percentage, // % otázek s >= 1 bodem
                     percentage_points_achieved: results.totalMaxPossiblePoints > 0 ? Math.round((results.totalPointsAchieved / results.totalMaxPossiblePoints) * 100) : 0, // % získaných bodů
                     time_spent_seconds: results.timeSpent,
                     total_questions: results.totalQuestions,
                     correct_questions_count: results.correctAnswers, // >= 1 bod
                     incorrect_questions_count: results.incorrectAnswers, // 0 bodů
                     unanswered_questions_count: results.unanswered,
                 },
                 strengths: [], // Témata s >= 75% úspěšností (plně správně)
                 weaknesses: [], // Témata s < 50% úspěšností (plně správně)
                 detailed_topic_performance: {}, // Detailní statistiky pro KAŽDÉ téma
                 detailed_question_performance: [], // Detailní statistiky pro KAŽDOU otázku
                 performance_by_type: {}, // Výkon podle typu otázky
                 performance_by_difficulty: {}, // Výkon podle obtížnosti (pokud je dostupná)
                 overall_assessment: "", // Celkové slovní hodnocení
                 recommendations: [] // Doporučení pro studijní plán
             };

             // 1. Detailní výkon podle témat a identifikace S&W
             for (const [topicKey, stats] of Object.entries(results.topicResults || {})) {
                 const topicDetail = {
                     topic_id: stats.id,
                     topic_name: stats.name,
                     total_questions_in_topic: stats.totalQuestions,
                     fully_correct_questions: stats.fullyCorrectQuestions, // s plným počtem bodů
                     partially_correct_questions: 0, // Budeme počítat níže
                     incorrect_questions: 0, // s 0 body
                     total_points_achieved: stats.totalPointsAchieved,
                     total_max_points: stats.totalMaxPoints,
                     score_percent_fully_correct: stats.scorePercent, // % plně správných
                     score_percent_points_achieved: stats.totalMaxPoints > 0 ? Math.round((stats.totalPointsAchieved / stats.totalMaxPoints) * 100) : 0, // % získaných bodů
                     strength_level: stats.strength // 'strength', 'neutral', 'weakness'
                 };
                 analysis.detailed_topic_performance[stats.name] = topicDetail;
                 if (stats.strength === 'strength') analysis.strengths.push({ topic: stats.name, score: stats.scorePercent });
                 else if (stats.strength === 'weakness') analysis.weaknesses.push({ topic: stats.name, score: stats.scorePercent });
             }
             analysis.strengths.sort((a, b) => b.score - a.score);
             analysis.weaknesses.sort((a, b) => a.score - b.score);

             // 2. Detailní výkon podle otázek a typů
             questionsData.forEach((q, index) => {
                 const answer = answers[index];
                 const qType = q.question_type;
                 const difficulty = q.difficulty || 'unknown';
                 const topicName = q.topic || 'Neznámé téma';

                 // Agregace podle typu
                 if (!analysis.performance_by_type[qType]) analysis.performance_by_type[qType] = { points_achieved: 0, max_points: 0, total_questions: 0, correct_questions: 0, partial_questions: 0, incorrect_questions: 0 };
                 analysis.performance_by_type[qType].total_questions++;

                 // Agregace podle obtížnosti
                 if (!analysis.performance_by_difficulty[difficulty]) analysis.performance_by_difficulty[difficulty] = { points_achieved: 0, max_points: 0, total_questions: 0, correct_questions: 0, partial_questions: 0, incorrect_questions: 0 };
                 analysis.performance_by_difficulty[difficulty].total_questions++;

                 const maxQScore = answer?.maxScore ?? 1;
                 analysis.performance_by_type[qType].max_points += maxQScore;
                 analysis.performance_by_difficulty[difficulty].max_points += maxQScore;

                 const questionDetail = {
                     question_number: q.question_number,
                     question_id: q.id,
                     topic: topicName,
                     subtopic: q.subtopic || null,
                     type: qType,
                     difficulty: difficulty,
                     user_answer: answer?.userAnswerValue ?? null,
                     correct_answer: q.correct_answer,
                     solution_explanation: q.solution_explanation,
                     score_awarded: answer?.scoreAwarded ?? 0,
                     max_score: maxQScore,
                     checked_by: answer?.checked_by ?? 'unknown',
                     status: 'unanswered' // Default status
                 };

                 if (answer && answer.checked_by !== 'skipped' && answer.checked_by !== 'fallback_empty') {
                      const awardedScore = answer.scoreAwarded ?? 0;
                      analysis.performance_by_type[qType].points_achieved += awardedScore;
                      analysis.performance_by_difficulty[difficulty].points_achieved += awardedScore;

                      if (awardedScore === maxQScore) {
                          questionDetail.status = 'correct';
                          analysis.performance_by_type[qType].correct_questions++;
                          analysis.performance_by_difficulty[difficulty].correct_questions++;
                          if(analysis.detailed_topic_performance[topicName]) {
                              // fullyCorrectQuestions se počítá v `calculateFinalResults`, zde nepotřebujeme znovu
                          }
                      } else if (awardedScore > 0) {
                          questionDetail.status = 'partial';
                          analysis.performance_by_type[qType].partial_questions++;
                          analysis.performance_by_difficulty[difficulty].partial_questions++;
                           if(analysis.detailed_topic_performance[topicName]) {
                               analysis.detailed_topic_performance[topicName].partially_correct_questions++;
                           }
                      } else {
                          questionDetail.status = 'incorrect';
                          analysis.performance_by_type[qType].incorrect_questions++;
                          analysis.performance_by_difficulty[difficulty].incorrect_questions++;
                           if(analysis.detailed_topic_performance[topicName]) {
                               analysis.detailed_topic_performance[topicName].incorrect_questions++;
                           }
                      }
                 } else {
                     questionDetail.status = 'skipped';
                      // Nezapočítáváme body, ale otázka existuje
                 }
                 analysis.detailed_question_performance.push(questionDetail);
             });

             // 3. Celkové slovní hodnocení
             const score = results.score;
             if (score >= 45) analysis.overall_assessment = "Vynikající výkon! Skvělá příprava.";
             else if (score >= 38) analysis.overall_assessment = "Velmi dobrý výkon, silný základ.";
             else if (score >= 30) analysis.overall_assessment = "Dobrý výkon, s prostorem pro zlepšení v konkrétních oblastech.";
             else if (score >= 20) analysis.overall_assessment = "Průměrný výkon. Je třeba se zaměřit na identifikované slabiny.";
             else if (score >= 10) analysis.overall_assessment = "Podprůměrný výkon. Doporučuje se systematické opakování základů a cílené procvičování.";
             else analysis.overall_assessment = "Výrazně podprůměrný výkon. Nutné důkladné zopakování všech témat a intenzivní procvičování.";
             if (score < SCORE_THRESHOLD_FOR_SAVING) analysis.overall_assessment += " Skóre je příliš nízké pro uložení a generování optimálního studijního plánu.";

             // 4. Doporučení (Více detailní)
             if (analysis.weaknesses.length > 0) {
                 analysis.recommendations.push(`Priorita č. 1: Intenzivně se zaměřte na nejslabší témata: **${analysis.weaknesses.map(w => `${w.topic} (${w.score}%)`).join(', ')}**. Projděte si teorii a řešte co nejvíce příkladů z těchto oblastí.`);
                 const incorrectWeakTopics = analysis.detailed_question_performance.filter(q => analysis.weaknesses.some(w => w.topic === q.topic) && q.status === 'incorrect');
                 if (incorrectWeakTopics.length > 0) {
                      analysis.recommendations.push(`Analyzujte konkrétní chyby v otázkách č. ${incorrectWeakTopics.map(q => q.question_number).slice(0, 5).join(', ')} z těchto slabých témat.`);
                 }
             } else if (results.percentage < 85 && Object.keys(analysis.detailed_topic_performance).length > 0) {
                 // Najdi téma s nejnižším % získaných bodů (pokud nejsou explicitní slabiny)
                 const lowestPointsTopic = Object.values(analysis.detailed_topic_performance).sort((a,b) => a.score_percent_points_achieved - b.score_percent_points_achieved)[0];
                 if(lowestPointsTopic) analysis.recommendations.push(`I když nemáte výrazné slabiny, zaměřte se na zlepšení v tématu **${lowestPointsTopic.topic_name}** (získané body: ${lowestPointsTopic.score_percent_points_achieved}%).`);
             }

             // Doporučení na základě typů otázek
             const typePerformance = Object.entries(analysis.performance_by_type)
                 .map(([type, stats]) => ({ type, perc: stats.max_points > 0 ? Math.round(stats.points_achieved * 100 / stats.max_points) : 100 }))
                 .sort((a, b) => a.perc - b.perc);
             if (typePerformance.length > 0 && typePerformance[0].perc < 60) {
                 analysis.recommendations.push(`Zlepšete se v řešení otázek typu: **${typePerformance[0].type}** (úspěšnost bodů: ${typePerformance[0].perc}%). Zkuste jiný přístup nebo si projděte strategii řešení.`);
             }

             // Další obecná doporučení
             const incorrectQuestions = analysis.detailed_question_performance.filter(q => q.status === 'incorrect').length;
             if (incorrectQuestions > 3) { analysis.recommendations.push(`Pečlivě si projděte **${incorrectQuestions} chybně zodpovězených otázek** a pochopte, kde nastala chyba.`); }

             if (results.percentage < 70) { analysis.recommendations.push("Opakujte klíčové vzorce a definice."); }
             if (analysis.strengths.length > 0) { analysis.recommendations.push(`Nezapomínejte udržovat silné stránky (např. **${analysis.strengths[0].topic}**) pravidelným opakováním.`); }
             if (score >= SCORE_THRESHOLD_FOR_SAVING) { analysis.recommendations.push("Využijte tuto analýzu pro **vytvoření personalizovaného studijního plánu**."); }
             else { analysis.recommendations.push("Po dalším procvičení zkuste diagnostický test znovu."); }

             console.log("Detailní analýza vygenerována.");
             return analysis;
        }


         async function saveTestResults() {
             console.log("Spouštím saveTestResults...");
             // Znovu zkontrolovat podmínky, i když by měly být splněny, pokud se funkce volá
             if (!currentUser || currentUser.id === 'PLACEHOLDER_USER_ID') {
                 console.warn("Neukládám: Není přihlášený uživatel.");
                 return false; // Neuloženo
             }
             if (testResultsData.score < SCORE_THRESHOLD_FOR_SAVING) {
                 console.log(`Neukládám: Výsledek (${testResultsData.score}/50) je nižší než ${SCORE_THRESHOLD_FOR_SAVING}.`);
                 return false; // Neuloženo
             }

             console.log(`Pokouším se uložit výsledky (Skóre: ${testResultsData.score}/50 >= ${SCORE_THRESHOLD_FOR_SAVING})...`);
             if (continueBtn) continueBtn.disabled = true; // Zakázat tlačítko během ukládání

             try {
                 // Generování EXTRÉMNĚ PODROBNÉ analýzy
                 const detailedAnalysis = generateDetailedAnalysis(testResultsData, userAnswers, questions);

                 const dataToSave = {
                     user_id: currentUser.id,
                     completed_at: new Date().toISOString(),
                     total_score: testResultsData.score, // Skóre 0-50
                     total_questions: testResultsData.totalQuestions,
                     // Uložíme pole odpovědí s detailními informacemi
                     answers: userAnswers.map(a => ({
                         q_id: a?.question_id,
                         u_answer: a?.userAnswerValue,
                         score: a?.scoreAwarded,
                         max_score: a?.maxScore,
                         checked_by: a?.checked_by
                     })),
                     // Uložíme detailní výsledky podle témat z testResultsData
                     topic_results: testResultsData.topicResults,
                     // Uložíme nově vygenerovanou SUPER-DETAILNÍ analýzu
                     analysis: detailedAnalysis,
                     // Můžeme přidat i další metadata, např. typ testu
                     // test_type: selectedTestType
                 };

                 console.log("Data k uložení do user_diagnostics:", dataToSave);

                 const { data, error } = await supabaseClient
                     .from('user_diagnostics')
                     .insert(dataToSave)
                     .select('id')
                     .single();

                 if (error) {
                     console.error('Supabase insert error:', error);
                     throw new Error(`Supabase chyba: ${error.message} (Hint: ${error.hint})`);
                 }

                 diagnosticId = data.id; // Uložíme ID pro případné další použití
                 console.log("Diagnostika úspěšně uložena, ID:", diagnosticId);
                 if (continueBtn) continueBtn.disabled = false; // Povolit tlačítko po úspěšném uložení
                 return true; // Uloženo úspěšně

             } catch (error) {
                 console.error('Chyba při ukládání výsledků testu:', error);
                 showToast(`Nepodařilo se uložit výsledky: ${error.message}`, 'error');
                 if (continueBtn) {
                     continueBtn.disabled = true;
                     continueBtn.setAttribute('data-save-error', 'true'); // Označit chybu pro displayResults
                 }
                 // Nevyhazujeme zde znovu chybu, necháme finishTest zobrazit výsledky s chybovou zprávou
                 return false; // Uložení selhalo
             }
         }
        // --- КОНЕЦ saveTestResults ---

        async function awardPoints() { /* ... */ if (!selectedTestType || !testResultsData || testResultsData.totalQuestions <= 0) { console.warn("Nelze vypočítat body: Chybí data testu."); return; } if (!currentUser || currentUser.id === 'PLACEHOLDER_USER_ID') { console.warn("Nelze uložit body: Chybí uživatel."); return; } if (!currentProfile) { currentProfile = await fetchUserProfile(currentUser.id); if (!currentProfile) { console.warn("Nelze uložit body: Chybí profil uživatele."); return; } } const config = testTypeConfig[selectedTestType]; if (!config) { console.warn(`Neznámá konfigurace testu pro typ: ${selectedTestType}`); return; } const n = config.multiplier; const score_perc = testResultsData.percentage / 100; // Použijeme procentuální úspěšnost otázek (>=1b)
 const calculatedPoints = Math.round(n * score_perc * 15); // Max cca 15-25 bodů za test
 if (calculatedPoints <= 0) { console.log("Nebyly získány žádné body."); return; } console.log(`Vypočítané body: ${calculatedPoints} (n=${n}, score%=${testResultsData.percentage})`); await updateUserPoints(calculatedPoints); }
        async function updateUserPoints(pointsToAdd) { /* ... */ if (!currentUser || !currentProfile || pointsToAdd <= 0) { console.log("Přeskakuji aktualizaci bodů:", { userId: currentUser?.id, profileExists: !!currentProfile, pointsToAdd }); return; } try { const currentPoints = currentProfile.points || 0; const newPoints = currentPoints + pointsToAdd; const { error } = await supabaseClient.from('profiles').update({ points: newPoints, updated_at: new Date().toISOString() }).eq('id', currentUser.id); if (error) { throw error; } console.log(`Body uživatele ${currentUser.id} aktualizovány na ${newPoints} (+${pointsToAdd})`); currentProfile.points = newPoints; showToast(`Získali jste ${pointsToAdd} bodů!`, 'success'); } catch (error) { console.error("Chyba při aktualizaci bodů uživatele:", error); showToast('Nepodařilo se aktualizovat body.', 'error'); } }
        async function updateUserStats() { /* ... */ console.log("Aktualizace user stats - přeskočeno (zatím není implementováno)."); }
        function displayReview() { /* ... */ if (!resultsContainer || !reviewContainer || !reviewContent) { console.error("Elementy pro přehled odpovědí nenalezeny!"); return; } resultsContainer.style.display = 'none'; reviewContainer.style.display = 'block'; reviewContent.innerHTML = ''; if (!questions || !userAnswers || questions.length !== userAnswers.length) { reviewContent.innerHTML = '<p class="error-message-container">Chyba: Data pro přehled odpovědí nejsou kompletní.</p>'; return; } questions.forEach((q, index) => { const answer = userAnswers[index]; if (!answer) { console.warn(`Nenalezena data odpovědi pro otázku #${index + 1}`); reviewContent.innerHTML += `<div class="review-question-item skipped"><div class="review-question-header"><span class="review-question-number">${q.question_number}</span><div class="review-question-text">${marked.parse(q.question_text || '')}</div></div><div class="review-answer-section"><em>Data pro tuto otázku chybí nebo nebyla zodpovězena.</em></div></div>`; return; } let itemClass = 'review-question-item'; let scoreStatus = ''; if (answer.checked_by === 'skipped' || answer.checked_by === 'fallback_empty') { itemClass += ' skipped'; scoreStatus = '<span class="skipped">Přeskočeno</span>'; } else if (answer.scoreAwarded === answer.maxScore) { itemClass += ' correct'; scoreStatus = '<span class="correct">Správně</span>'; } else if (answer.scoreAwarded > 0) { itemClass += ' partial'; scoreStatus = '<span class="partial">Částečně</span>'; } else { itemClass += ' incorrect'; scoreStatus = '<span class="incorrect">Chybně</span>'; } let reviewHTML = `<div class="${itemClass}">`; reviewHTML += `<div class="review-question-header"><span class="review-question-number">${q.question_number}</span><div class="review-question-text">${marked.parse(q.question_text || '')}</div></div>`; if (q.image_url) { reviewHTML += `<div class="question-image-container"><img class="question-image" src="${q.image_url}" alt="Obrázek k otázce ${q.question_number}" loading="lazy"></div>`; } reviewHTML += `<div class="review-answer-section">`; if (answer.userAnswerValue !== null && answer.checked_by !== 'skipped' && answer.checked_by !== 'fallback_empty') { reviewHTML += `<div class="review-user-answer"><strong>Vaše odpověď:</strong> `; if (q.question_type === 'multiple_choice') { const selectedLetter = String(answer.userAnswerValue).trim().toUpperCase(); const selectedOptionIndex = selectedLetter.charCodeAt(0) - 65; const optionText = (Array.isArray(q.options) && q.options[selectedOptionIndex] !== undefined) ? marked.parseInline(String(q.options[selectedOptionIndex])) : `(Neplatná volba: ${sanitizeHTML(answer.userAnswerValue)})`; reviewHTML += `${selectedLetter}. ${optionText}`; } else { reviewHTML += marked.parseInline(String(answer.userAnswerValue)); // Použijeme parseInline pro případný markdown v odpovědi
 } reviewHTML += `</div>`; } else { reviewHTML += `<div class="review-user-answer"><strong>Vaše odpověď:</strong> <em>(Nezodpovězeno)</em></div>`; } if (answer.checked_by !== 'skipped' && answer.checked_by !== 'fallback_empty') { reviewHTML += `<div class="review-correct-answer"><strong>Správná odpověď:</strong> `; if (q.question_type === 'multiple_choice') { const correctLetter = String(q.correct_answer).trim().toUpperCase().charAt(0); const correctOptionIndex = correctLetter.charCodeAt(0) - 65; const correctText = (Array.isArray(q.options) && q.options[correctOptionIndex] !== undefined) ? marked.parseInline(String(q.options[correctOptionIndex])) : `(Neplatný text správné odpovědi)`; reviewHTML += `${correctLetter}. ${correctText}`; } else if (q.question_type !== 'construction') { reviewHTML += marked.parseInline(String(q.correct_answer)); } else { reviewHTML += `<em>(Viz oficiální postup níže)</em>`; } reviewHTML += `</div>`; } if (q.solution_explanation) { // Použijeme Marked pro renderování vysvětlení
 reviewHTML += `<div class="review-solution"><strong>Řešení / Postup:</strong><div class="solution-content">${marked.parse(q.solution_explanation)}</div></div>`; } reviewHTML += `<div class="review-score"><strong>Hodnocení:</strong> ${scoreStatus} (${answer.scoreAwarded ?? 0} / ${answer.maxScore} b.) <em style="font-size:0.8em; opacity:0.7;">(by: ${answer.checked_by})</em></div>`; reviewHTML += `</div></div>`; reviewContent.innerHTML += reviewHTML; }); if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') { try { setTimeout(() => { window.MathJax.typesetPromise([reviewContent]) }, 0); } catch (e) { console.error("Chyba MathJax v přehledu:", e); } } reviewContainer.scrollIntoView({ behavior: 'smooth' }); }
        function setupCommonEventListeners() { /* ... */ if (mobileMenuToggle) mobileMenuToggle.addEventListener('click', () => { sidebar?.classList.toggle('active'); sidebarOverlay?.classList.toggle('active'); }); if (sidebarOverlay) sidebarOverlay.addEventListener('click', () => { sidebar?.classList.remove('active'); sidebarOverlay?.classList.remove('active'); }); if (prevBtn) prevBtn.addEventListener('click', () => { if (currentQuestionIndex > 0) showQuestion(currentQuestionIndex - 1); }); if (nextBtn) nextBtn.addEventListener('click', () => { if (currentQuestionIndex < questions.length - 1) showQuestion(currentQuestionIndex + 1); }); if (finishBtn) { finishBtn.addEventListener('click', async () => { const unansweredCount = userAnswers.filter(a => a === null || (a && String(a.userAnswerValue).trim() === '')).length; let confirmFinish = true; if (unansweredCount > 0) confirmFinish = confirm(`Nezodpověděli jste ${unansweredCount} ${unansweredCount === 1 ? 'otázku' : (unansweredCount < 5 ? 'otázky' : 'otázek')}. Přesto dokončit?`); else confirmFinish = confirm('Opravdu chcete dokončit test?'); if (confirmFinish) { finishBtn.disabled = true; finishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Dokončuji...'; await finishTest(); } }); } if (retryBtn) { retryBtn.addEventListener('click', () => { /* Reset logiky beze změny */ checkExistingDiagnostic(currentUser?.id).then(hasCompleted => { if (hasCompleted) { if(testSelector) { testSelector.innerHTML = `<div class="section animated"><h2 class="section-title"><i class="fas fa-check-circle" style="color: var(--success);"></i> Test již dokončen</h2><p>Tento diagnostický test jste již absolvoval/a.</p><p><strong>Tento test nelze opakovat.</strong></p><div style="margin-top:1.5rem; display:flex; gap:1rem; flex-wrap:wrap;"><a href="plan.html" class="btn btn-primary"><i class="fas fa-tasks"></i> Zobrazit plán</a><a href="main.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Zpět</a></div></div>`; testSelector.style.display = 'block'; } if(resultsContainer) resultsContainer.style.display = 'none'; if(reviewContainer) reviewContainer.style.display = 'none'; } else { if(resultsContainer) resultsContainer.style.display = 'none'; if (reviewContainer) reviewContainer.style.display = 'none'; if(testSelector) testSelector.style.display = 'block'; questions = []; userAnswers = []; testResultsData = { score: 0 }; diagnosticId = null; selectedTestType = null; document.querySelectorAll('.test-type-card').forEach(c => c.classList.remove('selected')); if(lowScoreMessageContainer) lowScoreMessageContainer.innerHTML = ''; if (continueBtn) { continueBtn.disabled = true; continueBtn.removeAttribute('data-save-error'); } if(testLevel) testLevel.textContent = 'Výběr testu'; history.replaceState({ state: 'testSelection' }, document.title, window.location.href); } }); }); } if (continueBtn) { continueBtn.addEventListener('click', () => { if (!continueBtn.disabled) { window.location.href = `plan.html`; // Cíl je stránka s plánem
 } }); } window.addEventListener('resize', () => { if (window.innerWidth > 576 && sidebar?.classList.contains('active')) { sidebar.classList.remove('active'); sidebarOverlay?.classList.remove('active'); } }); }
        function handleBackButton(event) { /* ... */ const state = event.state ? event.state.state : null; const testIsRunning = testContainer && testContainer.style.display === 'block'; const resultsAreShown = resultsContainer && resultsContainer.style.display === 'block'; const reviewIsShown = reviewContainer && reviewContainer.style.display === 'block'; if (reviewIsShown) { // If in review, go back to results
 reviewContainer.style.display = 'none'; if (resultsContainer) resultsContainer.style.display = 'block'; history.pushState({ state: 'testFinished', saved: history.state?.saved }, document.title, window.location.href); // Go back to results state
 } else if (testIsRunning) { // If test is running, confirm exit
 if (!confirm('Opustit test? Postup nebude uložen.')) { history.pushState({ state: 'testInProgress' }, document.title, window.location.href); // Stay in test state
 } else { stopTimer(); // Go back to selection
 if (testContainer) testContainer.style.display = 'none'; if (testLoader) testLoader.style.display = 'none'; if (testSelector) testSelector.style.display = 'block'; if (testTimer) testTimer.style.display = 'none'; if (testLevel) testLevel.textContent = 'Výběr testu'; history.replaceState({ state: 'testSelection' }, document.title, window.location.href); // Replace state to selection
 } } else if (resultsAreShown) { // If results are shown, go back to selection
 if(resultsContainer) resultsContainer.style.display = 'none'; if (testSelector) testSelector.style.display = 'block'; if(testLevel) testLevel.textContent = 'Výběr testu'; history.replaceState({ state: 'testSelection' }, document.title, window.location.href); } else { // Default browser behavior or initial state
 console.log("Navigace zpět (výchozí chování nebo výběr testu)."); if(testSelector) testSelector.style.display = 'block'; if(testContainer) testContainer.style.display = 'none'; if(resultsContainer) resultsContainer.style.display = 'none'; if(reviewContainer) reviewContainer.style.display = 'none'; } 
}


        // Spuštění Aplikace
        document.addEventListener('DOMContentLoaded', initializeApp);

   </script>
</body>
</html>