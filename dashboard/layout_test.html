 <!DOCTYPE html>
<html lang="cs" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layout & Component Test Lab // Cosmic v3.6 Refactored</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;700&family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;500;700;900&family=Audiowide&family=Shadows+Into+Light+Two&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">

</head>
<body class="new-vyuka-layout">

    <aside class="vyuka-sidebar-ai" id="vyuka-sidebar-test">
        <div class="vyuka-sidebar-ai-header">
            <a href="#" class="vyuka-sidebar-ai-logo"><i class="fas fa-atom"></i> <span class="logo-text">Test Lab</span></a>
        </div>
        <ul class="vyuka-sidebar-ai-menu">
            <li class="vyuka-sidebar-ai-item" title="Dashboard"><a href="#" class="vyuka-sidebar-ai-link active"><i class="fas fa-tachometer-alt"></i><span class="link-text">Dashboard</span></a></li>
            <li class="vyuka-sidebar-ai-item" title="Settings"><a href="#" class="vyuka-sidebar-ai-link"><i class="fas fa-cog"></i><span class="link-text">Settings</span></a></li>
        </ul>
        <div class="vyuka-sidebar-ai-footer">&copy; 2025 Test Lab</div>
    </aside>
    <div class="sidebar-overlay-ai" id="sidebar-overlay-test"></div>

    <div class="vyuka-page-container">
        <header class="vyuka-header">
            <div class="vyuka-header-left">
                <button class="mobile-menu-toggle" id="mobile-menu-toggle-test"><i class="fas fa-bars"></i></button>
                <button class="sidebar-ai-desktop-toggle" id="sidebar-toggle-test" title="Sbalit panel"><i class="fas fa-chevron-left"></i></button>
                <div class="vyuka-header-page-title-container">
                    <h1>Layout Test Lab</h1>
                    <p>Prostředí pro testování a vylepšování UI komponent.</p>
                </div>
            </div>
            <div class="vyuka-header-right">
                <div class="header-stats">
                    <div class="header-stat-item" id="header-credits-display" title="Kredity"><i class="fas fa-coins"></i><strong id="header-credits-value">...</strong></div>
                    <div class="header-stat-item" id="header-level-widget">
                        <div class="level-xp-widget-new">
                            <div class="level-display"><span class="level-label">Lvl</span><span class="level-value" id="header-level-value">..</span></div>
                            <div class="xp-bar-container">
                                <div class="xp-bar-track"><div class="xp-bar-progress" id="header-exp-progress" style="width: 0%;"></div></div>
                                <div class="xp-text" id="header-exp-text">.../...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="user-menu-container">
                    <div class="vyuka-header-user-display">
                        <div class="vyuka-header-user-avatar-wrapper" id="header-avatar-wrapper"><span>?</span></div>
                        <div class="vyuka-header-user-details">
                            <span class="vyuka-header-user-name" id="header-user-name">Načítání...</span>
                            <span class="vyuka-header-user-title" id="header-user-title">...</span>
                        </div>
                    </div>
                    <div class="user-dropdown-menu">
                         <ul class="user-dropdown-links">
                            <li><a href="#"><i class="fas fa-user-astronaut"></i> Veřejný Profil</a></li>
                            <li><a href="#"><i class="fas fa-cog"></i> Nastavení</a></li>
                        </ul>
                        <button class="btn btn-danger btn-sm logout-btn"><i class="fas fa-power-off"></i> Odhlásit se</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="vyuka-main-content-scrollable">
            <main class="vyuka-main-content">
                <div class="component-section">
                    <h3>Refactoring Buttons / Shortcuts</h3>
                    <div class="test-lab-grid">
                        <a href="#" class="card shortcut-card">
                            <div class="shortcut-icon"><i class="fas fa-rocket"></i></div>
                            <h3 class="shortcut-title">Launch Mission</h3>
                            <p class="shortcut-desc">Start a new training exercise or diagnostic test.</p>
                        </a>
                        <a href="#" class="card shortcut-card">
                            <div class="shortcut-icon"><i class="fas fa-book-spells"></i></div>
                            <h3 class="shortcut-title">Review Codex</h3>
                            <p class="shortcut-desc">Access your learning materials and database.</p>
                        </a>
                    </div>
                </div>
            </main>

            <footer class="main-footer vyuka-footer">
                <div class="container">
                    <div class="footer-grid">
                        <div class="footer-column">
                            <a href="#" class="logo" aria-label="Justax Domů">
                                <i class="fas fa-atom" aria-hidden="true"></i> <span>Test Lab</span>
                            </a>
                            <p>Testovací prostředí pro UI komponenty a layouty.</p>
                            <div class="social-links" aria-label="Sociální sítě">
                                 <a href="#" class="social-link" aria-label="Telegram"><i class="fab fa-telegram-plane" aria-hidden="true"></i></a>
                                 <a href="#" class="social-link" aria-label="Instagram"><i class="fab fa-instagram" aria-hidden="true"></i></a>
                            </div>
                        </div>
                        <div class="footer-column">
                            <h3>Navigace</h3>
                            <ul class="footer-links">
                                <li><a href="#"><i class="fas fa-tachometer-alt" aria-hidden="true"></i> Dashboard</a></li>
                                <li><a href="#"><i class="fas fa-cog" aria-hidden="true"></i> Nastavení</a></li>
                            </ul>
                        </div>
                        <div class="footer-column">
                            <h3>Podpora</h3>
                            <ul class="footer-links">
                                <li><a href="#"><i class="fas fa-shield-alt" aria-hidden="true"></i> Privacy Policy</a></li>
                                <li><a href="#"><i class="fas fa-headset" aria-hidden="true"></i> Kontaktovat Podporu</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="footer-copyright">
                        &copy; 2025 Test Lab Footer // Justax Systems
                    </div>
                </div>
            </footer>
        </div>
    </div>
    
    <script src="js/supabase-client.js"></script>
    <script src="js/ui-helpers.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const supabase = Justax.initSupabase();
            Justax.UI.init(); 

            // --- Элементы UI для обновления ---
            const headerAvatarWrapper = document.getElementById('header-avatar-wrapper');
            const headerUserName = document.getElementById('header-user-name');
            const headerUserTitle = document.getElementById('header-user-title');
            const headerCreditsValue = document.getElementById('header-credits-value');
            const headerLevelValue = document.getElementById('header-level-value');
            const headerExpProgress = document.getElementById('header-exp-progress');
            const headerExpText = document.getElementById('header-exp-text');

            const getInitials = (profile, email) => {
                if (!profile && !email) return '?'; let i = '';
                if (profile?.first_name) i += profile.first_name[0]; if (profile?.last_name) i += profile.last_name[0];
                if (i) return i.toUpperCase(); if (profile?.username) return profile.username[0].toUpperCase();
                if (email) return email[0].toUpperCase(); return 'P';
            };
            
            const getTotalExpThreshold = (targetLevel) => {
                const BASE_XP = 100; const INCREMENT_XP = 25;
                if (targetLevel <= 1) return 0; let totalExp = 0;
                for (let level = 1; level < targetLevel; level++) { totalExp += (BASE_XP + (INCREMENT_XP * (level - 1))); }
                return totalExp;
            };

            const updateHeaderProfile = (profile, titles) => {
                if (!profile) {
                    headerUserName.textContent = "Nepřihlášen";
                    headerUserTitle.textContent = "Host";
                    headerAvatarWrapper.innerHTML = `<span>?</span>`;
                    headerCreditsValue.textContent = '0';
                    headerLevelValue.textContent = '1';
                    headerExpProgress.style.width = '0%';
                    headerExpText.textContent = '0/100';
                    return;
                }
                const displayName = `${profile.first_name || ''} ${profile.last_name || ''}`.trim() || profile.username || profile.email.split('@')[0];
                headerUserName.textContent = displayName;
                const initials = getInitials(profile, profile.email);
                const avatarUrl = profile.avatar_url;
                if (avatarUrl) {
                    headerAvatarWrapper.innerHTML = `<img src="${avatarUrl}?t=${new Date().getTime()}" alt="Avatar" class="vyuka-header-avatar-img">`;
                    headerAvatarWrapper.querySelector('img').onerror = () => { headerAvatarWrapper.innerHTML = `<span>${initials}</span>`; };
                } else {
                    headerAvatarWrapper.innerHTML = `<span>${initials}</span>`;
                }
                let displayTitle = 'Pilot';
                if (profile.selected_title && titles.length > 0) {
                    const foundTitle = titles.find(t => t.title_key === profile.selected_title);
                    if (foundTitle) displayTitle = foundTitle.name;
                }
                headerUserTitle.textContent = displayTitle;
                headerCreditsValue.textContent = profile.points || 0;
                const currentLevel = profile.level || 1;
                const currentExperience = profile.experience || 0;
                headerLevelValue.textContent = currentLevel;
                const expForCurrentLevel = getTotalExpThreshold(currentLevel);
                const expForNextLevel = getTotalExpThreshold(currentLevel + 1);
                const expNeededForSpan = expForNextLevel - expForCurrentLevel;
                const currentExpInLevelSpan = Math.max(0, currentExperience - expForCurrentLevel);
                let percentage = (expNeededForSpan > 0) ? Math.min(100, Math.round((currentExpInLevelSpan / expNeededForSpan) * 100)) : 0;
                headerExpProgress.style.width = `${percentage}%`;
                headerExpText.textContent = `${currentExpInLevelSpan}/${expNeededForSpan > 0 ? expNeededForSpan : 'MAX'}`;
            };

            async function loadUserData() {
                if (!supabase) { updateHeaderProfile(null, []); return; }
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user) {
                        const [profileResponse, titlesResponse] = await Promise.all([
                            supabase.from('profiles').select('first_name, last_name, username, email, avatar_url, selected_title, level, experience, points').eq('id', user.id).single(),
                            supabase.from('title_shop').select('title_key, name')
                        ]);
                        if (profileResponse.error && profileResponse.error.code !== 'PGRST116') throw profileResponse.error;
                        if (titlesResponse.error) throw titlesResponse.error;
                        updateHeaderProfile(profileResponse.data, titlesResponse.data || []);
                    } else {
                        updateHeaderProfile(null, []);
                    }
                } catch (error) {
                    console.error("Error loading user data:", error);
                    updateHeaderProfile(null, []);
                }
            }

            loadUserData();
        });
    </script>
</body>
</html>