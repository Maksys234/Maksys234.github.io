<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* CSS (Stejné jako předtím, přidány skeleton styly) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        :root {
            --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9;
            --success: #4cc9f0; --danger: #f72585; --warning: #f8961e;
            --info: #4895ef; --dark: #1e2a3a; --light: #f8f9fa; --gray: #6c757d;
            --gray-light: #dee2e6; --gray-dark: #343a40;
            --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3);
            --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee);
            --gradient-3: linear-gradient(135deg, #f72585, #7209b7);
            --white: #ffffff; --sidebar-width: 260px; --transition-speed: 0.3s;
            --card-radius: 16px; --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.07); --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --text-primary: #2d3748; --text-secondary: #4a5568; --text-muted: #718096;
            --skeleton-bg: #e0e0e0; /* Barva pro skeleton */
        }
        body { background-color: #f6f8ff; color: var(--text-primary); min-height: 100vh; display: flex; overflow-x: hidden; }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-1); color: var(--white); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 100; box-shadow: var(--shadow-lg); transition: all var(--transition-speed) ease; }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; }
        .sidebar-logo { font-size: 1.5rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo i { font-size: 1.75rem; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .sidebar-item { margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; color: rgba(255, 255, 255, 0.85); text-decoration: none; border-radius: 12px; transition: all 0.2s ease; font-weight: 500; }
        .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; width: 24px; text-align: center; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--white); }
        .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); text-align: center; }
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.1); border-radius: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-weight: 500; overflow: hidden; color: var(--white); }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; }
        .user-name { font-weight: 600; font-size: 0.95rem; }
        .user-role { font-size: 0.8rem; opacity: 0.8; }
        main { flex: 1; margin-left: var(--sidebar-width); padding: 1.5rem 2rem; transition: margin var(--transition-speed) ease; width: calc(100% - var(--sidebar-width)); }
        .dashboard-header { margin-bottom: 2rem; background-color: var(--white); border-radius: var(--card-radius); padding: 1.25rem 1.5rem; box-shadow: var(--shadow-sm); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .header-content > div:first-child { display: flex; align-items: center; gap: 1rem; flex-grow: 1; }
        .header-content h1 { font-size: 1.75rem; font-weight: 600; color: var(--dark); margin: 0; }
        .header-actions { display: flex; align-items: center; gap: 1.5rem; }
        .search-box { position: relative; }
        .search-box input { width: 280px; height: 44px; border-radius: 22px; padding: 0 1rem 0 2.5rem; border: 1px solid var(--gray-light); background-color: var(--light); outline: none; transition: all 0.2s ease; font-size: 0.95rem; }
        .search-box input:focus { border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15); }
        .search-box i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .notifications { position: relative; cursor: pointer; }
        .notifications i { font-size: 1.4rem; color: var(--gray-dark); }
        .notification-badge { position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: var(--danger); color: white; font-size: 0.7rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .main-content { display: grid; gap: 1.75rem; }
        .section-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1.25rem; color: var(--dark); }
        .welcome-banner { background: var(--gradient-2); border-radius: var(--card-radius); box-shadow: var(--shadow-md); overflow: hidden; position: relative; }
        .welcome-content { display: flex; justify-content: space-between; align-items: center; padding: 2.5rem 3rem; position: relative; z-index: 1; }
        .welcome-text-content { max-width: 60%; color: var(--white); }
        .welcome-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 1rem; }
        .welcome-text { font-size: 1rem; margin-bottom: 1.5rem; opacity: 0.9; line-height: 1.6; }
        .welcome-button { background-color: var(--white); color: var(--primary); border: none; border-radius: 12px; padding: 0.75rem 1.5rem; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        .welcome-button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); }
        .welcome-image { width: 300px; height: 200px; display: flex; align-items: center; justify-content: center; }
        .welcome-image img { max-width: 100%; max-height: 100%; }
        .stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .stat-card { background-color: var(--white); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); overflow: hidden; transition: all 0.3s ease; min-height: 190px; /* Min height for skeleton */ position: relative; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .stat-card-content { display: flex; padding: 1.5rem; align-items: center; justify-content: space-between; }
        .stat-card-info { flex-grow: 1; }
        .stat-card-title { font-size: 1rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.75rem; }
        .stat-card-value { font-size: 2rem; font-weight: 700; color: var(--dark); margin-bottom: 0.5rem; min-height: 36px; /* Prevent layout shift */ }
        .stat-card-change { font-size: 0.85rem; color: var(--text-muted); min-height: 20px; /* Prevent layout shift */ }
        .stat-card-change.positive { color: #10b981; }
        .stat-card-change.negative { color: var(--danger); }
        .stat-card-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--white); flex-shrink: 0; }
        .progress-icon { background: linear-gradient(135deg, #4cc9f0, #4361ee); }
        .points-icon { background: linear-gradient(135deg, #f8961e, #f3722c); }
        .streak-icon { background: linear-gradient(135deg, #f72585, #b5179e); }
        .stat-card-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--gray-light); position: absolute; bottom: 0; left: 0; right: 0; background: var(--white); border-radius: 0 0 var(--card-radius) var(--card-radius); }
        .stat-card-footer a { display: block; color: var(--primary); text-decoration: none; font-weight: 500; font-size: 0.9rem; transition: all 0.2s ease; }
        .stat-card-footer a i { margin-left: 0.5rem; transition: transform 0.2s ease; }
        .stat-card-footer a:hover i { transform: translateX(3px); }
        .shortcut-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .shortcut-card { background-color: var(--white); border-radius: var(--card-radius); padding: 1.5rem; box-shadow: var(--shadow-sm); text-decoration: none; color: var(--text-primary); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; text-align: center; border: 1px solid transparent; }
        .shortcut-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--primary-light); }
        .shortcut-icon { width: 70px; height: 70px; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; margin-bottom: 1rem; background-color: #f0f5ff; color: var(--primary); transition: all 0.3s ease; }
        .shortcut-card:hover .shortcut-icon { background-color: var(--primary); color: var(--white); }
        .shortcut-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--dark); }
        .shortcut-desc { font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; }
        .activity-list { background-color: var(--white); border-radius: var(--card-radius); box-shadow: var(--shadow-sm); overflow: hidden; min-height: 200px; position: relative; }
        .activity-item { display: flex; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--gray-light); transition: background-color 0.2s ease; }
        .activity-item:last-child { border-bottom: none; }
        .activity-item:hover { background-color: #f8faff; }
        .activity-icon { width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 1rem; color: white; flex-shrink: 0; }
        .activity-icon.completed { background: linear-gradient(135deg, #10b981, #059669); }
        .activity-icon.badge { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .activity-icon.streak { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .activity-icon.default { background: linear-gradient(135deg, var(--gray), var(--gray-dark)); }
        .activity-content { flex-grow: 1; }
        .activity-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem; color: var(--dark); }
        .activity-desc { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .activity-time { font-size: 0.8rem; color: var(--text-muted); }
        .view-all-link { display: block; text-align: center; padding: 1rem; color: var(--primary); text-decoration: none; font-weight: 500; background-color: var(--white); border-radius: 0 0 var(--card-radius) var(--card-radius); box-shadow: var(--shadow-sm); margin-top: 1rem; transition: all 0.2s ease; }
        .view-all-link i { margin-left: 0.5rem; transition: transform 0.2s ease; }
        .view-all-link:hover i { transform: translateX(3px); }
        .dashboard-footer { margin-top: 2rem; padding: 1.5rem 0; text-align: center; color: var(--text-muted); font-size: 0.9rem; border-top: 1px solid var(--gray-light); }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; font-size: 1rem; color: var(--text-muted); width: 100%; justify-content: center; align-items: center; gap: 10px; }
        .loading::after { content: ""; width: 20px; height: 20px; border: 2px solid var(--primary); border-radius: 50%; border-top-color: transparent; animation: loading-spinner 0.8s linear infinite; }
        @keyframes loading-spinner { to { transform: rotate(360deg); } }
        .activity-list .empty-state { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; padding: 2rem; text-align: center; color: var(--text-secondary); }
        .activity-list .empty-state i { font-size: 2rem; margin-bottom: 1rem; color: var(--info); }
        .activity-list .empty-state p { margin-bottom: 0; }
        .activity-list .empty-state p + p { font-size: 0.9rem; margin-top: 0.5rem; }
        .error-message { background-color: #fff2f5; border-left: 4px solid var(--danger); color: var(--danger); padding: 1rem; margin: 1rem 0; border-radius: 8px; font-size: 0.9rem; display: flex; align-items: center; }
        .error-message i { margin-right: 0.75rem; font-size: 1.25rem; }
        .error-container { display: none; margin-bottom: 1.5rem; }
        .retry-button { background-color: var(--primary); color: white; border: none; border-radius: 8px; padding: 0.5rem 1rem; font-size: 0.9rem; cursor: pointer; margin-top: 0.5rem; transition: all 0.2s ease; }
        .retry-button:hover { background-color: var(--secondary); }
        .offline-banner { display: none; background-color: var(--warning); color: white; padding: 0.75rem; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .toast { position: fixed; bottom: 20px; right: 20px; background-color: var(--white); color: var(--text-primary); border-radius: 8px; padding: 1rem; box-shadow: var(--shadow-lg); max-width: 300px; z-index: 1001; display: flex; align-items: center; transform: translateY(120px); opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast i { margin-right: 0.75rem; font-size: 1.25rem; }
        .toast.success i { color: #10b981; }
        .toast.error i { color: var(--danger); }
        .toast.warning i { color: var(--warning); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Skeleton Loader Styles */
        .skeleton { background-color: var(--skeleton-bg); border-radius: 4px; animation: skeleton-loading 1.5s infinite linear; background-image: linear-gradient(90deg, var(--skeleton-bg) 0px, #f5f5f5 40px, var(--skeleton-bg) 80px); background-size: 600px; }
        .skeleton.title { height: 20px; width: 60%; margin-bottom: 0.75rem; }
        .skeleton.value { height: 36px; width: 40%; margin-bottom: 0.5rem; }
        .skeleton.text { height: 16px; width: 80%; margin-bottom: 0.25rem; }
        .skeleton.text-short { width: 50%; }
        .skeleton.icon-placeholder { width: 60px; height: 60px; border-radius: 50%; flex-shrink: 0; }
        .skeleton.activity-icon-placeholder { width: 50px; height: 50px; border-radius: 15px; margin-right: 1rem; flex-shrink: 0; }
        .skeleton.activity-line { height: 18px; width: 70%; margin-bottom: 0.5rem; }
        .skeleton.activity-line-short { width: 40%; margin-top: 0.25rem; height: 14px; }
        /* Apply skeleton to stat cards during loading */
        .stat-card.loading .stat-card-content { visibility: hidden; } /* Hide real content */
        .stat-card.loading::after { /* Skeleton overlay */ content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .stat-card.loading::after { background: transparent; /* Make overlay transparent */ } /* Needed to allow skeleton placement */
        /* Explicit skeleton elements inside the loading card */
        .stat-card.loading .stat-card-skeleton-content { visibility: visible; position: absolute; top: 0; left: 0; right: 0; bottom: 0; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; pointer-events: none; }
        .stat-card.loading .stat-card-skeleton-info { flex-grow: 1; }
        /* Apply skeleton to activity list during loading */
        .activity-list.loading { min-height: 200px; /* Ensure space for loader */ }
        .activity-list.loading .activity-item { display: none; } /* Hide actual items if any */
        .activity-list.loading .loading-placeholder { /* Container for skeleton items */ display: block; }
        .activity-list .skeleton-activity-item { display: flex; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--gray-light); }
        .activity-list .skeleton-activity-item:last-child { border-bottom: none; }

        /* Media Queries */
        @media (max-width: 1200px) { .welcome-content { padding: 2rem; } .welcome-text-content { max-width: 100%; } .welcome-image { display: none; } }
        @media (max-width: 992px) { :root { --sidebar-width: 80px; } main { margin-left: 80px; width: calc(100% - 80px); } .sidebar { width: 80px; } .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; } .sidebar-link i { margin-right: 0; font-size: 1.5rem; } .sidebar-logo i { margin-right: 0; } .sidebar-header, .sidebar-link { justify-content: center; } .user-profile { justify-content: center; padding: 0.75rem; } .user-avatar { margin-right: 0; } .search-box input { width: 200px; } .mobile-menu-toggle { display: block; } }
        @media (max-width: 768px) { main { padding: 1rem; margin-left: 80px; width: calc(100% - 80px); } .header-content { flex-direction: column; align-items: flex-start; gap: 1rem; } .header-actions { width: 100%; justify-content: space-between; } .search-box input { width: 100%; } .stat-cards, .shortcut-grid { grid-template-columns: 1fr; } .welcome-button { width: 100%; text-align: center;} }
        @media (max-width: 576px) { :root { --sidebar-width: 0; } main { margin-left: 0; width: 100%; } .sidebar { transform: translateX(-100%); width: 260px; z-index: 1000; } .sidebar.active { transform: translateX(0); } .search-box { display: none; } .header-actions { justify-content: flex-end; gap: 1rem; } .mobile-menu-toggle { display: block; } }
        @media (prefers-color-scheme: dark) { :root { /* Dark mode variables */ --white: #1a202c; --light: #2d3748; --dark: #e2e8f0; --gray-light: #4a5568; --text-primary: #e2e8f0; --text-secondary: #cbd5e0; --text-muted: #a0aec0; --skeleton-bg: #2d3748; } body { background-color: #171923; } .dashboard-header, .stat-card, .shortcut-card, .activity-list, .view-all-link, .toast { background-color: #1e2533; border-color: var(--gray-light); } .search-box input { background-color: #2d3748; color: var(--text-primary); border-color: #4a5568; } .search-box i { color: #a0aec0; } .welcome-button { background-color: #2d3748; color: #4cc9f0; } .shortcut-icon { background-color: #2d3748; } .activity-item:hover { background-color: #242c3b; } .toast { border: 1px solid var(--gray-light); } .dashboard-footer { border-top-color: var(--gray-light); } .mobile-menu-toggle { color: var(--text-primary); } .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.1); } .error-message { background-color: rgba(247, 37, 133, 0.1); } .stat-card-footer { background-color: #1e2533; } .skeleton { background-image: linear-gradient(90deg, #2d3748 0px, #4a5568 40px, #2d3748 80px); } }
        .mobile-menu-toggle { display: none; background: none; border: none; color: var(--dark); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; margin-right: 0.5rem; z-index: 101; }
        @media (max-width: 992px) { .mobile-menu-toggle { display: block; } }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.55); z-index: 99; opacity: 0; transition: opacity var(--transition-speed) ease; backdrop-filter: blur(4px); }
        .sidebar-overlay.active { display: block; opacity: 1; }
        .initial-loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f6f8ff; /* Match light body bg */ z-index: 1001; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 1rem; }
        @media (prefers-color-scheme: dark) { .initial-loading-overlay { background-color: #171923; /* Match dark body bg */ } }
        .initial-loading-overlay .loading::after { width: 30px; height: 30px; border-width: 3px; }
        .initial-loading-overlay p { color: var(--text-secondary); }
        main { display: none; /* Initially hidden */ }
        main.loaded { display: block; /* Shown by JS after auth */ }

    </style>
</head>
<body>
    <div class="initial-loading-overlay" id="initial-loader">
         <div class="loading">Ověřování...</div>
         <p>Prosím čekejte</p>
     </div>

    <div class="offline-banner" id="offline-banner"> <i class="fas fa-wifi"></i> Momentálně jste offline. Některé funkce nemusí fungovat správně. </div>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
             <button class="mobile-menu-toggle" id="sidebar-close-toggle" style="color: var(--white); margin-right: 1rem; display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer;"> <i class="fas fa-times"></i> </button>
            <a href="/" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-item"> <a href="/dashboard.html" class="sidebar-link active"> <i class="fas fa-th-large"></i> <span>Dashboard</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li>
            <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li>
        </ul>
        <div class="user-profile">
            <div class="user-avatar" id="sidebar-avatar">?</div>
            <div class="user-info"> <div class="user-name" id="sidebar-name">Načítání...</div> <div class="user-role">Student</div> </div>
        </div>
        <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main id="main-content"> <div class="error-container" id="global-error"></div>

        <header class="dashboard-header">
            <div class="header-content">
                 <div> <button class="mobile-menu-toggle" id="main-mobile-menu-toggle"> <i class="fas fa-bars"></i> </button> <h1>Dashboard</h1> </div>
                <div class="header-actions">
                    <div class="search-box"> <i class="fas fa-search"></i> <input type="text" placeholder="Hledat..."> </div>
                    <div class="notifications"> <i class="fas fa-bell"></i> <span class="notification-badge" id="notification-count">0</span> </div>
                </div>
            </div>
        </header>

        <div class="main-content"> <section class="welcome-banner"> <div class="welcome-content">
                    <div class="welcome-text-content">
                        <h2 class="welcome-title">Vítejte ve vašem Dashboardu</h2>
                        <p class="welcome-text">Zde můžete spravovat nastavení profilu, sledovat svůj pokrok a procvičovat své dovednosti.</p>
                        <button class="welcome-button" id="start-practice-btn">Začít procvičovat</button>
                    </div>
                    <div class="welcome-image">
                        <svg width="200" height="150" viewBox="0 0 200 150" fill="none" xmlns="http://www.w3.org/2000/svg"> <rect width="200" height="150" rx="10" fill="url(#paint0_linear_dash)"/> <circle cx="50" cy="75" r="20" fill="#FFF" opacity="0.3"/> <rect x="100" y="50" width="80" height="10" rx="5" fill="#FFF" opacity="0.5"/> <rect x="100" y="70" width="60" height="10" rx="5" fill="#FFF" opacity="0.4"/> <rect x="100" y="90" width="70" height="10" rx="5" fill="#FFF" opacity="0.3"/> <defs> <linearGradient id="paint0_linear_dash" x1="0" y1="0" x2="200" y2="150" gradientUnits="userSpaceOnUse"> <stop stop-color="#FFF" stop-opacity="0.3"/> <stop offset="1" stop-color="#FFF" stop-opacity="0"/> </linearGradient> </defs> </svg>
                    </div>
                </div>
            </section>

            <section class="stats-section">
                <h2 class="section-title">Váš pokrok</h2>
                <div class="stat-cards">
                    <div class="stat-card loading" id="progress-card">
                         <div class="stat-card-skeleton-content">
                              <div class="stat-card-skeleton-info">
                                   <div class="skeleton title"></div>
                                   <div class="skeleton value"></div>
                                   <div class="skeleton text"></div>
                              </div>
                              <div class="skeleton icon-placeholder"></div>
                         </div>
                         <div class="stat-card-content" style="visibility: hidden;"> <div class="stat-card-info"> <div class="stat-card-title">Celkový pokrok</div> <div class="stat-card-value">- %</div> <div class="stat-card-change">Načítání...</div> </div>
                              <div class="stat-card-icon progress-icon"> <i class="fas fa-chart-line"></i> </div>
                         </div>
                         <div class="stat-card-footer"> <a href="/dashboard/pokrok.html">Zobrazit podrobnosti <i class="fas fa-chevron-right"></i></a> </div>
                    </div>
                     <div class="stat-card loading" id="points-card">
                          <div class="stat-card-skeleton-content">
                               <div class="stat-card-skeleton-info">
                                    <div class="skeleton title"></div>
                                    <div class="skeleton value"></div>
                                    <div class="skeleton text"></div>
                               </div>
                               <div class="skeleton icon-placeholder"></div>
                          </div>
                          <div class="stat-card-content" style="visibility: hidden;">
                               <div class="stat-card-info"> <div class="stat-card-title">Body</div> <div class="stat-card-value">-</div> <div class="stat-card-change">Načítání...</div> </div>
                               <div class="stat-card-icon points-icon"> <i class="fas fa-star"></i> </div>
                          </div>
                          <div class="stat-card-footer"> <a href="/dashboard/oceneni.html">Zobrazit odměny <i class="fas fa-chevron-right"></i></a> </div>
                     </div>
                     <div class="stat-card loading" id="streak-card">
                          <div class="stat-card-skeleton-content">
                               <div class="stat-card-skeleton-info">
                                    <div class="skeleton title"></div>
                                    <div class="skeleton value"></div>
                                    <div class="skeleton text"></div>
                               </div>
                               <div class="skeleton icon-placeholder"></div>
                          </div>
                           <div class="stat-card-content" style="visibility: hidden;">
                               <div class="stat-card-info"> <div class="stat-card-title">Dnů v řadě</div> <div class="stat-card-value">-</div> <div class="stat-card-change">Načítání...</div> </div>
                               <div class="stat-card-icon streak-icon"> <i class="fas fa-fire"></i> </div>
                           </div>
                          <div class="stat-card-footer"> <a href="/dashboard/procvicovani/main.html">Procvičovat <i class="fas fa-chevron-right"></i></a> </div>
                     </div>
                </div>
            </section>

            <section class="shortcuts-section">
                <h2 class="section-title">Rychlé odkazy</h2>
                <div class="shortcut-grid">
                    <a href="/dashboard/procvicovani/main.html" class="shortcut-card"> <div class="shortcut-icon"> <i class="fas fa-book-open"></i> </div> <h3 class="shortcut-title">Procvičování</h3> <p class="shortcut-desc">Procvičte si své znalosti a dovednosti v různých tématech.</p> </a>
                    <a href="/dashboard/pokrok.html" class="shortcut-card"> <div class="shortcut-icon"> <i class="fas fa-chart-line"></i> </div> <h3 class="shortcut-title">Pokrok</h3> <p class="shortcut-desc">Sledujte svůj pokrok a úspěchy v jednotlivých oblastech.</p> </a>
                    <a href="/dashboard/materialy.html" class="shortcut-card"> <div class="shortcut-icon"> <i class="fas fa-file-alt"></i> </div> <h3 class="shortcut-title">Materiály</h3> <p class="shortcut-desc">Prohlédněte si výukové materiály a studijní zdroje.</p> </a>
                    <a href="/dashboard/profile.html" class="shortcut-card"> <div class="shortcut-icon"> <i class="fas fa-user-cog"></i> </div> <h3 class="shortcut-title">Profil</h3> <p class="shortcut-desc">Upravte své osobní údaje a nastavení profilu.</p> </a>
                </div>
            </section>

            <section class="activity-section">
                <h2 class="section-title">Nedávné aktivity</h2>
                <div class="activity-list loading" id="activity-list">
                    <div class="loading-placeholder">
                         <div class="skeleton-activity-item">
                             <div class="skeleton activity-icon-placeholder"></div>
                             <div style="flex-grow: 1;">
                                 <div class="skeleton activity-line"></div>
                                 <div class="skeleton activity-line text-short"></div>
                                 <div class="skeleton activity-line-short"></div>
                             </div>
                         </div>
                          <div class="skeleton-activity-item">
                             <div class="skeleton activity-icon-placeholder"></div>
                             <div style="flex-grow: 1;">
                                 <div class="skeleton activity-line"></div>
                                 <div class="skeleton activity-line text-short"></div>
                                 <div class="skeleton activity-line-short"></div>
                             </div>
                         </div>
                          <div class="skeleton-activity-item">
                             <div class="skeleton activity-icon-placeholder"></div>
                             <div style="flex-grow: 1;">
                                 <div class="skeleton activity-line"></div>
                                 <div class="skeleton activity-line text-short"></div>
                                 <div class="skeleton activity-line-short"></div>
                             </div>
                         </div>
                     </div>
                    </div>
                <a href="/dashboard/pokrok.html" class="view-all-link">Zobrazit všechny aktivity <i class="fas fa-chevron-right"></i></a>
            </section>
        </div>

        <footer class="dashboard-footer">
            <p>&copy; 2025 Justax. Všechna práva vyhrazena.</p>
        </footer>
    </main>

    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <div id="toast-message">Operace byla úspěšně dokončena.</div>
    </div>

    <script>
        // Using an immediately invoked function expression (IIFE) to scope variables
        (function() {
            // --- START: Initialization and Configuration ---
            const supabaseUrl = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
            let supabase = null;
            let currentUser = null;
            let currentProfile = null;

            // DOM Elements Cache
            const ui = {
                sidebarAvatar: document.getElementById('sidebar-avatar'),
                sidebarName: document.getElementById('sidebar-name'),
                notificationCount: document.getElementById('notification-count'),
                offlineBanner: document.getElementById('offline-banner'),
                globalError: document.getElementById('global-error'),
                activityList: document.getElementById('activity-list'),
                progressCard: document.getElementById('progress-card'),
                pointsCard: document.getElementById('points-card'),
                streakCard: document.getElementById('streak-card'),
                startPracticeBtn: document.getElementById('start-practice-btn'),
                mainMobileMenuToggle: document.getElementById('main-mobile-menu-toggle'),
                sidebarCloseToggle: document.getElementById('sidebar-close-toggle'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                toast: document.getElementById('toast'),
                toastMessage: document.getElementById('toast-message'),
                initialLoader: document.getElementById('initial-loader'),
                mainContent: document.getElementById('main-content'),
                mainContentContainer: document.querySelector('.main-content') // For adding 'loaded' class
            };
            // --- END: Initialization and Configuration ---


            // --- START: Helper Functions ---
             function showToast(message, type = 'success') {
                 if (!ui.toast || !ui.toastMessage) return;
                 ui.toastMessage.textContent = message;
                 const icon = ui.toast.querySelector('i');
                 const colors = { success: '#10b981', error: 'var(--danger)', warning: 'var(--warning)', info: 'var(--info)' };
                 if (icon) {
                     icon.className = `fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}`;
                     icon.style.color = colors[type] || colors.info;
                 }
                 ui.toast.className = `toast ${type}`;
                 ui.toast.classList.add('show');
                 // Automatically hide toast after 5 seconds
                 setTimeout(() => {
                     if (ui.toast) ui.toast.classList.remove('show');
                 }, 5000);
             }

             function showError(message) {
                 if (!ui.globalError) return;
                 ui.globalError.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><div><div>${message}</div><button class="retry-button" id="retry-btn">Zkusit znovu</button></div></div>`;
                 ui.globalError.style.display = 'block';
                 const retryBtn = document.getElementById('retry-btn');
                 if (retryBtn) {
                     retryBtn.addEventListener('click', () => {
                         hideError();
                         // Determine current user state and attempt reload
                         if (currentUser) {
                            showLoadingIndicators(); // Show loading states again
                            loadDashboardData(currentUser);
                         } else {
                              console.warn("Retry clicked, but no current user found. Re-checking auth.");
                              // Reload the whole page might be safest here if auth state is uncertain
                              window.location.reload();
                         }
                     });
                 }
             }

             function hideError() { if (ui.globalError) ui.globalError.style.display = 'none'; }

             function updateOnlineStatus() {
                 if (ui.offlineBanner) ui.offlineBanner.style.display = navigator.onLine ? 'none' : 'block';
                 if (!navigator.onLine) showToast('Jste offline. Některé funkce nemusí být dostupné.', 'warning');
             }

             function getInitials(userData) {
                 if (!userData) return '?';
                 const first = userData.first_name?.[0] || ''; const last = userData.last_name?.[0] || '';
                 const usernameInitial = userData.username?.[0] || ''; const emailInitial = userData.email?.[0] || '';
                 return (first + last).toUpperCase() || usernameInitial.toUpperCase() || emailInitial.toUpperCase() || '?';
             }

             function formatRelativeTime(timestamp) {
                 if (!timestamp) return '';
                 try {
                     const now = new Date(); const date = new Date(timestamp);
                     if (isNaN(date.getTime())) return '-';
                     const diffMs = now - date; const diffSec = Math.round(diffMs / 1000);
                     const diffMin = Math.round(diffSec / 60); const diffHour = Math.round(diffMin / 60);
                     const diffDay = Math.round(diffHour / 24); const diffWeek = Math.round(diffDay / 7);
                     if (diffSec < 60) return 'Právě teď'; if (diffMin < 60) return `Před ${diffMin} min`;
                     if (diffHour < 24) return `Před ${diffHour} h`; if (diffDay === 1) return `Včera`;
                     if (diffDay < 7) return `Před ${diffDay} dny`; if (diffWeek <= 4) return `Před ${diffWeek} týdny`;
                     return date.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'numeric', year: 'numeric' });
                 } catch(e) { console.error("Chyba formátování času:", e, "Timestamp:", timestamp); return '-'; }
             }

             function openMenu() { if (ui.sidebar && ui.sidebarOverlay) { ui.sidebar.classList.add('active'); ui.sidebarOverlay.classList.add('active'); } }
             function closeMenu() { if (ui.sidebar && ui.sidebarOverlay) { ui.sidebar.classList.remove('active'); ui.sidebarOverlay.classList.remove('active'); } }

             // Function to show skeleton loaders
             function showLoadingIndicators() {
                 // Stats Cards
                 if (ui.progressCard) ui.progressCard.classList.add('loading');
                 if (ui.pointsCard) ui.pointsCard.classList.add('loading');
                 if (ui.streakCard) ui.streakCard.classList.add('loading');

                 // Activity List
                 if (ui.activityList) {
                     ui.activityList.classList.add('loading');
                     // Ensure skeleton placeholder is visible if it exists
                     const placeholder = ui.activityList.querySelector('.loading-placeholder');
                     if (placeholder) placeholder.style.display = 'block';
                     // Hide any existing items or empty state
                     ui.activityList.querySelectorAll('.activity-item, .empty-state').forEach(el => el.style.display = 'none');
                 }
             }

             // Function to hide skeleton loaders and remove loading classes
             function hideLoadingIndicators() {
                  if (ui.progressCard) ui.progressCard.classList.remove('loading');
                  if (ui.pointsCard) ui.pointsCard.classList.remove('loading');
                  if (ui.streakCard) ui.streakCard.classList.remove('loading');
                  if (ui.activityList) {
                       ui.activityList.classList.remove('loading');
                       const placeholder = ui.activityList.querySelector('.loading-placeholder');
                       if (placeholder) placeholder.style.display = 'none'; // Hide skeleton
                       // Make sure actual content items (if any) are visible
                        ui.activityList.querySelectorAll('.activity-item').forEach(el => el.style.display = 'flex'); // Use flex for items
                  }
             }
            // --- END: Helper Functions ---


            // --- START: Data Loading and UI Update Functions ---
            async function loadUserProfile(user) {
                if (!user) { console.error("loadUserProfile: Missing user object."); return null; }
                try {
                    const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
                    if (error && error.code !== 'PGRST116') throw error; // Handle profile not found gracefully below
                    if (!profile) {
                        console.warn("Profile not found for user:", user.id);
                         return { id: user.id, email: user.email, username: user.email?.split('@')[0] || 'Uživatel', points: 0, streak_days: 0, level: 1 }; // Return default structure
                    }
                    console.log("Profil načten:", profile);
                    return profile;
                } catch (error) {
                    console.error('Chyba při načítání profilu:', error);
                    // Return null to indicate failure, handled by caller
                    return null;
                }
            }

            function updateSidebarProfile(userData) {
                if (!userData || !ui.sidebarName || !ui.sidebarAvatar) return;
                const displayName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim() || userData.username || 'Uživatel';
                ui.sidebarName.textContent = displayName;
                if (userData.avatar_url) { ui.sidebarAvatar.innerHTML = `<img src="${userData.avatar_url}" alt="${displayName}" />`; }
                else { ui.sidebarAvatar.textContent = getInitials(userData); }
                if(ui.notificationCount) ui.notificationCount.textContent = '0';
            }

             // Load user statistics (REVISED)
             async function loadUserStats(userId, profileData) {
                 let statsFromDb = null;
                 // Ensure profileData exists for fallbacks
                 const safeProfileData = profileData || { points: 0, streak_days: 0 }; // Provide defaults if profileData is null
                 const defaultStats = { progress: 0, progress_weekly: 0, points: safeProfileData.points, points_weekly: 0, streak_current: safeProfileData.streak_days, streak_longest: safeProfileData.streak_days };

                 if (!userId) { console.error("loadUserStats: Missing user ID."); return defaultStats; }

                 try {
                     const { data: userStatsData, error: userStatsError } = await supabase.from('user_stats').select('progress, progress_weekly, points_weekly, streak_longest').eq('user_id', userId).maybeSingle();
                     if (userStatsError) { console.warn("Chyba při načítání user_stats:", userStatsError.message); }
                     else { statsFromDb = userStatsData; }
                 } catch (error) { console.error('Neočekávaná chyba při načítání user_stats:', error); }

                 // Combine data - IMPORTANT: Check profileData again *inside* here if it wasn't guaranteed
                 const finalStats = {
                     progress: statsFromDb?.progress ?? 0,
                     progress_weekly: statsFromDb?.progress_weekly ?? 0,
                     points: safeProfileData.points ?? 0, // Use safeProfileData
                     points_weekly: statsFromDb?.points_weekly ?? 0,
                     streak_current: safeProfileData.streak_days ?? 0, // Use safeProfileData
                     streak_longest: Math.max(statsFromDb?.streak_longest ?? 0, safeProfileData.streak_days ?? 0) // Ensure longest isn't less than current
                 };
                 return finalStats;
             }

             // Update stats cards (REVISED - Handles loading state removal)
             function updateStatsCards(stats) {
                 // Remove loading class first
                 if (ui.progressCard) ui.progressCard.classList.remove('loading');
                 if (ui.pointsCard) ui.pointsCard.classList.remove('loading');
                 if (ui.streakCard) ui.streakCard.classList.remove('loading');

                 if (!stats || !ui.progressCard || !ui.pointsCard || !ui.streakCard) { console.warn("updateStatsCards: Chybí data nebo elementy."); return; }

                 const progressValue = ui.progressCard.querySelector('.stat-card-value');
                 const progressChange = ui.progressCard.querySelector('.stat-card-change');
                 const pointsValue = ui.pointsCard.querySelector('.stat-card-value');
                 const pointsChange = ui.pointsCard.querySelector('.stat-card-change');
                 const streakValue = ui.streakCard.querySelector('.stat-card-value');
                 const streakLongest = ui.streakCard.querySelector('.stat-card-change');

                  // Update Progress card safely
                  if (progressValue && progressChange) {
                     progressValue.textContent = `${stats.progress ?? 0}%`;
                     const weeklyChange = stats.progress_weekly ?? 0;
                     progressChange.classList.remove('positive', 'negative');
                     if (weeklyChange > 0) { progressChange.textContent = `+${weeklyChange}% tento týden`; progressChange.classList.add('positive'); }
                     else if (weeklyChange < 0) { progressChange.textContent = `${weeklyChange}% tento týden`; progressChange.classList.add('negative'); }
                     else { progressChange.textContent = `Beze změny tento týden`; }
                     progressCard.querySelector('.stat-card-content').style.visibility = 'visible'; // Make content visible
                 }

                 // Update Points card safely
                 if (pointsValue && pointsChange) {
                     pointsValue.textContent = stats.points ?? 0;
                     const weeklyPoints = stats.points_weekly ?? 0;
                     pointsChange.classList.remove('positive', 'negative');
                     if (weeklyPoints > 0) { pointsChange.textContent = `+${weeklyPoints} tento týden`; pointsChange.classList.add('positive'); }
                     else if (weeklyPoints < 0) { pointsChange.textContent = `${weeklyPoints} tento týden`; pointsChange.classList.add('negative'); }
                     else { pointsChange.textContent = `Beze změny tento týden`; }
                     pointsCard.querySelector('.stat-card-content').style.visibility = 'visible'; // Make content visible
                 }

                 // Update Streak card safely
                 if (streakValue && streakLongest) {
                     streakValue.textContent = stats.streak_current ?? 0;
                     streakLongest.textContent = `Nejdelší: ${stats.streak_longest ?? 0} dnů`;
                     streakLongest.classList.remove('positive', 'negative');
                      streakCard.querySelector('.stat-card-content').style.visibility = 'visible'; // Make content visible
                 }
             }

            // Load user activities
            async function loadUserActivities(userId) {
                try {
                    if (!userId) throw new Error("Missing user ID for activities");
                    const { data: activities, error } = await supabase.from('activities').select('*').eq('user_id', userId).order('created_at', { ascending: false }).limit(5);
                    if (error) throw error;
                    return activities || [];
                } catch (error) {
                    console.error('Chyba při načítání aktivit:', error); return [];
                }
            }

            // Render activities (REVISED - Handles loading state removal)
            function renderActivities(activities) {
                if (!ui.activityList) return;
                ui.activityList.classList.remove('loading'); // Remove loading class
                const placeholder = ui.activityList.querySelector('.loading-placeholder');
                if (placeholder) placeholder.style.display = 'none'; // Hide skeleton

                if (!activities || activities.length === 0) {
                    ui.activityList.innerHTML = `<div class="empty-state"><i class="fas fa-history"></i><p>Zatím žádné nedávné aktivity.</p><p>Začněte procvičovat a vaše úspěchy se zde zobrazí.</p></div>`;
                    return;
                }

                const activityHTML = activities.map(activity => {
                    let iconClass = 'default'; let iconName = 'tasks';
                    const type = activity.type ? activity.type.toLowerCase() : '';
                    if (type.includes('badge')) { iconClass = 'badge'; iconName = 'medal'; }
                    else if (type.includes('streak')) { iconClass = 'streak'; iconName = 'fire'; }
                    else if (type.includes('test') || type.includes('cvičení') || type.includes('úkol')) { iconClass = 'completed'; iconName = 'check-circle'; }
                    const title = activity.title || 'Neznámá aktivita'; const description = activity.description || '';
                    return `<div class="activity-item"><div class="activity-icon ${iconClass}"><i class="fas fa-${iconName}"></i></div><div class="activity-content"><div class="activity-title">${title}</div><div class="activity-desc">${description}</div><div class="activity-time">${formatRelativeTime(activity.created_at)}</div></div></div>`;
                }).join('');
                ui.activityList.innerHTML = activityHTML;
            }
            // --- END: Data Loading and UI Update Functions ---


            // --- START: Main Orchestration ---
            async function loadDashboardData(user) {
                if (!user) { showError("Chyba: Nelze načíst data bez přihlášeného uživatele."); return; }
                console.log("Načítání dat dashboardu pro uživatele:", user.id);
                hideError();
                showLoadingIndicators(); // Show skeletons

                try {
                    // Load profile first, it's crucial
                    const profileData = await loadUserProfile(user);
                    if (!profileData) {
                        throw new Error("Nepodařilo se načíst profil uživatele."); // Throw error if profile fails
                    }
                    currentProfile = profileData; // Set global profile

                    // Update sidebar immediately after profile load
                    updateSidebarProfile(currentProfile);

                    // Load stats and activities (can run in parallel if desired, profile is needed for stats)
                    const [userStats, activities] = await Promise.all([
                        loadUserStats(user.id, currentProfile), // Pass loaded profile
                        loadUserActivities(user.id)
                    ]);

                    // Update UI with results (hides skeletons automatically)
                    updateStatsCards(userStats);
                    renderActivities(activities);

                     // Trigger entrance animations after data is rendered
                     if (ui.mainContentContainer) ui.mainContentContainer.classList.add('loaded');

                } catch (error) {
                    console.error('Chyba při načítání dat dashboardu:', error);
                    showError('Nepodařilo se načíst data dashboardu: ' + error.message);
                    // Hide loading indicators even on error, show empty/error state in cards/list
                    hideLoadingIndicators();
                    // Optionally render cards with default/error state
                    updateStatsCards({}); // Render default/N/A state
                    if (ui.activityList) ui.activityList.innerHTML = '<div class="error-message" style="position: static; transform: none;">Chyba načítání aktivit.</div>';
                }
            }
            // --- END: Main Orchestration ---


            // --- START: Initialization Logic with onAuthStateChange ---
            function initializeApp() {
                try {
                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    console.log('Supabase klient inicializován.');

                    supabase.auth.onAuthStateChange(async (event, session) => {
                        console.log('Auth State Change:', event, session);
                        const user = session?.user;
                        currentUser = user;

                        if (event === 'INITIAL_SESSION' || event === 'SIGNED_IN') {
                            if (user) {
                                console.log('Uživatel přihlášen, načítám dashboard...');
                                if (ui.initialLoader) ui.initialLoader.style.display = 'none';
                                if (ui.mainContent) ui.mainContent.style.display = 'block'; // Zobrazit obsah AŽ po ověření
                                await loadDashboardData(user);
                                setupUIEventListeners();
                            } else {
                                console.log('Stav SIGNED_IN/INITIAL_SESSION, ale chybí session.user, přesměrovávám na login.');
                                window.location.href = '/auth/index.html'; // Adjust path if needed
                            }
                        } else if (event === 'SIGNED_OUT') {
                            console.log('Uživatel odhlášen, přesměrovávám na login.');
                            window.location.href = '/auth/index.html'; // Adjust path if needed
                        }
                    });

                } catch (error) {
                    console.error("Kritická chyba při inicializaci Supabase:", error);
                    if (ui.initialLoader) ui.initialLoader.innerHTML = `<p style="color: var(--danger);">Chyba inicializace. Zkuste obnovit stránku.</p>`;
                }
            }
             // Setup UI event listeners
             function setupUIEventListeners() {
                 if (ui.startPracticeBtn) { ui.startPracticeBtn.addEventListener('click', () => { window.location.href = '/dashboard/procvicovani/main.html'; }); }
                 if (ui.mainMobileMenuToggle) ui.mainMobileMenuToggle.addEventListener('click', openMenu);
                 if (ui.sidebarCloseToggle) ui.sidebarCloseToggle.addEventListener('click', closeMenu); // Assuming close button exists in sidebar HTML
                 if (ui.sidebarOverlay) ui.sidebarOverlay.addEventListener('click', closeMenu);
                 document.querySelectorAll('.sidebar-link').forEach(link => { link.addEventListener('click', () => { if (window.innerWidth <= 992) closeMenu(); }); });
                 window.addEventListener('online', updateOnlineStatus);
                 window.addEventListener('offline', updateOnlineStatus);
                 updateOnlineStatus();
             }

            // --- START THE APP ---
            initializeApp();

        })(); // End of IIFE
    </script>
</body>
</html>