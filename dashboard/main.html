<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax Dashboard</title>
    
    <!-- Performance optimizations -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://qcimhjjwvsbgjsitmvuh.supabase.co">
    
    <!-- Meta tags for SEO and sharing -->
    <meta name="description" content="Justax Dashboard - Modern tax management system">
    <meta name="theme-color" content="#4361ee">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Core CSS -->
    <link rel="stylesheet" href="/styles/common.css">
    <link rel="stylesheet" href="/styles/layout.css">
    <link rel="stylesheet" href="/styles/sidebar.css">
    <link rel="stylesheet" href="/styles/dashboard.css">
    <link rel="stylesheet" href="/styles/components.css">
    <link rel="stylesheet" href="/styles/animations.css">
</head>
<body>
    <!-- Offline indicator -->
    <div class="offline-banner" id="offline-banner">
        <i class="fas fa-wifi"></i> 
        <span>You are currently offline. Some features may be unavailable.</span>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="sidebar-logo">
                <i class="fas fa-calculator"></i>
                <span>Justax</span>
            </a>
        </div>
        
        <ul class="sidebar-menu">
            <li class="sidebar-item">
                <a href="/dashboard" class="sidebar-link active">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="/dashboard/transactions" class="sidebar-link">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Transactions</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="/dashboard/reports" class="sidebar-link">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="/dashboard/documents" class="sidebar-link">
                    <i class="fas fa-file-alt"></i>
                    <span>Documents</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="/dashboard/calendar" class="sidebar-link">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Calendar</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="/dashboard/settings" class="sidebar-link">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </li>
        </ul>

        <div class="user-profile">
            <div class="user-avatar" id="user-avatar"></div>
            <div class="user-info">
                <div class="user-name" id="user-name"></div>
                <div class="user-role" id="user-role"></div>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <!-- Error container -->
        <div id="error-container" class="error-container"></div>

        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-left">
                    <h1>Dashboard</h1>
                    <span class="header-subtitle">Welcome back, <span id="user-greeting"></span></span>
                </div>
                <div class="header-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="search" placeholder="Search..." id="global-search">
                    </div>
                    <button class="btn btn-primary" id="new-transaction-btn">
                        <i class="fas fa-plus"></i>
                        <span>New Transaction</span>
                    </button>
                    <div class="notifications" id="notifications-toggle">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notifications-count">0</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Grid -->
        <div class="dashboard-grid">
            <!-- Overview Section -->
            <section class="section overview-section animate-fade-in">
                <h2 class="section-title">
                    <i class="fas fa-chart-line"></i>
                    Overview
                </h2>
                <div class="overview-cards">
                    <div class="overview-card" id="total-balance"></div>
                    <div class="overview-card" id="monthly-income"></div>
                    <div class="overview-card" id="monthly-expenses"></div>
                    <div class="overview-card" id="pending-tasks"></div>
                </div>
            </section>

            <!-- Recent Transactions -->
            <section class="section transactions-section animate-fade-in delay-1">
                <h2 class="section-title">
                    <i class="fas fa-history"></i>
                    Recent Transactions
                </h2>
                <div class="transactions-list" id="recent-transactions"></div>
            </section>

            <!-- Quick Actions -->
            <section class="section actions-section animate-fade-in delay-2">
                <h2 class="section-title">
                    <i class="fas fa-bolt"></i>
                    Quick Actions
                </h2>
                <div class="actions-grid" id="quick-actions"></div>
            </section>
        </div>
    </main>

    <!-- Modals -->
    <div class="modal" id="transaction-modal"></div>
    <div class="modal" id="notifications-modal"></div>

    <!-- Core JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script type="module">
        import auth from '/js/auth.js';
        import ui from '/js/ui.js';
        import profile from '/js/profile.js';

        // Supabase Configuration
        const SUPABASE_URL = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';

        // Initialize
        auth.init(SUPABASE_URL, SUPABASE_KEY);
        profile.init(auth.supabase);

        // Setup UI handlers
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize UI components
                ui.initializeOfflineHandling();
                
                // Load user profile
                const userProfile = await profile.loadUserProfile();
                if (userProfile) {
                    document.getElementById('user-greeting').textContent = userProfile.username || userProfile.email;
                }

                // Setup event listeners
                setupEventListeners();
                
                // Load initial data
                await loadDashboardData();

            } catch (error) {
                ui.showError(error.message);
            }
        });

        function setupEventListeners() {
            // Global search
            const searchInput = document.getElementById('global-search');
            searchInput.addEventListener('input', debounce(handleSearch, 300));

            // New transaction button
            document.getElementById('new-transaction-btn').addEventListener('click', () => {
                ui.showModal('transaction-modal');
            });

            // Notifications toggle
            document.getElementById('notifications-toggle').addEventListener('click', () => {
                ui.showModal('notifications-modal');
            });
        }

        async function loadDashboardData() {
            ui.showLoading();
            try {
                // Load data from Supabase
                const { data: dashboardData, error } = await auth.supabase
                    .from('dashboard_data')
                    .select('*')
                    .single();

                if (error) throw error;

                // Update UI with real data
                updateDashboardUI(dashboardData);

            } catch (error) {
                ui.showError('Failed to load dashboard data');
            } finally {
                ui.hideLoading();
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function handleSearch(e) {
            const searchTerm = e.target.value.trim();
            if (searchTerm.length < 2) return;

            try {
                ui.showLoading('search-results');
                // Implement search logic
            } catch (error) {
                ui.showError('Search failed. Please try again.');
            } finally {
                ui.hideLoading('search-results');
            }
        }

        function updateDashboardUI(data) {
            // Update overview cards
            updateOverviewCards(data);
            
            // Update recent transactions
            updateTransactionsList(data.recent_transactions);
            
            // Update quick actions
            updateQuickActions();
        }

        // Dashboard UI update functions
        function updateOverviewCards(data) {
            // Implementation
        }

        function updateTransactionsList(transactions) {
            // Implementation
        }

        function updateQuickActions() {
            // Implementation
        }
    </script>
</body>
</html>