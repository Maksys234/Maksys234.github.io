<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Procvičování</title>
    <!-- Připojení fontů -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- MathJax для формул -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        /* Базовые стили */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --dark: #1e2a3a;
            --light: #f8f9fa;
            --gray: #6c757d;
            --gray-light: #dee2e6;
            --gray-dark: #343a40;
            --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3);
            --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee);
            --gradient-3: linear-gradient(135deg, #f72585, #7209b7);
            --gradient-4: linear-gradient(135deg, #f8961e, #f3722c);
            --white: #ffffff;
            --sidebar-width: 260px;
            --transition-speed: 0.3s;
            --card-radius: 16px;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-muted: #718096;
        }

        body {
            background-color: #f6f8ff;
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: var(--gradient-1);
            color: var(--white);
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            z-index: 100;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-speed) ease;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding: 0 0.75rem;
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-logo i {
            font-size: 1.75rem;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .sidebar-item {
            margin-bottom: 0.5rem;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .sidebar-link i {
            margin-right: 0.75rem;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .sidebar-link.active, .sidebar-link:hover {
            background-color: rgba(255, 255, 255, 0.15);
            color: var(--white);
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 1rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-top: 1rem;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-weight: 500;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            flex-grow: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-role {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Hlavní obsah */
        main {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 1.5rem 2rem;
            transition: margin var(--transition-speed) ease;
            width: calc(100% - var(--sidebar-width));
        }

        .dashboard-header {
            margin-bottom: 2rem;
            background-color: var(--white);
            border-radius: var(--card-radius);
            padding: 1.25rem 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content h1 {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--dark);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 280px;
            height: 44px;
            border-radius: 22px;
            padding: 0 1rem 0 2.5rem;
            border: 1px solid var(--gray-light);
            background-color: var(--light);
            outline: none;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }

        .search-box input:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .notifications {
            position: relative;
            cursor: pointer;
        }

        .notifications i {
            font-size: 1.4rem;
            color: var(--gray-dark);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background-color: var(--danger);
            color: white;
            font-size: 0.7rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Основное содержание */
        .main-content {
            display: grid;
            gap: 1.75rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            color: var(--dark);
        }

        /* Категории упражнений */
        .categories-section {
            margin-bottom: 2rem;
        }

        .categories-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1.5rem;
        }

        .category-card {
            background-color: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .category-card.math::before {
            background: var(--gradient-2);
        }

        .category-card.language::before {
            background: var(--gradient-3);
        }

        .category-card.mixed::before {
            background: var(--gradient-4);
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .category-card:hover::before {
            opacity: 1;
        }

        .category-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.5rem;
        }

        .category-icon.math {
            background: var(--gradient-2);
        }

        .category-icon.language {
            background: var(--gradient-3);
        }

        .category-icon.mixed {
            background: var(--gradient-4);
        }

        .category-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .category-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .category-stats {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Упражнения */
        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .exercise-card {
            background-color: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .exercise-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .exercise-header {
            position: relative;
            height: 140px;
            overflow: hidden;
        }

        .exercise-header img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .exercise-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--white);
            z-index: 1;
        }

        .exercise-badge.math {
            background-color: var(--primary);
        }

        .exercise-badge.language {
            background-color: var(--danger);
        }

        .exercise-badge.mixed {
            background-color: var(--warning);
        }

        .exercise-body {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .exercise-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .exercise-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1.25rem;
            flex-grow: 1;
        }

        .exercise-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .exercise-difficulty {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .difficulty-indicator {
            display: flex;
            margin-left: 0.5rem;
        }

        .difficulty-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--gray-light);
            margin-right: 3px;
        }

        .difficulty-dot.active {
            background-color: var(--primary);
        }

        .exercise-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }

        .exercise-time i {
            margin-right: 0.5rem;
        }

        .exercise-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--gradient-1);
            color: white;
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(67, 97, 238, 0.25);
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--text-secondary);
            border: 1px solid var(--gray-light);
        }

        .btn-secondary:hover {
            background-color: var(--gray-light);
        }

        /* Фильтры */
        .filter-section {
            margin-bottom: 2rem;
        }

        .filter-card {
            background-color: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .filter-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        .filter-reset {
            font-size: 0.9rem;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-reset:hover {
            text-decoration: underline;
        }

        .filter-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-group-title {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 0.75rem;
        }

        .filter-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .filter-tag {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            background-color: var(--light);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--gray-light);
        }

        .filter-tag:hover {
            background-color: rgba(67, 97, 238, 0.05);
            border-color: var(--primary-light);
        }

        .filter-tag.active {
            background-color: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        /* Тестовый интерфейс */
        .test-container {
            background-color: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-md);
            padding: 2rem;
            margin-bottom: 2rem;
            display: none; /* По умолчанию скрыт */
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-light);
        }

        .test-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .test-info {
            display: flex;
            gap: 1.5rem;
        }

        .test-info-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .test-info-item i {
            margin-right: 0.5rem;
            color: var(--primary);
        }

        .test-progress {
            height: 8px;
            background-color: var(--gray-light);
            border-radius: 4px;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .test-progress-bar {
            height: 100%;
            background: var(--gradient-2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .question-container {
            margin-bottom: 2rem;
        }

        .question-number {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .question-image {
            max-width: 100%;
            margin-bottom: 1.5rem;
            border-radius: 8px;
        }

        .answers-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .answer-option {
            display: flex;
            align-items: center;
            padding: 1rem 1.25rem;
            border: 1px solid var(--gray-light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .answer-option:hover {
            background-color: rgba(67, 97, 238, 0.05);
            border-color: var(--primary-light);
        }

        .answer-option.selected {
            background-color: rgba(67, 97, 238, 0.1);
            border-color: var(--primary);
        }

        .answer-option.correct {
            background-color: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
        }

        .answer-option.incorrect {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
        }

        .answer-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray);
            border-radius: 4px;
            margin-right: 1rem;
            position: relative;
        }

        .answer-option.selected .answer-checkbox {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .answer-option.selected .answer-checkbox::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 7px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .answer-radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray);
            border-radius: 50%;
            margin-right: 1rem;
            position: relative;
        }

        .answer-option.selected .answer-radio {
            border-color: var(--primary);
        }

        .answer-option.selected .answer-radio::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--primary);
        }

        .answer-text {
            font-size: 1rem;
            color: var(--text-primary);
        }

        .numeric-input-container {
            display: flex;
            margin-top: 1rem;
        }

        .numeric-input {
            flex: 1;
            height: 48px;
            padding: 0 1rem;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .numeric-input:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        .text-input-container {
            display: flex;
            margin-top: 1rem;
        }

        .text-input {
            flex: 1;
            min-height: 100px;
            padding: 1rem;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s ease;
            resize: vertical;
        }

        .text-input:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        .test-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-light);
        }

        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem;
        }

        /* Результаты теста */
        .results-container {
            background-color: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-md);
            padding: 2rem;
            margin-bottom: 2rem;
            display: none; /* По умолчанию скрыт */
        }

        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .results-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .results-score {
            font-size: 3rem;
            font-weight: 700;
            margin: 1.5rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .score-percentage {
            color: var(--primary);
        }

        .score-fraction {
            font-size: 1.5rem;
            color: var(--text-secondary);
        }

        .results-message {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-item {
            text-align: center;
            padding: 1.5rem;
            background-color: var(--light);
            border-radius: 12px;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .summary-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .results-details {
            margin-bottom: 2rem;
        }

        .details-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 1rem;
        }

        .questions-review {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .review-item {
            padding: 1.5rem;
            border: 1px solid var(--gray-light);
            border-radius: 12px;
            background-color: var(--light);
        }

        .review-item.correct {
            border-left: 4px solid #10b981;
        }

        .review-item.incorrect {
            border-left: 4px solid #ef4444;
        }

        .review-question {
            font-size: 1rem;
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 1rem;
        }

        .review-answers {
            margin-bottom: 1rem;
        }

        .review-answer {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .review-answer i {
            margin-right: 0.75rem;
            font-size: 1rem;
        }

        .review-answer i.correct {
            color: #10b981;
        }

        .review-answer i.incorrect {
            color: #ef4444;
        }

        .review-explanation {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--gray-light);
        }

        .results-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        /* Таймер теста */
        .test-timer {
            padding: 0.5rem 1rem;
            background-color: var(--light);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .timer-warning {
            color: var(--warning);
        }

        .timer-danger {
            color: var(--danger);
        }

        /* Загрузка */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(67, 97, 238, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        /* Сообщения об ошибках */
        .error-message {
            background-color: #fff2f5;
            border-left: 4px solid var(--danger);
            color: var(--danger);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }

        .error-message i {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }

        /* Патичка */
        .dashboard-footer {
            margin-top: 2rem;
            padding: 1.5rem 0;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Медиа-запросы */
        @media (max-width: 992px) {
            :root {
                --sidebar-width: 80px;
            }
            
            .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer {
                display: none;
            }
            
            .sidebar-link i {
                margin-right: 0;
                font-size: 1.5rem;
            }
            
            .sidebar-logo i {
                margin-right: 0;
            }
            
            .sidebar-header, .sidebar-link {
                justify-content: center;
            }
            
            .user-profile {
                justify-content: center;
                padding: 0.75rem;
            }
            
            .user-avatar {
                margin-right: 0;
            }
            
            .search-box input {
                width: 200px;
            }
            
            .filter-options {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            main {
                padding: 1rem;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .search-box input {
                width: 100%;
            }
            
            .test-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .test-info {
                width: 100%;
                justify-content: space-between;
            }
            
            .test-navigation {
                flex-direction: column;
                gap: 1rem;
            }
            
            .test-navigation .btn {
                width: 100%;
                justify-content: center;
            }
            
            .results-actions {
                flex-direction: column;
            }
            
            .results-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 576px) {
            :root {
                --sidebar-width: 0;
            }
            
            .sidebar {
                transform: translateX(-100%);
            }
            
            main {
                margin-left: 0;
                width: 100%;
            }
            
            .search-box {
                display: none;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .categories-container {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }

        /* Мобильное меню */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--dark);
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animated {
            animation: fadeIn 0.5s ease forwards;
        }

        .delay-1 {
            animation-delay: 0.1s;
        }

        .delay-2 {
            animation-delay: 0.2s;
        }

        .delay-3 {
            animation-delay: 0.3s;
        }

        /* Темный режим */
        @media (prefers-color-scheme: dark) {
            :root {
                --white: #1a202c;
                --light: #2d3748;
                --dark: #e2e8f0;
                --gray-light: #4a5568;
                --text-primary: #e2e8f0;
                --text-secondary: #cbd5e0;
                --text-muted: #a0aec0;
            }
            
            body {
                background-color: #171923;
            }
            
            .search-box input {
                background-color: #2d3748;
                color: var(--text-primary);
                border-color: #4a5568;
            }
            
            .search-box i {
                color: #a0aec0;
            }
            
            .category-card {
                background-color: #1a202c;
            }
            
            .difficulty-dot {
                background-color: #4a5568;
            }
            
            .filter-tag {
                background-color: #2d3748;
                border-color: #4a5568;
            }
            
            .sort-dropdown {
                background-color: #2d3748;
                border-color: #4a5568;
                color: var(--text-primary);
            }
            
            .btn-secondary {
                background-color: #2d3748;
                border-color: #4a5568;
                color: var(--text-primary);
            }
            
            .answer-option {
                background-color: #1a202c;
                border-color: #4a5568;
            }
            
            .answer-option:hover {
                background-color: #2d3748;
            }
            
            .numeric-input, .text-input {
                background-color: #2d3748;
                color: var(--text-primary);
                border-color: #4a5568;
            }
            
            .test-timer {
                background-color: #2d3748;
            }
            
            .summary-item {
                background-color: #2d3748;
            }
            
            .review-item {
                background-color: #2d3748;
                border-color: #4a5568;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="sidebar-logo">
                <i class="fas fa-calculator"></i>
                <span>Justax</span>
            </a>
        </div>
        
        <ul class="sidebar-menu">
            <li class="sidebar-item">
                <a href="/dashboard/dashboard.html" class="sidebar-link">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="/dashboard/procvicovani.html" class="sidebar-link active">
                    <i class="fas fa-book-open"></i>
                    <span>Procvičování</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="/dashboard/pokrok.html" class="sidebar-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Pokrok</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="/dashboard/oceneni.html" class="sidebar-link">
                    <i class="fas fa-medal"></i>
                    <span>Ocenění</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="/dashboard/materialy.html" class="sidebar-link">
                    <i class="fas fa-file-alt"></i>
                    <span>Materiály</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="/dashboard/profile.html" class="sidebar-link">
                    <i class="fas fa-user-cog"></i>
                    <span>Profil</span>
                </a>
            </li>
        </ul>
        
        <div class="user-profile">
            <div class="user-avatar" id="user-avatar">MS</div>
            <div class="user-info">
                <div class="user-name" id="user-name">Načítání...</div>
                <div class="user-role" id="user-role">Student</div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            &copy; 2025 Justax
        </div>
    </aside>
    
    <main>
        <!-- Ошибки загрузки -->
        <div class="error-container" id="global-error" style="display: none;">
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <div>
                    <div id="global-error-message">Došlo k chybě při načítání dat.</div>
                    <button class="retry-button" id="global-retry-btn">Zkusit znovu</button>
                </div>
            </div>
        </div>

        <header class="dashboard-header">
            <div class="header-content">
                <h1>Procvičování</h1>
                <div class="header-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Hledat...">
                    </div>
                    <div class="notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notification-count">0</span>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <!-- Секция с категориями -->
            <section class="categories-section">
                <h2 class="section-title">Kategorie</h2>
                <div class="categories-container">
                    <div class="category-card math" data-category="math">
                        <div class="category-icon math">
                            <i class="fas fa-square-root-alt"></i>
                        </div>
                        <h3 class="category-title">Matematika</h3>
                        <p class="category-desc">Algebra, geometrie, funkce a další témata</p>
                        <div class="category-stats">15 cvičení</div>
                    </div>
                    
                    <div class="category-card language" data-category="czech">
                        <div class="category-icon language">
                            <i class="fas fa-spell-check"></i>
                        </div>
                        <h3 class="category-title">Český jazyk</h3>
                        <p class="category-desc">Gramatika, literatura, sloh a stylistika</p>
                        <div class="category-stats">12 cvičení</div>
                    </div>
                    
                    <div class="category-card mixed" data-category="mixed">
                        <div class="category-icon mixed">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <h3 class="category-title">Kombinované</h3>
                        <p class="category-desc">Komplexní cvičení z více oblastí</p>
                        <div class="category-stats">8 cvičení</div>
                    </div>
                </div>
            </section>
            
            <!-- Фильтры для упражнений -->
            <section class="filter-section">
                <div class="filter-card">
                    <div class="filter-header">
                        <h3 class="filter-title">Filtry</h3>
                        <div class="filter-reset" id="reset-filters">Resetovat filtry</div>
                    </div>
                    <div class="filter-options">
                        <div class="filter-group">
                            <h4 class="filter-group-title">Obtížnost</h4>
                            <div class="filter-list" id="difficulty-filters">
                                <div class="filter-tag" data-difficulty="1">Lehká</div>
                                <div class="filter-tag" data-difficulty="2">Střední</div>
                                <div class="filter-tag" data-difficulty="3">Vysoká</div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <h4 class="filter-group-title">Čas</h4>
                            <div class="filter-list" id="time-filters">
                                <div class="filter-tag" data-time="5">Do 5 minut</div>
                                <div class="filter-tag" data-time="10">5-10 minut</div>
                                <div class="filter-tag" data-time="15">10-15 minut</div>
                                <div class="filter-tag" data-time="30">Nad 15 minut</div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <h4 class="filter-group-title">Řazení</h4>
                            <select class="sort-dropdown" id="sort-dropdown">
                                <option value="recommended">Doporučené</option>
                                <option value="newest">Nejnovější</option>
                                <option value="difficulty-asc">Od nejlehčích</option>
                                <option value="difficulty-desc">Od nejtěžších</option>
                                <option value="popularity">Nejpopulárnější</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Упражнения -->
            <section class="exercises-section">
                <h2 class="section-title">Dostupná cvičení</h2>
                <div class="exercise-grid" id="exercises-container">
                    <!-- Загрузка упражнений -->
                    <div class="loading-container" id="exercises-loading">
                        <div class="spinner"></div>
                        <div class="loading-text">Načítání cvičení...</div>
                    </div>
                </div>
            </section>
            
            <!-- Тестовый контейнер (появляется при запуске упражнения) -->
            <section class="test-container" id="test-container">
                <div class="test-header">
                    <h2 class="test-title" id="test-title">Název cvičení</h2>
                    <div class="test-info">
                        <div class="test-info-item">
                            <i class="fas fa-clock"></i>
                            <span id="test-time">10 minut</span>
                        </div>
                        <div class="test-info-item">
                            <i class="fas fa-chart-bar"></i>
                            <span id="test-difficulty">Střední obtížnost</span>
                        </div>
                        <div class="test-timer" id="test-timer">
                            <i class="far fa-clock"></i>
                            <span id="timer-display">10:00</span>
                        </div>
                    </div>
                </div>
                
                <div class="test-progress">
                    <div class="test-progress-bar" id="test-progress-bar"></div>
                </div>
                
                <div class="question-container" id="question-container">
                    <!-- Вопросы будут загружены через JavaScript -->
                </div>
                
                <div class="test-navigation">
                    <button class="btn btn-secondary btn-lg" id="prev-question">
                        <i class="fas fa-arrow-left"></i> Předchozí otázka
                    </button>
                    <button class="btn btn-primary btn-lg" id="next-question">
                        Další otázka <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </section>
            
            <!-- Результаты теста (появляются после завершения) -->
            <section class="results-container" id="results-container">
                <div class="results-header">
                    <h2 class="results-title">Výsledky cvičení</h2>
                    <div class="results-score">
                        <span class="score-percentage" id="score-percentage">85%</span>
                        <span class="score-fraction" id="score-fraction">(17/20)</span>
                    </div>
                    <p class="results-message" id="results-message">Výborně! Zvládl(a) jste to velmi dobře.</p>
                </div>
                
                <div class="results-summary">
                    <div class="summary-item">
                        <div class="summary-value" id="summary-correct">17</div>
                        <div class="summary-label">Správných odpovědí</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="summary-incorrect">3</div>
                        <div class="summary-label">Chybných odpovědí</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="summary-time">8:25</div>
                        <div class="summary-label">Celkový čas</div>
                    </div>
                </div>
                
                <div class="results-details">
                    <h3 class="details-title">Přehled otázek</h3>
                    <div class="questions-review" id="questions-review">
                        <!-- Обзор вопросов будет загружен через JavaScript -->
                    </div>
                </div>
                
                <div class="results-actions">
                    <button class="btn btn-secondary btn-lg" id="retry-test">
                        <i class="fas fa-redo"></i> Zkusit znovu
                    </button>
                    <button class="btn btn-primary btn-lg" id="back-to-exercises">
                        <i class="fas fa-th-large"></i> Zpět na cvičení
                    </button>
                </div>
            </section>
        </div>
        
        <footer class="dashboard-footer">
            &copy; 2025 Justax | Všechna práva vyhrazena
        </footer>
    </main>
    
    <script>
        // Конфигурация Supabase
        const SUPABASE_URL = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Глобальные переменные
        let currentUser = null;
        let exercises = [];
        let filteredExercises = [];
        let activeFilters = {
            category: null,
            difficulty: [],
            time: []
        };
        let sortBy = 'recommended';
        
        // Переменные для теста
        let currentTest = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let testStartTime = null;
        let timerInterval = null;
        let testTimeLeft = 0;

        // Инициализация страницы
        document.addEventListener('DOMContentLoaded', async () => {
            // Проверка авторизации
            await checkAuth();
            
            // Загрузка упражнений
            await loadExercises();
            
            // Обработчики событий для фильтров
            initializeFilters();
            
            // Обработчики событий для тестового интерфейса
            initializeTestHandlers();
        });

        // Проверка авторизации
        async function checkAuth() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error || !user) {
                    window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                // Получение профиля пользователя
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (profileError) {
                    showError('Nepodařilo se načíst profil uživatele.');
                    return;
                }
                
                currentUser = {
                    ...user,
                    profile: profile
                };
                
                // Обновление информации о пользователе в UI
                updateUserInfo();
                
            } catch (error) {
                console.error('Authentication error:', error);
                showError('Nastala chyba při ověřování přihlášení.');
            }
        }

        // Обновление информации о пользователе в UI
        function updateUserInfo() {
            if (!currentUser || !currentUser.profile) return;
            
            const avatarElement = document.getElementById('user-avatar');
            const nameElement = document.getElementById('user-name');
            
            if (currentUser.profile.avatar_url) {
                avatarElement.innerHTML = `<img src="${currentUser.profile.avatar_url}" alt="Avatar">`;
            } else {
                // Инициалы пользователя
                const initials = `${currentUser.profile.first_name ? currentUser.profile.first_name[0] : ''}${currentUser.profile.last_name ? currentUser.profile.last_name[0] : ''}`;
                avatarElement.textContent = initials || 'U';
            }
            
            nameElement.textContent = `${currentUser.profile.first_name || ''} ${currentUser.profile.last_name || ''}`.trim() || 'Uživatel';
            
            // Обновление счетчика уведомлений (для демонстрации)
            document.getElementById('notification-count').textContent = '2';
        }

        // Загрузка упражнений из Supabase
        async function loadExercises() {
            try {
                document.getElementById('exercises-loading').style.display = 'flex';
                
                // Получение всех упражнений
                const { data, error } = await supabase
                    .from('exercises')
                    .select('*')
                    .eq('is_published', true)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                exercises = data || [];
                
                // Получение прогресса пользователя
                if (currentUser) {
                    const { data: userExercises, error: userExError } = await supabase
                        .from('user_exercises')
                        .select('*')
                        .eq('user_id', currentUser.id);
                    
                    if (!userExError && userExercises) {
                        // Объединение данных упражнений с прогрессом пользователя
                        exercises = exercises.map(exercise => {
                            const userProgress = userExercises.find(ue => ue.exercise_id === exercise.id);
                            return {
                                ...exercise,
                                userProgress: userProgress || null
                            };
                        });
                    }
                }
                
                // Применение фильтров и отображение
                applyFiltersAndRender();
                
            } catch (error) {
                console.error('Error loading exercises:', error);
                showError('Nepodařilo se načíst cvičení.');
            } finally {
                document.getElementById('exercises-loading').style.display = 'none';
            }
        }

        // Инициализация фильтров
        function initializeFilters() {
            // Обработчики для категорий
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', () => {
                    const category = card.dataset.category;
                    
                    // Переключение активной категории
                    if (activeFilters.category === category) {
                        activeFilters.category = null;
                        document.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
                    } else {
                        activeFilters.category = category;
                        document.querySelectorAll('.category-card').forEach(c => {
                            c.classList.toggle('active', c.dataset.category === category);
                        });
                    }
                    
                    applyFiltersAndRender();
                });
            });
            
            // Обработчики для сложности
            document.querySelectorAll('#difficulty-filters .filter-tag').forEach(tag => {
                tag.addEventListener('click', () => {
                    const difficulty = parseInt(tag.dataset.difficulty);
                    
                    // Переключение активного фильтра сложности
                    if (activeFilters.difficulty.includes(difficulty)) {
                        activeFilters.difficulty = activeFilters.difficulty.filter(d => d !== difficulty);
                        tag.classList.remove('active');
                    } else {
                        activeFilters.difficulty.push(difficulty);
                        tag.classList.add('active');
                    }
                    
                    applyFiltersAndRender();
                });
            });
            
            // Обработчики для времени
            document.querySelectorAll('#time-filters .filter-tag').forEach(tag => {
                tag.addEventListener('click', () => {
                    const time = parseInt(tag.dataset.time);
                    
                    // Переключение активного фильтра времени
                    if (activeFilters.time.includes(time)) {
                        activeFilters.time = activeFilters.time.filter(t => t !== time);
                        tag.classList.remove('active');
                    } else {
                        activeFilters.time.push(time);
                        tag.classList.add('active');
                    }
                    
                    applyFiltersAndRender();
                });
            });
            
            // Обработчик для сортировки
            document.getElementById('sort-dropdown').addEventListener('change', (e) => {
                sortBy = e.target.value;
                applyFiltersAndRender();
            });
            
            // Обработчик для сброса фильтров
            document.getElementById('reset-filters').addEventListener('click', () => {
                activeFilters = {
                    category: null,
                    difficulty: [],
                    time: []
                };
                sortBy = 'recommended';
                
                // Сброс UI
                document.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('#difficulty-filters .filter-tag, #time-filters .filter-tag').forEach(tag => tag.classList.remove('active'));
                document.getElementById('sort-dropdown').value = 'recommended';
                
                applyFiltersAndRender();
            });
        }

        // Применение фильтров и отображение упражнений
        function applyFiltersAndRender() {
            filteredExercises = [...exercises];
            
            // Фильтрация по категории
            if (activeFilters.category) {
                filteredExercises = filteredExercises.filter(ex => ex.subject === activeFilters.category);
            }
            
            // Фильтрация по сложности
            if (activeFilters.difficulty.length > 0) {
                filteredExercises = filteredExercises.filter(ex => activeFilters.difficulty.includes(ex.difficulty));
            }
            
            // Фильтрация по времени
            if (activeFilters.time.length > 0) {
                filteredExercises = filteredExercises.filter(ex => {
                    const time = ex.time_minutes;
                    if (activeFilters.time.includes(5) && time <= 5) return true;
                    if (activeFilters.time.includes(10) && time > 5 && time <= 10) return true;
                    if (activeFilters.time.includes(15) && time > 10 && time <= 15) return true;
                    if (activeFilters.time.includes(30) && time > 15) return true;
                    return false;
                });
            }
            
            // Сортировка
            switch (sortBy) {
                case 'newest':
                    filteredExercises.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
                case 'difficulty-asc':
                    filteredExercises.sort((a, b) => a.difficulty - b.difficulty);
                    break;
                case 'difficulty-desc':
                    filteredExercises.sort((a, b) => b.difficulty - a.difficulty);
                    break;
                case 'popularity':
                    // Здесь можно добавить логику сортировки по популярности, если у вас есть такие данные
                    break;
                case 'recommended':
default:
    // Рекомендуемая сортировка (можно настроить под ваши потребности)
    filteredExercises.sort((a, b) => {
        // Сначала сортируем по незавершенным и рекомендуемым
        if (a.userProgress && a.userProgress.status === 'in_progress' && (!b.userProgress || b.userProgress.status !== 'in_progress')) {
            return -1;
        }
        if (b.userProgress && b.userProgress.status === 'in_progress' && (!a.userProgress || a.userProgress.status !== 'in_progress')) {
            return 1;
        }
        
        // Затем по уровню сложности (подходящему для пользователя)
        const userLevel = currentUser?.profile?.level || 1;
        const aLevelDiff = Math.abs(a.difficulty - userLevel);
        const bLevelDiff = Math.abs(b.difficulty - userLevel);
        
        if (aLevelDiff !== bLevelDiff) {
            return aLevelDiff - bLevelDiff;
        }
        
        // Наконец, по популярности или релевантности
        return (b.is_featured ? 1 : 0) - (a.is_featured ? 1 : 0);
    });
    break;
}

// Отображение упражнений
renderExercises();
}

// Отображение упражнений в интерфейсе
function renderExercises() {
const container = document.getElementById('exercises-container');
container.innerHTML = '';

if (filteredExercises.length === 0) {
    container.innerHTML = `
        <div class="no-results">
            <i class="fas fa-search" style="font-size: 3rem; color: var(--gray-light); margin-bottom: 1rem;"></i>
            <h3>Žádná cvičení nebyla nalezena</h3>
            <p>Zkuste změnit filtry nebo vybrat jinou kategorii.</p>
        </div>
    `;
    return;
}

filteredExercises.forEach(exercise => {
    const card = document.createElement('div');
    card.className = 'exercise-card animated';
    
    // Определение статуса упражнения
    let statusText = '';
    let progressWidth = 0;
    
    if (exercise.userProgress) {
        if (exercise.userProgress.status === 'completed') {
            statusText = 'Dokončeno';
            progressWidth = 100;
        } else if (exercise.userProgress.status === 'in_progress') {
            statusText = `${exercise.userProgress.progress}% hotovo`;
            progressWidth = exercise.userProgress.progress;
        }
    }
    
    // Генерация HTML карточки упражнения
    card.innerHTML = `
        <div class="exercise-header">
            <img src="${exercise.image_url || 'https://via.placeholder.com/300x150?text=Cvičení'}" alt="${exercise.title}">
            <div class="exercise-badge ${exercise.subject}">${
                exercise.subject === 'math' ? 'Matematika' : 
                exercise.subject === 'czech' ? 'Čeština' : 'Kombinované'
            }</div>
        </div>
        <div class="exercise-body">
            <h3 class="exercise-title">${exercise.title}</h3>
            <p class="exercise-desc">${exercise.description || 'Bez popisu'}</p>
            <div class="exercise-meta">
                <div class="exercise-difficulty">
                    Obtížnost:
                    <div class="difficulty-indicator">
                        <div class="difficulty-dot ${exercise.difficulty >= 1 ? 'active' : ''}"></div>
                        <div class="difficulty-dot ${exercise.difficulty >= 2 ? 'active' : ''}"></div>
                        <div class="difficulty-dot ${exercise.difficulty >= 3 ? 'active' : ''}"></div>
                    </div>
                </div>
                <div class="exercise-time">
                    <i class="far fa-clock"></i> ${exercise.time_minutes} min
                </div>
            </div>
        </div>
        <div class="exercise-footer">
            <div class="progress-info">${statusText}</div>
            <button class="btn btn-primary start-exercise" data-id="${exercise.id}">
                <i class="fas fa-play"></i> Spustit
            </button>
        </div>
        ${progressWidth > 0 ? `
            <div style="height: 4px; background: var(--gray-light); width: 100%;">
                <div style="height: 100%; width: ${progressWidth}%; background: var(--primary);"></div>
            </div>
        ` : ''}
    `;
    
    // Добавление события клика на кнопку запуска упражнения
    card.querySelector('.start-exercise').addEventListener('click', () => {
        startExercise(exercise.id);
    });
    
    container.appendChild(card);
});
}

// Запуск выбранного упражнения
async function startExercise(exerciseId) {
try {
    // Получение данных упражнения
    const { data: exercise, error } = await supabase
        .from('exercises')
        .select('*')
        .eq('id', exerciseId)
        .single();
    
    if (error) throw error;
    
    // Получение контента упражнения (вопросы и ответы)
    if (!exercise.content || !Array.isArray(exercise.content.questions) || exercise.content.questions.length === 0) {
        showError('Toto cvičení nemá žádné otázky.');
        return;
    }
    
    // Настройка текущего теста
    currentTest = {
        ...exercise,
        questions: exercise.content.questions,
        totalQuestions: exercise.content.questions.length
    };
    
    // Инициализация пользовательских ответов
    userAnswers = new Array(currentTest.totalQuestions).fill(null);
    
    // Настройка интерфейса теста
    document.getElementById('test-title').textContent = currentTest.title;
    document.getElementById('test-time').textContent = `${currentTest.time_minutes} minut`;
    
    let difficultyText = '';
    switch (currentTest.difficulty) {
        case 1:
            difficultyText = 'Lehká obtížnost';
            break;
        case 2:
            difficultyText = 'Střední obtížnost';
            break;
        case 3:
            difficultyText = 'Vysoká obtížnost';
            break;
        default:
            difficultyText = 'Neznámá obtížnost';
    }
    
    document.getElementById('test-difficulty').textContent = difficultyText;
    
    // Настройка таймера
    testTimeLeft = currentTest.time_minutes * 60; // В секундах
    updateTimerDisplay();
    
    // Запуск таймера
    testStartTime = new Date();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimer, 1000);
    
    // Отображение первого вопроса
    currentQuestionIndex = 0;
    showCurrentQuestion();
    
    // Скрытие списка упражнений и отображение интерфейса теста
    document.querySelector('.exercises-section').style.display = 'none';
    document.querySelector('.filter-section').style.display = 'none';
    document.querySelector('.categories-section').style.display = 'none';
    document.getElementById('test-container').style.display = 'block';
    
    // Обновление прогресса пользователя в БД
    if (currentUser) {
        // Проверка существующего прогресса
        const { data: existingProgress } = await supabase
            .from('user_exercises')
            .select('*')
            .eq('user_id', currentUser.id)
            .eq('exercise_id', exerciseId)
            .single();
        
        if (!existingProgress) {
            // Создание новой записи прогресса
            await supabase
                .from('user_exercises')
                .insert([
                    {
                        user_id: currentUser.id,
                        exercise_id: exerciseId,
                        status: 'in_progress',
                        progress: 0,
                        attempts: 1,
                        last_attempt: new Date().toISOString()
                    }
                ]);
        } else if (existingProgress.status !== 'completed') {
            // Обновление существующей записи
            await supabase
                .from('user_exercises')
                .update({
                    status: 'in_progress',
                    attempts: existingProgress.attempts + 1,
                    last_attempt: new Date().toISOString()
                })
                .eq('id', existingProgress.id);
        }
    }
    
} catch (error) {
    console.error('Error starting exercise:', error);
    showError('Nepodařilo se spustit cvičení.');
}
}

// Отображение текущего вопроса
function showCurrentQuestion() {
if (!currentTest || !currentTest.questions || currentQuestionIndex >= currentTest.questions.length) {
    return;
}

const question = currentTest.questions[currentQuestionIndex];
const questionContainer = document.getElementById('question-container');
const progressBar = document.getElementById('test-progress-bar');

// Обновление прогресс-бара
const progressPercent = ((currentQuestionIndex + 1) / currentTest.totalQuestions) * 100;
progressBar.style.width = `${progressPercent}%`;

// Генерация HTML для текущего вопроса
let questionHTML = `
    <div class="question-number">Otázka ${currentQuestionIndex + 1} z ${currentTest.totalQuestions}</div>
    <div class="question-text">${question.text}</div>
`;

// Добавление изображения вопроса, если есть
if (question.image_url) {
    questionHTML += `<img src="${question.image_url}" alt="Question image" class="question-image">`;
}

// Генерация вариантов ответа в зависимости от типа вопроса
questionHTML += `<div class="answers-container">`;

switch (question.type) {
    case 'multiple_choice':
        // Вопрос с одним правильным ответом
        question.options.forEach((option, index) => {
            const isSelected = userAnswers[currentQuestionIndex] === index;
            questionHTML += `
                <div class="answer-option ${isSelected ? 'selected' : ''}" data-index="${index}">
                    <div class="answer-radio"></div>
                    <div class="answer-text">${option}</div>
                </div>
            `;
        });
        break;
        
    case 'checkbox':
        // Вопрос с множественным выбором
        question.options.forEach((option, index) => {
            const isSelected = userAnswers[currentQuestionIndex] && 
                               Array.isArray(userAnswers[currentQuestionIndex]) && 
                               userAnswers[currentQuestionIndex].includes(index);
            questionHTML += `
                <div class="answer-option ${isSelected ? 'selected' : ''}" data-index="${index}">
                    <div class="answer-checkbox"></div>
                    <div class="answer-text">${option}</div>
                </div>
            `;
        });
        break;
        
    case 'numeric':
        // Вопрос с числовым ответом
        questionHTML += `
            <div class="numeric-input-container">
                <input type="number" class="numeric-input" placeholder="Zadejte číselnou odpověď" 
                       value="${userAnswers[currentQuestionIndex] || ''}" step="any">
            </div>
        `;
        break;
        
    case 'text':
        // Вопрос с текстовым ответом
        questionHTML += `
            <div class="text-input-container">
                <textarea class="text-input" placeholder="Zadejte svou odpověď">${userAnswers[currentQuestionIndex] || ''}</textarea>
            </div>
        `;
        break;
        
    default:
        questionHTML += `<div class="error-message">Neznámý typ otázky</div>`;
}

questionHTML += `</div>`;

// Обновление контейнера вопроса
questionContainer.innerHTML = questionHTML;

// Добавление обработчиков событий для вариантов ответа
if (question.type === 'multiple_choice') {
    questionContainer.querySelectorAll('.answer-option').forEach(option => {
        option.addEventListener('click', () => {
            // Выбор только одного варианта
            questionContainer.querySelectorAll('.answer-option').forEach(o => o.classList.remove('selected'));
            option.classList.add('selected');
            
            // Сохранение ответа пользователя
            userAnswers[currentQuestionIndex] = parseInt(option.dataset.index);
        });
    });
} else if (question.type === 'checkbox') {
    questionContainer.querySelectorAll('.answer-option').forEach(option => {
        option.addEventListener('click', () => {
            // Переключение состояния выбора
            option.classList.toggle('selected');
            
            // Сохранение ответов пользователя
            const selectedIndices = Array.from(questionContainer.querySelectorAll('.answer-option.selected'))
                                      .map(el => parseInt(el.dataset.index));
            userAnswers[currentQuestionIndex] = selectedIndices.length > 0 ? selectedIndices : null;
        });
    });
} else if (question.type === 'numeric') {
    const numericInput = questionContainer.querySelector('.numeric-input');
    numericInput.addEventListener('input', () => {
        userAnswers[currentQuestionIndex] = numericInput.value === '' ? null : parseFloat(numericInput.value);
    });
} else if (question.type === 'text') {
    const textInput = questionContainer.querySelector('.text-input');
    textInput.addEventListener('input', () => {
        userAnswers[currentQuestionIndex] = textInput.value.trim() === '' ? null : textInput.value.trim();
    });
}

// Обновление кнопок навигации
updateNavigationButtons();

// Обновление MathJax (если формулы есть)
if (window.MathJax && question.text.includes('$')) {
    MathJax.typeset();
}
}

// Обновление кнопок навигации
function updateNavigationButtons() {
const prevButton = document.getElementById('prev-question');
const nextButton = document.getElementById('next-question');

// Настройка кнопки "Предыдущий вопрос"
prevButton.disabled = currentQuestionIndex === 0;
prevButton.style.visibility = currentQuestionIndex === 0 ? 'hidden' : 'visible';

// Настройка кнопки "Следующий вопрос" или "Завершить"
if (currentQuestionIndex === currentTest.totalQuestions - 1) {
    nextButton.innerHTML = '<i class="fas fa-flag-checkered"></i> Dokončit test';
    nextButton.classList.add('btn-success');
} else {
    nextButton.innerHTML = 'Další otázka <i class="fas fa-arrow-right"></i>';
    nextButton.classList.remove('btn-success');
}
}

// Инициализация обработчиков событий для теста
function initializeTestHandlers() {
// Кнопка "Предыдущий вопрос"
document.getElementById('prev-question').addEventListener('click', () => {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        showCurrentQuestion();
    }
});

// Кнопка "Следующий вопрос" / "Завершить"
document.getElementById('next-question').addEventListener('click', () => {
    if (currentQuestionIndex < currentTest.totalQuestions - 1) {
        currentQuestionIndex++;
        showCurrentQuestion();
    } else {
        finishTest();
    }
});

// Кнопки в результатах теста
document.getElementById('retry-test').addEventListener('click', () => {
    // Перезапуск того же теста
    startExercise(currentTest.id);
});

document.getElementById('back-to-exercises').addEventListener('click', () => {
    // Возврат к списку упражнений
    document.querySelector('.exercises-section').style.display = 'block';
    document.querySelector('.filter-section').style.display = 'block';
    document.querySelector('.categories-section').style.display = 'block';
    document.getElementById('test-container').style.display = 'none';
    document.getElementById('results-container').style.display = 'none';
    
    // Остановка таймера
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
});
}

// Обновление таймера
function updateTimer() {
if (testTimeLeft <= 0) {
    // Время истекло - автоматическое завершение теста
    clearInterval(timerInterval);
    finishTest(true);
    return;
}

testTimeLeft--;
updateTimerDisplay();

// Изменение цвета таймера, когда осталось мало времени
const timerDisplay = document.getElementById('timer-display');
const timerIcon = document.querySelector('#test-timer i');

if (testTimeLeft <= 60) { // Последняя минута
    timerDisplay.classList.add('timer-danger');
    timerIcon.className = 'fas fa-exclamation-circle';
} else if (testTimeLeft <= 180) { // Последние 3 минуты
    timerDisplay.classList.add('timer-warning');
    timerDisplay.classList.remove('timer-danger');
    timerIcon.className = 'fas fa-exclamation';
}
}

// Обновление отображения таймера
function updateTimerDisplay() {
const minutes = Math.floor(testTimeLeft / 60);
const seconds = testTimeLeft % 60;
document.getElementById('timer-display').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

// Завершение теста
async function finishTest(timeExpired = false) {
// Остановка таймера
if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
}

// Расчет результатов
let correctAnswers = 0;
const testEndTime = new Date();
const testDuration = Math.floor((testEndTime - testStartTime) / 1000); // В секундах

const results = currentTest.questions.map((question, index) => {
    const userAnswer = userAnswers[index];
    let isCorrect = false;
    
    // Проверка правильности ответа в зависимости от типа вопроса
    switch (question.type) {
        case 'multiple_choice':
            isCorrect = userAnswer === question.correct_answer;
            break;
            
        case 'checkbox':
            if (Array.isArray(userAnswer) && Array.isArray(question.correct_answer)) {
                isCorrect = userAnswer.length === question.correct_answer.length &&
                           userAnswer.every(a => question.correct_answer.includes(a));
            }
            break;
            
        case 'numeric':
            const userNum = parseFloat(userAnswer);
            const correctNum = parseFloat(question.correct_answer);
            const tolerance = question.tolerance || 0;
            isCorrect = !isNaN(userNum) && Math.abs(userNum - correctNum) <= tolerance;
            break;
            
        case 'text':
            if (Array.isArray(question.correct_answer)) {
                // Можно принимать несколько вариантов ответа
                isCorrect = question.correct_answer.some(
                    a => userAnswer && userAnswer.toLowerCase() === a.toLowerCase()
                );
            } else {
                isCorrect = userAnswer && userAnswer.toLowerCase() === question.correct_answer.toLowerCase();
            }
            break;
    }
    
    if (isCorrect) correctAnswers++;
    
    return {
        question: question.text,
        userAnswer,
        correctAnswer: question.correct_answer,
        isCorrect,
        explanation: question.solution_explanation || ''
    };
});

const score = Math.round((correctAnswers / currentTest.totalQuestions) * 100);

// Сохранение результатов в базу данных
if (currentUser) {
    try {
        // Создание записи о попытке
        const { data: attempt, error: attemptError } = await supabase
            .from('user_test_attempts')
            .insert([
                {
                    user_id: currentUser.id,
                    test_id: currentTest.id,
                    started_at: testStartTime.toISOString(),
                    completed_at: testEndTime.toISOString(),
                    total_questions: currentTest.totalQuestions,
                    correct_answers: correctAnswers,
                    time_spent_seconds: testDuration,
                    score: score
                }
            ])
            .select();
        
        if (attemptError) throw attemptError;
        
        // Сохранение ответов пользователя на вопросы
        const userResponses = results.map((result, idx) => ({
            attempt_id: attempt[0].id,
            question_id: currentTest.questions[idx].id || idx,
            user_answer: JSON.stringify(result.userAnswer),
            is_correct: result.isCorrect,
            time_spent_seconds: Math.floor(testDuration / currentTest.totalQuestions) // Примерное время на вопрос
        }));
        
        await supabase
            .from('user_question_responses')
            .insert(userResponses);
        
        // Обновление прогресса пользователя в упражнении
        const { data: existingProgress } = await supabase
            .from('user_exercises')
            .select('*')
            .eq('user_id', currentUser.id)
            .eq('exercise_id', currentTest.id)
            .single();
        
        if (existingProgress) {
            // Обновление прогресса
            const updatedStatus = score >= 80 ? 'completed' : 'in_progress';
            const updatedProgress = Math.max(existingProgress.progress || 0, score);
            
            await supabase
                .from('user_exercises')
                .update({
                    status: updatedStatus,
                    progress: updatedProgress,
                    score: score > (existingProgress.score || 0) ? score : existingProgress.score,
                    completed_at: updatedStatus === 'completed' ? testEndTime.toISOString() : null
                })
                .eq('id', existingProgress.id);
            
            // Обновление очков пользователя
            if (score > (existingProgress.score || 0)) {
                const pointsGained = Math.floor((score - (existingProgress.score || 0)) / 10);
                
                if (pointsGained > 0) {
                    await supabase
                        .from('profiles')
                        .update({ 
                            points: currentUser.profile.points + pointsGained,
                            completed_exercises: currentUser.profile.completed_exercises + (updatedStatus === 'completed' ? 1 : 0)
                        })
                        .eq('id', currentUser.id);
                }
            }
        }
    } catch (error) {
        console.error('Error saving test results:', error);
    }
}

// Отображение результатов
showTestResults(score, correctAnswers, testDuration, results, timeExpired);
}

// Отображение результатов теста
function showTestResults(score, correctAnswers, duration, results, timeExpired) {
// Скрытие интерфейса теста и отображение результатов
document.getElementById('test-container').style.display = 'none';
document.getElementById('results-container').style.display = 'block';

// Заголовок результатов
if (timeExpired) {
    document.getElementById('results-title').textContent = 'Čas vypršel - Výsledky cvičení';
} else {
    document.getElementById('results-title').textContent = 'Výsledky cvičení';
}

// Процент правильных ответов
document.getElementById('score-percentage').textContent = `${score}%`;
document.getElementById('score-fraction').textContent = `(${correctAnswers}/${currentTest.totalQuestions})`;

// Сообщение о результате
let resultMessage = '';
if (score >= 90) {
    resultMessage = 'Vynikající! Perfektně jste zvládli toto cvičení.';
} else if (score >= 80) {
    resultMessage = 'Výborně! Zvládli jste to velmi dobře.';
} else if (score >= 60) {
    resultMessage = 'Dobře! Zvládli jste toto cvičení, ale je prostor pro zlepšení.';
} else if (score >= 40) {
    resultMessage = 'Zvládli jste to, ale doporučujeme další procvičování.';
} else {
    resultMessage = 'Toto cvičení bylo náročné. Zkuste to znovu po dalším procvičování.';
}
document.getElementById('results-message').textContent = resultMessage;

// Обновление сводки
document.getElementById('summary-correct').textContent = correctAnswers;
document.getElementById('summary-incorrect').textContent = currentTest.totalQuestions - correctAnswers;

// Форматирование времени
const minutes = Math.floor(duration / 60);
const seconds = duration % 60;
document.getElementById('summary-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

// Генерация обзора вопросов
const reviewContainer = document.getElementById('questions-review');
reviewContainer.innerHTML = '';

results.forEach((result, index) => {
    const reviewItem = document.createElement('div');
    reviewItem.className = `review-item ${result.isCorrect ? 'correct' : 'incorrect'}`;
    
    let reviewHTML = `
        <div class="review-question">Otázka ${index + 1}: ${result.question}</div>
        <div class="review-answers">
    `;
    
    // Отображение ответа пользователя
    reviewHTML += `<div class="review-answer">
        <i class="${result.isCorrect ? 'fas fa-check correct' : 'fas fa-times incorrect'}"></i>
        <span>Vaše odpověď: ${formatAnswer(result.userAnswer, currentTest.questions[index].type)}</span>
    </div>`;
    
    // Отображение правильного ответа, если пользователь ошибся
    if (!result.isCorrect) {
        reviewHTML += `<div class="review-answer">
            <i class="fas fa-check correct"></i>
            <span>Správná odpověď: ${formatAnswer(result.correctAnswer, currentTest.questions[index].type)}</span>
        </div>`;
    }
    
    reviewHTML += `</div>`;
    
    // Объяснение (если есть)
    if (result.explanation) {
        reviewHTML += `<div class="review-explanation">
            <strong>Vysvětlení:</strong> ${result.explanation}
        </div>`;
    }
    
    reviewItem.innerHTML = reviewHTML;
    reviewContainer.appendChild(reviewItem);
});
}

// Форматирование ответа для отображения
function formatAnswer(answer, questionType) {
if (answer === null || answer === undefined) {
    return 'Bez odpovědi';
}

switch (questionType) {
    case 'multiple_choice':
        // Для вопросов с одним выбором показываем текст выбранного варианта
        if (currentTest && currentTest.questions) {
            const question = currentTest.questions.find(q => q.type === 'multiple_choice');
            if (question && question.options && question.options[answer]) {
                return question.options[answer];
            }
        }
        return `Možnost ${answer + 1}`;
        
    case 'checkbox':
        // Для вопросов с множественным выбором показываем список выбранных вариантов
        if (Array.isArray(answer) && answer.length > 0) {
            if (currentTest && currentTest.questions) {
                const question = currentTest.questions.find(q => q.type === 'checkbox');
                if (question && question.options) {
                    return answer.map(idx => question.options[idx] || `Možnost ${idx + 1}`).join(', ');
                }
            }
            return answer.map(idx => `Možnost ${idx + 1}`).join(', ');
        }
        return 'Žádné vybrané možnosti';
        
    case 'numeric':
        // Для числовых вопросов форматируем число
        return answer.toString();
        
    case 'text':
        // Для текстовых вопросов показываем текст
        return answer;
        
    default:
        return JSON.stringify(answer);
}
}

// Отображение ошибок
function showError(message) {
const errorContainer = document.getElementById('global-error');
const errorMessage = document.getElementById('global-error-message');

errorMessage.textContent = message;
errorContainer.style.display = 'block';

// Автоматическое скрытие ошибки через 5 секунд
setTimeout(() => {
    errorContainer.style.display = 'none';
}, 5000);
}

// Обработчик повторной попытки при ошибке
document.getElementById('global-retry-btn').addEventListener('click', async () => {
document.getElementById('global-error').style.display = 'none';
await loadExercises();
});
</script>