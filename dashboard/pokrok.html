<!DOCTYPE html>
<html lang="cs" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justax - Přehled pokroku // Kyber-verze</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns/locale/cs/index.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- START: Cyberpunk CSS Theme (Combined & Adapted) --- */
        :root {
            --bg-color: #03020c;
            --bg-secondary: #0a071f;
            --bg-secondary-rgb: 10, 7, 31;
            --card-bg: rgba(15, 10, 45, 0.88);
            --card-solid: #0f0a2d;
            --card-solid-rgb: 15, 10, 45;
            --interface-bg: rgba(6, 4, 22, 0.92);
            --interface-border: rgba(0, 240, 255, 0.35);
            --dark-purple-accent: #160c41;
            --accent-primary: #00e0ff;
            --accent-primary-rgb: 0, 224, 255;
            --accent-secondary: #a05cff;
            --accent-secondary-rgb: 160, 92, 255;
            --accent-pink: #ff33a8;
            --accent-pink-rgb: 255, 51, 168;
            --accent-lime: #6fff3a;
            --accent-lime-rgb: 111, 255, 58;
            --accent-cyan: var(--accent-primary);
            --accent-cyan-rgb: var(--accent-primary-rgb);
            --accent-cyan-glow: rgba(var(--accent-cyan-rgb), 0.6);
            --accent-glow: rgba(var(--accent-primary-rgb), 0.6);
            --accent-secondary-glow: rgba(var(--accent-secondary-rgb), 0.5);
            --accent-pink-glow: rgba(var(--accent-pink-rgb), 0.4);
            --accent-lime-glow: rgba(var(--accent-lime-rgb), 0.5);
            --accent-border-glow: rgba(var(--accent-primary-rgb), 0.7);
            --accent-orange: #f8961e;
            --accent-orange-rgb: 248, 150, 30;
            --accent-orange-glow: rgba(var(--accent-orange-rgb), 0.5);
            --text-light: #f1f5f9;
            --text-medium: #b8c4e0;
            --text-muted: #808db0;
            --text-muted-rgb: 128, 141, 176;
            --text-heading: #ffffff;
            --text-link: var(--accent-primary);
            --text-link-hover: #ffffff;
            --text-fixed-dark: #03020c;
            --white: #ffffff;
            --black: #000000;
            --white-rgb: 255, 255, 255;
            --border-color-light: rgba(var(--accent-secondary-rgb), 0.25);
            --border-color-medium: rgba(var(--accent-secondary-rgb), 0.45);
            --border-color-strong: rgba(var(--accent-primary-rgb), 0.65);
            --border-interactive: var(--accent-primary);
            --border-glow-gradient: linear-gradient(90deg, transparent, var(--accent-primary), var(--accent-pink), var(--accent-primary), transparent);
            --gradient-header: linear-gradient(180deg, rgba(3, 2, 12, 0.97) 0%, rgba(3, 2, 12, 0.9) 100%);
            --gradient-border-anim: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary), var(--accent-pink), var(--accent-primary), var(--accent-secondary));
            --gradient-button: linear-gradient(100deg, var(--accent-secondary) 0%, var(--accent-primary) 100%);
            --gradient-button-hover: linear-gradient(100deg, var(--accent-primary) 0%, var(--accent-pink) 100%);
            --gradient-hero-bg: radial-gradient(ellipse at 15% 15%, rgba(var(--accent-primary-rgb), 0.18), transparent 55%), radial-gradient(ellipse at 85% 85%, rgba(var(--accent-secondary-rgb), 0.15), transparent 60%), var(--bg-color);
            --gradient-card-highlight: linear-gradient(160deg, rgba(var(--accent-primary-rgb), 0.15), rgba(var(--accent-secondary-rgb), 0.12));
            --gradient-cta: linear-gradient(110deg, var(--accent-secondary) 0%, var(--accent-pink) 100%);
            --shimmer-gradient: linear-gradient(90deg, transparent, rgba(var(--accent-primary-rgb), 0.2), transparent);
            --gradient-sidebar: linear-gradient(190deg, var(--bg-secondary) 0%, var(--dark-purple-accent) 100%);
            --gradient-level-up: linear-gradient(45deg, var(--accent-pink), var(--accent-secondary));
            --gradient-welcome: linear-gradient(135deg, rgba(var(--accent-primary-rgb), 0.2), rgba(var(--accent-secondary-rgb), 0.25));
            --gradient-math: linear-gradient(135deg, var(--accent-cyan), var(--accent-secondary));
            --gradient-lang: linear-gradient(135deg, var(--accent-pink), var(--accent-secondary));
            --gradient-special: linear-gradient(135deg, var(--accent-orange), var(--accent-pink));
            --gradient-streak: linear-gradient(135deg, var(--accent-pink), #d90429);
            --gradient-locked: linear-gradient(135deg, #334155, #1e293b);
            --gradient-success: linear-gradient(135deg, var(--accent-lime), #45a247);
            --gradient-warning: linear-gradient(135deg, var(--accent-orange), #f3722c);
            --gradient-danger: linear-gradient(135deg, var(--accent-pink), #b5179e);
            --gradient-info: linear-gradient(135deg, var(--accent-cyan), var(--accent-primary));
            --font-primary: 'Inter', sans-serif;
            --font-secondary: 'Poppins', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
            --shadow-glow: 0 0 25px var(--accent-glow);
            --shadow-card: 0 12px 40px rgba(0, 0, 0, 0.4);
            --shadow-interactive: 0 8px 20px rgba(var(--accent-primary-rgb), 0.4);
            --shadow-interactive-hover: 0 10px 28px rgba(var(--accent-pink-rgb), 0.45);
            --shadow-card-hover-enhanced: 0 18px 50px rgba(0, 0, 0, 0.45), 0 0 30px var(--accent-glow), inset 0 0 15px rgba(var(--accent-primary-rgb), 0.15);
            --shadow-hud: 0 4px 15px rgba(0,0,0,0.3), inset 0 1px 2px rgba(var(--accent-primary-rgb), 0.1);
            --shadow-text-glow: 0 0 8px rgba(var(--accent-primary-rgb), 0.6);
            --sidebar-width: 260px;
            --card-radius: 14px;
            --button-radius: 10px;
            --form-element-radius: 8px;
            --section-padding-y: clamp(2rem, 5vh, 3rem);
            --container-padding-x: 2rem;
            --transition-speed: 0.3s;
            --transition-fast: all 0.2s ease-out;
            --transition-medium: all 0.35s ease-out;
            --transition-long: all 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
            --transition-bounce: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --transition-entrance: all 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
            --skeleton-bg: rgba(var(--accent-secondary-rgb), 0.1);
            --skeleton-highlight: rgba(var(--accent-secondary-rgb), 0.2);
            --card-bg-color: var(--card-bg);
            --card-bg-color-rgb: 15, 10, 45;
            --danger-color: #ff4d6d;
            --success-color: var(--accent-lime);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; font-size: 16px; -webkit-text-size-adjust: 100%; }
        body { background-color: var(--bg-color); color: var(--text-medium); font-family: var(--font-primary); line-height: 1.7; min-height: 100vh; display: flex; overflow: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; position: relative; }
        body::before { content: ""; position: fixed; inset: 0; width: 100%; height: 100%; z-index: -3; background-image: linear-gradient(rgba(var(--accent-secondary-rgb), 0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(var(--accent-secondary-rgb), 0.04) 1px, transparent 1px); background-size: 40px 40px; opacity: 0.6; animation: bg-grid-pan 100s linear infinite; pointer-events: none; }
        body::after { content: ""; position: fixed; inset: 0; width: 100%; height: 100%; z-index: -2; background: linear-gradient( to bottom, rgba(10, 7, 31, 0) 50%, rgba(0, 0, 0, 0.08) 50% ); background-size: 100% 3px; opacity: 0.15; animation: scanlines 25s linear infinite; pointer-events: none; }
        @keyframes bg-grid-pan { 0% { background-position: 0 0; } 100% { background-position: 800px 400px; } }
        @keyframes scanlines { from { background-position: 0 0; } to { background-position: 0 75px; } }
        .mouse-follower-glow { position: fixed; width: 200px; height: 200px; background: radial-gradient(circle, rgba(var(--accent-primary-rgb), 0.05) 0%, transparent 70%); border-radius: 50%; pointer-events: none; z-index: -1; transform: translate(-50%, -50%); filter: blur(35px); transition: top 0.1s ease-out, left 0.1s ease-out, background 0.3s ease, opacity 0.3s ease; opacity: 0; will-change: top, left, opacity; }
        body.mouse-has-moved .mouse-follower-glow { opacity: 1; }
        h1, h2, h3, h4, h5, h6 { font-family: var(--font-secondary); font-weight: 600; color: var(--text-heading); line-height: 1.35; margin-bottom: 1em; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        h1 { font-size: clamp(1.6rem, 3vw, 1.9rem); font-weight: 700; }
        h2 { font-size: clamp(1.3rem, 2.5vw, 1.5rem); margin-bottom: 1.5rem; }
        h3 { font-size: clamp(1.1rem, 2vw, 1.25rem); }
        p { margin-bottom: 1.2rem; font-size: clamp(0.9rem, 1.8vw, 1rem); max-width: 700px; color: var(--text-medium); }
        a { color: var(--text-link); text-decoration: none; transition: color var(--transition-fast), text-shadow 0.3s ease, outline-offset 0.1s ease; }
        a:hover { color: var(--text-link-hover); text-shadow: var(--shadow-text-glow); }
        a:focus-visible, button:focus-visible, input:focus-visible, textarea:focus-visible, select:focus-visible { outline: 3px solid var(--accent-primary); outline-offset: 4px; border-radius: 6px; box-shadow: 0 0 12px var(--accent-glow); }
        :is(a, button, input, textarea, select):focus { outline: none; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(var(--accent-secondary-rgb), 0.08); border-radius: 4px;}
        ::-webkit-scrollbar-thumb { background-color: rgba(var(--accent-primary-rgb), 0.5); border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background-color: rgba(var(--accent-primary-rgb), 0.8); }
        body { scrollbar-width: thin; scrollbar-color: rgba(var(--accent-primary-rgb), 0.5) rgba(var(--accent-secondary-rgb), 0.08); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5em; padding: 0.6rem 1.2rem; background: transparent; color: var(--accent-primary); border: 2px solid var(--accent-primary); border-radius: var(--button-radius); font-family: var(--font-secondary); font-weight: 600; font-size: 0.9rem; text-align: center; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: all var(--transition-medium), transform 0.15s ease-out; position: relative; overflow: hidden; z-index: 1; box-shadow: 0 0 10px -3px var(--accent-glow), inset 0 0 8px -5px var(--accent-glow); backdrop-filter: blur(2px); will-change: transform, box-shadow, color, border-color; }
        .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: var(--gradient-button); transition: left 0.35s ease-in-out; z-index: -1; }
        .btn:hover:not(:disabled) { color: var(--text-fixed-dark); border-color: var(--accent-secondary); box-shadow: 0 0 20px var(--accent-secondary-glow), inset 0 0 10px rgba(var(--accent-secondary-rgb), 0.15); transform: translateY(-3px); }
        .btn:hover:not(:disabled)::before { left: 0; background: var(--gradient-button-hover); }
        .btn:active:not(:disabled) { transform: translateY(0px) scale(0.97); box-shadow: 0 0 8px var(--accent-secondary-glow), inset 0 0 12px rgba(0,0,0,0.3); transition-duration: 0.08s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: transparent !important; border-color: var(--text-muted) !important; color: var(--text-muted) !important; box-shadow: none !important; }
        .btn:disabled::before { display: none; }
        .btn-outline { border-color: var(--accent-secondary); color: var(--accent-secondary); box-shadow: 0 0 10px -3px var(--accent-secondary-glow), inset 0 0 8px -5px var(--accent-secondary-glow); }
        .btn-outline::before { display: none; }
        .btn-outline:hover:not(:disabled) { background: rgba(var(--accent-secondary-rgb), 0.12); border-color: var(--accent-pink); color: var(--accent-pink); box-shadow: 0 0 18px var(--accent-pink-glow); transform: translateY(-3px); }
        .btn-outline:active:not(:disabled) { transform: translateY(0px) scale(0.97); box-shadow: 0 0 8px var(--accent-pink-glow), inset 0 0 10px rgba(0,0,0,0.15); background: rgba(var(--accent-pink-rgb), 0.18); transition-duration: 0.08s; }
        .btn-primary { background: var(--gradient-button); border-color: transparent; color: var(--text-fixed-dark); box-shadow: 0 0 15px -2px var(--accent-glow); }
        .btn-primary::before { display: none; }
        .btn-primary:hover:not(:disabled) { background: var(--gradient-button-hover); border-color: transparent; color: var(--white); box-shadow: 0 0 22px var(--accent-pink-glow); transform: translateY(-3px); }
        .btn-secondary { border-color: var(--text-muted); color: var(--text-muted); box-shadow: none; }
        .btn-secondary::before { display: none; }
        .btn-secondary:hover:not(:disabled) { background: rgba(var(--accent-secondary-rgb), 0.1); border-color: var(--accent-secondary); color: var(--accent-secondary); box-shadow: 0 0 10px rgba(var(--accent-secondary-rgb), 0.2); transform: translateY(-2px); }
        .btn-secondary:active:not(:disabled) { transform: translateY(0px) scale(0.97); background: rgba(var(--accent-secondary-rgb), 0.15); }
        .btn-sm { padding: 0.45rem 0.9rem; font-size: 0.8rem; }
        .btn i { font-size: 1em; transition: transform 0.2s ease; }
        .btn:hover:not(:disabled) i.fa-sync-alt { transform: rotate(90deg); }
        .btn .button-text { display: inline; }
        @media (max-width: 768px) { .btn .button-text { display: none; } .btn { padding: 0.6rem 0.8rem; } }
        .btn.loading i { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .card { background: var(--card-bg); border-radius: var(--card-radius); border: 1px solid var(--border-color-light); box-shadow: var(--shadow-hud); transition: transform var(--transition-medium), box-shadow var(--transition-medium), border-color var(--transition-medium); position: relative; overflow: hidden; will-change: transform, box-shadow; }
        .card:hover { transform: translateY(-5px) scale(1.01); box-shadow: var(--shadow-card-hover-enhanced); border-color: var(--border-color-medium); }
        .card::before, .card::after { content: ''; position: absolute; width: 12px; height: 12px; border-color: var(--accent-primary); border-style: solid; opacity: 0; transition: all 0.3s ease; pointer-events: none; z-index: 1; }
        .card::before { top: 10px; left: 10px; border-width: 2px 0 0 2px; }
        .card::after { bottom: 10px; right: 10px; border-width: 0 2px 2px 0; }
        .card:hover::before, .card:hover::after { opacity: 0.6; }
        .card:hover::before { transform: translate(-3px, -3px); }
        .card:hover::after { transform: translate(3px, 3px); }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--gradient-sidebar); color: var(--text-medium); padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 1000; box-shadow: 5px 0 30px rgba(0, 0, 0, 0.4); border-right: 1px solid var(--border-color-light); transition: transform var(--transition-medium) ease, width var(--transition-medium) ease; }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2.5rem; padding: 0 0.5rem; position: relative; min-height: 45px; }
        #sidebar-close-toggle { display: none; position: absolute; right: 0px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); font-size: 1.8rem; cursor: pointer; padding: 0.5rem; line-height: 1; transition: color 0.2s ease; }
        #sidebar-close-toggle:hover { color: var(--accent-primary); }
        .sidebar-logo { font-size: 1.7rem; font-weight: 700; color: var(--text-heading); text-decoration: none; display: flex; align-items: center; gap: 0.8rem; text-shadow: 0 0 8px var(--accent-secondary-glow); }
        .sidebar-logo i { font-size: 1.8rem; color: var(--accent-secondary); }
        .sidebar-logo span { transition: opacity 0.2s ease; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        .sidebar-menu::-webkit-scrollbar { width: 5px; }
        .sidebar-menu::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 3px;}
        .sidebar-menu::-webkit-scrollbar-thumb { background-color: rgba(var(--accent-primary-rgb), 0.4); border-radius: 3px; }
        .sidebar-menu::-webkit-scrollbar-thumb:hover { background-color: rgba(var(--accent-primary-rgb), 0.6); }
        .sidebar-menu { scrollbar-width: thin; scrollbar-color: rgba(var(--accent-primary-rgb), 0.4) rgba(255, 255, 255, 0.05); }
        .sidebar-item { margin-bottom: 0.6rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.85rem 1rem; color: var(--text-medium); text-decoration: none; border-radius: var(--button-radius); transition: background-color 0.25s ease, color 0.25s ease, box-shadow 0.25s ease, border-left-color 0.25s ease; font-weight: 500; position: relative; border-left: 4px solid transparent; }
        .sidebar-link i { margin-right: 0.85rem; font-size: 1.25rem; width: 25px; text-align: center; transition: color 0.25s ease; color: var(--text-muted); }
        .sidebar-link span { transition: opacity 0.2s ease; }
        .sidebar-link:hover { background-color: rgba(var(--accent-primary-rgb), 0.1); color: var(--text-light); box-shadow: inset 3px 0 8px -2px rgba(var(--accent-primary-rgb), 0.3); }
        .sidebar-link:hover i { color: var(--accent-primary); }
        .sidebar-link.active { background-color: rgba(var(--accent-primary-rgb), 0.15); color: var(--white); font-weight: 600; border-left-color: var(--accent-primary); box-shadow: inset 4px 0 10px -3px rgba(var(--accent-primary-rgb), 0.4); }
        .sidebar-link.active i { color: var(--accent-primary); }
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1.5rem; background-color: rgba(var(--accent-secondary-rgb), 0.1); border-radius: 12px; border: 1px solid var(--border-color-light); flex-shrink: 0; }
        .user-avatar { width: 42px; height: 42px; border-radius: 50%; background-color: var(--accent-secondary); display: flex; align-items: center; justify-content: center; margin-right: 0.85rem; font-weight: 600; font-size: 1.1rem; overflow: hidden; color: var(--white); border: 2px solid rgba(var(--accent-primary-rgb), 0.3); flex-shrink: 0; box-shadow: 0 0 8px rgba(var(--accent-secondary-rgb), 0.4); }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; overflow: hidden; }
        .user-name { font-weight: 600; font-size: 1rem; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-role { font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; }
        .sidebar-footer { margin-top: 1.5rem; padding: 1rem; font-size: 0.8rem; color: var(--text-muted); text-align: center; flex-shrink: 0; opacity: 0.7; }
        main { flex: 1; margin-left: var(--sidebar-width); padding: 0 var(--container-padding-x); transition: margin-left var(--transition-medium) ease; width: calc(100% - var(--sidebar-width)); overflow-y: auto; height: 100vh; display: none; }
        main.loaded { display: block; animation: fadeInMain 0.5s ease-out forwards; }
        @keyframes fadeInMain { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .dashboard-header { margin-bottom: var(--section-padding-y); background-color: rgba(var(--bg-secondary-rgb, 10, 7, 31), 0.7); backdrop-filter: blur(12px); border-radius: 0 0 var(--card-radius) var(--card-radius); padding: 1rem var(--container-padding-x); box-shadow: var(--shadow-hud); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; position: sticky; top: 0; z-index: 900; border-bottom: 1px solid var(--border-color-light); transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        body.scrolled .dashboard-header { background-color: rgba(var(--bg-secondary-rgb, 10, 7, 31), 0.85); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .header-title { display: flex; align-items: center; gap: 1rem; flex-grow: 1; }
        .header-title h1 { font-size: 1.7rem; font-weight: 700; color: var(--text-heading); margin: 0; text-shadow: 0 0 10px var(--accent-glow); }
        .header-time { font-size: 0.9rem; color: var(--text-muted); margin-left: 1rem; display: none; }
        @media (min-width: 768px) { .header-time { display: block; } }
        .header-actions { display: flex; align-items: center; gap: 0.75rem; }
        .mobile-menu-toggle { display: none; background: none; border: none; color: var(--text-medium); font-size: 1.6rem; cursor: pointer; padding: 0.5rem; margin-right: 0.5rem; z-index: 1010; transition: color 0.2s ease; }
        .mobile-menu-toggle:hover { color: var(--accent-primary); }
        @media (max-width: 992px) { .mobile-menu-toggle { display: block; } }
        .refresh-btn { background: rgba(var(--accent-primary-rgb), 0.1); border: 1px solid rgba(var(--accent-primary-rgb), 0.3); color: var(--accent-primary); font-size: 0.9rem; cursor: pointer; padding: 0.5rem 1rem; border-radius: var(--button-radius); transition: all 0.25s ease; display: flex; align-items: center; gap: 0.5em; }
        .refresh-btn:hover:not(:disabled) { background-color: rgba(var(--accent-primary-rgb), 0.2); color: var(--white); border-color: var(--accent-primary); box-shadow: 0 0 12px rgba(var(--accent-primary-rgb), 0.4); transform: translateY(-2px); }
        .refresh-btn:active:not(:disabled) { transform: translateY(0px) scale(0.98); background-color: rgba(var(--accent-primary-rgb), 0.15); box-shadow: 0 0 5px rgba(var(--accent-primary-rgb), 0.3); }
        .refresh-btn .refresh-text { display: none; font-weight: 600; }
        @media (min-width: 768px) { .refresh-btn .refresh-text { display: inline; } }
        .refresh-btn.loading i { animation: spin 1s linear infinite; }
        .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: transparent !important; border-color: var(--text-muted) !important; color: var(--text-muted) !important; box-shadow: none !important; }
        .main-content-wrapper { padding: var(--section-padding-y) 0; }
        .main-content-grid { display: grid; gap: 2rem; }
        .section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--text-heading); padding-bottom: 0.8rem; position: relative; display: flex; align-items: center; gap: 0.7rem; }
        .section-title i { font-size: 1.1em; color: var(--accent-secondary); text-shadow: 0 0 8px var(--accent-secondary-glow); }
        .section-title::after { content: ''; position: absolute; bottom: 0; left: 0; width: 60px; height: 3px; background: var(--gradient-border-anim); background-size: 300% 100%; animation: gradient-move 4s linear infinite; border-radius: 1.5px; filter: drop-shadow(0 0 5px var(--accent-primary)); }
        @keyframes gradient-move { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.8rem; margin-bottom: 2.5rem; }
        .stats-card { min-height: 170px; position: relative; display: flex; flex-direction: column; padding: 1.5rem; background: var(--card-bg); border-radius: var(--card-radius); border: 1px solid var(--border-color-light); box-shadow: var(--shadow-hud); transition: transform var(--transition-medium), box-shadow var(--transition-medium), border-color var(--transition-medium); overflow: hidden; will-change: transform, box-shadow; }
        .stats-card:hover { transform: translateY(-5px) scale(1.01); box-shadow: var(--shadow-card-hover-enhanced); border-color: var(--border-color-medium); }
        .stats-card .loading-skeleton { display: none; padding: 1.5rem; align-items: flex-start; justify-content: space-between; width: 100%; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 5; backdrop-filter: blur(2px); }
        .stats-card .loading-skeleton .skeleton-info { flex-grow: 1; }
        .stats-card.loading .loading-skeleton { display: flex; background-color: rgba(var(--card-solid-rgb), 0.7); }
        .stats-card.loading .stats-card-header, .stats-card.loading .stats-card-content, .stats-card.loading .stats-card-footer { visibility: hidden; }
        .stats-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .stats-card-title { font-size: 0.9rem; font-weight: 500; color: var(--text-muted); display: flex; align-items: center; gap: 0.6rem; text-transform: uppercase; letter-spacing: 0.8px; }
        .stats-card-title i { font-size: 1em; }
        .stats-card[data-type="progress"] .stats-card-title i { color: var(--info); }
        .stats-card[data-type="points"] .stats-card-title i { color: var(--warning); }
        .stats-card[data-type="streak"] .stats-card-title i { color: var(--danger); }
        .stats-card[data-type="exercises"] .stats-card-title i { color: var(--success); }
        .stats-card-content { flex-grow: 1; margin-bottom: 1rem; position: relative; z-index: 1; }
        .stats-card-value { font-size: 2.4rem; font-weight: 700; color: var(--text-heading); margin-bottom: 0.4rem; line-height: 1.1; min-height: 40px; text-shadow: 0 0 8px rgba(var(--white-rgb, 255,255,255), 0.3); }
        .stats-card-description { font-size: 0.9rem; color: var(--text-medium); min-height: 18px; }
        .stats-card-footer { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.4rem; padding-top: 0.8rem; margin-top: auto; border-top: 1px solid var(--border-color-light); position: relative; z-index: 1; min-height: 20px; }
        .stats-card-footer i { font-size: 0.8em; }
        .stats-card-footer.positive { color: var(--accent-lime); font-weight: 500; }
        .stats-card-footer.negative { color: var(--accent-pink); font-weight: 500; }
        .chart-section { background: var(--card-bg); border-radius: var(--card-radius); box-shadow: var(--shadow-hud); padding: 2rem; margin-bottom: 2.5rem; position: relative; min-height: 420px; border: 1px solid var(--border-color-light); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .chart-title { font-size: 1.35rem; font-weight: 600; color: var(--text-light); display: flex; align-items: center; gap: 0.6rem; }
        .chart-title i { color: var(--accent-secondary); }
        .chart-actions { display: flex; gap: 0.6rem; }
        .chart-actions select { padding: 0.5rem 1rem; font-size: 0.85rem; border-radius: var(--form-element-radius); border: 1px solid var(--border-color-light); background-color: rgba(var(--bg-secondary-rgb), 0.5); color: var(--text-medium); cursor: pointer; min-width: 120px; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23808db0'%3E%3cpath fill-rule='evenodd' d='M8 11.646l-4.854-4.853.708-.708L8 10.23l4.146-4.146.708.708z'/%3E%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 14px 10px; transition: border-color 0.2s ease; }
        .chart-actions select:hover { border-color: var(--border-color-medium); }
        .chart-actions select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 2px var(--input-focus-shadow); }
        .chart-container { height: 360px; position: relative; }
        .empty-chart-message { display: none; position: absolute; inset: 0; background: rgba(var(--card-solid-rgb), 0.9); border-radius: var(--card-radius); align-items: center; justify-content: center; flex-direction: column; text-align: center; z-index: 5;}
        .empty-chart-message i { font-size: 2.8rem; margin-bottom: 1rem; color: var(--text-muted); opacity: 0.7; }
        .empty-chart-message p { margin: 0; font-size: 1rem; color: var(--text-medium); }
        .data-table-section { background: var(--card-bg); border-radius: var(--card-radius); box-shadow: var(--shadow-hud); padding: 0; margin-bottom: 2.5rem; position: relative; min-height: 350px; overflow: hidden; border: 1px solid var(--border-color-light); }
        .data-table-header { padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color-light); flex-wrap: wrap; gap: 1rem; background-color: rgba(var(--dark-purple-accent), 0.3); }
        .data-table-title { font-size: 1.35rem; font-weight: 600; color: var(--text-light); display: flex; align-items: center; gap: 0.6rem; }
        .data-table-title i { color: var(--accent-lime); }
        .data-table-actions { display: flex; gap: 0.6rem; }
        .data-table-actions select { padding: 0.5rem 1rem; font-size: 0.85rem; border-radius: var(--form-element-radius); border: 1px solid var(--border-color-light); background-color: rgba(var(--bg-secondary-rgb), 0.5); color: var(--text-medium); cursor: pointer; min-width: 140px; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23808db0'%3E%3cpath fill-rule='evenodd' d='M8 11.646l-4.854-4.853.708-.708L8 10.23l4.146-4.146.708.708z'/%3E%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 14px 10px; transition: border-color 0.2s ease; }
        .data-table-actions select:hover { border-color: var(--border-color-medium); }
        .data-table-actions select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 2px var(--input-focus-shadow); }
        .table-responsive { overflow-x: auto; max-height: 500px; }
        .table-responsive::-webkit-scrollbar { width: 6px; height: 6px; }
        .table-responsive::-webkit-scrollbar-track { background: transparent; }
        .table-responsive::-webkit-scrollbar-thumb { background-color: rgba(var(--accent-primary-rgb), 0.4); border-radius: 3px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; white-space: nowrap; }
        .data-table th, .data-table td { padding: 0.9rem 1.5rem; text-align: left; border-bottom: 1px solid var(--border-color-light); }
        .data-table th { color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; background-color: rgba(var(--dark-purple-accent), 0.4); white-space: nowrap; cursor: pointer; position: sticky; top: 0; z-index: 2; }
        .data-table th i.fa-sort, .data-table th i.fa-sort-up, .data-table th i.fa-sort-down, .data-table th i.fa-filter { margin-left: 0.5rem; color: rgba(var(--text-muted-rgb), 0.7); transition: color 0.2s, transform 0.2s; }
        .data-table th:hover i { color: var(--text-medium); }
        .data-table th.sort-asc i.fa-sort-up, .data-table th.sort-desc i.fa-sort-down { color: var(--accent-primary); }
        .data-table th.filtered i.fa-filter { color: var(--accent-primary); }
        .data-table td { color: var(--text-medium); vertical-align: middle; }
        .data-table tbody tr:last-child td { border-bottom: none; }
        .data-table tbody tr:hover { background-color: rgba(var(--accent-primary-rgb), 0.05); }
        .status-badge { padding: 0.3rem 0.9rem; border-radius: 14px; font-size: 0.8rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.4rem; white-space: nowrap; border: 1px solid transparent; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-badge i { font-size: 0.85em; }
        .status-badge.test, .status-badge.diagnostic { background-color: rgba(var(--accent-secondary-rgb), 0.1); color: var(--accent-secondary); border-color: rgba(var(--accent-secondary-rgb), 0.3); }
        .status-badge.exercise, .status-badge.completed { background-color: rgba(var(--accent-lime-rgb), 0.1); color: var(--accent-lime); border-color: rgba(var(--accent-lime-rgb), 0.3); }
        .status-badge.badge, .status-badge.earned { background-color: rgba(var(--accent-orange-rgb), 0.15); color: var(--accent-orange); border-color: rgba(var(--accent-orange-rgb), 0.3); }
        .status-badge.lesson, .status-badge.pending { background-color: rgba(var(--accent-cyan-rgb), 0.1); color: var(--accent-cyan); border-color: rgba(var(--accent-cyan-rgb), 0.3); }
        .status-badge.plan_generated, .status-badge.generated { background-color: rgba(var(--accent-primary-rgb), 0.1); color: var(--accent-primary); border-color: rgba(var(--accent-primary-rgb), 0.3); }
        .status-badge.level_up { background-color: rgba(var(--accent-pink-rgb), 0.1); color: var(--accent-pink); border-color: rgba(var(--accent-pink-rgb), 0.3); }
        .status-badge.other, .status-badge.default, .status-badge.skipped { background-color: rgba(var(--text-muted-rgb), 0.1); color: var(--text-muted); border-color: rgba(var(--text-muted-rgb), 0.3); }
        .status-badge.in-progress { background-color: rgba(var(--accent-orange-rgb), 0.1); color: var(--accent-orange); border-color: rgba(var(--accent-orange-rgb), 0.3); }
        .status-badge.failed { background-color: rgba(var(--accent-pink-rgb), 0.1); color: var(--accent-pink); border-color: rgba(var(--accent-pink-rgb), 0.3); }
        .points-value { font-weight: 600; color: var(--accent-secondary); text-shadow: 0 0 5px var(--accent-secondary-glow); }
        .table-activity-title { max-width: 350px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: middle; color: var(--text-light);}
        .loading-overlay { position: absolute; inset: 0; background-color: rgba(var(--card-solid-rgb), 0.8); display: flex; justify-content: center; align-items: center; z-index: 10; border-radius: var(--card-radius); transition: opacity 0.3s ease-out; opacity: 1; backdrop-filter: blur(3px); }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 32px; height: 32px; border: 4px solid var(--accent-primary); border-radius: 50%; border-top-color: transparent; border-right-color: transparent; animation: loading-spinner 0.8s linear infinite; }
        .skeleton { background-color: var(--skeleton-bg); border-radius: 4px; position: relative; overflow: hidden; }
        .skeleton::after { content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, var(--skeleton-highlight), transparent); animation: skeleton-loading 1.5s infinite linear; }
        @keyframes skeleton-loading { 0% { left: -150%; } 100% { left: 150%; } }
        .skeleton.title-sm { height: 16px; width: 65%; margin-bottom: 0.6rem; }
        .skeleton.value-lg { height: 40px; width: 45%; margin-bottom: 0.5rem; border-radius: 6px; }
        .skeleton.text-md { height: 18px; width: 85%; margin-bottom: 0.4rem; }
        .skeleton.text-sm { height: 15px; width: 75%; }
        .data-table tbody.loading tr.skeleton-row td .skeleton { margin-bottom: 0; }
        .data-table tbody:not(.loading) tr.skeleton-row { display: none; }
        .data-table tbody.loading tr:not(.skeleton-row) { display: none; }
        .empty-state { padding: 3rem 2rem; text-align: center; color: var(--text-muted); display: none; background-color: transparent; border-radius: var(--card-radius); border: 1px dashed var(--border-color-medium); margin-top: 1rem; }
        .empty-state i { font-size: 3rem; margin-bottom: 1.2rem; color: var(--accent-secondary); opacity: 0.6; }
        .empty-state p { margin: 0 auto 1.5rem auto; font-size: 1rem; max-width: 450px; color: var(--text-medium); }
        .pagination-controls { display: none; flex-direction: row; justify-content: center; align-items: center; margin-top: 2rem; text-align: center; padding-top: 1.5rem; border-top: 1px solid var(--border-color-light); }
        #page-info { margin: 0 1rem; font-size: 0.95rem; color: var(--text-medium); vertical-align: middle; }
        .pagination-controls .btn { padding: 0.5rem 1rem; background-color: transparent; border: 1px solid var(--border-color-light); color: var(--text-medium); }
        .pagination-controls .btn:hover:not(:disabled) { background-color: rgba(var(--accent-primary-rgb), 0.1); border-color: var(--accent-primary); color: var(--accent-primary); }
        .pagination-controls .btn:disabled { background-color: transparent; border-color: var(--border-color-light); color: var(--text-muted); opacity: 0.5; }
        .pagination-controls .btn i { font-size: 0.9em; }
        .error-container { display: none; margin-bottom: 1.5rem; }
        .error-message { background-color: rgba(var(--accent-pink-rgb), 0.1); border-left: 5px solid var(--accent-pink); color: var(--accent-pink); padding: 1rem 1.2rem; margin: 0; border-radius: 8px; font-size: 0.95rem; display: flex; align-items: center; box-shadow: 0 3px 8px rgba(var(--accent-pink-rgb), 0.2); }
        .error-message i { margin-right: 0.8rem; font-size: 1.3rem; }
        .retry-button { margin-left: auto; padding: 0.4rem 0.8rem; font-size: 0.85rem; background: var(--accent-pink); color: var(--white); border: none; border-radius: var(--button-radius); }
        .retry-button:hover { background: var(--accent-secondary); }
        .toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1050; display: flex; flex-direction: column; gap: 0.8rem; max-width: 380px; pointer-events: none; }
        .toast { padding: 1rem 1.3rem; border-radius: 12px; background: var(--interface-bg); box-shadow: var(--shadow-card); display: flex; align-items: flex-start; color: var(--text-light); animation: toast-in 0.45s cubic-bezier(0.215, 0.610, 0.355, 1) forwards; pointer-events: auto; border: 1px solid var(--border-color-medium); border-left-width: 5px; opacity: 0; transform: translateX(110%); backdrop-filter: blur(4px); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { border-left-color: var(--accent-lime); } .toast.error { border-left-color: var(--accent-pink); } .toast.info { border-left-color: var(--accent-primary); } .toast.warning { border-left-color: var(--accent-orange); }
        .toast-icon { margin-right: 0.8rem; font-size: 1.3rem; flex-shrink: 0; margin-top: 3px; }
        .toast.success .toast-icon { color: var(--accent-lime); } .toast.error .toast-icon { color: var(--accent-pink); } .toast.info .toast-icon { color: var(--accent-primary); } .toast.warning .toast-icon { color: var(--accent-orange); }
        .toast-content { flex: 1; } .toast-title { font-weight: 600; margin-bottom: 0.3rem; font-size: 1rem; color: var(--text-heading); } .toast-message { font-size: 0.9rem; color: var(--text-medium); line-height: 1.5; }
        .toast-close { background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 1.4rem; padding: 0.1rem 0.2rem; margin-left: 0.6rem; line-height: 1; opacity: 0.7; transition: opacity 0.2s, color 0.2s; }
        .toast-close:hover { opacity: 1; color: var(--accent-primary); }
        @keyframes toast-in { from { opacity: 0; transform: translateX(110%); } to { opacity: 1; transform: translateX(0); } }
        .initial-loading-overlay { position: fixed; inset: 0; background-color: var(--bg-color); z-index: 1100; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 1.2rem; transition: opacity 0.6s ease-out, visibility 0s 0.6s; opacity: 1; visibility: visible; }
        .initial-loading-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .initial-loading-overlay .loading-spinner { width: 40px; height: 40px; border-width: 5px; border-color: var(--accent-primary); border-top-color: transparent; border-right-color: transparent; animation: loading-spinner 0.9s linear infinite; }
        .initial-loading-overlay p { color: var(--text-medium); font-size: 1.1rem; font-weight: 500; letter-spacing: 0.5px; }
        @media (max-width: 992px) { :root { --sidebar-width: 85px; } main { margin-left: 85px; width: calc(100% - 85px); } .sidebar { width: 85px; } .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; } .sidebar-link i { margin-right: 0; font-size: 1.6rem; } .sidebar-logo i { margin-right: 0; } .sidebar-header, .sidebar-link { justify-content: center; } .user-profile { justify-content: center; padding: 0.8rem; } .user-avatar { margin-right: 0; width: 45px; height: 45px; } .mobile-menu-toggle { display: block; } #sidebar-close-toggle { display: none !important; } .stats-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); } }
        @media (max-width: 768px) { main { padding: 1rem; } .dashboard-header { padding: 1rem 1.25rem; } body.scrolled .dashboard-header { margin: 0 -1rem 1.5rem -1rem; padding: 1rem 1.25rem; } .header-title { gap: 0.5rem; } .header-title h1 { font-size: 1.5rem; } .stats-grid { grid-template-columns: 1fr; gap: 1.25rem; } .stats-card, .chart-section, .data-table-section { padding: 1.5rem; } .chart-header, .data-table-header { flex-direction: column; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem; } .chart-title, .data-table-title { font-size: 1.25rem; } .chart-actions, .data-table-actions { width: 100%; justify-content: flex-start; } .chart-container { height: 300px; } .data-table th, .data-table td { padding: 0.8rem 1rem; } .dashboard-footer { margin-top: 1.5rem; padding-top: 1rem;} }
        @media (max-width: 576px) { :root { --sidebar-width: 0; } main { margin-left: 0; width: 100%; padding: 0.75rem; } body.scrolled .dashboard-header { margin: 0 -0.75rem 1rem -0.75rem; padding: 0.75rem 1rem; } .sidebar { transform: translateX(-110%); z-index: 1100; width: 280px; } .sidebar.active { transform: translateX(0); } .sidebar.active .sidebar-logo span, .sidebar.active .sidebar-link span, .sidebar.active .user-info, .sidebar.active .sidebar-footer { display: block; } .sidebar.active .sidebar-link i { margin-right: 0.85rem; font-size: 1.25rem; } .sidebar.active .sidebar-header, .sidebar.active .sidebar-link { justify-content: flex-start; } .sidebar.active .user-profile { padding: 1rem; } .sidebar.active .user-avatar { margin-right: 0.85rem; width: 42px; height: 42px; } .sidebar.active #sidebar-close-toggle { display: block; } .header-title h1 { font-size: 1.3rem; } .header-actions { gap: 0.5rem; } .stats-card-value { font-size: 2rem; } .stats-card-description { font-size: 0.85rem; } .stats-card-footer { font-size: 0.8rem; } .data-table { font-size: 0.85rem; } .data-table th, .data-table td { padding: 0.6rem 0.8rem; } .status-badge { padding: 0.2rem 0.6rem; font-size: 0.7rem; } .toast-container { bottom: 1rem; right: 1rem; max-width: calc(100% - 1.5rem); } .mouse-follower-glow { display: none !important; } }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background-color: rgba(3, 2, 12, 0.7); z-index: 999; opacity: 0; transition: opacity var(--transition-medium) ease; backdrop-filter: blur(5px); }
        .sidebar-overlay.active { display: block; opacity: 1; }
        @media (prefers-reduced-motion: reduce) { html { scroll-behavior: auto; } *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; animation-delay: -0.01ms !important; transition-delay: 0ms !important; will-change: auto !important; } .sidebar { transition: transform 0.01ms !important; } .main-content-wrapper [data-animate] { opacity: 1 !important; transform: none !important; transition: none !important; } .mouse-follower-glow { display: none !important; } body::before, body::after { animation: none !important; } .refresh-btn.loading i { animation: none !important; } .loading-spinner, .initial-loading-overlay .loading-spinner { animation: none !important; border: 4px solid var(--accent-primary) !important; } .card:hover, .shortcut-card:hover, .btn:hover, .btn-outline:hover, .welcome-button:hover, .refresh-btn:hover, .view-all-link:hover { transform: none !important; } .skeleton::after { animation: none !important; background: var(--skeleton-highlight) !important; } }
        .tooltipster-shadow { border-radius: 6px; background: var(--interface-bg); color: var(--text-light); box-shadow: var(--shadow-card); border: 1px solid var(--border-color-medium); }
        .tooltipster-shadow .tooltipster-content { padding: 8px 12px; font-size: 0.85rem; }
        .dashboard-footer { margin-top: 3rem; padding: 1.5rem 0; text-align: center; color: var(--text-muted); font-size: 0.9rem; border-top: 1px solid var(--border-color-light); opacity: 0.6; }
        /* --- END: Cyberpunk CSS Theme --- */
    </style>
</head>

<body class="dark">
    <div class="initial-loading-overlay" id="initial-loader">
        <div class="loading-spinner"></div>
        <p>SYNCHRONIZACE POKROKU...</p>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <button class="mobile-menu-toggle" id="sidebar-close-toggle"> <i class="fas fa-times"></i> </button>
            <a href="/dashboard/dashboard.html" class="sidebar-logo"> <i class="fas fa-atom"></i> <span>Justax</span> </a>
        </div>
        <ul class="sidebar-menu">
             <li class="sidebar-item"> <a href="/dashboard/dashboard.html" class="sidebar-link"> <i class="fas fa-tachometer-alt"></i> <span>Nástěnka</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link"> <i class="fas fa-laptop-code"></i> <span>Procvičování</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link active"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-database"></i> <span>Databanka</span> </a> </li>
             <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-astronaut"></i> <span>Profil</span> </a> </li>
        </ul>
        <div class="user-profile">
            <div class="user-avatar" id="user-avatar">?</div>
            <div class="user-info">
                <div class="user-name" id="user-name">Načítání...</div>
                <div class="user-role">Pilot</div>
            </div>
        </div>
        <div class="sidebar-footer"> &copy; <span id="currentYearSidebar">2025</span> Justax Systems </div>
    </aside>

    <main id="main-content">
        <header class="dashboard-header">
             <div class="header-title">
                  <button class="mobile-menu-toggle" id="mobile-menu-toggle"> <i class="fas fa-bars"></i> </button>
                 <h1><i class="fas fa-chart-network"></i> Přehled pokroku</h1>
                 <div class="header-time" id="current-time"></div>
             </div>
            <div class="header-actions">
                <button class="refresh-btn btn-tooltip" id="refresh-btn" title="Obnovit data">
                    <i class="fas fa-sync-alt"></i>
                    <span class="button-text">Obnovit</span>
                </button>
            </div>
        </header>
        <div class="error-container" id="global-error"></div>

        <div class="main-content-wrapper">
            <div class="stats-grid" id="stats-grid">
                <div class="stats-card loading card" data-type="progress" data-animate style="--animation-order: 1;">
                    <div class="loading-skeleton"> <div class="skeleton-info"> <div class="skeleton title-sm" style="width: 70%;"></div> <div class="skeleton value-lg" style="width: 50%;"></div> <div class="skeleton text-md" style="width: 90%;"></div> </div> <div style="margin-top: auto; border-top: 1px solid transparent; padding-top: 1rem;"> <div class="skeleton text-sm" style="width: 65%;"></div> </div> </div>
                    <div class="stats-card-header"> <h3 class="stats-card-title"><i class="fas fa-tasks"></i>Celkový pokrok</h3> </div>
                    <div class="stats-card-content"> <div class="stats-card-value" id="overall-progress-value">- %</div> <div class="stats-card-description" id="overall-progress-desc">Průměr ze všech oblastí</div> </div>
                    <div class="stats-card-footer" id="overall-progress-footer"><i class="fas fa-minus"></i> Načítání...</div>
                </div>
                <div class="stats-card loading card" data-type="points" data-animate style="--animation-order: 2;">
                     <div class="loading-skeleton"> <div class="skeleton-info"> <div class="skeleton title-sm" style="width: 60%;"></div> <div class="skeleton value-lg" style="width: 40%;"></div> <div class="skeleton text-md" style="width: 80%;"></div> </div> <div style="margin-top: auto; border-top: 1px solid transparent; padding-top: 1rem;"> <div class="skeleton text-sm" style="width: 70%;"></div> </div> </div>
                    <div class="stats-card-header"> <h3 class="stats-card-title"><i class="fas fa-star"></i>Celkem bodů</h3> </div>
                    <div class="stats-card-content"> <div class="stats-card-value" id="total-points-value">-</div> <div class="stats-card-description" id="total-points-desc">Získané za aktivity a testy</div> </div>
                    <div class="stats-card-footer" id="total-points-footer"><i class="fas fa-minus"></i> Načítání...</div>
                </div>
                <div class="stats-card loading card" data-type="streak" data-animate style="--animation-order: 3;">
                     <div class="loading-skeleton"> <div class="skeleton-info"> <div class="skeleton title-sm" style="width: 65%;"></div> <div class="skeleton value-lg" style="width: 30%;"></div> <div class="skeleton text-md" style="width: 85%;"></div> </div> <div style="margin-top: auto; border-top: 1px solid transparent; padding-top: 1rem;"> <div class="skeleton text-sm" style="width: 60%;"></div> </div> </div>
                    <div class="stats-card-header"> <h3 class="stats-card-title"><i class="fas fa-fire"></i>Studijní série</h3> </div>
                    <div class="stats-card-content"> <div class="stats-card-value" id="streak-value">-</div> <div class="stats-card-description" id="streak-desc">Počet dnů studia v řadě</div> </div>
                    <div class="stats-card-footer" id="streak-footer">Nejdelší série: -</div>
                </div>
                <div class="stats-card loading card" data-type="exercises" data-animate style="--animation-order: 4;">
                    <div class="loading-skeleton"> <div class="skeleton-info"> <div class="skeleton title-sm" style="width: 80%;"></div> <div class="skeleton value-lg" style="width: 45%;"></div> <div class="skeleton text-md" style="width: 75%;"></div> </div> <div style="margin-top: auto; border-top: 1px solid transparent; padding-top: 1rem;"> <div class="skeleton text-sm" style="width: 55%;"></div> </div> </div>
                    <div class="stats-card-header"> <h3 class="stats-card-title"><i class="fas fa-check-double"></i>Dokončené aktivity</h3> </div>
                    <div class="stats-card-content"> <div class="stats-card-value" id="completed-count-value">-</div> <div class="stats-card-description" id="completed-count-desc">Počet testů a cvičení</div> </div>
                    <div class="stats-card-footer" id="completed-count-footer"><i class="fas fa-minus"></i> Načítání...</div>
                </div>
            </div>

            <div class="chart-section card" id="progress-chart-section" data-animate style="--animation-order: 5;">
                <div class="loading-overlay hidden" id="chart-loading-overlay"> <div class="loading-spinner"></div> </div>
                <div class="chart-header">
                    <h2 class="chart-title"><i class="fas fa-chart-line"></i>Vývoj pokroku v čase</h2>
                    <div class="chart-actions">
                        <select id="chart-period-select" class="form-control btn-sm btn-secondary" aria-label="Vyberte období grafu">
                            <option value="week">Poslední týden</option>
                            <option value="month" selected>Poslední měsíc</option>
                            <option value="3months">Poslední 3 měsíce</option>
                            <option value="all">Celkově</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="progressChart"></canvas>
                    <div class="empty-chart-message" id="chart-empty-state" style="display: none;">
                        <i class="fas fa-chart-line"></i>
                        <p>Nedostatek dat pro graf.</p>
                    </div>
                </div>
            </div>

            <div class="data-table-section card" id="activities-section" data-animate style="--animation-order: 6;">
                <div class="loading-overlay hidden" id="table-loading-overlay"> <div class="loading-spinner"></div> </div>
                <div class="data-table-header">
                    <h2 class="data-table-title"><i class="fas fa-history"></i>Historie aktivit</h2>
                    <div class="data-table-actions">
                        <button class="btn btn-secondary btn-sm btn-tooltip" id="export-table-btn" title="Exportovat tabulku jako CSV">
                            <i class="fas fa-download"></i>
                            <span class="button-text">Export</span>
                        </button>
                        <select id="activity-type-filter" class="form-control btn-sm btn-secondary" aria-label="Filtrovat typ aktivity">
                            <option value="all">Všechny typy</option>
                            <option value="test">Testy</option>
                            <option value="diagnostic">Diagnostika</option>
                            <option value="exercise">Cvičení</option>
                            <option value="lesson">Lekce</option>
                            <option value="badge">Odznaky</option>
                            <option value="plan_generated">Plány</option>
                            <option value="level_up">Postup</option>
                            <option value="other">Jiné</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="data-table" id="activities-table" style="display: none;">
                        <thead>
                            <tr>
                                <th data-sort="created_at">Datum <i class="fas fa-sort"></i></th>
                                <th data-sort="type">Typ <i class="fas fa-filter"></i></th>
                                <th data-sort="title">Název / Popis</th>
                                <th data-sort="points_earned">Body <i class="fas fa-sort"></i></th>
                                <th data-sort="status">Stav</th>
                            </tr>
                        </thead>
                        <tbody id="activities-body">
                            </tbody>
                    </table>
                </div>
                <div class="empty-state" id="activities-empty-state" style="display: none;">
                    <i class="fas fa-box-open"></i>
                    <p>Zatím žádné zaznamenané aktivity.</p>
                </div>
                <div class="pagination-controls" id="pagination-controls" style="display: none;">
                    <button class="btn btn-secondary btn-sm" id="prev-page-btn" disabled><i class="fas fa-chevron-left"></i></button>
                    <span id="page-info">Strana 1 z 1</span>
                    <button class="btn btn-secondary btn-sm" id="next-page-btn" disabled><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            <footer class="dashboard-footer">
                <p>&copy; <span id="currentYearFooter">2025</span> Justax Systems // Secure Channel</p>
            </footer>
        </div>
    </main>

    <div id="mouse-follower" class="mouse-follower-glow"></div>

    <script>
        (function() {
            const supabaseUrl = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
            let supabase = null;
            let currentUser = null;
            let currentProfile = null;
            let progressChartInstance = null;
            let currentActivitiesPage = 1;
            const activitiesPerPage = 10;
            let totalActivitiesCount = 0;
            let currentSort = { column: 'created_at', direction: 'desc' };
            let currentFilter = 'all';
            let allActivitiesData = [];
            let isLoading = { stats: false, chart: false, activities: false };

            const ui = {
                 sidebarAvatar: document.getElementById('user-avatar'),
                 sidebarName: document.getElementById('user-name'),
                 currentTime: document.getElementById('current-time'),
                 refreshBtn: document.getElementById('refresh-btn'),
                 globalError: document.getElementById('global-error'),
                 statsGrid: document.getElementById('stats-grid'),
                 overallProgressValue: document.getElementById('overall-progress-value'),
                 overallProgressDesc: document.getElementById('overall-progress-desc'),
                 overallProgressFooter: document.getElementById('overall-progress-footer'),
                 totalPointsValue: document.getElementById('total-points-value'),
                 totalPointsDesc: document.getElementById('total-points-desc'),
                 totalPointsFooter: document.getElementById('total-points-footer'),
                 streakValue: document.getElementById('streak-value'),
                 streakDesc: document.getElementById('streak-desc'),
                 streakFooter: document.getElementById('streak-footer'),
                 completedCountValue: document.getElementById('completed-count-value'),
                 completedCountDesc: document.getElementById('completed-count-desc'),
                 completedCountFooter: document.getElementById('completed-count-footer'),
                 progressChartSection: document.getElementById('progress-chart-section'),
                 chartLoadingOverlay: document.getElementById('chart-loading-overlay'),
                 progressChartCanvas: document.getElementById('progressChart'),
                 chartEmptyState: document.getElementById('chart-empty-state'),
                 chartPeriodSelect: document.getElementById('chart-period-select'),
                 activitiesSection: document.getElementById('activities-section'),
                 tableLoadingOverlay: document.getElementById('table-loading-overlay'),
                 activitiesTable: document.getElementById('activities-table'),
                 activitiesBody: document.getElementById('activities-body'),
                 activitiesEmptyState: document.getElementById('activities-empty-state'),
                 activityTypeFilter: document.getElementById('activity-type-filter'),
                 exportTableBtn: document.getElementById('export-table-btn'),
                 tableHeaders: document.querySelectorAll('#activities-table th[data-sort]'),
                 paginationControls: document.getElementById('pagination-controls'),
                 prevPageBtn: document.getElementById('prev-page-btn'),
                 nextPageBtn: document.getElementById('next-page-btn'),
                 pageInfo: document.getElementById('page-info'),
                 toastContainer: document.getElementById('toast-container'),
                 mobileMenuToggle: document.getElementById('mobile-menu-toggle'),
                 sidebar: document.getElementById('sidebar'),
                 sidebarOverlay: document.getElementById('sidebar-overlay'),
                 sidebarCloseToggle: document.getElementById('sidebar-close-toggle'),
                 mainElement: document.getElementById('main-content'),
                 dashboardHeader: document.querySelector('.dashboard-header'),
                 initialLoader: document.getElementById('initial-loader'),
                 mouseFollower: document.getElementById('mouse-follower'),
                 currentYearSidebar: document.getElementById('currentYearSidebar'),
                 currentYearFooter: document.getElementById('currentYearFooter')
            };

             const activityTypeMap = {
                 test: { name: 'Test', icon: 'fa-vial', class: 'test' },
                 exercise: { name: 'Cvičení', icon: 'fa-pencil-alt', class: 'exercise' },
                 badge: { name: 'Odznak', icon: 'fa-medal', class: 'badge' },
                 diagnostic: { name: 'Diagnostika', icon: 'fa-clipboard-check', class: 'diagnostic' },
                 lesson: { name: 'Lekce', icon: 'fa-book-open', class: 'lesson' },
                 plan_generated: { name: 'Plán', icon: 'fa-calendar-alt', class: 'plan_generated' },
                 level_up: { name: 'Postup', icon: 'fa-level-up-alt', class: 'level_up' },
                 other: { name: 'Jiná', icon: 'fa-info-circle', class: 'other' },
                 default: { name: 'Aktivita', icon: 'fa-check-circle', class: 'default' }
             };
             const activityStatusMap = {
                 completed: { name: 'Dokončeno', class: 'completed', icon: 'fa-check-circle' },
                 'in-progress': { name: 'Probíhá', class: 'in-progress', icon: 'fa-spinner fa-spin' },
                 pending: { name: 'Čeká', class: 'pending', icon: 'fa-clock' },
                 failed: { name: 'Neúspěch', class: 'failed', icon: 'fa-times-circle' },
                 earned: { name: 'Získáno', class: 'earned', icon: 'fa-medal' },
                 generated: { name: 'Vygenerováno', class: 'generated', icon: 'fa-magic' },
                 skipped: { name: 'Přeskočeno', class: 'skipped', icon: 'fa-forward' },
                 default: { name: 'Neznámý', class: 'default', icon: 'fa-question-circle' }
             };

            function showToast(title, message, type = 'info', duration = 4500) { if (!ui.toastContainer) return; try { const toastId = `toast-${Date.now()}`; const toastElement = document.createElement('div'); toastElement.className = `toast ${type}`; toastElement.id = toastId; toastElement.setAttribute('role', 'alert'); toastElement.setAttribute('aria-live', 'assertive'); toastElement.innerHTML = `<i class="toast-icon"></i><div class="toast-content">${title ? `<div class="toast-title">${sanitizeHTML(title)}</div>` : ''}<div class="toast-message">${sanitizeHTML(message)}</div></div><button type="button" class="toast-close" aria-label="Zavřít">&times;</button>`; const icon = toastElement.querySelector('.toast-icon'); icon.className = `toast-icon fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}`; toastElement.querySelector('.toast-close').addEventListener('click', () => { toastElement.classList.remove('show'); setTimeout(() => toastElement.remove(), 400); }); ui.toastContainer.appendChild(toastElement); requestAnimationFrame(() => { toastElement.classList.add('show'); }); setTimeout(() => { if (toastElement.parentElement) { toastElement.classList.remove('show'); setTimeout(() => toastElement.remove(), 400); } }, duration); } catch (e) { console.error("Chyba při zobrazování toastu:", e); } }
            function showError(message, isGlobal = false) { console.error("Došlo k chybě:", message); if (isGlobal && ui.globalError) { ui.globalError.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><div>${sanitizeHTML(message)}</div><button class="retry-button btn" onclick="location.reload()">Zkusit Znovu</button></div>`; ui.globalError.style.display = 'block'; } else { showToast('CHYBA SYSTÉMU', message, 'error', 6000); } }
            function hideGlobalError() { if (ui.globalError) ui.globalError.style.display = 'none'; }
            function sanitizeHTML(str) { const temp = document.createElement('div'); temp.textContent = str || ''; return temp.innerHTML; }
            function getInitials(userData) { if (!userData) return '?'; const f = userData.first_name?.[0] || ''; const l = userData.last_name?.[0] || ''; const nameInitial = (f + l).toUpperCase(); const usernameInitial = userData.username?.[0].toUpperCase() || ''; const emailInitial = userData.email?.[0].toUpperCase() || ''; return nameInitial || usernameInitial || emailInitial || '?'; }
            function formatDate(dateString, includeTime = false) { if (!dateString) return '-'; try { const date = new Date(dateString); if (isNaN(date.getTime())) return '-'; const optionsDate = { day: 'numeric', month: 'numeric', year: 'numeric' }; const optionsTime = { hour: '2-digit', minute: '2-digit' }; let formatted = date.toLocaleDateString('cs-CZ', optionsDate); if (includeTime) { formatted += ' ' + date.toLocaleTimeString('cs-CZ', optionsTime); } return formatted; } catch (e) { console.error("Chyba formátování data:", dateString, e); return '-'; } }
            function updateCurrentTime() { if (ui.currentTime) ui.currentTime.textContent = new Date().toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' }); }
            function toggleMobileMenu() { ui.sidebar?.classList.toggle('active'); ui.sidebarOverlay?.classList.toggle('active'); }
            function handleScroll() { if (!ui.mainElement || !ui.dashboardHeader) return; document.body.classList.toggle('scrolled', ui.mainElement.scrollTop > 10); }
            function setLoadingState(section, isLoadingFlag) { if (isLoading[section] === isLoadingFlag && section !== 'all') return; if (section === 'all') { Object.keys(isLoading).forEach(key => isLoading[key] = isLoadingFlag); } else { isLoading[section] = isLoadingFlag; } console.log(`[setLoadingState] Sekce: ${section}, isLoading: ${isLoadingFlag}`); const overlayMap = { chart: ui.chartLoadingOverlay, activities: ui.tableLoadingOverlay }; const contentMap = { chart: ui.progressChartCanvas, activities: ui.activitiesTable }; const emptyStateMap = { chart: ui.chartEmptyState, activities: ui.activitiesEmptyState }; const sectionsToUpdate = section === 'all' ? Object.keys(isLoading) : [section]; sectionsToUpdate.forEach(sec => { if (sec === 'stats' && ui.statsGrid) { ui.statsGrid.querySelectorAll('.stats-card').forEach(card => card.classList.toggle('loading', isLoadingFlag)); } const overlay = overlayMap[sec]; const contentEl = contentMap[sec]; const emptyEl = emptyStateMap[sec]; if (overlay) overlay.classList.toggle('hidden', !isLoadingFlag); if (isLoadingFlag && contentEl) contentEl.style.display = 'none'; if (isLoadingFlag && emptyEl) emptyEl.style.display = 'none'; if (sec === 'activities' && ui.activitiesBody) { if (isLoadingFlag) { renderSkeletonRows(activitiesPerPage); ui.activitiesBody.classList.add('loading'); if (ui.activitiesTable) ui.activitiesTable.style.display = 'table'; if (ui.paginationControls) ui.paginationControls.style.display = 'none'; } else { ui.activitiesBody.classList.remove('loading'); } } }); }
            function renderSkeletonRows(count = 5) { if (!ui.activitiesBody) return; let skeletonHTML = ''; for (let i = 0; i < count; i++) { skeletonHTML += `<tr class="skeleton-row"><td><div class="skeleton text-sm" style="width: 70px;"></div></td><td><div class="skeleton text-sm" style="width: 80px;"></div></td><td><div class="skeleton text-sm" style="width: 150px;"></div></td><td><div class="skeleton text-sm" style="width: 40px;"></div></td><td><div class="skeleton text-sm" style="width: 90px;"></div></td></tr>`; } ui.activitiesBody.innerHTML = skeletonHTML; }
            function initializeTooltips() { console.log("[Tooltips] Inicializace..."); try { if (window.jQuery && window.jQuery.fn.tooltipster) { window.jQuery('.btn-tooltip.tooltipstered').each(function() { if (document.body.contains(this)) { window.jQuery(this).tooltipster('destroy'); } }); window.jQuery('.btn-tooltip').tooltipster({ theme: 'tooltipster-shadow', animation: 'fade', delay: 150, distance: 6, side: 'top' }); console.log("[Tooltips] Initialized."); } else { console.warn("[Tooltips] jQuery or Tooltipster not loaded."); } } catch (e) { console.error("[Tooltips] Error initializing Tooltipster:", e); } }
            const initMouseFollower = () => { const follower = ui.mouseFollower; if (!follower || window.innerWidth <= 576) return; let hasMoved = false; const updatePosition = (event) => { if (!hasMoved) { document.body.classList.add('mouse-has-moved'); hasMoved = true; } requestAnimationFrame(() => { follower.style.left = `${event.clientX}px`; follower.style.top = `${event.clientY}px`; }); }; window.addEventListener('mousemove', updatePosition, { passive: true }); document.body.addEventListener('mouseleave', () => { if (hasMoved) follower.style.opacity = '0'; }); document.body.addEventListener('mouseenter', () => { if (hasMoved) follower.style.opacity = '1'; }); window.addEventListener('touchstart', () => { follower.style.display = 'none'; }, { passive: true, once: true }); };
            const initScrollAnimations = () => { const animatedElements = document.querySelectorAll('.main-content-wrapper [data-animate]'); if (!animatedElements.length || !('IntersectionObserver' in window)) return; const observer = new IntersectionObserver((entries, observerInstance) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('animated'); observerInstance.unobserve(entry.target); } }); }, { threshold: 0.1, rootMargin: "0px 0px -30px 0px" }); animatedElements.forEach(element => observer.observe(element)); console.log(`Scroll animations initialized for ${animatedElements.length} elements.`); };
            const initHeaderScrollDetection = () => { let lastScrollY = ui.mainElement?.scrollTop || 0; const mainEl = ui.mainElement; if (!mainEl) return; mainEl.addEventListener('scroll', () => { const currentScrollY = mainEl.scrollTop; document.body.classList.toggle('scrolled', currentScrollY > 10); lastScrollY = currentScrollY <= 0 ? 0 : currentScrollY; }, { passive: true }); if (mainEl.scrollTop > 10) document.body.classList.add('scrolled'); };
            const updateCopyrightYear = () => { const year = new Date().getFullYear(); if (ui.currentYearSidebar) ui.currentYearSidebar.textContent = year; if (ui.currentYearFooter) ui.currentYearFooter.textContent = year; };

            function initializeSupabase() { try { if (typeof window.supabase === 'undefined' || typeof window.supabase.createClient !== 'function') { throw new Error("Knihovna Supabase nebyla správně načtena."); } supabase = window.supabase.createClient(supabaseUrl, supabaseKey); if (!supabase) throw new Error("Vytvoření klienta Supabase selhalo."); console.log('[Supabase] Klient úspěšně inicializován.'); return true; } catch (error) { console.error('[Supabase] Inicializace selhala:', error); showError("Kritická chyba: Nepodařilo se připojit k databázi.", true); return false; } }
            async function fetchUserProfile(userId) { if (!supabase) { console.error("[Profile] Supabase klient není dostupný."); return null; } console.log(`[Profile] Načítání profilu pro uživatele ID: ${userId}`); try { const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', userId).single(); if (error && error.code !== 'PGRST116') { throw error; } if (!profile) { console.warn(`[Profile] Profil pro uživatele ${userId} nenalezen. Vracím null.`); return null; } console.log("[Profile] Data profilu úspěšně načtena."); return profile; } catch (error) { console.error('[Profile] Zachycena výjimka při načítání profilu:', error); showToast('Chyba', 'Nepodařilo se načíst data profilu.', 'error'); return null; } }
            async function loadAllData() { if (!currentUser || !supabase || !currentProfile) { showError("Nelze načíst data: Chybí informace o uživateli nebo spojení.", true); setLoadingState('all', false); return; } if (Object.values(isLoading).some(s => s)) { console.log("[LoadAllData] Přeskakuji - data se již načítají."); return; } console.log("🔄 [LoadAllData] Zahájení načítání dat..."); hideGlobalError(); setLoadingState('all', true); try { const results = await Promise.allSettled([ fetchUserStats(currentUser.id, currentProfile), fetchProgressHistory(currentUser.id, ui.chartPeriodSelect?.value || 'month'), fetchRecentActivities(currentUser.id, currentActivitiesPage, activitiesPerPage, currentSort.column, currentSort.direction === 'asc', currentFilter) ]); console.log("[LoadAllData] Výsledky načítání (settled):", results); if (results[0].status === 'fulfilled') { updateStatsCards(results[0].value); } else { console.error("❌ Chyba při načítání statistik:", results[0].reason); showError("Nepodařilo se načíst statistiky pokroku.", false); updateStatsCards(null); } setLoadingState('stats', false); if (results[1].status === 'fulfilled') { renderProgressChart(results[1].value); } else { console.error("❌ Chyba při načítání historie pro graf:", results[1].reason); showError("Nepodařilo se načíst historii pro graf.", false); renderProgressChart(null); } setLoadingState('chart', false); if (results[2].status === 'fulfilled') { const activityResult = results[2].value || { data: [], count: 0 }; allActivitiesData = activityResult.data; totalActivitiesCount = activityResult.count; renderActivitiesTable(allActivitiesData); updatePaginationUI(); } else { console.error("❌ Chyba při načítání historie aktivit:", results[2].reason); showError("Nepodařilo se načíst historii aktivit.", false); allActivitiesData = []; totalActivitiesCount = 0; renderActivitiesTable(null); updatePaginationUI(); } setLoadingState('activities', false); initializeTooltips(); } catch (error) { console.error("❌ Neočekávaná chyba v loadAllData:", error); showError(`Nastala neočekávaná chyba: ${error.message}`, true); setLoadingState('all', false); updateStatsCards(null); renderProgressChart(null); renderActivitiesTable(null); updatePaginationUI(); } finally { console.log("🏁 [LoadAllData] Dokončeno načítání a zpracování dat."); } }
            async function fetchUserStats(userId, profileData) { if (!supabase || !userId || !profileData) { console.error("[Stats] Chybí Supabase klient, ID uživatele nebo data profilu."); return null; } console.log(`[Stats] Načítání statistik pro uživatele ${userId}...`); let fetchedStats = null; let statsError = null; try { const { data, error } = await supabase.from('user_stats').select('progress, progress_weekly, points_weekly, streak_longest, completed_tests').eq('user_id', userId).maybeSingle(); fetchedStats = data; statsError = error; if (statsError) { console.warn("[Stats] Supabase chyba při načítání user_stats:", statsError.message); } } catch (error) { console.error("[Stats] Neočekávaná chyba při načítání user_stats:", error); statsError = error; } const finalStats = { progress: fetchedStats?.progress ?? profileData.progress ?? 0, progress_weekly: fetchedStats?.progress_weekly ?? 0, points: profileData.points ?? 0, points_weekly: fetchedStats?.points_weekly ?? 0, streak_current: profileData.streak_days ?? 0, streak_longest: Math.max(fetchedStats?.streak_longest ?? 0, profileData.streak_days ?? 0), completed_exercises: profileData.completed_exercises ?? 0, completed_tests: profileData.completed_tests ?? fetchedStats?.completed_tests ?? 0 }; if (statsError) { console.warn("[Stats] Vracím statistiky založené primárně na profilu kvůli chybě načítání."); } else { console.log("[Stats] Statistiky úspěšně načteny/sestaveny:", finalStats); } return finalStats; }
            async function fetchProgressHistory(userId, period = 'month') { if (!supabase || !userId) { console.error("[ChartData] Chybí Supabase nebo ID uživatele."); return null; } console.log(`[ChartData] Načítání snímků pokroku pro uživatele ${userId}, období: ${period}`); const today = new Date(); let startDate = null; switch (period) { case 'week': startDate = dateFns.subDays(today, 7); break; case 'month': startDate = dateFns.subMonths(today, 1); break; case '3months': startDate = dateFns.subMonths(today, 3); break; case 'all': startDate = null; break; default: startDate = dateFns.subMonths(today, 1); } let query = supabase.from('progress_snapshots').select('snapshot_date, overall_progress').eq('user_id', userId); if (startDate) { const formattedStartDate = dateFns.formatISO(startDate, { representation: 'date' }); query = query.gte('snapshot_date', formattedStartDate); console.log(`[ChartData] Filtruji od data: ${formattedStartDate}`); } query = query.order('snapshot_date', { ascending: true }); try { const { data, error } = await query; if (error) { console.error("[ChartData] Supabase chyba při načítání snímků:", error); throw error; } console.log(`[ChartData] Načteno ${data?.length || 0} snímků.`); if (!data || data.length === 0) { return { labels: [], data: [] }; } const labels = data.map(item => new Date(item.snapshot_date + 'T00:00:00Z')); const progressData = data.map(item => item.overall_progress ?? 0); return { labels, data: progressData }; } catch (error) { console.error('[ChartData] Zachycena výjimka při načítání snímků:', error); showToast('Chyba', 'Nepodařilo se načíst data pro graf.', 'error'); return null; } }
            async function fetchRecentActivities(userId, page = 1, limit = 10, sortBy = 'created_at', ascending = false, filterType = 'all') { if (!supabase || !userId) { console.error("[Activities] Chybí Supabase klient nebo ID uživatele."); return { data: [], count: 0 }; } console.log(`[Activities] Načítání stránky ${page} (limit ${limit}), řazení: ${sortBy} ${ascending ? 'ASC' : 'DESC'}, filtr: ${filterType}`); const offset = (page - 1) * limit; let query = supabase.from('activities').select('*', { count: 'exact' }).eq('user_id', userId); if (filterType !== 'all') { query = query.eq('type', filterType); } const dbSortColumn = sortBy === 'points_earned' ? 'points_earned' : sortBy === 'status' ? 'status' : sortBy === 'title' ? 'title' : sortBy === 'type' ? 'type' : 'created_at'; query = query.order(dbSortColumn, { ascending: ascending }); query = query.range(offset, offset + limit - 1); try { const { data, error, count } = await query; if (error) { console.error("[Activities] Supabase chyba při načítání aktivit:", error); throw error; } console.log(`[Activities] Načteno ${data?.length || 0} aktivit. Celkový počet: ${count}`); return { data: data || [], count: count || 0 }; } catch (error) { console.error('[Activities] Zachycena výjimka při načítání aktivit:', error); showToast('Chyba', 'Nepodařilo se načíst historii aktivit.', 'error'); return { data: [], count: 0 }; } }

            function updateUserInfoUI() { console.log("[UI Update] Aktualizace informací uživatele v sidebaru..."); if (!ui.sidebarName || !ui.sidebarAvatar) { console.warn("[UI Update] Elementy sidebaru nenalezeny."); return; } if (currentUser && currentProfile) { const firstName = currentProfile.first_name ?? ''; const lastName = currentProfile.last_name ?? ''; const username = currentProfile.username ?? ''; const emailUsername = currentUser.email?.split('@')[0] || ''; const displayName = `${firstName} ${lastName}`.trim() || username || emailUsername || 'Pilot'; ui.sidebarName.textContent = sanitizeHTML(displayName); const initials = getInitials(currentProfile); const avatarUrl = currentProfile.avatar_url; ui.sidebarAvatar.innerHTML = avatarUrl ? `<img src="${sanitizeHTML(avatarUrl)}" alt="${initials}">` : sanitizeHTML(initials); console.log("[UI Update] Sidebar UI aktualizován."); } else { console.warn("[UI Update] Chybí currentUser nebo currentProfile, nastavuji výchozí hodnoty."); ui.sidebarName.textContent = "Nepřihlášen"; ui.sidebarAvatar.textContent = '?'; } }
            function updateStatsCards(stats) { console.log("[UI Update] Aktualizace karet statistik daty:", stats); const statElements = { progress: { value: ui.overallProgressValue, desc: ui.overallProgressDesc, footer: ui.overallProgressFooter }, points: { value: ui.totalPointsValue, desc: ui.totalPointsDesc, footer: ui.totalPointsFooter }, streak: { value: ui.streakValue, desc: ui.streakDesc, footer: ui.streakFooter }, completed: { value: ui.completedCountValue, desc: ui.completedCountDesc, footer: ui.completedCountFooter } }; ui.statsGrid?.querySelectorAll('.stats-card').forEach(card => card.classList.remove('loading')); if (!stats) { console.warn("[UI Update] Nejsou dostupná data statistik, zobrazuji chybový stav v kartách."); Object.values(statElements).forEach(els => { if (els.value) els.value.textContent = '-'; if (els.desc) els.desc.textContent = 'Data nedostupná'; if (els.footer) els.footer.innerHTML = '<i class="fas fa-exclamation-circle" style="color:var(--danger-color);"></i> Chyba'; }); return; } const completedTotal = (stats.completed_exercises || 0) + (stats.completed_tests || 0); if (statElements.progress.value) statElements.progress.value.textContent = `${stats.progress ?? 0}%`; if (statElements.progress.desc) statElements.progress.desc.textContent = "Průměrný pokrok"; if (statElements.progress.footer) { const change = stats.progress_weekly ?? 0; const icon = change > 0 ? 'fa-arrow-up' : change < 0 ? 'fa-arrow-down' : 'fa-minus'; const sign = change > 0 ? '+' : ''; statElements.progress.footer.className = `stats-card-footer ${change > 0 ? 'positive' : change < 0 ? 'negative' : ''}`; statElements.progress.footer.innerHTML = `<i class="fas ${icon}"></i> ${sign}${change}% tento týden`; } if (statElements.points.value) statElements.points.value.textContent = stats.points ?? 0; if (statElements.points.desc) statElements.points.desc.textContent = "Celkem získaných bodů"; if (statElements.points.footer) { const change = stats.points_weekly ?? 0; const icon = change > 0 ? 'fa-arrow-up' : change < 0 ? 'fa-arrow-down' : 'fa-minus'; const sign = change > 0 ? '+' : ''; statElements.points.footer.className = `stats-card-footer ${change > 0 ? 'positive' : change < 0 ? 'negative' : ''}`; statElements.points.footer.innerHTML = `<i class="fas ${icon}"></i> ${sign}${change} bodů tento týden`; } if (statElements.streak.value) statElements.streak.value.textContent = stats.streak_current ?? 0; if (statElements.streak.desc) statElements.streak.desc.textContent = `Aktuální série dnů`; if (statElements.streak.footer) statElements.streak.footer.innerHTML = `<i class="fas fa-medal"></i> Nejdelší: ${stats.streak_longest ?? 0} dnů`; if (statElements.completed.value) statElements.completed.value.textContent = completedTotal; if (statElements.completed.desc) statElements.completed.desc.textContent = `Cvičení: ${stats.completed_exercises || 0}, Testů: ${stats.completed_tests || 0}`; if (statElements.completed.footer) statElements.completed.footer.innerHTML = `<i class="fas fa-tasks"></i> Celkový počet`; console.log("[UI Update] Karty statistik aktualizovány."); }
            function renderProgressChart(chartData) { if (!ui.progressChartCanvas) { console.error("[Chart] Canvas element nenalezen."); setLoadingState('chart', false); return; } const ctx = ui.progressChartCanvas.getContext('2d'); if (!ctx) { console.error("[Chart] Nepodařilo se získat kontext canvasu."); setLoadingState('chart', false); return; } if (progressChartInstance) { progressChartInstance.destroy(); progressChartInstance = null; console.log("[Chart] Předchozí instance grafu zničena."); } if (!chartData || !chartData.labels || !chartData.data || chartData.labels.length === 0) { console.warn("[Chart] Nejsou platná data pro vykreslení grafu."); if (ui.progressChartCanvas) ui.progressChartCanvas.style.display = 'none'; if (ui.chartEmptyState) ui.chartEmptyState.style.display = 'flex'; setLoadingState('chart', false); return; } if (ui.progressChartCanvas) ui.progressChartCanvas.style.display = 'block'; if (ui.chartEmptyState) ui.chartEmptyState.style.display = 'none'; console.log("[Chart] Vykreslování grafu s daty:", chartData); const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; const gridColor = isDarkMode ? 'rgba(51, 65, 85, 0.4)' : 'rgba(var(--primary-rgb), 0.08)'; const textColor = isDarkMode ? '#94a3b8' : 'var(--text-muted)'; Chart.defaults.color = textColor; Chart.defaults.borderColor = isDarkMode ? 'rgba(71, 85, 105, 0.3)' : 'rgba(0,0,0,0.1)'; Chart.defaults.scale.grid.color = gridColor; const chartUnit = determineChartUnit(chartData.labels); const locale = dateFns.locale.cs || dateFns.locale.enUS; progressChartInstance = new Chart(ctx, { type: 'line', data: { labels: chartData.labels, datasets: [{ label: 'Pokrok (%)', data: chartData.data, borderColor: 'rgba(var(--accent-primary-rgb), 0.8)', backgroundColor: 'rgba(var(--accent-primary-rgb), 0.1)', borderWidth: 2.5, pointBackgroundColor: 'rgba(var(--accent-primary-rgb), 1)', pointRadius: 4, pointHoverRadius: 6, tension: 0.3, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', adapters: { date: { locale: locale } }, time: { unit: chartUnit, tooltipFormat: 'P', displayFormats: { day: 'd.M.', week: 'PP', month: 'LLLL yyyy', year: 'yyyy' } }, ticks: { color: textColor, maxRotation: 0, autoSkipPadding: 15 }, grid: { display: false } }, y: { beginAtZero: true, max: 100, ticks: { stepSize: 20, color: textColor, callback: function(value) { return value + '%'; } }, grid: { color: gridColor } } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, backgroundColor: isDarkMode ? 'rgba(15, 10, 45, 0.9)' : 'rgba(var(--dark), 0.9)', titleColor: isDarkMode ? '#e2e8f0' : '#ffffff', bodyColor: isDarkMode ? '#cbd5e0' : '#ffffff', borderColor: 'rgba(var(--accent-primary-rgb), 0.5)', borderWidth: 1, padding: 10, displayColors: false, callbacks: { title: (items) => dateFns.format(new Date(items[0].parsed.x), 'PPP', { locale: locale }), label: (ctx) => `Pokrok: ${ctx.parsed.y.toFixed(1)}%` } } }, interaction: { mode: 'nearest', axis: 'x', intersect: false } } }); console.log("[Chart] Graf úspěšně vykreslen."); }
            function determineChartUnit(labels) { if (!labels || labels.length < 2) return 'day'; const firstDate = labels[0]; const lastDate = labels[labels.length - 1]; if (!(firstDate instanceof Date) || !(lastDate instanceof Date)) { console.warn("[ChartUnit] Neplatné objekty Date v popiscích."); return 'day'; } const diffDays = dateFns.differenceInDays(lastDate, firstDate); if (diffDays <= 10) return 'day'; if (diffDays <= 90) return 'week'; if (diffDays <= 730) return 'month'; return 'year'; }
            function renderActivitiesTable(activities) { if (!ui.activitiesBody || !ui.activitiesTable || !ui.activitiesEmptyState) { console.error("[ActivitiesTable] Elementy tabulky nenalezeny."); setLoadingState('activities', false); return; } ui.activitiesBody.innerHTML = ''; if (!activities || activities.length === 0) { console.log("[ActivitiesTable] Nejsou žádné aktivity k zobrazení."); ui.activitiesTable.style.display = 'none'; ui.activitiesEmptyState.style.display = 'flex'; setLoadingState('activities', false); return; } console.log(`[ActivitiesTable] Vykreslování ${activities.length} aktivit.`); ui.activitiesTable.style.display = 'table'; ui.activitiesEmptyState.style.display = 'none'; const fragment = document.createDocumentFragment(); activities.forEach(activity => { const tr = document.createElement('tr'); const typeKey = activity.type?.toLowerCase() || 'default'; const statusKey = activity.status?.toLowerCase() || 'default'; const activityTypeInfo = activityTypeMap[typeKey] || activityTypeMap.default; const activityStatusInfo = activityStatusMap[statusKey] || activityStatusMap.default; const pointsEarned = activity.points_earned != null ? activity.points_earned : '-'; const titleOrDesc = sanitizeHTML(activity.title || activity.description || '-'); tr.innerHTML = `<td>${formatDate(activity.created_at, true)}</td><td><span class="status-badge ${activityTypeInfo.class || typeKey}"><i class="fas ${activityTypeInfo.icon}"></i> ${activityTypeInfo.name}</span></td><td><span class="table-activity-title" title="${titleOrDesc}">${titleOrDesc}</span></td><td class="points-value">${pointsEarned}</td><td><span class="status-badge ${activityStatusInfo.class}"><i class="fas ${activityStatusInfo.icon}"></i> ${activityStatusInfo.name}</span></td>`; fragment.appendChild(tr); }); ui.activitiesBody.appendChild(fragment); console.log("[ActivitiesTable] Tabulka vykreslena."); setLoadingState('activities', false); }
            function updatePaginationUI() { if (!ui.paginationControls || !ui.pageInfo || !ui.prevPageBtn || !ui.nextPageBtn) return; if (totalActivitiesCount <= activitiesPerPage) { ui.paginationControls.style.display = 'none'; return; } ui.paginationControls.style.display = 'flex'; const totalPages = Math.ceil(totalActivitiesCount / activitiesPerPage); ui.pageInfo.textContent = `Strana ${currentActivitiesPage} z ${totalPages}`; ui.prevPageBtn.disabled = currentActivitiesPage === 1; ui.nextPageBtn.disabled = currentActivitiesPage === totalPages; console.log(`[Pagination] UI aktualizováno: Strana ${currentActivitiesPage}/${totalPages}`); }

            function setupEventListeners() { console.log("[Events] Nastavování event listenerů..."); ui.refreshBtn?.addEventListener('click', async () => { if (Object.values(isLoading).some(s => s)) { showToast('Info', "Data se již načítají..."); return; } console.log("🔄 Manuální obnovení spuštěno..."); const icon = ui.refreshBtn.querySelector('i'); const text = ui.refreshBtn.querySelector('.button-text'); if (icon) icon.classList.add('loading'); if (text) text.textContent = 'Obnovuji...'; ui.refreshBtn.disabled = true; try { await loadAllData(); showToast('Úspěch', "Data byla úspěšně obnovena."); } catch (error) { showError("Obnovení dat selhalo: " + error.message); } finally { if (icon) icon.classList.remove('loading'); if (text) text.textContent = 'Obnovit'; ui.refreshBtn.disabled = false; initializeTooltips(); } }); ui.mobileMenuToggle?.addEventListener('click', toggleMobileMenu); ui.sidebarOverlay?.addEventListener('click', toggleMobileMenu); ui.sidebarCloseToggle?.addEventListener('click', toggleMobileMenu); ui.chartPeriodSelect?.addEventListener('change', handlePeriodChange); ui.activityTypeFilter?.addEventListener('change', handleActivityFilterChange); ui.exportTableBtn?.addEventListener('click', exportTableToCSV); ui.tableHeaders?.forEach(header => header.addEventListener('click', handleSortChange)); ui.prevPageBtn?.addEventListener('click', () => changeActivitiesPage(-1)); ui.nextPageBtn?.addEventListener('click', () => changeActivitiesPage(1)); ui.mainElement?.addEventListener('scroll', handleScroll, { passive: true }); window.addEventListener('resize', () => { if (window.innerWidth > 992 && ui.sidebar?.classList.contains('active')) toggleMobileMenu(); }); console.log("[Events] Event listenery nastaveny."); }
            async function handlePeriodChange() { if (!currentUser || isLoading.chart) return; console.log("[Chart] Období změněno, znovunačítání dat grafu..."); await reloadChartData(); }
            async function handleActivityFilterChange() { if (!currentUser || isLoading.activities) return; currentFilter = ui.activityTypeFilter.value; currentActivitiesPage = 1; console.log(`[Filter] Filtr aktivit změněn na: ${currentFilter}. Znovunačítání aktivit...`); await reloadActivities(); }
            async function handleSortChange(event) { if (isLoading.activities) return; const header = event.currentTarget; const newSortColumn = header.dataset.sort; if (!newSortColumn) return; let newDirection = 'desc'; if (currentSort.column === newSortColumn && currentSort.direction === 'desc') { newDirection = 'asc'; } currentSort = { column: newSortColumn, direction: newDirection }; currentActivitiesPage = 1; ui.tableHeaders?.forEach(th => { th.classList.remove('sort-asc', 'sort-desc'); const i = th.querySelector('i.fa-sort, i.fa-sort-up, i.fa-sort-down, i.fa-filter'); if(i) { if(i.classList.contains('fa-sort') || i.classList.contains('fa-sort-up') || i.classList.contains('fa-sort-down')) { i.className = 'fas fa-sort'; } } }); header.classList.add(newDirection === 'asc' ? 'sort-asc' : 'sort-desc'); const sortIcon = header.querySelector('i.fa-sort'); if (sortIcon) { sortIcon.className = `fas ${newDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'}`; } console.log(`[Sort] Řazení změněno na: ${currentSort.column} ${currentSort.direction}. Znovunačítání aktivit...`); await reloadActivities(); }
            async function changeActivitiesPage(direction) { if (isLoading.activities) return; const totalPages = Math.ceil(totalActivitiesCount / activitiesPerPage); const newPage = currentActivitiesPage + direction; if (newPage >= 1 && newPage <= totalPages) { currentActivitiesPage = newPage; console.log(`[Pagination] Změna na stránku ${currentActivitiesPage}. Znovunačítání aktivit...`); await reloadActivities(); } }
            async function reloadActivities() { if (!currentUser || isLoading.activities) return; console.log(`🔄 [ReloadActivities] Znovunačítání: stránka=${currentActivitiesPage}, řazení=${currentSort.column} ${currentSort.direction}, filtr=${currentFilter}`); setLoadingState('activities', true); try { const activityResult = await fetchRecentActivities( currentUser.id, currentActivitiesPage, activitiesPerPage, currentSort.column, currentSort.direction === 'asc', currentFilter ); allActivitiesData = activityResult.data || []; totalActivitiesCount = activityResult.count || 0; renderActivitiesTable(allActivitiesData); updatePaginationUI(); } catch (error) { showError("Nepodařilo se znovu načíst aktivity.", false); renderActivitiesTable(null); updatePaginationUI(); } finally { setLoadingState('activities', false); } }
            async function reloadChartData() { if (!currentUser || isLoading.chart) return; const selectedPeriod = ui.chartPeriodSelect.value; console.log(`🔄 [ReloadChart] Znovunačítání grafu pro období: ${selectedPeriod}`); setLoadingState('chart', true); try { const chartData = await fetchProgressHistory(currentUser.id, selectedPeriod); renderProgressChart(chartData); } catch (error) { showError("Nepodařilo se načíst data pro graf.", false); renderProgressChart(null); } finally { setLoadingState('chart', false); } }
            function exportTableToCSV() { if (isLoading.activities) { showToast('Info', "Počkejte na dokončení načítání."); return; } if (!allActivitiesData || allActivitiesData.length === 0) { showToast('Info', "Není co exportovat."); return; } console.log("[Export] Zahájení exportu do CSV..."); const headers = ["Datum", "Čas", "Typ Aktivity", "Název/Popis", "Body", "Stav"]; const rows = allActivitiesData.map(activity => { const date = new Date(activity.created_at); const formattedDate = date.toLocaleDateString('cs-CZ'); const formattedTime = date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' }); const typeInfo = activityTypeMap[activity.type?.toLowerCase()] || activityTypeMap.default; const statusInfo = activityStatusMap[activity.status?.toLowerCase()] || activityStatusMap.default; const escapeCSV = (field) => { const str = String(field ?? ''); if (str.includes(',') || str.includes('"') || str.includes('\n')) { return `"${str.replace(/"/g, '""')}"`; } return str; }; return [ formattedDate, formattedTime, escapeCSV(typeInfo.name), escapeCSV(activity.title || activity.description || '-'), activity.points_earned ?? '', escapeCSV(statusInfo.name) ].join(','); }); const BOM = "\uFEFF"; const csvContent = BOM + headers.join(',') + '\n' + rows.join('\n'); const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); const now = new Date(); const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`; link.setAttribute("download", `historie_aktivit_${timestamp}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast('Úspěch', "Export do CSV dokončen."); console.log("[Export] Export CSV dokončen."); }

            async function initializeApp() {
                console.log("🚀 [Init Pokrok] Spouštění inicializace...");
                if (!initializeSupabase()) return;

                if (ui.initialLoader) { ui.initialLoader.classList.remove('hidden'); ui.initialLoader.style.display = 'flex'; }
                if (ui.mainElement) ui.mainElement.style.display = 'none';

                try {
                    console.log("[Init] Ověřování session...");
                    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                    if (sessionError) throw new Error(`Nepodařilo se ověřit přihlášení: ${sessionError.message}`);

                    if (session?.user) {
                        currentUser = session.user;
                        console.log(`[Init] Uživatel ověřen (ID: ${currentUser.id}). Načítání profilu...`);
                        currentProfile = await fetchUserProfile(currentUser.id);
                        if (!currentProfile) throw new Error("Nepodařilo se načíst profil uživatele.");
                        console.log("[Init] Profil načten:", currentProfile);

                        updateUserInfoUI();
                        setupEventListeners(); // Nastavit listenery PO načtení profilu
                        updateCurrentTime(); setInterval(updateCurrentTime, 60000);

                        if (ui.initialLoader) { ui.initialLoader.classList.add('hidden'); setTimeout(() => { if (ui.initialLoader) ui.initialLoader.style.display = 'none'; }, 300); }
                        if (ui.mainElement) { ui.mainElement.style.display = 'block'; requestAnimationFrame(() => { ui.mainElement.classList.add('loaded'); }); }

                        console.log("[Init] Načítání všech dat stránky...");
                        await loadAllData();
                        console.log("✅ [Init] Stránka plně načtena a inicializována.");
                        initMouseFollower();
                        initScrollAnimations();
                        initHeaderScrollDetection();
                        updateCopyrightYear();

                    } else {
                        console.log("[Init] Uživatel není přihlášen. Přesměrování na login...");
                        window.location.href = '/auth/index.html';
                    }
                } catch (error) {
                    console.error("❌ [Init] Kritická chyba inicializace:", error);
                    if (ui.initialLoader && !ui.initialLoader.classList.contains('hidden')) { ui.initialLoader.innerHTML = `<p style="color: var(--danger-color);">Chyba (${error.message}). Obnovte stránku.</p>`; }
                    else { showError(`Chyba při inicializaci: ${error.message}`, true); }
                    if (ui.mainElement) ui.mainElement.style.display = 'none';
                }
            }

            document.addEventListener('DOMContentLoaded', initializeApp);

        })();
    </script>
</body>
</html>