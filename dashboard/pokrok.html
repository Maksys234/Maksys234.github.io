<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Justax - Přehled pokroku</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>


    <style>
        /* --- CSS STYLES (Konzistentní s dashboard.html) --- */
         :root {
            /* Základní paleta (předpokládá se světlá jako výchozí) */
            --primary-rgb: 67, 97, 238; /* Přidáno pro RGBA */
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #06d6a0; /* Upraveno pro lepší kontrast */
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4cc9f0; /* Upraveno */
            --dark: #1e2a3a; /* Tmavý text na světlém */
            --light: #f8f9fa; /* Světlé pozadí */
            --gray: #6c757d;
            --gray-light: #dee2e6; /* Světle šedá pro okraje atd. */
            --gray-medium: #adb5bd;
            --gray-dark: #343a40;
            --white: #ffffff; /* Bílá pro text na tmavém pozadí/kartách */
            --gradient-1: linear-gradient(135deg, #4361ee, #3a0ca3);
            --gradient-2: linear-gradient(135deg, #4cc9f0, #4361ee);
            --gradient-3: linear-gradient(135deg, #f72585, #7209b7);
            --gradient-4: linear-gradient(135deg, #f8961e, #f3722c);

            /* Sémantické barvy */
            --bg-color: #f0f2f5; /* Pozadí stránky - lehce šedé */
            --card-bg-color: var(--white); /* Pozadí karet/sekcí */
            --text-primary: #2d3748; /* Primární text */
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: var(--gray-light); /* Barva okrajů */
            --input-bg: var(--white);
            --input-border: var(--gray-light);
            --input-focus-border: var(--primary-light);
            --input-focus-shadow: rgba(var(--primary-rgb), 0.15);

            /* Rozměry a přechody */
            --sidebar-width: 260px;
            --transition-speed: 0.3s;
            --card-radius: 16px; /* Větší zaoblení */
            --button-radius: 10px;
            --form-element-radius: 8px;

            /* Stíny */
            --shadow-sm: 0 3px 6px rgba(0, 0, 0, 0.04); /* Jemnější stíny */
            --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.08);

            /* Skeleton Loader */
            --skeleton-bg: #f3f4f6;
            --skeleton-highlight: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-color); /* Používá CSS proměnnou */
            color: var(--text-primary); /* Používá CSS proměnnou */
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
            line-height: 1.6;
            font-size: 15px;
        }

        /* --- Sidebar (předpokládáme, že je stejný jako v dashboard.html) --- */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: var(--gradient-1);
            color: var(--white); /* Text v sidebar je vždy bílý */
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            z-index: 1000; /* Vyšší Z-index pro překrytí */
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-speed) ease;
        }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2rem; padding: 0 0.75rem; }
        .sidebar-logo { font-size: 1.5rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo i { font-size: 1.75rem; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        .sidebar-item { margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; padding: 0.8rem 1rem; color: rgba(255, 255, 255, 0.85); text-decoration: none; border-radius: 10px; /* Mírně menší */ transition: all 0.2s ease; font-weight: 500; position: relative; }
        .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; width: 24px; text-align: center; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--white); }
         .sidebar-link.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); height: 60%; width: 4px; background-color: var(--white); border-radius: 0 3px 3px 0; }
        .sidebar-footer { margin-top: auto; padding: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); text-align: center; }
        .user-profile { display: flex; align-items: center; padding: 1rem; margin-top: 1rem; background-color: rgba(255, 255, 255, 0.1); border-radius: 12px; transition: all 0.2s ease; border: 1px solid rgba(255,255,255, 0.15); }
        .user-profile:hover { background-color: rgba(255, 255, 255, 0.2); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-weight: 500; overflow: hidden; color: var(--white); border: 2px solid rgba(255,255,255, 0.3); }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex-grow: 1; }
        .user-name { font-weight: 600; font-size: 0.95rem; }
        .user-role { font-size: 0.8rem; opacity: 0.8; }
        /* --- Konec Sidebar --- */


        /* --- Hlavní obsah --- */
        main {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 1.5rem 2rem;
            transition: margin var(--transition-speed) ease;
            width: calc(100% - var(--sidebar-width));
            overflow-y: auto; /* Povolit skrolování jen pro hlavní obsah */
            height: 100vh; /* Zajistit, aby skrolování fungovalo správně */
        }

        .dashboard-header {
            margin-bottom: 2rem;
            background-color: var(--card-bg-color); /* Používá proměnnou */
            border-radius: var(--card-radius);
            padding: 1.25rem 1.75rem; /* Větší padding */
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Umožnit zalomení */
            gap: 1rem;
            position: sticky; /* Přilepení headeru */
            top: 0;
            z-index: 900; /* Pod sidebar */
            transition: box-shadow 0.2s ease;
        }
        body.scrolled .dashboard-header { /* Přidá stín při skrolování */
             box-shadow: var(--shadow-md);
        }


        .header-title { display: flex; align-items: center; gap: 1rem; }

        .header-title h1 {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-primary); /* Používá proměnnou */
            margin: 0; /* Odebrat defaultní margin */
        }

        .header-time {
            font-size: 0.9rem;
            color: var(--text-muted); /* Používá proměnnou */
            margin-top: 0.25rem; /* Přidáno malé odsazení */
            display: none; /* Skryjeme na menších obrazovkách */
        }
        @media (min-width: 768px) { .header-time { display: block; } }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* Zmenšená mezera */
        }

        /* Tlačítka (konzistentní styl) */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.7rem 1.4rem; /* Mírně upravený padding */ border-radius: var(--button-radius); font-weight: 500; font-size: 0.9rem; /* Mírně menší font */ text-decoration: none; transition: all 0.3s ease; cursor: pointer; border: none; gap: 0.5rem; line-height: 1.4; /* Upraveno pro lepší zarovnání */ }
        .btn-primary { background: var(--gradient-1); color: white; box-shadow: 0 4px 10px rgba(var(--primary-rgb), 0.2); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(var(--primary-rgb), 0.25); background: linear-gradient(135deg, var(--primary-light), var(--secondary));}
        .btn-secondary { background-color: #e9ecef; color: var(--text-secondary); border: 1px solid var(--border-color); }
        .btn-secondary:hover:not(:disabled) { background-color: #dfe3e7; border-color: #adb5bd; color: var(--dark); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn i { font-size: 1em; /* Velikost ikony relativní k fontu */ }
        .btn .button-text { /* Skrytí textu na malých obrazovkách */ display: inline; }
        @media (max-width: 768px) { .btn .button-text { display: none; } .btn { padding: 0.6rem 0.8rem; } }

        /* Tooltipster Theme */
        .tooltipster-shadow { border-radius: 6px; background: var(--dark); color: var(--light); box-shadow: var(--shadow-md); border: none; }
        .tooltipster-shadow .tooltipster-content { padding: 8px 12px; font-size: 0.85rem; }

        /* Grid pro statistiky */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.75rem; /* Větší mezery */
            margin-bottom: 2rem;
        }

        .stats-card {
            background-color: var(--card-bg-color); /* Používá proměnnou */
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-sm);
            padding: 1.75rem; /* Větší padding */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative; /* Pro skeleton loader */
            min-height: 180px; /* Minimální výška pro konzistenci */
            overflow: hidden; /* Skryje skeleton přetékání */
            border: 1px solid transparent; /* Pro hover efekt */
        }

        .stats-card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: var(--shadow-md);
            border-color: rgba(var(--primary-rgb), 0.2);
        }

        .stats-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.25rem;
        }

        .stats-card-title {
            font-size: 1rem; /* Mírně menší */
            font-weight: 600; /* Tučnější */
            color: var(--text-primary); /* Používá proměnnou */
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .stats-card-title i {
            font-size: 1.1rem; /* Trochu menší ikona */
            color: var(--primary);
            width: 24px; /* Fixní šířka */
            text-align: center;
        }
        /* Různé barvy ikon pro různé karty */
        .stats-card[data-type="progress"] .stats-card-title i { color: var(--info); }
        .stats-card[data-type="points"] .stats-card-title i { color: var(--warning); }
        .stats-card[data-type="streak"] .stats-card-title i { color: var(--danger); }
        .stats-card[data-type="exercises"] .stats-card-title i { color: var(--success); }

        .stats-card-content {
            flex-grow: 1;
            margin-bottom: 1rem;
            position: relative; /* Pro skeleton */
            z-index: 1; /* Nad skeleton */
        }

        .stats-card-value {
            font-size: 2.4rem; /* Větší hodnota */
            font-weight: 700;
            color: var(--primary); /* Zvýraznění hodnoty */
            margin-bottom: 0.5rem;
            line-height: 1.1;
            min-height: 40px; /* Výška pro skeleton */
        }
        .stats-card-description {
            font-size: 0.9rem; /* Mírně menší */
            color: var(--text-secondary); /* Používá proměnnou */
            min-height: 18px; /* Výška pro skeleton */
        }

        .stats-card-footer {
            font-size: 0.85rem; /* Menší font */
            color: var(--text-muted); /* Používá proměnnou */
            display: flex;
            align-items: center;
            gap: 0.4rem; /* Menší mezera */
            padding-top: 1rem;
            margin-top: auto; /* Tlačí patičku dolů */
            border-top: 1px solid var(--border-color); /* Používá proměnnou */
            position: relative; /* Pro skeleton */
            z-index: 1; /* Nad skeleton */
            min-height: 20px; /* Výška pro skeleton */
        }

        .stats-card-footer i { font-size: 0.8em; /* Relativní velikost */ }
        .stats-card-footer.positive { color: var(--success); font-weight: 500; }
        .stats-card-footer.negative { color: var(--danger); font-weight: 500; }

        /* Sekce pro graf */
        .chart-section {
            background-color: var(--card-bg-color); /* Používá proměnnou */
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-sm);
            padding: 1.75rem; /* Větší padding */
            margin-bottom: 2rem;
            position: relative;
            min-height: 400px; /* Minimální výška pro graf a loader */
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.75rem; /* Větší mezera */
            flex-wrap: wrap; /* Zalomení na menších */
            gap: 1rem;
        }
        .chart-title {
            font-size: 1.4rem; /* Větší titul */
            font-weight: 600;
            color: var(--text-primary); /* Používá proměnnou */
            display: flex; align-items: center; gap: 0.6rem;
        }
        .chart-title i { color: var(--secondary); }
        .chart-actions { display: flex; gap: 0.5rem; }
        .chart-actions select { /* Základní styl pro select */
             padding: 0.5rem 1rem; font-size: 0.85rem; border-radius: var(--form-element-radius);
             border: 1px solid var(--input-border); background-color: var(--input-bg);
             color: var(--text-secondary); cursor: pointer; min-width: 120px; appearance: none;
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
             background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 16px 12px;
        }
        .chart-container {
            height: 380px; /* Větší výška */
            position: relative;
        }

        /* Sekce pro tabulku aktivit */
        .data-table-section {
            background-color: var(--card-bg-color); /* Používá proměnnou */
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-sm);
            padding: 1.75rem;
            margin-bottom: 2rem;
            position: relative;
            min-height: 300px; /* Minimální výška */
            overflow: hidden; /* Skryje loader, pokud je pod tabulkou */
        }
        .data-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.75rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .data-table-title {
            font-size: 1.4rem; /* Větší titul */
            font-weight: 600;
            color: var(--text-primary); /* Používá proměnnou */
             display: flex; align-items: center; gap: 0.6rem;
        }
        .data-table-title i { color: var(--success); }
        .data-table-actions { display: flex; gap: 0.5rem; }

        .table-responsive { overflow-x: auto; /* Povolí horizontální scroll pro tabulku */ }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem; /* Mírně menší font */
            white-space: nowrap; /* Zabrání zalomení v buňkách */
        }
        .data-table th, .data-table td {
            padding: 0.9rem 1.2rem; /* Upravený padding */
            text-align: left;
            border-bottom: 1px solid var(--border-color); /* Používá proměnnou */
        }
        .data-table th {
            color: var(--text-secondary); /* Používá proměnnou */
            font-weight: 600; /* Tučnější */
            text-transform: uppercase; /* Velká písmena */
            letter-spacing: 0.5px;
            background-color: #fcfdff; /* Lehce odlišené pozadí */
            white-space: nowrap; /* Zajistí, že se nadpisy nezalomí */
        }
        .data-table td {
            color: var(--text-primary); /* Používá proměnnou */
            vertical-align: middle; /* Zarovnání na střed */
        }
        .data-table tbody tr:last-child td { border-bottom: none; }
        .data-table tbody tr:hover { background-color: rgba(var(--primary-rgb), 0.03); /* Jemné zvýraznění pro světlý režim */ }

        /* Specifické styly pro buňky tabulky */
        .status-badge {
            padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500;
            display: inline-flex; align-items: center; gap: 0.3rem; white-space: nowrap;
        }
        .status-badge i { font-size: 0.8em; }
        .status-badge.completed { background-color: rgba(6, 214, 160, 0.1); color: var(--success); }
        .status-badge.in-progress { background-color: rgba(248, 150, 30, 0.1); color: var(--warning); }
        .status-badge.pending { background-color: rgba(72, 149, 239, 0.1); color: var(--info); }

        .points-value { font-weight: 600; color: var(--secondary); }

        /* Loading States */
        .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 10; border-radius: var(--card-radius); transition: opacity 0.3s ease-out; opacity: 1;}
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 28px; height: 28px; border: 3px solid var(--primary); border-radius: 50%; border-top-color: transparent; animation: loading-spinner 0.8s linear infinite; }
        @keyframes loading-spinner { to { transform: rotate(360deg); } }
        .skeleton { background-color: var(--skeleton-bg); border-radius: 4px; position: relative; overflow: hidden; }
        .skeleton::after { content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, var(--skeleton-highlight), transparent); animation: skeleton-loading 1.5s infinite linear; }
        @keyframes skeleton-loading { 0% { left: -150%; } 100% { left: 150%; } }
        /* Skeleton Specific Styles */
        .skeleton.title-sm { height: 16px; width: 60%; margin-bottom: 0.6rem; }
        .skeleton.value-lg { height: 38px; width: 40%; margin-bottom: 0.5rem; border-radius: 6px; }
        .skeleton.text-md { height: 18px; width: 80%; margin-bottom: 0.4rem; }
        .skeleton.text-sm { height: 15px; width: 70%; }
        /* Apply skeleton */
        .stats-card .loading-skeleton { display: none; /* Hide skeleton by default */ padding: 1.75rem; width: 100%; position: absolute; top:0; left:0; right:0; bottom: 0; /* Cover whole card */ z-index: 5; /* Below content but above bg */ pointer-events: none;}
        .stats-card.loading .loading-skeleton { display: block; /* Show when loading */ }
        .stats-card.loading .stats-card-header, .stats-card.loading .stats-card-content, .stats-card.loading .stats-card-footer { visibility: hidden; /* Hide real content */ }
        /* Skeleton for Table */
        .data-table tbody.loading tr td { padding: 0.9rem 1.2rem; } /* Keep padding same */
        .data-table tbody.loading tr td .skeleton { margin-bottom: 0; } /* Remove margin for table cells */
        /* Empty State for Table */
        .empty-state { padding: 3rem 2rem; text-align: center; color: var(--text-muted); }
        .empty-state i { font-size: 2.5rem; margin-bottom: 1rem; color: var(--gray-medium); }
        .empty-state p { margin: 0; font-size: 1rem; }

        /* Error messages */
        .error-message { display: flex; align-items: center; background-color: rgba(var(--danger-rgb, 247, 37, 133), 0.05); color: var(--danger); padding: 1rem 1.25rem; border-radius: 8px; margin: 1rem 0; box-shadow: var(--shadow-sm); border-left: 4px solid var(--danger); font-size: 0.9rem; }
        .error-message i { font-size: 1.25rem; margin-right: 0.75rem; }
        .error-container { display: none; margin-bottom: 1.5rem; } /* Global error container */

        /* Toast notifications */
        .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 1050; display: flex; flex-direction: column; gap: 0.5rem; max-width: 350px; pointer-events: none; }
        .toast { padding: 1rem 1.2rem; border-radius: 10px; background: var(--card-bg-color); box-shadow: var(--shadow-lg); display: flex; align-items: center; color: var(--text-primary); animation: toast-in 0.4s ease forwards; pointer-events: auto; border: 1px solid var(--border-color); }
        .toast.success { border-left: 4px solid var(--success); } .toast.error { border-left: 4px solid var(--danger); } .toast.info { border-left: 4px solid var(--info); }
        .toast-icon { margin-right: 0.75rem; font-size: 1.25rem; }
        .toast.success .toast-icon { color: var(--success); } .toast.error .toast-icon { color: var(--danger); } .toast.info .toast-icon { color: var(--info); }
        .toast-content { flex: 1; } .toast-title { font-weight: 600; margin-bottom: 0.25rem; } .toast-message { font-size: 0.9rem; color: var(--text-secondary); }
        .toast-close { background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 1.1rem; padding: 0.25rem; margin-left: 0.5rem; }
        @keyframes toast-in { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }

        /* Mobile menu */
        .mobile-menu-toggle { display: none; background: none; border: none; cursor: pointer; font-size: 1.5rem; color: var(--text-primary); padding: 0.5rem; margin-right: 0.5rem; z-index: 1010; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.55); z-index: 999; opacity: 0; transition: opacity var(--transition-speed) ease; backdrop-filter: blur(4px); }
        .sidebar-overlay.active { display: block; opacity: 1; }

        /* Footer */
        .dashboard-footer { margin-top: 2.5rem; padding: 1.5rem 0; text-align: center; color: var(--text-muted); font-size: 0.9rem; border-top: 1px solid var(--border-color); }

        /* --- START DARK MODE --- */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #171923; --card-bg-color: #1a202c;
                --text-primary: #e2e8f0; --text-secondary: #cbd5e0; --text-muted: #a0aec0;
                --border-color: #4a5568; --light: #2d3748; --white: #1a202c;
                --skeleton-bg: #2d3748; --skeleton-highlight: #4a5568;
                --input-bg: #2d3748; --input-border: #4a5568;
                --input-focus-border: var(--primary-light);
                --input-focus-shadow: rgba(72, 149, 239, 0.15);
                --danger-rgb: 247, 37, 133; /* Pro RGBA chyby */
            }
            body { background-color: var(--bg-color); }
            .dashboard-header { background-color: var(--card-bg-color); border-bottom-color: var(--border-color); }
            .stats-card { background-color: var(--card-bg-color); border-color: transparent; }
            .stats-card:hover { border-color: rgba(var(--primary-rgb), 0.3); }
            .stats-card-footer { border-top-color: var(--border-color); }
            .chart-section { background-color: var(--card-bg-color); }
            .chart-actions select { background-color: var(--input-bg); border-color: var(--input-border); color: var(--text-secondary); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23a0aec0' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");}
            .data-table-section { background-color: var(--card-bg-color); }
            .data-table th { background-color: #242c3b; border-bottom-color: var(--border-color); }
            .data-table td { border-bottom-color: var(--border-color); }
            .data-table tbody tr:hover { background-color: #1e2533; }
            .btn-secondary { background-color: var(--light); color: var(--text-secondary); border-color: var(--border-color); }
            .btn-secondary:hover:not(:disabled) { background-color: #4a5568; border-color: #6c757d; color: var(--white); }
            .mobile-menu-toggle { color: var(--text-primary); }
            .loading-overlay { background-color: rgba(30, 37, 51, 0.8); }
            .error-message { background-color: rgba(var(--danger-rgb), 0.1); border-left-color: var(--danger); }
            .toast { background-color: var(--card-bg-color); border-color: var(--border-color); box-shadow: var(--shadow-lg); }
            .dashboard-footer { border-top-color: var(--border-color); }
             .status-badge.completed { background-color: rgba(6, 214, 160, 0.15); color: var(--success); }
             .status-badge.in-progress { background-color: rgba(248, 150, 30, 0.15); color: var(--warning); }
             .status-badge.pending { background-color: rgba(72, 149, 239, 0.15); color: var(--info); }
             .tooltipster-shadow { background: #1e2a3a; color: #e2e8f0; }
             Chart.defaults.color = '#a0aec0'; Chart.defaults.borderColor = 'rgba(74, 85, 104, 0.3)'; Chart.defaults.scale.grid.color = 'rgba(74, 85, 104, 0.15)';
        }
        /* --- END DARK MODE --- */


        /* Responsive design */
        @media (max-width: 992px) {
            :root { --sidebar-width: 80px; }
            main { margin-left: 80px; width: calc(100% - 80px); }
             .sidebar { width: 80px; }
            .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: none; }
            .sidebar-link i { margin-right: 0; font-size: 1.5rem; } .sidebar-logo i { margin-right: 0; }
            .sidebar-header, .sidebar-link { justify-content: center; }
            .user-profile { justify-content: center; padding: 0.75rem 0; } .user-avatar { margin-right: 0; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        }
        @media (max-width: 768px) {
            main { padding: 1rem; }
            .dashboard-header { padding: 1rem 1.25rem; top: 0; /* Přilepit nahoře i na mobilu */ }
            .header-title { gap: 0.5rem; }
            .header-title h1 { font-size: 1.5rem; }
            .mobile-menu-toggle { display: block; }
            .stats-grid { grid-template-columns: 1fr; gap: 1.25rem; }
             .stats-card, .chart-section, .data-table-section { padding: 1.25rem; }
             .chart-header, .data-table-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; margin-bottom: 1.25rem; }
             .chart-title, .data-table-title { font-size: 1.25rem; }
             .chart-actions, .data-table-actions { width: 100%; justify-content: flex-start; }
             .chart-container { height: 300px; }
             .data-table th, .data-table td { padding: 0.8rem 1rem; }
             .dashboard-footer { margin-top: 1.5rem; padding-top: 1rem;}
        }
        @media (max-width: 576px) {
            :root { --sidebar-width: 0; }
             main { margin-left: 0; width: 100%; padding: 0.75rem; }
             .sidebar { transform: translateX(-100%); z-index: 1000; width: 260px; }
             .sidebar.active { transform: translateX(0); .sidebar-logo span, .sidebar-link span, .user-info, .sidebar-footer { display: block; } .sidebar-link i { margin-right: 0.75rem; font-size: 1.2rem; } .sidebar-header, .sidebar-link { justify-content: flex-start; } .user-profile { justify-content: flex-start; padding: 1rem; } .user-avatar { margin-right: 0.75rem; } }
             .header-title h1 { font-size: 1.3rem; }
             .header-actions { gap: 0.5rem; }
             .btn { padding: 0.6rem 1rem; font-size: 0.85rem; }
             .btn .button-text { display: none; } /* Vždy skrýt text na extra malých */
             .btn i { margin-right: 0 !important; /* Odebrat margin ikon */ }
             .stats-card-value { font-size: 2rem; }
             .stats-card-description { font-size: 0.85rem; }
             .stats-card-footer { font-size: 0.8rem; }
             .data-table { font-size: 0.85rem; }
             .data-table th, .data-table td { padding: 0.6rem 0.8rem; }
             .status-badge { padding: 0.2rem 0.6rem; font-size: 0.7rem; }
        }
        /* --- Konec CSS --- */
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>

    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header"> <a href="/" class="sidebar-logo"> <i class="fas fa-calculator"></i> <span>Justax</span> </a> </div>
        <ul class="sidebar-menu"> <li class="sidebar-item"> <a href="/dashboard.html" class="sidebar-link"> <i class="fas fa-th-large"></i> <span>Dashboard</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/procvicovani/main.html" class="sidebar-link"> <i class="fas fa-book-open"></i> <span>Procvičování</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/pokrok.html" class="sidebar-link active"> <i class="fas fa-chart-line"></i> <span>Pokrok</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/oceneni.html" class="sidebar-link"> <i class="fas fa-medal"></i> <span>Ocenění</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/materialy.html" class="sidebar-link"> <i class="fas fa-file-alt"></i> <span>Materiály</span> </a> </li> <li class="sidebar-item"> <a href="/dashboard/profile.html" class="sidebar-link"> <i class="fas fa-user-cog"></i> <span>Profil</span> </a> </li> </ul>
        <div class="user-profile"> <div class="user-avatar" id="user-avatar">?</div> <div class="user-info"> <div class="user-name" id="user-name">Načítání...</div> <div class="user-role">Student</div> </div> </div>
        <div class="sidebar-footer"> &copy; 2025 Justax </div>
    </aside>

    <main>
        <header class="dashboard-header">
             <div class="header-title">
                  <button class="mobile-menu-toggle" id="mobile-menu-toggle"> <i class="fas fa-bars"></i> </button>
                 <h1>Přehled pokroku</h1>
             </div>
             <div class="header-time" id="current-time"></div>
            <div class="header-actions">
                <button class="btn btn-primary btn-tooltip" id="refresh-btn" title="Obnovit data">
                    <i class="fas fa-sync-alt"></i>
                    <span class="button-text">Obnovit</span>
                </button>
            </div>
        </header>

        <div class="error-container" id="global-error"></div>

        <div class="stats-grid" id="stats-grid">
             <div class="stats-card loading" data-type="progress">
                 <div class="loading-skeleton">
                     <div class="skeleton title-sm" style="width: 70%;"></div>
                     <div class="skeleton value-lg" style="width: 50%;"></div>
                     <div class="skeleton text-md" style="width: 90%;"></div>
                     <div style="margin-top: auto; border-top: 1px solid transparent; padding-top: 1rem;">
                         <div class="skeleton text-sm" style="width: 65%;"></div>
                     </div>
                 </div>
                 <div class="stats-card-header"> <h3 class="stats-card-title"><i class="fas fa-chart-pie"></i>Celkový pokrok</h3> </div>
                 <div class="stats-card-content"> <div class="stats-card-value" id="overall-progress-value">- %</div> <div class="stats-card-description" id="overall-progress-desc">Průměr ze všech oblastí</div> </div>
                 <div class="stats-card-footer" id="overall-progress-footer"><i class="fas fa-minus"></i> Načítání...</div>
             </div>

             <div class="stats-card loading" data-type="points">
                  <div class="loading-skeleton"> <div class="skeleton title-sm" style="width: 60%;"></div> <div class="skeleton value-lg" style="width: 40%;"></div> <div class="skeleton text-md" style="width: 80%;"></div> <div style="margin-top: auto; border-top: 1px solid transparent; padding-top: 1rem;"><div class="skeleton text-sm" style="width: 70%;"></div></div> </div>
                 <div class="stats-card-header"> <h3 class="stats-card-title"><i class="fas fa-star"></i>Celkem bodů</h3> </div>
                 <div class="stats-card-content"> <div class="stats-card-value" id="total-points-value">-</div> <div class="stats-card-description" id="total-points-desc">Získané za aktivity a testy</div> </div>
                 <div class="stats-card-footer" id="total-points-footer"><i class="fas fa-minus"></i> Načítání...</div>
             </div>

             <div class="stats-card loading" data-type="streak">
                  <div class="loading-skeleton"> <div class="skeleton title-sm" style="width: 65%;"></div> <div class="skeleton value-lg" style="width: 30%;"></div> <div class="skeleton text-md" style="width: 85%;"></div> <div style="margin-top: auto; border-top: 1px solid transparent; padding-top: 1rem;"><div class="skeleton text-sm" style="width: 60%;"></div></div> </div>
                 <div class="stats-card-header"> <h3 class="stats-card-title"><i class="fas fa-fire"></i>Studijní série</h3> </div>
                 <div class="stats-card-content"> <div class="stats-card-value" id="streak-value">-</div> <div class="stats-card-description" id="streak-desc">Počet dnů studia v řadě</div> </div>
                 <div class="stats-card-footer" id="streak-footer">Nejdelší série: -</div>
             </div>

             <div class="stats-card loading" data-type="exercises">
                  <div class="loading-skeleton"> <div class="skeleton title-sm" style="width: 80%;"></div> <div class="skeleton value-lg" style="width: 45%;"></div> <div class="skeleton text-md" style="width: 75%;"></div> <div style="margin-top: auto; border-top: 1px solid transparent; padding-top: 1rem;"><div class="skeleton text-sm" style="width: 55%;"></div></div> </div>
                 <div class="stats-card-header"> <h3 class="stats-card-title"><i class="fas fa-check-double"></i>Dokončené aktivity</h3> </div>
                 <div class="stats-card-content"> <div class="stats-card-value" id="completed-count-value">-</div> <div class="stats-card-description" id="completed-count-desc">Počet testů a cvičení</div> </div>
                 <div class="stats-card-footer" id="completed-count-footer"><i class="fas fa-minus"></i> Načítání...</div>
             </div>
        </div>

        <div class="chart-section" id="progress-chart-section">
             <div class="loading-overlay" id="chart-loading-overlay"> <div class="loading-spinner"></div> </div>
            <div class="chart-header">
                <h2 class="chart-title"><i class="fas fa-chart-line"></i>Vývoj pokroku v čase</h2>
                <div class="chart-actions">
                    <select id="chart-period-select" class="btn-sm btn-secondary" aria-label="Vyberte období grafu">
                        <option value="week">Poslední týden</option>
                        <option value="month" selected>Poslední měsíc</option>
                        <option value="3months">Poslední 3 měsíce</option>
                        <option value="all">Celkově</option>
                    </select>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="progressChart"></canvas>
            </div>
        </div>

        <div class="data-table-section" id="activities-section">
             <div class="loading-overlay hidden" id="table-loading-overlay"> <div class="loading-spinner"></div> </div>
            <div class="data-table-header">
                <h2 class="data-table-title"><i class="fas fa-history"></i>Nedávné aktivity</h2>
                <div class="data-table-actions">
                    <button class="btn btn-secondary btn-sm btn-tooltip" id="export-table-btn" title="Exportovat tabulku jako CSV">
                         <i class="fas fa-download"></i>
                         <span class="button-text">Exportovat</span>
                    </button>
                    <select id="activity-type-filter" class="btn-sm btn-secondary" aria-label="Filtrovat typ aktivity">
                         <option value="all">Všechny typy</option>
                         <option value="test">Testy</option>
                         <option value="exercise">Cvičení</option>
                         <option value="badge">Odznaky</option>
                     </select>
                </div>
            </div>
            <div class="table-responsive">
                 <table class="data-table" id="activities-table">
                     <thead>
                         <tr>
                             <th>Datum <i class="fas fa-sort"></i></th>
                             <th>Typ <i class="fas fa-filter"></i></th>
                             <th>Název / Popis</th>
                             <th>Získané body <i class="fas fa-sort-numeric-down"></i></th>
                             <th>Stav</th>
                         </tr>
                     </thead>
                     <tbody id="activities-body">
                         <tr class="skeleton-row"><td colspan="5"><div class="skeleton text-md"></div></td></tr>
                         <tr class="skeleton-row"><td colspan="5"><div class="skeleton text-md"></div></td></tr>
                         <tr class="skeleton-row"><td colspan="5"><div class="skeleton text-md"></div></td></tr>
                         <tr class="skeleton-row"><td colspan="5"><div class="skeleton text-md"></div></td></tr>
                         <tr class="skeleton-row"><td colspan="5"><div class="skeleton text-md"></div></td></tr>
                     </tbody>
                 </table>
             </div>
             <div class="empty-state" id="activities-empty-state" style="display: none;">
                 <i class="fas fa-box-open"></i>
                 <p>Zatím žádné zaznamenané aktivity.</p>
             </div>
             </div>

        <footer class="dashboard-footer">
            <p>&copy; 2025 Justax. Všechna práva vyhrazena.</p>
        </footer>
    </main>

    <script>
        // Obálka IIFE pro izolaci scope
        (function() {
            // --- START: Inicializace a Konfigurace ---
            const supabaseUrl = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';
            let supabase = null;
            let currentUser = null;
            let currentProfile = null;
            let progressChartInstance = null; // Instance grafu
            let allActivities = []; // Všechny načtené aktivity pro filtrování
            let isLoading = { stats: false, chart: false, activities: false };

            // DOM Cache - ukládání odkazů na elementy pro rychlejší přístup
            const ui = {
                sidebarAvatar: document.getElementById('user-avatar'),
                sidebarName: document.getElementById('user-name'),
                currentTime: document.getElementById('current-time'),
                refreshBtn: document.getElementById('refresh-btn'),
                globalError: document.getElementById('global-error'),
                statsGrid: document.getElementById('stats-grid'),
                overallProgressValue: document.getElementById('overall-progress-value'),
                overallProgressDesc: document.getElementById('overall-progress-desc'),
                overallProgressFooter: document.getElementById('overall-progress-footer'),
                totalPointsValue: document.getElementById('total-points-value'),
                totalPointsDesc: document.getElementById('total-points-desc'),
                totalPointsFooter: document.getElementById('total-points-footer'),
                streakValue: document.getElementById('streak-value'),
                streakDesc: document.getElementById('streak-desc'),
                streakFooter: document.getElementById('streak-footer'),
                completedCountValue: document.getElementById('completed-count-value'),
                completedCountDesc: document.getElementById('completed-count-desc'),
                completedCountFooter: document.getElementById('completed-count-footer'),
                progressChartSection: document.getElementById('progress-chart-section'),
                chartLoadingOverlay: document.getElementById('chart-loading-overlay'),
                progressChartCanvas: document.getElementById('progressChart'),
                chartPeriodSelect: document.getElementById('chart-period-select'),
                activitiesSection: document.getElementById('activities-section'),
                tableLoadingOverlay: document.getElementById('table-loading-overlay'),
                activitiesTable: document.getElementById('activities-table'),
                activitiesBody: document.getElementById('activities-body'),
                activitiesEmptyState: document.getElementById('activities-empty-state'),
                activityTypeFilter: document.getElementById('activity-type-filter'),
                exportTableBtn: document.getElementById('export-table-btn'),
                toastContainer: document.getElementById('toast-container'),
                mobileMenuToggle: document.getElementById('mobile-menu-toggle'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                mainElement: document.querySelector('main'), // Pro sledování skrolování
                dashboardHeader: document.querySelector('.dashboard-header') // Pro přidání stínu
            };

            // Mapování typů aktivit pro filtrování a ikony
            const activityTypeMap = {
                 test: { name: 'Test', icon: 'fa-vial' },
                 exercise: { name: 'Cvičení', icon: 'fa-pencil-alt' },
                 badge: { name: 'Odznak', icon: 'fa-medal' },
                 diagnostic: { name: 'Diagnostika', icon: 'fa-clipboard-check' },
                 lesson: { name: 'Lekce', icon: 'fa-book-open' },
                 plan_generated: { name: 'Plán', icon: 'fa-tasks' },
                 default: { name: 'Aktivita', icon: 'fa-check-circle' }
             };
             const activityStatusMap = {
                 completed: { name: 'Dokončeno', class: 'completed', icon: 'fa-check-circle' },
                 'in-progress': { name: 'Probíhá', class: 'in-progress', icon: 'fa-spinner fa-spin' }, // Přidáno
                 pending: { name: 'Čeká', class: 'pending', icon: 'fa-clock' }, // Přidáno
                 failed: { name: 'Neúspěch', class: 'failed', icon: 'fa-times-circle' }, // Přidáno
                 earned: { name: 'Získáno', class: 'completed', icon: 'fa-medal'} // Pro odznaky
             };
            // --- KONEC: Inicializace a Konfigurace ---


            // --- START: Pomocné Funkce ---
            function showToast(message, type = 'success', duration = 4000) {
                 if (!ui.toastContainer) return;
                 const toastId = `toast-${Date.now()}`;
                 const toastElement = document.createElement('div');
                 toastElement.className = `toast ${type}`;
                 toastElement.id = toastId;
                 toastElement.innerHTML = `
                     <i class="toast-icon"></i>
                     <div class="toast-content">
                         <div class="toast-message">${sanitizeHTML(message)}</div>
                     </div>
                     <button class="toast-close">&times;</button>
                 `;
                 const icon = toastElement.querySelector('.toast-icon');
                 icon.className = `toast-icon fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}`;

                 toastElement.querySelector('.toast-close').addEventListener('click', () => {
                     toastElement.classList.remove('show');
                     setTimeout(() => toastElement.remove(), 400); // Remove after fade out
                 });

                 ui.toastContainer.appendChild(toastElement);
                 // Force reflow to enable transition
                 void toastElement.offsetWidth;
                 toastElement.classList.add('show');

                 setTimeout(() => {
                     toastElement.classList.remove('show');
                     setTimeout(() => toastElement.remove(), 400);
                 }, duration);
            }
            function showError(message, isGlobal = false) {
                console.error("Chyba:", message);
                if (isGlobal && ui.globalError) {
                    ui.globalError.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><div>${sanitizeHTML(message)}</div></div>`;
                    ui.globalError.style.display = 'block';
                } else {
                     // Zobrazit jako toast, pokud není globální
                     showToast(message, 'error', 6000);
                }
            }
            function hideGlobalError() { if (ui.globalError) ui.globalError.style.display = 'none'; }
            function sanitizeHTML(str) { const t = document.createElement('div'); t.textContent = str || ''; return t.innerHTML; }
            function getInitials(userData) { const f=userData?.first_name?.[0]||''; const l=userData?.last_name?.[0]||''; return (f+l).toUpperCase() || userData?.username?.[0].toUpperCase() || userData?.email?.[0].toUpperCase() || '?'; }
            function formatDate(dateString, includeTime = false) { if (!dateString) return '-'; try { const d = new Date(dateString); const optionsDate = { day: 'numeric', month: 'numeric', year: 'numeric' }; const optionsTime = { hour: '2-digit', minute: '2-digit' }; return d.toLocaleDateString('cs-CZ', optionsDate) + (includeTime ? ' ' + d.toLocaleTimeString('cs-CZ', optionsTime) : ''); } catch (e) { return '-'; } }
             function setLoadingState(section, isLoading) {
                console.log(`Nastavuji loading pro sekci ${section} na ${isLoading}`);
                 switch(section) {
                     case 'stats':
                         if (ui.statsGrid) {
                              Array.from(ui.statsGrid.children).forEach(card => card.classList.toggle('loading', isLoading));
                         }
                         break;
                     case 'chart':
                          if (ui.chartLoadingOverlay) ui.chartLoadingOverlay.classList.toggle('hidden', !isLoading);
                         break;
                     case 'activities':
                          if (ui.tableLoadingOverlay) ui.tableLoadingOverlay.classList.toggle('hidden', !isLoading);
                          if (ui.activitiesBody) ui.activitiesBody.classList.toggle('loading', isLoading);
                          // Zobraz/skryj skeleton řádky v tabulce
                          const skeletonRows = ui.activitiesTable.querySelectorAll('.skeleton-row');
                          skeletonRows.forEach(row => row.style.display = isLoading ? 'table-row' : 'none');
                         break;
                 }
             }
            function updateCurrentTime() { if (ui.currentTime) ui.currentTime.textContent = new Date().toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' }); }
            function toggleMobileMenu() { ui.sidebar?.classList.toggle('active'); ui.sidebarOverlay?.classList.toggle('active'); }
             // Přidá/odebere stín headeru při skrolování
             function handleScroll() {
                 if (!ui.mainElement || !ui.dashboardHeader) return;
                 if (ui.mainElement.scrollTop > 10) {
                     ui.dashboardHeader.style.boxShadow = 'var(--shadow-md)';
                 } else {
                     ui.dashboardHeader.style.boxShadow = 'var(--shadow-sm)';
                 }
             }
            // --- KONEC: Pomocné Funkce ---


             // --- START: Načítání Dat ---
             async function initializeApp() {
                console.log("Inicializace Pokrok stránky...");
                 if (!initializeSupabase()) return;
                 updateCurrentTime(); setInterval(updateCurrentTime, 60000);
                 setupEventListeners();
                 try {
                     const { data: { user } } = await supabase.auth.getUser();
                     if (user) {
                         currentUser = user;
                         console.log("Uživatel přihlášen:", currentUser.id);
                         currentProfile = await fetchUserProfile(currentUser.id);
                         updateUserInfoUI();
                         await loadAllData(); // Načte všechna data najednou
                     } else {
                         console.log("Uživatel není přihlášen, přesměrovávám...");
                         window.location.href = '/auth/index.html'; // Přesměrování na login
                     }
                 } catch (error) {
                     showError("Chyba při inicializaci: " + error.message, true);
                 }
             }

             function initializeSupabase() {
                 try {
                     if (!window.supabase || !window.supabase.createClient) throw new Error("Supabase knihovna nenalezena");
                     supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                     if (!supabase) throw new Error("Nepodařilo se vytvořit Supabase klienta");
                     console.log("Supabase klient inicializován.");
                     return true;
                 } catch (error) {
                     showError("Kritická chyba inicializace Supabase: " + error.message, true);
                     return false;
                 }
             }

            async function fetchUserProfile(userId) {
                 if (!supabase) return null;
                 try {
                     const { data, error } = await supabase.from('profiles').select('*').eq('id', userId).single();
                     if (error && error.code !== 'PGRST116') throw error; // Ignorovat nenalezený profil
                     return data;
                 } catch (error) {
                     console.error("Chyba načítání profilu:", error);
                     showToast("Nepodařilo se načíst profil.", 'error');
                     return null;
                 }
             }

            async function loadAllData() {
                 if (!currentUser || !supabase) return;
                 hideGlobalError();
                 // Paralelní načítání všech datových sad
                 setLoadingState('stats', true);
                 setLoadingState('chart', true);
                 setLoadingState('activities', true);
                 isLoading = { stats: true, chart: true, activities: true };

                 try {
                     const [stats, chartData, activities] = await Promise.all([
                         fetchUserStats(currentUser.id),
                         fetchProgressHistory(currentUser.id, ui.chartPeriodSelect?.value || 'month'),
                         fetchRecentActivities(currentUser.id)
                     ]);

                     // Aktualizace UI po načtení všech dat
                     updateStatsCards(stats);
                     isLoading.stats = false; setLoadingState('stats', false);

                     renderProgressChart(chartData);
                     isLoading.chart = false; setLoadingState('chart', false);

                     allActivities = activities || []; // Uložit všechny aktivity
                     renderActivitiesTable(allActivities); // Vykreslit všechny na začátku
                     isLoading.activities = false; setLoadingState('activities', false);

                 } catch (error) {
                     showError("Nepodařilo se načíst všechna data pokroku: " + error.message, true);
                      // Skrýt všechny loadery i při chybě
                      isLoading = { stats: false, chart: false, activities: false };
                      setLoadingState('stats', false);
                      setLoadingState('chart', false);
                      setLoadingState('activities', false);
                      // Možná zobrazit fallback stavy
                      updateStatsCards(null);
                      renderProgressChart(null);
                      renderActivitiesTable(null);
                 }
             }

            async function fetchUserStats(userId) {
                 try {
                     const { data: stats, error: statsError } = await supabase.from('user_stats').select('progress, progress_weekly, points_weekly, streak_longest').eq('user_id', userId).maybeSingle();
                     const { data: profile, error: profileError } = await supabase.from('profiles').select('points, streak_days').eq('id', userId).single();

                     if (statsError || profileError) {
                         console.warn("Chyba při načítání statistik nebo profilu:", statsError || profileError);
                         // Vracíme výchozí hodnoty, pokud něco selže
                          return { progress: 0, progress_weekly: 0, points: profile?.points || 0, points_weekly: 0, streak_current: profile?.streak_days || 0, streak_longest: profile?.streak_days || 0, completed_tests: 0, completed_exercises: 0 };
                     }

                      // Sloučení a výchozí hodnoty
                     const finalStats = {
                         progress: stats?.progress ?? 0,
                         progress_weekly: stats?.progress_weekly ?? 0,
                         points: profile?.points ?? 0,
                         points_weekly: stats?.points_weekly ?? 0,
                         streak_current: profile?.streak_days ?? 0,
                         streak_longest: Math.max(stats?.streak_longest ?? 0, profile?.streak_days ?? 0),
                         completed_tests: stats?.completed_tests ?? 0, // Předpokládáme, že tyto sloupce existují v user_stats
                         completed_exercises: stats?.completed_exercises ?? 0 // Předpokládáme, že tyto sloupce existují v user_stats
                     };
                     console.log("Načtené statistiky:", finalStats);
                     return finalStats;
                 } catch (error) {
                     console.error("Neočekávaná chyba ve fetchUserStats:", error);
                      return { progress: 0, progress_weekly: 0, points: 0, points_weekly: 0, streak_current: 0, streak_longest: 0, completed_tests: 0, completed_exercises: 0 }; // Fallback
                 }
            }

            async function fetchProgressHistory(userId, period = 'month') {
                // TODO: Implementovat načítání historie pokroku (např. z tabulky 'progress_history')
                // Prozatím vracíme dummy data
                 console.log(`Načítám historii pokroku pro období: ${period}`);
                 await new Promise(resolve => setTimeout(resolve, 500)); // Simulace načítání

                 const today = new Date();
                 const labels = [];
                 const data = [];
                 let daysToFetch;

                 switch (period) {
                     case 'week': daysToFetch = 7; break;
                     case 'month': daysToFetch = 30; break;
                     case '3months': daysToFetch = 90; break;
                     case 'all': daysToFetch = 180; break; // Např. posledních 6 měsíců
                     default: daysToFetch = 30;
                 }

                 let currentProgress = Math.random() * 30 + 50; // Start progress somewhere 50-80
                 for (let i = daysToFetch - 1; i >= 0; i--) {
                     const date = new Date(today);
                     date.setDate(today.getDate() - i);
                     labels.push(date.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'numeric' }));
                     // Simulate slight random changes in progress
                     currentProgress += (Math.random() - 0.45) * 2; // Small changes up or down
                     currentProgress = Math.max(0, Math.min(100, currentProgress)); // Clamp between 0 and 100
                     data.push(currentProgress);
                 }

                return { labels, data };
            }

             async function fetchRecentActivities(userId, limit = 20) {
                 try {
                     const { data, error } = await supabase
                         .from('activities') // Předpokládáme tabulku 'activities'
                         .select('*')
                         .eq('user_id', userId)
                         .order('created_at', { ascending: false })
                         .limit(limit);
                     if (error) throw error;
                     console.log(`Načteno ${data?.length || 0} aktivit.`);
                     return data;
                 } catch (error) {
                     console.error("Chyba načítání aktivit:", error);
                     showToast('Nepodařilo se načíst nedávné aktivity.', 'error');
                     return [];
                 }
             }
             // --- KONEC: Načítání Dat ---


             // --- START: Aktualizace UI ---
             function updateUserInfoUI() {
                 if (!ui.sidebarName || !ui.sidebarAvatar) return;
                 if (currentUser) {
                     const displayName = `${currentProfile?.first_name || ''} ${currentProfile?.last_name || ''}`.trim() || currentProfile?.username || currentUser.email?.split('@')[0] || 'Uživatel';
                     ui.sidebarName.textContent = displayName;
                     const initials = getInitials(currentProfile || { email: currentUser.email });
                     ui.sidebarAvatar.innerHTML = currentProfile?.avatar_url ? `<img src="${currentProfile.avatar_url}" alt="${initials}">` : initials;
                 } else {
                     ui.sidebarName.textContent = "Nepřihlášen";
                     ui.sidebarAvatar.textContent = '?';
                 }
             }

            function updateStatsCards(stats) {
                 if (!stats) { // Zobrazit chybový nebo výchozí stav
                     const cards = [ui.overallProgressValue, ui.totalPointsValue, ui.streakValue, ui.completedCountValue];
                      const footers = [ui.overallProgressFooter, ui.totalPointsFooter, ui.streakFooter, ui.completedCountFooter];
                      cards.forEach(el => { if(el) el.textContent = '-'; });
                      footers.forEach(el => { if(el) el.innerHTML = '<i class="fas fa-exclamation-circle"></i> Data nejsou dostupná'; });
                     return;
                 }

                 // Celkový pokrok
                 if (ui.overallProgressValue) ui.overallProgressValue.textContent = `${stats.progress || 0}%`;
                 if (ui.overallProgressDesc) ui.overallProgressDesc.textContent = "Průměr ze všech oblastí"; // Může být dynamické
                 if (ui.overallProgressFooter) {
                     const change = stats.progress_weekly || 0;
                     const icon = change > 0 ? 'fa-arrow-up' : change < 0 ? 'fa-arrow-down' : 'fa-minus';
                     const sign = change > 0 ? '+' : '';
                     ui.overallProgressFooter.className = `stats-card-footer ${change > 0 ? 'positive' : change < 0 ? 'negative' : ''}`;
                     ui.overallProgressFooter.innerHTML = `<i class="fas ${icon}"></i> ${sign}${change}% tento týden`;
                 }

                 // Body
                 if (ui.totalPointsValue) ui.totalPointsValue.textContent = stats.points || 0;
                 if (ui.totalPointsDesc) ui.totalPointsDesc.textContent = "Získáno za aktivity a testy";
                 if (ui.totalPointsFooter) {
                     const change = stats.points_weekly || 0;
                     const icon = change > 0 ? 'fa-arrow-up' : change < 0 ? 'fa-arrow-down' : 'fa-minus';
                     const sign = change > 0 ? '+' : '';
                      ui.totalPointsFooter.className = `stats-card-footer ${change > 0 ? 'positive' : change < 0 ? 'negative' : ''}`;
                      ui.totalPointsFooter.innerHTML = `<i class="fas ${icon}"></i> ${sign}${change} bodů tento týden`;
                 }

                 // Série
                 if (ui.streakValue) ui.streakValue.textContent = stats.streak_current || 0;
                 if (ui.streakDesc) ui.streakDesc.textContent = `Počet dnů studia v řadě`;
                 if (ui.streakFooter) ui.streakFooter.innerHTML = `<i class="fas fa-medal"></i> Nejdelší série: ${stats.streak_longest || 0} dnů`;

                 // Dokončené aktivity
                 const completedTotal = (stats.completed_tests || 0) + (stats.completed_exercises || 0);
                 if (ui.completedCountValue) ui.completedCountValue.textContent = completedTotal;
                 if (ui.completedCountDesc) ui.completedCountDesc.textContent = `Testů: ${stats.completed_tests || 0}, Cvičení: ${stats.completed_exercises || 0}`;
                 // Zde footer může ukazovat např. % dokončení plánu, pokud je k dispozici
                 if (ui.completedCountFooter) ui.completedCountFooter.innerHTML = `<i class="fas fa-tasks"></i> Celkem dokončených úkolů`; // Placeholder
            }

             function renderProgressChart(chartData) {
                if (!ui.progressChartCanvas) return;
                const ctx = ui.progressChartCanvas.getContext('2d');

                if (progressChartInstance) {
                    progressChartInstance.destroy(); // Zničit starý graf před kreslením nového
                    progressChartInstance = null;
                }

                 if (!chartData || !chartData.labels || !chartData.data || chartData.labels.length === 0) {
                      // Zobrazit zprávu, pokud nejsou data
                      ui.progressChartCanvas.style.display = 'none'; // Skrýt canvas
                      const container = ui.progressChartCanvas.parentElement;
                      let msgElement = container.querySelector('.empty-chart-message');
                      if (!msgElement) {
                           msgElement = document.createElement('div');
                           msgElement.className = 'empty-state empty-chart-message'; // Reuse empty-state style
                           container.appendChild(msgElement);
                      }
                       msgElement.innerHTML = '<i class="fas fa-chart-line"></i><p>Nedostatek dat pro zobrazení grafu.</p>';
                      return;
                 }

                  // Skrýt zprávu a zobrazit canvas, pokud existují data
                 ui.progressChartCanvas.style.display = 'block';
                 const existingMsg = ui.progressChartCanvas.parentElement.querySelector('.empty-chart-message');
                 if (existingMsg) existingMsg.remove();


                const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                 const gridColor = isDarkMode ? 'rgba(74, 85, 104, 0.15)' : 'rgba(200, 200, 200, 0.2)';
                 const textColor = isDarkMode ? '#a0aec0' : '#6c757d';
                 const pointColor = isDarkMode ? '#4cc9f0' : '#4361ee'; // Info color for dark, Primary for light
                 const lineColor = pointColor; // Use the same color for the line
                 const areaColor = isDarkMode ? 'rgba(76, 201, 240, 0.1)' : 'rgba(67, 97, 238, 0.1)';

                 progressChartInstance = new Chart(ctx, {
                     type: 'line',
                     data: {
                         labels: chartData.labels,
                         datasets: [{
                             label: 'Celkový pokrok (%)',
                             data: chartData.data,
                             borderColor: lineColor,
                             backgroundColor: areaColor,
                             fill: true,
                             tension: 0.3, // Lehké zaoblení čáry
                             borderWidth: 2,
                             pointBackgroundColor: pointColor,
                             pointBorderColor: pointColor,
                             pointRadius: 4,
                             pointHoverRadius: 6,
                             pointHoverBackgroundColor: pointColor,
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         scales: {
                             y: {
                                 beginAtZero: true,
                                 max: 100,
                                 ticks: {
                                      stepSize: 20,
                                     color: textColor,
                                      callback: function(value) { return value + '%'; }
                                 },
                                 grid: { color: gridColor, }
                             },
                             x: {
                                 ticks: { color: textColor, maxRotation: 0, autoSkipPadding: 15 }, // Vylepšené popisky osy X
                                 grid: { display: false } // Skrytí mřížky X
                             }
                         },
                         plugins: {
                             legend: { display: false }, // Skrytí legendy
                             tooltip: {
                                 mode: 'index',
                                 intersect: false,
                                 backgroundColor: isDarkMode ? '#1e2a3a' : '#343a40',
                                 titleColor: '#ffffff',
                                 bodyColor: '#ffffff',
                                 borderColor: isDarkMode ? 'rgba(74, 85, 104, 0.5)' : 'rgba(0,0,0,0.1)',
                                 borderWidth: 1,
                                 padding: 10,
                                 displayColors: false, // Nezobrazovat barevný čtvereček
                                 callbacks: {
                                     label: function(context) {
                                         return `Pokrok: ${context.parsed.y.toFixed(1)}%`;
                                     }
                                 }
                             }
                         },
                         interaction: {
                             mode: 'nearest',
                             axis: 'x',
                             intersect: false
                         }
                     }
                 });
             }

            function renderActivitiesTable(activities) {
                 if (!ui.activitiesBody || !ui.activitiesTable) return;
                 ui.activitiesBody.innerHTML = ''; // Vyčistit staré řádky

                  // Odstranit skeleton řádky, pokud existují
                 const skeletonRows = ui.activitiesTable.querySelectorAll('.skeleton-row');
                 skeletonRows.forEach(row => row.remove());

                 if (!activities || activities.length === 0) {
                     ui.activitiesTable.style.display = 'none';
                     ui.activitiesEmptyState.style.display = 'block';
                     return;
                 }

                 ui.activitiesTable.style.display = 'table';
                 ui.activitiesEmptyState.style.display = 'none';

                 activities.forEach(activity => {
                     const row = ui.activitiesBody.insertRow();
                     const typeInfo = activityTypeMap[activity.type] || activityTypeMap.default;
                     const statusInfo = activityStatusMap[activity.status] || { name: activity.status || '-', class: 'pending', icon: 'fa-question-circle'};

                     row.innerHTML = `
                         <td>${formatDate(activity.created_at, true)}</td>
                         <td><i class="fas ${typeInfo.icon}" style="margin-right: 5px;" title="${typeInfo.name}"></i> ${typeInfo.name}</td>
                         <td>${sanitizeHTML(activity.title || activity.description || '-')}</td>
                         <td class="points-value">${activity.points_earned ?? '-'}</td>
                         <td><span class="status-badge ${statusInfo.class}"><i class="fas ${statusInfo.icon}"></i> ${statusInfo.name}</span></td>
                     `;
                 });
             }
            // --- KONEC: Aktualizace UI ---


            // --- START: Event Listenery ---
             function setupEventListeners() {
                 if (ui.refreshBtn) ui.refreshBtn.addEventListener('click', loadAllData);
                 if (ui.mobileMenuToggle) ui.mobileMenuToggle.addEventListener('click', toggleMobileMenu);
                 if (ui.sidebarOverlay) ui.sidebarOverlay.addEventListener('click', toggleMobileMenu);
                 if (ui.chartPeriodSelect) ui.chartPeriodSelect.addEventListener('change', handlePeriodChange);
                 if (ui.activityTypeFilter) ui.activityTypeFilter.addEventListener('change', handleActivityFilter);
                 if (ui.exportTableBtn) ui.exportTableBtn.addEventListener('click', exportTableToCSV);
                 if (ui.mainElement) ui.mainElement.addEventListener('scroll', handleScroll); // Sledování skrolování
                 // Inicializace Tooltipster
                 if (window.jQuery && window.jQuery.fn.tooltipster) {
                     window.jQuery('.btn-tooltip').tooltipster({ theme: 'tooltipster-shadow', animation: 'fade', delay: 100 });
                 }
             }

            async function handlePeriodChange() {
                if (!currentUser || isLoading.chart) return;
                const selectedPeriod = ui.chartPeriodSelect.value;
                console.log(`Změna období grafu na: ${selectedPeriod}`);
                setLoadingState('chart', true);
                isLoading.chart = true;
                try {
                    const chartData = await fetchProgressHistory(currentUser.id, selectedPeriod);
                    renderProgressChart(chartData);
                } catch (error) {
                    showError("Nepodařilo se načíst data pro graf.", false);
                     renderProgressChart(null); // Zobrazit prázdný stav grafu
                } finally {
                     isLoading.chart = false;
                     setLoadingState('chart', false);
                }
            }

             function handleActivityFilter() {
                 const selectedType = ui.activityTypeFilter.value;
                 console.log(`Filtruji aktivity podle typu: ${selectedType}`);
                 const filteredActivities = selectedType === 'all'
                     ? allActivities
                     : allActivities.filter(activity => activity.type === selectedType);
                 renderActivitiesTable(filteredActivities);
             }

            function exportTableToCSV() {
                if (!allActivities || allActivities.length === 0) {
                    showToast("Není co exportovat.", "warning");
                    return;
                }

                 const headers = ["Datum", "Typ", "Název/Popis", "Body", "Stav"];
                 const rows = allActivities.map(activity => {
                    const typeInfo = activityTypeMap[activity.type] || activityTypeMap.default;
                    const statusInfo = activityStatusMap[activity.status] || { name: activity.status || '-'};
                    return [
                         `"${formatDate(activity.created_at, true)}"`,
                         `"${typeInfo.name}"`,
                         `"${(activity.title || activity.description || '-').replace(/"/g, '""')}"`, // Handle quotes
                         activity.points_earned ?? '',
                         `"${statusInfo.name}"`
                    ].join(',');
                 });

                 const csvContent = "data:text/csv;charset=utf-8,"
                     + headers.join(',') + "\n"
                     + rows.join("\n");

                 const encodedUri = encodeURI(csvContent);
                 const link = document.createElement("a");
                 link.setAttribute("href", encodedUri);
                 link.setAttribute("download", `justax_aktivity_${new Date().toISOString().split('T')[0]}.csv`);
                 document.body.appendChild(link); // Required for FF
                 link.click();
                 document.body.removeChild(link);
                 showToast("Tabulka exportována do CSV.", "success");
            }
            // --- KONEC: Event Listenery ---


            // --- Spuštění Aplikace ---
            document.addEventListener('DOMContentLoaded', initializeApp);

        })(); // Konec IIFE
    </script>
</body>
</html>