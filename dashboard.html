<script>
// Initialize Supabase client
const supabaseUrl = 'https://xunitidnszlsqupiifhd.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1bml0aWRuc3psc3F1cGlpZmhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEwMTY0MDQsImV4cCI6MjA1NjU5MjQwNH0.8v2dMEaAQYRhHmmJe15XkbA07Tsupc1iLT9oAsLEsWw';
const supabase = supabaseClient.createClient(supabaseUrl, supabaseKey);

document.addEventListener('DOMContentLoaded', async function() {
    // Check authentication state
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
    
    if (!session) {
        window.location.href = '/auth/login.html';
        return;
    }

    // Initialize UI elements
    const userNameDisplay = document.getElementById('userNameDisplay');
    const userWelcomeName = document.getElementById('userWelcomeName');
    const userInitials = document.getElementById('userInitials');
    const chatMessages = document.querySelector('.ai-chat-messages');
    const chatInput = document.querySelector('.ai-chat-input input');
    const sendButton = document.querySelector('.ai-chat-input .btn');

    // Load user profile
    async function loadUserProfile() {
        const { data: profile, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', session.user.id)
            .single();

        if (profile) {
            userNameDisplay.textContent = profile.full_name;
            userWelcomeName.textContent = profile.full_name;
            userInitials.textContent = profile.full_name
                .split(' ')
                .map(n => n[0])
                .join('')
                .toUpperCase();
        }
    }

    // Load user statistics
    async function loadUserStats() {
        const { data: stats, error } = await supabase
            .from('user_stats')
            .select('*')
            .eq('user_id', session.user.id)
            .single();

        if (stats) {
            document.querySelector('.stat-card:nth-child(1) .stat-card-value').textContent = `${stats.total_time}h`;
            document.querySelector('.stat-card:nth-child(2) .stat-card-value').textContent = stats.solved_problems;
            document.querySelector('.stat-card:nth-child(3) .stat-card-value').textContent = `${stats.streak} dní`;
        }
    }

    // Load user progress
    async function loadUserProgress() {
        const { data: progress, error } = await supabase
            .from('user_progress')
            .select('*')
            .eq('user_id', session.user.id)
            .single();

        if (progress) {
            updateProgressBar('Algebra', progress.algebra);
            updateProgressBar('Geometrie', progress.geometry);
            updateProgressBar('Analýza', progress.analysis);
        }
    }

    function updateProgressBar(subject, value) {
        const container = Array.from(document.querySelectorAll('.progress-container'))
            .find(container => container.querySelector('.progress-label span').textContent === subject);
        
        if (container) {
            container.querySelector('.progress-label span:last-child').textContent = `${value}%`;
            container.querySelector('.progress-value').style.width = `${value}%`;
        }
    }

    // Load recent activities
    async function loadRecentActivities() {
        const { data: activities, error } = await supabase
            .from('activities')
            .select('*')
            .eq('user_id', session.user.id)
            .order('timestamp', { ascending: false })
            .limit(3);

        if (activities && activities.length > 0) {
            const recentActivitiesContainer = document.querySelector('.recent-activities');
            recentActivitiesContainer.innerHTML = '';

            activities.forEach(activity => {
                const activityElement = createActivityElement(activity);
                recentActivitiesContainer.appendChild(activityElement);
            });
        }
    }

    function createActivityElement(activity) {
        const div = document.createElement('div');
        div.className = 'activity-item';
        div.innerHTML = `
            <div class="activity-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    ${getActivityIcon(activity.activity_type)}
                </svg>
            </div>
            <div class="activity-content">
                <div class="activity-text">${activity.description}</div>
                <div class="activity-time">${formatActivityTime(activity.timestamp)}</div>
            </div>
        `;
        return div;
    }

    function getActivityIcon(type) {
        const icons = {
            'practice': '<path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>',
            'test': '<rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>',
            'tutorial': '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline>'
        };
        return icons[type] || icons['practice'];
    }

    function formatActivityTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 86400000) { // Less than 24 hours
            return date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
        } else if (diff < 172800000) { // Less than 48 hours
            return 'Včera, ' + date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
        } else {
            return date.toLocaleDateString('cs-CZ');
        }
    }

    // Chat functionality
    let currentTopic = 'Algebra';

    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        // Add user message to chat
        addMessage(message, 'user');
        chatInput.value = '';

        try {
            // Save message to Supabase
            const { data: savedMessage, error: messageError } = await supabase
                .from('messages')
                .insert([{
                    user_id: session.user.id,
                    content: message,
                    topic: currentTopic,
                    type: 'user'
                }])
                .single();

            if (messageError) throw messageError;

            // Get AI response
            const aiResponse = await getAIResponse(message, currentTopic);
            addMessage(aiResponse, 'ai');

            // Save AI response
            await supabase
                .from('messages')
                .insert([{
                    user_id: session.user.id,
                    content: aiResponse,
                    topic: currentTopic,
                    type: 'ai'
                }]);

        } catch (error) {
            console.error('Error:', error);
            addMessage('Omlouváme se, došlo k chybě při zpracování zprávy.', 'system');
        }
    }

    async function getAIResponse(message, topic) {
        // Simplified AI response logic - replace with actual AI integration
        const responses = {
            'Algebra': {
                'default': 'Rád ti pomůžu s algebrou. Co konkrétně potřebuješ vysvětlit?',
                'příklad': 'Pojďme ten příklad vyřešit krok po kroku.'
            },
            'Derivace': {
                'default': 'Derivace jsou základem diferenciálního počtu. Jak ti mohu pomoci?'
            }
        };

        return responses[topic]?.[message.toLowerCase()] || responses[topic]?.['default'] || 
               'Mohu ti s tímto tématem pomoci. Jak konkrétně ti mohu poradit?';
    }

    function addMessage(content, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${type}`;
        
        const contentDiv = document.createElement('div');
        contentDiv.textContent = content;
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = new Date().toLocaleTimeString('cs-CZ', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(timeDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Topic selection handling
    document.querySelectorAll('.topic-btn').forEach(button => {
        button.addEventListener('click', function() {
            const topic = this.textContent;
            document.querySelectorAll('.topic-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            currentTopic = topic;
            
            // Update chat header
            document.querySelector('.ai-chat-title').innerHTML = `
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                    <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                    <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                    <line x1="6" y1="6" x2="6.01" y2="6"></line>
                    <line x1="6" y1="18" x2="6.01" y2="18"></line>
                </svg>
                ${topic} - osobní tutor
            `;
        });
    });

    // Chat input handlers
    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Logout handler
    document.getElementById('logoutButton').addEventListener('click', async function(e) {
        e.preventDefault();
        try {
            await supabase.auth.signOut();
            window.location.href = '/auth/login.html';
        } catch (error) {
            console.error('Error during logout:', error);
        }
    });

    // Section navigation
    document.querySelectorAll('[data-section]').forEach(element => {
        element.addEventListener('click', function(e) {
            e.preventDefault();
            const sectionId = this.getAttribute('data-section');
            document.querySelectorAll('.section-container').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`${sectionId}-section`)?.classList.remove('hidden');
        });
    });

    // Initialize dashboard
    async function initializeDashboard() {
        try {
            await Promise.all([
                loadUserProfile(),
                loadUserStats(),
                loadUserProgress(),
                loadRecentActivities()
            ]);
        } catch (error) {
            console.error('Error initializing dashboard:', error);
        }
    }

    // Start initialization
    initializeDashboard();
});
</script>
</body>
</html>