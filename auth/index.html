<!DOCTYPE html>
<html lang="cs" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="Justax - Přihlášení nebo Registrace. Osobní doučování matematiky s AI asistentem.">
    <title>Justax - Autentizace</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- START: Kyberpunk CSS (převzato a upraveno z index.html) --- */
        :root {
            /* Основа */
            --bg-color: #050410;            /* Глубокий */
            --bg-secondary: #0d0a24;       /* Темный индиго */
            --card-bg: rgba(12, 8, 40, 0.85);  /* Mírně tmavší, méně průhledné pro kontrast */
            --card-solid: #120d33;         /* Сплошной */
            --interface-bg: rgba(8, 5, 26, 0.9);
            --interface-border: rgba(0, 240, 255, 0.3); /* Циановая рамка интерфейса */

            /* Акценты - Циан основной, Фиолетовый/Розовый вторичные */
            --accent-primary: #00e0ff;     /* Циан */
            --accent-primary-rgb: 0, 240, 255;
            --accent-secondary: #a05cff;   /* Фиолетовый */
            --accent-secondary-rgb: 160, 92, 255;
            --accent-pink: #ff33a8;        /* Розовый */
            --accent-pink-rgb: 255, 51, 168;
            --accent-lime: #6fff3a;        /* Лайм */
            --accent-lime-rgb: 111, 255, 58;
            --accent-glow: rgba(var(--accent-primary-rgb), 0.5); /* Сильное Циановое свечение */
            --accent-secondary-glow: rgba(var(--accent-secondary-rgb), 0.4);
            --accent-border-glow: rgba(var(--accent-primary-rgb), 0.7);
            --danger-color: #ff4d6d; /* Jasnější červená pro chyby */
            --danger-glow: rgba(255, 77, 109, 0.5);
            --success-color: var(--accent-lime);
            --success-glow: rgba(var(--accent-lime-rgb), 0.5);

            /* Текст */
            --text-light: #f0f4f8;
            --text-medium: #c0c8e0;
            --text-muted: #8892b0;
            --text-heading: #ffffff; /* БЕЛЫЙ! */
            --text-link: var(--accent-primary);
            --text-link-hover: #ffffff;
            --text-fixed-dark: #050410;

            /* Границы */
            --border-color-light: rgba(var(--accent-secondary-rgb), 0.2);
            --border-color-medium: rgba(var(--accent-secondary-rgb), 0.4);
            --border-color-strong: rgba(var(--accent-primary-rgb), 0.6); /* Ярче циан */
            --border-interactive: var(--accent-primary);
            --border-glow-gradient: linear-gradient(90deg, transparent, var(--accent-primary), transparent);

            /* Градиенты */
            --gradient-header: linear-gradient(180deg, rgba(5, 4, 16, 0.95) 0%, rgba(5, 4, 16, 0.8) 100%);
            --gradient-border-anim: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary), var(--accent-pink), var(--accent-primary), var(--accent-secondary));
            --gradient-button: linear-gradient(100deg, var(--accent-secondary) 0%, var(--accent-primary) 100%);
            --gradient-button-hover: linear-gradient(100deg, var(--accent-primary) 0%, var(--accent-pink) 100%);
            --gradient-body-bg: radial-gradient(ellipse at 50% 0%, rgba(var(--accent-primary-rgb), 0.1), transparent 60%),
                                radial-gradient(ellipse at 10% 100%, rgba(var(--accent-secondary-rgb), 0.1), transparent 70%),
                                radial-gradient(ellipse at 90% 100%, rgba(var(--accent-pink-rgb), 0.08), transparent 70%),
                                var(--bg-color);

            /* Шрифты */
            --font-primary: 'Inter', sans-serif;
            --font-secondary: 'Poppins', sans-serif;
            --font-mono: 'Roboto Mono', monospace;

            /* Тени */
            --shadow-glow: 0 0 20px var(--accent-glow);
            --shadow-card: 0 10px 35px rgba(0, 0, 0, 0.35); /* Глубже */
            --shadow-interactive: 0 6px 18px rgba(var(--accent-primary-rgb), 0.35); /* Заметнее */
            --shadow-interactive-hover: 0 8px 25px rgba(var(--accent-pink-rgb), 0.4); /* Розовый ховер */

            /* Размеры и переходы */
            --card-radius: 12px;
            --btn-radius: 8px;
            --input-radius: 8px; /* Sjednotit s tlačítky */
            --transition-fast: all 0.2s ease-out;
            --transition-medium: all 0.35s ease-out;
        }

        /* --- Základní styly --- */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            background-color: var(--bg-color);
            background-image: var(--gradient-body-bg);
            color: var(--text-medium);
            font-family: var(--font-primary);
            line-height: 1.7;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
            display: flex; /* Zajistit, aby flex fungoval */
            align-items: center; /* Vertikální zarovnání */
            justify-content: center; /* Horizontální zarovnání */
            padding: 2rem; /* Odsazení od okrajů */
            position: relative;
        }
        body::before { /* Animated Grid */
            content: ""; position: fixed; inset: 0; width: 100%; height: 100%; z-index: -2;
            background-image:
                linear-gradient(rgba(var(--accent-secondary-rgb), 0.06) 1px, transparent 1px),
                linear-gradient(90deg, rgba(var(--accent-secondary-rgb), 0.06) 1px, transparent 1px);
            background-size: 40px 40px; /* Mírně větší mřížka */
            opacity: 0.8;
            animation: bg-grid-pan 120s linear infinite;
        }
        @keyframes bg-grid-pan { 0% { background-position: 0 0; } 100% { background-position: 800px 400px; } }

        /* --- Typografie --- */
        h1, h2, h3, h4, h5, h6 { font-family: var(--font-secondary); font-weight: 700; color: var(--text-heading); line-height: 1.3; margin-bottom: 1em; text-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        h1 { font-size: clamp(2.5rem, 6vw, 3.5rem); font-weight: 800; }
        p { margin-bottom: 1.5rem; font-size: clamp(0.95rem, 2vw, 1.05rem); max-width: 650px; color: var(--text-medium); }
        a { color: var(--text-link); text-decoration: none; transition: color var(--transition-fast), text-shadow 0.3s ease; }
        a:hover { color: var(--text-link-hover); text-shadow: 0 0 8px var(--accent-glow); }

        /* --- Kontejner a formulářový panel --- */
        .auth-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Zajistí, že wrapper zabere celou výšku */
        }

        .auth-container {
            width: 100%;
            max-width: 480px; /* Užší pro zaměření */
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--interface-border);
            border-radius: var(--card-radius);
            padding: clamp(2rem, 6vw, 3rem);
            box-shadow: var(--shadow-card), 0 0 50px rgba(var(--accent-secondary-rgb), 0.1) inset;
            position: relative;
            z-index: 1;
            animation: fadeIn 0.6s ease forwards;
            opacity: 0;
            transform: translateY(15px);
        }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        /* HUD Corners */
        .auth-container::before, .auth-container::after {
            content: ''; position: absolute; width: 25px; height: 25px;
            border-color: var(--accent-primary); border-style: solid; opacity: 0.6;
            transition: all 0.3s ease; pointer-events: none;
        }
        .auth-container::before { top: 12px; left: 12px; border-width: 2px 0 0 2px; }
        .auth-container::after { bottom: 12px; right: 12px; border-width: 0 2px 2px 0; }
        .auth-container:hover::before { transform: translate(-2px, -2px); border-color: var(--accent-pink); }
        .auth-container:hover::after { transform: translate(2px, 2px); border-color: var(--accent-pink); }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-header .logo {
             display: inline-block;
             font-size: 2rem;
             font-weight: 800;
             color: var(--text-heading);
             text-decoration: none;
             margin-bottom: 0.5rem;
             text-shadow: 0 0 8px var(--accent-glow);
         }
         .auth-header .logo i {
             color: var(--accent-primary);
             margin-right: 0.5rem;
             filter: drop-shadow(0 0 5px var(--accent-glow));
         }

        .auth-header h1 {
            font-size: 1.8rem; /* Mírně menší */
            margin-bottom: 0.5rem;
            color: var(--text-heading);
        }

        .auth-header p {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 0;
        }

        /* --- Taby --- */
        .tab-container {
            display: flex;
            margin-bottom: 1.8rem;
            border-radius: var(--btn-radius);
            overflow: hidden;
            border: 1px solid var(--border-color-light);
            background: rgba(var(--accent-primary-rgb), 0.05);
        }
        .tab {
            flex: 1;
            padding: 0.8rem 1rem;
            text-align: center;
            background: transparent;
            cursor: pointer;
            transition: all var(--transition-medium);
            font-weight: 600;
            color: var(--text-medium);
            position: relative;
            border: none;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        .tab:hover:not(.active) {
            background: rgba(var(--accent-primary-rgb), 0.1);
            color: var(--text-light);
        }
        .tab.active {
            background: var(--accent-primary);
            color: var(--text-fixed-dark);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2), 0 0 10px var(--accent-glow);
        }

        /* --- Formulářové Prvky --- */
        .form-group {
            margin-bottom: 1.4rem; /* Mírně menší mezery */
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-medium);
            font-size: 0.9rem;
        }
        .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color-light);
            border-radius: var(--input-radius);
            font-size: 1rem;
            font-family: var(--font-primary);
            color: var(--text-light);
            background-color: rgba(var(--bg-secondary), 0.6);
            transition: all var(--transition-fast);
            caret-color: var(--accent-primary);
        }
        .form-control::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--accent-primary);
            background-color: rgba(var(--bg-secondary), 0.9);
            box-shadow: 0 0 10px -2px var(--accent-glow);
        }
        .form-control.is-invalid {
             border-color: var(--danger-color) !important;
             box-shadow: 0 0 8px var(--danger-glow) !important;
        }

        /* --- Tlačítka (použití stylu z index.html) --- */
        .btn {
            display: inline-block; padding: 0.9rem 2.4rem;
            background: transparent; color: var(--accent-primary);
            border: 2px solid var(--accent-primary); border-radius: var(--btn-radius);
            font-family: var(--font-secondary); font-weight: 600; font-size: 0.95rem;
            text-align: center; text-transform: uppercase; letter-spacing: 1.3px;
            cursor: pointer; transition: all var(--transition-medium);
            position: relative; overflow: hidden; z-index: 1;
            box-shadow: 0 0 12px -2px var(--accent-glow), inset 0 0 8px -4px var(--accent-glow);
            backdrop-filter: blur(2px);
            width: 100%; /* Tlačítko na celou šířku */
            margin-top: 1rem;
        }
        .btn::before { /* Fill effect */
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: var(--gradient-button); transition: left 0.3s ease-in-out; z-index: -1;
        }
        .btn:hover:not(:disabled) {
            color: var(--text-fixed-dark); border-color: var(--accent-secondary); /* Secondary border on hover */
            box-shadow: 0 0 25px var(--accent-secondary-glow), inset 0 0 10px rgba(var(--accent-secondary-rgb), 0.1);
            transform: translateY(-3px);
        }
        .btn:hover:not(:disabled)::before { left: 0; background: var(--gradient-button-hover); /* Use hover gradient for fill */ }
        .btn:active:not(:disabled) { transform: translateY(0px) scale(0.98); }
        .btn:disabled {
             opacity: 0.5;
             cursor: not-allowed;
             background: var(--border-color-medium);
             border-color: var(--border-color-medium);
             color: var(--text-muted);
             box-shadow: none;
             backdrop-filter: none;
         }
        .btn:disabled::before { display: none; }

        /* --- Ostatní Prvky --- */
        .forgot-password {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.9rem;
        }
        .forgot-password a, .form-footer a {
            color: var(--text-link);
            font-weight: 500;
        }
        .forgot-password a:hover, .form-footer a:hover {
            color: var(--text-link-hover);
            text-shadow: 0 0 6px var(--accent-glow);
        }

        .checkbox-container {
             display: flex;
             align-items: center;
             margin-bottom: 1rem;
             cursor: pointer;
             user-select: none;
             color: var(--text-medium);
             font-size: 0.9rem;
         }
         .checkbox-container input[type="checkbox"] {
             margin-right: 0.7rem;
             accent-color: var(--accent-primary); /* Prohlížečový styl checkboxu */
             width: 16px;
             height: 16px;
             cursor: pointer;
         }

        .password-container { position: relative; }
        .password-toggle {
            position: absolute; right: 1rem; top: 50%; transform: translateY(-50%);
            cursor: pointer; color: var(--text-muted); background: none; border: none;
            padding: 0.3rem; font-size: 1rem; transition: color var(--transition-fast);
        }
        .password-toggle:hover { color: var(--accent-primary); }

        .password-strength {
            margin-top: 0.6rem; height: 5px; background-color: rgba(var(--border-color-light), 0.5);
            border-radius: 2.5px; overflow: hidden; transition: all 0.3s ease;
        }
        .password-strength-meter {
            height: 100%; border-radius: 2.5px; transition: width 0.4s ease-out, background-color 0.4s ease-out;
        }
        .strength-weak { background-color: var(--danger-color); width: 30%; box-shadow: 0 0 5px var(--danger-glow); }
        .strength-medium { background-color: var(--accent-secondary); width: 65%; box-shadow: 0 0 5px var(--accent-secondary-glow); }
        .strength-strong { background-color: var(--accent-lime); width: 100%; box-shadow: 0 0 5px var(--success-glow); }

        /* --- Zprávy a Loading --- */
        #messageContainer {
            margin-bottom: 1.5rem;
            min-height: 0;
            transition: all 0.3s ease;
            overflow: hidden; /* Ensure content doesn't overflow during transition */
        }
        .alert {
            padding: 0.9rem 1.2rem; border-radius: var(--btn-radius);
            font-size: 0.9rem; font-weight: 500;
            animation: fadeIn 0.4s ease forwards;
            opacity: 0; transform: translateY(5px);
            border: 1px solid;
            display: flex; align-items: center; gap: 0.7rem;
        }
        .alert i { font-size: 1.1em; }
        .alert-error { background-color: rgba(var(--danger-color), 0.1); color: var(--danger-color); border-color: rgba(var(--danger-color), 0.4); }
        .alert-success { background-color: rgba(var(--success-color), 0.1); color: var(--success-color); border-color: rgba(var(--success-color), 0.4); }

        .form-loading { display: none; text-align: center; margin: 1rem 0; color: var(--text-muted); font-size: 0.9rem; }
        .loading-spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid rgba(var(--accent-primary-rgb), 0.3); border-radius: 50%; border-top-color: var(--accent-primary); animation: spin 1s linear infinite; margin-right: 0.5rem; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Footer text */
        .form-footer {
            margin-top: 1.5rem; font-size: 0.8rem; text-align: center;
            color: var(--text-muted); line-height: 1.5;
        }

        /* Hidden form state */
        .form-container.hidden { display: none; }

        /* --- Responzivita --- */
        @media (max-width: 576px) {
            body { padding: 1rem; }
            .auth-container { padding: 1.5rem; }
            .auth-header h1 { font-size: 1.6rem; }
            .tab { padding: 0.7rem 0.5rem; font-size: 0.85rem; }
            .btn { padding: 0.8rem 1.5rem; font-size: 0.9rem; }
        }
        /* --- END: Kyberpunk CSS --- */
    </style>
</head>
<body class="dark">

    <div class="auth-wrapper">
        <div class="auth-container">
            <div class="auth-header">
                <a href="/" class="logo">
                    <i class="fas fa-atom"></i> <span>JUSTAX</span>
                </a>
                <p>Přihlaste se nebo se zaregistrujte pro přístup</p>
            </div>

            <div class="tab-container">
                <div class="tab active" id="loginTab">Přihlášení</div>
                <div class="tab" id="registerTab">Registrace</div>
            </div>

            <div id="messageContainer"></div>

            <form id="loginForm" class="form-container">
                <div class="form-group">
                    <label for="loginEmail" class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-control" required autocomplete="email" placeholder="vas@email.cz">
                </div>

                <div class="form-group">
                    <div class="password-container">
                        <label for="loginPassword" class="form-label">Heslo</label>
                        <input type="password" id="loginPassword" class="form-control" required autocomplete="current-password" placeholder="••••••••">
                        <button type="button" class="password-toggle" data-for="loginPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group checkbox-container">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">Zapamatovat si mě</label>
                </div>

                <div class="form-loading" id="loginLoading">
                    <div class="loading-spinner"></div> Přihlašování...
                </div>

                <button type="submit" class="btn" id="loginButton">Přihlásit se</button>

                <div class="forgot-password">
                    <a href="#" id="forgotPasswordLink">Zapomněli jste heslo?</a>
                </div>
            </form>

            <form id="registerForm" class="form-container hidden">
                <div class="form-group">
                    <label for="registerEmail" class="form-label">Email</label>
                    <input type="email" id="registerEmail" class="form-control" required autocomplete="email" placeholder="vas@email.cz">
                </div>

                <div class="form-group">
                    <label for="registerUsername" class="form-label">Uživatelské jméno</label>
                    <input type="text" id="registerUsername" class="form-control" required minlength="3" autocomplete="username" placeholder="Min. 3 znaky">
                </div>

                <div class="form-group">
                    <div class="password-container">
                        <label for="registerPassword" class="form-label">Heslo</label>
                        <input type="password" id="registerPassword" class="form-control" required minlength="6" autocomplete="new-password" placeholder="Min. 6 znaků">
                        <button type="button" class="password-toggle" data-for="registerPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="password-strength">
                        <div class="password-strength-meter" id="passwordStrength"></div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="password-container">
                        <label for="confirmPassword" class="form-label">Potvrzení hesla</label>
                        <input type="password" id="confirmPassword" class="form-control" required autocomplete="new-password" placeholder="Zadejte nové heslo znovu">
                        <button type="button" class="password-toggle" data-for="confirmPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-loading" id="registerLoading">
                    <div class="loading-spinner"></div> Vytváření účtu...
                </div>

                <button type="submit" class="btn" id="registerButton">Registrovat se</button>

                <div class="form-footer">
                    Registrací souhlasíte s našimi <a href="/terms" target="_blank">Podmínkami služby</a> a <a href="/privacy" target="_blank">Zásadami</a>.
                </div>
            </form>

            <form id="resetPasswordForm" class="form-container hidden">
                 <div class="auth-header" style="margin-bottom: 1.5rem;">
                     <h3>Obnovení hesla</h3>
                     <p>Zadejte svůj e-mail a my vám pošleme odkaz.</p>
                 </div>
                <div class="form-group">
                    <label for="resetEmail" class="form-label">Email</label>
                    <input type="email" id="resetEmail" class="form-control" required autocomplete="email" placeholder="Váš registrovaný email">
                </div>

                <div class="form-loading" id="resetLoading">
                    <div class="loading-spinner"></div> Odesílání...
                </div>

                <button type="submit" class="btn" id="resetButton">Odeslat odkaz</button>

                <div class="forgot-password">
                    <a href="#" id="backToLoginLink">Zpět na přihlášení</a>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Ponechán původní JavaScript pro funkčnost
        document.addEventListener('DOMContentLoaded', async function() {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const resetPasswordForm = document.getElementById('resetPasswordForm');
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            const backToLoginLink = document.getElementById('backToLoginLink');
            const messageContainer = document.getElementById('messageContainer');
            const passwordStrength = document.getElementById('passwordStrength');

            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');
            const rememberMe = document.getElementById('rememberMe');
            const loginButton = document.getElementById('loginButton');
            const loginLoading = document.getElementById('loginLoading');

            const registerEmail = document.getElementById('registerEmail');
            const registerUsername = document.getElementById('registerUsername');
            const registerPassword = document.getElementById('registerPassword');
            const confirmPassword = document.getElementById('confirmPassword');
            const registerButton = document.getElementById('registerButton');
            const registerLoading = document.getElementById('registerLoading');

            const resetEmail = document.getElementById('resetEmail');
            const resetButton = document.getElementById('resetButton');
            const resetLoading = document.getElementById('resetLoading');

            const SUPABASE_URL = 'https://qcimhjjwvsbgjsitmvuh.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjaW1oamp3dnNiZ2pzaXRtdnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1ODA5MjYsImV4cCI6MjA1ODE1NjkyNn0.OimvRtbXuIUkaIwveOvqbMd_cmPN5yY3DbWCBYc9D10';

            let supabase;
            try {
                 if (typeof window.supabase === 'undefined' || typeof window.supabase.createClient !== 'function') {
                     throw new Error("Knihovna Supabase nebyla správně načtena.");
                 }
                 supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                 console.log('Supabase klient inicializován.');
            } catch(e) {
                 console.error("Kritická chyba Supabase:", e);
                 showMessage(`Chyba připojení k backendu. Obnovte stránku. (${e.message})`, 'error');
                 // Optionally disable all forms
                 loginButton.disabled = true;
                 registerButton.disabled = true;
                 resetButton.disabled = true;
                 return; // Stop further execution
            }

            async function checkLoggedInUser() {
                 try {
                     const { data: { session }, error } = await supabase.auth.getSession();
                     if (error) { console.error('Chyba při kontrole sezení:', error); return false; }
                     if (session) {
                         console.log('Uživatel již přihlášen, přesměrování...');
                         window.location.href = '/dashboard/dashboard.html';
                         return true;
                     }
                     return false;
                 } catch (error) { console.error('Chyba při kontrole autorizace:', error); return false; }
             }

             if (await checkLoggedInUser()) return; // Stop if already logged in

            const errorTranslations = {
                'Invalid login credentials': 'Nesprávný email nebo heslo.',
                'Email not confirmed': 'Email není potvrzen. Zkontrolujte svou schránku (i spam).',
                'User already registered': 'Tento email je již registrován.', // Updated key based on potential Supabase error
                'Password should be at least 6 characters': 'Heslo musí mít alespoň 6 znaků.', // Updated key
                'Unable to validate email address: invalid format': 'Neplatný formát emailu.', // Updated key
                'password should be different from the old password.': 'Nové heslo musí být jiné.', // Example, might differ
                'For security purposes, you can only request this once every 60 seconds': 'Vyčkejte prosím 60 sekund před dalším pokusem.', // Example
                'Username already taken': 'Toto uživatelské jméno je již obsazené.', // Custom error message
                'User not found': 'Uživatel s tímto emailem nebyl nalezen.' // Example for password reset
            };

            function showMessage(message, type) {
                messageContainer.innerHTML = `<div class="alert alert-${type}"><i class="fas ${type === 'error' ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i> ${message}</div>`;
                 messageContainer.style.maxHeight = messageContainer.scrollHeight + 'px'; // Smoothly expand
                if (type === 'success') { setTimeout(() => { messageContainer.style.maxHeight = '0'; setTimeout(() => messageContainer.innerHTML = '', 300); }, 4500); }
                 // Smooth scroll to message only on small screens
                if (window.innerWidth < 768 && messageContainer.getBoundingClientRect().top < 0) {
                    messageContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            function translateError(errorMsg) {
                 if (!errorMsg) return "Neznámá chyba.";
                 const msgString = typeof errorMsg === 'string' ? errorMsg : (errorMsg.message || JSON.stringify(errorMsg));
                 for (const [key, translation] of Object.entries(errorTranslations)) {
                     if (msgString.includes(key)) return translation;
                 }
                  console.warn("Nenalezen překlad pro chybu:", msgString); // Log untranslated errors
                 return msgString.length > 100 ? 'Nastala neočekávaná chyba.' : msgString; // Return generic if too long or unknown
            }

            function validateEmail(email) { const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; return re.test(email); }
            function debounce(func, wait) { let t; return function(...a){ clearTimeout(t); t = setTimeout(()=>func.apply(this,a),wait); }; }
            function checkPasswordStrength(password) { let s=0; if(!password || password.length === 0){passwordStrength.style.width='0'; return 0;} if(password.length>=8)s+=1; if(password.match(/[A-Z]/))s+=1; if(password.match(/[0-9]/))s+=1; if(password.match(/[^A-Za-z0-9]/))s+=1; passwordStrength.className='password-strength-meter'; if(s<=1)passwordStrength.classList.add('strength-weak'); else if(s<=3)passwordStrength.classList.add('strength-medium'); else passwordStrength.classList.add('strength-strong'); return s;}
             const debouncedPasswordCheck = debounce(checkPasswordStrength, 250);

            registerPassword.addEventListener('input', function() { debouncedPasswordCheck(this.value); });
            document.querySelectorAll('.password-toggle').forEach(b=>{ b.addEventListener('click', function(){ const i=document.getElementById(this.dataset.for), c=this.querySelector('i'); if(i.type==='password'){i.type='text'; c.classList.replace('fa-eye','fa-eye-slash');} else {i.type='password'; c.classList.replace('fa-eye-slash','fa-eye');} }); });

            function switchTab(activeTab, showForm, hideForm1, hideForm2) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                activeTab.classList.add('active');
                [hideForm1, hideForm2, showForm].forEach(f => f.classList.add('hidden')); // Hide all first
                messageContainer.innerHTML = ''; messageContainer.style.maxHeight = '0'; // Clear messages
                // Remove 'hidden' class to trigger animation (if styles use it)
                showForm.classList.remove('hidden');
            }

            loginTab.addEventListener('click', () => switchTab(loginTab, loginForm, registerForm, resetPasswordForm));
            registerTab.addEventListener('click', () => switchTab(registerTab, registerForm, loginForm, resetPasswordForm));
            forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); switchTab(loginTab, resetPasswordForm, loginForm, registerForm); resetEmail.value = loginEmail.value; });
            backToLoginLink.addEventListener('click', (e) => { e.preventDefault(); switchTab(loginTab, loginForm, resetPasswordForm, registerForm); });

            // Form Submit Handlers
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginEmail.value.trim(); const password = loginPassword.value;
                if (!validateEmail(email) || !password) { showMessage('Zadejte platný email a heslo.', 'error'); return; }
                loginButton.disabled = true; loginLoading.style.display = 'block'; messageContainer.innerHTML = '';
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    showMessage('Přihlášení úspěšné! Přesměrovávám...', 'success');
                    // Local storage for 'remember me' is not recommended for sessions. Supabase handles session persistence.
                    setTimeout(() => window.location.href = '/dashboard/dashboard.html', 1200);
                } catch (error) { showMessage(`Přihlášení selhalo: ${translateError(error)}`, 'error'); }
                finally { loginButton.disabled = false; loginLoading.style.display = 'none'; }
            });

            registerForm.addEventListener('submit', async (e) => {
                 e.preventDefault();
                 const email = registerEmail.value.trim(); const username = registerUsername.value.trim(); const password = registerPassword.value; const passwordConfirm = confirmPassword.value;
                 if (!validateEmail(email)) { showMessage('Zadejte platný email.', 'error'); return; }
                 if (username.length < 3) { showMessage('Uživatelské jméno min. 3 znaky.', 'error'); return; }
                 if (password.length < 6) { showMessage('Heslo min. 6 znaků.', 'error'); return; }
                 if (checkPasswordStrength(password) <= 1) { showMessage('Heslo je příliš slabé.', 'error'); return; }
                 if (password !== passwordConfirm) { showMessage('Hesla se neshodují.', 'error'); return; }

                 // Check username availability again before submitting
                 if (await isUsernameTaken(username)) {
                      showMessage('Toto uživatelské jméno je již obsazené.', 'error');
                      return;
                 }

                 registerButton.disabled = true; registerLoading.style.display = 'block'; messageContainer.innerHTML = '';
                 try {
                     const { data: signUpData, error: signUpError } = await supabase.auth.signUp({ email, password, options: { data: { username } } });
                     if (signUpError) throw signUpError;
                     if (!signUpData.user) throw new Error("Nepodařilo se získat informace o uživateli po registraci.");

                     // Profile creation is now handled by the trigger `create_profile_on_signup`
                     console.log("Registrace auth úspěšná, profil by měl být vytvořen triggerem.");
                     showMessage('Registrace úspěšná! Zkontrolujte svůj email pro potvrzení účtu. (Může být ve spamu)', 'success');
                     registerForm.reset();
                     setTimeout(() => loginTab.click(), 3000);

                 } catch (error) { console.error('Registration process error:', error); showMessage(`Registrace selhala: ${translateError(error)}`, 'error'); }
                 finally { registerButton.disabled = false; registerLoading.style.display = 'none'; }
            });

            resetPasswordForm.addEventListener('submit', async (e) => {
                 e.preventDefault();
                 const email = resetEmail.value.trim();
                 if (!validateEmail(email)) { showMessage('Zadejte platný email.', 'error'); return; }
                 resetButton.disabled = true; resetLoading.style.display = 'block'; messageContainer.innerHTML = '';
                 try {
                     const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + '/auth/reset-password.html' }); // Ensure correct redirect
                     if (error) throw error;
                     showMessage('Pokyny k obnovení hesla byly odeslány na váš email.', 'success');
                     setTimeout(() => loginTab.click(), 3000);
                 } catch (error) { console.error('Password reset error:', error); showMessage(`Odeslání selhalo: ${translateError(error)}`, 'error'); }
                 finally { resetButton.disabled = false; resetLoading.style.display = 'none'; }
            });

            // Check username availability function
             async function isUsernameTaken(username) {
                 if (!username || username.length < 3) return false;
                 try {
                     const { data, error, count } = await supabase
                         .from('profiles')
                         .select('id', { count: 'exact', head: true }) // Efficient count query
                         .eq('username', username);
                     if (error && error.code !== 'PGRST116') { // Ignore 'not found' error
                         console.error('Username check error:', error); return false; // Assume not taken if error occurs
                     }
                     return count > 0;
                 } catch (err) { console.error('Username check exception:', err); return false; }
             }

             const debouncedUsernameCheck = debounce(async function() {
                 const username = registerUsername.value.trim();
                 if (username.length < 3) { clearFieldError('registerUsername'); return; } // Clear if too short
                 if (await isUsernameTaken(username)) {
                     // Using showFieldError (if defined) or simple message
                     const errorElement = document.getElementById('registerUsername-error');
                     if (errorElement) {
                         errorElement.textContent = 'Uživatelské jméno je obsazené.';
                         errorElement.style.display = 'block';
                         registerUsername.classList.add('is-invalid');
                     } else {
                          showMessage('Toto uživatelské jméno je již obsazené', 'error');
                     }
                      registerButton.disabled = true; // Disable button if taken
                 } else {
                      // Clear error if username is valid
                      const errorElement = document.getElementById('registerUsername-error');
                     if (errorElement) {
                          errorElement.textContent = '';
                          errorElement.style.display = 'none';
                         registerUsername.classList.remove('is-invalid');
                     }
                     // Re-enable button based on other fields (might need updateInputListeners logic)
                     updateRegisterButtonState();
                 }
             }, 400); // Debounce check

             registerUsername.addEventListener('input', debouncedUsernameCheck);

             // Function to update register button state based on all inputs
             function updateRegisterButtonState() {
                 const emailValid = validateEmail(registerEmail.value);
                 const usernameValid = registerUsername.value.length >= 3 && !registerUsername.classList.contains('is-invalid'); // Check invalid class
                 const passwordValid = registerPassword.value.length >= 6 && checkPasswordStrength(registerPassword.value) > 1;
                 const confirmValid = registerPassword.value === confirmPassword.value;
                 registerButton.disabled = !(emailValid && usernameValid && passwordValid && confirmValid);
             }

             // Add input listeners to re-validate button state
             [registerEmail, registerUsername, registerPassword, confirmPassword].forEach(input => {
                 input.addEventListener('input', updateRegisterButtonState);
                 // Also clear specific field errors on input
                 input.addEventListener('input', () => {
                      const errorElement = document.getElementById(`${input.id}-error`);
                      if (errorElement) {
                          errorElement.textContent = '';
                          errorElement.style.display = 'none';
                          input.classList.remove('is-invalid');
                      }
                 });
             });
             confirmPassword.addEventListener('input', () => {
                 const errorElement = document.getElementById('confirmPassword-error');
                 if(registerPassword.value !== confirmPassword.value && confirmPassword.value) {
                     if(errorElement) { errorElement.textContent = 'Hesla se neshodují.'; errorElement.style.display='block';}
                     confirmPassword.classList.add('is-invalid');
                 } else {
                      if(errorElement) { errorElement.textContent = ''; errorElement.style.display='none';}
                     confirmPassword.classList.remove('is-invalid');
                 }
                  updateRegisterButtonState(); // Update button state based on match
             });

             // Initial button state check
             updateRegisterButtonState();

        });
    </script>
</body>
</html>